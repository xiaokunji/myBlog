<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"https:\/\/xiaokunji.github.io\/myBlog\/",
  "author": {
    "@type": "Person",
    "name": "Firstname Lastname",
    
    "image": "https://www.gravatar.com/avatar/d09dc2d7aa5c467519e8af89f7b3d94c"
    
  },
  "name":"Hugo tranquilpeak theme",
  "description":"[toc]\n前言 阿里开源的注册中心和配置中心\nNacos 官方文档\nNacos 源码\n1. 概念 Name Space\n用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。\nConfiguration\n配置文件\nData ID\nNacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。\nGroup\nNacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。\nVirtual Cluster\n同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。\n如图: Nacos 概念\n2. 架构 3. 安装 Nacos Server下载地址：\nhttps:\/\/github.com\/alibaba\/nacos\/releases\n下载解压后打开bin目录\n\/work\/nacos\/bin\/startup.sh -m standalone",
  "url":"https:\/\/xiaokunji.github.io\/myBlog\/post\/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6\/spring-cloud\/nacos\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.116.1 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="Firstname Lastname">
<meta name="keywords" content="">
<meta name="description" content="[toc]
前言 阿里开源的注册中心和配置中心
Nacos 官方文档
Nacos 源码
1. 概念 Name Space
用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。
Configuration
配置文件
Data ID
Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。
Group
Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。
Virtual Cluster
同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。
如图: Nacos 概念
2. 架构 3. 安装 Nacos Server下载地址：
https://github.com/alibaba/nacos/releases
下载解压后打开bin目录
/work/nacos/bin/startup.sh -m standalone">


<meta property="og:description" content="[toc]
前言 阿里开源的注册中心和配置中心
Nacos 官方文档
Nacos 源码
1. 概念 Name Space
用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。
Configuration
配置文件
Data ID
Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。
Group
Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。
Virtual Cluster
同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。
如图: Nacos 概念
2. 架构 3. 安装 Nacos Server下载地址：
https://github.com/alibaba/nacos/releases
下载解压后打开bin目录
/work/nacos/bin/startup.sh -m standalone">
<meta property="og:type" content="article">
<meta property="og:title" content="Hugo tranquilpeak theme">
<meta name="twitter:title" content="Hugo tranquilpeak theme">
<meta property="og:url" content="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/">
<meta property="twitter:url" content="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/">
<meta property="og:site_name" content="Hugo tranquilpeak theme">
<meta property="og:description" content="[toc]
前言 阿里开源的注册中心和配置中心
Nacos 官方文档
Nacos 源码
1. 概念 Name Space
用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。
Configuration
配置文件
Data ID
Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。
Group
Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。
Virtual Cluster
同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。
如图: Nacos 概念
2. 架构 3. 安装 Nacos Server下载地址：
https://github.com/alibaba/nacos/releases
下载解压后打开bin目录
/work/nacos/bin/startup.sh -m standalone">
<meta name="twitter:description" content="[toc]
前言 阿里开源的注册中心和配置中心
Nacos 官方文档
Nacos 源码
1. 概念 Name Space
用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。
Configuration
配置文件
Data ID
Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。
Group
Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。
Virtual Cluster
同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。
如图: Nacos 概念
2. 架构 3. 安装 Nacos Server下载地址：
https://github.com/alibaba/nacos/releases
下载解压后打开bin目录
/work/nacos/bin/startup.sh -m standalone">
<meta property="og:locale" content="en-us">

  
  
  
  
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://www.gravatar.com/avatar/d09dc2d7aa5c467519e8af89f7b3d94c?s=640">
  <meta property="twitter:image" content="https://www.gravatar.com/avatar/d09dc2d7aa5c467519e8af89f7b3d94c?s=640">






    <title>Hugo tranquilpeak theme</title>

    <link rel="icon" href="https://xiaokunji.github.io/myBlog/favicon.png">
    

    

    <link rel="canonical" href="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="https://xiaokunji.github.io/myBlog/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://xiaokunji.github.io/myBlog/" aria-label="Go to homepage">Hugo tranquilpeak theme</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://xiaokunji.github.io/myBlog/#about" aria-label="Open the link: /#about">
    
    
    
      
        <img class="header-picture" src="https://www.gravatar.com/avatar/d09dc2d7aa5c467519e8af89f7b3d94c?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://xiaokunji.github.io/myBlog/#about" aria-label="Read more about the author">
          <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/d09dc2d7aa5c467519e8af89f7b3d94c?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Firstname Lastname</h4>
        
          <h5 class="sidebar-profile-bio">Super bio with markdown support <strong>COOL</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/" title="Home">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/content" title="我的">
    
      <i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">我的</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/categories" title="Categories">
    
      <i class="sidebar-button-icon fas fa-lg fa-bookmark" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/tags" title="Tags">
    
      <i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/archives" title="Archives">
    
      <i class="sidebar-button-icon fas fa-lg fa-archive" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/#about" title="About">
    
      <i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/kakawait" target="_blank" rel="noopener" title="GitHub">
    
      <i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://stackoverflow.com/users/636472/kakawait" target="_blank" rel="noopener" title="Stack Overflow">
    
      <i class="sidebar-button-icon fab fa-lg fa-stack-overflow" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">Stack Overflow</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://xiaokunji.github.io/myBlog/index.xml" title="RSS">
    
      <i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden="true"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="0001-01-01T00:00:00Z">
        
  January 1, 1

      </time>
    
    
  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>[toc]</p>
<h1 id="前言">前言</h1>
<p>阿里开源的注册中心和配置中心</p>
<p><img src="https://nacos.io/img/nacosMap.jpg" alt="nacos_map"></p>
<p><a href="https://nacos.io/zh-cn/docs/what-is-nacos.html">Nacos 官方文档</a></p>
<p><a href="https://github.com/alibaba/nacos">Nacos 源码</a></p>
<h1 id="1-概念">1. 概念</h1>
<p><strong>Name Space</strong></p>
<p>用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是<strong>不同环境的配置</strong>的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。</p>
<p><strong>Configuration</strong></p>
<p>配置文件</p>
<p><strong>Data ID</strong></p>
<p>Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。</p>
<p><strong>Group</strong></p>
<p>Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</p>
<p><strong>Virtual Cluster</strong></p>
<p>同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。</p>
<blockquote>
<p>如图: <!-- raw HTML omitted --></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561217857314-95ab332c-acfb-40b2-957a-aae26c2b5d71.jpeg" alt="nacos_data_model"></p>
<p><a href="https://nacos.io/zh-cn/docs/concepts.html">Nacos 概念</a></p>
<h1 id="2-架构">2. 架构</h1>
<p><img src="https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561217892717-1418fb9b-7faa-4324-87b9-f1740329f564.jpeg" alt="nacos_arch.jpg"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2019/png/338441/1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png" alt="nacos-logic.jpg"></p>
<h1 id="3-安装">3. 安装</h1>
<p>Nacos Server下载地址：</p>
<p><a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p>
<p>下载解压后打开bin目录</p>
<p><code>/work/nacos/bin/startup.sh -m standalone</code></p>
<blockquote>
<p>windows: <code>startup.cmd -m standalone</code></p>
</blockquote>
<p>启动完后访问后台</p>
<p>Nacos Server的后台访问地址：</p>
<p>http://192.168.10.13:8848/nacos/index.html</p>
<p>默认账号和密码为：<code>nacos/nacos</code></p>
<p><img src="https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos%E5%90%AF%E5%8A%A8%E6%97%A5%E5%BF%97.png" alt="image-20220109225601199"></p>
<h2 id="31-nacos-server-有两种运行模式">3.1 Nacos Server 有两种运行模式：</h2>
<ul>
<li>standalone</li>
<li>cluster (默认模式)</li>
</ul>
<h3 id="311-standalone-模式">3.1.1 standalone 模式</h3>
<p>此模式一般用于 demo 和测试，不用改任何配置，直接敲以下命令执行</p>
<h3 id="312-cluster-模式">3.1.2 cluster 模式</h3>
<p>cluster 模式需要依赖 MySQL，然后改两个配置文件：</p>
<pre tabindex="0"><code>conf/cluster.conf
conf/application.properties
</code></pre><p><strong><code>conf/cluster.conf</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-conf" data-lang="conf"><span style="display:flex;"><span><span style="color:#75715e"># 集群节点(此处是在同一台机器上,所以用ip区分)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">192.168.10.13</span><span style="color:#960050;background-color:#1e0010">:</span>8841
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168.10.13</span><span style="color:#960050;background-color:#1e0010">:</span>8845
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168.10.13</span><span style="color:#960050;background-color:#1e0010">:</span>8848
</span></span></code></pre></div><p><strong><code>conf/application.properties</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">spring.datasource.platform</span><span style="color:#f92672">=</span><span style="color:#e6db74">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db.num</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db.url.0</span><span style="color:#f92672">=</span><span style="color:#e6db74">jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC&amp;AllowPublicKeyRetrieval=True</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db.user.0</span><span style="color:#f92672">=</span><span style="color:#e6db74">test</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db.password.0</span><span style="color:#f92672">=</span><span style="color:#e6db74">xiaokunji</span>
</span></span></code></pre></div><blockquote>
<p>每个节点上需要改这两个文件</p>
<p>注意在application.properties文件中修改端口</p>
</blockquote>
<p>启动后 任意节点都能进入管理界面</p>
<p><img src="https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos%E6%8E%A7%E5%88%B6%E5%8F%B0-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86.png" alt="image-20220110000124372"></p>
<p><a href="https://developer.aliyun.com/article/738219">阿里巴巴NACOS（3）- 部署Nacos的生产集群环境-阿里云开发者社区 (aliyun.com)</a></p>
<blockquote>
<p>一般集群部署需要搭配NGINX, 这样就可以统一管理对外ip, 且需要利用NGINX的故障转移策略, nacos本身不具备故障转移</p>
</blockquote>
<p><a href="https://www.cnblogs.com/FlyAway2013/p/11201250.html">Nacos 集群部署 - CanntBelieve - 博客园 (cnblogs.com)</a></p>
<h1 id="4-注册中心">4. 注册中心</h1>
<p><strong>参数解释</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>com.alibaba.nacos.naming.log.level</code></td>
<td>Naming客户端的日志级别，改属性通过客户端启动时通过命令行加参数指定 注：默认为info</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.heart-beat-interval</td>
<td>nacos客户端向服务端发送心跳的时间间隔，默认5s<!-- raw HTML omitted -->注：客户端向服务端每隔5s向服务端发送心跳请求，进行服务续租，告诉服务端该实例IP健康。若在3次心跳的间隔时间(默认15s)内服务端没有接受到该实例的心跳请求，则认为该实例不健康，该实例将无法被消费。如果再次经历3次心跳的间隔时间，服务端接受到该实例的请求，那么会立刻将其设置外健康，并可以被消费，若未接受到，则删除该实例的注册信息。推荐配置为5s，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值。</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.heart-beat-timeout:</td>
<td>服务端没有接受到客户端心跳请求就将其设为不健康的时间间隔，默认为15s. 注：推荐值该值为15s即可，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值。</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.log-name:</td>
<td>nacos客户端会在启动时打印一部分发送注册请求信息和异常日志，可以通过日志查看注册的nacos集群地址、服务名、nameSpace、IP、元数据等内容，文件名默认为naming.log . 注:推荐将该日志的位置设置为和其他日志在一个文件夹下</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.metadata:</td>
<td>给服务添加一些标签，例如属于什么业务线，该元数据会持久化存储在服务端，但是客户端消费时不会获取到此值，默认为空. 注:推荐为空，我们可以通过已经注册的服务名来找到具体的业务线，无需添加metadata</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.namespace:</td>
<td>命名空间ID，Nacos通过不同的命名空间来区分不同的环境，进行数据隔离，服务消费时只能消费到对应命名空间下的服务。</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.naming-load-cache-at-start:</td>
<td>默认为false。客户端在启动时是否读取本地配置项(一个文件)来获取服务列表. 注：推荐该值为false，若改成true。则客户端会在本地的一个文件中保存服务信息，当下次宕机启动时，会优先读取本地的配置对外提供服务。</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.port:</td>
<td>向nacos注册服务时，服务对应的端口号 . 注:无需修改，默认为应用对外提供服务的端口号,server.port</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.register-enabled:</td>
<td>该项目是否向注册中心注册服务，默认为true . 注：如果服务从注册中心只消费服务，没有对外提供服务，那么该值可设置为false，可减少客户端线程池的创建，无需向服务端发送心跳请求，提高性能。</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.server-addr</td>
<td>nacos集群地址。注：多个IP可以通过“，”号隔离，例如<code>192.168.80.1:8848,192.168.80.1:8848</code>  填写域名时前缀不要加上http://</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.service:</td>
<td>项目向注册中心注册服务时的服务名，默认为spring.application.name 变量 . 注:该服务名必须使用小写，因为nacos服务名区分大小写，如果服务名不完全匹配，那么无法调用服务</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.watch-delay:</td>
<td>默认为30s。客户端在启动时会创建一个线程池，该线程定期去查询服务端的信息列表，该请求不会立刻返回，默认等待30s，若在30s内，服务端信息列表发生变化，则该请求立刻返回，通知客户端拉取服务端的服务信息列表，若30s内，没有变化，则30s时该请求返回响应，客户端服务列表不变，再次发生该请求。 注：推荐该值为30s即可，无需修改</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.watch.enabled:</td>
<td>默认为true,客户端在启动时会创建一个线程池，该线程定期去查询服务端的信息列表，该请求不会立刻返回，默认等待30s，若在30s内，服务端信息列表发生变化，则该请求立刻返回，通知客户端拉取服务端的服务信息列表，若30s内，没有变化，则30s时该请求返回响应，客户端服务列表不变，再次发生该请求。 注:推荐该功能为true，这是nacos类似长连接推送服务变化的功能，不要关闭</td>
</tr>
<tr>
<td>spring.cloud.nacos.discovery.weight:</td>
<td>nacos支持服务端基于权重的负载均衡，该值默认为1 . 注:建议该值保持默认即可，因为代码可能会部署到不同的服务器上，无法确保某台服务器的配置一定较好，如果有需要修改该值的需求，可以上控制台修改，这样可以保证对应IP服务器的权重值较高</td>
</tr>
</tbody>
</table>
<blockquote>
<p><!-- raw HTML omitted --> watch-delay 有什么作用?<!-- raw HTML omitted --></p>
</blockquote>
<h2 id="41-基本使用">4.1 基本使用</h2>
<p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>   <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>2.2.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>使用配置文件如下:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:   
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>        	-- <span style="color:#ae81ff">配置中心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">xkjNamespace</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">192.168.2.101</span>:<span style="color:#ae81ff">8841</span>,<span style="color:#ae81ff">192.168.2.101</span>:<span style="color:#ae81ff">8845</span>,<span style="color:#ae81ff">192.168.2.101</span>:<span style="color:#ae81ff">8848</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">group</span>: <span style="color:#ae81ff">xkjGroup</span>
</span></span><span style="display:flex;"><span>            -- <span style="color:#ae81ff">注册中心</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">discovery</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">${spring.cloud.nacos.config.server-addr}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">cluster-name</span>: <span style="color:#ae81ff">xkjCluster</span>
</span></span><span style="display:flex;"><span>                -- <span style="color:#ae81ff">此处是命名空间的id</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">xkjNamespace</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">service</span>: <span style="color:#ae81ff">javaDemoDiscovery</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">group</span>: <span style="color:#ae81ff">xkjGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">javaDemo</span>
</span></span></code></pre></div><h2 id="42-在不写本机地址时nacos如何发现ip的">4.2 在不写本机地址时,nacos如何发现ip的</h2>
<p>与 <code>Eureka</code>使用了同一个工具类, 有spring-cloud-common提供的 <code>InetUtils</code> 类, 因此两者获取ip是同样的原理,详见 [Eureka文章](<a href="https://github.com/xiaokunji/myNotes/blob/main/java">https://github.com/xiaokunji/myNotes/blob/main/java</a>及其框架/Spring Cloud/Eureka.md)</p>
<blockquote>
<p>简单来说就是遍历所有网卡, 去除一些回旋地址,忽略地址等规则取索引最小的, 默认返回本地地址</p>
</blockquote>
<h1 id="5-配置中心">5. 配置中心</h1>
<p>在 Nacos Spring Cloud 中，dataId 的完整格式如下：</p>
<p><code>${prefix}-${spring.profile.active}.${file-extension}</code></p>
<blockquote>
<ul>
<li>prefix 默认为所属工程配置spring.application.name 的值（即：nacos-provider），也可以通过配置项 spring.cloud.nacos.config.prefix来配置；</li>
<li>spring.profile.active 即为当前环境对应的 profile，详情可以参考 Spring Boot文档。 注意：当spring.profile.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension}</li>
<li>file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类型；默认为 properties ；</li>
</ul>
</blockquote>
<p><a href="https://blog.csdn.net/cristianoxm/article/details/113639172">Nacos 入门教程_cristianoxm的博客-CSDN博客_nacos 教程</a></p>
<p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>2.2.1.RELEASE<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>配置文件:</p>
<blockquote>
<p>新增bootstrap.yml文件，配置信息写在该文件里。（问题：如放在application.yml会导致项目启动报找不到配置属性错误，原因：application.yml与bootstrap.yml加载顺序优先级问题。）</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">javaDemo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cloud</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nacos</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server-addr</span>: <span style="color:#ae81ff">${spring.cloud.client.ip-address}:8848</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">config</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">xkjNamespace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">file-extension</span>: <span style="color:#ae81ff">yml</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">shared-configs</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">data-id</span>: <span style="color:#ae81ff">mysqlTest.yml</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">refresh</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">group</span>: <span style="color:#ae81ff">xkjGroup</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">extension-configs</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">data-id</span>: <span style="color:#ae81ff">MyTest.yml</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">refresh</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">group</span>: <span style="color:#ae81ff">xkjGroup</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">group</span>: <span style="color:#ae81ff">xkjGroup</span> <span style="color:#75715e"># 该配置如果放在share和extentsion配置的前面,将覆盖其下的组</span>
</span></span></code></pre></div><p>java使用类:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${my.name:本地值name}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${person.name:本地值person.name}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String person_name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${personAge:本地值personAge}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String personAge<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${personName:本地值personName}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String personName<span style="color:#f92672">;</span>
</span></span></code></pre></div><p><img src="https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BD%BF%E7%94%A8.png" alt="image-20220306005109148"></p>
<h2 id="51-动态配置">5.1 动态配置</h2>
<h3 id="511-使用">5.1.1 使用</h3>
<p>通常获取配置文件的方式</p>
<ol>
<li>
<p><code>@Value</code></p>
</li>
<li>
<p><code>@ConfigurationProperties(Prefix)</code></p>
</li>
</ol>
<p>如果是在运行时要动态更新的话，</p>
<p>第一种方式要在bean上加<code>@RefreshScope </code></p>
<p>第二种方式是自动支持的。</p>
<h3 id="512-原理详解">5.1.2 原理详解</h3>
<p><img src="https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97.png" alt="image-20220308002516886"></p>
<h4 id="5121-采用延迟线程池定时执行监听文件是否有修改">5.1.2.1 采用延迟线程池定时执行&quot;监听&quot;文件是否有修改</h4>
<p>服务启动后就回轮询的打印图上信息, 当有配置被改动时, 这个<code>[]</code> 就会包含数据了, 可想而知这是监听日志了, 那就找到这段代码</p>
<p><strong><code>ClientWorker.java</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LongPollingRunnable</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> taskId<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LongPollingRunnable</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> taskId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">taskId</span> <span style="color:#f92672">=</span> taskId<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>CacheData<span style="color:#f92672">&gt;</span> cacheDatas <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>CacheData<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> inInitializingCacheList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// check failover config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>CacheData cacheData <span style="color:#f92672">:</span> cacheMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">values</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">getTaskId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> taskId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        cacheDatas<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            checkLocalConfig<span style="color:#f92672">(</span>cacheData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">isUseLocalConfigInfo</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">checkListenerMd5</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get local config info error&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// check server config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> changedGroupKeys <span style="color:#f92672">=</span> checkUpdateDataIds<span style="color:#f92672">(</span>cacheDatas<span style="color:#f92672">,</span> inInitializingCacheList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get changedGroupKeys:&#34;</span> <span style="color:#f92672">+</span> changedGroupKeys<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//              省略剩下代码  .....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>从这里就能看出, 先是对配置做了一些检查, 然后就打印结果, 而且这个是在run方法里, 说明这里肯定是开了线程在跑的, 找到调用<code>LongPollingRunnable</code>这个类的地方</p>
<p>还是在同一个类中, 发现是在execute中执行的, 那就是弄了一个线程池, 而且这里是在for循环里, 看一下任务, 就会联想到多个配置文件的情况, 同时监听的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkConfigInfo</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 分任务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> listenerSize <span style="color:#f92672">=</span> cacheMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 向上取整为批数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> longingTaskCount <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">ceil</span><span style="color:#f92672">(</span>listenerSize <span style="color:#f92672">/</span> ParamUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getPerTaskConfigSize</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>longingTaskCount <span style="color:#f92672">&gt;</span> currentLongingTaskCount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> currentLongingTaskCount<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> longingTaskCount<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 要判断任务是否在执行 这块需要好好想想。 任务列表现在是无序的。变化过程可能有问题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                executorService<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LongPollingRunnable<span style="color:#f92672">(</span>i<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            currentLongingTaskCount <span style="color:#f92672">=</span> longingTaskCount<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>看一下这个线程池的参数.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;PMD.ThreadPoolCreationRule&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ClientWorker</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> HttpAgent agent<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ConfigFilterChainManager configFilterChainManager<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Properties properties<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">agent</span> <span style="color:#f92672">=</span> agent<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configFilterChainManager</span> <span style="color:#f92672">=</span> configFilterChainManager<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Initialize the timeout parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        init<span style="color:#f92672">(</span>properties<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        executor <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newScheduledThreadPool</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ThreadFactory<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> Thread <span style="color:#a6e22e">newThread</span><span style="color:#f92672">(</span>Runnable r<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread t <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                t<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com.alibaba.nacos.client.Worker.&#34;</span> <span style="color:#f92672">+</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                t<span style="color:#f92672">.</span><span style="color:#a6e22e">setDaemon</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 执行的线程池
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        executorService <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newScheduledThreadPool</span><span style="color:#f92672">(</span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">availableProcessors</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> ThreadFactory<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> Thread <span style="color:#a6e22e">newThread</span><span style="color:#f92672">(</span>Runnable r<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread t <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                t<span style="color:#f92672">.</span><span style="color:#a6e22e">setName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com.alibaba.nacos.client.Worker.longPolling.&#34;</span> <span style="color:#f92672">+</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                t<span style="color:#f92672">.</span><span style="color:#a6e22e">setDaemon</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        executor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleWithFixedDelay</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    checkConfigInfo<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[&#34;</span> <span style="color:#f92672">+</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] [sub-check] rotate check error&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">},</span> 1L<span style="color:#f92672">,</span> 10L<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>还会发现这里还有个延迟线程池,而且只有一个线程数, 发现里面执行了<code>checkConfigInfo()</code>, 这刚好<code>LongPollingRunnable</code> 类执行的所在方法.</p>
<p>至此, 它的定时执行就清楚了, <strong>它开了一个单线程的延时线程池,每隔10ms执行一次, 线程里再用线程池去&quot;监听&quot;文件是否有修改</strong></p>
<p>但是我们发现日志间隔并不是10ms,而且这个间隔也太小了, 肯定不合理</p>
<h4 id="5122-通过长轮询的方式获得修改过的文件及其内容">5.1.2.2 通过长轮询的方式获得修改过的文件及其内容</h4>
<p>去看一下它是如何&quot;监听&quot;, 跟进<code>com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateDataIds</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 从Server获取值变化了的DataID列表。返回的对象里只有dataId和group是有效的。 保证不返回NULL。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">checkUpdateDataIds</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>CacheData<span style="color:#f92672">&gt;</span> cacheDatas<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> inInitializingCacheList<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 构造参数- 通过配置dataId/group/tenant等数据来指定文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>CacheData cacheData <span style="color:#f92672">:</span> cacheDatas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">isUseLocalConfigInfo</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">dataId</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>WORD_SEPARATOR<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>WORD_SEPARATOR<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">tenant</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">getMd5</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>LINE_SEPARATOR<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">getMd5</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>WORD_SEPARATOR<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">getTenant</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>LINE_SEPARATOR<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">isInitializing</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// cacheData 首次出现在cacheMap中&amp;首次check更新
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    inInitializingCacheList
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>GroupKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyTenant</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">dataId</span><span style="color:#f92672">,</span> cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">,</span> cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">tenant</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> isInitializingCacheList <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>inInitializingCacheList<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 核心方法- 检查更新文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> checkUpdateConfigStr<span style="color:#f92672">(</span>sb<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> isInitializingCacheList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateConfigStr</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 从Server获取值变化了的DataID列表。返回的对象里只有dataId和group是有效的。 保证不返回NULL。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">checkUpdateConfigStr</span><span style="color:#f92672">(</span>String probeUpdateString<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> isInitializingCacheList<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> params <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;(</span>2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        params<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">PROBE_MODIFY_REQUEST</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        params<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>probeUpdateString<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> headers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;(</span>2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        headers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Long-Pulling-Timeout&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置长轮询的过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        headers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span> timeout<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// told server do not hang me up if new initializing cacheData added in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isInitializingCacheList<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            headers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Long-Pulling-Timeout-No-Hangup&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            headers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>probeUpdateString<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyList</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// In order to prevent the server from handling the delay of the client&#39;s long task,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// increase the client&#39;s read timeout to avoid this problem.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">long</span> readTimeoutMs <span style="color:#f92672">=</span> timeout <span style="color:#f92672">+</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">round</span><span style="color:#f92672">(</span>timeout <span style="color:#f92672">&gt;&gt;</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 长轮询请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            HttpResult result <span style="color:#f92672">=</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">httpPost</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIG_CONTROLLER_PATH</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/listener&#34;</span><span style="color:#f92672">,</span> headers<span style="color:#f92672">,</span> params<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getEncode</span><span style="color:#f92672">(),</span> readTimeoutMs<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>HttpURLConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">HTTP_OK</span> <span style="color:#f92672">==</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">code</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                setHealthServer<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 解析返参
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> parseUpdateDataIdResponse<span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                setHealthServer<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [check-update] get changed dataId error, code: {}&#34;</span><span style="color:#f92672">,</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">code</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            setHealthServer<span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[&#34;</span> <span style="color:#f92672">+</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] [check-update] get changed dataId exception&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyList</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>就会发现它是发了一个请求过去, 然后通过<code>parseUpdateDataIdResponse(result.content)</code> 方法解析出返参里面的 dataId/group/tenant等数据</p>
<p>这个请求中设置了一些长轮询的参数,表示这是一个长轮询的请求</p>
<blockquote>
<p><strong>长轮询:</strong> 客户端发起Long Polling，此时如果服务端没有相关数据，会hold住请求，直到服务端有相关数据，或者等待一定时间超时才会返回。返回后，客户端又会立即再次发起下一次Long Polling。</p>
</blockquote>
<p>这里只是拿到了一个dataId和group等数据,那什么时候拿到具体的配置信息呢?  继续往下看 <code>LongPollingRunnable#run</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>                <span style="color:#75715e">// 检查更新的dataId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> changedGroupKeys <span style="color:#f92672">=</span> checkUpdateDataIds<span style="color:#f92672">(</span>cacheDatas<span style="color:#f92672">,</span> inInitializingCacheList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;get changedGroupKeys:&#34;</span> <span style="color:#f92672">+</span> changedGroupKeys<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 遍历这些文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String groupKey <span style="color:#f92672">:</span> changedGroupKeys<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    String<span style="color:#f92672">[]</span> key <span style="color:#f92672">=</span> GroupKey<span style="color:#f92672">.</span><span style="color:#a6e22e">parseKey</span><span style="color:#f92672">(</span>groupKey<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    String dataId <span style="color:#f92672">=</span> key<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                    String group <span style="color:#f92672">=</span> key<span style="color:#f92672">[</span>1<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                    String tenant <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 3<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        tenant <span style="color:#f92672">=</span> key<span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 获得具体配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        String<span style="color:#f92672">[]</span> ct <span style="color:#f92672">=</span> getServerConfig<span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">,</span> 3000L<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        CacheData cache <span style="color:#f92672">=</span> cacheMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>GroupKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyTenant</span><span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 把内容直接写到cacheMap中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        cache<span style="color:#f92672">.</span><span style="color:#a6e22e">setContent</span><span style="color:#f92672">(</span>ct<span style="color:#f92672">[</span>0<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> ct<span style="color:#f92672">[</span>1<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            cache<span style="color:#f92672">.</span><span style="color:#a6e22e">setType</span><span style="color:#f92672">(</span>ct<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">,</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">getMd5</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                            ContentUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">truncateContent</span><span style="color:#f92672">(</span>ct<span style="color:#f92672">[</span>0<span style="color:#f92672">]),</span> ct<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NacosException ioe<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        String message <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> ioe<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>CacheData cacheData <span style="color:#f92672">:</span> cacheDatas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">isInitializing</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> inInitializingCacheList
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>GroupKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyTenant</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">dataId</span><span style="color:#f92672">,</span> cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">,</span> cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">tenant</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 检查md5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">checkListenerMd5</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                        cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">setInitializing</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ....省略剩下代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>com.alibaba.nacos.client.config.impl.ClientWorker#getServerConfig</code> 获得具体配置的方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getServerConfig</span><span style="color:#f92672">(</span>String dataId<span style="color:#f92672">,</span> String group<span style="color:#f92672">,</span> String tenant<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> readTimeout<span style="color:#f92672">)</span>  <span style="color:#66d9ef">throws</span> NacosException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String<span style="color:#f92672">[]</span> ct <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>group<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            group <span style="color:#f92672">=</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_GROUP</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HttpResult result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> params <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>tenant<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                params <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dataId&#34;</span><span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;group&#34;</span><span style="color:#f92672">,</span> group<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                params <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dataId&#34;</span><span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;group&#34;</span><span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;tenant&#34;</span><span style="color:#f92672">,</span> tenant<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 通过get请求,获得具体配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">httpGet</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">CONFIG_CONTROLLER_PATH</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> params<span style="color:#f92672">,</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getEncode</span><span style="color:#f92672">(),</span> readTimeout<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String message <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;[%s] [sub-server] get server config exception, dataId=%s, group=%s, tenant=%s&#34;</span><span style="color:#f92672">,</span> agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NacosException<span style="color:#f92672">(</span>NacosException<span style="color:#f92672">.</span><span style="color:#a6e22e">SERVER_ERROR</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">code</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> HttpURLConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">HTTP_OK</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 先放到本地文件中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                LocalConfigInfoProcessor<span style="color:#f92672">.</span><span style="color:#a6e22e">saveSnapshot</span><span style="color:#f92672">(</span>agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">,</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 将请求返参放入ct数组中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                ct<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">content</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">headers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>CONFIG_TYPE<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    ct<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">headers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>CONFIG_TYPE<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    ct<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> ConfigType<span style="color:#f92672">.</span><span style="color:#a6e22e">TEXT</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> ct<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">case</span> HttpURLConnection<span style="color:#f92672">.</span><span style="color:#a6e22e">HTTP_NOT_FOUND</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//  省略剩下代码......
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>至此, 清楚了它是如何拿到具体配置的了, <strong>它通过(一次post请求)长轮询的方式和服务端建立连接, 获得dataId/group等数据, 再通过这些参数发起get请求获得具体的配置文件内容,并写到本地缓存中使用</strong></p>
<h4 id="5123-拿到配置后通过applicationcontext更新到项目内存中">5.1.2.3 拿到配置后通过applicationContext更新到项目内存中</h4>
<p>它取到这些配置后,是如何写到项目的内存中并使其生效的呢?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        String<span style="color:#f92672">[]</span> ct <span style="color:#f92672">=</span> getServerConfig<span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">,</span> 3000L<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        CacheData cache <span style="color:#f92672">=</span> cacheMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>GroupKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyTenant</span><span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                        cache<span style="color:#f92672">.</span><span style="color:#a6e22e">setContent</span><span style="color:#f92672">(</span>ct<span style="color:#f92672">[</span>0<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> ct<span style="color:#f92672">[</span>1<span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            cache<span style="color:#f92672">.</span><span style="color:#a6e22e">setType</span><span style="color:#f92672">(</span>ct<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">,</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">getMd5</span><span style="color:#f92672">(),</span>
</span></span><span style="display:flex;"><span>                            ContentUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">truncateContent</span><span style="color:#f92672">(</span>ct<span style="color:#f92672">[</span>0<span style="color:#f92672">]),</span> ct<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NacosException ioe<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        String message <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            agent<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> tenant<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> ioe<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>CacheData cacheData <span style="color:#f92672">:</span> cacheDatas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">isInitializing</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> inInitializingCacheList
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>GroupKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyTenant</span><span style="color:#f92672">(</span>cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">dataId</span><span style="color:#f92672">,</span> cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">,</span> cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">tenant</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 检查md5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">checkListenerMd5</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                        cacheData<span style="color:#f92672">.</span><span style="color:#a6e22e">setInitializing</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 省略剩下代码.....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在取到具体配置后,遍历cacheDatas数据,并检查md5, 跟进去看一下, 它开始出现监听器了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkListenerMd5</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ManagerListenerWrap wrap <span style="color:#f92672">:</span> listeners<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>md5<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>wrap<span style="color:#f92672">.</span><span style="color:#a6e22e">lastCallMd5</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                safeNotifyListener<span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> content<span style="color:#f92672">,</span> type<span style="color:#f92672">,</span> md5<span style="color:#f92672">,</span> wrap<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">safeNotifyListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String dataId<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String group<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String content<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String type<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">final</span> String md5<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> ManagerListenerWrap listenerWrap<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> Listener listener <span style="color:#f92672">=</span> listenerWrap<span style="color:#f92672">.</span><span style="color:#a6e22e">listener</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Runnable job <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                ClassLoader myClassLoader <span style="color:#f92672">=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextClassLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                ClassLoader appClassLoader <span style="color:#f92672">=</span> listener<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>listener <span style="color:#66d9ef">instanceof</span> AbstractSharedListener<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        AbstractSharedListener adapter <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>AbstractSharedListener<span style="color:#f92672">)</span> listener<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                        adapter<span style="color:#f92672">.</span><span style="color:#a6e22e">fillContext</span><span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [notify-context] dataId={}, group={}, md5={}&#34;</span><span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> md5<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 执行回调之前先将线程classloader设置为具体webapp的classloader，以免回调方法中调用spi接口是出现异常或错用（多应用部署才会有该问题）。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setContextClassLoader</span><span style="color:#f92672">(</span>appClassLoader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    ConfigResponse cr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConfigResponse<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    cr<span style="color:#f92672">.</span><span style="color:#a6e22e">setDataId</span><span style="color:#f92672">(</span>dataId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    cr<span style="color:#f92672">.</span><span style="color:#a6e22e">setGroup</span><span style="color:#f92672">(</span>group<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    cr<span style="color:#f92672">.</span><span style="color:#a6e22e">setContent</span><span style="color:#f92672">(</span>content<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    configFilterChainManager<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> cr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    String contentTmp <span style="color:#f92672">=</span> cr<span style="color:#f92672">.</span><span style="color:#a6e22e">getContent</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 处理配置信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    listener<span style="color:#f92672">.</span><span style="color:#a6e22e">receiveConfigInfo</span><span style="color:#f92672">(</span>contentTmp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// compare lastContent and content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>listener <span style="color:#66d9ef">instanceof</span> AbstractConfigChangeListener<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        Map data <span style="color:#f92672">=</span> ConfigChangeHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">parseChangeData</span><span style="color:#f92672">(</span>listenerWrap<span style="color:#f92672">.</span><span style="color:#a6e22e">lastContent</span><span style="color:#f92672">,</span> content<span style="color:#f92672">,</span> type<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        ConfigChangeEvent event <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConfigChangeEvent<span style="color:#f92672">(</span>data<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">((</span>AbstractConfigChangeListener<span style="color:#f92672">)</span>listener<span style="color:#f92672">).</span><span style="color:#a6e22e">receiveConfigChange</span><span style="color:#f92672">(</span>event<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        listenerWrap<span style="color:#f92672">.</span><span style="color:#a6e22e">lastContent</span> <span style="color:#f92672">=</span> content<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    listenerWrap<span style="color:#f92672">.</span><span style="color:#a6e22e">lastCallMd5</span> <span style="color:#f92672">=</span> md5<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [notify-ok] dataId={}, group={}, md5={}, listener={} &#34;</span><span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> md5<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NacosException de<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [notify-error] dataId={}, group={}, md5={}, listener={} errCode={} errMsg={}&#34;</span><span style="color:#f92672">,</span> name<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> md5<span style="color:#f92672">,</span> listener<span style="color:#f92672">,</span> de<span style="color:#f92672">.</span><span style="color:#a6e22e">getErrCode</span><span style="color:#f92672">(),</span> de<span style="color:#f92672">.</span><span style="color:#a6e22e">getErrMsg</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [notify-error] dataId={}, group={}, md5={}, listener={} tx={}&#34;</span><span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        md5<span style="color:#f92672">,</span> listener<span style="color:#f92672">,</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">getCause</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setContextClassLoader</span><span style="color:#f92672">(</span>myClassLoader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> startNotify <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> listener<span style="color:#f92672">.</span><span style="color:#a6e22e">getExecutor</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                listener<span style="color:#f92672">.</span><span style="color:#a6e22e">getExecutor</span><span style="color:#f92672">().</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>job<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                job<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [notify-error] dataId={}, group={}, md5={}, listener={} throwable={}&#34;</span><span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                md5<span style="color:#f92672">,</span> listener<span style="color:#f92672">,</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">getCause</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> finishNotify <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[{}] [notify-listener] time cost={}ms in ClientWorker, dataId={}, group={}, md5={}, listener={} &#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">,</span> <span style="color:#f92672">(</span>finishNotify <span style="color:#f92672">-</span> startNotify<span style="color:#f92672">),</span> dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> md5<span style="color:#f92672">,</span> listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>这么长的代码,核心就是处理了那个runable, 其中调用了<code>listener.receiveConfigInfo(contentTmp)</code> 方法处理的监听器,它是一个抽象类, 找到它的实现类</p>
<p><code>com.alibaba.cloud.nacos.refresh.NacosContextRefresher</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerNacosListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String groupKey<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String dataKey<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		String key <span style="color:#f92672">=</span> NacosPropertySourceRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapKey</span><span style="color:#f92672">(</span>dataKey<span style="color:#f92672">,</span> groupKey<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		Listener listener <span style="color:#f92672">=</span> listenerMap<span style="color:#f92672">.</span><span style="color:#a6e22e">computeIfAbsent</span><span style="color:#f92672">(</span>key<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>				lst <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">new</span> AbstractSharedListener<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">innerReceive</span><span style="color:#f92672">(</span>String dataId<span style="color:#f92672">,</span> String group<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>							String configInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						refreshCountIncrement<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>						nacosRefreshHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">addRefreshRecord</span><span style="color:#f92672">(</span>dataId<span style="color:#f92672">,</span> group<span style="color:#f92672">,</span> configInfo<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// todo feature: support single refresh for listening
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#75715e">// 通过applicationContext的事件去更新配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						applicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">publishEvent</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>								<span style="color:#66d9ef">new</span> RefreshEvent<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Refresh Nacos config&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>							log<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>									<span style="color:#e6db74">&#34;Refresh Nacos config group=%s,dataId=%s,configInfo=%s&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>									group<span style="color:#f92672">,</span> dataId<span style="color:#f92672">,</span> configInfo<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			configService<span style="color:#f92672">.</span><span style="color:#a6e22e">addListener</span><span style="color:#f92672">(</span>dataKey<span style="color:#f92672">,</span> groupKey<span style="color:#f92672">,</span> listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NacosException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#e6db74">&#34;register fail for nacos listener ,dataId=[%s],group=[%s]&#34;</span><span style="color:#f92672">,</span> dataKey<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>					groupKey<span style="color:#f92672">),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>至此, 清楚了获得的配置是如何生效的, 它将获得发生修改过的文件, 如果md5不一样了, 则执行监听器,通过applicationContext 更新配置到项目内存中</p>
<blockquote>
<p>明明已经知道了哪些文件被修改了,为啥还有比对md5, 因为可能是没有修改具体内容,只是点了编辑并保存</p>
<p><!-- raw HTML omitted -->md5用的是java的digest和位移,md5可能存在冲突, 那怎么解决冲突问题的?<!-- raw HTML omitted --></p>
</blockquote>
<h3 id="513-总结">5.1.3 总结</h3>
<ul>
<li>1.Nacos 客户端会循环请求服务端变更的数据，并且超时时间设置为30s，当配置发生变化时，请求的响应会立即返回，否则会一直等到 29.5s+ 之后再返回响应</li>
<li>2.Nacos 客户端能够实时感知到服务端配置发生了变化。</li>
<li>3.实时感知是建立在客户端拉和服务端“推”的基础上，但是这里的服务端“推”需要打上引号，因为服务端和客户端直接本质上还是通过 http 进行数据通讯的，之所以有“推”的感觉，是因为服务端主动将变更后的数据通过 http 的 response 对象提前写入了。</li>
</ul>
<p><a href="https://www.jianshu.com/p/d3f66b1eb748?isappinstalled=0">Long Polling长轮询详解 - 简书 (jianshu.com)</a></p>
<p><a href="https://www.cnblogs.com/barry-blog/articles/14305358.html">NACOS动态配置 - barryzhou - 博客园 (cnblogs.com)</a></p>
<p><a href="https://www.cnblogs.com/hankuikui/p/12084193.html">spring boot 配置文件动态更新原理 以Nacos为例 - 二奎 - 博客园 (cnblogs.com)</a></p>
<p><a href="https://www.jianshu.com/p/38b5452c9fec">Nacos 配置中心原理分析 -第一篇- 简书 (jianshu.com)</a></p>
<p><a href="https://www.jianshu.com/p/acb9b1093a54">Nacos 配置中心原理分析 -第二篇 - 简书 (jianshu.com)</a></p>
<h1 id="aq">A&amp;Q</h1>
<ol>
<li>
<p>nacos集群架构?</p>
<p><strong>答</strong>:  和Eureka集群架构一样,他的数据是点对点的, 本身是主从结构,也就是说会产生过半选举,脑裂等知识点, 默认支持cap理论中的ap模式. 生产部署nacos集群时,推荐通过NGINX给nacos集群做负载均衡</p>
<p><a href="https://www.cnblogs.com/songfeifeine/p/14321014.html">浅谈Nacos中的CAP - 包子卖完了嘛 - 博客园 (cnblogs.com)</a></p>
</li>
<li>
<p>nacos如何实现动态配置?</p>
<p>答: 使用长轮询机制,由客户端定时发起请求询问服务端是否有修改, 如果存在修改则通过applicationContext的publishEvent更新内存中的配置</p>
<blockquote>
<p>一次请求后将阻塞29.5s+, 才会发起下一次请求, 如果遇到服务端存在修改文件, 则会立即返回.</p>
<p>定时机制是开了一个延时线程池,其中只有一个线程,每隔10ms发起一次请求, 服务启动时该任务就执行了</p>
</blockquote>
</li>
</ol>

              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/gateway/" data-tooltip="" aria-label="NEXT: ">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/openfeign/" data-tooltip="" aria-label="PREVIOUS: ">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/" title="Share on Facebook" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
    <li class="post-action">
      <a class="post-action-btn btn btn--default" href="#disqus_thread" aria-label="Leave a comment">
        <i class="far fa-comment"></i>
      </a>
    </li>
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            
  
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
    <script type="text/javascript">
      var disqus_config = function() {
        this.page.url = 'https:\/\/xiaokunji.github.io\/myBlog\/post\/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6\/spring-cloud\/nacos\/';
        
          this.page.identifier = '\/post\/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6\/spring-cloud\/nacos\/'
        
      };
      (function() {
        
        
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
          document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
          return;
        }
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'hugo-tranquilpeak-theme';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 Firstname Lastname. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/gateway/" data-tooltip="" aria-label="NEXT: ">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/openfeign/" data-tooltip="" aria-label="PREVIOUS: ">
          
              <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
    <li class="post-action hide-lg hide-md hide-sm">
      <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
        <i class="fa fa-share-alt" aria-hidden="true"></i>
      </a>
    </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/" title="Share on Facebook" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/" title="Share on Twitter" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
      </li>
    
      <li class="post-action hide-xs">
        <a class="post-action-btn btn btn--default" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https://xiaokunji.github.io/myBlog/post/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring-cloud/nacos/" title="Share on Linkedin" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i>
        </a>
      </li>
    
  
  
    <li class="post-action">
      <a class="post-action-btn btn btn--default" href="#disqus_thread" aria-label="Leave a comment">
        <i class="far fa-comment"></i>
      </a>
    </li>
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="Back to top">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      
<div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fxiaokunji.github.io%2FmyBlog%2Fpost%2Fjava%25E5%258F%258A%25E5%2585%25B6%25E6%25A1%2586%25E6%259E%25B6%2Fspring-cloud%2Fnacos%2F" aria-label="Share on Facebook">
          <i class="fab fa-facebook-square" aria-hidden="true"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fxiaokunji.github.io%2FmyBlog%2Fpost%2Fjava%25E5%258F%258A%25E5%2585%25B6%25E6%25A1%2586%25E6%259E%25B6%2Fspring-cloud%2Fnacos%2F" aria-label="Share on Twitter">
          <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fxiaokunji.github.io%2FmyBlog%2Fpost%2Fjava%25E5%258F%258A%25E5%2585%25B6%25E6%25A1%2586%25E6%259E%25B6%2Fspring-cloud%2Fnacos%2F" aria-label="Share on Linkedin">
          <i class="fab fa-linkedin" aria-hidden="true"></i><span>Share on Linkedin</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>


    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://www.gravatar.com/avatar/d09dc2d7aa5c467519e8af89f7b3d94c?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Firstname Lastname</h4>
    
      <div id="about-card-bio">Super bio with markdown support <strong>COOL</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Your job title
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        France
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://xiaokunji.github.io/myBlog/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="https://xiaokunji.github.io/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js"></script>


  
    <script async crossorigin="anonymous" defer integrity="sha512-gE8KAQyFIzV1C9+GZ8TKJHZS2s+n7EjNtC+IMRn1l5+WYJTHOODUM6JSjZhFhqXmc7bG8Av6XXpckA4tYhflnw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/apache.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-EWROca+bote+7Oaaar1F6y74iZj1r1F9rm/ly7o+/FwJopbBaWtsFDmaKoZDd3QiGU2pGacBirHJNivmGLYrow==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/go.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-GDVzAn0wpx1yVtQsRWmFc6PhJiLBPdUic+h4GWgljBh904O3JU10fk9EKNpVyIoPqkFn54rgL2QBG4BmUTMpiQ==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/http.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-UgZlma8NzkrDb/NWgmLIcTrH7i/CSnLLDRFqCSNF5NGPpjKmzyM25qcoXGOup8+cDakKyaiTDd7N4dyH4YT+IA==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/less.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-lot9koe73sfXIrUvIPM/UEhuMciN56RPyBdOyZgfO53P2lkWyyXN7J+njcxIIBRV+nVDQeiWtiXg+bLAJZDTfg==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/nginx.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-Zd3e7XxHP00TD0Imr0PIfeM0fl0v95kMWuhyAS3Wn1UTSXTkz0OhtRgBAr4JlmADRgiXr4x7lpeUdqaGN8xIog==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/puppet.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-qtqDO052iXMSP+5d/aE/jMtL9vIIGvONgTJziC2K/ZIB1yEGa55WVxGE9/08rSQ62EoDifS9SWVGZ7ihSLhzMA==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/scss.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-1NmkjnEDnwwwcu28KoQF8vs3oaPFokQHbmbtwGhFfeDsQZtVFI8zW2aE9O8yMYdpdyKV/5blE4pSWw4Z/Sv97w==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/stylus.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-B2wSfruPjr8EJL6IIzQr1eAuDwrsfIfccNf/LCEdxELCgC/S/ZMt/Uvk80aD79m7IqOqW+Sw8nbkvha20yZpzg==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/swift.min.js"></script>
  

  
    <script async crossorigin="anonymous" defer integrity="sha512-28oDiQZGKUVN6wQ7PSLPNipOcmkCALXKwOi7bnkyFf8QiMZQxG9EQoy/iiNx6Zxj2cG2SbVa4dXKigQhu7GiFw==" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/yaml.min.js"></script>
  


<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

