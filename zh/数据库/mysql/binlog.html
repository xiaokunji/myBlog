<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>binlog | 米二</title><meta name=keywords content=" 1. 前言, 2. 三种模式, 2.1 row level (默认), 2.2 Statement level, 2.3 Mixed, 3 查看与配置,设置日志路径，注意路经需要mysql用户有权限写,这里可以写绝对路径,也可以直接写mysql-bin(后者默认就是在/var/lib/mysql目录下),配置serverid,设置日志三种格式：STATEMENT、ROW、MIXED 。,设置binlog清理时间,binlog每个日志文件大小,binlog缓存大小,最大binlog缓存大小, at 4,190308 10:05:03 server id 1  end_log_pos 123 CRC32 0xff02e23d     Start: binlog v 4,server v 5.7.22-log created 190308 10:05:03, Warning: this binlog is either in use or was not closed properly., at 123,190308 10:05:03 server id 1  end_log_pos 154 CRC32 0xb81da4c5     Previous-GTIDs, [empty], at 154,190308 10:05:09 server id 1  end_log_pos 219 CRC32 0xfb30d42c     Anonymous_GTID  last_committed=0    sequence_number=1   rbr_only=yes, at 219, at 21019,190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query   thread_id=113   exec_time=0 error_code=0, at 21094,190308 10:10:09 server id 1  end_log_pos 21161 CRC32 0xdb7a2b35     Table_map: `maxwell`.`positions` mapped to number 110, at 21161,190308 10:10:09 server id 1  end_log_pos 21275 CRC32 0xec3be372     Update_rows: table id 110 flags: STMT_END_F, UPDATE `maxwell`.`positions`, WHERE,   @1=1,   @2='master.000003',   @3=20262,   @4=NULL,   @5='maxwell',   @6=NULL,   @7=1552011005707, SET,   @1=1,   @2='master.000003',   @3=20923,   @4=NULL,   @5='maxwell',   @6=NULL,   @7=1552011009790, at 21275,190308 10:10:09 server id 1  end_log_pos 21306 CRC32 0xe6c4346d     Xid = 13088, End of log file, at 21019,190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query   thread_id=113   exec_time=0 error_code=0"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/binlog.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/binlog.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="binlog"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/binlog.html"><meta property="article:section" content="数据库"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-28T17:01:18+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="binlog"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"binlog","item":"https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/binlog.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"binlog","name":"binlog","description":"     ","keywords":[" 1. 前言"," 2. 三种模式"," 2.1 row level (默认)"," 2.2 Statement level"," 2.3 Mixed"," 3 查看与配置","设置日志路径，注意路经需要mysql用户有权限写,这里可以写绝对路径,也可以直接写mysql-bin(后者默认就是在/var/lib/mysql目录下)","配置serverid","设置日志三种格式：STATEMENT、ROW、MIXED 。","设置binlog清理时间","binlog每个日志文件大小","binlog缓存大小","最大binlog缓存大小"," at 4","190308 10:05:03 server id 1  end_log_pos 123 CRC32 0xff02e23d     Start: binlog v 4, server v 5.7.22-log created 190308 10:05:03"," Warning: this binlog is either in use or was not closed properly."," at 123","190308 10:05:03 server id 1  end_log_pos 154 CRC32 0xb81da4c5     Previous-GTIDs"," [empty]"," at 154","190308 10:05:09 server id 1  end_log_pos 219 CRC32 0xfb30d42c     Anonymous_GTID  last_committed=0    sequence_number=1   rbr_only=yes"," at 219"," at 21019","190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query   thread_id=113   exec_time=0 error_code=0"," at 21094","190308 10:10:09 server id 1  end_log_pos 21161 CRC32 0xdb7a2b35     Table_map: `maxwell`.`positions` mapped to number 110"," at 21161","190308 10:10:09 server id 1  end_log_pos 21275 CRC32 0xec3be372     Update_rows: table id 110 flags: STMT_END_F"," UPDATE `maxwell`.`positions`"," WHERE","   @1=1","   @2='master.000003'","   @3=20262","   @4=NULL","   @5='maxwell'","   @6=NULL","   @7=1552011005707"," SET","   @1=1","   @2='master.000003'","   @3=20923","   @4=NULL","   @5='maxwell'","   @6=NULL","   @7=1552011009790"," at 21275","190308 10:10:09 server id 1  end_log_pos 21306 CRC32 0xe6c4346d     Xid = 13088"," End of log file"," at 21019","190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query   thread_id=113   exec_time=0 error_code=0"],"articleBody":"[toc]\n1. 前言 MySQL的二进制日志可以说是MySQL最重要的日志了，它记录了所有的DDL和DML(除了数据查询语句)语句，以事件形式记录，还包含语句所执行的消耗的时间，MySQL的二进制日志是事务安全型的。一般来说开启二进制日志大概会有1%的性能损耗(参见MySQL官方中文手册 5.1.24版)。二进制有两个最重要的使用场景: 其一：MySQL Replication在Master端开启binlog，Mster把它的二进制日志传递给slaves来达到master-slave数据一致的目的。 其二：自然就是数据恢复了，通过使用mysqlbinlog工具来使恢复数据。\n二进制日志包括两类文件：\n二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件，\n二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。\nbinlog是一个二进制文件集合，每个binlog文件以一个4字节的魔数开头，接着是一组Events:\n魔数：0xfe62696e对应的是0xfebin；\nEvent：每个Event包含header和data两个部分；header提供了Event的创建时间，哪个服务器等信息，data部分提供的是针对该Event的具体信息，如具体数据的修改；\n第一个Event用于描述binlog文件的格式版本，这个格式就是event写入binlog文件的格式；\n其余的Event按照第一个Event的格式版本写入；\n最后一个Event用于说明下一个binlog文件；\nbinlog的索引文件是一个文本文件，其中内容为当前的binlog文件列表\n当遇到以下3种情况时，MySQL会重新生成一个新的日志文件，文件序号递增：\nMySQL服务器停止或重启时\n使用 flush logs 命令；\n当 binlog 文件大小超过 max_binlog_size 变量的值时；\nmax_binlog_size 的最小值是4096字节，最大值和默认值是 1GB (1073741824字节)。事务被写入到binlog的一个块中，所以它不会在几个二进制日志之间被拆分。\n因此，如果你有很大的事务，为了保证事务的完整性，不可能做切换日志的动作，只能将该事务的日志都记录到当前日志文件中，直到事务结束，你可能会看到binlog文件大于 max_binlog_size 的情况。\n写 Binlog 的时机\n对支持事务的引擎如InnoDB而言，是在prepare完commit前写的。binlog 什么时候刷新到磁盘跟参数 sync_binlog 相关。\n如果设置为0，则表示MySQL不控制binlog的刷新，由文件系统去控制它缓存的刷新；\n如果设置为不为0的值，则表示每 sync_binlog 次事务，MySQL调用文件系统的刷新操作刷新binlog到磁盘中。\n设为1是最安全的，在系统故障时最多丢失一个事务的更新，但是会对性能有所影响。\n如果 sync_binlog=0 或 sync_binlog大于1，当发生电源故障或操作系统崩溃时，可能有一部分已提交但其binlog未被同步到磁盘的事务会被丢失，恢复程序将无法恢复这部分事务。\n在MySQL 5.7.7之前，默认值 sync_binlog 是0，MySQL 5.7.7和更高版本使用默认值1，这是最安全的选择。一般情况下会设置为100或者0，牺牲一定的一致性来获取更好的性能。\n这涉及几个知识点\nredolog\n二段式提交\n当我们更新数据时，两阶段提交的具体流程：\n更新操作先写入redolog，这时候这条log的状态是prepared状态 再将逻辑日志写入binlog 最后在binlog写好之后，把redolog里的这条日志的状态改为commit redolog和undolog：innodb事务日志包括redo log和undo log。redo log是重做日志，提供前滚操作，undo log是回滚日志，提供回滚操作。\n三种日志的写入顺序 : undo log -\u003e redo log(prepare阶段) -\u003e bin log -\u003e commit\n详见：https://www.cnblogs.com/f-ck-need-u/p/9010872.html\n2. 三种模式 在 MySQL 5.7.7 之前，默认的格式是 STATEMENT，在 MySQL 5.7.7 及更高版本中，默认值是 ROW\n2.1 row level (默认) 记录的方式是行，即如果批量修改数据，记录的不是批量修改的SQL语句事件，而是每条记录被更改的SQL语句，因此，ROW模式的binlog日志文件会变得很“重”。\n优点：row level的binlog日志内容会非常清楚的记录下每一行数据被修改的细节。而且不会出现某些特定情况下存储过程或function，以及trigger的调用和触发器无法被正确复制的问题。\n缺点：row level下，所有执行的语句当记录到日志中的时候，都以每行记录的修改来记录，这样可能会产生大量的日志内容，产生的binlog日志量是惊人的。批量修改几百万条数据，那么记录几百万行……\n存的是具体的修改语句\n2.2 Statement level 记录每一条修改数据的SQL语句（批量修改时，记录的不是单条SQL语句，而是批量修改的SQL语句事件）。看上面的图解可以很好的理解row level和statement level两种模式的区别。\n存的是sql 语句\n优点：statement模式记录的更改的SQ语句事件，并非每条更改记录，所以大大减少了binlog日志量，节约磁盘IO，提高性能。\n缺点：statement level下对一些特殊功能的复制效果不是很好，比如：函数、存储过程的复制。由于row level是基于每一行的变化来记录的，所以不会出现类似问题\n行模式和语句模式的区别\n语句模式：\n​\t100万条记录,\t只需1条delete * from test；就可以删除100万条记录\nrow模式\n100万条记录 , 记录100万条删除命令\n2.3 Mixed 实际上就是前两种模式的结合。在Mixed模式下，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种。\n为什么不推荐使用mixed模式，理由如下\n假设master有两条记录，而slave只有一条记录。\nmaster的数据为\n+----+------------------------------------------------------+ | id | n | +----+------------------------------------------------------+ | 1 | d24c2c7e-430b-11e7-bf1b-00155d016710 | | 2 | ddd | +----+------------------------------------------------------+ slave的数据为\n+----+-------------------------------------------------------+ | id | n | +----+-------------------------------------------------------+ | 1 | d24c2c7e-430b-11e7-bf1b-00155d016710 | +----+-------------------------------------------------------+ 当在master上更新一条从库不存在的记录时，也就是id=2的记录，你会发现master是可以执行成功的。而slave拿到这个SQL后，也会照常执行，不报任何异常，只是更新操作不影响行数而已。并且你执行命令show slave status，查看输出，你会发现没有异常。但是，如果你是row模式，由于这行根本不存在，是会报1062错误的。\n3 查看与配置 配置:\n[mysqld] #设置日志路径，注意路经需要mysql用户有权限写,这里可以写绝对路径,也可以直接写mysql-bin(后者默认就是在/var/lib/mysql目录下) log-bin = /data/mysql/logs/mysql-bin.log #配置serverid server-id=1 #设置日志三种格式：STATEMENT、ROW、MIXED 。 binlog_format = mixed #设置binlog清理时间 expire_logs_days = 7 #binlog每个日志文件大小 max_binlog_size = 100m #binlog缓存大小 binlog_cache_size = 4m #最大binlog缓存大小 max_binlog_cache_size = 512m // 配置前两个亦可 查看biglog是否开启\nSHOW VARIABLES LIKE 'log_bin';\n查看binlog模式\nshow global variables like \"binlog%\";\nshow binlog events; #只查看第一个binlog文件的内容 show binlog events in 'mysql-bin.000002';#查看指定binlog文件的内容 show binary logs; #获取binlog文件列表 show master status； #查看当前正在写入的binlog文件 show variables like '%binlog_format%'; # 查看日志格式 mysqlbinlog工具\n/usr/local/mysql/bin/mysqlbinlog --start-datetime=\"2013-03-01 00:00:00\" --stop-datetime=\"2014-03-21 23:59:59\" /usr/local/mysql/var/mysql-bin.000007 -r test2.sql\n-r 输出到文件\n-v / -vv 查看binlog是row格式 -vv 展示更详细的sql信息\n-d 指定库名\n-h 指定ip\n-P 端口\n-u 指定用户名\n-p 指定密码\n–server-id= 指定sever-id\n当前查询binlog时一个事务日志被截断了,使用 --include-gtids 指定事务标识\ngtid（Global Transaction ID） : 全局事务id; 组成: server_uuid：transaction_id\n输出案例\n/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/; /*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/; DELIMITER /*!*/; # at 4 #190308 10:05:03 server id 1 end_log_pos 123 CRC32 0xff02e23d Start: binlog v 4, server v 5.7.22-log created 190308 10:05:03 # Warning: this binlog is either in use or was not closed properly. # at 123 #190308 10:05:03 server id 1 end_log_pos 154 CRC32 0xb81da4c5 Previous-GTIDs # [empty] # at 154 #190308 10:05:09 server id 1 end_log_pos 219 CRC32 0xfb30d42c Anonymous_GTID last_committed=0 sequence_number=1 rbr_only=yes /*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/; SET @@SESSION.GTID_NEXT= 'ANONYMOUS'/*!*/; # at 219 ... ... # at 21019 #190308 10:10:09 server id 1 end_log_pos 21094 CRC32 0x7a405abc Query thread_id=113 exec_time=0 error_code=0 SET TIMESTAMP=1552011009/*!*/; BEGIN /*!*/; # at 21094 #190308 10:10:09 server id 1 end_log_pos 21161 CRC32 0xdb7a2b35 Table_map: `maxwell`.`positions` mapped to number 110 # at 21161 #190308 10:10:09 server id 1 end_log_pos 21275 CRC32 0xec3be372 Update_rows: table id 110 flags: STMT_END_F ### UPDATE `maxwell`.`positions` ### WHERE ### @1=1 ### @2='master.000003' ### @3=20262 ### @4=NULL ### @5='maxwell' ### @6=NULL ### @7=1552011005707 ### SET ### @1=1 ### @2='master.000003' ### @3=20923 ### @4=NULL ### @5='maxwell' ### @6=NULL ### @7=1552011009790 # at 21275 #190308 10:10:09 server id 1 end_log_pos 21306 CRC32 0xe6c4346d Xid = 13088 COMMIT/*!*/; SET @@SESSION.GTID_NEXT= 'AUTOMATIC' /* added by mysqlbinlog */ /*!*/; DELIMITER ; # End of log file /*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/; /*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/; 比较关注的就是里面的修改类语句\n截取其中的一段进行分析：\n# at 21019 #190308 10:10:09 server id 1 end_log_pos 21094 CRC32 0x7a405abc Query thread_id=113 exec_time=0 error_code=0 SET TIMESTAMP=1552011009/*!*/; BEGIN /*!*/; 上面输出包括信息：\nposition: 位于文件中的位置，即第一行的（# at 21019）,说明该事件记录从文件第21019个字节开始\ntimestamp: 事件发生的时间戳，即第二行的（#190308 10:10:09）\nserver id: 服务器标识（1）\nend_log_pos 表示下一个事件开始的位置（即当前事件的结束位置+1）\nthread_id: 执行该事件的线程id （thread_id=113）\nexec_time: 事件执行的花费时间\nerror_code: 错误码，0意味着没有发生错误\ntype:事件类型Query\n一些常见的事件类型\n事件类型 说明 QUERY_EVENT 执行更新语句时会生成此事件，包括：create，insert，update，delete； STOP_EVENT 当mysqld停止时生成此事件 ROTATE_EVENT 当mysqld切换到新的binlog文件生成此事件，切换到新的binlog文件可以通过执行flush logs命令或者binlog文件大于 max_binlog_size 参数配置的大小； INTVAR_EVENT 当sql语句中使用了AUTO_INCREMENT的字段或者LAST_INSERT_ID()函数；此事件没有被用在binlog_format为ROW模式的情况下 XID_EVENT 支持XA的存储引擎才有，本地测试的数据库存储引擎是innodb，所有上面出现了XID_EVENT；innodb事务提交产生了QUERY_EVENT的BEGIN声明，QUERY_EVENT以及COMMIT声明，如果是myIsam存储引擎也会有BEGIN和COMMIT声明，只是COMMIT类型不是XID_EVENT TABLE_MAP_EVENT 用在binlog_format为ROW模式下，将表的定义映射到一个数字，在行操作事件之前记录（包括：WRITE_ROWS_EVENT，UPDATE_ROWS_EVENT，DELETE_ROWS_EVENT） WRITE_ROWS_EVENT 用在binlog_format为ROW模式下，对应 insert 操作 UPDATE_ROWS_EVENT 用在binlog_format为ROW模式下，对应 update 操作 DELETE_ROWS_EVENT 用在binlog_format为ROW模式下，对应 delete 操作 参考链接\nbinlog配置 binlog三种模式-博客园 查询binlog日志 mysql-binlog binlog和redolog ","wordCount":"4210","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-28T17:01:18.723436506Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/binlog.html"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="米二 (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>米二</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://xiaokunji.com/zh/search.html title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=📚文章><span>📚文章</span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=🔖标签><span>🔖标签</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=📖分类><span>📖分类</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>🏠</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93.html>数据库</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql.html>MySQL</a> <span>></span></ul></nav><h1 class=post-title>binlog</h1><div class=post-description></div><div class=post-meta><span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;·&nbsp;9 分钟&nbsp;·&nbsp;xkj
&nbsp;|&nbsp;分类: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/%E6%95%B0%E6%8D%AE%E5%BA%93.html>数据库</a></ul><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#1-%e5%89%8d%e8%a8%80 aria-label="1. 前言">1. 前言</a></li><li><a href=#2-%e4%b8%89%e7%a7%8d%e6%a8%a1%e5%bc%8f aria-label="2. 三种模式">2. 三种模式</a><ul><li><a href=#21-row-level-%e9%bb%98%e8%ae%a4 aria-label="2.1 row level (默认)">2.1 row level (默认)</a></li><li><a href=#22-statement-level aria-label="2.2 Statement level">2.2 Statement level</a></li><li><a href=#23-mixed aria-label="2.3 Mixed">2.3 Mixed</a></li></ul></li><li><a href=#3-%e6%9f%a5%e7%9c%8b%e4%b8%8e%e9%85%8d%e7%bd%ae aria-label="3 查看与配置">3 查看与配置</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1-前言>1. 前言<a hidden class=anchor aria-hidden=true href=#1-前言>#</a></h1><p>MySQL的二进制日志可以说是MySQL最重要的日志了，它记录了所有的DDL和DML(除了数据查询语句)语句，以事件形式记录，还包含语句所执行的消耗的时间，MySQL的二进制日志是事务安全型的。一般来说开启二进制日志大概会有1%的性能损耗(参见MySQL官方中文手册 5.1.24版)。二进制有两个最重要的使用场景:
其一：MySQL Replication在Master端开启binlog，Mster把它的二进制日志传递给slaves来达到master-slave数据一致的目的。
其二：自然就是数据恢复了，通过使用mysqlbinlog工具来使恢复数据。</p><p>二进制日志包括两类文件：</p><ul><li><p>二进制日志索引文件（文件名后缀为.index）用于记录所有的二进制文件，</p></li><li><p>二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML(除了数据查询语句)语句事件。</p></li></ul><p>binlog是一个二进制文件集合，每个binlog文件以一个4字节的魔数开头，接着是一组Events:</p><p>魔数：0xfe62696e对应的是0xfebin；</p><p>Event：每个Event包含header和data两个部分；header提供了Event的创建时间，哪个服务器等信息，data部分提供的是针对该Event的具体信息，如具体数据的修改；</p><p>第一个Event用于描述binlog文件的格式版本，这个格式就是event写入binlog文件的格式；</p><p>其余的Event按照第一个Event的格式版本写入；</p><p>最后一个Event用于说明下一个binlog文件；</p><p>binlog的索引文件是一个文本文件，其中内容为当前的binlog文件列表</p><p>当遇到以下3种情况时，MySQL会重新生成一个新的日志文件，文件序号递增：</p><ul><li><p>MySQL服务器停止或重启时</p></li><li><p>使用 flush logs 命令；</p></li><li><p>当 binlog 文件大小超过 max_binlog_size 变量的值时；</p></li></ul><p><code>max_binlog_size</code> 的最小值是4096字节，最大值和默认值是 1GB (1073741824字节)。事务被写入到binlog的一个块中，所以它不会在几个二进制日志之间被拆分。</p><p>因此，如果你有很大的事务，为了保证事务的完整性，不可能做切换日志的动作，只能将该事务的日志都记录到当前日志文件中，直到事务结束，你可能会看到binlog文件大于 <code>max_binlog_size</code> 的情况。</p><p><strong>写 Binlog 的时机</strong></p><p>对支持事务的引擎如<strong>InnoDB而言，是在prepare完commit前写的</strong>。binlog 什么时候刷新到磁盘跟参数 <code>sync_binlog</code> 相关。</p><p>如果设置为0，则表示MySQL不控制binlog的刷新，由文件系统去控制它缓存的刷新；</p><p>如果设置为不为0的值，则表示每 sync_binlog 次事务，MySQL调用文件系统的刷新操作刷新binlog到磁盘中。</p><p>设为1是最安全的，在系统故障时最多丢失一个事务的更新，但是会对性能有所影响。</p><p>如果 sync_binlog=0 或 sync_binlog大于1，当发生电源故障或操作系统崩溃时，可能有一部分已提交但其binlog未被同步到磁盘的事务会被丢失，恢复程序将无法恢复这部分事务。</p><p>在MySQL 5.7.7之前，默认值 sync_binlog 是0，<u>MySQL 5.7.7和更高版本使用默认值1</u>，这是最安全的选择。一般情况下会设置为100或者0，牺牲一定的一致性来获取更好的性能。</p><blockquote><p>这涉及几个知识点</p><ul><li><p>redolog</p></li><li><p>二段式提交</p><p>当我们更新数据时，两阶段提交的具体流程：</p><ul><li>更新操作先写入redolog，这时候这条log的状态是prepared状态</li><li>再将逻辑日志写入binlog</li><li>最后在binlog写好之后，把redolog里的这条日志的状态改为commit</li></ul></li></ul><p><strong>redolog和undolog</strong>：innodb事务日志包括redo log和undo log。redo log是重做日志，提供前滚操作，undo log是回滚日志，提供回滚操作。</p><p><strong>三种日志的写入顺序 : undo log -> redo log(prepare阶段) -> bin log -> commit</strong></p><p>详见：https://www.cnblogs.com/f-ck-need-u/p/9010872.html</p></blockquote><h1 id=2-三种模式>2. 三种模式<a hidden class=anchor aria-hidden=true href=#2-三种模式>#</a></h1><p>在 <code>MySQL 5.7.7</code> 之前，默认的格式是 <code>STATEMENT</code>，在 <code>MySQL 5.7.7</code> 及更高版本中，默认值是 <code>ROW</code></p><h2 id=21-row-level-默认>2.1 row level (默认)<a hidden class=anchor aria-hidden=true href=#21-row-level-默认>#</a></h2><p>记录的方式是行，即如果批量修改数据，记录的不是批量修改的SQL语句事件，而是每条记录被更改的SQL语句，因此，ROW模式的binlog日志文件会变得很“重”。</p><p><img loading=lazy src=https://images2018.cnblogs.com/blog/163758/201809/163758-20180905223630873-1667858615.png alt=image></p><p><strong>优点</strong>：row level的binlog日志内容会非常清楚的记录下每一行数据被修改的细节。而且不会出现某些特定情况下存储过程或function，以及trigger的调用和触发器无法被正确复制的问题。</p><p><strong>缺点</strong>：row level下，所有执行的语句当记录到日志中的时候，都以每行记录的修改来记录，这样可能会产生大量的日志内容，产生的binlog日志量是惊人的。批量修改几百万条数据，那么记录几百万行……</p><blockquote><p>存的是具体的修改语句</p></blockquote><h2 id=22-statement-level>2.2 Statement level<a hidden class=anchor aria-hidden=true href=#22-statement-level>#</a></h2><p>记录每一条修改数据的SQL语句（批量修改时，记录的不是单条SQL语句，而是批量修改的SQL语句事件）。看上面的图解可以很好的理解row level和statement level两种模式的区别。</p><blockquote><p>存的是sql 语句</p></blockquote><p><strong>优点</strong>：statement模式记录的更改的SQ语句事件，并非每条更改记录，所以大大减少了binlog日志量，节约磁盘IO，提高性能。</p><p><strong>缺点</strong>：statement level下对一些特殊功能的复制效果不是很好，比如：函数、存储过程的复制。由于row level是基于每一行的变化来记录的，所以不会出现类似问题</p><blockquote><p>行模式和语句模式的区别</p><ol><li><p>语句模式：</p><p>​ 100万条记录, 只需1条delete * from test；就可以删除100万条记录</p></li><li><p>row模式</p><p>100万条记录 , 记录100万条删除命令</p></li></ol></blockquote><h2 id=23-mixed>2.3 Mixed<a hidden class=anchor aria-hidden=true href=#23-mixed>#</a></h2><p>实际上就是前两种模式的结合。在Mixed模式下，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种。</p><blockquote><p>为什么不推荐使用<code>mixed</code>模式，理由如下</p><p>假设master有两条记录，而slave只有一条记录。</p><p>master的数据为</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>+----+------------------------------------------------------+
</span></span><span style=display:flex><span>| id | n |
</span></span><span style=display:flex><span>+----+------------------------------------------------------+
</span></span><span style=display:flex><span>| 1 | d24c2c7e-430b-11e7-bf1b-00155d016710 |
</span></span><span style=display:flex><span>| 2 | ddd |
</span></span><span style=display:flex><span>+----+------------------------------------------------------+
</span></span></code></pre></div><p>slave的数据为</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>+----+-------------------------------------------------------+
</span></span><span style=display:flex><span>| id | n |
</span></span><span style=display:flex><span>+----+-------------------------------------------------------+
</span></span><span style=display:flex><span>| 1 | d24c2c7e-430b-11e7-bf1b-00155d016710 |
</span></span><span style=display:flex><span>+----+-------------------------------------------------------+
</span></span></code></pre></div><p>当在<code>master</code>上更新一条从库不存在的记录时，也就是<code>id=2</code>的记录，你会发现<code>master</code>是可以执行成功的。而<code>slave</code>拿到这个SQL后，也会照常执行，不报任何异常，只是更新操作不影响行数而已。并且你执行命令<code>show slave status</code>，查看输出，你会发现没有异常。但是，如果你是<code>row</code>模式，由于这行根本不存在，是会报1062错误的。</p></blockquote><h1 id=3-查看与配置>3 查看与配置<a hidden class=anchor aria-hidden=true href=#3-查看与配置>#</a></h1><p>配置:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#f85149>[mysqld]</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#设置日志路径，注意路经需要mysql用户有权限写,这里可以写绝对路径,也可以直接写mysql-bin(后者默认就是在/var/lib/mysql目录下)</span>
</span></span><span style=display:flex><span>log-bin <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>/data/mysql/logs/mysql-bin.log</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#配置serverid</span>
</span></span><span style=display:flex><span>server-id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#设置日志三种格式：STATEMENT、ROW、MIXED 。</span>
</span></span><span style=display:flex><span>binlog_format <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>mixed</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#设置binlog清理时间</span>
</span></span><span style=display:flex><span>expire_logs_days <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>7</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#binlog每个日志文件大小</span>
</span></span><span style=display:flex><span>max_binlog_size <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>100m</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#binlog缓存大小</span>
</span></span><span style=display:flex><span>binlog_cache_size <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>4m</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#最大binlog缓存大小</span>
</span></span><span style=display:flex><span>max_binlog_cache_size <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>512m</span>
</span></span><span style=display:flex><span>// <span style=color:#a5d6ff>配置前两个亦可</span>
</span></span></code></pre></div><p>查看biglog是否开启</p><p><code>SHOW VARIABLES LIKE 'log_bin';</code></p><p>查看binlog模式</p><p><code>show global variables like "binlog%";</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#ff7b72>show</span><span style=color:#6e7681> </span>binlog<span style=color:#6e7681> </span>events;<span style=color:#6e7681>   </span><span style=color:#8b949e;font-style:italic>#只查看第一个binlog文件的内容
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>show</span><span style=color:#6e7681> </span>binlog<span style=color:#6e7681> </span>events<span style=color:#6e7681> </span><span style=color:#ff7b72>in</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;mysql-bin.000002&#39;</span>;<span style=color:#8b949e;font-style:italic>#查看指定binlog文件的内容
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>show</span><span style=color:#6e7681> </span><span style=color:#ff7b72>binary</span><span style=color:#6e7681> </span>logs;<span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic>#获取binlog文件列表
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>show</span><span style=color:#6e7681> </span>master<span style=color:#6e7681> </span>status<span style=color:#f85149>；</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>#查看当前正在写入的binlog文件
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>show</span><span style=color:#6e7681>  </span>variables<span style=color:#6e7681> </span><span style=color:#ff7b72>like</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;%binlog_format%&#39;</span>;<span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># 查看日志格式
</span></span></span></code></pre></div><p><strong>mysqlbinlog工具</strong></p><p><code>/usr/local/mysql/bin/mysqlbinlog --start-datetime="2013-03-01 00:00:00" --stop-datetime="2014-03-21 23:59:59" /usr/local/mysql/var/mysql-bin.000007 -r test2.sql</code></p><blockquote><p>-r 输出到文件</p><p>-v / -vv 查看binlog是row格式 -vv 展示更详细的sql信息</p><p>-d 指定库名</p><p>-h 指定ip</p><p>-P 端口</p><p>-u 指定用户名</p><p>-p 指定密码</p><p>&ndash;server-id= 指定sever-id</p><p>当前查询binlog时一个事务日志被截断了,使用 <code>--include-gtids</code> 指定事务标识</p><p>gtid（Global Transaction ID） : 全局事务id; 组成: <code>server_uuid：transaction_id</code></p></blockquote><p>输出案例</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>DELIMITER<span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>/*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># at 4
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:05:03 server id 1  end_log_pos 123 CRC32 0xff02e23d     Start: binlog v 4, server v 5.7.22-log created 190308 10:05:03
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Warning: this binlog is either in use or was not closed properly.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># at 123
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:05:03 server id 1  end_log_pos 154 CRC32 0xb81da4c5     Previous-GTIDs
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># [empty]
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># at 154
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:05:09 server id 1  end_log_pos 219 CRC32 0xfb30d42c     Anonymous_GTID  last_committed=0    sequence_number=1   rbr_only=yes
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#8b949e;font-style:italic>/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>SET</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>@@</span>SESSION.GTID_NEXT<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;ANONYMOUS&#39;</span><span style=color:#8b949e;font-style:italic>/*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># at 219
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>...<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>...<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># at 21019
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query   thread_id=113   exec_time=0 error_code=0
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>SET</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TIMESTAMP</span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1552011009</span><span style=color:#8b949e;font-style:italic>/*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>BEGIN<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>/*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># at 21094
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:10:09 server id 1  end_log_pos 21161 CRC32 0xdb7a2b35     Table_map: `maxwell`.`positions` mapped to number 110
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># at 21161
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:10:09 server id 1  end_log_pos 21275 CRC32 0xec3be372     Update_rows: table id 110 flags: STMT_END_F
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>### UPDATE `maxwell`.`positions`
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>### WHERE
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @1=1
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @2=&#39;master.000003&#39;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @3=20262
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @4=NULL
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @5=&#39;maxwell&#39;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @6=NULL
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @7=1552011005707
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>### SET
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @1=1
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @2=&#39;master.000003&#39;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @3=20923
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @4=NULL
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @5=&#39;maxwell&#39;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @6=NULL
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>###   @7=1552011009790
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># at 21275
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#190308 10:10:09 server id 1  end_log_pos 21306 CRC32 0xe6c4346d     Xid = 13088
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>COMMIT<span style=color:#8b949e;font-style:italic>/*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>SET</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>@@</span>SESSION.GTID_NEXT<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#39;AUTOMATIC&#39;</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>/* added by mysqlbinlog */</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>/*!*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>DELIMITER<span style=color:#6e7681> </span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># End of log file
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#8b949e;font-style:italic>/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/</span>;<span style=color:#6e7681>
</span></span></span></code></pre></div><p>比较关注的就是里面的修改类语句</p><p>截取其中的一段进行分析：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># at 21019
</span></span><span style=display:flex><span>#190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query   thread_id=113   exec_time=0 error_code=0
</span></span><span style=display:flex><span>SET TIMESTAMP=1552011009/*!*/;
</span></span><span style=display:flex><span>BEGIN
</span></span><span style=display:flex><span>/*!*/;
</span></span></code></pre></div><p>上面输出包括信息：</p><ul><li><p>position: 位于文件中的位置，即第一行的（# at 21019）,说明该事件记录从文件第21019个字节开始</p></li><li><p>timestamp: 事件发生的时间戳，即第二行的（#190308 10:10:09）</p></li><li><p>server id: 服务器标识（1）</p></li><li><p>end_log_pos 表示下一个事件开始的位置（即当前事件的结束位置+1）</p></li><li><p>thread_id: 执行该事件的线程id （thread_id=113）</p></li><li><p>exec_time: 事件执行的花费时间</p></li><li><p>error_code: 错误码，0意味着没有发生错误</p></li><li><p>type:事件类型Query</p></li></ul><blockquote><p>一些常见的事件类型</p><table><thead><tr><th>事件类型</th><th>说明</th></tr></thead><tbody><tr><td>QUERY_EVENT</td><td>执行更新语句时会生成此事件，包括：create，insert，update，delete；</td></tr><tr><td>STOP_EVENT</td><td>当mysqld停止时生成此事件</td></tr><tr><td>ROTATE_EVENT</td><td>当mysqld切换到新的binlog文件生成此事件，切换到新的binlog文件可以通过执行flush logs命令或者binlog文件大于 <code>max_binlog_size</code> 参数配置的大小；</td></tr><tr><td>INTVAR_EVENT</td><td>当sql语句中使用了AUTO_INCREMENT的字段或者LAST_INSERT_ID()函数；此事件没有被用在binlog_format为ROW模式的情况下</td></tr><tr><td>XID_EVENT</td><td>支持XA的存储引擎才有，本地测试的数据库存储引擎是innodb，所有上面出现了XID_EVENT；innodb事务提交产生了QUERY_EVENT的BEGIN声明，QUERY_EVENT以及COMMIT声明，如果是myIsam存储引擎也会有BEGIN和COMMIT声明，只是COMMIT类型不是XID_EVENT</td></tr><tr><td>TABLE_MAP_EVENT</td><td>用在binlog_format为ROW模式下，将表的定义映射到一个数字，在行操作事件之前记录（包括：WRITE_ROWS_EVENT，UPDATE_ROWS_EVENT，DELETE_ROWS_EVENT）</td></tr><tr><td>WRITE_ROWS_EVENT</td><td>用在binlog_format为ROW模式下，对应 insert 操作</td></tr><tr><td>UPDATE_ROWS_EVENT</td><td>用在binlog_format为ROW模式下，对应 update 操作</td></tr><tr><td>DELETE_ROWS_EVENT</td><td>用在binlog_format为ROW模式下，对应 delete 操作</td></tr></tbody></table></blockquote><p>参考链接</p><p><a href=https://blog.csdn.net/weixin_43944305/article/details/108620849 target=_blank rel=noopener>binlog配置</a></p><p><a href=https://www.cnblogs.com/rinack/p/9595370.html target=_blank rel=noopener>binlog三种模式-博客园</a></p><p><a href=https://www.cnblogs.com/softidea/p/12624778.html target=_blank rel=noopener>查询binlog日志</a></p><p><a href=https://blog.csdn.net/chushoufengli/article/details/106748672 target=_blank rel=noopener>mysql-binlog</a></p><p><a href=https://www.jianshu.com/p/ac7bcfc656eb target=_blank rel=noopener>binlog和redolog</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/mysql.html>MySQL</a></li><li><a href=https://xiaokunji.com/zh/tags/%E6%95%B0%E6%8D%AE%E5%BA%93.html>数据库</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring/aop.html><span class=title>« 上一页</span><br><span>aop</span></a>
<a class=next href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springcloud/bus.html><span class=title>下一页 »</span><br><span>Bus</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>米二</a>
All Rights Reserved</span>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container><span class="fa fa-user">用户数:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">访问数:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>