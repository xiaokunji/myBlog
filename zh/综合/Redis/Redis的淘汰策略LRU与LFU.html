<!DOCTYPE html>
<html dir="auto" lang="zh"><head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="x-ua-compatible"/><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"/><meta content="index, follow" name="robots"/><title>Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU | ç±³äºŒ</title>
<meta content=" redisä¸­çš„LRUå®ç°,define LRU_BITS 24,define REDIS_LRU_BITS 24, redisä¸­çš„LFUå®ç°,  ldt(Last Decrement Time), logc(Logistic Counter), logc ç®—æ³•è°ƒæ•´, æ‰©å±•, æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥" name="keywords"/><meta content="     " name="description"/><meta content="xkj" name="author"/><link href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis/Redis%E7%9A%84%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5LRU%E4%B8%8ELFU.html" rel="canonical"/><link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.dc6bd2c841ee388e899e13872ae986c0e847e8b957d6714ad6ddc628ef2d17ff.css" integrity="sha256-3GvSyEHuOI6JnhOHKumGwOhH6LlX1nFK1t3GKO8tF/8=" rel="preload stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js"></script><link href="https://xiaokunji.com/img/Q.svg" rel="icon"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="16x16" type="image/png"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="32x32" type="image/png"/><link href="https://xiaokunji.com/Q.svg" rel="apple-touch-icon"/><link href="https://xiaokunji.com/Q.svg" rel="mask-icon"/><meta content="#2e2e33" name="theme-color"/><meta content="#2e2e33" name="msapplication-TileColor"/><link href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis/Redis%E7%9A%84%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5LRU%E4%B8%8ELFU.html" hreflang="zh" rel="alternate"/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta content="Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU" property="og:title"/><meta content="     " property="og:description"/><meta content="article" property="og:type"/><meta content="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis/Redis%E7%9A%84%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5LRU%E4%B8%8ELFU.html" property="og:url"/><meta content="ç»¼åˆ" property="article:section"/><meta content="2023-08-22T00:00:00+00:00" property="article:published_time"/><meta content="2023-08-22T22:36:07+08:00" property="article:modified_time"/><meta content="summary" name="twitter:card"/><meta content="Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU" name="twitter:title"/><meta content="     " name="twitter:description"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU","item":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis/Redis%E7%9A%84%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5LRU%E4%B8%8ELFU.html"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU","name":"Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU","description":"     ","keywords":[" redisä¸­çš„LRUå®ç°","define LRU_BITS 24","define REDIS_LRU_BITS 24"," redisä¸­çš„LFUå®ç°","  ldt(Last Decrement Time)"," logc(Logistic Counter)"," logc ç®—æ³•è°ƒæ•´"," æ‰©å±•"," æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥"],"articleBody":"[toc]\né‡Šæ”¾å†…å­˜å…¶å®åœ¨æ¯æ¬¡å¤„ç†å‘½ä»¤æ—¶éƒ½ä¼šæ‰§è¡Œ, åªæ˜¯æ»¡è¶³åˆ¤æ–­æ¡ä»¶æ‰æ‰§è¡Œ , ä¾‹å¦‚å†…å­˜æ»¡äº†, éœ€è¦æ·˜æ±°keyç­‰ç­‰æ¡ä»¶, è‹¥å‘ç°å·²ç”¨å†…å­˜è¶…å‡ºmaxmemoryï¼Œä¼šè®¡ç®—éœ€é‡Šæ”¾çš„å†…å­˜é‡ã€‚è¿™ä¸ª é‡Šæ”¾å†…å­˜å¤§å°=å·²ä½¿ç”¨å†…å­˜é‡-maxmemoryã€‚\nredisä¸­çš„LRUå®ç° redisæ²¡æœ‰ä½¿ç”¨æ ‡å‡†çš„LRUç®—æ³•, åªæ˜¯è¿‘ä¼¼çš„LRUç®—æ³•, å› ä¸ºå«ŒLinkedListå ç”¨çš„ç©ºé—´å¤ªå¤§äº†(å› ä¸ºèµ·ç è¦è®°å½•å¤´å°¾æŒ‡é’ˆ)\nç®€è¿°: redisé€šè¿‡è®¡ç®—æ¯ä¸ªkeyçš„é—²ç½®æ—¶é—´æ¥å†³å®šæ˜¯å¦è¦é€‰å®ƒæ·˜æ±°(å…¨å±€æ—¶é’Ÿ å‡å» å½“å‰keyçš„è®¿é—®æ—¶é’Ÿ), redisä¼šéšæœºé€‰å‡ ä¸ªkey, å®ƒä»¬çš„é—²ç½®æ—¶é—´éƒ½è¦å¤§äºä¸€ä¸ªé˜ˆå€¼(å…¶å®ä¼šå­˜å…¥ä¸€ä¸ªpool, è¿™ä¸ªé˜ˆå€¼å°±æ˜¯poolä¸­æœ€å°çš„é—²ç½®æ—¶é—´), å½“å†…å­˜ä¸å¤Ÿæ—¶, å°±ä»è¿™å‡ ä¸ªkeyä¸­æ·˜æ±°é—²ç½®æ—¶é—´æœ€å¤§çš„å€¼\né¦–å…ˆçœ‹ä¸€ä¸‹å…¨å±€æ—¶é’Ÿå®šä¹‰\n#define LRU_BITS 24 struct redisServer { pid_t pid; /* Main process pid. */ char *configfile; /* Absolute config file path, or NULL */ â€¦.. unsigned lruclock:LRU_BITS; /* Clock for LRU eviction */ ... }; redisServer ä¸­åŒ…å«äº†redisæœåŠ¡å™¨å¯åŠ¨ä¹‹åçš„åŸºæœ¬ä¿¡æ¯(PID,é…ç½®æ–‡ä»¶è·¯å¾„,serverCronè¿è¡Œé¢‘ç‡hzç­‰),å¤–éƒ¨å¯è°ƒç”¨æ¨¡å—ä¿¡æ¯ï¼Œç½‘ç»œä¿¡æ¯ï¼ŒRDB/AOFä¿¡æ¯ï¼Œæ—¥å¿—ä¿¡æ¯ï¼Œå¤åˆ¶ä¿¡æ¯ç­‰ç­‰ã€‚\nä¸Šè¿°ç»“æ„ä½“ä¸­lruclock:LRU_BITS,å…¶ä¸­å­˜å‚¨äº†æœåŠ¡å™¨è‡ªå¯åŠ¨ä¹‹åçš„lruæ—¶é’Ÿï¼Œè¯¥æ—¶é’Ÿæ˜¯å…¨å±€çš„lruæ—¶é’Ÿã€‚è¯¥æ—¶é’Ÿ100msæ›´æ–°ä¸€æ¬¡ã€‚\nå¯ä»¥é€šè¿‡hzæ¥è°ƒæ•´,é»˜è®¤æƒ…å†µhz=10,å› æ­¤æ¯1000ms/10=100msæ‰§è¡Œä¸€æ¬¡å®šæ—¶ä»»åŠ¡\nå› æ­¤lrulockæœ€å¤§èƒ½åˆ°(2**24-1)/3600/24 = 194å¤©,å¦‚æœè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œlrulocké‡æ–°å¼€å§‹ã€‚å¯¹äºredis serveræ¥è¯´ï¼Œserver.lrulockè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå…¨å±€çš„lrulockï¼Œ\nå¦‚æœå…¨å±€æ—¶é’Ÿ å°äº å¯¹è±¡æ—¶é’Ÿ, åˆ™ä¼šå†åŠ ä¸Šæ—¶é’Ÿæœ€å¤§å€¼ REDIS_LRU_CLOCK_MAX , ä¹Ÿå°±æ˜¯ 194å¤© çš„ç§’æ•°, ç›¸å½“äºæ˜¯ç¬¬äºŒè½®äº†\n/* Given an object returns the min number of seconds the object was never * requested, using an approximated LRU algorithm. */ #define REDIS_LRU_CLOCK_MAX ((1\u003c","wordCount":"4300","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-22T22:36:07+08:00","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis/Redis%E7%9A%84%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5LRU%E4%B8%8ELFU.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class="dark" id="top"><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class="header"><nav class="nav"><div class="logo"><a accesskey="h" href="https://xiaokunji.com/zh/" title="ç±³äºŒ (Alt + H)"><img alt="" aria-label="logo" height="35" src="https://xiaokunji.com/img/Q.svg"/>ç±³äºŒ</a><div class="logo-switches"><button accesskey="t" id="theme-toggle" title="(Alt + T)"><svg fill="none" height="18" id="moon" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg><svg fill="none" height="18" id="sun" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg></button><ul class="lang-switch"><li>|</li><li><a aria-label="English" href="https://xiaokunji.com/en/" title="English">English</a></li></ul></div></div><ul id="menu"><li><a href="https://xiaokunji.com/zh/" title="ğŸ ä¸»é¡µ"><span>ğŸ ä¸»é¡µ</span></a></li><li><a accesskey="/" href="https://xiaokunji.com/zh/search" title="ğŸ”æœç´¢ (Alt + /)"><span>ğŸ”æœç´¢</span></a></li><li><a href="https://xiaokunji.com/zh/post.html" title="ğŸ“šæ–‡ç« "><span>ğŸ“šæ–‡ç« </span></a></li><li><a href="https://xiaokunji.com/zh/archives.html" title="â±æ—¶é—´è½´"><span>â±æ—¶é—´è½´</span></a></li><li><a href="https://xiaokunji.com/zh/tags.html" title="ğŸ”–æ ‡ç­¾"><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href="https://xiaokunji.com/zh/categories.html" title="ğŸ“–åˆ†ç±»"><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href="https://xiaokunji.com/zh/links.html" title="ğŸ¤å‹é“¾"><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><nav aria-label="breadcrumb"><ul><a href="https://xiaokunji.com/zh/">ğŸ </a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88.html">ç»¼åˆ</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis.html">Redis</a> <span>&gt;</span></ul></nav><h1 class="post-title">Redisçš„æ·˜æ±°ç­–ç•¥LRUä¸LFU</h1><div class="post-description"></div><div class="post-meta">åˆ›å»º:&amp;nbsp;&lt;span title='2023-08-22 00:00:00 +0000 UTC'&gt;2023-08-22&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;æ›´æ–°:&amp;nbsp;2023-08-22&amp;nbsp;Â·&amp;nbsp;xkj
Â |Â åˆ†ç±»: Â <ul class="post-categories-meta" style="display:inline"><a href="https://xiaokunji.com/zh/categories/%E7%BB%BC%E5%90%88.html">ç»¼åˆ</a></ul><span id="busuanzi_container_page_pv">Â | è®¿é—®: <span id="busuanzi_value_page_pv">1</span></span></div></header><aside class="toc-container wide" id="toc-container"><div class="toc"><details open=""><summary accesskey="c" title="(Alt + C)"><span class="details">ç›®å½•</span></summary><div class="inner"><ul><li><a aria-label="redisä¸­çš„LRUå®ç°" href="#redis%e4%b8%ad%e7%9a%84lru%e5%ae%9e%e7%8e%b0">redisä¸­çš„LRUå®ç°</a></li><li><a aria-label="redisä¸­çš„LFUå®ç°" href="#redis%e4%b8%ad%e7%9a%84lfu%e5%ae%9e%e7%8e%b0">redisä¸­çš„LFUå®ç°</a><ul><li><a aria-label="ldt(Last Decrement Time)" href="#ldtlast-decrement-time">ldt(Last Decrement Time)</a></li><li><a aria-label="logc(Logistic Counter)" href="#logclogistic-counter">logc(Logistic Counter)</a></li><li><a aria-label="logc ç®—æ³•è°ƒæ•´" href="#logc-%e7%ae%97%e6%b3%95%e8%b0%83%e6%95%b4">logc ç®—æ³•è°ƒæ•´</a></li></ul></li><li><a aria-label="æ‰©å±•" href="#%e6%89%a9%e5%b1%95">æ‰©å±•</a><ul><li><a aria-label="æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥" href="#%e6%b7%98%e6%b1%b0%e6%b1%a0%e7%9a%84%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5">æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class="post-content"><p>[toc]</p><blockquote><p>é‡Šæ”¾å†…å­˜å…¶å®åœ¨æ¯æ¬¡å¤„ç†å‘½ä»¤æ—¶éƒ½ä¼šæ‰§è¡Œ, åªæ˜¯æ»¡è¶³åˆ¤æ–­æ¡ä»¶æ‰æ‰§è¡Œ , ä¾‹å¦‚å†…å­˜æ»¡äº†, éœ€è¦æ·˜æ±°keyç­‰ç­‰æ¡ä»¶, è‹¥å‘ç°å·²ç”¨å†…å­˜è¶…å‡º<code>maxmemory</code>ï¼Œä¼šè®¡ç®—éœ€é‡Šæ”¾çš„å†…å­˜é‡ã€‚è¿™ä¸ª <code>é‡Šæ”¾å†…å­˜å¤§å°=å·²ä½¿ç”¨å†…å­˜é‡-maxmemory</code>ã€‚</p></blockquote><h1 id="redisä¸­çš„lruå®ç°">redisä¸­çš„LRUå®ç°<a aria-hidden="true" class="anchor" hidden="" href="#redisä¸­çš„lruå®ç°">#</a></h1><p>redisæ²¡æœ‰ä½¿ç”¨æ ‡å‡†çš„LRUç®—æ³•, åªæ˜¯è¿‘ä¼¼çš„LRUç®—æ³•, å› ä¸ºå«ŒLinkedListå ç”¨çš„ç©ºé—´å¤ªå¤§äº†(å› ä¸ºèµ·ç è¦è®°å½•å¤´å°¾æŒ‡é’ˆ)</p><blockquote><p>ç®€è¿°: redisé€šè¿‡è®¡ç®—æ¯ä¸ªkeyçš„é—²ç½®æ—¶é—´æ¥å†³å®šæ˜¯å¦è¦é€‰å®ƒæ·˜æ±°(å…¨å±€æ—¶é’Ÿ å‡å» å½“å‰keyçš„è®¿é—®æ—¶é’Ÿ), redisä¼šéšæœºé€‰å‡ ä¸ªkey, å®ƒä»¬çš„é—²ç½®æ—¶é—´éƒ½è¦å¤§äºä¸€ä¸ªé˜ˆå€¼(å…¶å®ä¼šå­˜å…¥ä¸€ä¸ªpool, è¿™ä¸ªé˜ˆå€¼å°±æ˜¯poolä¸­æœ€å°çš„é—²ç½®æ—¶é—´), å½“å†…å­˜ä¸å¤Ÿæ—¶, å°±<strong>ä»è¿™å‡ ä¸ªkeyä¸­æ·˜æ±°é—²ç½®æ—¶é—´æœ€å¤§çš„å€¼</strong></p></blockquote><p>é¦–å…ˆçœ‹ä¸€ä¸‹å…¨å±€æ—¶é’Ÿå®šä¹‰</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c++" data-lang="c++"><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic">#define LRU_BITS 24
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic"></span><span style="color:#ff7b72">struct</span> <span style="color:#f0883e;font-weight:700">redisServer</span> {
</span></span><span style="display:flex"><span>       pid_t pid; <span style="color:#8b949e;font-style:italic">/* Main process pid. */</span>
</span></span><span style="display:flex"><span>       <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:700">*</span>configfile; <span style="color:#8b949e;font-style:italic">/* Absolute config file path, or NULL */</span>
</span></span><span style="display:flex"><span>       <span style="color:#f85149">â€¦</span>..
</span></span><span style="display:flex"><span>       <span style="color:#ff7b72">unsigned</span> <span style="color:#79c0ff;font-weight:700">lruclock</span>:LRU_BITS; <span style="color:#8b949e;font-style:italic">/* Clock for LRU eviction */</span>
</span></span><span style="display:flex"><span>       ...
</span></span><span style="display:flex"><span>};
</span></span></code></pre></div><p>redisServer ä¸­åŒ…å«äº†redisæœåŠ¡å™¨å¯åŠ¨ä¹‹åçš„åŸºæœ¬ä¿¡æ¯(PID,é…ç½®æ–‡ä»¶è·¯å¾„,serverCronè¿è¡Œé¢‘ç‡hzç­‰),å¤–éƒ¨å¯è°ƒç”¨æ¨¡å—ä¿¡æ¯ï¼Œç½‘ç»œä¿¡æ¯ï¼ŒRDB/AOFä¿¡æ¯ï¼Œæ—¥å¿—ä¿¡æ¯ï¼Œå¤åˆ¶ä¿¡æ¯ç­‰ç­‰ã€‚</p><p>ä¸Šè¿°ç»“æ„ä½“ä¸­<code>lruclock:LRU_BITS</code>,å…¶ä¸­å­˜å‚¨äº†æœåŠ¡å™¨è‡ªå¯åŠ¨ä¹‹åçš„lruæ—¶é’Ÿï¼Œè¯¥æ—¶é’Ÿæ˜¯å…¨å±€çš„lruæ—¶é’Ÿã€‚<strong>è¯¥æ—¶é’Ÿ100msæ›´æ–°ä¸€æ¬¡</strong>ã€‚</p><blockquote><p>å¯ä»¥é€šè¿‡hzæ¥è°ƒæ•´,é»˜è®¤æƒ…å†µhz=10,å› æ­¤æ¯1000ms/10=100msæ‰§è¡Œä¸€æ¬¡å®šæ—¶ä»»åŠ¡</p></blockquote><p>å› æ­¤lrulockæœ€å¤§èƒ½åˆ°(2**24-1)/3600/24 = 194å¤©,å¦‚æœè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œlrulocké‡æ–°å¼€å§‹ã€‚å¯¹äºredis serveræ¥è¯´ï¼Œserver.lrulockè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå…¨å±€çš„lrulockï¼Œ</p><blockquote><p>å¦‚æœå…¨å±€æ—¶é’Ÿ å°äº å¯¹è±¡æ—¶é’Ÿ, åˆ™ä¼šå†åŠ ä¸Šæ—¶é’Ÿæœ€å¤§å€¼ <code>REDIS_LRU_CLOCK_MAX</code> , ä¹Ÿå°±æ˜¯ 194å¤© çš„ç§’æ•°, ç›¸å½“äºæ˜¯ç¬¬äºŒè½®äº†</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/* Given an object returns the min number of seconds the object was never
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"> * requested, using an approximated LRU algorithm. */</span>
</span></span><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic">#define REDIS_LRU_CLOCK_MAX ((1&lt;&lt;REDIS_LRU_BITS)-1) </span><span style="color:#8b949e;font-style:italic">/* Max value of obj-&gt;lru */</span><span style="color:#8b949e;font-weight:700;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic">#define REDIS_LRU_CLOCK_RESOLUTION 1 </span><span style="color:#8b949e;font-style:italic">/* LRU clock resolution in seconds */</span><span style="color:#8b949e;font-weight:700;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic"></span><span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> <span style="color:#d2a8ff;font-weight:700">estimateObjectIdleTime</span>(robj <span style="color:#ff7b72;font-weight:700">*</span>o) {
</span></span><span style="display:flex"><span>    <span style="color:#ff7b72">if</span> (server.lruclock <span style="color:#ff7b72;font-weight:700">&gt;=</span> o<span style="color:#ff7b72;font-weight:700">-&gt;</span>lru) {
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">return</span> (server.lruclock <span style="color:#ff7b72;font-weight:700">-</span> o<span style="color:#ff7b72;font-weight:700">-&gt;</span>lru) <span style="color:#ff7b72;font-weight:700">*</span> REDIS_LRU_CLOCK_RESOLUTION;
</span></span><span style="display:flex"><span>    } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">return</span> ((REDIS_LRU_CLOCK_MAX <span style="color:#ff7b72;font-weight:700">-</span> o<span style="color:#ff7b72;font-weight:700">-&gt;</span>lru) <span style="color:#ff7b72;font-weight:700">+</span> server.lruclock) <span style="color:#ff7b72;font-weight:700">*</span> REDIS_LRU_CLOCK_RESOLUTION;
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div></blockquote><p>é‚£ä¹ˆå¯¹äºæ¯ä¸ªredisObjectéƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„lrulockã€‚è¿™æ ·æ¯redisObjectå°±å¯ä»¥æ ¹æ®è‡ªå·±çš„lrulockå’Œå…¨å±€çš„server.lrulockæ¯”è¾ƒï¼Œæ¥ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè¢«æ·˜æ±°æ‰ã€‚</p><p>å†çœ‹ä¸€ä¸‹ redisObjectçš„å®ç°</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic">#define REDIS_LRU_BITS 24
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-weight:700;font-style:italic"></span><span style="color:#ff7b72">typedef</span> <span style="color:#ff7b72">struct</span> redisObject {
</span></span><span style="display:flex"><span>     <span style="color:#ff7b72">unsigned</span> <span style="color:#79c0ff;font-weight:700">type</span>:<span style="color:#a5d6ff">4</span>;
</span></span><span style="display:flex"><span>     <span style="color:#ff7b72">unsigned</span> <span style="color:#79c0ff;font-weight:700">encoding</span>:<span style="color:#a5d6ff">4</span>;
</span></span><span style="display:flex"><span>    <span style="color:#8b949e;font-style:italic">// ä»è¿™é‡Œçœ‹å‡º, è¿™ä¸ªå­—æ®µåœ¨ä¸åŒæ·˜æ±°ç­–ç•¥ä¸‹, å­˜çš„å†…å®¹æ˜¯ä¸ä¸€æ ·çš„
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>     <span style="color:#ff7b72">unsigned</span> <span style="color:#79c0ff;font-weight:700">lru</span>:LRU_BITS; <span style="color:#8b949e;font-style:italic">/* LRU time (relative to server.lruclock) or
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">                             * LFU data (least significant 8 bits frequency
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">                             * and most significant 16 bits decreas time). */</span>
</span></span><span style="display:flex"><span>     <span style="color:#ff7b72">int</span> refcount;
</span></span><span style="display:flex"><span>     <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:700">*</span>ptr;
</span></span><span style="display:flex"><span>} robj
</span></span></code></pre></div><p>åœ¨Redisçš„dictä¸­æ¯æ¬¡æŒ‰keyè·å–ä¸€ä¸ªå€¼çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨lookupKeyå‡½æ•°,å¦‚æœé…ç½®ä½¿ç”¨äº†LRUæ¨¡å¼,è¯¥å‡½æ•°ä¼šæ›´æ–°valueä¸­çš„lruå­—æ®µä¸ºå½“å‰ç§’çº§åˆ«çš„æ—¶é—´æˆ³</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span>robj <span style="color:#ff7b72;font-weight:700">*</span><span style="color:#d2a8ff;font-weight:700">lookupKey</span>(redisDb <span style="color:#ff7b72;font-weight:700">*</span>db, robj <span style="color:#ff7b72;font-weight:700">*</span>key, <span style="color:#ff7b72">int</span> flags) {
</span></span><span style="display:flex"><span>    ...
</span></span><span style="display:flex"><span>            <span style="color:#ff7b72">if</span> (server.maxmemory_policy <span style="color:#ff7b72;font-weight:700">&amp;</span> MAXMEMORY_FLAG_LFU) { <span style="color:#8b949e;font-style:italic">//å¦‚æœé…ç½®çš„æ˜¯lfuæ–¹å¼ï¼Œåˆ™æ›´æ–°lfu
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>                <span style="color:#d2a8ff;font-weight:700">updateLFU</span>(val);
</span></span><span style="display:flex"><span>            } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex"><span>                val<span style="color:#ff7b72;font-weight:700">-&gt;</span>lru <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">LRU_CLOCK</span>();<span style="color:#8b949e;font-style:italic">//å¦åˆ™æŒ‰lruæ–¹å¼æ›´æ–°
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>            }
</span></span><span style="display:flex"><span>    ...
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>ç¬¬ä¸€æ¬¡éšæœºé€‰å–çš„keyéƒ½ä¼šæ”¾å…¥ä¸€ä¸ªpoolä¸­(poolçš„å¤§å°ä¸º16),poolä¸­çš„keyæ˜¯æŒ‰lruå¤§å°é¡ºåºæ’åˆ—çš„ã€‚æ¥ä¸‹æ¥æ¯æ¬¡éšæœºé€‰å–çš„key lruå€¼å¿…é¡»å¤§äºpoolä¸­æœ€å°çš„lruæ‰ä¼šç»§ç»­æ”¾å…¥ï¼Œç›´åˆ°å°†poolæ”¾æ»¡ã€‚æ”¾æ»¡ä¹‹åï¼Œæ¯æ¬¡å¦‚æœæœ‰æ–°çš„keyéœ€è¦æ”¾å…¥ï¼Œéœ€è¦å°†poolä¸­lruæœ€å¤§çš„ä¸€ä¸ªkeyå–å‡ºã€‚æ·˜æ±°çš„æ—¶å€™ï¼Œç›´æ¥<strong>ä»poolä¸­é€‰å–ä¸€ä¸ªlruæœ€å¤§çš„å€¼ç„¶åå°†å…¶æ·˜æ±°</strong>ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¯æ¬¡ç§»é™¤çš„Keyå¹¶ä¸ä»…ä»…æ˜¯éšæœºé€‰æ‹©çš„Nä¸ªKeyé‡Œé¢æœ€å¤§çš„ï¼Œè€Œä¸”è¿˜æ˜¯poolé‡Œé¢idle timeæœ€å¤§çš„</p><p>éšæœºé€‰çš„keyçš„æ•°é‡é»˜è®¤ä¸º5, ç”± <code>server.maxmemory_samples</code> æ§åˆ¶, <code>maxmemory_samples</code> å°±æ˜¯æ ·æœ¬å¤§å°, å€¼è¶Šå¤§, çº¦æ¥è¿‘LRU, æ·˜æ±°çš„æ­£ç¡®ç‡è¶Šé«˜, æ€§èƒ½æ¶ˆè€—ä¹Ÿè¶Šå¤§</p><blockquote><p>é‡‡ç”¨"pool"ï¼ŒæŠŠä¸€ä¸ªå…¨å±€æ’åºé—®é¢˜ è½¬åŒ–æˆä¸ºäº† å±€éƒ¨çš„æ¯”è¾ƒé—®é¢˜ã€‚(å°½ç®¡æ’åºæœ¬è´¨ä¸Šä¹Ÿæ˜¯æ¯”è¾ƒï¼Œå›§)ã€‚è¦æƒ³çŸ¥é“idle time æœ€å¤§çš„keyï¼Œç²¾ç¡®çš„LRUéœ€è¦å¯¹å…¨å±€çš„keyçš„idle timeæ’åºï¼Œç„¶åå°±èƒ½æ‰¾å‡ºidle timeæœ€å¤§çš„keyäº†ã€‚ä½†æ˜¯å¯ä»¥é‡‡ç”¨ä¸€ç§è¿‘ä¼¼çš„æ€æƒ³ï¼Œå³éšæœºé‡‡æ ·(samping)è‹¥å¹²ä¸ªkeyï¼Œè¿™è‹¥å¹²ä¸ªkeyå°±ä»£è¡¨ç€å…¨å±€çš„keyï¼ŒæŠŠsampingå¾—åˆ°çš„keyæ”¾åˆ°poolé‡Œé¢ï¼Œæ¯æ¬¡é‡‡æ ·ä¹‹åæ›´æ–°poolï¼Œä½¿å¾—poolé‡Œé¢æ€»æ˜¯ä¿å­˜ç€éšæœºé€‰æ‹©è¿‡çš„keyçš„idle timeæœ€å¤§çš„é‚£äº›keyã€‚éœ€è¦evict keyæ—¶ï¼Œç›´æ¥ä»poolé‡Œé¢å–å‡ºidle timeæœ€å¤§çš„keyï¼Œå°†ä¹‹evictæ‰ã€‚è¿™ç§æ€æƒ³æ˜¯å¾ˆå€¼å¾—å€Ÿé‰´çš„ã€‚</p></blockquote><h1 id="redisä¸­çš„lfuå®ç°">redisä¸­çš„LFUå®ç°<a aria-hidden="true" class="anchor" hidden="" href="#redisä¸­çš„lfuå®ç°">#</a></h1><blockquote><p>ç®€è¿°: å®ƒå’ŒLRUè§„åˆ™ä¸€æ ·, åˆ©ç”¨åœ¨keyä¸­æ—¶é—´é’Ÿå­—æ®µ, ä¸è¿‡æŠŠå†…éƒ¨æ—¶é’Ÿçš„24ä½åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå‰16ä½è¿˜ä»£è¡¨æ—¶é’Ÿï¼Œ<strong>å8ä½ä»£è¡¨ä¸€ä¸ªè®¡æ•°å™¨</strong>ã€‚8ä½åªèƒ½ä»£è¡¨255ï¼Œä½†æ˜¯rediså¹¶æ²¡æœ‰é‡‡ç”¨çº¿æ€§ä¸Šå‡çš„æ–¹å¼ï¼Œè€Œæ˜¯ç»“åˆå¢é•¿å› å­æ¥è®¡æ•°, è€Œä¸”è¿˜æœ‰è¡°é€€å› å­æ¥å‡å°‘è®¡æ•°ã€‚ä¹Ÿä¼šå’ŒLRUä¸€æ ·, å­˜åœ¨ä¸€ä¸ªæ·˜æ±°æ± , <strong>ä»æ·˜æ±°æ± ä¸­redisä¼šå¯¹å†…éƒ¨æ—¶é’Ÿæœ€å°çš„keyè¿›è¡Œæ·˜æ±°</strong>ï¼ˆæœ€å°è¡¨ç¤ºæœ€ä¸é¢‘ç¹ä½¿ç”¨ï¼‰ï¼Œæ³¨æ„è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯æ ¹æ®ç­–ç•¥éšæœºé€‰æ‹©é”®</p></blockquote><p>åœ¨LFUæ¨¡å¼ä¸‹ï¼ŒRediså¯¹è±¡å¤´çš„24bit lruå­—æ®µè¢«åˆ†æˆä¸¤æ®µæ¥å­˜å‚¨ï¼Œé«˜16bitå­˜å‚¨ldt(Last Decrement Time)ï¼Œä½8bitå­˜å‚¨logc(Logistic Counter)ã€‚</p><p><img alt="lru_24 bit.png" loading="lazy" src="Redis%E7%9A%84%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5LRU%E4%B8%8ELFU.assets/5dd759c2c31876ed554585f5cd0e9193.png"/></p><h2 id="ldtlast-decrement-time">ldt(Last Decrement Time)<a aria-hidden="true" class="anchor" hidden="" href="#ldtlast-decrement-time">#</a></h2><p>é«˜16bitç”¨æ¥è®°å½•æœ€è¿‘ä¸€æ¬¡è®¡æ•°å™¨é™ä½çš„æ—¶é—´ï¼Œç”±äºåªæœ‰8bitï¼Œå­˜å‚¨çš„æ˜¯Unixåˆ†é’Ÿæ—¶é—´æˆ³å–æ¨¡2^16ï¼Œ16bitèƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ä¸º65535ï¼ˆ65535/24/60â‰ˆ45.5ï¼‰ï¼Œå¤§æ¦‚45.5å¤©ä¼šæŠ˜è¿”ï¼ˆæŠ˜è¿”æŒ‡çš„æ˜¯å–æ¨¡åçš„å€¼é‡æ–°ä»0å¼€å§‹ï¼‰ã€‚</p><p>æºç å¦‚ä¸‹:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/*Â ReturnÂ theÂ currentÂ timeÂ inÂ minutes,Â justÂ takingÂ theÂ leastÂ significant
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â 16Â bits.Â TheÂ returnedÂ timeÂ isÂ suitableÂ toÂ beÂ storedÂ asÂ LDTÂ (lastÂ decrement
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â time)Â forÂ theÂ LFUÂ implementation.Â */</span>
</span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">//Â server.unixtimeæ˜¯Redisç¼“å­˜çš„Unixæ—¶é—´æˆ³
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">//Â å¯ä»¥çœ‹å‡ºä½¿ç”¨çš„Unixçš„åˆ†é’Ÿæ—¶é—´æˆ³ï¼Œå–æ¨¡2^16
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â <span style="color:#d2a8ff;font-weight:700">LFUGetTimeInMinutes</span>(<span style="color:#ff7b72">void</span>)Â {
</span></span><span style="display:flex"><span>Â Â <span style="color:#ff7b72">return</span>Â (server.unixtime<span style="color:#ff7b72;font-weight:700">/</span><span style="color:#a5d6ff">60</span>)Â <span style="color:#ff7b72;font-weight:700">&amp;</span>Â <span style="color:#a5d6ff">65535</span>;
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span> 
</span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/*Â GivenÂ anÂ objectÂ lastÂ accessÂ time,Â computeÂ theÂ minimumÂ numberÂ ofÂ minutes
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â thatÂ elapsedÂ sinceÂ theÂ lastÂ access.Â HandleÂ overflowÂ (ldtÂ greaterÂ than
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â theÂ currentÂ 16Â bitsÂ minutesÂ time)Â consideringÂ theÂ timeÂ asÂ wrapping
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â exactlyÂ once.Â */</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â <span style="color:#d2a8ff;font-weight:700">LFUTimeElapsed</span>(<span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â ldt)Â {
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â è·å–ç³»ç»Ÿå½“å‰çš„LFUÂ time
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â nowÂ <span style="color:#ff7b72;font-weight:700">=</span>Â <span style="color:#d2a8ff;font-weight:700">LFUGetTimeInMinutes</span>();
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â å¦‚æœnowÂ &gt;=Â ldtÂ ç›´æ¥å–å·®å€¼Â Â 
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">if</span>Â (nowÂ <span style="color:#ff7b72;font-weight:700">&gt;=</span>Â ldt)Â <span style="color:#ff7b72">return</span>Â now<span style="color:#ff7b72;font-weight:700">-</span>ldt;
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â å¦‚æœnowÂ &lt;Â ldtÂ å¢åŠ ä¸Š65535
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#8b949e;font-style:italic">//Â æ³¨æ„RedisÂ è®¤ä¸ºæŠ˜è¿”å°±åªæœ‰ä¸€æ¬¡æŠ˜è¿”ï¼Œå¤šæ¬¡æŠ˜è¿”ä¹Ÿæ˜¯ä¸€æ¬¡ï¼Œæˆ‘æ€è€ƒäº†å¾ˆä¹…æ„Ÿè§‰è¿™ä¸ªåº”è¯¥æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæœ¬èº«Redisçš„æ·˜æ±°ç®—æ³•å°±å¸¦æœ‰éšæœºæ€§Â Â 
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">return</span>Â <span style="color:#a5d6ff">65535</span><span style="color:#ff7b72;font-weight:700">-</span>ldt<span style="color:#ff7b72;font-weight:700">+</span>now;
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><h2 id="logclogistic-counter">logc(Logistic Counter)<a aria-hidden="true" class="anchor" hidden="" href="#logclogistic-counter">#</a></h2><p>ä½8ä½ç”¨æ¥è®°å½•è®¿é—®é¢‘æ¬¡ï¼Œ8bitèƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ä¸º255ï¼Œlogcè‚¯å®šæ— æ³•è®°å½•çœŸå®çš„Rediskeyçš„è®¿é—®æ¬¡æ•°ï¼Œå…¶å®ä»åå­—å¯ä»¥çœ‹å‡ºå­˜å‚¨çš„æ˜¯è®¿é—®æ¬¡æ•°çš„å¯¹æ•°å€¼ï¼Œæ¯ä¸ª<strong>æ–°åŠ å…¥çš„keyçš„logcåˆå§‹å€¼ä¸º5ï¼ˆLFU_INITI_VALï¼‰</strong>ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ–°åŠ å…¥çš„å€¼ä¸ä¼šè¢«é¦–å…ˆé€‰ä¸­æ·˜æ±°ï¼›logcæ¯æ¬¡keyè¢«è®¿é—®æ—¶éƒ½ä¼šæ›´æ–°ï¼›æ­¤å¤–ï¼Œlogcä¼šéšç€æ—¶é—´è¡°å‡ã€‚</p><h2 id="logc-ç®—æ³•è°ƒæ•´">logc ç®—æ³•è°ƒæ•´<a aria-hidden="true" class="anchor" hidden="" href="#logc-ç®—æ³•è°ƒæ•´">#</a></h2><p>redis.conf æä¾›äº†ä¸¤ä¸ªé…ç½®é¡¹ï¼Œç”¨äºè°ƒæ•´LFUçš„ç®—æ³•ä»è€Œæ§åˆ¶Logistic Counterçš„å¢é•¿å’Œè¡°å‡ã€‚</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-properties" data-lang="properties"><span style="display:flex"><span>-- <span style="color:#a5d6ff">ç”¨äºè°ƒæ•´Logistic Counterçš„å¢é•¿é€Ÿåº¦ï¼Œlfu-log-factorå€¼è¶Šå¤§ï¼ŒLogistic Counterå¢é•¿è¶Šæ…¢ã€‚</span>
</span></span><span style="display:flex"><span>lfu-log-factor <span style="color:#a5d6ff">10</span>
</span></span><span style="display:flex"><span>-- <span style="color:#a5d6ff">ç”¨äºè°ƒæ•´Logistic Counterçš„è¡°å‡é€Ÿåº¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»¥åˆ†é’Ÿä¸ºå•ä½çš„æ•°å€¼ï¼Œé»˜è®¤å€¼ä¸º1,ï¼›lfu-decay-timeå€¼è¶Šå¤§ï¼Œè¡°å‡è¶Šæ…¢ã€‚</span>
</span></span><span style="display:flex"><span>lfu-decay-time <span style="color:#a5d6ff">1</span>
</span></span></code></pre></div><p>å¢é•¿çš„æºç :</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/*Â LogarithmicallyÂ incrementÂ aÂ counter.Â TheÂ greaterÂ isÂ theÂ currentÂ counterÂ value
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â theÂ lessÂ likelyÂ isÂ thatÂ itÂ getsÂ reallyÂ implemented.Â SaturateÂ itÂ atÂ 255.Â */</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">uint8_t</span>Â <span style="color:#d2a8ff;font-weight:700">LFULogIncr</span>(<span style="color:#ff7b72">uint8_t</span>Â counter)Â {
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â LogisticÂ Counteræœ€å¤§å€¼ä¸º255Â Â 
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">if</span>Â (counterÂ <span style="color:#ff7b72;font-weight:700">==</span>Â <span style="color:#a5d6ff">255</span>)Â <span style="color:#ff7b72">return</span>Â <span style="color:#a5d6ff">255</span>;
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â å–ä¸€ä¸ª0~1çš„éšæœºæ•°rÂ Â 
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">double</span>Â rÂ <span style="color:#ff7b72;font-weight:700">=</span>Â (<span style="color:#ff7b72">double</span>)<span style="color:#d2a8ff;font-weight:700">rand</span>()<span style="color:#ff7b72;font-weight:700">/</span>RAND_MAX;
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â counterå‡å»LFU_INIT_VALÂ ï¼ˆLFU_INIT_VALä¸ºæ¯ä¸ªkeyçš„LogisticÂ Counteråˆå§‹å€¼ï¼Œé»˜è®¤ä¸º5ï¼‰
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">double</span>Â basevalÂ <span style="color:#ff7b72;font-weight:700">=</span>Â counterÂ <span style="color:#ff7b72;font-weight:700">-</span>Â LFU_INIT_VAL;
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â å¦‚æœè¡°å‡ä¹‹åå·²ç»å°äº5äº†ï¼Œé‚£ä¹ˆbasevalÂ &lt;Â 0å–0
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">if</span>Â (basevalÂ <span style="color:#ff7b72;font-weight:700">&lt;</span>Â <span style="color:#a5d6ff">0</span>)Â basevalÂ <span style="color:#ff7b72;font-weight:700">=</span>Â <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â lfu-log-factoråœ¨è¿™é‡Œè¢«ä½¿ç”¨
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#8b949e;font-style:italic">//Â å¯ä»¥çœ‹å‡ºå¦‚æœlfu_log_factorçš„å€¼è¶Šå¤§ï¼Œpè¶Šå°
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#8b949e;font-style:italic">//Â rÂ &lt;Â pçš„æ¦‚ç‡å°±è¶Šå°ï¼ŒLogisticÂ Counterå¢åŠ çš„æ¦‚ç‡å°±è¶Šå°ï¼ˆå› æ­¤lfu_log_factorè¶Šå¤§å¢é•¿è¶Šç¼“æ…¢ï¼‰
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">double</span>Â pÂ <span style="color:#ff7b72;font-weight:700">=</span>Â <span style="color:#a5d6ff">1.0</span><span style="color:#ff7b72;font-weight:700">/</span>(baseval<span style="color:#ff7b72;font-weight:700">*</span>server.lfu_log_factor<span style="color:#ff7b72;font-weight:700">+</span><span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex"><span>Â Â <span style="color:#ff7b72">if</span>Â (rÂ <span style="color:#ff7b72;font-weight:700">&lt;</span>Â p)Â counter<span style="color:#ff7b72;font-weight:700">++</span>;
</span></span><span style="display:flex"><span>Â Â <span style="color:#ff7b72">return</span>Â counter;
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>è¡°å‡çš„æºä»£ç ï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/*Â IfÂ theÂ objectÂ decrementÂ timeÂ isÂ reachedÂ decrementÂ theÂ LFUÂ counterÂ but
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â doÂ notÂ updateÂ LFUÂ fieldsÂ ofÂ theÂ object,Â weÂ updateÂ theÂ accessÂ time
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â andÂ counterÂ inÂ anÂ explicitÂ wayÂ whenÂ theÂ objectÂ isÂ reallyÂ accessed.
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â AndÂ weÂ willÂ timesÂ halveÂ theÂ counterÂ accordingÂ toÂ theÂ timesÂ of
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â elapsedÂ timeÂ thanÂ server.lfu_decay_time.
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â ReturnÂ theÂ objectÂ frequencyÂ counter.
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â ThisÂ functionÂ isÂ usedÂ inÂ orderÂ toÂ scanÂ theÂ datasetÂ forÂ theÂ bestÂ object
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â toÂ fit:Â asÂ weÂ checkÂ forÂ theÂ candidate,Â weÂ incrementallyÂ decrementÂ the
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">Â *Â counterÂ ofÂ theÂ scannedÂ objectsÂ ifÂ needed.Â */</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â <span style="color:#d2a8ff;font-weight:700">LFUDecrAndReturn</span>(robjÂ <span style="color:#ff7b72;font-weight:700">*</span>o)Â {
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â è·å–lruçš„é«˜16ä½ï¼Œä¹Ÿå°±æ˜¯ldt
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â ldtÂ <span style="color:#ff7b72;font-weight:700">=</span>Â o<span style="color:#ff7b72;font-weight:700">-&gt;</span>lruÂ <span style="color:#ff7b72;font-weight:700">&gt;&gt;</span>Â <span style="color:#a5d6ff">8</span>;Â Â 
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â è·å–lruçš„ä½8ä½ï¼Œä¹Ÿå°±æ˜¯logcÂ Â 
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â counterÂ <span style="color:#ff7b72;font-weight:700">=</span>Â o<span style="color:#ff7b72;font-weight:700">-&gt;</span>lruÂ <span style="color:#ff7b72;font-weight:700">&amp;</span>Â <span style="color:#a5d6ff">255</span>;
</span></span><span style="display:flex"><span>Â Â <span style="color:#8b949e;font-style:italic">//Â æ ¹æ®é…ç½®çš„lfu-decay-timeè®¡ç®—LogisticÂ Counteréœ€è¦è¡°å‡çš„å€¼
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>Â Â <span style="color:#ff7b72">unsigned</span>Â <span style="color:#ff7b72">long</span>Â num_periodsÂ <span style="color:#ff7b72;font-weight:700">=</span>Â server.lfu_decay_timeÂ <span style="color:#ff7b72;font-weight:700">?</span>Â <span style="color:#d2a8ff;font-weight:700">LFUTimeElapsed</span>(ldt)Â <span style="color:#ff7b72;font-weight:700">/</span>Â server.<span style="color:#79c0ff;font-weight:700">lfu_decay_time</span>Â :Â <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex"><span>Â Â <span style="color:#ff7b72">if</span>Â (num_periods)
</span></span><span style="display:flex"><span>Â Â Â Â counterÂ <span style="color:#ff7b72;font-weight:700">=</span>Â (num_periodsÂ <span style="color:#ff7b72;font-weight:700">&gt;</span>Â counter)Â <span style="color:#ff7b72;font-weight:700">?</span>Â <span style="color:#a5d6ff">0</span>Â <span style="color:#ff7b72;font-weight:700">:</span>Â counterÂ <span style="color:#ff7b72;font-weight:700">-</span>Â num_periods;
</span></span><span style="display:flex"><span>Â Â <span style="color:#ff7b72">return</span>Â counter;
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>LFU ä¸ LRU æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼Œå½“å†…å­˜è¾¾åˆ°max_memoryæ—¶ï¼Œé€‰æ‹©keyæ˜¯éšæœºæŠ“å–çš„ï¼Œå› æ­¤Redisä¸ºäº†ä½¿è¿™ç§éšæœºæ€§æ›´åŠ å‡†ç¡®ï¼Œè®¾è®¡äº†ä¸€ä¸ªæ·˜æ±°æ± ï¼Œè¿™ä¸ªæ·˜æ±°æ± å¯¹äºLFUå’ŒLRUç®—çš„éƒ½é€‚åº”ï¼Œåªæ˜¯æ·˜æ±°æ± çš„æ’åºç®—æ³•æœ‰åŒºåˆ«è€Œå·²ã€‚</p><h1 id="æ‰©å±•">æ‰©å±•<a aria-hidden="true" class="anchor" hidden="" href="#æ‰©å±•">#</a></h1><h2 id="æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥">æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥<a aria-hidden="true" class="anchor" hidden="" href="#æ·˜æ±°æ± çš„æ›´æ–°ç­–ç•¥">#</a></h2><p>è¿™ä¸ªæ·˜æ±°æ± å°±æ˜¯ä½¿ç”¨LRUå’ŒLFUæ—¶, éœ€è¦æ·˜æ±°keyæ—¶, æ˜¯ä»æ·˜æ±°æ± æŒ‰æ—¶é—´é’Ÿæ¥æ·˜æ±°, æºç å¦‚ä¸‹:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:700">evictionPoolPopulate</span>(<span style="color:#ff7b72">int</span> dbid, dict <span style="color:#ff7b72;font-weight:700">*</span>sampledict, dict <span style="color:#ff7b72;font-weight:700">*</span>keydict, <span style="color:#ff7b72">struct</span> evictionPoolEntry <span style="color:#ff7b72;font-weight:700">*</span>pool) {
</span></span><span style="display:flex"><span>    <span style="color:#ff7b72">int</span> j, k, count;
</span></span><span style="display:flex"><span>    dictEntry <span style="color:#ff7b72;font-weight:700">*</span>samples[server.maxmemory_samples];
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    count <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">dictGetSomeKeys</span>(sampledict,samples,server.maxmemory_samples);
</span></span><span style="display:flex"><span>    <span style="color:#ff7b72">for</span> (j <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#a5d6ff">0</span>; j <span style="color:#ff7b72;font-weight:700">&lt;</span> count; j<span style="color:#ff7b72;font-weight:700">++</span>) {
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> <span style="color:#ff7b72">long</span> idle;
</span></span><span style="display:flex"><span>        sds key;
</span></span><span style="display:flex"><span>        robj <span style="color:#ff7b72;font-weight:700">*</span>o;
</span></span><span style="display:flex"><span>        dictEntry <span style="color:#ff7b72;font-weight:700">*</span>de;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        de <span style="color:#ff7b72;font-weight:700">=</span> samples[j];
</span></span><span style="display:flex"><span>        key <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">dictGetKey</span>(de);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#8b949e;font-style:italic">/* If the dictionary we are sampling from is not the main
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * dictionary (but the expires one) we need to lookup the key
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * again in the key dictionary to obtain the value object. */</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">if</span> (server.maxmemory_policy <span style="color:#ff7b72;font-weight:700">!=</span> MAXMEMORY_VOLATILE_TTL) {
</span></span><span style="display:flex"><span>            <span style="color:#ff7b72">if</span> (sampledict <span style="color:#ff7b72;font-weight:700">!=</span> keydict) de <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">dictFind</span>(keydict, key);
</span></span><span style="display:flex"><span>            o <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">dictGetVal</span>(de);
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#8b949e;font-style:italic">/* Calculate the idle time according to the policy. This is called
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * idle just because the code initially handled LRU, but is in fact
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * just a score where an higher score means better candidate. */</span>
</span></span><span style="display:flex"><span>        <span style="color:#8b949e;font-style:italic">// ç©ºé—²æ—¶é—´çš„è®¡ç®—æ–¹å¼ LRU ã€ LFU ã€æœ€å¿«è¿‡æœŸçš„å¯ä»¥ ä¸‰ç§è¿‡æœŸç­–ç•¥ä¸‹ éƒ½æ˜¯ä¸åŒçš„
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>        <span style="color:#ff7b72">if</span> (server.maxmemory_policy <span style="color:#ff7b72;font-weight:700">&amp;</span> MAXMEMORY_FLAG_LRU) {
</span></span><span style="display:flex"><span>            idle <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">estimateObjectIdleTime</span>(o);
</span></span><span style="display:flex"><span>        } <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (server.maxmemory_policy <span style="color:#ff7b72;font-weight:700">&amp;</span> MAXMEMORY_FLAG_LFU) {
</span></span><span style="display:flex"><span>            <span style="color:#8b949e;font-style:italic">/* When we use an LRU policy, we sort the keys by idle time
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * so that we expire keys starting from greater idle time.
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * However when the policy is an LFU one, we have a frequency
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * estimation, and we want to evict keys with lower frequency
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * first. So inside the pool we put objects using the inverted
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * frequency subtracting the actual frequency to the maximum
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * frequency of 255. */</span>
</span></span><span style="display:flex"><span>            idle <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#a5d6ff">255</span><span style="color:#ff7b72;font-weight:700">-</span><span style="color:#d2a8ff;font-weight:700">LFUDecrAndReturn</span>(o);
</span></span><span style="display:flex"><span>        } <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (server.maxmemory_policy <span style="color:#ff7b72;font-weight:700">==</span> MAXMEMORY_VOLATILE_TTL) {
</span></span><span style="display:flex"><span>            <span style="color:#8b949e;font-style:italic">/* In this case the sooner the expire the better. */</span>
</span></span><span style="display:flex"><span>            idle <span style="color:#ff7b72;font-weight:700">=</span> ULLONG_MAX <span style="color:#ff7b72;font-weight:700">-</span> (<span style="color:#ff7b72">long</span>)<span style="color:#d2a8ff;font-weight:700">dictGetVal</span>(de);
</span></span><span style="display:flex"><span>        } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex"><span>            <span style="color:#d2a8ff;font-weight:700">serverPanic</span>(<span style="color:#a5d6ff">"Unknown eviction policy in evictionPoolPopulate()"</span>);
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#8b949e;font-style:italic">/* Insert the element inside the pool.
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * First, find the first empty bucket or the first populated
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * bucket that has an idle time smaller than our idle time. */</span>
</span></span><span style="display:flex"><span>        k <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex"><span>        <span style="color:#8b949e;font-style:italic">// åœ¨è¿™é‡Œåˆ¤æ–­ æ± ä¸­æŸä¸€ä¸ªkeyçš„ç©ºé—²æ—¶é—´æ˜¯å¦å°äº å½“å‰keyçš„ç©ºé—²æ—¶é—´
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>        <span style="color:#ff7b72">while</span> (k <span style="color:#ff7b72;font-weight:700">&lt;</span> EVPOOL_SIZE <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span>
</span></span><span style="display:flex"><span>               pool[k].key <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span>
</span></span><span style="display:flex"><span>               pool[k].idle <span style="color:#ff7b72;font-weight:700">&lt;</span> idle) k<span style="color:#ff7b72;font-weight:700">++</span>;
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">if</span> (k <span style="color:#ff7b72;font-weight:700">==</span> <span style="color:#a5d6ff">0</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> pool[EVPOOL_SIZE<span style="color:#ff7b72;font-weight:700">-</span><span style="color:#a5d6ff">1</span>].key <span style="color:#ff7b72;font-weight:700">!=</span> NULL) {
</span></span><span style="display:flex"><span>            <span style="color:#8b949e;font-style:italic">/* Can't insert if the element is &lt; the worst element we have
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * and there are no empty buckets. */</span>
</span></span><span style="display:flex"><span>            <span style="color:#ff7b72">continue</span>;
</span></span><span style="display:flex"><span>        } <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (k <span style="color:#ff7b72;font-weight:700">&lt;</span> EVPOOL_SIZE <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> pool[k].key <span style="color:#ff7b72;font-weight:700">==</span> NULL) {
</span></span><span style="display:flex"><span>            <span style="color:#8b949e;font-style:italic">/* Inserting into empty position. No setup needed before insert. */</span>
</span></span><span style="display:flex"><span>        } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex"><span>            <span style="color:#8b949e;font-style:italic">/* Inserting in the middle. Now k points to the first element
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">             * greater than the element to insert.  */</span>
</span></span><span style="display:flex"><span>            <span style="color:#ff7b72">if</span> (pool[EVPOOL_SIZE<span style="color:#ff7b72;font-weight:700">-</span><span style="color:#a5d6ff">1</span>].key <span style="color:#ff7b72;font-weight:700">==</span> NULL) {
</span></span><span style="display:flex"><span>                <span style="color:#8b949e;font-style:italic">/* Free space on the right? Insert at k shifting
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">                 * all the elements from k to end to the right. */</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>                <span style="color:#8b949e;font-style:italic">/* Save SDS before overwriting. */</span>
</span></span><span style="display:flex"><span>                sds cached <span style="color:#ff7b72;font-weight:700">=</span> pool[EVPOOL_SIZE<span style="color:#ff7b72;font-weight:700">-</span><span style="color:#a5d6ff">1</span>].cached;
</span></span><span style="display:flex"><span>                <span style="color:#d2a8ff;font-weight:700">memmove</span>(pool<span style="color:#ff7b72;font-weight:700">+</span>k<span style="color:#ff7b72;font-weight:700">+</span><span style="color:#a5d6ff">1</span>,pool<span style="color:#ff7b72;font-weight:700">+</span>k,
</span></span><span style="display:flex"><span>                    <span style="color:#ff7b72">sizeof</span>(pool[<span style="color:#a5d6ff">0</span>])<span style="color:#ff7b72;font-weight:700">*</span>(EVPOOL_SIZE<span style="color:#ff7b72;font-weight:700">-</span>k<span style="color:#ff7b72;font-weight:700">-</span><span style="color:#a5d6ff">1</span>));
</span></span><span style="display:flex"><span>                pool[k].cached <span style="color:#ff7b72;font-weight:700">=</span> cached;
</span></span><span style="display:flex"><span>            } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex"><span>                <span style="color:#8b949e;font-style:italic">/* No free space on right? Insert at k-1 */</span>
</span></span><span style="display:flex"><span>                k<span style="color:#ff7b72;font-weight:700">--</span>;
</span></span><span style="display:flex"><span>                <span style="color:#8b949e;font-style:italic">/* Shift all elements on the left of k (included) to the
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">                 * left, so we discard the element with smaller idle time. */</span>
</span></span><span style="display:flex"><span>                sds cached <span style="color:#ff7b72;font-weight:700">=</span> pool[<span style="color:#a5d6ff">0</span>].cached; <span style="color:#8b949e;font-style:italic">/* Save SDS before overwriting. */</span>
</span></span><span style="display:flex"><span>                <span style="color:#ff7b72">if</span> (pool[<span style="color:#a5d6ff">0</span>].key <span style="color:#ff7b72;font-weight:700">!=</span> pool[<span style="color:#a5d6ff">0</span>].cached) <span style="color:#d2a8ff;font-weight:700">sdsfree</span>(pool[<span style="color:#a5d6ff">0</span>].key);
</span></span><span style="display:flex"><span>                <span style="color:#d2a8ff;font-weight:700">memmove</span>(pool,pool<span style="color:#ff7b72;font-weight:700">+</span><span style="color:#a5d6ff">1</span>,<span style="color:#ff7b72">sizeof</span>(pool[<span style="color:#a5d6ff">0</span>])<span style="color:#ff7b72;font-weight:700">*</span>k);
</span></span><span style="display:flex"><span>                pool[k].cached <span style="color:#ff7b72;font-weight:700">=</span> cached;
</span></span><span style="display:flex"><span>            }
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>        <span style="color:#8b949e;font-style:italic">/* Try to reuse the cached SDS string allocated in the pool entry,
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * because allocating and deallocating this object is costly
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * (according to the profiler, not my fantasy. Remember:
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">         * premature optimizbla bla bla bla. */</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">int</span> klen <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">sdslen</span>(key);
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">if</span> (klen <span style="color:#ff7b72;font-weight:700">&gt;</span> EVPOOL_CACHED_SDS_SIZE) {
</span></span><span style="display:flex"><span>            pool[k].key <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#d2a8ff;font-weight:700">sdsdup</span>(key);
</span></span><span style="display:flex"><span>        } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex"><span>            <span style="color:#d2a8ff;font-weight:700">memcpy</span>(pool[k].cached,key,klen<span style="color:#ff7b72;font-weight:700">+</span><span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex"><span>            <span style="color:#d2a8ff;font-weight:700">sdssetlen</span>(pool[k].cached,klen);
</span></span><span style="display:flex"><span>            pool[k].key <span style="color:#ff7b72;font-weight:700">=</span> pool[k].cached;
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>        pool[k].idle <span style="color:#ff7b72;font-weight:700">=</span> idle;
</span></span><span style="display:flex"><span>        pool[k].dbid <span style="color:#ff7b72;font-weight:700">=</span> dbid;
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p><a href="https://cloud.tencent.com/developer/article/1925123" rel="noopener" target="_blank">Redisçš„LRUç¼“å­˜æ·˜æ±°ç®—æ³•å®ç° - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a></p><p><a href="https://www.cnblogs.com/linxiyue/p/10955533.html" rel="noopener" target="_blank">Redisä¸­çš„LFUç®—æ³• - å†è§ç´«ç½—å…° - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/qq_41125219/article/details/120445829" rel="noopener" target="_blank">Redisç²¾é€šç³»åˆ—â€”â€”LFUç®—æ³•è¯¦è¿°(Least Frequently Used - æœ€ä¸ç»å¸¸ä½¿ç”¨)_æå­æŒçš„åšå®¢-CSDNåšå®¢_lfuç®—æ³•</a></p><p><a href="https://www.jianshu.com/p/c8aeb3eee6bc" rel="noopener" target="_blank">Redisçš„ç¼“å­˜æ·˜æ±°ç­–ç•¥LRUä¸LFU - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://www.cnblogs.com/hapjin/p/10933405.html" rel="noopener" target="_blank">Redisçš„LRUç®—æ³• - æ¼”å˜å†ç¨‹è¯¦è§£ (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/belongtocode/article/details/102989685" rel="noopener" target="_blank">å…¨é¢è®²è§£LRUç®—æ³•_Apple_Webçš„åšå®¢-CSDNåšå®¢_lru ç®—æ³•</a></p><p><a href="http://www.redis.cn/articles/20161114002.html" rel="noopener" target="_blank">ç”±æµ…å…¥æ·±ä»‹ç» Redis LRU ç­–ç•¥çš„å…·ä½“å®ç° â€“ Redisä¸­å›½ç”¨æˆ·ç»„ï¼ˆCRUGï¼‰</a></p></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xiaokunji.com/zh/tags/Redis.html">Redis</a></li><li><a href="https://xiaokunji.com/zh/tags/%E7%BB%BC%E5%90%88.html">ç»¼åˆ</a></li></ul><nav class="paginav"><a class="prev" href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E5%B7%A5%E5%85%B7%E7%AF%87/python%E6%90%AD%E5%BB%BAidle%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/python%E6%90%AD%E5%BB%BAidle%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html"><span class="title">Â« ä¸Šä¸€é¡µ</span><br/><span>pythonæ­å»ºidleå¼€å‘ç¯å¢ƒ</span>
</a><a class="next" href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/Redis/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html"><span class="title">ä¸‹ä¸€é¡µ Â»</span><br/><span>redisåº•å±‚æ•°æ®ç»“æ„</span></a></nav></footer></article></main><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><footer class="footer"><span>Copyright
Â©
-2023
<a href="https://xiaokunji.com/zh/" style="color:#939393">ç±³äºŒ</a>
All Rights Reserved
</span><span id="busuanzi_container"><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id="busuanzi_value_site_uv"></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id="busuanzi_value_site_pv"></span></span></footer><a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)"><svg fill="currentcolor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>