<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>painless_è„šæœ¬ | ç±³äºŒ</title><meta name=keywords content=" 1. å®šä¹‰, 2. è¯­æ³•, 3. è„šæœ¬ä½¿ç”¨, 3.1 inline è„šæœ¬, 3.2 stored è„šæœ¬, ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼, è„šæœ¬ä¼˜åŒ–"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/elasticsearch/painless_%E8%84%9A%E6%9C%AC/><link crossorigin=anonymous href=/assets/css/stylesheet.4e0011f750c7441f57e7cdbfd7afb83ad2ac4efdcdb4adebee9988b40de3f85c.css integrity="sha256-TgAR91DHRB9X582/16+4OtKsTv3NtK3r7pmItA3j+Fw=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/elasticsearch/painless_%E8%84%9A%E6%9C%AC/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="painless_è„šæœ¬"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/elasticsearch/painless_%E8%84%9A%E6%9C%AC/"><meta property="article:section" content="ç»¼åˆ"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="painless_è„šæœ¬"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":6,"name":"painless_è„šæœ¬","item":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/elasticsearch/painless_%E8%84%9A%E6%9C%AC/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"painless_è„šæœ¬","name":"painless_è„šæœ¬","description":"     ","keywords":[" 1. å®šä¹‰"," 2. è¯­æ³•"," 3. è„šæœ¬ä½¿ç”¨"," 3.1 inline è„šæœ¬"," 3.2 stored è„šæœ¬"," ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼"," è„šæœ¬ä¼˜åŒ–"],"articleBody":"[toc]\n1. å®šä¹‰ ElasticStackåœ¨å‡çº§åˆ°5.0ç‰ˆæœ¬ä¹‹åï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„è„šæœ¬è¯­è¨€ï¼Œpainlessã€‚è¿™é‡Œè¯´â€œæ–°çš„â€œæ˜¯ç›¸å¯¹ä¸å·²ç»å­˜åœ¨grooveè€Œè¨€çš„ã€‚Grooveè„šæœ¬å¼€å¯ä¹‹åï¼Œå¦‚æœè¢«äººè¯¯ç”¨å¯èƒ½å¸¦æ¥å„ç§æ¼æ´ï¼Œç”±äºè¿™äº›å¤–éƒ¨çš„è„šæœ¬å¼•æ“å¤ªè¿‡äºå¼ºå¤§ï¼Œç”¨ä¸å¥½æˆ–è€…è®¾ç½®ä¸å½“å°±ä¼šå¼•èµ·å®‰å…¨é£é™©ï¼ŒåŸºäºå®‰å…¨å’Œæ€§èƒ½æ–¹é¢ï¼Œæ‰€ä»¥elastic.coå¼€å‘äº†ä¸€ä¸ªæ–°çš„è„šæœ¬å¼•æ“ï¼Œåå­—å°±å«Painlessï¼Œå’ŒGrooveçš„æ²™ç›’æœºåˆ¶ä¸ä¸€æ ·ï¼ŒPainlessä½¿ç”¨ç™½åå•æ¥é™åˆ¶å‡½æ•°ä¸å­—æ®µçš„è®¿é—®ï¼Œé’ˆå¯¹esçš„åœºæ™¯æ¥è¿›è¡Œä¼˜åŒ–ï¼Œåªåšesæ•°æ®çš„æ“ä½œï¼Œæ›´åŠ è½»é‡çº§ï¼Œé€Ÿåº¦è¦å¿«å¥½å‡ å€ï¼Œå¹¶ä¸”æ”¯æŒJavaé™æ€ç±»å‹ï¼Œè¯­æ³•ä¿æŒGrooveç±»ä¼¼ï¼Œè¿˜æ”¯æŒJavaçš„lambdaè¡¨è¾¾å¼ã€‚\nå¯ä»¥åšå¾ˆå¤šäº‹æƒ…,æ”¹å­—æ®µå€¼ / åŠ å­—æ®µ / æŸ¥è¯¢æ—¶å¤„ç†ç»“æœå€¼ç­‰ç­‰\n2. è¯­æ³• è„šæœ¬å˜é‡\nctx._source.fieldï¼šadd, contains, remove, indexOf, length\nctx.opï¼šåº”è¯¥å¯¹æ–‡æ¡£åº”ç”¨çš„æ“ä½œï¼šç´¢å¼•æˆ–åˆ é™¤\nctx._indexï¼šè®¿é—®æ–‡æ¡£å…ƒæ•°æ®å­—æ®µ\n_score åªåœ¨script_scoreä¸­æœ‰æ•ˆ\ndoc[â€˜fieldâ€™], doc[â€˜fieldâ€™].value: add, contains, remove, indexOf, length\n1ã€å¸¸ç”¨æ•°æ®ç±»å‹ï¼š intã€doubleã€Stringã€Listã€Mapã€bool (å’Œjavaä¸€è‡´ï¼‰\n2ã€å˜é‡å®šä¹‰ï¼š\nâ€‹ å®šä¹‰å˜é‡æœ‰ä¸¤ç§æ–¹å¼ï¼ŒåŠ¨æ€ç±»å‹å’Œé™æ€ç±»å‹ï¼Œå»ºè®®ç”¨é™æ€ç±»å‹ï¼Œé™æ€ç±»å‹çš„è®¡ç®—é€Ÿåº¦æ˜¯åŠ¨æ€ç±»å‹çš„10å€\nåŠ¨æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š def a = â€œabcâ€ é™æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š int a = 1; Sting b = â€œasdsdâ€ 3ã€è·å–æ–‡æ¡£ä¸­æŸä¸ªå­—æ®µçš„å€¼çš„ç”¨æ³•ï¼š\nè·å–docä¸‹å­—æ®µï¼š doc[â€™nameâ€™].value\nnestedå­—æ®µå–å‡ºæ¥åå°±æ˜¯æ•°ç»„ï¼Œå¯ç”¨ä¸‹æ ‡è·å–, åé¢ä¸ç”¨åŠ valueï¼š doc['expect_jobs'][1]\ndocä»¥å¤–çš„å­—æ®µå¯ç›´æ¥ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 POST twitter/_update/1 { \"script\": { \"source\": \"ctx._source.age = params.value\", \"params\": { \"value\": 34 } } } å¦‚æœparamsæ˜¯å…¶ä»–ç±»å‹,åŸºæœ¬éµå¾ªjavaçš„è¯­æ³•\nlambdaè¯­æ³•:\n1 2 list.sort((x, y) -\u003e x - y); list.sort(Integer::compare); 3. è„šæœ¬ä½¿ç”¨ è„šæœ¬æ ¼å¼\n1 2 3 4 5 \"script\": { \"lang\": \"...\", \"source\" | \"id\": \"...\", \"params\": { ... } } ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º:\nè„šæœ¬ç¼–å†™çš„è¯­è¨€ï¼Œé»˜è®¤ä¸º painlessã€‚ è„šæœ¬æœ¬èº«å¯ä»¥æŒ‡å®šä¸ºå†…è”è„šæœ¬çš„ source æˆ–å­˜å‚¨è„šæœ¬çš„ idã€‚ åº”ä¼ é€’ç»™è„šæœ¬çš„ä»»ä½•å‘½åå‚æ•°ã€‚ è®¿é—®sourceé‡Œçš„å­—æ®µ\nPainlessä¸­ç”¨äºè®¿é—®å­—æ®µå€¼çš„è¯­æ³•å–å†³äºä¸Šä¸‹æ–‡ã€‚åœ¨Elasticsearchä¸­ï¼Œæœ‰è®¸å¤šä¸åŒçš„Plainlessä¸Šä¸‹æ–‡ã€‚å°±åƒé‚£ä¸ªé“¾æ¥æ˜¾ç¤ºçš„é‚£æ ·ï¼ŒPlainlessä¸Šä¸‹æ–‡åŒ…æ‹¬ï¼šingest processor, update, update by query, sortï¼Œfilterç­‰ç­‰ã€‚ Context è®¿é—®å­—æ®µ Ingest node: è®¿é—®å­—æ®µä½¿ç”¨ctx ctx.field_name Updates: ä½¿ç”¨_source å­—æ®µ ctx._source.field_name\nè¿™é‡Œçš„updatesåŒ…æ‹¬_updateï¼Œ_reindexä»¥åŠupdate_by_queryã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºcontextï¼ˆä¸Šä¸‹æ–‡çš„ç†è§£ï¼‰éå¸¸é‡è¦ã€‚å®ƒçš„æ„æ€æ˜¯é’ˆå¯¹ä¸åŒçš„APIï¼Œåœ¨ä½¿ç”¨ä¸­ctxæ‰€åŒ…å«çš„å­—æ®µæ˜¯ä¸ä¸€æ ·çš„\n3.1 inline è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 PUT twitter/_doc/1 { \"user\" : \"åŒæ¦†æ ‘-å¼ ä¸‰\", \"message\" : \"ä»Šå„¿å¤©æ°”ä¸é”™å•Šï¼Œå‡ºå»è½¬è½¬å»\", \"uid\" : 2, \"age\" : 20, \"city\" : \"åŒ—äº¬\", \"province\" : \"åŒ—äº¬\", \"country\" : \"ä¸­å›½\", \"address\" : \"ä¸­å›½åŒ—äº¬å¸‚æµ·æ·€åŒº\", \"location\" : { \"lat\" : \"39.970718\", \"lon\" : \"116.325747\" } } åœ¨è¿™ä¸ªæ–‡æ¡£é‡Œï¼Œæˆ‘ä»¬ç°åœ¨æƒ³æŠŠageä¿®æ”¹ä¸º30ï¼Œé‚£ä¹ˆä¸€ç§åŠæ³•å°±æ˜¯æŠŠæ‰€æœ‰çš„æ–‡æ¡£å†…å®¹éƒ½è¯»å‡ºæ¥ï¼Œè®©ä¿®æ”¹å…¶ä¸­çš„ageæƒ³ä¸º30ï¼Œå†é‡æ–°ç”¨åŒæ ·çš„æ–¹æ³•å†™è¿›å»ã€‚é¦–å…ˆè¿™é‡Œéœ€è¦æœ‰å‡ ä¸ªåŠ¨ä½œï¼šå…ˆè¯»å‡ºæ•°æ®ï¼Œç„¶åä¿®æ”¹ï¼Œå†æ¬¡å†™å…¥æ•°æ®ã€‚æ˜¾ç„¶è¿™æ ·æ¯”è¾ƒéº»çƒ¦ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨Painlessè¯­è¨€ç›´æ¥è¿›è¡Œä¿®æ”¹ï¼š\n1 2 3 4 5 6 POST twitter/_update/1 { \"script\": { \"source\": \"ctx._source.age = 30\" } } è¿™é‡Œçš„sourceè¡¨æ˜æ˜¯æˆ‘ä»¬çš„Painlessä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬åªå†™äº†å¾ˆå°‘çš„ä»£ç åœ¨DSLä¹‹ä¸­ã€‚è¿™ç§ä»£ç ç§°ä¹‹ä¸ºinlineã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ctx._source.ageæ¥è®¿é—® _souceé‡Œçš„ageã€‚è¿™æ ·æˆ‘ä»¬é€šè¿‡ç¼–ç¨‹çš„åŠæ³•ç›´æ¥å¯¹å¹´é¾„è¿›è¡Œäº†ä¿®æ”¹\næ¯æ¬¡æ›´æ–°å€¼ä¸ä¸€æ ·,esä¼šè®¤ä¸ºæ˜¯ä¸åŒçš„è„šæœ¬,éƒ½ä¼šè¿›è¡Œç¼–è¯‘,æ‰€ä»¥éœ€è¦ç”¨å‚æ•°çš„æ–¹å¼,è¿™æ ·eså°±ä¼šå½“æˆä¸€ä¸ªè„šæœ¬\nElasticsearchç¬¬ä¸€æ¬¡çœ‹åˆ°ä¸€ä¸ªæ–°è„šæœ¬ï¼Œå®ƒä¼šç¼–è¯‘å®ƒå¹¶å°†ç¼–è¯‘åçš„ç‰ˆæœ¬å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ— è®ºæ˜¯inlineæˆ–æ˜¯storedè„šæœ¬éƒ½å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ–°è„šæœ¬å¯ä»¥é©±é€ç¼“å­˜çš„è„šæœ¬ã€‚é»˜è®¤çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥å­˜å‚¨100ä¸ªè„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®script.cache.max_sizeæ¥æ”¹å˜å…¶å¤§å°ï¼Œæˆ–è€…é€šè¿‡script.cache.expireæ¥è®¾ç½®è¿‡æœŸçš„æ—¶é—´ã€‚è¿™äº›è®¾ç½®éœ€è¦åœ¨config/elasticsearch.ymlé‡Œè®¾ç½®ã€‚\n1 2 3 4 5 6 7 8 9 POST twitter/_update/1 { \"script\": { \"source\": \"ctx._source.age = params.value\", \"params\": { \"value\": 34 } } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 GET hockey/_search { \"query\": { \"match_all\": {} }, \"script_fields\": { \"total_goals\": { \"script\": { \"lang\": \"painless\", \"source\": \"\"\" int total = 0; for (int i = 0; i \u003c doc['goals'].length; ++i) { total += doc['goals'][i]; } return total; \"\"\" } } } } sourceé‡Œé¢å¯ä»¥ç”¨pythonçš„å¤šè¡Œå­—ç¬¦ä¸²æ–¹å¼å†™è¯­æ³•\nsourceä¹Ÿèƒ½å…·æœ‰æŸ¥è¯¢çš„åŠŸèƒ½\n3.2 stored è„šæœ¬ sourceå­—æ®µä¸å…‰èƒ½å†™è„šæœ¬,è¿˜èƒ½å†™id,è¿™ä¸ªidå°±æ˜¯æŒ‡çš„æ˜¯ä¸€ä¸ªå†™å¥½çš„è„šæœ¬,è¿™æ ·,è„šæœ¬å°±èƒ½æ›´å¥½çš„ç®¡ç†,ä¸ç”¨å†…åµŒåˆ°æŸ¥è¯¢ä¸­\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œscriptså¯ä»¥è¢«å­˜æ”¾äºä¸€ä¸ªé›†ç¾¤çš„çŠ¶æ€ä¸­ã€‚å®ƒä¹‹åå¯ä»¥é€šè¿‡IDè¿›è¡Œè°ƒç”¨ï¼š\n1 2 3 4 5 6 7 PUT _scripts/add_age { \"script\": { \"lang\": \"painless\", \"source\": \"ctx._source.age += params.value\" } } åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå«åšadd_ageçš„scriptã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬æŠŠsourceé‡Œçš„ageåŠ ä¸Šä¸€ä¸ªæ•°å€¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¹‹åè°ƒç”¨å®ƒï¼š\n1 2 3 4 5 6 7 8 9 POST twitter/_update/1 { \"script\": { \"id\": \"add_age\", \"params\": { \"value\": 2 } } } ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼ æ–‡æ¡£é‡Œçš„å€¼å¯ä»¥é€šè¿‡ä¸€ä¸ªå«åšdocçš„Mapå€¼æ¥è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è„šæœ¬è®¡ç®—ç©å®¶çš„æ€»è¿›çƒæ•°ã€‚ æ­¤ç¤ºä¾‹ä½¿ç”¨ç±»å‹intå’Œforå¾ªç¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 GET hockey/_search { \"query\": { \"function_score\": { \"script_score\": { \"script\": { \"lang\": \"painless\", \"source\": \"\"\" int total = 0; for (int i = 0; i \u003c doc['goals'].length; ++i) { total += doc['goals'][i]; } return total; \"\"\" } } } } } æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨script_fieldsè€Œä¸æ˜¯function_scoreæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 GET hockey/_search { \"query\": { \"match_all\": {} }, \"script_fields\": { \"total_goals\": { \"script\": { \"lang\": \"painless\", \"source\": \"\"\" int total = 0; for (int i = 0; i \u003c doc['goals'].length; ++i) { total += doc['goals'][i]; } return total; \"\"\" } } } } è„šæœ¬ä¼˜åŒ– ä½¿ç”¨è„šæœ¬ç¼“å­˜, é¢„å…ˆç¼“å­˜å¯ä»¥èŠ‚çœç¬¬ä¸€æ¬¡çš„æŸ¥è¯¢æ—¶é—´\nä½¿ç”¨ingest pipelineè¿›è¡Œé¢„å…ˆè®¡ç®—\nç›¸æ¯”äº_source.field_nameä½¿ç”¨doc[â€˜field_nameâ€™]è¯­æ³•é€Ÿåº¦æ›´å¿«, docè¯­æ³•ä½¿ç”¨doc value , åˆ—å­˜å‚¨\nå‚è€ƒé“¾æ¥:\nhttps://blog.csdn.net/qq_24499615/article/details/116161674 https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lambdas.html https://blog.csdn.net/u013613428/article/details/78134170 ","wordCount":"2489","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-22T00:00:00Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/elasticsearch/painless_%E8%84%9A%E6%9C%AC/"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.com/zh/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.com/zh/post title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.com/zh/archives/ title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.com/zh/tags title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.com/zh/categories title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.com/zh/links title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>ç±³äºŒ</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/>ç»¼åˆ</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/>ELK</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/elk/elasticsearch/>ElasticSearch</a> <span>></span></ul></nav><h1 class=post-title>painless_è„šæœ¬</h1><div class=post-description></div><div class=post-meta><span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;5 åˆ†é’Ÿ&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/%E7%BB%BC%E5%90%88/>ç»¼åˆ</a></ul><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1-%e5%ae%9a%e4%b9%89 aria-label="1. å®šä¹‰">1. å®šä¹‰</a></li><li><a href=#2-%e8%af%ad%e6%b3%95 aria-label="2. è¯­æ³•">2. è¯­æ³•</a></li><li><a href=#3-%e8%84%9a%e6%9c%ac%e4%bd%bf%e7%94%a8 aria-label="3. è„šæœ¬ä½¿ç”¨">3. è„šæœ¬ä½¿ç”¨</a><ul><li><a href=#31-inline-%e8%84%9a%e6%9c%ac aria-label="3.1 inline è„šæœ¬">3.1 inline è„šæœ¬</a></li><li><a href=#32-stored-%e8%84%9a%e6%9c%ac aria-label="3.2 stored è„šæœ¬">3.2 stored è„šæœ¬</a></li><li><a href=#%e4%bd%bf%e7%94%a8painless%e8%ae%bf%e9%97%aedoc%e9%87%8c%e7%9a%84%e5%80%bc aria-label=ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼>ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼</a></li></ul></li><li><a href=#%e8%84%9a%e6%9c%ac%e4%bc%98%e5%8c%96 aria-label=è„šæœ¬ä¼˜åŒ–>è„šæœ¬ä¼˜åŒ–</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1-å®šä¹‰>1. å®šä¹‰<a hidden class=anchor aria-hidden=true href=#1-å®šä¹‰>#</a></h1><p>ElasticStackåœ¨å‡çº§åˆ°5.0ç‰ˆæœ¬ä¹‹åï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„è„šæœ¬è¯­è¨€ï¼Œpainlessã€‚è¿™é‡Œè¯´â€œæ–°çš„â€œæ˜¯ç›¸å¯¹ä¸å·²ç»å­˜åœ¨grooveè€Œè¨€çš„ã€‚Grooveè„šæœ¬å¼€å¯ä¹‹åï¼Œå¦‚æœè¢«äººè¯¯ç”¨å¯èƒ½å¸¦æ¥å„ç§æ¼æ´ï¼Œç”±äºè¿™äº›å¤–éƒ¨çš„è„šæœ¬å¼•æ“å¤ªè¿‡äºå¼ºå¤§ï¼Œç”¨ä¸å¥½æˆ–è€…è®¾ç½®ä¸å½“å°±ä¼šå¼•èµ·å®‰å…¨é£é™©ï¼ŒåŸºäºå®‰å…¨å’Œæ€§èƒ½æ–¹é¢ï¼Œæ‰€ä»¥elastic.coå¼€å‘äº†ä¸€ä¸ªæ–°çš„è„šæœ¬å¼•æ“ï¼Œåå­—å°±å«Painlessï¼Œå’ŒGrooveçš„æ²™ç›’æœºåˆ¶ä¸ä¸€æ ·ï¼ŒPainlessä½¿ç”¨ç™½åå•æ¥é™åˆ¶å‡½æ•°ä¸å­—æ®µçš„è®¿é—®ï¼Œé’ˆå¯¹esçš„åœºæ™¯æ¥è¿›è¡Œä¼˜åŒ–ï¼Œåªåšesæ•°æ®çš„æ“ä½œï¼Œæ›´åŠ è½»é‡çº§ï¼Œé€Ÿåº¦è¦å¿«å¥½å‡ å€ï¼Œå¹¶ä¸”æ”¯æŒ<u>Javaé™æ€ç±»å‹ï¼Œè¯­æ³•ä¿æŒGrooveç±»ä¼¼ï¼Œè¿˜æ”¯æŒJavaçš„lambdaè¡¨è¾¾å¼</u>ã€‚</p><blockquote><p>å¯ä»¥åšå¾ˆå¤šäº‹æƒ…,æ”¹å­—æ®µå€¼ / åŠ å­—æ®µ / æŸ¥è¯¢æ—¶å¤„ç†ç»“æœå€¼ç­‰ç­‰</p></blockquote><h1 id=2-è¯­æ³•>2. è¯­æ³•<a hidden class=anchor aria-hidden=true href=#2-è¯­æ³•>#</a></h1><p><strong>è„šæœ¬å˜é‡</strong></p><p>ctx._source.fieldï¼šadd, contains, remove, indexOf, length</p><p>ctx.opï¼šåº”è¯¥å¯¹æ–‡æ¡£åº”ç”¨çš„æ“ä½œï¼šç´¢å¼•æˆ–åˆ é™¤</p><p>ctx._indexï¼šè®¿é—®æ–‡æ¡£å…ƒæ•°æ®å­—æ®µ</p><p>_score åªåœ¨script_scoreä¸­æœ‰æ•ˆ</p><p>doc[â€˜fieldâ€™], doc[â€˜fieldâ€™].value: add, contains, remove, indexOf, length</p><p>1ã€å¸¸ç”¨æ•°æ®ç±»å‹ï¼š intã€doubleã€Stringã€Listã€Mapã€bool (å’Œjavaä¸€è‡´ï¼‰</p><p>2ã€å˜é‡å®šä¹‰ï¼š</p><p>â€‹ å®šä¹‰å˜é‡æœ‰ä¸¤ç§æ–¹å¼ï¼ŒåŠ¨æ€ç±»å‹å’Œé™æ€ç±»å‹ï¼Œå»ºè®®ç”¨é™æ€ç±»å‹ï¼Œé™æ€ç±»å‹çš„è®¡ç®—é€Ÿåº¦æ˜¯åŠ¨æ€ç±»å‹çš„10å€</p><ul><li>åŠ¨æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š def a = &ldquo;abc&rdquo;</li><li>é™æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š int a = 1; Sting b = &ldquo;asdsd&rdquo;</li></ul><p>3ã€è·å–æ–‡æ¡£ä¸­æŸä¸ªå­—æ®µçš„å€¼çš„ç”¨æ³•ï¼š</p><p>è·å–docä¸‹å­—æ®µï¼š doc[&rsquo;name&rsquo;].value</p><p>nestedå­—æ®µå–å‡ºæ¥åå°±æ˜¯æ•°ç»„ï¼Œå¯ç”¨ä¸‹æ ‡è·å–, åé¢ä¸ç”¨åŠ valueï¼š <code>doc['expect_jobs'][1]</code></p><p>docä»¥å¤–çš„å­—æ®µå¯ç›´æ¥ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>twitter/_update/</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;script&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;ctx._source.age = params.value&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;params&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>34</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å¦‚æœparamsæ˜¯å…¶ä»–ç±»å‹,åŸºæœ¬éµå¾ªjavaçš„è¯­æ³•</p></blockquote><p>lambdaè¯­æ³•:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>list<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>((</span>x<span style=color:#f92672>,</span> y<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> x <span style=color:#f92672>-</span> y<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>list<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>::</span>compare<span style=color:#f92672>);</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=3-è„šæœ¬ä½¿ç”¨>3. è„šæœ¬ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#3-è„šæœ¬ä½¿ç”¨>#</a></h1><p>è„šæœ¬æ ¼å¼</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;script&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;lang&#34;</span>:   <span style=color:#e6db74>&#34;...&#34;</span>,  
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#e6db74>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>, 
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: { <span style=color:#960050;background-color:#1e0010>...</span> } 
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º:</p><ul><li>è„šæœ¬ç¼–å†™çš„è¯­è¨€ï¼Œé»˜è®¤ä¸º painlessã€‚</li><li>è„šæœ¬æœ¬èº«å¯ä»¥æŒ‡å®šä¸ºå†…è”è„šæœ¬çš„ source æˆ–å­˜å‚¨è„šæœ¬çš„ idã€‚</li><li>åº”ä¼ é€’ç»™è„šæœ¬çš„ä»»ä½•å‘½åå‚æ•°ã€‚</li></ul></blockquote><p><strong>è®¿é—®sourceé‡Œçš„å­—æ®µ</strong></p><p>Painlessä¸­ç”¨äºè®¿é—®å­—æ®µå€¼çš„è¯­æ³•å–å†³äºä¸Šä¸‹æ–‡ã€‚åœ¨Elasticsearchä¸­ï¼Œæœ‰è®¸å¤šä¸åŒçš„Plainlessä¸Šä¸‹æ–‡ã€‚å°±åƒé‚£ä¸ªé“¾æ¥æ˜¾ç¤ºçš„é‚£æ ·ï¼ŒPlainlessä¸Šä¸‹æ–‡åŒ…æ‹¬ï¼šingest processor, update, update by query, sortï¼Œfilterç­‰ç­‰ã€‚
Context è®¿é—®å­—æ®µ
Ingest node: è®¿é—®å­—æ®µä½¿ç”¨ctx ctx.field_name
Updates: ä½¿ç”¨<code>_source</code> å­—æ®µ <code>ctx._source.field_name</code></p><p>è¿™é‡Œçš„updatesåŒ…æ‹¬<code>_update</code>ï¼Œ<code>_reindex</code>ä»¥åŠupdate_by_queryã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºcontextï¼ˆä¸Šä¸‹æ–‡çš„ç†è§£ï¼‰éå¸¸é‡è¦ã€‚å®ƒçš„æ„æ€æ˜¯é’ˆå¯¹ä¸åŒçš„APIï¼Œåœ¨ä½¿ç”¨ä¸­ctxæ‰€åŒ…å«çš„å­—æ®µæ˜¯ä¸ä¸€æ ·çš„</p><h2 id=31-inline-è„šæœ¬>3.1 inline è„šæœ¬<a hidden class=anchor aria-hidden=true href=#31-inline-è„šæœ¬>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    PUT twitter/_doc/1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;user&#34; : &#34;åŒæ¦†æ ‘-å¼ ä¸‰&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;message&#34; : &#34;ä»Šå„¿å¤©æ°”ä¸é”™å•Šï¼Œå‡ºå»è½¬è½¬å»&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;uid&#34; : 2,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;age&#34; : 20,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;city&#34; : &#34;åŒ—äº¬&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;province&#34; : &#34;åŒ—äº¬&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;country&#34; : &#34;ä¸­å›½&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;address&#34; : &#34;ä¸­å›½åŒ—äº¬å¸‚æµ·æ·€åŒº&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;location&#34; : {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;lat&#34; : &#34;39.970718&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;lon&#34; : &#34;116.325747&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨è¿™ä¸ªæ–‡æ¡£é‡Œï¼Œæˆ‘ä»¬ç°åœ¨æƒ³æŠŠageä¿®æ”¹ä¸º30ï¼Œé‚£ä¹ˆä¸€ç§åŠæ³•å°±æ˜¯æŠŠæ‰€æœ‰çš„æ–‡æ¡£å†…å®¹éƒ½è¯»å‡ºæ¥ï¼Œè®©ä¿®æ”¹å…¶ä¸­çš„ageæƒ³ä¸º30ï¼Œå†é‡æ–°ç”¨åŒæ ·çš„æ–¹æ³•å†™è¿›å»ã€‚é¦–å…ˆè¿™é‡Œéœ€è¦æœ‰å‡ ä¸ªåŠ¨ä½œï¼šå…ˆè¯»å‡ºæ•°æ®ï¼Œç„¶åä¿®æ”¹ï¼Œå†æ¬¡å†™å…¥æ•°æ®ã€‚æ˜¾ç„¶è¿™æ ·æ¯”è¾ƒéº»çƒ¦ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨Painlessè¯­è¨€ç›´æ¥è¿›è¡Œä¿®æ”¹ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  POST twitter/_update/1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;source&#34;: &#34;ctx._source.age = 30&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œçš„sourceè¡¨æ˜æ˜¯æˆ‘ä»¬çš„Painlessä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬åªå†™äº†å¾ˆå°‘çš„ä»£ç åœ¨DSLä¹‹ä¸­ã€‚è¿™ç§ä»£ç ç§°ä¹‹ä¸ºinlineã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥é€šè¿‡<code>ctx._source.age</code>æ¥è®¿é—® <code>_souce</code>é‡Œçš„ageã€‚è¿™æ ·æˆ‘ä»¬é€šè¿‡ç¼–ç¨‹çš„åŠæ³•ç›´æ¥å¯¹å¹´é¾„è¿›è¡Œäº†ä¿®æ”¹</p><p><strong>æ¯æ¬¡æ›´æ–°å€¼ä¸ä¸€æ ·,esä¼šè®¤ä¸ºæ˜¯ä¸åŒçš„è„šæœ¬,éƒ½ä¼šè¿›è¡Œç¼–è¯‘,æ‰€ä»¥éœ€è¦ç”¨å‚æ•°çš„æ–¹å¼,è¿™æ ·eså°±ä¼šå½“æˆä¸€ä¸ªè„šæœ¬</strong></p><blockquote><p>Elasticsearchç¬¬ä¸€æ¬¡çœ‹åˆ°ä¸€ä¸ªæ–°è„šæœ¬ï¼Œå®ƒä¼šç¼–è¯‘å®ƒå¹¶å°†ç¼–è¯‘åçš„ç‰ˆæœ¬å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ— è®ºæ˜¯inlineæˆ–æ˜¯storedè„šæœ¬éƒ½å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ–°è„šæœ¬å¯ä»¥é©±é€ç¼“å­˜çš„è„šæœ¬ã€‚<strong>é»˜è®¤çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥å­˜å‚¨100ä¸ªè„šæœ¬</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®script.cache.max_sizeæ¥æ”¹å˜å…¶å¤§å°ï¼Œæˆ–è€…é€šè¿‡script.cache.expireæ¥è®¾ç½®è¿‡æœŸçš„æ—¶é—´ã€‚è¿™äº›è®¾ç½®éœ€è¦åœ¨config/elasticsearch.ymlé‡Œè®¾ç½®ã€‚</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  POST twitter/_update/1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;source&#34;: &#34;ctx._source.age = params.value&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;params&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          &#34;value&#34;: 34
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>   GET hockey/_search
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;match_all&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      },
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;script_fields&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;total_goals&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;lang&#34;: &#34;painless&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;source&#34;: &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              int total = 0;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              for (int i = 0; i &lt; doc[&#39;goals&#39;].length; ++i) {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                total += doc[&#39;goals&#39;][i];
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              return total;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>sourceé‡Œé¢å¯ä»¥ç”¨pythonçš„å¤šè¡Œå­—ç¬¦ä¸²æ–¹å¼å†™è¯­æ³•</p></blockquote><p><strong>sourceä¹Ÿèƒ½å…·æœ‰æŸ¥è¯¢çš„åŠŸèƒ½</strong></p><h2 id=32-stored-è„šæœ¬>3.2 stored è„šæœ¬<a hidden class=anchor aria-hidden=true href=#32-stored-è„šæœ¬>#</a></h2><p>sourceå­—æ®µä¸å…‰èƒ½å†™è„šæœ¬,è¿˜èƒ½å†™id,è¿™ä¸ªidå°±æ˜¯æŒ‡çš„æ˜¯ä¸€ä¸ªå†™å¥½çš„è„šæœ¬,è¿™æ ·,è„šæœ¬å°±èƒ½æ›´å¥½çš„ç®¡ç†,ä¸ç”¨å†…åµŒåˆ°æŸ¥è¯¢ä¸­</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œscriptså¯ä»¥è¢«å­˜æ”¾äºä¸€ä¸ªé›†ç¾¤çš„çŠ¶æ€ä¸­ã€‚å®ƒä¹‹åå¯ä»¥é€šè¿‡IDè¿›è¡Œè°ƒç”¨ï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> PUT _scripts/add_age
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;lang&#34;: &#34;painless&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;source&#34;: &#34;ctx._source.age += params.value&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå«åšadd_ageçš„scriptã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬æŠŠsourceé‡Œçš„ageåŠ ä¸Šä¸€ä¸ªæ•°å€¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¹‹åè°ƒç”¨å®ƒï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  POST twitter/_update/1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;id&#34;: &#34;add_age&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;params&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          &#34;value&#34;: 2
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><h2 id=ä½¿ç”¨painlessè®¿é—®docé‡Œçš„å€¼>ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨painlessè®¿é—®docé‡Œçš„å€¼>#</a></h2><p>æ–‡æ¡£é‡Œçš„å€¼å¯ä»¥é€šè¿‡ä¸€ä¸ªå«åšdocçš„Mapå€¼æ¥è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è„šæœ¬è®¡ç®—ç©å®¶çš„æ€»è¿›çƒæ•°ã€‚ æ­¤ç¤ºä¾‹ä½¿ç”¨ç±»å‹intå’Œforå¾ªç¯ã€‚</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    GET hockey/_search
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;function_score&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          &#34;script_score&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              &#34;lang&#34;: &#34;painless&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              &#34;source&#34;: &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                int total = 0;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                for (int i = 0; i &lt; doc[&#39;goals&#39;].length; ++i) {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                  total += doc[&#39;goals&#39;][i];
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                return total;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨script_fieldsè€Œä¸æ˜¯function_scoreæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>   GET hockey/_search
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;match_all&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      },
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      &#34;script_fields&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        &#34;total_goals&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;lang&#34;: &#34;painless&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;source&#34;: &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              int total = 0;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              for (int i = 0; i &lt; doc[&#39;goals&#39;].length; ++i) {
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>                total += doc[&#39;goals&#39;][i];
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>              return total;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>            &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>          }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>        }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>      }
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    }
</span></span></span></code></pre></td></tr></table></div></div><h1 id=è„šæœ¬ä¼˜åŒ–>è„šæœ¬ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#è„šæœ¬ä¼˜åŒ–>#</a></h1><p>ä½¿ç”¨è„šæœ¬ç¼“å­˜, é¢„å…ˆç¼“å­˜å¯ä»¥èŠ‚çœç¬¬ä¸€æ¬¡çš„æŸ¥è¯¢æ—¶é—´</p><p>ä½¿ç”¨ingest pipelineè¿›è¡Œé¢„å…ˆè®¡ç®—</p><p>ç›¸æ¯”äº_source.field_nameä½¿ç”¨doc[â€˜field_nameâ€™]è¯­æ³•é€Ÿåº¦æ›´å¿«, docè¯­æ³•ä½¿ç”¨doc value , åˆ—å­˜å‚¨</p><p>å‚è€ƒé“¾æ¥:</p><p><a href=https://blog.csdn.net/qq_24499615/article/details/116161674 target=_blank rel=noopener>https://blog.csdn.net/qq_24499615/article/details/116161674</a></p><p><a href=https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lambdas.html target=_blank rel=noopener>https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lambdas.html</a></p><p><a href=https://blog.csdn.net/u013613428/article/details/78134170 target=_blank rel=noopener>https://blog.csdn.net/u013613428/article/details/78134170</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/elasticsearch/>ElasticSearch</a></li><li><a href=https://xiaokunji.com/zh/tags/%E7%BB%BC%E5%90%88/>ç»¼åˆ</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E6%9C%8D%E5%8A%A1%E5%99%A8/openresty/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>OpenResty</span></a>
<a class=next href=https://xiaokunji.com/zh/python%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/python2/pdb/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Pdb</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>