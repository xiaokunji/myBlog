<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>安装 | 米二</title><meta name=keywords content="  1 准备环境, 1.1 服务器要求：, 1.2 软件环境：, 1.3 服务器规划：, 2. 主机名解析, 3.时间同步, 4.禁用selinux和firewalld服务, 5.禁用swap分区, 6.添加网桥过滤和地址转发功能,然后执行, 7.docker安装, 7.1 安装docker依赖, 7.2 配置docker 镜像加速器和默认存储目录, 7.3 启动Docker, 设置开机启动, 启动docker, 7.4 验证, 7.5 安装cri-dockerd, 8.kubernetes的Yum源切换成国内源, 9.安装指定版本 kubeadm，kubelet和kubect,设置kubelet开机启动, 10. 通过 kubeadm 部署Kubernetes, 10.1 部署master节点, 这行数据 复制下来,节点加入进群需要用到此命令, 10.2 将node节点加入集群, 11.部署容器网络（CNI）, 上面这些, 12.其他维护事项"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/kubernetes/%E5%AE%89%E8%A3%85.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/kubernetes/%E5%AE%89%E8%A3%85.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="安装"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/kubernetes/%E5%AE%89%E8%A3%85.html"><meta property="article:section" content="综合"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-28T17:01:18+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="安装"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"安装","item":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/kubernetes/%E5%AE%89%E8%A3%85.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"安装","name":"安装","description":"     ","keywords":["  1 准备环境"," 1.1 服务器要求："," 1.2 软件环境："," 1.3 服务器规划："," 2. 主机名解析"," 3.时间同步"," 4.禁用selinux和firewalld服务"," 5.禁用swap分区"," 6.添加网桥过滤和地址转发功能","然后执行"," 7.docker安装"," 7.1 安装docker依赖"," 7.2 配置docker 镜像加速器和默认存储目录"," 7.3 启动Docker"," 设置开机启动"," 启动docker"," 7.4 验证"," 7.5 安装cri-dockerd"," 8.kubernetes的Yum源切换成国内源"," 9.安装指定版本 kubeadm，kubelet和kubect","设置kubelet开机启动"," 10. 通过 kubeadm 部署Kubernetes"," 10.1 部署master节点"," 这行数据 复制下来, 节点加入进群需要用到此命令"," 10.2 将node节点加入集群"," 11.部署容器网络（CNI）"," 上面这些"," 12.其他维护事项"],"articleBody":"[toc]\nK8s搭建流程-使用kubeadm\n1 准备环境 1.1 服务器要求： 建议最小硬件配置：2核CPU、2G内存、20G硬盘，服务器最好可以访问外网，会有从网上拉取镜像需求，如果服务器不能上网，需要提前下载对应镜像并导入节点。\n1.2 软件环境： 软件 版本 操作系统 CentOS 7.7.1908 (Core) Docker 24.0.4 (当前最新版) Kubernetes 1.23 1.3 服务器规划： 服务器名称 服务器IP 备注 master 10.39.40.1 24u/93G/755G 同时作为node节点 node1 10.39.40.2 32u/132G/3.6T node2 10.39.40.3 64u/141G/1.1T 部署使用root账号, 非root账号很多命令相对麻烦\n2. 主机名解析 编辑所有节点服务器的 /etc/hosts 文件 ,添加主机名, 执行命令：\ncat \u003e\u003e /etc/hosts \u003c\u003c EOF 10.39.97.19 master 10.39.97.20 node1 EOF 用sudo cat追加文件出错_iteye_2225的博客-CSDN博客 设置每台节点的hostname, 分别执行\nmaster节点:\nhostnamectl set-hostname master\nnode1节点:\nhostnamectl set-hostname node1\n3.时间同步 启动chronyd服务\nsystemctl start chronyd systemctl enable chronyd date 如果没有安装 chronyd , 可以使用 yum install chrony -y 安装\n4.禁用selinux和firewalld服务 关闭firewalld服务,并 设置开机不启动\nsystemctl stop firewalld systemctl disable firewalld 关闭selinux服务，重启后生效\nsed -i 's/enforcing/disabled/' /etc/selinux/config\nselinux - linux的安全系统, 可以尽可能的控制权限最小化 5.禁用swap分区 swap分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用swap设备会对系统的性能产生非常负面的影响，因此kubernetes要求每个节点都要禁用swap设备，但是如果因为某些原因确实不能关闭swap分区，就需要在集群安装过程中通过明确的参数进行配置说明\nsed -ri 's/.*swap.*/#\u0026/' /etc/fstab # 永久关闭\n6.添加网桥过滤和地址转发功能 cat \u003e\u003e /etc/sysctl.d/kubernetes.conf \u003c\u003c EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 EOF #然后执行 sysctl --system 为使之前的配置生效，重启所有节点服务器\nreboot\n7.docker安装 7.1 安装docker依赖 curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun\n这里使用阿里的镜像一键安装, 默认装最新版, 如果是要指定版本,就采用手动安装的方式, 会帮我们做如下操作\n安装yum-utils\n设置docker仓库镜像为阿里的\n安装 docker-ce / docker-ce-cli / containerd.io / docker-compose / makecache\nCentOS Docker 安装 | 菜鸟教程 (runoob.com) 7.2 配置docker 镜像加速器和默认存储目录 cat \u003c /etc/docker/daemon.json { \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"100m\" }, \"data-root\": \"/app/docker-home\", \"registry-mirrors\": [\"https://registry.docker-cn.com\", \"https://hub-mirror.c.163.com\", \"https://docker.mirrors.ustc.edu.cn\",\"https://alzgoonw.mirror.aliyuncs.com\"] } EOF 【简记】修改Docker数据目录位置，包含镜像位置 - 东北小狐狸 - 博客园 (cnblogs.com) 7.3 启动Docker # 设置开机启动 systemctl enable docker # 启动docker systemctl start docker 7.4 验证 docker version 检查版本\n可以看到 docker版本, 容器数, 镜像数, root dir 路径, 镜像仓库 等等\ndocker run hello-world\n执行一个 hello-world , 如果能运行成功, 则表示安装成功, 第一次运行要pull 镜像, 可能会慢一点, 等一会它\nUnable to find image 'hello-world:latest' locally latest: Pulling from library/hello-world 1b930d010525: Pull complete Digest: sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f Status: Downloaded newer image for hello-world:latest Hello from Docker! This message shows that your installation appears to be working correctly. To generate this message, Docker took the following steps: 1. The Docker client contacted the Docker daemon. 2. The Docker daemon pulled the \"hello-world\" image from the Docker Hub. (amd64) 3. The Docker daemon created a new container from that image which runs the executable that produces the output you are currently reading. 4. The Docker daemon streamed that output to the Docker client, which sent it to your terminal. To try something more ambitious, you can run an Ubuntu container with: $ docker run -it ubuntu bash Share images, automate workflows, and more with a free Docker ID: https://hub.docker.com/ For more examples and ideas, visit: https://docs.docker.com/get-started/ 7.5 安装cri-dockerd 从v1.24起，Docker不能直接作为k8s的容器运行时 ，因为在k8s v1.24版本移除了叫dockershim的组件，这是由k8s团队直接维护而非Docker团队维护的组件，这意味着Docker和k8s的关系不再像原来那般亲密，开发者需要使用其它符合CRI（容器运行时接口 ）的容器运行时工具（如containerd, CRI-O等），当然这并不意味着新版本的k8s彻底抛弃Docker（由于Docker庞大的生态和广泛的群众基础，显然这并不容易办到），在原本安装了Docker的基础上，可以通过补充安装cri-dockerd ，以满足容器运行时接口的条件，从某种程度上说，cri-dockerd就是翻版的dockershim。\n本篇的k8s 刚好在 1.23版本, 所以不用特意安装\nKubernetes最新版2023.07v1.27.4安装和集群搭建保姆级教程 - 知乎 (zhihu.com) 8.kubernetes的Yum源切换成国内源 cat \u003e\u003e /etc/yum.repos.d/kubernetes.repo \u003c\u003c EOF [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 9.安装指定版本 kubeadm，kubelet和kubect yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0 #设置kubelet开机启动 systemctl enable kubelet 10. 通过 kubeadm 部署Kubernetes 10.1 部署master节点 Kubernetes 初始化，下面的操作只需要在master节点上执行即可\nkubeadm init \\ --apiserver-advertise-address=10.39.40.1 \\ --image-repository registry.aliyuncs.com/google_containers \\ --kubernetes-version v1.23.0 \\ --service-cidr=192.168.128.0/17 \\ --pod-network-cidr=192.168.0.0/17 \\ --ignore-preflight-errors=all –apiserver-advertise-address #集群通告地址(master 机器IP) –image-repository #由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址 –kubernetes-version #K8s版本，与上面安装的一致 –service-cidr #集群内部service网络 –pod-network-cidr #集群内部pod网络，与下面部署的CNI网络组件yaml中保持一致\n搭建k8s时service-cidr是根据自己本地得ip地址写得 (aliyun.com) 成功后末尾输出信息如下：\nYour Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: #### 这行数据 复制下来, 节点加入进群需要用到此命令 kubeadm join 10.39.40.1:6443 --token 1j3dl9.1z8wjckd94xluwh6 \\ --discovery-token-ca-cert-hash sha256:c464e3ebd7f432f094bacf06269003730f010b431c3fb76acade4f43d4740 创建客户端授权文件\nmkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 授权kubectl 客户端能连接上 k8s, 这里只在master配置, 如果需要在其他节点配置, 就把 /etc/kubernetes/admin.conf 文件复制到其他节点上\n10.2 将node节点加入集群 在所有node节点上执行以下命令(初始化master 得到的命令)\nkubeadm join 10.39.40.1:6443 --token 1j3dl9.1z8wjckd94xluwh6 \\ --discovery-token-ca-cert-hash sha256:c464e3ebd7f432f094bacf06269003730f010b431c3fb76acade4f43d4740 11.部署容器网络（CNI） pod之前需要网络通信, 但是k8s没有具体实现, 只是开了CNI能力, 所以需要其他方案来完善\nCalico是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案。 官方的部署文档使用的是 flannel\nKubernetes CNI网络最强对比：Flannel、Calico、Canal和Weave_文化 \u0026 方法_Rancher_InfoQ精选文章 Master 节点下载Calico YAML 文件\ncurl https://docs.projectcalico.org/v3.7/manifests/calico.yaml -O\n下载完后修改里面定义Pod网络（CALICO_IPV4POOL_CIDR），与前面kubeadm init 的 –pod-network-cidr 指定的一样\n创建calico网络，Master节点上执行\nkubectl apply -f calico.yaml\n查看网络状态\nkubectl get pods -n kube-system -w\n等待一段时间，calico 和 coredns 相关pod处于ready状态, 这个过程要等好几分钟\nNAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-dbd6bd945-vlqxh 1/1 Running 0 4m51s kube-system calico-node-hkp5s 1/1 Running 0 4m51s kube-system calico-node-ksxg8 1/1 Running 0 4m51s kube-system calico-node-srd2r 1/1 Running 0 4m51s kube-system coredns-7f6cbbb7b8-svhdg 1/1 Running 0 22h kube-system coredns-7f6cbbb7b8-vmm2h 1/1 Running 0 22h ### 上面这些 kube-system etcd-k8s-master 1/1 Running 0 22h kube-system kube-apiserver-k8s-master 1/1 Running 0 22h kube-system kube-controller-manager-k8s-master 1/1 Running 0 22h kube-system kube-proxy-4dvgq 1/1 Running 0 22h kube-system kube-proxy-5jhkj 1/1 Running 0 22h kube-system kube-proxy-5jtwf 1/1 Running 0 22h kube-system kube-scheduler-k8s-master 1/1 Running 0 22h 查看节点状态，处于 ready 状态\n[root@master01 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master Ready control-plane,master 21h v1.23.4 node1 Ready 16h v1.23.4 node2 Ready 16h v1.23.4 [root@master01 ~]# 可以看到所有节点的状态已经变为是Ready了。 至此K8s已经部署完成，已可以简单使用，但是缺少NFS，不支持灵活的数据持久化\n12.其他维护事项 重新申请 join token 24小时有效\nkubeadm token create --print-join-command\nmaster 节点同时设置为 node节点\nkubectl taint node master node-role.kubernetes.io/master-\n恢复 master only\nkubectl taint node master node-role.kubernetes.io/master=\"\":NoSchedule\nK8s搭建流程-使用kubeadm (flowus.cn) kubernetes(k8s)环境搭建 - 知乎 (zhihu.com) Kubernetes最新版2023.07v1.27.4安装和集群搭建保姆级教程 - 知乎 (zhihu.com) Windows Docker 安装 | 菜鸟教程 (runoob.com) ","wordCount":"2773","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-28T17:01:18.759436243Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/kubernetes/%E5%AE%89%E8%A3%85.html"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="米二 (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>米二</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://xiaokunji.com/zh/search.html title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=📚文章><span>📚文章</span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=🔖标签><span>🔖标签</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=📖分类><span>📖分类</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>🏠</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88.html>综合</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/kubernetes.html>Kubernetes</a> <span>></span></ul></nav><h1 class=post-title>安装</h1><div class=post-description></div><div class=post-meta><span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;xkj
&nbsp;|&nbsp;分类: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/%E7%BB%BC%E5%90%88.html>综合</a></ul><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#1-%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83 aria-label="1 准备环境">1 准备环境</a><ul><li><a href=#11-%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a6%81%e6%b1%82 aria-label="1.1 服务器要求：">1.1 服务器要求：</a></li><li><a href=#12-%e8%bd%af%e4%bb%b6%e7%8e%af%e5%a2%83 aria-label="1.2 软件环境：">1.2 软件环境：</a></li><li><a href=#13-%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%a7%84%e5%88%92 aria-label="1.3 服务器规划：">1.3 服务器规划：</a></li></ul></li><li><a href=#2-%e4%b8%bb%e6%9c%ba%e5%90%8d%e8%a7%a3%e6%9e%90 aria-label="2. 主机名解析">2. 主机名解析</a></li><li><a href=#3%e6%97%b6%e9%97%b4%e5%90%8c%e6%ad%a5 aria-label=3.时间同步>3.时间同步</a></li><li><a href=#4%e7%a6%81%e7%94%a8selinux%e5%92%8cfirewalld%e6%9c%8d%e5%8a%a1 aria-label=4.禁用selinux和firewalld服务>4.禁用selinux和firewalld服务</a></li><li><a href=#5%e7%a6%81%e7%94%a8swap%e5%88%86%e5%8c%ba aria-label=5.禁用swap分区>5.禁用swap分区</a></li><li><a href=#6%e6%b7%bb%e5%8a%a0%e7%bd%91%e6%a1%a5%e8%bf%87%e6%bb%a4%e5%92%8c%e5%9c%b0%e5%9d%80%e8%bd%ac%e5%8f%91%e5%8a%9f%e8%83%bd aria-label=6.添加网桥过滤和地址转发功能>6.添加网桥过滤和地址转发功能</a></li><li><a href=#7docker%e5%ae%89%e8%a3%85 aria-label=7.docker安装>7.docker安装</a><ul><li><a href=#71-%e5%ae%89%e8%a3%85docker%e4%be%9d%e8%b5%96 aria-label="7.1 安装docker依赖">7.1 安装docker依赖</a></li><li><a href=#72-%e9%85%8d%e7%bd%aedocker-%e9%95%9c%e5%83%8f%e5%8a%a0%e9%80%9f%e5%99%a8%e5%92%8c%e9%bb%98%e8%ae%a4%e5%ad%98%e5%82%a8%e7%9b%ae%e5%bd%95 aria-label="7.2 配置docker 镜像加速器和默认存储目录">7.2 配置docker 镜像加速器和默认存储目录</a></li><li><a href=#73-%e5%90%af%e5%8a%a8docker aria-label="7.3 启动Docker">7.3 启动Docker</a></li><li><a href=#74-%e9%aa%8c%e8%af%81 aria-label="7.4 验证">7.4 验证</a></li><li><a href=#75-%e5%ae%89%e8%a3%85cri-dockerd aria-label="7.5 安装cri-dockerd">7.5 安装cri-dockerd</a></li></ul></li><li><a href=#8kubernetes%e7%9a%84yum%e6%ba%90%e5%88%87%e6%8d%a2%e6%88%90%e5%9b%bd%e5%86%85%e6%ba%90 aria-label=8.kubernetes的Yum源切换成国内源>8.kubernetes的Yum源切换成国内源</a></li><li><a href=#9%e5%ae%89%e8%a3%85%e6%8c%87%e5%ae%9a%e7%89%88%e6%9c%ac-kubeadmkubelet%e5%92%8ckubect aria-label="9.安装指定版本 kubeadm，kubelet和kubect">9.安装指定版本 kubeadm，kubelet和kubect</a></li><li><a href=#10-%e9%80%9a%e8%bf%87-kubeadm-%e9%83%a8%e7%bd%b2kubernetes aria-label="10. 通过 kubeadm 部署Kubernetes">10. 通过 kubeadm 部署Kubernetes</a><ul><li><a href=#101-%e9%83%a8%e7%bd%b2master%e8%8a%82%e7%82%b9 aria-label="10.1 部署master节点">10.1 部署master节点</a></li><li><a href=#102-%e5%b0%86node%e8%8a%82%e7%82%b9%e5%8a%a0%e5%85%a5%e9%9b%86%e7%be%a4 aria-label="10.2 将node节点加入集群">10.2 将node节点加入集群</a></li></ul></li><li><a href=#11%e9%83%a8%e7%bd%b2%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9ccni aria-label=11.部署容器网络（CNI）>11.部署容器网络（CNI）</a></li><li><a href=#12%e5%85%b6%e4%bb%96%e7%bb%b4%e6%8a%a4%e4%ba%8b%e9%a1%b9 aria-label=12.其他维护事项>12.其他维护事项</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><p><strong>K8s搭建流程-使用kubeadm</strong></p><h1 id=1-准备环境>1 准备环境<a hidden class=anchor aria-hidden=true href=#1-准备环境>#</a></h1><h2 id=11-服务器要求>1.1 服务器要求：<a hidden class=anchor aria-hidden=true href=#11-服务器要求>#</a></h2><p>建议最小硬件配置：2核CPU、2G内存、20G硬盘，服务器最好可以访问外网，会有从网上拉取镜像需求，如果服务器不能上网，需要提前下载对应镜像并导入节点。</p><h2 id=12-软件环境>1.2 软件环境：<a hidden class=anchor aria-hidden=true href=#12-软件环境>#</a></h2><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS 7.7.1908 (Core)</td></tr><tr><td>Docker</td><td>24.0.4 (当前最新版)</td></tr><tr><td>Kubernetes</td><td>1.23</td></tr></tbody></table><h2 id=13-服务器规划>1.3 服务器规划：<a hidden class=anchor aria-hidden=true href=#13-服务器规划>#</a></h2><table><thead><tr><th>服务器名称</th><th>服务器IP</th><th>备注</th></tr></thead><tbody><tr><td>master</td><td>10.39.40.1</td><td>24u/93G/755G 同时作为node节点</td></tr><tr><td>node1</td><td>10.39.40.2</td><td>32u/132G/3.6T</td></tr><tr><td>node2</td><td>10.39.40.3</td><td>64u/141G/1.1T</td></tr></tbody></table><blockquote><p>部署使用root账号, 非root账号很多命令相对麻烦</p></blockquote><h1 id=2-主机名解析>2. 主机名解析<a hidden class=anchor aria-hidden=true href=#2-主机名解析>#</a></h1><p><strong>编辑所有节点服务器的 /etc/hosts 文件 ,添加主机名, 执行命令：</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt;&gt; /etc/hosts  <span style=color:#a5d6ff>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>10.39.97.19  master
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>10.39.97.20  node1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><blockquote><p><a href=https://blog.csdn.net/iteye_2225/article/details/82434589 target=_blank rel=noopener>用sudo cat追加文件出错_iteye_2225的博客-CSDN博客</a></p></blockquote><p><strong>设置每台节点的hostname</strong>, 分别执行</p><p>master节点:</p><p><code>hostnamectl set-hostname master</code></p><p>node1节点:</p><p><code>hostnamectl set-hostname node1</code></p><h1 id=3时间同步>3.时间同步<a hidden class=anchor aria-hidden=true href=#3时间同步>#</a></h1><p>启动chronyd服务</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start chronyd 
</span></span><span style=display:flex><span>systemctl enable chronyd 
</span></span><span style=display:flex><span>date
</span></span></code></pre></div><blockquote><p>如果没有安装 chronyd , 可以使用 <code>yum install chrony -y</code> 安装</p></blockquote><h1 id=4禁用selinux和firewalld服务>4.禁用selinux和firewalld服务<a hidden class=anchor aria-hidden=true href=#4禁用selinux和firewalld服务>#</a></h1><p>关闭firewalld服务,并 设置开机不启动</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>systemctl stop firewalld 
</span></span><span style=display:flex><span>systemctl disable firewalld
</span></span></code></pre></div><p>关闭selinux服务，重启后生效</p><p><code>sed -i 's/enforcing/disabled/' /etc/selinux/config</code></p><blockquote><p><a href=https://zhuanlan.zhihu.com/p/165974960 target=_blank rel=noopener>selinux - linux的安全系统, 可以尽可能的控制权限最小化</a></p></blockquote><h1 id=5禁用swap分区>5.禁用swap分区<a hidden class=anchor aria-hidden=true href=#5禁用swap分区>#</a></h1><blockquote><p>swap分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用swap设备会对系统的性能产生非常负面的影响，因此kubernetes要求每个节点都要禁用swap设备，但是如果因为某些原因确实不能关闭swap分区，就需要在集群安装过程中通过明确的参数进行配置说明</p></blockquote><p><code>sed -ri 's/.*swap.*/#&/' /etc/fstab # 永久关闭</code></p><h1 id=6添加网桥过滤和地址转发功能>6.添加网桥过滤和地址转发功能<a hidden class=anchor aria-hidden=true href=#6添加网桥过滤和地址转发功能>#</a></h1><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt;&gt; /etc/sysctl.d/kubernetes.conf <span style=color:#a5d6ff>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>net.ipv4.ip_forward = 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#然后执行</span>
</span></span><span style=display:flex><span>sysctl --system  
</span></span></code></pre></div><p><strong>为使之前的配置生效，重启所有节点服务器</strong></p><p><code>reboot</code></p><h1 id=7docker安装>7.docker安装<a hidden class=anchor aria-hidden=true href=#7docker安装>#</a></h1><h2 id=71-安装docker依赖>7.1 安装docker依赖<a hidden class=anchor aria-hidden=true href=#71-安装docker依赖>#</a></h2><p><code>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</code></p><blockquote><p>这里使用阿里的镜像一键安装, 默认装最新版, 如果是要指定版本,就采用手动安装的方式, 会帮我们做如下操作</p><ol><li><p>安装yum-utils</p></li><li><p>设置docker仓库镜像为阿里的</p></li><li><p>安装 docker-ce / docker-ce-cli / containerd.io / docker-compose / makecache</p><p><a href=https://www.runoob.com/docker/centos-docker-install.html target=_blank rel=noopener>CentOS Docker 安装 | 菜鸟教程 (runoob.com)</a></p></li></ol></blockquote><h2 id=72-配置docker-镜像加速器和默认存储目录>7.2 配置docker 镜像加速器和默认存储目录<a hidden class=anchor aria-hidden=true href=#72-配置docker-镜像加速器和默认存储目录>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>cat <span style=color:#a5d6ff>&lt;&lt;EOF&gt; /etc/docker/daemon.json
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>{
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  &#34;log-opts&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>    &#34;max-size&#34;: &#34;100m&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  },
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  &#34;data-root&#34;: &#34;/app/docker-home&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>  &#34;registry-mirrors&#34;: [&#34;https://registry.docker-cn.com&#34;, &#34;https://hub-mirror.c.163.com&#34;, &#34;https://docker.mirrors.ustc.edu.cn&#34;,&#34;https://alzgoonw.mirror.aliyuncs.com&#34;]
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>}
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><blockquote><p><a href=https://www.cnblogs.com/hellxz/p/docker-change-data-root.html target=_blank rel=noopener>【简记】修改Docker数据目录位置，包含镜像位置 - 东北小狐狸 - 博客园 (cnblogs.com)</a></p></blockquote><h2 id=73-启动docker>7.3 启动Docker<a hidden class=anchor aria-hidden=true href=#73-启动docker>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 设置开机启动</span>
</span></span><span style=display:flex><span>systemctl enable docker 
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 启动docker</span>
</span></span><span style=display:flex><span>systemctl start docker
</span></span></code></pre></div><h2 id=74-验证>7.4 验证<a hidden class=anchor aria-hidden=true href=#74-验证>#</a></h2><p><code>docker version</code> 检查版本</p><blockquote><p>可以看到 docker版本, 容器数, 镜像数, root dir 路径, 镜像仓库 等等</p></blockquote><p><code>docker run hello-world</code></p><p>执行一个 hello-world , 如果能运行成功, 则表示安装成功, 第一次运行要pull 镜像, 可能会慢一点, 等一会它</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Unable to find image &#39;hello-world:latest&#39; locally
</span></span><span style=display:flex><span>latest: Pulling from library/hello-world
</span></span><span style=display:flex><span>1b930d010525: Pull complete
</span></span><span style=display:flex><span>Digest: sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f
</span></span><span style=display:flex><span>Status: Downloaded newer image for hello-world:latest
</span></span><span style=display:flex><span>Hello from Docker!
</span></span><span style=display:flex><span>This message shows that your installation appears to be working correctly.
</span></span><span style=display:flex><span>To generate this message, Docker took the following steps:
</span></span><span style=display:flex><span> 1. The Docker client contacted the Docker daemon.
</span></span><span style=display:flex><span> 2. The Docker daemon pulled the &#34;hello-world&#34; image from the Docker Hub.
</span></span><span style=display:flex><span>    (amd64)
</span></span><span style=display:flex><span> 3. The Docker daemon created a new container from that image which runs the
</span></span><span style=display:flex><span>    executable that produces the output you are currently reading.
</span></span><span style=display:flex><span> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span></span><span style=display:flex><span>    to your terminal.
</span></span><span style=display:flex><span>To try something more ambitious, you can run an Ubuntu container with:
</span></span><span style=display:flex><span> $ docker run -it ubuntu bash
</span></span><span style=display:flex><span>Share images, automate workflows, and more with a free Docker ID:
</span></span><span style=display:flex><span> https://hub.docker.com/
</span></span><span style=display:flex><span>For more examples and ideas, visit:
</span></span><span style=display:flex><span> https://docs.docker.com/get-started/
</span></span></code></pre></div><h2 id=75-安装cri-dockerd>7.5 安装cri-dockerd<a hidden class=anchor aria-hidden=true href=#75-安装cri-dockerd>#</a></h2><p>从v1.24起，Docker不能直接作为k8s的<a href=https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/ target=_blank rel=noopener>容器运行时</a>
，因为在k8s v1.24版本移除了叫dockershim的组件，这是由k8s团队直接维护而非Docker团队维护的组件，这意味着Docker和k8s的关系不再像原来那般亲密，开发者需要使用其它符合CRI（<a href=https://github.com/kubernetes/cri-api#readme target=_blank rel=noopener>容器运行时接口</a>
）的容器运行时工具（如containerd, CRI-O等），当然这并不意味着新版本的k8s彻底抛弃Docker（由于Docker庞大的生态和广泛的群众基础，显然这并不容易办到），在原本安装了Docker的基础上，可以通过补充安装<a href=https://github.com/Mirantis/cri-dockerd target=_blank rel=noopener>cri-dockerd</a>
，以满足容器运行时接口的条件，从某种程度上说，cri-dockerd就是翻版的dockershim。</p><p><strong>本篇的k8s 刚好在 1.23版本, 所以不用特意安装</strong></p><p><a href=https://zhuanlan.zhihu.com/p/641521752 target=_blank rel=noopener>Kubernetes最新版2023.07v1.27.4安装和集群搭建保姆级教程 - 知乎 (zhihu.com)</a></p><h1 id=8kubernetes的yum源切换成国内源>8.kubernetes的Yum源切换成国内源<a hidden class=anchor aria-hidden=true href=#8kubernetes的yum源切换成国内源>#</a></h1><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo <span style=color:#a5d6ff>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>repo_gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg 
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>EOF</span>
</span></span></code></pre></div><h1 id=9安装指定版本-kubeadmkubelet和kubect>9.安装指定版本 kubeadm，kubelet和kubect<a hidden class=anchor aria-hidden=true href=#9安装指定版本-kubeadmkubelet和kubect>#</a></h1><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#设置kubelet开机启动</span>
</span></span><span style=display:flex><span>systemctl enable kubelet
</span></span></code></pre></div><h1 id=10-通过-kubeadm-部署kubernetes>10. 通过 kubeadm 部署Kubernetes<a hidden class=anchor aria-hidden=true href=#10-通过-kubeadm-部署kubernetes>#</a></h1><h2 id=101-部署master节点>10.1 部署master节点<a hidden class=anchor aria-hidden=true href=#101-部署master节点>#</a></h2><p>Kubernetes 初始化，下面的操作<strong>只需要在master节点</strong>上执行即可</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm init <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --apiserver-advertise-address<span style=color:#ff7b72;font-weight:700>=</span>10.39.40.1 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --image-repository registry.aliyuncs.com/google_containers <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --kubernetes-version v1.23.0 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --service-cidr<span style=color:#ff7b72;font-weight:700>=</span>192.168.128.0/17 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --pod-network-cidr<span style=color:#ff7b72;font-weight:700>=</span>192.168.0.0/17 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>  --ignore-preflight-errors<span style=color:#ff7b72;font-weight:700>=</span>all
</span></span></code></pre></div><blockquote><p>&ndash;apiserver-advertise-address #集群通告地址(master 机器IP)
&ndash;image-repository #由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址
&ndash;kubernetes-version #K8s版本，与上面安装的一致
&ndash;service-cidr #集群内部service网络
&ndash;pod-network-cidr #集群内部pod网络，与下面部署的CNI网络组件yaml中保持一致</p></blockquote><blockquote><p><a href=https://developer.aliyun.com/ask/139167 target=_blank rel=noopener>搭建k8s时service-cidr是根据自己本地得ip地址写得 (aliyun.com)</a>
<img loading=lazy src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" alt=img></p></blockquote><p><strong>成功后末尾输出信息如下</strong>：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style=display:flex><span>To start using your cluster, you need to run the following as a regular user<span style=color:#f85149>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mkdir -p <span style=color:#79c0ff>$HOME</span>/.<span style=color:#79c0ff>kube</span>
</span></span><span style=display:flex><span>  sudo cp -i /etc/kubernetes/admin.<span style=color:#79c0ff>conf</span> <span style=color:#79c0ff>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>  sudo chown $(id -u)<span style=color:#f85149>:</span>$(id -g) <span style=color:#79c0ff>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You should now deploy a pod network to the cluster.
</span></span><span style=display:flex><span>Run <span style=color:#a5d6ff>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at<span style=color:#f85149>:</span>
</span></span><span style=display:flex><span>  https<span style=color:#f85149>:</span>//kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root<span style=color:#f85149>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>#### 这行数据 复制下来, 节点加入进群需要用到此命令</span>
</span></span><span style=display:flex><span>kubeadm join <span style=color:#a5d6ff>10.39</span>.<span style=color:#79c0ff>40</span>.<span style=color:#a5d6ff>1</span><span style=color:#f85149>:</span><span style=color:#a5d6ff>6443</span> --token 1j3dl9.<span style=color:#79c0ff>1z8wjckd94xluwh6</span> \
</span></span><span style=display:flex><span>    --discovery-token-ca-cert-hash sha256<span style=color:#f85149>:</span>c464e3ebd7f432f094bacf06269003730f010b431c3fb76acade4f43d4740
</span></span></code></pre></div><p><strong>创建客户端授权文件</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p <span style=color:#79c0ff>$HOME</span>/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf <span style=color:#79c0ff>$HOME</span>/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#ff7b72>$(</span>id -u<span style=color:#ff7b72>)</span>:<span style=color:#ff7b72>$(</span>id -g<span style=color:#ff7b72>)</span> <span style=color:#79c0ff>$HOME</span>/.kube/config
</span></span></code></pre></div><blockquote><p>授权kubectl 客户端能连接上 k8s, 这里只在master配置, 如果需要在其他节点配置, 就把 <code>/etc/kubernetes/admin.conf</code> 文件复制到其他节点上</p></blockquote><h2 id=102-将node节点加入集群>10.2 将node节点加入集群<a hidden class=anchor aria-hidden=true href=#102-将node节点加入集群>#</a></h2><p>在所有node节点上执行以下命令(初始化master 得到的命令)</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm join 10.39.40.1:6443 --token 1j3dl9.1z8wjckd94xluwh6 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    --discovery-token-ca-cert-hash sha256:c464e3ebd7f432f094bacf06269003730f010b431c3fb76acade4f43d4740
</span></span></code></pre></div><h1 id=11部署容器网络cni>11.部署容器网络（CNI）<a hidden class=anchor aria-hidden=true href=#11部署容器网络cni>#</a></h1><blockquote><p>pod之前需要网络通信, 但是k8s没有具体实现, 只是开了CNI能力, 所以需要其他方案来完善</p><p>Calico是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案。 官方的部署文档使用的是 <code>flannel</code></p><p><a href=https://www.infoq.cn/article/gxftm0x8z2zlhw9xlezv target=_blank rel=noopener>Kubernetes CNI网络最强对比：Flannel、Calico、Canal和Weave_文化 & 方法_Rancher_InfoQ精选文章</a></p></blockquote><p><strong>Master 节点下载Calico YAML 文件</strong></p><p><code>curl https://docs.projectcalico.org/v3.7/manifests/calico.yaml -O</code></p><p>下载完后<strong>修改里面定义Pod网络</strong>（CALICO_IPV4POOL_CIDR），与前面kubeadm init 的 &ndash;pod-network-cidr 指定的一样</p><p><img loading=lazy src=./%E5%AE%89%E8%A3%85.assets/image-20230802201055835.png alt=image-20230802201055835></p><p><strong>创建calico网络，Master节点上执行</strong></p><p><code>kubectl apply -f calico.yaml</code></p><p><strong>查看网络状态</strong></p><p><code>kubectl get pods -n kube-system -w</code></p><p>等待一段时间，calico 和 coredns 相关pod处于ready状态, 这个过程要等好几分钟</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kube-system   calico-kube-controllers-dbd6bd945-vlqxh   1/1     Running   0          4m51s
</span></span><span style=display:flex><span>kube-system   calico-node-hkp5s                         1/1     Running   0          4m51s
</span></span><span style=display:flex><span>kube-system   calico-node-ksxg8                         1/1     Running   0          4m51s
</span></span><span style=display:flex><span>kube-system   calico-node-srd2r                         1/1     Running   0          4m51s
</span></span><span style=display:flex><span>kube-system   coredns-7f6cbbb7b8-svhdg                  1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   coredns-7f6cbbb7b8-vmm2h                  1/1     Running   0          22h
</span></span><span style=display:flex><span>### 上面这些
</span></span><span style=display:flex><span>kube-system   etcd-k8s-master                           1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   kube-apiserver-k8s-master                 1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-k8s-master        1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   kube-proxy-4dvgq                          1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   kube-proxy-5jhkj                          1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   kube-proxy-5jtwf                          1/1     Running   0          22h
</span></span><span style=display:flex><span>kube-system   kube-scheduler-k8s-master                 1/1     Running   0          22h
</span></span></code></pre></div><p>查看节点状态，处于 ready 状态</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[root@master01 ~]# kubectl get nodes
</span></span><span style=display:flex><span>NAME       STATUS   ROLES                  AGE   VERSION
</span></span><span style=display:flex><span>master   Ready    control-plane,master   21h   v1.23.4
</span></span><span style=display:flex><span>node1   Ready    &lt;none&gt;                 16h   v1.23.4
</span></span><span style=display:flex><span>node2   Ready    &lt;none&gt;                 16h   v1.23.4
</span></span><span style=display:flex><span>[root@master01 ~]# 
</span></span><span style=display:flex><span>可以看到所有节点的状态已经变为是Ready了。
</span></span></code></pre></div><p>至此K8s已经部署完成，已可以简单使用，但是缺少NFS，不支持灵活的数据持久化</p><h1 id=12其他维护事项>12.其他维护事项<a hidden class=anchor aria-hidden=true href=#12其他维护事项>#</a></h1><p>重新申请 join token 24小时有效</p><p><code>kubeadm token create --print-join-command</code></p><p>master 节点同时设置为 node节点</p><p><code>kubectl taint node master node-role.kubernetes.io/master-</code></p><p>恢复 master only</p><p><code>kubectl taint node master node-role.kubernetes.io/master="":NoSchedule</code></p><p><a href=https://flowus.cn/share/cf359a50-272a-4fc2-b27b-42014bec123e target=_blank rel=noopener>K8s搭建流程-使用kubeadm (flowus.cn)</a></p><p><a href=https://zhuanlan.zhihu.com/p/265968760 target=_blank rel=noopener>kubernetes(k8s)环境搭建 - 知乎 (zhihu.com)</a></p><p><a href=https://zhuanlan.zhihu.com/p/641521752 target=_blank rel=noopener>Kubernetes最新版2023.07v1.27.4安装和集群搭建保姆级教程 - 知乎 (zhihu.com)</a></p><p><a href=https://www.runoob.com/docker/windows-docker-install.html target=_blank rel=noopener>Windows Docker 安装 | 菜鸟教程 (runoob.com)</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/kubernetes.html>Kubernetes</a></li><li><a href=https://xiaokunji.com/zh/tags/%E7%BB%BC%E5%90%88.html>综合</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/docker/%E5%AE%89%E8%A3%85.html><span class=title>« 上一页</span><br><span>安装</span></a>
<a class=next href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/%E5%AE%89%E8%A3%85%E5%8F%8A%E5%87%86%E5%A4%87.html><span class=title>下一页 »</span><br><span>安装及准备</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>米二</a>
All Rights Reserved</span>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container><span class="fa fa-user">用户数:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">访问数:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>