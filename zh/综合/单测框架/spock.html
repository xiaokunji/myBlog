<!DOCTYPE html>
<html dir="auto" lang="zh"><head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="x-ua-compatible"/><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"/><meta content="index, follow" name="robots"/><title>简述spock以及使用 | 米二</title><meta content="spock,单测" name="keywords"/><meta content="Spock是一款国外优秀的测试框架，基于BDD（行为驱动开发）思想实现，功能非常强大。Spock结合Groovy动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效 " name="description"/><meta content="xkj" name="author"/><link href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6/spock.html" rel="canonical"/><link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.dc6bd2c841ee388e899e13872ae986c0e847e8b957d6714ad6ddc628ef2d17ff.css" integrity="sha256-3GvSyEHuOI6JnhOHKumGwOhH6LlX1nFK1t3GKO8tF/8=" rel="preload stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js"></script>
<link href="https://xiaokunji.com/img/Q.svg" rel="icon"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="16x16" type="image/png"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="32x32" type="image/png"/><link href="https://xiaokunji.com/Q.svg" rel="apple-touch-icon"/><link href="https://xiaokunji.com/Q.svg" rel="mask-icon"/><meta content="#2e2e33" name="theme-color"/><meta content="#2e2e33" name="msapplication-TileColor"/><link href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6/spock.html" hreflang="zh" rel="alternate"/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta content="简述spock以及使用" property="og:title"/><meta content="Spock是一款国外优秀的测试框架，基于BDD（行为驱动开发）思想实现，功能非常强大。Spock结合Groovy动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效 " property="og:description"/><meta content="article" property="og:type"/><meta content="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6/spock.html" property="og:url"/><meta content="综合" property="article:section"/><meta content="2024-02-23T00:00:00+00:00" property="article:published_time"/><meta content="2024-06-17T19:51:53+08:00" property="article:modified_time"/><meta content="summary" name="twitter:card"/><meta content="简述spock以及使用" name="twitter:title"/><meta content="Spock是一款国外优秀的测试框架，基于BDD（行为驱动开发）思想实现，功能非常强大。Spock结合Groovy动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效 " name="twitter:description"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"简述spock以及使用","item":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6/spock.html"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"简述spock以及使用","name":"简述spock以及使用","description":"Spock是一款国外优秀的测试框架，基于BDD（行为驱动开发）思想实现，功能非常强大。Spock结合Groovy动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效 ","keywords":["spock","单测"],"articleBody":"1. 介绍 1.1 Spock是什么？ Spock是一款国外优秀的测试框架，基于BDD （行为驱动开发）思想实现，功能非常强大。Spock结合Groovy动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效。官方的介绍 Spock是一个Java和Groovy`应用的测试和规范框架。之所以能够在众多测试框架中脱颖而出，是因为它优美而富有表现力的规范语言。Spock的灵感来自JUnit、RSpec、jMock、Mockito、Groovy、Scala、Vulcans。\n简单来讲，Spock主要特点如下：\n让测试代码更规范，内置多种标签来规范单元测试代码的语义，测试代码结构清晰，更具可读性，降低后期维护难度。\n提供多种标签，比如：given、when、then、expect、where、with、thrown……帮助我们应对复杂的测试场景。\n使用Groovy这种动态语言来编写测试代码，可以让我们编写的测试代码更简洁，适合敏捷开发，提高编写单元测试代码的效率。\n遵从BDD （行为驱动开发）模式，有助于提升代码的质量。\nIDE兼容性好，自带Mock功能。\nSpock和JUnit、jMock、Mockito的区别在哪里？\n总的来说，JUnit、jMock、Mockito都是相对独立的工具，只是针对不同的业务场景提供特定的解决方案。其中JUnit单纯用于测试，并不提供Mock功能。\n我们的服务大部分是分布式微服务架构。服务与服务之间通常都是通过接口的方式进行交互。即使在同一个服务内也会分为多个模块，业务功能需要依赖下游接口的返回数据，才能继续后面的处理流程。这里的下游不限于接口，还包括中间件数据存储比如Squirrel、DB、MCC配置中心等等，所以如果想要测试自己的代码逻辑，就必须把这些依赖项Mock掉。因为如果下游接口不稳定可能会影响我们代码的测试结果，让下游接口返回指定的结果集（事先准备好的数据），这样才能验证我们的代码是否正确，是否符合逻辑结果的预期。\n尽管jMock、Mockito提供了Mock功能，可以把接口等依赖屏蔽掉，但不能对静态方法Mock。虽然PowerMock、jMockit能够提供静态方法的Mock，但它们之间也需要配合（JUnit + Mockito PowerMock）使用，并且语法上比较繁琐。工具多了就会导致不同的人写出的单元测试代码“五花八门”，风格相差较大。\nSpock通过提供规范性的描述，定义多种标签（given、when、then、where等），去描述代码“应该做什么”，“输入条件是什么”，“输出是否符合预期”，从语义层面规范了代码的编写。\nSpock自带Mock功能，使用简单方便（也支持扩展其他Mock框架，比如PowerMock），再加上Groovy动态语言的强大语法，能写出简洁高效的测试代码，同时能方便直观地验证业务代码的行为流转，增强工程师对代码执行逻辑的可控性。\n1.2 使用Spock解决单元测试开发中的痛点 如果在（if/else）分支很多的复杂场景下，编写单元测试代码的成本会变得非常高，正常的业务代码可能只有几十行，但为了测试这个功能覆盖大部分的分支场景，编写的测试代码可能远不止几十行。\n尽管使用JUnit的@Parametered参数化注解或者DataProvider方式可以解决多数据分支问题，但不够直观，而且如果其中某一次分支测试Case出错了，它的报错信息也不够详尽。\n这就需要一种编写测试用例高效、可读性强、占用工时少、维护成本低的测试框架。首先不能让业务人员排斥编写单元测试，更不能让工程师觉得写单元测试是在浪费时间。而且使用JUnit做测试工作量不算小。据初步统计，采用JUnit的话，它的测试代码行和业务代码行能到3:1。如果采用Spock作为测试框架的话，它的比例可缩减到1:1，能够大大提高编写测试用例的效率。\n举个例子:\npublic double calc(double income) { BigDecimal tax; BigDecimal salary = BigDecimal.valueOf(income); if (income \u003c= 0) { return 0; } if (income \u003e 0 \u0026\u0026 income \u003c= 3000) { BigDecimal taxLevel = BigDecimal.valueOf(0.03); tax = salary.multiply(taxLevel); } else if (income \u003e 3000 \u0026\u0026 income \u003c= 12000) { BigDecimal taxLevel = BigDecimal.valueOf(0.1); BigDecimal base = BigDecimal.valueOf(210); tax = salary.multiply(taxLevel).subtract(base); } else if (income \u003e 12000 \u0026\u0026 income \u003c= 25000) { BigDecimal taxLevel = BigDecimal.valueOf(0.2); BigDecimal base = BigDecimal.valueOf(1410); tax = salary.multiply(taxLevel).subtract(base); } else if (income \u003e 25000 \u0026\u0026 income \u003c= 35000) { BigDecimal taxLevel = BigDecimal.valueOf(0.25); BigDecimal base = BigDecimal.valueOf(2660); tax = salary.multiply(taxLevel).subtract(base); } else if (income \u003e 35000 \u0026\u0026 income \u003c= 55000) { BigDecimal taxLevel = BigDecimal.valueOf(0.3); BigDecimal base = BigDecimal.valueOf(4410); tax = salary.multiply(taxLevel).subtract(base); } else if (income \u003e 55000 \u0026\u0026 income \u003c= 80000) { BigDecimal taxLevel = BigDecimal.valueOf(0.35); BigDecimal base = BigDecimal.valueOf(7160); tax = salary.multiply(taxLevel).subtract(base); } else { BigDecimal taxLevel = BigDecimal.valueOf(0.45); BigDecimal base = BigDecimal.valueOf(15160); tax = salary.multiply(taxLevel).subtract(base); } return tax.setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue(); } 能够看到上面的代码中有大量的if-else语句，Spock提供了where标签，可以让我们通过表格的方式来测试多种分支。\n@Unroll def \"个税计算,收入:#income, 个税:#result\"() { expect: \"when + then 的组合\" CalculateTaxUtils.calc(income) == result where: \"表格方式测试不同的分支逻辑\" income || result -1 || 0 0 || 0 2999 || 89.97 3000 || 90.0 3001 || 90.1 11999 || 989.9 12000 || 990.0 12001 || 990.2 24999 || 3589.8 25000 || 3590.0 25001 || 3590.25 34999 || 6089.75 35000 || 6090.0 35001 || 6090.3 54999 || 12089.7 55000 || 12090 55001 || 12090.35 79999 || 20839.65 80000 || 20840.0 80001 || 20840.45 } 由此可见, 使用spock框架比junit更能节省代码, 但是spock是使用的是Groovy语法, 所以需要学习一下它的语法, 因为Groovy是基于java虚拟机的语言, 所以也能直接写java代码(不过java语法繁琐, 用java的话和用junit差不多了)\n2. 使用篇 2.1 引入pom org.codehaus.groovy groovy-all 2.4.15 test org.spockframework spock-spring 1.2-groovy-2.4 test org.powermock powermock-api-mockito2 2.0.0 test org.powermock powermock-module-junit4 2.0.0 test 2.2 使用案例 import org.mockito.InjectMocks import org.mockito.Matchers import org.mockito.Mock import org.mockito.MockitoAnnotations import org.slf4j.Logger import spock.lang.Specification import spock.lang.Unroll import java.time.LocalDate import java.time.LocalDateTime import java.time.Month import java.time.temporal.ChronoUnit import static org.mockito.Mockito.when class QueryDateTest extends Specification { @Unroll(\"#testName\") def \"测试特定时间tess\"() { when: \"执行以及结果验证\" def queryDate = new QueryDate() queryDate.setSpecialDateType(sepecial) // 赋值, \u003c\u003c 表示(集合类型)右边赋值给左边 (Groovy语法) //\tqueryDate.getCustomDateTimes() \u003c\u003c [time1, time2] then: def actual = queryDate.getCustomDateTimes() def collect = actual.collect { arr -\u003e \"[${arr*.toString().join(',')}]\" }.join(',') rStr == collect where: \"测试用例覆盖\" testName | sepecial || rStr \"1-分钟粒度-近12小时-最后一天\" | Arrays.asList(5) || \"{2024-01-19T05:00,2024-01-19T17:00}\" \"2-10分钟粒度-近12小时-中间天\" | Arrays.asList(4) || \"{2024-01-18T00:00,2024-01-19T00:00}\" \"3-10分钟粒度-绝对时间-中间天-跨天\" | Arrays.asList(1) || \"{2024-01-15T00:00,2024-01-16T00:00}\" } } 结果如下:\n解释:\n@Unroll , 可以让where中的每一个案例当成一个单测, 如此可以在输出结果时,分开查看当前用例执行情况 (如果不加, 则合并一起展示)\n#testName 是一个变量, 在where中复制, 表示, 当前用例的名称 (参见输出结果)\n测试特定时间tess 表示这个单测方法的名称 (其实java也允许中文函数名称)\nwhen, then, where 是spock的关键字\nwhen: 表示当如何时, 可以做一些赋值,定义之类的工作 then: 表示然后如何, 可以做业务逻辑的操作 where: 表示条件如何, 这里就是写大量条件的地方 当然, 你也可以把 when和then合并, 也可以不要 where, 把输入条件全部写在then中 (这就和juint一样了), 后面再介绍一下还有其他关键字和组合用法\ndef 和 collect{} 是 Groovy语法\nwhere 后面是一个类似表格的东西, 里面就是入参, 第一行是定义变量名, 这里的变量名可以再when 和 then中使用, 多个列使用|单竖线隔开，||双竖线区分输入和输出变量，即左边是输入值，右边是输出值 (其实全部写成 || 也可以)(此处的用法是, 入参和期望结果都是变量形式)\n格式: 输入参数1 | 输入参数2 || 输出结果1 | 输出结果2\n2.3 分块(关键字) 分块 替换 功能 说明 given setup 初始化函数、MOCK 非必要 when expect 执行待测试的函数 when 和 then 必须成对出现 then expect 验证函数结果 when 和 then 可以被 expect 替换 where 多套测试数据的检测 spock的特性功能 and 对其余块进行分隔说明 非必要 Spock单元测试框架介绍以及在美团优选的实践 - 美团技术团队 (meituan.com) 吃透单元测试：Spock单元测试框架的应用与实践-CSDN博客 Spock-高质量单元测试实操篇 - My_blog_s - 博客园 (cnblogs.com) ","wordCount":"3129","inLanguage":"zh","datePublished":"2024-02-23T00:00:00Z","dateModified":"2024-06-17T19:51:53+08:00","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6/spock.html"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class="dark" id="top"><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class="header"><nav class="nav"><div class="logo"><a accesskey="h" href="https://xiaokunji.com/zh/" title="米二 (Alt + H)"><img alt="" aria-label="logo" height="35" src="https://xiaokunji.com/img/Q.svg"/>米二</a><div class="logo-switches"><button accesskey="t" id="theme-toggle" title="(Alt + T)"><svg fill="none" height="18" id="moon" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg><svg fill="none" height="18" id="sun" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg></button><ul class="lang-switch"><li>|</li><li><a aria-label="English" href="https://xiaokunji.com/en/" title="English">English</a></li></ul></div></div><ul id="menu"><li><a href="https://xiaokunji.com/zh/" title="🏠主页"><span>🏠主页</span></a></li><li><a accesskey="/" href="https://xiaokunji.com/zh/search" title="🔍搜索 (Alt + /)"><span>🔍搜索</span></a></li><li><a href="https://xiaokunji.com/zh/post.html" title="📚文章"><span>📚文章</span></a></li><li><a href="https://xiaokunji.com/zh/archives.html" title="⏱时间轴"><span>⏱时间轴</span></a></li><li><a href="https://xiaokunji.com/zh/tags.html" title="🔖标签"><span>🔖标签</span></a></li><li><a href="https://xiaokunji.com/zh/categories.html" title="📖分类"><span>📖分类</span></a></li><li><a href="https://xiaokunji.com/zh/links.html" title="🤝友链"><span>🤝友链</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><nav aria-label="breadcrumb"><ul><a href="https://xiaokunji.com/zh/">🏠</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88.html">综合</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6.html">单测框架</a> <span>&gt;</span></ul></nav><h1 class="post-title">简述spock以及使用</h1><div class="post-description">Spock是一款国外优秀的测试框架，基于BDD（行为驱动开发）思想实现，功能非常强大。Spock结合Groovy动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效</div><div class="post-meta">创建: <span title="2024-02-23 00:00:00 +0000 UTC">2024-02-23</span> · 更新: 2024-06-17 · xkj
 | 分类:  <ul class="post-categories-meta" style="display:inline"><a href="https://xiaokunji.com/zh/categories/%E7%BB%BC%E5%90%88.html">综合</a></ul><span id="busuanzi_container_page_pv"> | 访问: <span id="busuanzi_value_page_pv">1</span></span></div></header><aside class="toc-container wide" id="toc-container"><div class="toc"><details open=""><summary accesskey="c" title="(Alt + C)"><span class="details">目录</span></summary><div class="inner"><ul><li><a aria-label="1. 介绍" href="#1-%e4%bb%8b%e7%bb%8d">1. 介绍</a><ul><li><a aria-label="1.1 Spock是什么？" href="#11-spock%e6%98%af%e4%bb%80%e4%b9%88">1.1 Spock是什么？</a></li><li><a aria-label="1.2 使用Spock解决单元测试开发中的痛点" href="#12-%e4%bd%bf%e7%94%a8spock%e8%a7%a3%e5%86%b3%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e5%bc%80%e5%8f%91%e4%b8%ad%e7%9a%84%e7%97%9b%e7%82%b9">1.2 使用Spock解决单元测试开发中的痛点</a></li></ul></li><li><a aria-label="2. 使用篇" href="#2-%e4%bd%bf%e7%94%a8%e7%af%87">2. 使用篇</a><ul><li><a aria-label="2.1 引入pom" href="#21-%e5%bc%95%e5%85%a5pom">2.1 引入pom</a></li><li><a aria-label="2.2 使用案例" href="#22-%e4%bd%bf%e7%94%a8%e6%a1%88%e4%be%8b">2.2 使用案例</a></li><li><a aria-label="2.3 分块(关键字)" href="#23-%e5%88%86%e5%9d%97%e5%85%b3%e9%94%ae%e5%ad%97">2.3 分块(关键字)</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class="post-content"><h1 id="1-介绍">1. 介绍<a aria-hidden="true" class="anchor" hidden="" href="#1-介绍">#</a></h1><h2 id="11-spock是什么">1.1 Spock是什么？<a aria-hidden="true" class="anchor" hidden="" href="#11-spock是什么">#</a></h2><p>Spock是一款国外优秀的测试框架，基于<a href="https://en.wikipedia.org/wiki/Behavior-driven_development" rel="noopener" target="_blank">BDD</a>
（行为驱动开发）思想实现，功能非常强大。<strong>Spock结合Groovy动态语言的特点</strong>，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效。<a href="https://spockframework.org/" rel="noopener" target="_blank">官方的介绍</a></p><p>Spock是一个Java和Groovy`应用的测试和规范框架。之所以能够在众多测试框架中脱颖而出，是因为它优美而富有表现力的规范语言。Spock的灵感来自JUnit、RSpec、jMock、Mockito、Groovy、Scala、Vulcans。</p><p>简单来讲，Spock主要特点如下：</p><ul><li><p>让测试代码更规范，内置多种标签来规范单元测试代码的语义，测试代码结构清晰，更具可读性，降低后期维护难度。</p></li><li><p>提供多种标签，比如：<code>given</code>、<code>when</code>、<code>then</code>、<code>expect</code>、<code>where</code>、<code>with</code>、<code>thrown</code>……帮助我们应对复杂的测试场景。</p></li><li><p>使用Groovy这种动态语言来编写测试代码，可以让我们编写的测试代码更简洁，适合敏捷开发，提高编写单元测试代码的效率。</p></li><li><p>遵从<a href="https://en.wikipedia.org/wiki/Behavior-driven_development" rel="noopener" target="_blank">BDD</a>
（行为驱动开发）模式，有助于提升代码的质量。</p></li><li><p>IDE兼容性好，自带Mock功能。</p></li></ul><p><strong>Spock和JUnit、jMock、Mockito的区别在哪里？</strong></p><p>总的来说，JUnit、jMock、Mockito都是相对独立的工具，只是针对不同的业务场景提供特定的解决方案。其中JUnit单纯用于测试，并不提供Mock功能。</p><p>我们的服务大部分是分布式微服务架构。服务与服务之间通常都是通过接口的方式进行交互。即使在同一个服务内也会分为多个模块，业务功能需要依赖下游接口的返回数据，才能继续后面的处理流程。这里的下游不限于接口，还包括中间件数据存储比如Squirrel、DB、MCC配置中心等等，所以如果想要测试自己的代码逻辑，就必须把这些依赖项Mock掉。因为如果下游接口不稳定可能会影响我们代码的测试结果，让下游接口返回指定的结果集（事先准备好的数据），这样才能验证我们的代码是否正确，是否符合逻辑结果的预期。</p><p>尽管jMock、Mockito提供了Mock功能，可以把接口等依赖屏蔽掉，但不能对静态方法Mock。虽然PowerMock、jMockit能够提供静态方法的Mock，但它们之间也需要配合（JUnit + Mockito PowerMock）使用，并且语法上比较繁琐。工具多了就会导致不同的人写出的单元测试代码“五花八门”，风格相差较大。</p><p>Spock通过提供规范性的描述，定义多种标签（<code>given</code>、<code>when</code>、<code>then</code>、<code>where</code>等），去描述代码“应该做什么”，“输入条件是什么”，“输出是否符合预期”，从语义层面规范了代码的编写。</p><p>Spock自带Mock功能，使用简单方便（也支持扩展其他Mock框架，比如PowerMock），再加上Groovy动态语言的强大语法，能写出简洁高效的测试代码，同时能方便直观地验证业务代码的行为流转，增强工程师对代码执行逻辑的可控性。</p><h2 id="12-使用spock解决单元测试开发中的痛点">1.2 使用Spock解决单元测试开发中的痛点<a aria-hidden="true" class="anchor" hidden="" href="#12-使用spock解决单元测试开发中的痛点">#</a></h2><p>如果在（<code>if/else</code>）分支很多的复杂场景下，编写单元测试代码的成本会变得非常高，正常的业务代码可能只有几十行，但为了测试这个功能覆盖大部分的分支场景，编写的测试代码可能远不止几十行。</p><p>尽管使用JUnit的@Parametered参数化注解或者DataProvider方式可以解决多数据分支问题，但不够直观，而且如果其中某一次分支测试Case出错了，它的报错信息也不够详尽。</p><p>这就需要一种编写测试用例高效、可读性强、占用工时少、维护成本低的测试框架。首先不能让业务人员排斥编写单元测试，更不能让工程师觉得写单元测试是在浪费时间。而且使用JUnit做测试工作量不算小。据初步统计，采用JUnit的话，它的测试代码行和业务代码行能到3:1。如果采用Spock作为测试框架的话，它的比例可缩减到1:1，能够大大提高编写测试用例的效率。</p><p>举个例子:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">public</span> <span style="color:#ff7b72">double</span> <span style="color:#d2a8ff;font-weight:700">calc</span><span style="color:#ff7b72;font-weight:700">(</span><span style="color:#ff7b72">double</span> income<span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>        BigDecimal tax<span style="color:#ff7b72;font-weight:700">;</span>
</span></span><span style="display:flex"><span>        BigDecimal salary <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span>income<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">;</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&gt;</span> <span style="color:#a5d6ff">0</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">3000</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>03<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span> <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&gt;</span> <span style="color:#a5d6ff">3000</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">12000</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>1<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            BigDecimal base <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">210</span><span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">).</span>subtract<span style="color:#ff7b72;font-weight:700">(</span>base<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span> <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&gt;</span> <span style="color:#a5d6ff">12000</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">25000</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>2<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            BigDecimal base <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">1410</span><span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">).</span>subtract<span style="color:#ff7b72;font-weight:700">(</span>base<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span> <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&gt;</span> <span style="color:#a5d6ff">25000</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">35000</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>25<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            BigDecimal base <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">2660</span><span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">).</span>subtract<span style="color:#ff7b72;font-weight:700">(</span>base<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span> <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&gt;</span> <span style="color:#a5d6ff">35000</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">55000</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>3<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            BigDecimal base <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">4410</span><span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">).</span>subtract<span style="color:#ff7b72;font-weight:700">(</span>base<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span> <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:700">(</span>income <span style="color:#ff7b72;font-weight:700">&gt;</span> <span style="color:#a5d6ff">55000</span> <span style="color:#ff7b72;font-weight:700">&amp;&amp;</span> income <span style="color:#ff7b72;font-weight:700">&lt;=</span> <span style="color:#a5d6ff">80000</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>35<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            BigDecimal base <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">7160</span><span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">).</span>subtract<span style="color:#ff7b72;font-weight:700">(</span>base<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span> <span style="color:#ff7b72">else</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>            BigDecimal taxLevel <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">0</span><span style="color:#ff7b72;font-weight:700">.</span>45<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            BigDecimal base <span style="color:#ff7b72;font-weight:700">=</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>valueOf<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">15160</span><span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>            tax <span style="color:#ff7b72;font-weight:700">=</span> salary<span style="color:#ff7b72;font-weight:700">.</span>multiply<span style="color:#ff7b72;font-weight:700">(</span>taxLevel<span style="color:#ff7b72;font-weight:700">).</span>subtract<span style="color:#ff7b72;font-weight:700">(</span>base<span style="color:#ff7b72;font-weight:700">);</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72;font-weight:700">}</span>
</span></span><span style="display:flex"><span>        <span style="color:#ff7b72">return</span> tax<span style="color:#ff7b72;font-weight:700">.</span>setScale<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">2</span><span style="color:#ff7b72;font-weight:700">,</span> BigDecimal<span style="color:#ff7b72;font-weight:700">.</span>ROUND_HALF_UP<span style="color:#ff7b72;font-weight:700">).</span>doubleValue<span style="color:#ff7b72;font-weight:700">();</span>
</span></span><span style="display:flex"><span>    <span style="color:#ff7b72;font-weight:700">}</span>
</span></span></code></pre></div><p>能够看到上面的代码中有大量的<code>if-else</code>语句，Spock提供了where标签，可以让我们通过表格的方式来测试多种分支。</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-groovy" data-lang="groovy"><span style="display:flex"><span><span style="color:#d2a8ff;font-weight:700">@Unroll</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">def</span> <span style="color:#a5d6ff">"个税计算,收入:#income, 个税:#result"</span><span style="color:#ff7b72;font-weight:700">()</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>  <span style="color:#79c0ff;font-weight:700">expect:</span> <span style="color:#a5d6ff">"when + then 的组合"</span>
</span></span><span style="display:flex"><span>  CalculateTaxUtils<span style="color:#ff7b72;font-weight:700">.</span>calc<span style="color:#ff7b72;font-weight:700">(</span>income<span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">==</span> result
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>  <span style="color:#79c0ff;font-weight:700">where:</span> <span style="color:#a5d6ff">"表格方式测试不同的分支逻辑"</span>
</span></span><span style="display:flex"><span>  income <span style="color:#ff7b72;font-weight:700">||</span> result
</span></span><span style="display:flex"><span>  <span style="color:#ff7b72;font-weight:700">-</span><span style="color:#a5d6ff">1</span>     <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">0</span>      <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">2999</span>   <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">89.97</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">3000</span>   <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">90.0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">3001</span>   <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">90.1</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">11999</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">989.9</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">12000</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">990.0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">12001</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">990.2</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">24999</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">3589.8</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">25000</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">3590.0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">25001</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">3590.25</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">34999</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">6089.75</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">35000</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">6090.0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">35001</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">6090.3</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">54999</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">12089.7</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">55000</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">12090</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">55001</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">12090.35</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">79999</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">20839.65</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">80000</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">20840.0</span>
</span></span><span style="display:flex"><span>  <span style="color:#a5d6ff">80001</span>  <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">20840.45</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72;font-weight:700">}</span>
</span></span></code></pre></div><p><img alt="img" loading="lazy" src="./spock.assets/39c39b05b983ca33b760e060c598ec19255399.png"/></p><p><strong>由此可见, 使用spock框架比junit更能节省代码, 但是spock是使用的是Groovy语法, 所以需要学习一下它的语法, 因为Groovy是基于java虚拟机的语言, 所以也能直接写java代码</strong>(不过java语法繁琐, 用java的话和用junit差不多了)</p><h2 id="heading"><a aria-hidden="true" class="anchor" hidden="" href="#heading">#</a></h2><h1 id="2-使用篇">2. 使用篇<a aria-hidden="true" class="anchor" hidden="" href="#2-使用篇">#</a></h1><h2 id="21-引入pom">2.1 引入pom<a aria-hidden="true" class="anchor" hidden="" href="#21-引入pom">#</a></h2><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-xml" data-lang="xml"><span style="display:flex"><span>				<span style="color:#8b949e;font-style:italic">&lt;!--引入 groovy 依赖--&gt;</span>
</span></span><span style="display:flex"><span>		<span style="color:#7ee787">&lt;dependency&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;groupId&gt;</span>org.codehaus.groovy<span style="color:#7ee787">&lt;/groupId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;artifactId&gt;</span>groovy-all<span style="color:#7ee787">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;version&gt;</span>2.4.15<span style="color:#7ee787">&lt;/version&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;scope&gt;</span>test<span style="color:#7ee787">&lt;/scope&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;/dependency&gt;</span>
</span></span><span style="display:flex"><span>				<span style="color:#8b949e;font-style:italic">&lt;!--引入spock 与 spring 集成包--&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;dependency&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;groupId&gt;</span>org.spockframework<span style="color:#7ee787">&lt;/groupId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;artifactId&gt;</span>spock-spring<span style="color:#7ee787">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;version&gt;</span>1.2-groovy-2.4<span style="color:#7ee787">&lt;/version&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;scope&gt;</span>test<span style="color:#7ee787">&lt;/scope&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;/dependency&gt;</span>
</span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">&lt;!-- Spock自带Mock功能，所以我们可以来Mock非静态方法。但是遇到静态方法时，我们需要导入powermock --&gt;</span>
</span></span><span style="display:flex"><span>				<span style="color:#8b949e;font-style:italic">&lt;!--powermock --&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;dependency&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;groupId&gt;</span>org.powermock<span style="color:#7ee787">&lt;/groupId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;artifactId&gt;</span>powermock-api-mockito2<span style="color:#7ee787">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;version&gt;</span>2.0.0<span style="color:#7ee787">&lt;/version&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;scope&gt;</span>test<span style="color:#7ee787">&lt;/scope&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;/dependency&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;dependency&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;groupId&gt;</span>org.powermock<span style="color:#7ee787">&lt;/groupId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;artifactId&gt;</span>powermock-module-junit4<span style="color:#7ee787">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;version&gt;</span>2.0.0<span style="color:#7ee787">&lt;/version&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;scope&gt;</span>test<span style="color:#7ee787">&lt;/scope&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id="22-使用案例">2.2 使用案例<a aria-hidden="true" class="anchor" hidden="" href="#22-使用案例">#</a></h2><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">org.mockito.InjectMocks</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">org.mockito.Matchers</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">org.mockito.Mock</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">org.mockito.MockitoAnnotations</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">org.slf4j.Logger</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">spock.lang.Specification</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">spock.lang.Unroll</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">java.time.LocalDate</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">java.time.LocalDateTime</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">java.time.Month</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">java.time.temporal.ChronoUnit</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">import static</span> <span style="color:#ff7b72">org.mockito.Mockito.when</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:700">QueryDateTest</span> <span style="color:#ff7b72">extends</span> Specification <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>    <span style="color:#d2a8ff;font-weight:700">@Unroll</span><span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">"#testName"</span><span style="color:#ff7b72;font-weight:700">)</span>
</span></span><span style="display:flex"><span>    def <span style="color:#a5d6ff">"测试特定时间tess"</span><span style="color:#ff7b72;font-weight:700">()</span> <span style="color:#ff7b72;font-weight:700">{</span>
</span></span><span style="display:flex"><span>        when<span style="color:#ff7b72;font-weight:700">:</span> <span style="color:#a5d6ff">"执行以及结果验证"</span>
</span></span><span style="display:flex"><span>        def queryDate <span style="color:#ff7b72;font-weight:700">=</span> <span style="color:#ff7b72">new</span> QueryDate<span style="color:#ff7b72;font-weight:700">()</span>
</span></span><span style="display:flex"><span>        queryDate<span style="color:#ff7b72;font-weight:700">.</span>setSpecialDateType<span style="color:#ff7b72;font-weight:700">(</span>sepecial<span style="color:#ff7b72;font-weight:700">)</span>
</span></span><span style="display:flex"><span>  <span style="color:#8b949e;font-style:italic">// 赋值, &lt;&lt; 表示(集合类型)右边赋值给左边   (Groovy语法)     
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">//	    queryDate.getCustomDateTimes() &lt;&lt; [time1, time2]
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic"></span>            
</span></span><span style="display:flex"><span>        then<span style="color:#ff7b72;font-weight:700">:</span>
</span></span><span style="display:flex"><span>        def actual <span style="color:#ff7b72;font-weight:700">=</span> queryDate<span style="color:#ff7b72;font-weight:700">.</span>getCustomDateTimes<span style="color:#ff7b72;font-weight:700">()</span>
</span></span><span style="display:flex"><span>        def collect <span style="color:#ff7b72;font-weight:700">=</span> actual<span style="color:#ff7b72;font-weight:700">.</span>collect <span style="color:#ff7b72;font-weight:700">{</span> arr <span style="color:#ff7b72;font-weight:700">-&gt;</span> <span style="color:#a5d6ff">"[${arr*.toString().join(',')}]"</span> <span style="color:#ff7b72;font-weight:700">}.</span>join<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">','</span><span style="color:#ff7b72;font-weight:700">)</span>
</span></span><span style="display:flex"><span>        rStr <span style="color:#ff7b72;font-weight:700">==</span> collect
</span></span><span style="display:flex"><span><span style="color:#79c0ff;font-weight:700">
</span></span></span><span style="display:flex"><span><span style="color:#79c0ff;font-weight:700">        where:</span> <span style="color:#a5d6ff">"测试用例覆盖"</span>
</span></span><span style="display:flex"><span>        testName                            <span style="color:#ff7b72;font-weight:700">|</span> sepecial         <span style="color:#ff7b72;font-weight:700">||</span> rStr
</span></span><span style="display:flex"><span>        <span style="color:#a5d6ff">"1-分钟粒度-近12小时-最后一天"</span>      <span style="color:#ff7b72;font-weight:700">|</span> Arrays<span style="color:#ff7b72;font-weight:700">.</span>asList<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">5</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">"{2024-01-19T05:00,2024-01-19T17:00}"</span>
</span></span><span style="display:flex"><span>        <span style="color:#a5d6ff">"2-10分钟粒度-近12小时-中间天"</span>      <span style="color:#ff7b72;font-weight:700">|</span> Arrays<span style="color:#ff7b72;font-weight:700">.</span>asList<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">4</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">"{2024-01-18T00:00,2024-01-19T00:00}"</span>
</span></span><span style="display:flex"><span>        <span style="color:#a5d6ff">"3-10分钟粒度-绝对时间-中间天-跨天"</span> <span style="color:#ff7b72;font-weight:700">|</span> Arrays<span style="color:#ff7b72;font-weight:700">.</span>asList<span style="color:#ff7b72;font-weight:700">(</span><span style="color:#a5d6ff">1</span><span style="color:#ff7b72;font-weight:700">)</span> <span style="color:#ff7b72;font-weight:700">||</span> <span style="color:#a5d6ff">"{2024-01-15T00:00,2024-01-16T00:00}"</span>
</span></span><span style="display:flex"><span>    <span style="color:#ff7b72;font-weight:700">}</span>
</span></span><span style="display:flex"><span><span style="color:#ff7b72;font-weight:700">}</span>
</span></span></code></pre></div><p>结果如下:</p><p><img alt="image-20240617194451427" loading="lazy" src="./spock.assets/image-20240617194451427.png"/></p><p>解释:</p><ol><li><p>@Unroll , 可以让where中的每一个案例当成一个单测, 如此可以在输出结果时,分开查看当前用例执行情况 (如果不加, 则合并一起展示)</p></li><li><p><code>#testName</code> 是一个变量, 在where中复制, 表示, 当前用例的名称 (参见输出结果)</p></li><li><p><code>测试特定时间tess</code> 表示这个单测方法的名称 (其实java也允许中文函数名称)</p></li><li><p><code>when</code>, <code>then</code>, <code>where</code> 是spock的关键字</p><ol><li><code>when</code>: 表示当如何时, 可以做一些赋值,定义之类的工作</li><li><code>then</code>: 表示然后如何, 可以做业务逻辑的操作</li><li><code>where</code>: 表示条件如何, 这里就是写大量条件的地方</li></ol><p>当然, 你也可以把 <code>when</code>和<code>then</code>合并, 也可以不要 <code>where</code>, 把输入条件全部写在then中 (这就和juint一样了), 后面再介绍一下还有其他关键字和组合用法</p></li><li><p><code>def</code> 和 <code>collect{}</code> 是 Groovy语法</p></li><li><p><code>where</code> 后面是一个类似表格的东西, 里面就是入参, 第一行是定义变量名, 这里的变量名可以再<code>when</code> 和 <code>then</code>中使用, 多个列使用<code>|</code>单竖线隔开，<code>||</code>双竖线区分输入和输出变量，即左边是输入值，右边是输出值 (其实全部写成 || 也可以)(此处的用法是, 入参和期望结果都是变量形式)</p><p>格式: <code>输入参数1 | 输入参数2 || 输出结果1 | 输出结果2</code></p></li></ol><h2 id="23-分块关键字">2.3 分块(关键字)<a aria-hidden="true" class="anchor" hidden="" href="#23-分块关键字">#</a></h2><table><thead><tr><th><strong>分块</strong></th><th><strong>替换</strong></th><th><strong>功能</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>given</td><td>setup</td><td>初始化函数、MOCK</td><td>非必要</td></tr><tr><td>when</td><td>expect</td><td>执行待测试的函数</td><td>when 和 then 必须成对出现</td></tr><tr><td>then</td><td>expect</td><td>验证函数结果</td><td>when 和 then 可以被 expect 替换</td></tr><tr><td>where</td><td></td><td>多套测试数据的检测</td><td>spock的特性功能</td></tr><tr><td>and</td><td></td><td>对其余块进行分隔说明</td><td>非必要</td></tr></tbody></table><p><a href="https://tech.meituan.com/2021/08/06/spock-practice-in-meituan.html" rel="noopener" target="_blank">Spock单元测试框架介绍以及在美团优选的实践 - 美团技术团队 (meituan.com)</a></p><p><a href="https://blog.csdn.net/u013277209/article/details/120941785" rel="noopener" target="_blank">吃透单元测试：Spock单元测试框架的应用与实践-CSDN博客</a></p><p><a href="https://www.cnblogs.com/qq3245792286/p/15438897.html" rel="noopener" target="_blank">Spock-高质量单元测试实操篇 - My_blog_s - 博客园 (cnblogs.com)</a></p></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xiaokunji.com/zh/tags/%E5%8D%95%E6%B5%8B%E6%A1%86%E6%9E%B6.html">单测框架</a></li><li><a href="https://xiaokunji.com/zh/tags/%E7%BB%BC%E5%90%88.html">综合</a></li></ul><nav class="paginav"><a class="prev" href="https://xiaokunji.com/zh/%E5%89%8D%E7%AB%AF/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html"><span class="title">« 上一页</span><br/><span>前端性能优化——让你的长任务保持在50ms内</span></a>
<a class="next" href="https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/StarRocks/%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%8E%9F%E7%90%86.html"><span class="title">下一页 »</span><br/><span>StartRocks介绍及原理</span></a></nav></footer></article></main><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><footer class="footer"><span>Copyright
©
-2024
<a href="https://xiaokunji.com/zh/" style="color:#939393">米二</a>
All Rights Reserved</span>
<span id="busuanzi_container"><span class="fa fa-user">用户数:</span><span id="busuanzi_value_site_uv"></span>
<span class="fa fa-eye">访问数:</span><span id="busuanzi_value_site_pv"></span></span></footer><a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)"><svg fill="currentcolor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>