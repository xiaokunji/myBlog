<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>analysis | 米二</title><meta name=keywords content=" 1. 什么是analysis?, 2. 主要组成, 3. 使用分析器, 3.1 Elasticsearch的内置分析器, 3.2 分析器测试, 3.3 自定义分析器, 4. 分析器作用位置及使用, 4.1 创建索引时指定分析器, 4.2 搜索时如何确定分析器, 5. 常用分析器, 5.1 繁简转换分析器, 5.1.1 安装与验证, 5.1.2 插件介绍, 5.1.3 简转繁, 5.1.4 繁转简, 5.2 Ik分析器, 5.2.1 安装与验证, 5.2.2 插件介绍, 5.2.3 基本使用, 5.2.4 自定义分词库, 5.3 同义词分析器, 5.4 拼音分析器"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/analysis.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/analysis.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="analysis"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/analysis.html"><meta property="article:section" content="综合"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-04T11:26:13+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="analysis"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":5,"name":"analysis","item":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/analysis.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"analysis","name":"analysis","description":"     ","keywords":[" 1. 什么是analysis?"," 2. 主要组成"," 3. 使用分析器"," 3.1 Elasticsearch的内置分析器"," 3.2 分析器测试"," 3.3 自定义分析器"," 4. 分析器作用位置及使用"," 4.1 创建索引时指定分析器"," 4.2 搜索时如何确定分析器"," 5. 常用分析器"," 5.1 繁简转换分析器"," 5.1.1 安装与验证"," 5.1.2 插件介绍"," 5.1.3 简转繁"," 5.1.4 繁转简"," 5.2 Ik分析器"," 5.2.1 安装与验证"," 5.2.2 插件介绍"," 5.2.3 基本使用"," 5.2.4 自定义分词库"," 5.3 同义词分析器"," 5.4 拼音分析器"],"articleBody":"[toc]\n1. 什么是analysis? analysis是Elasticsearch在文档发送之前对文档正文执行的过程，以添加到反向索引中（inverted index）。 在将文档添加到索引之前，Elasticsearch会为每个分析的字段执行许多步骤：\nCharacter filtering (字符过滤器): 使用字符过滤器转换字符 Breaking text into tokens (把文字转化为标记): 将文本分成一组一个或多个标记 Token filtering：使用标记过滤器转换每个标记(大小写转化/删除无用词等等) Token indexing：把这些标记存于index中 文本分词会发生在两个地方：\n创建索引:当索引文档字符类型为text时，在建立索引时将会对该字段进行分词。 搜索：当对一个text类型的字段进行全文检索时，会对用户输入的文本进行分词。 2. 主要组成 总体说来一个analyzer可以分为如下的几个部分：\n0个或1个以上的character filter\n接收原字符流，通过添加、删除或者替换操作改变原字符流。例如：去除文本中的html标签，或者将罗马数字转换成阿拉伯数字等。一个字符过滤器可以有零个或者多个。\n1个tokenizer\n简单的说就是将一整段文本拆分成一个个的词。例如拆分英文，通过空格能将句子拆分成一个个的词，但是对于中文来说，无法使用这种方式来实现。在一个分词器中,有且只有一个tokenizeer\n0个或1个以上的token filter\n将切分的单词添加、删除或者改变。例如将所有英文单词小写，或者将英文中的停词a删除等。在token filters中，不允许将token(分出的词)的position或者offset改变。同时，在一个分词器中，可以有零个或者多个token filters.\n单词的过滤顺序按照 filter过滤器的顺序\n3. 使用分析器 默认ES使用standard analyzer\n3.1 Elasticsearch的内置分析器 Analyzer\nStandard Analyzer - 默认分词器，按词切分，小写处理 Simple Analyzer - 按照非字母切分(符号被过滤), 小写处理 Stop Analyzer - 小写处理，停用词过滤(the,a,is) Whitespace Analyzer - 按照空格切分，不转小写 Keyword Analyzer - 不分词，直接将输入当作输出 Patter Analyzer - 正则表达式，默认\\W+(非字符分割) Language - 提供了30多种常见语言的分词器 Customer Analyzer 自定义分词器 参考链接 Character Filter\ncharacter filter logical name description mapping char filter mapping 根据配置的映射关系替换字符 html strip char filter html_strip 去掉HTML元素 pattern replace char filter pattern_replace 用正则表达式处理字符串 Tokenizer\ntokenizer logical name description standard tokenizer standard edge ngram tokenizer edgeNGram keyword tokenizer keyword 不分词 letter analyzer letter 按单词分 lowercase analyzer lowercase letter tokenizer, lower case filter ngram analyzers nGram whitespace analyzer whitespace 以空格为分隔符拆分 pattern analyzer pattern 定义分隔符的正则表达式 uax email url analyzer uax_url_email 不拆分 url 和 email path hierarchy analyzer path_hierarchy 处理类似 /path/to/somthing样式的字符串 Token Filter\ntoken filter logical name description standard filter standard ascii folding filter asciifolding length filter length 去掉太长或者太短的 lowercase filter lowercase 转成小写 ngram filter nGram edge ngram filter edgeNGram porter stem filter porterStem 波特词干算法 shingle filter shingle 定义分隔符的正则表达式 stop filter stop 移除 stop words word delimiter filter word_delimiter 将一个单词再拆成子分词 stemmer token filter stemmer stemmer override filter stemmer_override keyword marker filter keyword_marker keyword repeat filter keyword_repeat kstem filter kstem snowball filter snowball phonetic filter phonetic 插件 synonym filter synonyms 处理同义词 compound word filter dictionary_decompounder, hyphenation_decompounder 分解复合词 reverse filter reverse 反转字符串 elision filter elision 去掉缩略语 truncate filter truncate 截断字符串 unique filter unique pattern capture filter pattern_capture pattern replace filte pattern_replace 用正则表达式替换 trim filter trim 去掉空格 limit token count filter limit 限制 token 数量 hunspell filter hunspell 拼写检查 common grams filter common_grams normalization filter arabic_normalization, persian_normalization 内置 Analyzer 一览表 3.2 分析器测试 可以通过_analyzerAPI来测试分词的效果。\nPOST _analyze { \"analyzer\": \"standard\", \"text\": \"The quick Brown Fox\" } 结果: 按空格切分,所以会有四个词\n可以按照下面的规则组合使用：\n0个或者多个character filters 一个tokenizer 0个或者多个token filters POST _analyze { \"tokenizer\": \"standard\", \"filter\": [\"lowercase\"], \"text\": \"The quick Brown Fox\" } 结果: 按空格切分,所以会有四个词,但每个词都是小写\n3.3 自定义分析器 当内置的分词器无法满足需求时，可以创建custom类型的分词器。\ntokenizer:内置或定制的tokenizer.(必须) char_filter:内置或定制的char_filter(非必须) filter:内置或定制的token filter(非必须) position_increment_gap:当值为文本数组时，设置改值会在文本的中间插入假空隙。设置该属性，对与后面的查询会有影响。默认该值为100. PUT my_index { \"settings\": { \"analysis\": { \"analyzer\": { \"my_custom_analyzer\":{ \"type\":\"custom\", \"tokenizer\":\"standard\", \"char_filter\":[\"html_strip\"], \"filter\":[\"lowercase\",\"asciifolding\"] } } } } } 上面的示例中定义了一个名为my_custom_analyzer的分析器，该分析器的type为custom，tokenizer为standard，char_filter为hmtl_strip,filter定义了两个分别为：lowercase和asciifolding.\n测试一下:\nPOST my_index/_analyze { \"text\": \"Is this déjà vu?\", \"analyzer\": \"my_custom_analyzer\" } 结果:\n{ \"tokens\" : [ { \"token\" : \"is\", \"start_offset\" : 0, \"end_offset\" : 2, \"type\" : \"\", \"position\" : 0 }, { \"token\" : \"this\", \"start_offset\" : 3, \"end_offset\" : 7, \"type\" : \"\", \"position\" : 1 }, { \"token\" : \"deja\", \"start_offset\" : 11, \"end_offset\" : 15, \"type\" : \"\", \"position\" : 2 }, { \"token\" : \"vu\", \"start_offset\" : 16, \"end_offset\" : 22, \"type\" : \"\", \"position\" : 3 } ] } 4. 分析器作用位置及使用 分析器的使用地方有两个：\n创建索引时 进行搜索时 4.1 创建索引时指定分析器 如果设置手动设置了分析器，ES将按照下面顺序来确定使用哪个分析器：\n先判断字段是否有设置分析器，如果有，则使用字段属性上的分析器设置 如果设置了analysis.analyzer.default，则使用该设置的分析器 如果上面两个都未设置，则使用默认的standard分析器 为字段指定分析器\nPUT my_index { \"mappings\": { \"properties\": { \"title\":{ \"type\":\"text\", \"analyzer\": \"whitespace\" } } } } 设置索引默认分析器\nPUT my_index { \"settings\": { \"analysis\": { \"analyzer\": { \"default\":{ \"type\":\"simple\" } } } } } 4.2 搜索时如何确定分析器 在搜索时，通过下面参数依次检查搜索时使用的分词器：\n搜索时指定analyzer参数 创建mapping时指定字段的search_analyzer属性 创建索引时指定setting的analysis.analyzer.default_search 查看创建索引时字段指定的analyzer属性 如果上面几种都未设置，则使用默认的standard分词器。 搜索时指定analyzer查询参数\nGET my_index/_search { \"query\": { \"match\": { \"message\": { \"query\": \"Quick foxes\", \"analyzer\": \"stop\" } } } } 指定字段的seach_analyzer\nPUT my_index { \"mappings\": { \"properties\": { \"title\":{ \"type\":\"text\", \"analyzer\": \"whitespace\", \"search_analyzer\": \"simple\" } } } } // 上面指定创建索引时使用的默认分析器为whitespace分词器，而搜索的默认分词器为 simple分词器。 指定索引的默认搜索分词器\nPUT my_index { \"settings\": { \"analysis\": { \"analyzer\": { \"default\":{ \"type\":\"simple\" }, \"default_seach\":{ \"type\":\"whitespace\" } } } } } // 上面指定创建索引时使用的默认分词器为simple分词器，而搜索的默认分词器为whitespace分词器。 5. 常用分析器 5.1 繁简转换分析器 简体和繁体的几个主要情况：\n字形差异，汉字字形本身存在着明显差异，如劉与刘，一般是单个字。\n词汇的差异，习惯、文化环境造成的用法差异，如滑鼠与鼠标，一般是多字词语。\n多种形态共存，有很多代表不同意思的繁体最后简化成了一个字，所以就出现了多音和多义的简体字，如：飆、飈、𩙪都对应于一个简体：飚。\n对应第一种，我们可以采用替换的办法，将所有的繁体都替换成对应的简体，在创建索引的时候，就进行标准化，比较好实现，(此文仅针对第一种)\n第二种我们可以采用收集相应的词汇转换关系，进行替换，不过因为是多字词语的替换，所以这里面还需要提取处理好分词，不然就有可能替换错误反而引起歧义的问题。\n第三种情况，因为繁体和简体是一对多的情况，我们将繁体通过映射表转成简体相对容易，反过来将简体转换成繁体将遇到调整，可能需要结合前后语义来选择正确的繁体。\n5.1.1 安装与验证 Github 上的地址是：https://github.com/medcl/elasticsearch-analysis-stconvert/releases\n下载之后解压到es的安装目录下的plugins 子目录,重启es即可 (必须选择对应版本)\n验证:\n如果你的集群里面有不止一个 Elasticsearch 的节点，你需要在每一台 Elasticsearch 的实例上执行相同的插件安装，并进行重启让其加载生效。\n5.1.2 插件介绍 STConvert 这个插件一共提供了 4 个不同的组件:\n一个名为 stconvert 的 Analyzer，可以将简体转换成繁体 一个名为 stconvert 的 Tokenizer，可以将简体转换成繁体 一个名为 stconvert 的 Token Filter，可以将简体转换成繁体 一个名为 stconvert 的 Char Filter，可以将简体转换成繁体 每个组件都可以有以下3个参数用来进行自定义配置，分别是：\n参数 convert_type 设置转换的方向，默认是 s2t，表示简体到繁体，如果要将繁体转换为简体，则设置为 t2s 参数 keep_both 用于设置是否保留转换之前的内容，一般来说保留原始内容可以提高我们的搜索命中率(也就是说可以同时搜索繁体和简体)，默认是 false，也就是不保留 参数 delimiter 主要是用于，当保留原始内容的时候，如何分割两部分内容，默认的值是逗号 , t: Traditional (传统的) =\u003e Traditional Chinese (繁体)\ns: Simplified (简化的) =\u003e Simplified Chinese (简体)\n5.1.3 简转繁 简转繁好做,因为插件默认就是做这个的\nGET /_analyze { \"tokenizer\" : \"standard\", \"filter\" : [\"lowercase\"], \"char_filter\" : [\"stconvert\"], \"text\" : \"我爱China。\" } 我们指定了 Tokenizer 为 standard，也指定了 lowercase 作为分词之后的 Filter，这样就跟标准的 Standard Analyzer 的分析效果一样了，我们还新增了一个 Char Filter 的参数设置，使用的是我们新安装的简繁体转换插件提供的 stconvert，也就是将简体转成繁体,其结果如下\n{ \"tokens\": [ { \"token\": \"我\", \"start_offset\": 0, \"end_offset\": 1, \"type\": \"\", \"position\": 0 }, { \"token\": \"愛\", \"start_offset\": 1, \"end_offset\": 2, \"type\": \"\", \"position\": 1 }, { \"token\": \"china\", \"start_offset\": 2, \"end_offset\": 7, \"type\": \"\", \"position\": 2 } ] } 可以看到，除了和 Standard 分词效果一样的地方以外，我们还额外的将中文字符都转成了繁体，爱 字转成了 愛，而 我 没有变化，是因为它的繁体也是 我。建议我们在真正动手进行自定义分词之前，通过这样的方式先进行分词效果的测试，得到满意的结果之后再进行具体的自定义 Analyzer 的创建工作。\n5.1.4 繁转简 创建索引时指定分析器\nPUT /my_index { \"settings\": { \"analysis\": { \"analyzer\": { \"my_analyzer\": { \"tokenizer\": \"standard\", \"filter\": [\"lowercase\"], \"char_filter\": [\"tsconvert\"] } }, \"char_filter\": { \"tsconvert\" : { \"type\" : \"stconvert\", \"delimiter\" : \"#\", \"keep_both\" : false, \"convert_type\" : \"t2s\" } } } } } // delimiter 和 keep_both 属性可以不写 测试:\nPOST /my_index/_analyze { \"analyzer\": \"my_analyzer\", \"text\": \"我愛China。\" } 经过执行，得到的分析结果如下：\n{ \"tokens\": [ { \"token\": \"我\", \"start_offset\": 0, \"end_offset\": 1, \"type\": \"\", \"position\": 0 }, { \"token\": \"爱\", \"start_offset\": 1, \"end_offset\": 2, \"type\": \"\", \"position\": 1 }, { \"token\": \"china\", \"start_offset\": 2, \"end_offset\": 7, \"type\": \"\", \"position\": 2 } ] } 5.2 Ik分析器 IK分析插件将Lucene IK分析器（http://code.google.com/p/ik-analyzer/）集成到elasticsearch中，支持自定义字典。\n5.2.1 安装与验证 Github 上的地址是：https://github.com/medcl/elasticsearch-analysis-ik/releases\n下载之后解压到es的安装目录下的plugins 子目录,重启es即可 (必须选择对应版本)\n5.2.2 插件介绍 Analyzer: ik_smart , ik_max_word , Tokenizer: ik_smart , ik_max_word ik_max_word 和 ik_smart 什么区别?\nik_max_word: 会将文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合，适合 Term Query；\nik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”，适合 Phrase 查询。\n5.2.3 基本使用 使用analyzer:\n使用tokenizer\nPUT product { \"settings\": { \"analysis\": { \"analyzer\": { \"my_analyzer\": { \"type\": \"custom\", \"filter\": [ \"lowercase\" ], \"tokenizer\": \"ik_smart\" } } } } } 5.2.4 自定义分词库 配置 在ik分析器的config目录下的 IKAnalyzer.cfg.xml\n内容如下:\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE properties SYSTEM \"http://java.sun.com/dtd/properties.dtd\"\u003e IK Analyzer 扩展配置 ","wordCount":"5517","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-04T11:26:13.667236661Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/analysis.html"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="米二 (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>米二</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://xiaokunji.com/zh/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=📚文章><span>📚文章</span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=🔖标签><span>🔖标签</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=📖分类><span>📖分类</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>🏠</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88.html>综合</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK.html>ELK</a> <span>></span>
<a href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch.html>ElasticSearch</a> <span>></span></ul></nav><h1 class=post-title>analysis</h1><div class=post-description></div><div class=post-meta>创建:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;·&nbsp;更新:&nbsp;2023-09-04&nbsp;·&nbsp;xkj
&nbsp;|&nbsp;分类: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/%E7%BB%BC%E5%90%88.html>综合</a></ul><span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv>1</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#1-%e4%bb%80%e4%b9%88%e6%98%afanalysis aria-label="1. 什么是analysis?">1. 什么是analysis?</a></li><li><a href=#2-%e4%b8%bb%e8%a6%81%e7%bb%84%e6%88%90 aria-label="2. 主要组成">2. 主要组成</a></li><li><a href=#3-%e4%bd%bf%e7%94%a8%e5%88%86%e6%9e%90%e5%99%a8 aria-label="3. 使用分析器">3. 使用分析器</a><ul><li><a href=#31-elasticsearch%e7%9a%84%e5%86%85%e7%bd%ae%e5%88%86%e6%9e%90%e5%99%a8 aria-label="3.1 Elasticsearch的内置分析器">3.1 Elasticsearch的内置分析器</a></li><li><a href=#32-%e5%88%86%e6%9e%90%e5%99%a8%e6%b5%8b%e8%af%95 aria-label="3.2 分析器测试">3.2 分析器测试</a></li><li><a href=#33-%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%86%e6%9e%90%e5%99%a8 aria-label="3.3 自定义分析器">3.3 自定义分析器</a></li></ul></li><li><a href=#4-%e5%88%86%e6%9e%90%e5%99%a8%e4%bd%9c%e7%94%a8%e4%bd%8d%e7%bd%ae%e5%8f%8a%e4%bd%bf%e7%94%a8 aria-label="4. 分析器作用位置及使用">4. 分析器作用位置及使用</a><ul><li><a href=#41-%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95%e6%97%b6%e6%8c%87%e5%ae%9a%e5%88%86%e6%9e%90%e5%99%a8 aria-label="4.1 创建索引时指定分析器">4.1 创建索引时指定分析器</a></li><li><a href=#42-%e6%90%9c%e7%b4%a2%e6%97%b6%e5%a6%82%e4%bd%95%e7%a1%ae%e5%ae%9a%e5%88%86%e6%9e%90%e5%99%a8 aria-label="4.2 搜索时如何确定分析器">4.2 搜索时如何确定分析器</a></li></ul></li><li><a href=#5-%e5%b8%b8%e7%94%a8%e5%88%86%e6%9e%90%e5%99%a8 aria-label="5. 常用分析器">5. 常用分析器</a><ul><li><a href=#51-%e7%b9%81%e7%ae%80%e8%bd%ac%e6%8d%a2%e5%88%86%e6%9e%90%e5%99%a8 aria-label="5.1 繁简转换分析器">5.1 繁简转换分析器</a><ul><li><a href=#511-%e5%ae%89%e8%a3%85%e4%b8%8e%e9%aa%8c%e8%af%81 aria-label="5.1.1 安装与验证">5.1.1 安装与验证</a></li><li><a href=#512-%e6%8f%92%e4%bb%b6%e4%bb%8b%e7%bb%8d aria-label="5.1.2 插件介绍">5.1.2 插件介绍</a></li><li><a href=#513-%e7%ae%80%e8%bd%ac%e7%b9%81 aria-label="5.1.3 简转繁">5.1.3 简转繁</a></li><li><a href=#514-%e7%b9%81%e8%bd%ac%e7%ae%80 aria-label="5.1.4 繁转简">5.1.4 繁转简</a></li></ul></li><li><a href=#52-ik%e5%88%86%e6%9e%90%e5%99%a8 aria-label="5.2 Ik分析器">5.2 Ik分析器</a><ul><li><a href=#521-%e5%ae%89%e8%a3%85%e4%b8%8e%e9%aa%8c%e8%af%81 aria-label="5.2.1 安装与验证">5.2.1 安装与验证</a></li><li><a href=#522-%e6%8f%92%e4%bb%b6%e4%bb%8b%e7%bb%8d aria-label="5.2.2 插件介绍">5.2.2 插件介绍</a></li><li><a href=#523-%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 aria-label="5.2.3 基本使用">5.2.3 基本使用</a></li><li><a href=#524-%e8%87%aa%e5%ae%9a%e4%b9%89%e5%88%86%e8%af%8d%e5%ba%93 aria-label="5.2.4 自定义分词库">5.2.4 自定义分词库</a></li></ul></li><li><a href=#53-%e5%90%8c%e4%b9%89%e8%af%8d%e5%88%86%e6%9e%90%e5%99%a8 aria-label="5.3 同义词分析器">5.3 同义词分析器</a></li><li><a href=#54-%e6%8b%bc%e9%9f%b3%e5%88%86%e6%9e%90%e5%99%a8 aria-label="5.4 拼音分析器">5.4 拼音分析器</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1-什么是analysis>1. 什么是analysis?<a hidden class=anchor aria-hidden=true href=#1-什么是analysis>#</a></h1><p>analysis是Elasticsearch在文档发送之前对文档正文执行的过程，以添加到反向索引中（inverted index）。 在将文档添加到索引之前，Elasticsearch会为每个分析的字段执行许多步骤：</p><ul><li>Character filtering (字符过滤器): 使用字符过滤器转换字符</li><li>Breaking text into tokens (把文字转化为标记): 将文本分成一组一个或多个标记</li><li>Token filtering：使用标记过滤器转换每个标记(大小写转化/删除无用词等等)</li><li>Token indexing：把这些标记存于index中</li></ul><p>文本分词会发生在两个地方：</p><ul><li><code>创建索引</code>:当索引文档字符类型为<code>text</code>时，在建立索引时将会对该字段进行分词。</li><li><code>搜索</code>：当对一个<code>text</code>类型的字段进行全文检索时，会对用户输入的文本进行分词。</li></ul><h1 id=2-主要组成>2. 主要组成<a hidden class=anchor aria-hidden=true href=#2-主要组成>#</a></h1><p>总体说来一个analyzer可以分为如下的几个部分：</p><ul><li><p>0个或1个以上的character filter</p><blockquote><p>接收原字符流，通过添加、删除或者替换操作改变原字符流。例如：去除文本中的html标签，或者将罗马数字转换成阿拉伯数字等。一个字符过滤器可以有零个或者多个。</p></blockquote></li><li><p>1个tokenizer</p><blockquote><p>简单的说就是将一整段文本拆分成一个个的词。例如拆分英文，通过空格能将句子拆分成一个个的词，但是对于中文来说，无法使用这种方式来实现。在一个分词器中,有且只有一个tokenizeer</p></blockquote></li><li><p>0个或1个以上的token filter</p><blockquote><p>将切分的单词添加、删除或者改变。例如将所有英文单词小写，或者将英文中的停词a删除等。在token filters中，不允许将token(分出的词)的position或者offset改变。同时，在一个分词器中，可以有零个或者多个token filters.</p><p><u>单词的过滤顺序按照 filter过滤器的顺序</u></p></blockquote></li></ul><p><img loading=lazy src="https://img-blog.csdnimg.cn/20190923230030142.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1VidW50dVRvdWNo,size_16,color_FFFFFF,t_70" alt=img></p><h1 id=3-使用分析器>3. 使用分析器<a hidden class=anchor aria-hidden=true href=#3-使用分析器>#</a></h1><p>默认ES使用<code>standard analyzer</code></p><h2 id=31-elasticsearch的内置分析器>3.1 Elasticsearch的内置分析器<a hidden class=anchor aria-hidden=true href=#31-elasticsearch的内置分析器>#</a></h2><p><strong>Analyzer</strong></p><ul><li>Standard Analyzer - 默认分词器，按词切分，小写处理</li><li>Simple Analyzer - 按照非字母切分(符号被过滤), 小写处理</li><li>Stop Analyzer - 小写处理，停用词过滤(the,a,is)</li><li>Whitespace Analyzer - 按照空格切分，不转小写</li><li>Keyword Analyzer - 不分词，直接将输入当作输出</li><li>Patter Analyzer - 正则表达式，默认\W+(非字符分割)</li><li>Language - 提供了30多种常见语言的分词器</li><li>Customer Analyzer 自定义分词器</li></ul><p><a href=https://www.cnblogs.com/qdhxhz/p/11585639.html target=_blank rel=noopener>参考链接</a></p><p><strong>Character Filter</strong></p><table><thead><tr><th>character filter</th><th style=text-align:center>logical name</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td>mapping char filter</td><td style=text-align:center>mapping</td><td style=text-align:left>根据配置的映射关系替换字符</td></tr><tr><td>html strip char filter</td><td style=text-align:center>html_strip</td><td style=text-align:left>去掉HTML元素</td></tr><tr><td>pattern replace char filter</td><td style=text-align:center>pattern_replace</td><td style=text-align:left>用正则表达式处理字符串</td></tr></tbody></table><p><strong>Tokenizer</strong></p><table><thead><tr><th>tokenizer</th><th style=text-align:center>logical name</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td>standard tokenizer</td><td style=text-align:center>standard</td><td style=text-align:left></td></tr><tr><td>edge ngram tokenizer</td><td style=text-align:center>edgeNGram</td><td style=text-align:left></td></tr><tr><td>keyword tokenizer</td><td style=text-align:center>keyword</td><td style=text-align:left>不分词</td></tr><tr><td>letter analyzer</td><td style=text-align:center>letter</td><td style=text-align:left>按单词分</td></tr><tr><td>lowercase analyzer</td><td style=text-align:center>lowercase</td><td style=text-align:left>letter tokenizer, lower case filter</td></tr><tr><td>ngram analyzers</td><td style=text-align:center>nGram</td><td style=text-align:left></td></tr><tr><td>whitespace analyzer</td><td style=text-align:center>whitespace</td><td style=text-align:left>以空格为分隔符拆分</td></tr><tr><td>pattern analyzer</td><td style=text-align:center>pattern</td><td style=text-align:left>定义分隔符的正则表达式</td></tr><tr><td>uax email url analyzer</td><td style=text-align:center>uax_url_email</td><td style=text-align:left>不拆分 url 和 email</td></tr><tr><td>path hierarchy analyzer</td><td style=text-align:center>path_hierarchy</td><td style=text-align:left>处理类似 <code>/path/to/somthing</code>样式的字符串</td></tr></tbody></table><p>Token Filter</p><table><thead><tr><th>token filter</th><th style=text-align:center>logical name</th><th style=text-align:left>description</th></tr></thead><tbody><tr><td>standard filter</td><td style=text-align:center>standard</td><td style=text-align:left></td></tr><tr><td>ascii folding filter</td><td style=text-align:center>asciifolding</td><td style=text-align:left></td></tr><tr><td>length filter</td><td style=text-align:center>length</td><td style=text-align:left>去掉太长或者太短的</td></tr><tr><td>lowercase filter</td><td style=text-align:center>lowercase</td><td style=text-align:left>转成小写</td></tr><tr><td>ngram filter</td><td style=text-align:center>nGram</td><td style=text-align:left></td></tr><tr><td>edge ngram filter</td><td style=text-align:center>edgeNGram</td><td style=text-align:left></td></tr><tr><td>porter stem filter</td><td style=text-align:center>porterStem</td><td style=text-align:left>波特词干算法</td></tr><tr><td>shingle filter</td><td style=text-align:center>shingle</td><td style=text-align:left>定义分隔符的正则表达式</td></tr><tr><td>stop filter</td><td style=text-align:center>stop</td><td style=text-align:left>移除 stop words</td></tr><tr><td>word delimiter filter</td><td style=text-align:center>word_delimiter</td><td style=text-align:left>将一个单词再拆成子分词</td></tr><tr><td>stemmer token filter</td><td style=text-align:center>stemmer</td><td style=text-align:left></td></tr><tr><td>stemmer override filter</td><td style=text-align:center>stemmer_override</td><td style=text-align:left></td></tr><tr><td>keyword marker filter</td><td style=text-align:center>keyword_marker</td><td style=text-align:left></td></tr><tr><td>keyword repeat filter</td><td style=text-align:center>keyword_repeat</td><td style=text-align:left></td></tr><tr><td>kstem filter</td><td style=text-align:center>kstem</td><td style=text-align:left></td></tr><tr><td>snowball filter</td><td style=text-align:center>snowball</td><td style=text-align:left></td></tr><tr><td>phonetic filter</td><td style=text-align:center>phonetic</td><td style=text-align:left><a href="https://link.jianshu.com?t=https://github.com/elasticsearch/elasticsearch-analysis-phonetic" target=_blank rel=noopener>插件</a></td></tr><tr><td>synonym filter</td><td style=text-align:center>synonyms</td><td style=text-align:left>处理同义词</td></tr><tr><td>compound word filter</td><td style=text-align:center>dictionary_decompounder, hyphenation_decompounder</td><td style=text-align:left>分解复合词</td></tr><tr><td>reverse filter</td><td style=text-align:center>reverse</td><td style=text-align:left>反转字符串</td></tr><tr><td>elision filter</td><td style=text-align:center>elision</td><td style=text-align:left>去掉缩略语</td></tr><tr><td>truncate filter</td><td style=text-align:center>truncate</td><td style=text-align:left>截断字符串</td></tr><tr><td>unique filter</td><td style=text-align:center>unique</td><td style=text-align:left></td></tr><tr><td>pattern capture filter</td><td style=text-align:center>pattern_capture</td><td style=text-align:left></td></tr><tr><td>pattern replace filte</td><td style=text-align:center>pattern_replace</td><td style=text-align:left>用正则表达式替换</td></tr><tr><td>trim filter</td><td style=text-align:center>trim</td><td style=text-align:left>去掉空格</td></tr><tr><td>limit token count filter</td><td style=text-align:center>limit</td><td style=text-align:left>限制 token 数量</td></tr><tr><td>hunspell filter</td><td style=text-align:center>hunspell</td><td style=text-align:left>拼写检查</td></tr><tr><td>common grams filter</td><td style=text-align:center>common_grams</td><td style=text-align:left></td></tr><tr><td>normalization filter</td><td style=text-align:center>arabic_normalization, persian_normalization</td><td style=text-align:left></td></tr></tbody></table><p><a href=https://www.jianshu.com/p/edbef5c9d635 target=_blank rel=noopener>内置 Analyzer 一览表</a></p><h2 id=32-分析器测试>3.2 分析器测试<a hidden class=anchor aria-hidden=true href=#32-分析器测试>#</a></h2><p>可以通过<code>_analyzer</code>API来测试分词的效果。</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>POST _analyze
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;analyzer&#34;: &#34;standard&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;text&#34;: &#34;The quick Brown Fox&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><blockquote><p><strong>结果</strong>: 按空格切分,所以会有四个词</p></blockquote><p>可以按照下面的规则组合使用：</p><ul><li>0个或者多个<code>character filters</code></li><li>一个<code>tokenizer</code></li><li>0个或者多个<code>token filters</code></li></ul><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>POST _analyze
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;tokenizer&#34;: &#34;standard&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;filter&#34;: [&#34;lowercase&#34;],
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;text&#34;: &#34;The quick Brown Fox&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><blockquote><p><strong>结果</strong>: 按空格切分,所以会有四个词,但每个词都是小写</p></blockquote><h2 id=33-自定义分析器>3.3 自定义分析器<a hidden class=anchor aria-hidden=true href=#33-自定义分析器>#</a></h2><p>当内置的分词器无法满足需求时，可以创建<code>custom</code>类型的分词器。</p><ul><li><code>tokenizer</code>:内置或定制的tokenizer.(必须)</li><li><code>char_filter</code>:内置或定制的char_filter(非必须)</li><li><code>filter</code>:内置或定制的token filter(非必须)</li><li><code>position_increment_gap</code>:当值为文本数组时，设置改值会在文本的中间插入假空隙。设置该属性，对与后面的查询会有影响。默认该值为100.</li></ul><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT my_index
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;analysis&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;my_custom_analyzer&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;type&#34;:&#34;custom&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;tokenizer&#34;:&#34;standard&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;char_filter&#34;:[&#34;html_strip&#34;],
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;filter&#34;:[&#34;lowercase&#34;,&#34;asciifolding&#34;]
</span></span></span><span style=display:flex><span><span style=color:#f85149>        }
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><p>上面的示例中定义了一个名为<code>my_custom_analyzer</code>的分析器，该分析器的<code>type</code>为<code>custom</code>，<code>tokenizer</code>为<code>standard</code>，<code>char_filter</code>为<code>hmtl_strip</code>,<code>filter</code>定义了两个分别为：<code>lowercase</code>和<code>asciifolding</code>.</p><p>测试一下:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>POST my_index/_analyze
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;text&#34;: &#34;Is this &lt;b&gt;déjà vu&lt;/b&gt;?&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;analyzer&#34;: &#34;my_custom_analyzer&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><p>结果:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;tokens&#34;</span> : [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span> : <span style=color:#a5d6ff>&#34;is&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span> : <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span> : <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span> : <span style=color:#a5d6ff>&#34;&lt;ALPHANUM&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span> : <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span> : <span style=color:#a5d6ff>&#34;this&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span> : <span style=color:#a5d6ff>3</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span> : <span style=color:#a5d6ff>7</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span> : <span style=color:#a5d6ff>&#34;&lt;ALPHANUM&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span> : <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span> : <span style=color:#a5d6ff>&#34;deja&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span> : <span style=color:#a5d6ff>11</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span> : <span style=color:#a5d6ff>15</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span> : <span style=color:#a5d6ff>&#34;&lt;ALPHANUM&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span> : <span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span> : <span style=color:#a5d6ff>&#34;vu&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span> : <span style=color:#a5d6ff>16</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span> : <span style=color:#a5d6ff>22</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span> : <span style=color:#a5d6ff>&#34;&lt;ALPHANUM&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span> : <span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=4-分析器作用位置及使用>4. 分析器作用位置及使用<a hidden class=anchor aria-hidden=true href=#4-分析器作用位置及使用>#</a></h1><p>分析器的使用地方有两个：</p><ul><li>创建索引时</li><li>进行搜索时</li></ul><h2 id=41-创建索引时指定分析器>4.1 创建索引时指定分析器<a hidden class=anchor aria-hidden=true href=#41-创建索引时指定分析器>#</a></h2><p>如果设置手动设置了分析器，ES将按照下面顺序来确定使用哪个分析器：</p><ul><li>先判断字段是否有设置分析器，如果有，则使用字段属性上的分析器设置</li><li>如果设置了<code>analysis.analyzer.default</code>，则使用该设置的分析器</li><li>如果上面两个都未设置，则使用默认的<code>standard</code>分析器</li></ul><p>为字段指定分析器</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT my_index
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;mappings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;properties&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;title&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;type&#34;:&#34;text&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;analyzer&#34;: &#34;whitespace&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><p>设置索引默认分析器</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT my_index
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;analysis&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;default&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;type&#34;:&#34;simple&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>        }
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><h2 id=42-搜索时如何确定分析器>4.2 搜索时如何确定分析器<a hidden class=anchor aria-hidden=true href=#42-搜索时如何确定分析器>#</a></h2><p>在搜索时，通过下面参数依次检查搜索时使用的分词器：</p><ul><li>搜索时指定analyzer参数</li><li>创建mapping时指定字段的search_analyzer属性</li><li>创建索引时指定<code>setting</code>的<code>analysis.analyzer.default_search</code></li><li>查看创建索引时字段指定的analyzer属性</li><li>如果上面几种都未设置，则使用默认的standard分词器。</li></ul><p>搜索时指定analyzer查询参数</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>GET my_index/_search
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;message&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;query&#34;: &#34;Quick foxes&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;analyzer&#34;: &#34;stop&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><p>指定字段的<code>seach_analyzer</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT my_index
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;mappings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;properties&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;title&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;type&#34;:&#34;text&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;analyzer&#34;: &#34;whitespace&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;search_analyzer&#34;: &#34;simple&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span><span style=display:flex><span><span style=color:#f85149>//  上面指定创建索引时使用的默认分析器为whitespace分词器，而搜索的默认分词器为 simple分词器。
</span></span></span></code></pre></div><p>指定索引的默认搜索分词器</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT my_index
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;analysis&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;default&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;type&#34;:&#34;simple&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>        },
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;default_seach&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;type&#34;:&#34;whitespace&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>        }
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span><span style=display:flex><span><span style=color:#f85149>// 上面指定创建索引时使用的默认分词器为simple分词器，而搜索的默认分词器为whitespace分词器。
</span></span></span></code></pre></div><h1 id=5-常用分析器>5. 常用分析器<a hidden class=anchor aria-hidden=true href=#5-常用分析器>#</a></h1><h2 id=51-繁简转换分析器>5.1 繁简转换分析器<a hidden class=anchor aria-hidden=true href=#51-繁简转换分析器>#</a></h2><p>简体和繁体的几个主要情况：</p><ul><li><p>字形差异，汉字字形本身存在着明显差异，如劉与刘，一般是单个字。</p></li><li><p>词汇的差异，习惯、文化环境造成的用法差异，如滑鼠与鼠标，一般是多字词语。</p></li><li><p>多种形态共存，有很多代表不同意思的繁体最后简化成了一个字，所以就出现了多音和多义的简体字，如：飆、飈、𩙪都对应于一个简体：飚。</p></li></ul><p>对应第一种，我们可以采用替换的办法，将所有的繁体都替换成对应的简体，在创建索引的时候，就进行标准化，比较好实现，(此文仅针对第一种)</p><p>第二种我们可以采用收集相应的词汇转换关系，进行替换，不过因为是多字词语的替换，所以这里面还需要提取处理好分词，不然就有可能替换错误反而引起歧义的问题。</p><p>第三种情况，因为繁体和简体是一对多的情况，我们将繁体通过映射表转成简体相对容易，反过来将简体转换成繁体将遇到调整，可能需要结合前后语义来选择正确的繁体。</p><h3 id=511-安装与验证>5.1.1 安装与验证<a hidden class=anchor aria-hidden=true href=#511-安装与验证>#</a></h3><p><code>Github</code> 上的地址是：https://github.com/medcl/elasticsearch-analysis-stconvert/releases</p><p><u>下载之后解压到es的安装目录下的plugins 子目录,重启es即可</u> (必须选择对应版本)</p><p>验证:</p><p><img loading=lazy src=https://elastic-search-in-action.medcl.com/media/15501507055384/15509999877512.jpg alt=image></p><blockquote><p>如果你的集群里面有不止一个 Elasticsearch 的节点，你需要在每一台 Elasticsearch 的实例上执行相同的插件安装，并进行重启让其加载生效。</p></blockquote><h3 id=512-插件介绍>5.1.2 插件介绍<a hidden class=anchor aria-hidden=true href=#512-插件介绍>#</a></h3><p>STConvert 这个插件一共提供了 4 个不同的组件:</p><ul><li>一个名为 <code>stconvert</code> 的 Analyzer，可以将简体转换成繁体</li><li>一个名为 <code>stconvert</code> 的 Tokenizer，可以将简体转换成繁体</li><li>一个名为 <code>stconvert</code> 的 Token Filter，可以将简体转换成繁体</li><li>一个名为 <code>stconvert</code> 的 Char Filter，可以将简体转换成繁体</li></ul><p>每个组件都可以有以下3个参数用来进行自定义配置，分别是：</p><ul><li>参数 <code>convert_type</code> 设置转换的方向，默认是 <code>s2t</code>，表示简体到繁体，如果要将繁体转换为简体，则设置为 <code>t2s</code></li><li>参数 <code>keep_both</code> 用于设置是否保留转换之前的内容，一般来说保留原始内容可以提高我们的搜索命中率(也就是说可以同时搜索繁体和简体)，默认是 <code>false</code>，也就是不保留</li><li>参数 <code>delimiter</code> 主要是用于，当保留原始内容的时候，如何分割两部分内容，默认的值是逗号 <code>,</code></li></ul><blockquote><p>t: Traditional (传统的) => Traditional Chinese (繁体)</p><p>s: Simplified (简化的) => Simplified Chinese (简体)</p></blockquote><h3 id=513-简转繁>5.1.3 简转繁<a hidden class=anchor aria-hidden=true href=#513-简转繁>#</a></h3><p>简转繁好做,因为插件默认就是做这个的</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>GET /_analyze
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;tokenizer&#34; : &#34;standard&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;filter&#34; : [&#34;lowercase&#34;],
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;char_filter&#34; : [&#34;stconvert&#34;],
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;text&#34; : &#34;我爱China。&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><blockquote><p>我们指定了 Tokenizer 为 <code>standard</code>，也指定了 <code>lowercase</code> 作为分词之后的 Filter，这样就跟标准的 Standard Analyzer 的分析效果一样了，我们还新增了一个 Char Filter 的参数设置，使用的是我们新安装的简繁体转换插件提供的 <code>stconvert</code>，也就是将简体转成繁体,其结果如下</p></blockquote><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;tokens&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span>: <span style=color:#a5d6ff>&#34;我&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span>: <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span>: <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;&lt;IDEOGRAPHIC&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span>: <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span>: <span style=color:#a5d6ff>&#34;愛&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span>: <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span>: <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;&lt;IDEOGRAPHIC&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span>: <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span>: <span style=color:#a5d6ff>&#34;china&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span>: <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span>: <span style=color:#a5d6ff>7</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;&lt;ALPHANUM&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span>: <span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>可以看到，除了和 Standard 分词效果一样的地方以外，我们还额外的将中文字符都转成了繁体，<code>爱</code> 字转成了 <code>愛</code>，而 <code>我</code> 没有变化，是因为它的繁体也是 <code>我</code>。建议我们在真正动手进行自定义分词之前，通过这样的方式先进行分词效果的测试，得到满意的结果之后再进行具体的自定义 Analyzer 的创建工作。</p></blockquote><h3 id=514-繁转简>5.1.4 繁转简<a hidden class=anchor aria-hidden=true href=#514-繁转简>#</a></h3><p>创建索引时指定分析器</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT /my_index
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;analysis&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;my_analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;tokenizer&#34;: &#34;standard&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;filter&#34;: [&#34;lowercase&#34;],
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;char_filter&#34;: [&#34;tsconvert&#34;]
</span></span></span><span style=display:flex><span><span style=color:#f85149>        }
</span></span></span><span style=display:flex><span><span style=color:#f85149>      },
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;char_filter&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;tsconvert&#34; : {
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;type&#34; : &#34;stconvert&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;delimiter&#34; : &#34;#&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;keep_both&#34; : false,
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;convert_type&#34; : &#34;t2s&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>        }
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span><span style=display:flex><span><span style=color:#f85149>// delimiter 和 keep_both 属性可以不写
</span></span></span></code></pre></div><p>测试:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>POST /my_index/_analyze
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>	&#34;analyzer&#34;: &#34;my_analyzer&#34;,
</span></span></span><span style=display:flex><span><span style=color:#f85149>	&#34;text&#34;: &#34;我愛China。&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>}
</span></span></span></code></pre></div><p>经过执行，得到的分析结果如下：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;tokens&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span>: <span style=color:#a5d6ff>&#34;我&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span>: <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span>: <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;&lt;IDEOGRAPHIC&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span>: <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span>: <span style=color:#a5d6ff>&#34;爱&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span>: <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span>: <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;&lt;IDEOGRAPHIC&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span>: <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;token&#34;</span>: <span style=color:#a5d6ff>&#34;china&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;start_offset&#34;</span>: <span style=color:#a5d6ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;end_offset&#34;</span>: <span style=color:#a5d6ff>7</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;&lt;ALPHANUM&gt;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#7ee787>&#34;position&#34;</span>: <span style=color:#a5d6ff>2</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=52-ik分析器>5.2 Ik分析器<a hidden class=anchor aria-hidden=true href=#52-ik分析器>#</a></h2><p>IK分析插件将Lucene IK分析器（http://code.google.com/p/ik-analyzer/）集成到elasticsearch中，支持自定义字典。</p><h3 id=521-安装与验证>5.2.1 安装与验证<a hidden class=anchor aria-hidden=true href=#521-安装与验证>#</a></h3><p><code>Github</code> 上的地址是：https://github.com/medcl/elasticsearch-analysis-ik/releases</p><p><u>下载之后解压到es的安装目录下的plugins 子目录,重启es即可</u> (必须选择对应版本)</p><h3 id=522-插件介绍>5.2.2 插件介绍<a hidden class=anchor aria-hidden=true href=#522-插件介绍>#</a></h3><ul><li>Analyzer: <code>ik_smart</code> , <code>ik_max_word</code> ,</li><li>Tokenizer: <code>ik_smart</code> , <code>ik_max_word</code></li></ul><blockquote><p><code>ik_max_word</code> 和 <code>ik_smart</code> 什么区别?</p><p><code>ik_max_word</code>: <u>会将文本做最细粒度的拆分</u>，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合，适合 Term Query；</p><p><code>ik_smart</code>: <u>会做最粗粒度的拆分</u>，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”，适合 Phrase 查询。</p></blockquote><h3 id=523-基本使用>5.2.3 基本使用<a hidden class=anchor aria-hidden=true href=#523-基本使用>#</a></h3><p><strong>使用analyzer</strong>:</p><p><img loading=lazy src=https://img-blog.csdnimg.cn/2020072414541039.png alt=image></p><p><img loading=lazy src=https://img-blog.csdnimg.cn/20200724145528317.png alt=image></p><p><strong>使用tokenizer</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#f85149>PUT product
</span></span></span><span style=display:flex><span><span style=color:#f85149>{
</span></span></span><span style=display:flex><span><span style=color:#f85149>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>    &#34;analysis&#34;: {   
</span></span></span><span style=display:flex><span><span style=color:#f85149>      &#34;analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>        &#34;my_analyzer&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;type&#34;: &#34;custom&#34;,       
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;filter&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#f85149>            &#34;lowercase&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>          ],
</span></span></span><span style=display:flex><span><span style=color:#f85149>          &#34;tokenizer&#34;: &#34;ik_smart&#34;
</span></span></span><span style=display:flex><span><span style=color:#f85149>        }
</span></span></span><span style=display:flex><span><span style=color:#f85149>      }
</span></span></span><span style=display:flex><span><span style=color:#f85149>    }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span><span style=display:flex><span><span style=color:#f85149>  }
</span></span></span></code></pre></div><h3 id=524-自定义分词库>5.2.4 自定义分词库<a hidden class=anchor aria-hidden=true href=#524-自定义分词库>#</a></h3><p>配置 在ik分析器的config目录下的 <code>IKAnalyzer.cfg.xml</code></p><p>内容如下:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8b949e;font-weight:700;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-weight:700;font-style:italic>&lt;!DOCTYPE properties SYSTEM &#34;http://java.sun.com/dtd/properties.dtd&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&lt;comment&gt;</span>IK Analyzer 扩展配置<span style=color:#7ee787>&lt;/comment&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#8b949e;font-style:italic>&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&lt;entry</span> key=<span style=color:#a5d6ff>&#34;ext_dict&#34;</span><span style=color:#7ee787>&gt;</span>custom/mydict.dic;custom/single_word_low_freq.dic<span style=color:#7ee787>&lt;/entry&gt;</span>
</span></span><span style=display:flex><span>	 <span style=color:#8b949e;font-style:italic>&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&lt;entry</span> key=<span style=color:#a5d6ff>&#34;ext_stopwords&#34;</span><span style=color:#7ee787>&gt;</span>custom/ext_stopword.dic<span style=color:#7ee787>&lt;/entry&gt;</span>
</span></span><span style=display:flex><span> 	<span style=color:#8b949e;font-style:italic>&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&lt;entry</span> key=<span style=color:#a5d6ff>&#34;remote_ext_dict&#34;</span><span style=color:#7ee787>&gt;</span>location<span style=color:#7ee787>&lt;/entry&gt;</span>
</span></span><span style=display:flex><span> 	<span style=color:#8b949e;font-style:italic>&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#7ee787>&lt;entry</span> key=<span style=color:#a5d6ff>&#34;remote_ext_stopwords&#34;</span><span style=color:#7ee787>&gt;</span>http://xxx.com/xxx.dic<span style=color:#7ee787>&lt;/entry&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/properties&gt;</span>
</span></span></code></pre></div><blockquote><p>扩展词: 不想被分词的词: 比如, 乔碧罗, 神罗天征等</p><p>停止词: 不想要的词,搜索时不会搜它, 比如: 个 ,啊, the , a 等</p></blockquote><p><strong>远程词典具备热更新的能力</strong>, 满足以下前两点即可实现热更新</p><p>其中 <code>location</code> 是指一个 url，比如 <code>http://yoursite.com/getCustomDict</code>，该请求只需满足以下两点即可完成分词热更新。</p><ol><li><p>该 http 请求需要返回两个头部(header)，一个是 <code>Last-Modified</code>，一个是 <code>ETag</code>，这两者都是字符串类型，只要有一个发生变化，该插件就会去抓取新的分词进而更新词库。</p><blockquote><p>写个接口,返回修改时间和ETag即可</p><p>或者用Ng转发静态文件, 会自动加上这个两个配置,当文件改动时,这两个值自动改变</p></blockquote></li><li><p>该 http 请求返回的内容格式是一行一个分词，换行符用 <code></code>即可。</p></li><li><p>url返回一个UTF-8格式的文本即可</p></li></ol><blockquote><p>如果有多个文件,用英文分号隔开<code>;</code></p></blockquote><blockquote><p>监控流程</p><ol start=0><li><p><u>读取 <code>IKAnalyzer.cfg.xml</code>配置文件,并解析其中的配置</u></p></li><li><p>向词库服务器发送Head请求</p></li><li><p>从响应中获取<code>Last- Modify</code>、 <code>Etags</code>字段值，判断是否变化</p></li><li><p>如果未变化，体眠1min,返回第0步</p><p>​ 如果有变化，重新加戟词典</p></li><li><p>休眠1min,返回第0步</p></li></ol></blockquote><p><strong>自定义词汇只会对新加的数据生效,不会对存量数据生效,需要更新一次才行</strong></p><blockquote><p>数据在写入时就已分词存储,所以自定义词汇不会对存量数据生效</p></blockquote><p><a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html target=_blank rel=noopener>官方</a>
提供更新方式 <code>POST product/_update_by_query?conflicts=proceed</code></p><blockquote><p>update_by_query原理</p><p>开始时获取一个索引的快照，并且使用内部版本来号来进行更新。这意味着如果文档在获得快照后，对索引处理 过程中版本发生更改，将会发生版本冲突。当快照的版本和索引版本一直时则进行更新，并且递增文档版本号。</p><p>当遇到冲突而导致整个更新过程失败时，更新过程是不会回滚的。如果不想因为冲突导致整个更新过程终止，可以在url中添加参数conflicts=proceed。或者在请求body中添加”conflicts”:”proceed”</p><p>不光这里可以用,修改es文档也是用<code>_update_by_query</code></p><p>执行结果如图:(消耗时间单位 : 毫秒)</p><p>格力的es集群,执行效率大概是2300条/s, 26万数据,大概花了1.7分钟</p><p><img loading=lazy src="https://img-blog.csdnimg.cn/20210106175123919.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MDExNDE1,size_16,color_FFFFFF,t_70" alt=image></p><p>更新可能耗时太久导致客户端连接超时,可以用命令查看任务执行情况(未结束的任务)</p><p><code>GET _tasks?actions=*update*&amp;detailed</code></p></blockquote><h2 id=53-同义词分析器>5.3 同义词分析器<a hidden class=anchor aria-hidden=true href=#53-同义词分析器>#</a></h2><p><a href=https://www.jianshu.com/p/7dc93f4fbb46 target=_blank rel=noopener>配置同义词</a></p><h2 id=54-拼音分析器>5.4 拼音分析器<a hidden class=anchor aria-hidden=true href=#54-拼音分析器>#</a></h2><p><a href=https://github.com/medcl/elasticsearch-analysis-pinyin target=_blank rel=noopener>Pinyin Analysis for Elasticsearch</a></p><p>参考链接:</p><p><a href=https://www.jianshu.com/p/bebea42b5040 target=_blank rel=noopener>分析器-简书</a></p><p><a href=https://www.cnblogs.com/sanduzxcvbnm/p/12084607.html target=_blank rel=noopener>分析器-博客园</a></p><p><a href=https://elastic-search-in-action.medcl.com/3.site_search/3.3.search_box/unify_traditional_chinese_and_simplified_chinese/ target=_blank rel=noopener>繁简转换</a></p><p><a href=https://blog.csdn.net/zq199419951001/article/details/89884461 target=_blank rel=noopener>ES的同义词、扩展词、停止词热更新方案</a></p><p><a href=https://github.com/medcl/elasticsearch-analysis-ik target=_blank rel=noopener>ik分析器-github</a></p><p><a href=https://www.jianshu.com/p/f7634252ff9a target=_blank rel=noopener>ik分析器-简书</a></p><p><a href=https://blog.csdn.net/willingtolove/article/details/118382154 target=_blank rel=noopener>ik分析器-csdn</a></p><p><a href=http://3dobe.com/archives/44/ target=_blank rel=noopener>IK分词器原理与源码分析</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/ElasticSearch.html>ElasticSearch</a></li><li><a href=https://xiaokunji.com/zh/tags/%E7%BB%BC%E5%90%88.html>综合</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springBoot/Actuator.html><span class=title>« 上一页</span><br><span>Actuator</span></a>
<a class=next href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring/aop.html><span class=title>下一页 »</span><br><span>aop</span></a></nav></footer></article></main><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>米二</a>
All Rights Reserved</span>
<span id=busuanzi_container><span class="fa fa-user">用户数:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">访问数:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>