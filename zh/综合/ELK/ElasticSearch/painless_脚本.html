<!DOCTYPE html>
<html dir="auto" lang="zh"><head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="x-ua-compatible"/><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"/><meta content="index, follow" name="robots"/><title>painless_è„šæœ¬ | ç±³äºŒ</title>
<meta content=" 1. å®šä¹‰, 2. è¯­æ³•, 3. è„šæœ¬ä½¿ç”¨, 3.1 inline è„šæœ¬, 3.2 stored è„šæœ¬, ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼, è„šæœ¬ä¼˜åŒ–" name="keywords"/><meta content="     " name="description"/><meta content="xkj" name="author"/><link href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/painless_%E8%84%9A%E6%9C%AC.html" rel="canonical"/><link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.dc6bd2c841ee388e899e13872ae986c0e847e8b957d6714ad6ddc628ef2d17ff.css" integrity="sha256-3GvSyEHuOI6JnhOHKumGwOhH6LlX1nFK1t3GKO8tF/8=" rel="preload stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js"></script><link href="https://xiaokunji.com/img/Q.svg" rel="icon"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="16x16" type="image/png"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="32x32" type="image/png"/><link href="https://xiaokunji.com/Q.svg" rel="apple-touch-icon"/><link href="https://xiaokunji.com/Q.svg" rel="mask-icon"/><meta content="#2e2e33" name="theme-color"/><meta content="#2e2e33" name="msapplication-TileColor"/><link href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/painless_%E8%84%9A%E6%9C%AC.html" hreflang="zh" rel="alternate"/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta content="painless_è„šæœ¬" property="og:title"/><meta content="     " property="og:description"/><meta content="article" property="og:type"/><meta content="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/painless_%E8%84%9A%E6%9C%AC.html" property="og:url"/><meta content="ç»¼åˆ" property="article:section"/><meta content="2023-08-22T00:00:00+00:00" property="article:published_time"/><meta content="2023-08-22T22:36:07+08:00" property="article:modified_time"/><meta content="summary" name="twitter:card"/><meta content="painless_è„šæœ¬" name="twitter:title"/><meta content="     " name="twitter:description"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":5,"name":"painless_è„šæœ¬","item":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/painless_%E8%84%9A%E6%9C%AC.html"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"painless_è„šæœ¬","name":"painless_è„šæœ¬","description":"     ","keywords":[" 1. å®šä¹‰"," 2. è¯­æ³•"," 3. è„šæœ¬ä½¿ç”¨"," 3.1 inline è„šæœ¬"," 3.2 stored è„šæœ¬"," ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼"," è„šæœ¬ä¼˜åŒ–"],"articleBody":"[toc]\n1. å®šä¹‰ ElasticStackåœ¨å‡çº§åˆ°5.0ç‰ˆæœ¬ä¹‹åï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„è„šæœ¬è¯­è¨€ï¼Œpainlessã€‚è¿™é‡Œè¯´â€œæ–°çš„â€œæ˜¯ç›¸å¯¹ä¸å·²ç»å­˜åœ¨grooveè€Œè¨€çš„ã€‚Grooveè„šæœ¬å¼€å¯ä¹‹åï¼Œå¦‚æœè¢«äººè¯¯ç”¨å¯èƒ½å¸¦æ¥å„ç§æ¼æ´ï¼Œç”±äºè¿™äº›å¤–éƒ¨çš„è„šæœ¬å¼•æ“å¤ªè¿‡äºå¼ºå¤§ï¼Œç”¨ä¸å¥½æˆ–è€…è®¾ç½®ä¸å½“å°±ä¼šå¼•èµ·å®‰å…¨é£é™©ï¼ŒåŸºäºå®‰å…¨å’Œæ€§èƒ½æ–¹é¢ï¼Œæ‰€ä»¥elastic.coå¼€å‘äº†ä¸€ä¸ªæ–°çš„è„šæœ¬å¼•æ“ï¼Œåå­—å°±å«Painlessï¼Œå’ŒGrooveçš„æ²™ç›’æœºåˆ¶ä¸ä¸€æ ·ï¼ŒPainlessä½¿ç”¨ç™½åå•æ¥é™åˆ¶å‡½æ•°ä¸å­—æ®µçš„è®¿é—®ï¼Œé’ˆå¯¹esçš„åœºæ™¯æ¥è¿›è¡Œä¼˜åŒ–ï¼Œåªåšesæ•°æ®çš„æ“ä½œï¼Œæ›´åŠ è½»é‡çº§ï¼Œé€Ÿåº¦è¦å¿«å¥½å‡ å€ï¼Œå¹¶ä¸”æ”¯æŒJavaé™æ€ç±»å‹ï¼Œè¯­æ³•ä¿æŒGrooveç±»ä¼¼ï¼Œè¿˜æ”¯æŒJavaçš„lambdaè¡¨è¾¾å¼ã€‚\nå¯ä»¥åšå¾ˆå¤šäº‹æƒ…,æ”¹å­—æ®µå€¼ / åŠ å­—æ®µ / æŸ¥è¯¢æ—¶å¤„ç†ç»“æœå€¼ç­‰ç­‰\n2. è¯­æ³• è„šæœ¬å˜é‡\nctx._source.fieldï¼šadd, contains, remove, indexOf, length\nctx.opï¼šåº”è¯¥å¯¹æ–‡æ¡£åº”ç”¨çš„æ“ä½œï¼šç´¢å¼•æˆ–åˆ é™¤\nctx._indexï¼šè®¿é—®æ–‡æ¡£å…ƒæ•°æ®å­—æ®µ\n_score åªåœ¨script_scoreä¸­æœ‰æ•ˆ\ndoc[â€˜fieldâ€™], doc[â€˜fieldâ€™].value: add, contains, remove, indexOf, length\n1ã€å¸¸ç”¨æ•°æ®ç±»å‹ï¼š intã€doubleã€Stringã€Listã€Mapã€bool (å’Œjavaä¸€è‡´ï¼‰\n2ã€å˜é‡å®šä¹‰ï¼š\nâ€‹ å®šä¹‰å˜é‡æœ‰ä¸¤ç§æ–¹å¼ï¼ŒåŠ¨æ€ç±»å‹å’Œé™æ€ç±»å‹ï¼Œå»ºè®®ç”¨é™æ€ç±»å‹ï¼Œé™æ€ç±»å‹çš„è®¡ç®—é€Ÿåº¦æ˜¯åŠ¨æ€ç±»å‹çš„10å€\nåŠ¨æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š def a = â€œabcâ€ é™æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š int a = 1; Sting b = â€œasdsdâ€ 3ã€è·å–æ–‡æ¡£ä¸­æŸä¸ªå­—æ®µçš„å€¼çš„ç”¨æ³•ï¼š\nè·å–docä¸‹å­—æ®µï¼š doc[â€™nameâ€™].value\nnestedå­—æ®µå–å‡ºæ¥åå°±æ˜¯æ•°ç»„ï¼Œå¯ç”¨ä¸‹æ ‡è·å–, åé¢ä¸ç”¨åŠ valueï¼š doc['expect_jobs'][1]\ndocä»¥å¤–çš„å­—æ®µå¯ç›´æ¥ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š\nPOST twitter/_update/1 { \"script\": { \"source\": \"ctx._source.age = params.value\", \"params\": { \"value\": 34 } } } å¦‚æœparamsæ˜¯å…¶ä»–ç±»å‹,åŸºæœ¬éµå¾ªjavaçš„è¯­æ³•\nlambdaè¯­æ³•:\nlist.sort((x, y) -\u003e x - y); list.sort(Integer::compare); 3. è„šæœ¬ä½¿ç”¨ è„šæœ¬æ ¼å¼\n\"script\": { \"lang\": \"...\", \"source\" | \"id\": \"...\", \"params\": { ... } } ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º:\nè„šæœ¬ç¼–å†™çš„è¯­è¨€ï¼Œé»˜è®¤ä¸º painlessã€‚ è„šæœ¬æœ¬èº«å¯ä»¥æŒ‡å®šä¸ºå†…è”è„šæœ¬çš„ source æˆ–å­˜å‚¨è„šæœ¬çš„ idã€‚ åº”ä¼ é€’ç»™è„šæœ¬çš„ä»»ä½•å‘½åå‚æ•°ã€‚ è®¿é—®sourceé‡Œçš„å­—æ®µ\nPainlessä¸­ç”¨äºè®¿é—®å­—æ®µå€¼çš„è¯­æ³•å–å†³äºä¸Šä¸‹æ–‡ã€‚åœ¨Elasticsearchä¸­ï¼Œæœ‰è®¸å¤šä¸åŒçš„Plainlessä¸Šä¸‹æ–‡ã€‚å°±åƒé‚£ä¸ªé“¾æ¥æ˜¾ç¤ºçš„é‚£æ ·ï¼ŒPlainlessä¸Šä¸‹æ–‡åŒ…æ‹¬ï¼šingest processor, update, update by query, sortï¼Œfilterç­‰ç­‰ã€‚ Context è®¿é—®å­—æ®µ Ingest node: è®¿é—®å­—æ®µä½¿ç”¨ctx ctx.field_name Updates: ä½¿ç”¨_source å­—æ®µ ctx._source.field_name\nè¿™é‡Œçš„updatesåŒ…æ‹¬_updateï¼Œ_reindexä»¥åŠupdate_by_queryã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºcontextï¼ˆä¸Šä¸‹æ–‡çš„ç†è§£ï¼‰éå¸¸é‡è¦ã€‚å®ƒçš„æ„æ€æ˜¯é’ˆå¯¹ä¸åŒçš„APIï¼Œåœ¨ä½¿ç”¨ä¸­ctxæ‰€åŒ…å«çš„å­—æ®µæ˜¯ä¸ä¸€æ ·çš„\n3.1 inline è„šæœ¬ PUT twitter/_doc/1 { \"user\" : \"åŒæ¦†æ ‘-å¼ ä¸‰\", \"message\" : \"ä»Šå„¿å¤©æ°”ä¸é”™å•Šï¼Œå‡ºå»è½¬è½¬å»\", \"uid\" : 2, \"age\" : 20, \"city\" : \"åŒ—äº¬\", \"province\" : \"åŒ—äº¬\", \"country\" : \"ä¸­å›½\", \"address\" : \"ä¸­å›½åŒ—äº¬å¸‚æµ·æ·€åŒº\", \"location\" : { \"lat\" : \"39.970718\", \"lon\" : \"116.325747\" } } åœ¨è¿™ä¸ªæ–‡æ¡£é‡Œï¼Œæˆ‘ä»¬ç°åœ¨æƒ³æŠŠageä¿®æ”¹ä¸º30ï¼Œé‚£ä¹ˆä¸€ç§åŠæ³•å°±æ˜¯æŠŠæ‰€æœ‰çš„æ–‡æ¡£å†…å®¹éƒ½è¯»å‡ºæ¥ï¼Œè®©ä¿®æ”¹å…¶ä¸­çš„ageæƒ³ä¸º30ï¼Œå†é‡æ–°ç”¨åŒæ ·çš„æ–¹æ³•å†™è¿›å»ã€‚é¦–å…ˆè¿™é‡Œéœ€è¦æœ‰å‡ ä¸ªåŠ¨ä½œï¼šå…ˆè¯»å‡ºæ•°æ®ï¼Œç„¶åä¿®æ”¹ï¼Œå†æ¬¡å†™å…¥æ•°æ®ã€‚æ˜¾ç„¶è¿™æ ·æ¯”è¾ƒéº»çƒ¦ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨Painlessè¯­è¨€ç›´æ¥è¿›è¡Œä¿®æ”¹ï¼š\nPOST twitter/_update/1 { \"script\": { \"source\": \"ctx._source.age = 30\" } } è¿™é‡Œçš„sourceè¡¨æ˜æ˜¯æˆ‘ä»¬çš„Painlessä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬åªå†™äº†å¾ˆå°‘çš„ä»£ç åœ¨DSLä¹‹ä¸­ã€‚è¿™ç§ä»£ç ç§°ä¹‹ä¸ºinlineã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ctx._source.ageæ¥è®¿é—® _souceé‡Œçš„ageã€‚è¿™æ ·æˆ‘ä»¬é€šè¿‡ç¼–ç¨‹çš„åŠæ³•ç›´æ¥å¯¹å¹´é¾„è¿›è¡Œäº†ä¿®æ”¹\næ¯æ¬¡æ›´æ–°å€¼ä¸ä¸€æ ·,esä¼šè®¤ä¸ºæ˜¯ä¸åŒçš„è„šæœ¬,éƒ½ä¼šè¿›è¡Œç¼–è¯‘,æ‰€ä»¥éœ€è¦ç”¨å‚æ•°çš„æ–¹å¼,è¿™æ ·eså°±ä¼šå½“æˆä¸€ä¸ªè„šæœ¬\nElasticsearchç¬¬ä¸€æ¬¡çœ‹åˆ°ä¸€ä¸ªæ–°è„šæœ¬ï¼Œå®ƒä¼šç¼–è¯‘å®ƒå¹¶å°†ç¼–è¯‘åçš„ç‰ˆæœ¬å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ— è®ºæ˜¯inlineæˆ–æ˜¯storedè„šæœ¬éƒ½å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ–°è„šæœ¬å¯ä»¥é©±é€ç¼“å­˜çš„è„šæœ¬ã€‚é»˜è®¤çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥å­˜å‚¨100ä¸ªè„šæœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®script.cache.max_sizeæ¥æ”¹å˜å…¶å¤§å°ï¼Œæˆ–è€…é€šè¿‡script.cache.expireæ¥è®¾ç½®è¿‡æœŸçš„æ—¶é—´ã€‚è¿™äº›è®¾ç½®éœ€è¦åœ¨config/elasticsearch.ymlé‡Œè®¾ç½®ã€‚\nPOST twitter/_update/1 { \"script\": { \"source\": \"ctx._source.age = params.value\", \"params\": { \"value\": 34 } } } GET hockey/_search { \"query\": { \"match_all\": {} }, \"script_fields\": { \"total_goals\": { \"script\": { \"lang\": \"painless\", \"source\": \"\"\" int total = 0; for (int i = 0; i \u003c doc['goals'].length; ++i) { total += doc['goals'][i]; } return total; \"\"\" } } } } sourceé‡Œé¢å¯ä»¥ç”¨pythonçš„å¤šè¡Œå­—ç¬¦ä¸²æ–¹å¼å†™è¯­æ³•\nsourceä¹Ÿèƒ½å…·æœ‰æŸ¥è¯¢çš„åŠŸèƒ½\n3.2 stored è„šæœ¬ sourceå­—æ®µä¸å…‰èƒ½å†™è„šæœ¬,è¿˜èƒ½å†™id,è¿™ä¸ªidå°±æ˜¯æŒ‡çš„æ˜¯ä¸€ä¸ªå†™å¥½çš„è„šæœ¬,è¿™æ ·,è„šæœ¬å°±èƒ½æ›´å¥½çš„ç®¡ç†,ä¸ç”¨å†…åµŒåˆ°æŸ¥è¯¢ä¸­\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œscriptså¯ä»¥è¢«å­˜æ”¾äºä¸€ä¸ªé›†ç¾¤çš„çŠ¶æ€ä¸­ã€‚å®ƒä¹‹åå¯ä»¥é€šè¿‡IDè¿›è¡Œè°ƒç”¨ï¼š\nPUT _scripts/add_age { \"script\": { \"lang\": \"painless\", \"source\": \"ctx._source.age += params.value\" } } åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå«åšadd_ageçš„scriptã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬æŠŠsourceé‡Œçš„ageåŠ ä¸Šä¸€ä¸ªæ•°å€¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¹‹åè°ƒç”¨å®ƒï¼š\nPOST twitter/_update/1 { \"script\": { \"id\": \"add_age\", \"params\": { \"value\": 2 } } } ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼ æ–‡æ¡£é‡Œçš„å€¼å¯ä»¥é€šè¿‡ä¸€ä¸ªå«åšdocçš„Mapå€¼æ¥è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è„šæœ¬è®¡ç®—ç©å®¶çš„æ€»è¿›çƒæ•°ã€‚ æ­¤ç¤ºä¾‹ä½¿ç”¨ç±»å‹intå’Œforå¾ªç¯ã€‚\nGET hockey/_search { \"query\": { \"function_score\": { \"script_score\": { \"script\": { \"lang\": \"painless\", \"source\": \"\"\" int total = 0; for (int i = 0; i \u003c doc['goals'].length; ++i) { total += doc['goals'][i]; } return total; \"\"\" } } } } } æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨script_fieldsè€Œä¸æ˜¯function_scoreæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š\nGET hockey/_search { \"query\": { \"match_all\": {} }, \"script_fields\": { \"total_goals\": { \"script\": { \"lang\": \"painless\", \"source\": \"\"\" int total = 0; for (int i = 0; i \u003c doc['goals'].length; ++i) { total += doc['goals'][i]; } return total; \"\"\" } } } } è„šæœ¬ä¼˜åŒ– ä½¿ç”¨è„šæœ¬ç¼“å­˜, é¢„å…ˆç¼“å­˜å¯ä»¥èŠ‚çœç¬¬ä¸€æ¬¡çš„æŸ¥è¯¢æ—¶é—´\nä½¿ç”¨ingest pipelineè¿›è¡Œé¢„å…ˆè®¡ç®—\nç›¸æ¯”äº_source.field_nameä½¿ç”¨doc[â€˜field_nameâ€™]è¯­æ³•é€Ÿåº¦æ›´å¿«, docè¯­æ³•ä½¿ç”¨doc value , åˆ—å­˜å‚¨\nå‚è€ƒé“¾æ¥:\nhttps://blog.csdn.net/qq_24499615/article/details/116161674 https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lambdas.html https://blog.csdn.net/u013613428/article/details/78134170 ","wordCount":"2368","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-22T22:36:07+08:00","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch/painless_%E8%84%9A%E6%9C%AC.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class="dark" id="top"><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class="header"><nav class="nav"><div class="logo"><a accesskey="h" href="https://xiaokunji.com/zh/" title="ç±³äºŒ (Alt + H)"><img alt="" aria-label="logo" height="35" src="https://xiaokunji.com/img/Q.svg"/>ç±³äºŒ</a><div class="logo-switches"><button accesskey="t" id="theme-toggle" title="(Alt + T)"><svg fill="none" height="18" id="moon" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg><svg fill="none" height="18" id="sun" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg></button><ul class="lang-switch"><li>|</li><li><a aria-label="English" href="https://xiaokunji.com/en/" title="English">English</a></li></ul></div></div><ul id="menu"><li><a href="https://xiaokunji.com/zh/" title="ğŸ ä¸»é¡µ"><span>ğŸ ä¸»é¡µ</span></a></li><li><a accesskey="/" href="https://xiaokunji.com/zh/search" title="ğŸ”æœç´¢ (Alt + /)"><span>ğŸ”æœç´¢</span></a></li><li><a href="https://xiaokunji.com/zh/post.html" title="ğŸ“šæ–‡ç« "><span>ğŸ“šæ–‡ç« </span></a></li><li><a href="https://xiaokunji.com/zh/archives.html" title="â±æ—¶é—´è½´"><span>â±æ—¶é—´è½´</span></a></li><li><a href="https://xiaokunji.com/zh/tags.html" title="ğŸ”–æ ‡ç­¾"><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href="https://xiaokunji.com/zh/categories.html" title="ğŸ“–åˆ†ç±»"><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href="https://xiaokunji.com/zh/links.html" title="ğŸ¤å‹é“¾"><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><nav aria-label="breadcrumb"><ul><a href="https://xiaokunji.com/zh/">ğŸ </a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88.html">ç»¼åˆ</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK.html">ELK</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/ELK/ElasticSearch.html">ElasticSearch</a> <span>&gt;</span></ul></nav><h1 class="post-title">painless_è„šæœ¬</h1><div class="post-description"></div><div class="post-meta">åˆ›å»º:&amp;nbsp;&lt;span title='2023-08-22 00:00:00 +0000 UTC'&gt;2023-08-22&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;æ›´æ–°:&amp;nbsp;2023-08-22&amp;nbsp;Â·&amp;nbsp;xkj
Â |Â åˆ†ç±»: Â <ul class="post-categories-meta" style="display:inline"><a href="https://xiaokunji.com/zh/categories/%E7%BB%BC%E5%90%88.html">ç»¼åˆ</a></ul><span id="busuanzi_container_page_pv">Â | è®¿é—®: <span id="busuanzi_value_page_pv">1</span></span></div></header><aside class="toc-container wide" id="toc-container"><div class="toc"><details open=""><summary accesskey="c" title="(Alt + C)"><span class="details">ç›®å½•</span></summary><div class="inner"><ul><li><a aria-label="1. å®šä¹‰" href="#1-%e5%ae%9a%e4%b9%89">1. å®šä¹‰</a></li><li><a aria-label="2. è¯­æ³•" href="#2-%e8%af%ad%e6%b3%95">2. è¯­æ³•</a></li><li><a aria-label="3. è„šæœ¬ä½¿ç”¨" href="#3-%e8%84%9a%e6%9c%ac%e4%bd%bf%e7%94%a8">3. è„šæœ¬ä½¿ç”¨</a><ul><li><a aria-label="3.1 inline è„šæœ¬" href="#31-inline-%e8%84%9a%e6%9c%ac">3.1 inline è„šæœ¬</a></li><li><a aria-label="3.2 stored è„šæœ¬" href="#32-stored-%e8%84%9a%e6%9c%ac">3.2 stored è„šæœ¬</a></li><li><a aria-label="ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼" href="#%e4%bd%bf%e7%94%a8painless%e8%ae%bf%e9%97%aedoc%e9%87%8c%e7%9a%84%e5%80%bc">ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼</a></li></ul></li><li><a aria-label="è„šæœ¬ä¼˜åŒ–" href="#%e8%84%9a%e6%9c%ac%e4%bc%98%e5%8c%96">è„šæœ¬ä¼˜åŒ–</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class="post-content"><p>[toc]</p><h1 id="1-å®šä¹‰">1. å®šä¹‰<a aria-hidden="true" class="anchor" hidden="" href="#1-å®šä¹‰">#</a></h1><p>ElasticStackåœ¨å‡çº§åˆ°5.0ç‰ˆæœ¬ä¹‹åï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„è„šæœ¬è¯­è¨€ï¼Œpainlessã€‚è¿™é‡Œè¯´â€œæ–°çš„â€œæ˜¯ç›¸å¯¹ä¸å·²ç»å­˜åœ¨grooveè€Œè¨€çš„ã€‚Grooveè„šæœ¬å¼€å¯ä¹‹åï¼Œå¦‚æœè¢«äººè¯¯ç”¨å¯èƒ½å¸¦æ¥å„ç§æ¼æ´ï¼Œç”±äºè¿™äº›å¤–éƒ¨çš„è„šæœ¬å¼•æ“å¤ªè¿‡äºå¼ºå¤§ï¼Œç”¨ä¸å¥½æˆ–è€…è®¾ç½®ä¸å½“å°±ä¼šå¼•èµ·å®‰å…¨é£é™©ï¼ŒåŸºäºå®‰å…¨å’Œæ€§èƒ½æ–¹é¢ï¼Œæ‰€ä»¥elastic.coå¼€å‘äº†ä¸€ä¸ªæ–°çš„è„šæœ¬å¼•æ“ï¼Œåå­—å°±å«Painlessï¼Œå’ŒGrooveçš„æ²™ç›’æœºåˆ¶ä¸ä¸€æ ·ï¼ŒPainlessä½¿ç”¨ç™½åå•æ¥é™åˆ¶å‡½æ•°ä¸å­—æ®µçš„è®¿é—®ï¼Œé’ˆå¯¹esçš„åœºæ™¯æ¥è¿›è¡Œä¼˜åŒ–ï¼Œåªåšesæ•°æ®çš„æ“ä½œï¼Œæ›´åŠ è½»é‡çº§ï¼Œé€Ÿåº¦è¦å¿«å¥½å‡ å€ï¼Œå¹¶ä¸”æ”¯æŒ<u>Javaé™æ€ç±»å‹ï¼Œè¯­æ³•ä¿æŒGrooveç±»ä¼¼ï¼Œè¿˜æ”¯æŒJavaçš„lambdaè¡¨è¾¾å¼</u>ã€‚</p><blockquote><p>å¯ä»¥åšå¾ˆå¤šäº‹æƒ…,æ”¹å­—æ®µå€¼ / åŠ å­—æ®µ / æŸ¥è¯¢æ—¶å¤„ç†ç»“æœå€¼ç­‰ç­‰</p></blockquote><h1 id="2-è¯­æ³•">2. è¯­æ³•<a aria-hidden="true" class="anchor" hidden="" href="#2-è¯­æ³•">#</a></h1><p><strong>è„šæœ¬å˜é‡</strong></p><p>ctx._source.fieldï¼šadd, contains, remove, indexOf, length</p><p>ctx.opï¼šåº”è¯¥å¯¹æ–‡æ¡£åº”ç”¨çš„æ“ä½œï¼šç´¢å¼•æˆ–åˆ é™¤</p><p>ctx._indexï¼šè®¿é—®æ–‡æ¡£å…ƒæ•°æ®å­—æ®µ</p><p>_score åªåœ¨script_scoreä¸­æœ‰æ•ˆ</p><p>doc[â€˜fieldâ€™], doc[â€˜fieldâ€™].value: add, contains, remove, indexOf, length</p><p>1ã€å¸¸ç”¨æ•°æ®ç±»å‹ï¼š intã€doubleã€Stringã€Listã€Mapã€bool (å’Œjavaä¸€è‡´ï¼‰</p><p>2ã€å˜é‡å®šä¹‰ï¼š</p><p>â€‹ å®šä¹‰å˜é‡æœ‰ä¸¤ç§æ–¹å¼ï¼ŒåŠ¨æ€ç±»å‹å’Œé™æ€ç±»å‹ï¼Œå»ºè®®ç”¨é™æ€ç±»å‹ï¼Œé™æ€ç±»å‹çš„è®¡ç®—é€Ÿåº¦æ˜¯åŠ¨æ€ç±»å‹çš„10å€</p><ul><li>åŠ¨æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š def a = â€œabcâ€</li><li>é™æ€ç±»å‹å®šä¹‰æ–¹å¼ï¼š int a = 1; Sting b = â€œasdsdâ€</li></ul><p>3ã€è·å–æ–‡æ¡£ä¸­æŸä¸ªå­—æ®µçš„å€¼çš„ç”¨æ³•ï¼š</p><p>è·å–docä¸‹å­—æ®µï¼š doc[â€™nameâ€™].value</p><p>nestedå­—æ®µå–å‡ºæ¥åå°±æ˜¯æ•°ç»„ï¼Œå¯ç”¨ä¸‹æ ‡è·å–, åé¢ä¸ç”¨åŠ valueï¼š <code>doc['expect_jobs'][1]</code></p><p>docä»¥å¤–çš„å­—æ®µå¯ç›´æ¥ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-json" data-lang="json"><span style="display:flex"><span>  <span style="color:#f85149">POST</span> <span style="color:#f85149">twitter/_update/</span><span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex"><span>    {
</span></span><span style="display:flex"><span>      <span style="color:#7ee787">"script"</span>: {
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">"source"</span>: <span style="color:#a5d6ff">"ctx._source.age = params.value"</span>,
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">"params"</span>: {
</span></span><span style="display:flex"><span>          <span style="color:#7ee787">"value"</span>: <span style="color:#a5d6ff">34</span>
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>      }
</span></span><span style="display:flex"><span>    }
</span></span></code></pre></div><blockquote><p>å¦‚æœparamsæ˜¯å…¶ä»–ç±»å‹,åŸºæœ¬éµå¾ªjavaçš„è¯­æ³•</p></blockquote><p>lambdaè¯­æ³•:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span>list.sort((x,<span style="color:#6e7681"> </span>y)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-&gt;</span><span style="color:#6e7681"> </span>x<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-</span><span style="color:#6e7681"> </span>y);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>list.sort(Integer::compare);<span style="color:#6e7681">
</span></span></span></code></pre></div><h1 id="3-è„šæœ¬ä½¿ç”¨">3. è„šæœ¬ä½¿ç”¨<a aria-hidden="true" class="anchor" hidden="" href="#3-è„šæœ¬ä½¿ç”¨">#</a></h1><p>è„šæœ¬æ ¼å¼</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-json" data-lang="json"><span style="display:flex"><span><span style="color:#a5d6ff">"script"</span><span style="color:#f85149">:</span> {
</span></span><span style="display:flex"><span>  <span style="color:#7ee787">"lang"</span>:   <span style="color:#a5d6ff">"..."</span>,  
</span></span><span style="display:flex"><span>  <span style="color:#7ee787">"source"</span> <span style="color:#f85149">|</span> <span style="color:#a5d6ff">"id"</span>: <span style="color:#a5d6ff">"..."</span>, 
</span></span><span style="display:flex"><span>  <span style="color:#7ee787">"params"</span>: { <span style="color:#f85149">...</span> } 
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><blockquote><p>ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º:</p><ul><li>è„šæœ¬ç¼–å†™çš„è¯­è¨€ï¼Œé»˜è®¤ä¸º painlessã€‚</li><li>è„šæœ¬æœ¬èº«å¯ä»¥æŒ‡å®šä¸ºå†…è”è„šæœ¬çš„ source æˆ–å­˜å‚¨è„šæœ¬çš„ idã€‚</li><li>åº”ä¼ é€’ç»™è„šæœ¬çš„ä»»ä½•å‘½åå‚æ•°ã€‚</li></ul></blockquote><p><strong>è®¿é—®sourceé‡Œçš„å­—æ®µ</strong></p><p>Painlessä¸­ç”¨äºè®¿é—®å­—æ®µå€¼çš„è¯­æ³•å–å†³äºä¸Šä¸‹æ–‡ã€‚åœ¨Elasticsearchä¸­ï¼Œæœ‰è®¸å¤šä¸åŒçš„Plainlessä¸Šä¸‹æ–‡ã€‚å°±åƒé‚£ä¸ªé“¾æ¥æ˜¾ç¤ºçš„é‚£æ ·ï¼ŒPlainlessä¸Šä¸‹æ–‡åŒ…æ‹¬ï¼šingest processor, update, update by query, sortï¼Œfilterç­‰ç­‰ã€‚
Context è®¿é—®å­—æ®µ
Ingest node: è®¿é—®å­—æ®µä½¿ç”¨ctx ctx.field_name
Updates: ä½¿ç”¨<code>_source</code> å­—æ®µ <code>ctx._source.field_name</code></p><p>è¿™é‡Œçš„updatesåŒ…æ‹¬<code>_update</code>ï¼Œ<code>_reindex</code>ä»¥åŠupdate_by_queryã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºcontextï¼ˆä¸Šä¸‹æ–‡çš„ç†è§£ï¼‰éå¸¸é‡è¦ã€‚å®ƒçš„æ„æ€æ˜¯é’ˆå¯¹ä¸åŒçš„APIï¼Œåœ¨ä½¿ç”¨ä¸­ctxæ‰€åŒ…å«çš„å­—æ®µæ˜¯ä¸ä¸€æ ·çš„</p><h2 id="31-inline-è„šæœ¬">3.1 inline è„šæœ¬<a aria-hidden="true" class="anchor" hidden="" href="#31-inline-è„šæœ¬">#</a></h2><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">    PUT twitter/_doc/1
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "user" : "åŒæ¦†æ ‘-å¼ ä¸‰",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "message" : "ä»Šå„¿å¤©æ°”ä¸é”™å•Šï¼Œå‡ºå»è½¬è½¬å»",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "uid" : 2,
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "age" : 20,
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "city" : "åŒ—äº¬",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "province" : "åŒ—äº¬",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "country" : "ä¸­å›½",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "address" : "ä¸­å›½åŒ—äº¬å¸‚æµ·æ·€åŒº",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "location" : {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "lat" : "39.970718",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "lon" : "116.325747"
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><p>åœ¨è¿™ä¸ªæ–‡æ¡£é‡Œï¼Œæˆ‘ä»¬ç°åœ¨æƒ³æŠŠageä¿®æ”¹ä¸º30ï¼Œé‚£ä¹ˆä¸€ç§åŠæ³•å°±æ˜¯æŠŠæ‰€æœ‰çš„æ–‡æ¡£å†…å®¹éƒ½è¯»å‡ºæ¥ï¼Œè®©ä¿®æ”¹å…¶ä¸­çš„ageæƒ³ä¸º30ï¼Œå†é‡æ–°ç”¨åŒæ ·çš„æ–¹æ³•å†™è¿›å»ã€‚é¦–å…ˆè¿™é‡Œéœ€è¦æœ‰å‡ ä¸ªåŠ¨ä½œï¼šå…ˆè¯»å‡ºæ•°æ®ï¼Œç„¶åä¿®æ”¹ï¼Œå†æ¬¡å†™å…¥æ•°æ®ã€‚æ˜¾ç„¶è¿™æ ·æ¯”è¾ƒéº»çƒ¦ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨Painlessè¯­è¨€ç›´æ¥è¿›è¡Œä¿®æ”¹ï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">  POST twitter/_update/1
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "source": "ctx._source.age = 30"
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><p>è¿™é‡Œçš„sourceè¡¨æ˜æ˜¯æˆ‘ä»¬çš„Painlessä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬åªå†™äº†å¾ˆå°‘çš„ä»£ç åœ¨DSLä¹‹ä¸­ã€‚è¿™ç§ä»£ç ç§°ä¹‹ä¸ºinlineã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥é€šè¿‡<code>ctx._source.age</code>æ¥è®¿é—® <code>_souce</code>é‡Œçš„ageã€‚è¿™æ ·æˆ‘ä»¬é€šè¿‡ç¼–ç¨‹çš„åŠæ³•ç›´æ¥å¯¹å¹´é¾„è¿›è¡Œäº†ä¿®æ”¹</p><p><strong>æ¯æ¬¡æ›´æ–°å€¼ä¸ä¸€æ ·,esä¼šè®¤ä¸ºæ˜¯ä¸åŒçš„è„šæœ¬,éƒ½ä¼šè¿›è¡Œç¼–è¯‘,æ‰€ä»¥éœ€è¦ç”¨å‚æ•°çš„æ–¹å¼,è¿™æ ·eså°±ä¼šå½“æˆä¸€ä¸ªè„šæœ¬</strong></p><blockquote><p>Elasticsearchç¬¬ä¸€æ¬¡çœ‹åˆ°ä¸€ä¸ªæ–°è„šæœ¬ï¼Œå®ƒä¼šç¼–è¯‘å®ƒå¹¶å°†ç¼–è¯‘åçš„ç‰ˆæœ¬å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ— è®ºæ˜¯inlineæˆ–æ˜¯storedè„šæœ¬éƒ½å­˜å‚¨åœ¨ç¼“å­˜ä¸­ã€‚æ–°è„šæœ¬å¯ä»¥é©±é€ç¼“å­˜çš„è„šæœ¬ã€‚<strong>é»˜è®¤çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥å­˜å‚¨100ä¸ªè„šæœ¬</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®script.cache.max_sizeæ¥æ”¹å˜å…¶å¤§å°ï¼Œæˆ–è€…é€šè¿‡script.cache.expireæ¥è®¾ç½®è¿‡æœŸçš„æ—¶é—´ã€‚è¿™äº›è®¾ç½®éœ€è¦åœ¨config/elasticsearch.ymlé‡Œè®¾ç½®ã€‚</p></blockquote><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">  POST twitter/_update/1
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "source": "ctx._source.age = params.value",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "params": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          "value": 34
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">   GET hockey/_search
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "query": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "match_all": {}
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      },
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "script_fields": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "total_goals": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            "lang": "painless",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            "source": """
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              int total = 0;
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              for (int i = 0; i &lt; doc['goals'].length; ++i) {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                total += doc['goals'][i];
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              return total;
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            """
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><blockquote><p>sourceé‡Œé¢å¯ä»¥ç”¨pythonçš„å¤šè¡Œå­—ç¬¦ä¸²æ–¹å¼å†™è¯­æ³•</p></blockquote><p><strong>sourceä¹Ÿèƒ½å…·æœ‰æŸ¥è¯¢çš„åŠŸèƒ½</strong></p><h2 id="32-stored-è„šæœ¬">3.2 stored è„šæœ¬<a aria-hidden="true" class="anchor" hidden="" href="#32-stored-è„šæœ¬">#</a></h2><p>sourceå­—æ®µä¸å…‰èƒ½å†™è„šæœ¬,è¿˜èƒ½å†™id,è¿™ä¸ªidå°±æ˜¯æŒ‡çš„æ˜¯ä¸€ä¸ªå†™å¥½çš„è„šæœ¬,è¿™æ ·,è„šæœ¬å°±èƒ½æ›´å¥½çš„ç®¡ç†,ä¸ç”¨å†…åµŒåˆ°æŸ¥è¯¢ä¸­</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œscriptså¯ä»¥è¢«å­˜æ”¾äºä¸€ä¸ªé›†ç¾¤çš„çŠ¶æ€ä¸­ã€‚å®ƒä¹‹åå¯ä»¥é€šè¿‡IDè¿›è¡Œè°ƒç”¨ï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149"> PUT _scripts/add_age
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "lang": "painless",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "source": "ctx._source.age += params.value"
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå«åšadd_ageçš„scriptã€‚å®ƒçš„ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬æŠŠsourceé‡Œçš„ageåŠ ä¸Šä¸€ä¸ªæ•°å€¼ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¹‹åè°ƒç”¨å®ƒï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">  POST twitter/_update/1
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "id": "add_age",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "params": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          "value": 2
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><h2 id="ä½¿ç”¨painlessè®¿é—®docé‡Œçš„å€¼">ä½¿ç”¨Painlessè®¿é—®Docé‡Œçš„å€¼<a aria-hidden="true" class="anchor" hidden="" href="#ä½¿ç”¨painlessè®¿é—®docé‡Œçš„å€¼">#</a></h2><p>æ–‡æ¡£é‡Œçš„å€¼å¯ä»¥é€šè¿‡ä¸€ä¸ªå«åšdocçš„Mapå€¼æ¥è®¿é—®ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è„šæœ¬è®¡ç®—ç©å®¶çš„æ€»è¿›çƒæ•°ã€‚ æ­¤ç¤ºä¾‹ä½¿ç”¨ç±»å‹intå’Œforå¾ªç¯ã€‚</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">    GET hockey/_search
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "query": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "function_score": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          "script_score": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              "lang": "painless",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              "source": """
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                int total = 0;
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                for (int i = 0; i &lt; doc['goals'].length; ++i) {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                  total += doc['goals'][i];
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                return total;
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              """
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨script_fieldsè€Œä¸æ˜¯function_scoreæ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-http" data-lang="http"><span style="display:flex"><span><span style="color:#f85149">   GET hockey/_search
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "query": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "match_all": {}
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      },
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      "script_fields": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        "total_goals": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          "script": {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            "lang": "painless",
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            "source": """
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              int total = 0;
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              for (int i = 0; i &lt; doc['goals'].length; ++i) {
</span></span></span><span style="display:flex"><span><span style="color:#f85149">                total += doc['goals'][i];
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">              return total;
</span></span></span><span style="display:flex"><span><span style="color:#f85149">            """
</span></span></span><span style="display:flex"><span><span style="color:#f85149">          }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">        }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">      }
</span></span></span><span style="display:flex"><span><span style="color:#f85149">    }
</span></span></span></code></pre></div><h1 id="è„šæœ¬ä¼˜åŒ–">è„šæœ¬ä¼˜åŒ–<a aria-hidden="true" class="anchor" hidden="" href="#è„šæœ¬ä¼˜åŒ–">#</a></h1><p>ä½¿ç”¨è„šæœ¬ç¼“å­˜, é¢„å…ˆç¼“å­˜å¯ä»¥èŠ‚çœç¬¬ä¸€æ¬¡çš„æŸ¥è¯¢æ—¶é—´</p><p>ä½¿ç”¨ingest pipelineè¿›è¡Œé¢„å…ˆè®¡ç®—</p><p>ç›¸æ¯”äº_source.field_nameä½¿ç”¨doc[â€˜field_nameâ€™]è¯­æ³•é€Ÿåº¦æ›´å¿«, docè¯­æ³•ä½¿ç”¨doc value , åˆ—å­˜å‚¨</p><p>å‚è€ƒé“¾æ¥:</p><p><a href="https://blog.csdn.net/qq_24499615/article/details/116161674" rel="noopener" target="_blank">https://blog.csdn.net/qq_24499615/article/details/116161674</a></p><p><a href="https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lambdas.html" rel="noopener" target="_blank">https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lambdas.html</a></p><p><a href="https://blog.csdn.net/u013613428/article/details/78134170" rel="noopener" target="_blank">https://blog.csdn.net/u013613428/article/details/78134170</a></p></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xiaokunji.com/zh/tags/ElasticSearch.html">ElasticSearch</a></li><li><a href="https://xiaokunji.com/zh/tags/%E7%BB%BC%E5%90%88.html">ç»¼åˆ</a></li></ul><nav class="paginav"><a class="prev" href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E6%9C%8D%E5%8A%A1%E5%99%A8/OpenResty.html"><span class="title">Â« ä¸Šä¸€é¡µ</span><br/><span>OpenResty</span>
</a><a class="next" href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/maven/pom%E6%A0%87%E7%AD%BE.html"><span class="title">ä¸‹ä¸€é¡µ Â»</span><br/><span>pomæ ‡ç­¾</span></a></nav></footer></article></main><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><footer class="footer"><span>Copyright
Â©
-2023
<a href="https://xiaokunji.com/zh/" style="color:#939393">ç±³äºŒ</a>
All Rights Reserved
</span><span id="busuanzi_container"><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id="busuanzi_value_site_uv"></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id="busuanzi_value_site_pv"></span></span></footer><a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)"><svg fill="currentcolor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>