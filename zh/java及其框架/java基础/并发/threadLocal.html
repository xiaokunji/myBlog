<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜ | ç±³äºŒ</title><meta name=keywords content=" 1. ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ, 2. ThreadLocalçš„å…·ä½“å®ç°, 2.1 ThreadLocalç»“æ„  , 2.2 å…·ä½“å®ç°, 2.3 å¼•ç”¨å…³ç³», 2.3.1 threadLocalå¼•ç”¨å…³ç³», 2.3.2 æ‰©å±•, 3. æºç è§£è¯», 3.1 ä»setæ–¹æ³•å¼€å§‹, 3.2 ThreadLocalä¸­çš„get(), 3.3 ThreadLocalMapä¸­çš„remove(), 4. å†…å­˜æ³„éœ², 4.1 ThreadLocal å†…å­˜æ³„æ¼çš„åŸå› , 4.2 ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•, 4.3 æ€»ç»“, 5. ä½¿ç”¨åœºæ™¯, 5.1 åœºæ™¯ä¸€ï¼šä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’, 5.2 åœºæ™¯äºŒï¼šè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜, 5.3 åœºæ™¯ä¸‰ï¼šå…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯, 6. å®æˆ˜, 6.1 ä»£ç , 6.2 å¼‚å¸¸å¤„ç†, 6.2.1 feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´, 6.2.2 å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´, 7. æ‰©å±•, 7.1 InheritableThreadLocal, 7.2 TransmittableThreadLocal(TTL)"><meta name=description content="ThreadLocalåŸç†"><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/threadLocal.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/threadLocal.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜"><meta property="og:description" content="ThreadLocalåŸç†"><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/threadLocal.html"><meta property="article:section" content="javaåŠå…¶æ¡†æ¶"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-04T05:49:41+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜"><meta name=twitter:description content="ThreadLocalåŸç†"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":5,"name":"ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/threadLocal.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜","name":"ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜","description":"ThreadLocalåŸç†","keywords":[" 1. ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ"," 2. ThreadLocalçš„å…·ä½“å®ç°"," 2.1 ThreadLocalç»“æ„  "," 2.2 å…·ä½“å®ç°"," 2.3 å¼•ç”¨å…³ç³»"," 2.3.1 threadLocalå¼•ç”¨å…³ç³»"," 2.3.2 æ‰©å±•"," 3. æºç è§£è¯»"," 3.1 ä»setæ–¹æ³•å¼€å§‹"," 3.2 ThreadLocalä¸­çš„get()"," 3.3 ThreadLocalMapä¸­çš„remove()"," 4. å†…å­˜æ³„éœ²"," 4.1 ThreadLocal å†…å­˜æ³„æ¼çš„åŸå› "," 4.2 ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•"," 4.3 æ€»ç»“"," 5. ä½¿ç”¨åœºæ™¯"," 5.1 åœºæ™¯ä¸€ï¼šä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’"," 5.2 åœºæ™¯äºŒï¼šè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜"," 5.3 åœºæ™¯ä¸‰ï¼šå…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯"," 6. å®æˆ˜"," 6.1 ä»£ç "," 6.2 å¼‚å¸¸å¤„ç†"," 6.2.1 feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´"," 6.2.2 å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´"," 7. æ‰©å±•"," 7.1 InheritableThreadLocal"," 7.2 TransmittableThreadLocal(TTL)"],"articleBody":"[toc]\n1. ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ ä»åå­—æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ThreadLocal å«åšæœ¬åœ°çº¿ç¨‹å˜é‡ï¼Œæ„æ€æ˜¯è¯´ï¼ŒThreadLocal ä¸­å¡«å……çš„çš„æ˜¯å½“å‰çº¿ç¨‹çš„å˜é‡ï¼Œè¯¥å˜é‡å¯¹å…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯å°é—­ä¸”éš”ç¦»çš„ï¼ŒThreadLocal ä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨çš„å‰¯æœ¬å˜é‡ã€‚\nç®€å•å®ç”¨\n@Test public void testThreadLocal() { ThreadLocal\u003cString\u003e local = new ThreadLocal\u003c\u003e(); IntStream.range(0, 10) .forEach(i -\u003e new Thread(() -\u003e { local.set(Thread.currentThread().getName() + \":\" + i); System.out.println(\"çº¿ç¨‹ï¼š\" + Thread.currentThread().getName() + \",local:\" + local.get()); }).start() ); } è¾“å‡ºç»“æœï¼š çº¿ç¨‹ï¼šThread-0,local:Thread-0:0 çº¿ç¨‹ï¼šThread-1,local:Thread-1:1 çº¿ç¨‹ï¼šThread-2,local:Thread-2:2 çº¿ç¨‹ï¼šThread-3,local:Thread-3:3 çº¿ç¨‹ï¼šThread-4,local:Thread-4:4 çº¿ç¨‹ï¼šThread-5,local:Thread-5:5 çº¿ç¨‹ï¼šThread-6,local:Thread-6:6 çº¿ç¨‹ï¼šThread-7,local:Thread-7:7 çº¿ç¨‹ï¼šThread-8,local:Thread-8:8 çº¿ç¨‹ï¼šThread-9,local:Thread-9:9 2. ThreadLocalçš„å…·ä½“å®ç° 2.1 ThreadLocalç»“æ„ æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª ThreadLocalMap ï¼› è¯¥ Map åº•å±‚ç”± Entry æ•°ç»„æ„æˆï¼Œå«æœ‰å¤šä¸ª Entry ï¼› Entry ä¸­ key ä¸º ThreadLocal çš„å¼±å¼•ç”¨ï¼Œ value ä¸ºæˆ‘ä»¬ä¿å­˜çš„å€¼ çº¿ç¨‹ä¸‹çš„threadLocalMap\npublic class Thread implements Runnable { /* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; /* * InheritableThreadLocal values pertaining to this thread. This map is * maintained by the InheritableThreadLocal class. */ ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; } 2.2 å…·ä½“å®ç° ä»ç»“æ„å¯ä»¥çœ‹å‡º, æ¯ä¸ªçº¿ç¨‹åœ¨å‘ThreadLocalé‡Œå¡å€¼çš„æ—¶å€™ï¼Œå…¶å®éƒ½æ˜¯å‘è‡ªå·±æ‰€æŒæœ‰çš„ThreadLocalMapé‡Œå¡å…¥æ•°æ®ï¼›è¯»çš„æ—¶å€™åŒç†ï¼Œé¦–å…ˆä»è‡ªå·±çº¿ç¨‹ä¸­å–å‡ºè‡ªå·±æŒæœ‰çš„ThreadLocalMapï¼Œç„¶åå†æ ¹æ®ThreadLocalå¼•ç”¨ä½œä¸ºkeyå–å‡ºvalueï¼ŒåŸºäºä»¥ä¸Šæè¿°ï¼ŒThreadLocalå®ç°äº†å˜é‡çš„çº¿ç¨‹éš”ç¦»ï¼ˆå½“ç„¶ï¼Œæ¯•ç«Ÿå˜é‡å…¶å®éƒ½æ˜¯ä»è‡ªå·±å½“å‰çº¿ç¨‹å®ä¾‹ä¸­å–å‡ºæ¥çš„ï¼‰ã€‚\næ‰€ä»¥åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­, ä¼šç”Ÿæˆ10ä¸ªmap, æ¯ä¸ªmapä¸­å°±åªæœ‰ä¸€ä¸ªå…ƒç´ , keyéƒ½æ˜¯localå˜é‡, valueæ˜¯çº¿ç¨‹åç§°\nç”±æ­¤çœ‹å‡º , threadLocalåº•å±‚ä½¿ç”¨mapç»“æ„å­˜å‚¨ä¿¡æ¯, keyä¸ºå½“å‰çš„çº¿ç¨‹ä¸‹çš„threadLocalå¯¹è±¡, value æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡å€¼\nå®ƒä¸hashMapæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„, æ¯”å¦‚ æ‰©å±•å› å­, åˆå§‹åŒ–å¤§å°ç­‰ç­‰, ä½†æ˜¯threadLocalè§£å†³hashå†²çªä½¿ç”¨çš„çº¿æ€§æ¢æµ‹\nè§£å†³å“ˆå¸Œå†²çªçš„å››ç§æ–¹æ³• 1.å¼€æ”¾åœ°å€æ–¹æ³•(å†æ•£åˆ—æ³•)\nå¯ä»¥é€šä¿—ç†è§£ä¸ºæ‰€æœ‰çš„åœ°å€éƒ½å¯¹æ‰€æœ‰çš„æ•°å€¼å¼€æ”¾ï¼Œè€Œä¸æ˜¯é“¾å¼åœ°å€æ³•çš„å°é—­æ–¹å¼ï¼Œä¸€ä¸ªæ•°å€¼å›ºå®šåœ¨ä¸€ä¸ªç´¢å¼•åœ°å€ä½ç½®ã€‚p1=hash(key)å¦‚æœå†²çªå°±åœ¨p1åœ°å€çš„åŸºç¡€ä¸Š+1æˆ–è€…æ•£åˆ—å¤„ç†ï¼Œp2=hash(p1)â€¦.\n(1ï¼‰çº¿æ€§æ¢æµ‹\næŒ‰é¡ºåºå†³å®šå€¼æ—¶ï¼Œå¦‚æœæŸæ•°æ®çš„å€¼å·²ç»å­˜åœ¨ï¼Œåˆ™åœ¨åŸæ¥å€¼çš„åŸºç¡€ä¸Šå¾€ååŠ ä¸€ä¸ªå•ä½ï¼Œç›´è‡³ä¸å‘ç”Ÿå“ˆå¸Œå†²çªã€‚\nï¼ˆ2ï¼‰å†å¹³æ–¹æ¢æµ‹\næŒ‰é¡ºåºå†³å®šå€¼æ—¶ï¼Œå¦‚æœæŸæ•°æ®çš„å€¼å·²ç»å­˜åœ¨ï¼Œåˆ™åœ¨åŸæ¥å€¼çš„åŸºç¡€ä¸Šå…ˆåŠ 1çš„å¹³æ–¹ä¸ªå•ä½ï¼Œè‹¥ä»ç„¶å­˜åœ¨åˆ™åŠ 1çš„å¹³æ–¹ä¸ªå•ä½ã€‚éšä¹‹æ˜¯2çš„å¹³æ–¹ï¼Œ3çš„å¹³æ–¹ç­‰ç­‰ã€‚ç›´è‡³ä¸å‘ç”Ÿå“ˆå¸Œå†²çªã€‚\nå’Œçº¿æ€§æ¢æµ‹ç›¸æ¯”å°±æ˜¯æ”¹å˜æ¢æµ‹äº†æ­¥é•¿ã€‚å› ä¸ºå¦‚æœéƒ½æ˜¯+1æ¥æ¢æµ‹åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œæ•ˆç‡ä¼šå¾ˆå·®ã€‚\n2.é“¾å¼åœ°å€æ³•\nå¯¹äºç›¸åŒçš„å€¼ï¼Œä½¿ç”¨é“¾è¡¨è¿›è¡Œè¿æ¥ã€‚ä½¿ç”¨æ•°ç»„å­˜å‚¨æ¯ä¸€ä¸ªé“¾è¡¨ã€‚ï¼ˆHashMapçš„å“ˆå¸Œå†²çªè§£å†³æ–¹æ³•ï¼‰\n3.å»ºç«‹å…¬å…±æº¢å‡ºåŒº\nå»ºç«‹å…¬å…±æº¢å‡ºåŒºå­˜å‚¨æ‰€æœ‰å“ˆå¸Œå†²çªçš„æ•°æ®ã€‚\n4.å†å“ˆå¸Œæ³•\nå¯¹äºå†²çªçš„å“ˆå¸Œå€¼å†æ¬¡è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç›´è‡³æ²¡æœ‰å“ˆå¸Œå†²çªã€‚\nä¸€æ–‡ç†è§£å“ˆå¸Œå†²çªå››ç§è§£å†³æ–¹æ³• - ç®€ä¹¦ (jianshu.com) 2.3 å¼•ç”¨å…³ç³» 2.3.1 threadLocalå¼•ç”¨å…³ç³» å¼•ç”¨å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š\nåœ¨æ•´ä¸ªå¼•ç”¨é“¾è·¯ä¸­ï¼Œåªæœ‰ ThreadLocal æ˜¯é‡‡ç”¨äº†å¼±å¼•ç”¨çš„æ–¹å¼è¿›è¡Œå£°æ˜çš„ã€‚\n2.3.2 æ‰©å±• Java ä¸­å¼•ç”¨æœ‰å››ç§æ–¹å¼ã€‚\nå¼ºå¼•ç”¨ï¼š é€šè¿‡ new å…³é”®å­—äº§ç”Ÿçš„å¼•ç”¨å…³ç³»ï¼Œæ— è®ºä»»ä½•æƒ…å†µä¸‹ï¼Œåªè¦å¼ºå¼•ç”¨å…³ç³»è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ï¼›\nè½¯å¼•ç”¨ï¼š SoftReference å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œå‘ç”ŸGC, åƒåœ¾å›æ”¶å™¨å°±ä¼šå›æ”¶å®ƒ, å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚\nå¼±å¼•ç”¨ï¼š å£°æ˜æ—¶ï¼Œé€šè¿‡ WeakReference åŒ…è£¹ï¼Œå¼ºåº¦æ¯”è½¯å¼•ç”¨æ›´å¼±ä¸€äº›ï¼Œè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¸ºæ­¢ã€‚å½“åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚\nè™šå¼•ç”¨ï¼šè™šå¼•ç”¨ä¹Ÿç§°ä¸ºâ€œå¹½çµå¼•ç”¨â€æˆ–è€…â€œå¹»å½±å¼•ç”¨â€ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„ å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™š å¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åªæ˜¯ä¸ºäº†èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚\nJavaä¸­æä¾›è¿™å››ç§å¼•ç”¨ç±»å‹ä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ ï¼š\nå¯ä»¥è®©ç¨‹åºå‘˜é€šè¿‡ä»£ç çš„æ–¹å¼å†³å®šæŸäº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ æœ‰åˆ©äºJVMè¿›è¡Œåƒåœ¾å›æ”¶ã€‚ jvmå†…å­˜å›æ”¶å‰æ JVM åƒåœ¾å›æ”¶è¯¦è§£-å¼•ç”¨ç±»å‹ | JavaGuide 3. æºç è§£è¯» 3.1 ä»setæ–¹æ³•å¼€å§‹ å› ä¸ºsetæ˜¯çº¿ç¨‹çº§åˆ«çš„, æ‰€æœ‰çš„æ“ä½œéƒ½åœ¨å½“å‰çº¿ç¨‹ä¸‹, æ‰€ä»¥setæ“ä½œæœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„\nThreadLocal.set(T value)\npublic void set(T value) { Thread t = Thread.currentThread(); // è·å–å½“å‰çº¿ç¨‹ ThreadLocalMap map = getMap(t);// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap if (map != null) map.set(this, value);// mapä¸ä¸ºç©ºåˆ™è°ƒç”¨mapçš„setæ–¹æ³• else createMap(t, value);// mapä¸ºç©ºåˆ™è°ƒç”¨createMapæ–¹æ³• } å…ˆçœ‹çœ‹ map ä¸ºç©ºæ—¶ï¼Œ createMap æ–¹æ³•æ˜¯æ€ä¹ˆåˆ›å»º map çš„ã€‚\nThreadLocal.createMap(Thread t, T firstValue)\nvoid createMap(Thread t, T firstValue) { // ä¸ºä¼ å…¥çš„çº¿ç¨‹å®ä¾‹åŒ–ä¸€ä¸ªmapï¼Œä¼ å…¥äº†è‡ªèº«çš„å¼•ç”¨ t.threadLocals = new ThreadLocalMap(this, firstValue); } /** * æ„é€ ä¸€ä¸ªæœ€åˆåŒ…å« (firstKey, firstValue) çš„æ–°æ˜ å°„ã€‚ * ThreadLocalMaps æ˜¯æƒ°æ€§æ„å»ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæœ‰åœ¨è‡³å°‘æœ‰ä¸€ä¸ªæ¡ç›®å¯ä»¥æ”¾å…¥æ—¶æ‰åˆ›å»ºä¸€ä¸ªã€‚ */ ThreadLocalMap(ThreadLocal\u003c?\u003e firstKey, Object firstValue) { table = new Entry[INITIAL_CAPACITY]; int i = firstKey.threadLocalHashCode \u0026 (INITIAL_CAPACITY - 1); table[i] = new Entry(firstKey, firstValue); size = 1; setThreshold(INITIAL_CAPACITY); } è¯¥æ„é€ æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹æ“ä½œï¼š\nåˆ›å»ºä¸€ä¸ªé»˜è®¤é•¿åº¦çš„ Entry æ•°ç»„ è®¡ç®—å‡ºä¼ å…¥çš„ ThreadLocal åº”åœ¨æ•°ç»„ä¸­çš„ä½ç½® å®ä¾‹åŒ– Entry æ”¾åˆ°å¯¹åº”ä½ç½®ä¸Š ThreadLocalMap å…ƒç´ æ•°ç½®ä¸º1 è®¾ç½®è¦è°ƒæ•´å¤§å°çš„ä¸‹ä¸€ä¸ªå€¼ æˆ‘ä»¬çœ‹çœ‹ ThreadLocalMap çš„åŸºç¡€ä¿¡æ¯ï¼›\n/** * åˆå§‹å®¹é‡ - å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ */ private static final int INITIAL_CAPACITY = 16; /** * table,é•¿åº¦å¿…é¡»ä¸º 2 çš„å¹‚æ¬¡æ–¹ */ private Entry[] table; /** * tableä¸­å…ƒç´ çš„ä¸ªæ•° */ private int size = 0; /** * è¦è°ƒæ•´å¤§å°çš„ä¸‹ä¸€ä¸ªå¤§å°å€¼ã€‚ */ private int threshold; // é»˜è®¤å€¼ä¸º 0 /** * Entryå¯¹è±¡ç»§æ‰¿äº†å¼±å¼•ç”¨(å½“å‘ç”Ÿåƒåœ¾å›æ”¶æ—¶å°±ä¼šå›æ”¶) */ static class Entry extends WeakReference\u003cThreadLocal\u003c?\u003e\u003e { /** The value associated with this ThreadLocal. */ Object value; Entry(ThreadLocal\u003c?\u003e k, Object v) { super(k); value = v; } } ä¸»è¦è¯´ä¸€ä¸‹è®¡ç®—ç´¢å¼•ï¼ŒfirstKey.threadLocalHashCode \u0026 (INITIAL_CAPACITY - 1)ã€‚\nå…³äº\u0026 (INITIAL_CAPACITY - 1),è¿™æ˜¯å–æ¨¡çš„ä¸€ç§æ–¹å¼ï¼Œå¯¹äº2çš„å¹‚ä½œä¸ºæ¨¡æ•°å–æ¨¡ï¼Œç”¨æ­¤ä»£æ›¿%(2^n)ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥å®¹é‡å¿…é¡»ä¸º2çš„å†¥ï¼Œåœ¨è¿™ä¸ªåœ°æ–¹ä¹Ÿå¾—åˆ°äº†è§£ç­”ï¼Œè‡³äºä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·è¿™é‡Œä¸è¿‡å¤šè§£é‡Šï¼ŒåŸç†å¾ˆç®€å•ã€‚\nå…³äºfirstKey.threadLocalHashCodeï¼š\nprivate final int threadLocalHashCode = nextHashCode(); private static int nextHashCode() { return nextHashCode.getAndAdd(HASH_INCREMENT); } private static AtomicInteger nextHashCode = new AtomicInteger(); private static final int HASH_INCREMENT = 0x61c88647; å®šä¹‰äº†ä¸€ä¸ªAtomicIntegerç±»å‹ï¼Œæ¯æ¬¡è·å–å½“å‰å€¼å¹¶åŠ ä¸ŠHASH_INCREMENTï¼ŒHASH_INCREMENT = 0x61c88647,å…³äºè¿™ä¸ªå€¼å’Œæ–æ³¢é‚£å¥‘æ•£åˆ—æœ‰å…³ï¼Œå…¶ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†è®©å“ˆå¸Œç èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨2çš„næ¬¡æ–¹çš„æ•°ç»„é‡Œ, ä¹Ÿå°±æ˜¯Entry[] tableä¸­ã€‚\nå¸¸è§çš„æ•£åˆ—æ–¹æ³•æ˜¯å–æ¨¡æ•£åˆ—, è€Œæ–æ³¢é‚£å¥‘æ•£åˆ—æ˜¯å¦ä¸€ç§æ•£åˆ—æ–¹æ³•\nä» ThreadLocal çš„å®ç°çœ‹æ•£åˆ—ç®—æ³• - çŸ¥ä¹ (zhihu.com) å†çœ‹å›setæ–¹æ³•\nThreadLocalMap.set(ThreadLocal\u003c?\u003e key, Object value)\nThreadLocalMapä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³å“ˆå¸Œå†²çªï¼Œçº¿æ€§æ¢æµ‹æ³•çš„åœ°å€å¢é‡di = 1, 2, â€¦ , m-1ï¼Œå…¶ä¸­ï¼Œiä¸ºæ¢æµ‹æ¬¡æ•°ã€‚è¯¥æ–¹æ³•ä¸€æ¬¡æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ•´ä¸ªç©ºé—´éƒ½æ‰¾ä¸åˆ°ç©ºä½™çš„åœ°å€ï¼Œåˆ™äº§ç”Ÿæº¢å‡ºã€‚å‡è®¾å½“å‰tableé•¿åº¦ä¸º16ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè®¡ç®—å‡ºæ¥keyçš„hashå€¼ä¸º14ï¼Œå¦‚æœtable[14]ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶keyä¸å½“å‰keyä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº†hashå†²çªï¼Œè¿™ä¸ªæ—¶å€™å°†14åŠ 1å¾—åˆ°15ï¼Œå–table[15]è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ°0ï¼Œå–table[0],ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ã€‚æ‰€ä»¥ å¯ä»¥æŠŠtableçœ‹æˆä¸€ä¸ªç¯å½¢æ•°ç»„ã€‚\nåœ¨setçš„æ—¶å€™, ä¼šå»åˆ¤æ–­ entry==null å’Œ key==nullçš„å“ˆå¸Œæ§½, å¹¶åˆ é™¤è¿™äº›æ§½ä½, ç”±äºä½¿ç”¨çº¿æ€§æ¢æµ‹æ–¹å¼, è¿˜ä¼šæŒªåŠ¨å†²çªçš„keyçš„ä½ç½®, ä½¿å¾—ç›¸åŒkeyç´§å‡‘ä¸€èµ·\nprivate void set(ThreadLocal\u003c?\u003e key, Object value) { // We don't use a fast path as with get() because it is at // least as common to use set() to create new entries as // it is to replace existing ones, in which case, a fast // path would fail more often than not. Entry[] tab = table; int len = tab.length; // è·å–ThreadLocalçš„hashCodeï¼Œè®¡ç®—ç´¢å¼•ä½ç½® int i = key.threadLocalHashCode \u0026 (len-1); // è¯¥ç´¢å¼•ä½ç½®ä¸Šæ˜¯å¦æœ‰å…ƒç´ ï¼Œå¦‚æœæœ‰å…ƒç´ çš„è¯å°±è¿›è¡Œçº¿æ€§æ¢æµ‹ for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) { ThreadLocal\u003c?\u003e k = e.get(); // è¯´æ˜è¯¥keyå·²ç»å­˜åœ¨ï¼Œåˆ™è¦†ç›–æ—§å€¼ if (k == key) { e.value = value; return; } /** * table[i]ä¸Šçš„keyä¸ºç©ºï¼Œè¯´æ˜è¢«å›æ”¶äº†ï¼ˆä¸Šé¢çš„å¼±å¼•ç”¨ä¸­æåˆ°è¿‡ï¼‰ã€‚ * è¿™ä¸ªæ—¶å€™è¯´æ˜æ”¹table[i]å¯ä»¥é‡æ–°ä½¿ç”¨ï¼Œç”¨æ–°çš„key-valueå°†å…¶æ›¿æ¢,å¹¶åˆ é™¤å…¶ä»–æ— æ•ˆçš„entry */ if (k == null) { replaceStaleEntry(key, value, i); return; } } // è¯¥ç´¢å¼•ä½ç½®ä¸Šæ²¡æœ‰å…ƒç´ ï¼Œåˆ™æ–°å»ºEntry tab[i] = new Entry(key, value); int sz = ++size; // ä¸éœ€è¦æ¸…ç† ç©ºå“ˆå¸Œæ§½æˆ–è€…æ§½keyä¸ºnullçš„ï¼Œ å¹¶ä¸”å¤§äºç­‰äºæ‰©å®¹å€¼ï¼Œåˆ™è¿›è¡Œrehashï¼Œ if (!cleanSomeSlots(i, sz) \u0026\u0026 sz \u003e= threshold) // é»˜è®¤16ï¼Œä»¥2çš„å€æ•°æ‰©å®¹ rehash(); } /**java /** * è·å–ç¯å½¢æ•°ç»„çš„ä¸‹ä¸€ä¸ªç´¢å¼• */ private static int nextIndex(int i, int len) { return ((i + 1 \u003c len) ? i + 1 : 0); } /** * è·å–ç¯å½¢æ•°ç»„çš„ä¸Šä¸€ä¸ªç´¢å¼• */ private static int prevIndex(int i, int len) { return ((i - 1 \u003e= 0) ? i - 1 : len - 1); } replaceStaleEntry(ThreadLocal\u003c?\u003e key, Object value, int staleSlot)\n// å¥½å¤æ‚, çœ‹çœ‹ç½‘ä¸Šæ–‡ç« ,ä»¥åæ·±å…¥äº†è§£å§\nThreadLocalæºç åˆ†æ - ç®€ä¹¦ (jianshu.com) 3.2 ThreadLocalä¸­çš„get() public T get() { //åŒsetæ–¹æ³•ç±»ä¼¼è·å–å¯¹åº”çº¿ç¨‹ä¸­çš„ThreadLocalMapå®ä¾‹ Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) { @SuppressWarnings(\"unchecked\") T result = (T)e.value; return result; } } //ä¸ºç©ºè¿”å›åˆå§‹åŒ–å€¼ return setInitialValue(); } /** * åˆå§‹åŒ–è®¾å€¼çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«å­ç±»è¦†ç›–ã€‚ */ protected T initialValue() { return null; } private T setInitialValue() { //è·å–åˆå§‹åŒ–å€¼ï¼Œé»˜è®¤ä¸ºnull(å¦‚æœæ²¡æœ‰å­ç±»è¿›è¡Œè¦†ç›–) T value = initialValue(); Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); //ä¸ä¸ºç©ºä¸ç”¨å†åˆå§‹åŒ–ï¼Œç›´æ¥è°ƒç”¨setæ“ä½œè®¾å€¼ if (map != null) map.set(this, value); else //ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼ŒcreateMapåœ¨ä¸Šé¢ä»‹ç»set()çš„æ—¶å€™æœ‰ä»‹ç»è¿‡ã€‚ createMap(t, value); return value; } ThreadLocalMapä¸­çš„getEntry()\nprivate ThreadLocal.ThreadLocalMap.Entry getEntry(ThreadLocal\u003c?\u003e key) { //æ ¹æ®keyè®¡ç®—ç´¢å¼•ï¼Œè·å–entry int i = key.threadLocalHashCode \u0026 (table.length - 1); ThreadLocal.ThreadLocalMap.Entry e = table[i]; if (e != null \u0026\u0026 e.get() == key) return e; else return getEntryAfterMiss(key, i, e); } /** * é€šè¿‡ç›´æ¥è®¡ç®—å‡ºæ¥çš„keyæ‰¾ä¸åˆ°å¯¹äºçš„valueçš„æ—¶å€™é€‚ç”¨è¿™ä¸ªæ–¹æ³•. */ private ThreadLocal.ThreadLocalMap.Entry getEntryAfterMiss(ThreadLocal\u003c?\u003e key, int i, ThreadLocal.ThreadLocalMap.Entry e) { ThreadLocal.ThreadLocalMap.Entry[] tab = table; int len = tab.length; while (e != null) { ThreadLocal\u003c?\u003e k = e.get(); if (k == key) return e; if (k == null) //æ¸…é™¤æ— æ•ˆçš„entry expungeStaleEntry(i); else //åŸºäºçº¿æ€§æ¢æµ‹æ³•å‘åæ‰«æ i = nextIndex(i, len); e = tab[i]; } return null; } 3.3 ThreadLocalMapä¸­çš„remove() private void remove(ThreadLocal\u003c?\u003e key) { ThreadLocal.ThreadLocalMap.Entry[] tab = table; int len = tab.length; //è®¡ç®—ç´¢å¼• int i = key.threadLocalHashCode \u0026 (len-1); //è¿›è¡Œçº¿æ€§æ¢æµ‹ï¼ŒæŸ¥æ‰¾æ­£ç¡®çš„key for (ThreadLocal.ThreadLocalMap.Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) { if (e.get() == key) { //è°ƒç”¨weakrefrenceçš„clear()æ¸…é™¤å¼•ç”¨ e.clear(); //è¿ç»­æ®µæ¸…é™¤ expungeStaleEntry(i); return; } } } 4. å†…å­˜æ³„éœ² 4.1 ThreadLocal å†…å­˜æ³„æ¼çš„åŸå›  ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒhreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalä¸å­˜åœ¨å¤–éƒ¨å¼ºå¼•ç”¨æ—¶ï¼ŒKey(ThreadLocal)åŠ¿å¿…ä¼šè¢«GCå›æ”¶ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ThreadLocalMapä¸­keyä¸ºnullï¼Œ è€Œvalueè¿˜å­˜åœ¨ç€å¼ºå¼•ç”¨ï¼Œåªæœ‰theadçº¿ç¨‹é€€å‡ºä»¥å,valueçš„å¼ºå¼•ç”¨é“¾æ¡æ‰ä¼šæ–­æ‰ã€‚\nä½†å¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼š\nThread Ref -\u003e Thread -\u003e ThreaLocalMap -\u003e Entry -\u003e value\næ°¸è¿œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚, æ‰€ä»¥æ³„éœ²çš„æ˜¯valueå€¼\n4.2 ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³• æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocaléƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•æ¸…é™¤æ•°æ® å…¶å®è°ƒç”¨set()å’Œget() éƒ½æœ‰å¯èƒ½ä¹Ÿä¼šæ¸…é™¤æ•°æ®\nThreadLocalä¼šåœ¨ä»¥ä¸‹è¿‡ç¨‹ä¸­æ¸…ç†è¿‡æœŸèŠ‚ç‚¹ï¼š\nè°ƒç”¨set()æ–¹æ³•æ—¶ï¼Œé‡‡æ ·æ¸…ç†ã€å…¨é‡æ¸…ç†ï¼Œæ‰©å®¹æ—¶è¿˜ä¼šç»§ç»­æ£€æŸ¥ã€‚ è°ƒç”¨get()æ–¹æ³•ï¼Œæ²¡æœ‰ç›´æ¥å‘½ä¸­ï¼Œå‘åç¯å½¢æŸ¥æ‰¾æ—¶ã€‚ è°ƒç”¨remove()æ—¶ï¼Œé™¤äº†æ¸…ç†å½“å‰Entryï¼Œè¿˜ä¼šå‘åç»§ç»­æ¸…ç†ã€‚ ä½¿ç”¨ThreadLocalæ—¶ï¼Œä¸€èˆ¬å»ºè®®å°†å…¶å£°æ˜ä¸ºstatic finalçš„ï¼Œé¿å…é¢‘ç¹åˆ›å»ºThreadLocalå®ä¾‹ã€‚ 4.3 æ€»ç»“ ç”±äºThreadä¸­åŒ…å«å˜é‡ThreadLocalMapï¼Œå› æ­¤ThreadLocalMapä¸Threadçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·é•¿ï¼Œå¦‚æœéƒ½æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyï¼Œéƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚\nä½†æ˜¯ä½¿ç”¨å¼±å¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœï¼šå¼±å¼•ç”¨ThreadLocalä¸ä¼šå†…å­˜æ³„æ¼ï¼Œå¯¹åº”çš„valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨set(),get(),remove()çš„æ—¶å€™ä¼šè¢«æ¸…é™¤ã€‚\nå› æ­¤ï¼ŒThreadLocalå†…å­˜æ³„æ¼çš„æ ¹æºæ˜¯ï¼šç”±äºThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè€Œä¸æ˜¯å› ä¸ºå¼±å¼•ç”¨ã€‚\nThreadLocalçš„å†…å­˜æ³„éœ²ï¼Ÿä»€ä¹ˆåŸå› ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ - çŸ¥ä¹ (zhihu.com) 5. ä½¿ç”¨åœºæ™¯ 5.1 åœºæ™¯ä¸€ï¼šä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’ å½“æˆ‘ä»¬åœ¨å†™APIæ¥å£çš„æ—¶å€™ï¼Œé€šå¸¸Controllerå±‚ä¼šæ¥å—æ¥è‡ªå‰ç«¯çš„å…¥å‚ï¼Œå½“è¿™ä¸ªæ¥å£åŠŸèƒ½æ¯”è¾ƒå¤æ‚çš„æ—¶å€™ï¼Œå¯èƒ½æˆ‘ä»¬è°ƒç”¨çš„Serviceå±‚å†…éƒ¨è¿˜è°ƒç”¨äº† å¾ˆå¤šå…¶ä»–çš„å¾ˆå¤šæ–¹æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¯ä¸ªè°ƒç”¨çš„æ–¹æ³•ä¸ŠåŠ ä¸Šéœ€è¦ä¼ é€’çš„å‚æ•°ã€‚\nä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†å‚æ•°å­˜å…¥ThreadLocalä¸­ï¼Œé‚£ä¹ˆå°±ä¸ç”¨æ˜¾å¼çš„ä¼ é€’å‚æ•°äº†ï¼Œè€Œæ˜¯åªéœ€è¦ThreadLocalä¸­è·å–å³å¯ã€‚\nè¿™ä¸ªåœºæ™¯å…¶å®ä½¿ç”¨çš„æ¯”è¾ƒå°‘ï¼Œä¸€æ–¹é¢æ˜¾å¼ä¼ å‚æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå¦ä¸€æ–¹é¢æˆ‘ä»¬å¯ä»¥å°†å¤šä¸ªå‚æ•°å°è£…ä¸ºå¯¹è±¡å»ä¼ é€’ã€‚\n5.2 åœºæ™¯äºŒï¼šè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ åœ¨Springçš„Webé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†ä¸šåŠ¡åˆ†ä¸ºControllerå±‚ï¼ŒServiceå±‚ï¼ŒDaoå±‚ï¼Œ æˆ‘ä»¬éƒ½çŸ¥é“@Autowiredæ³¨è§£é»˜è®¤ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œé‚£ä¹ˆä¸åŒè¯·æ±‚çº¿ç¨‹è¿›æ¥ä¹‹åï¼Œç”±äºDaoå±‚ä½¿ç”¨å•ä¾‹ï¼Œé‚£ä¹ˆè´Ÿè´£æ•°æ®åº“è¿æ¥çš„Connectionä¹Ÿåªæœ‰ä¸€ä¸ªï¼Œ å¦‚æœæ¯ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½å»è¿æ¥æ•°æ®åº“ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆçº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ï¼ŒSpringæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ\nåœ¨Springé¡¹ç›®ä¸­Daoå±‚ä¸­è£…é…çš„Connectionè‚¯å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…¶è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡‡ç”¨ThreadLocalæ–¹æ³•ï¼Œå½“æ¯ä¸ªè¯·æ±‚çº¿ç¨‹ä½¿ç”¨Connectionçš„æ—¶å€™ï¼Œ éƒ½ä¼šä»ThreadLocalè·å–ä¸€æ¬¡ï¼Œå¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰è¿›è¡Œè¿‡æ•°æ®åº“è¿æ¥ï¼Œè¿æ¥åå­˜å…¥ThreadLocalä¸­ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½ä¿å­˜æœ‰ä¸€ä»½ è‡ªå·±çš„Connectionã€‚äºæ˜¯ä¾¿è§£å†³äº†çº¿ç¨‹å®‰å…¨é—®é¢˜\nThreadLocalåœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯ä¸ºè§£å†³å¹¶å‘é—®é¢˜è€Œæä¾›ä¸€ç§æ–¹æ¡ˆï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä»½è‡ªå·±çš„æ•°æ®ï¼Œè¾¾åˆ°çº¿ç¨‹éš”ç¦»çš„æ•ˆæœã€‚\n5.3 åœºæ™¯ä¸‰ï¼šå…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ åœ¨ç°åœ¨çš„ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œå‰åç«¯åˆ†ç¦»å·²åŸºæœ¬æˆä¸ºå¸¸æ€ï¼Œåˆ†ç¦»ä¹‹åå¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯å°±æˆäº†ä¸€ä»¶éº»çƒ¦äº‹ï¼Œé€šå¸¸åœ¨ç”¨æˆ·ç™»å½•åï¼Œ ç”¨æˆ·ä¿¡æ¯ä¼šä¿å­˜åœ¨Sessionæˆ–è€…Tokenä¸­ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¦‚æœä½¿ç”¨å¸¸è§„çš„æ‰‹æ®µå»è·å–ç”¨æˆ·ä¿¡æ¯ä¼šå¾ˆè´¹åŠ²ï¼Œæ‹¿Sessionæ¥è¯´ï¼Œæˆ‘ä»¬è¦åœ¨æ¥å£å‚æ•°ä¸­åŠ ä¸ŠHttpServletRequestå¯¹è±¡ï¼Œç„¶åè°ƒç”¨ getSessionæ–¹æ³•ï¼Œä¸”æ¯ä¸€ä¸ªéœ€è¦ç”¨æˆ·ä¿¡æ¯çš„æ¥å£éƒ½è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œæ‰èƒ½è·å–Sessionï¼Œè¿™æ ·å®ç°å°±å¾ˆéº»çƒ¦äº†ã€‚\nåœ¨å®é™…çš„ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šä¸ä¼šé‡‡ç”¨ä¸Šé¢æ‰€è¯´çš„è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ä½¿ç”¨ThreadLocalï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©åœ¨æ‹¦æˆªå™¨çš„ä¸šåŠ¡ä¸­ï¼Œ è·å–åˆ°ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åå­˜å…¥ThreadLocalï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹åœ¨ä»»ä½•åœ°æ–¹å¦‚æœéœ€è¦æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯éƒ½å¯ä»¥ä½¿ç”¨ThreadLocalçš„get()æ–¹æ³•\n(å¼‚æ­¥ç¨‹åºä¸­ThreadLocalæ˜¯ä¸å¯é çš„, å› ä¸ºthreadLocalæ˜¯çº¿ç¨‹çº§åˆ«çš„, æ‰€ä»¥åªè¦å¼€äº†æ–°çº¿ç¨‹éƒ½ä¼šä¸¢å¤±ä¿¡æ¯\nä¾‹å¦‚, ä½¿ç”¨äº†çº¿ç¨‹æ± , future, feginè°ƒç”¨ å°±ä¼šä¸¢å¤±threadlocalé‡Œçš„æ•°æ®(é™¤éthreadLocalæ˜¯å…¨å±€çš„)\n6. å®æˆ˜ 6.1 ä»£ç  å…·ä½“å®ç°æµç¨‹ï¼š\nåœ¨ç™»å½•ä¸šåŠ¡ä»£ç ä¸­ï¼Œå½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œç”Ÿæˆä¸€ä¸ªç™»å½•å‡­è¯å­˜å‚¨åˆ°redisä¸­ï¼Œå°†å‡­è¯ä¸­çš„å­—ç¬¦ä¸²ä¿å­˜åœ¨cookieä¸­è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ä½¿ç”¨ä¸€ä¸ªæ‹¦æˆªå™¨æ‹¦æˆªè¯·æ±‚ï¼Œä»cookieä¸­è·å–å‡­è¯å­—ç¬¦ä¸²ä¸redisä¸­çš„å‡­è¯è¿›è¡ŒåŒ¹é…ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°ThreadLocalä¸­ï¼Œåœ¨æœ¬æ¬¡è¯·æ±‚ä¸­æŒæœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå³å¯åœ¨åç»­æ“ä½œä¸­ä½¿ç”¨åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚ å®šä¹‰å·¥å…·ç±»æ“ä½œ[ThreadLocal]ï¼ˆå­˜æ”¾ï¼Œè·å–ï¼Œåˆ é™¤ç”¨æˆ·ä¿¡æ¯ï¼‰\npublic class ThreadLocalUtil { /** * ä¿å­˜ç”¨æˆ·å¯¹è±¡çš„ThreadLocal åœ¨æ‹¦æˆªå™¨æ“ä½œ æ·»åŠ ã€åˆ é™¤ç›¸å…³ç”¨æˆ·æ•°æ® */ private static final ThreadLocal\u003cFeginUser\u003e userThreadLocal = new ThreadLocal\u003cFeginUser\u003e(); /** * æ·»åŠ å½“å‰ç™»å½•ç”¨æˆ·æ–¹æ³• åœ¨æ‹¦æˆªå™¨æ–¹æ³•æ‰§è¡Œå‰è°ƒç”¨è®¾ç½®è·å–ç”¨æˆ· * @param user */ public static void addCurrentUser(FeginUser user){ userThreadLocal.set(user); } /** * è·å–å½“å‰ç™»å½•ç”¨æˆ·æ–¹æ³• */ public static FeginUser getCurrentUser(){ return userThreadLocal.get(); } /** * åˆ é™¤å½“å‰ç™»å½•ç”¨æˆ·æ–¹æ³• åœ¨æ‹¦æˆªå™¨æ–¹æ³•æ‰§è¡Œå ç§»é™¤å½“å‰ç”¨æˆ·å¯¹è±¡ */ public static void remove(){ userThreadLocal.remove(); } } æ‹¦æˆªå™¨\n@Component @Slf4j public class UserInfoInterceptor implements HandlerInterceptor { @Autowired private UserInfoUtil userInfoUtil; /** * è¯·æ±‚æ‰§è¡Œå‰æ‰§è¡Œçš„ï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ”¾å…¥ThreadLocal * @param request * @param response * @param handler * @return * @throws Exception */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { FeginUser user; try{ user = userInfoUtil.getUser(request); }catch (CustomException e){ log.info(\"***************************ç”¨æˆ·æœªç™»å½•ï¼Œ ThreadLocalæ— ä¿¡æ¯***************************\"); return true; } if (null!=user) { log.info(\"***************************ç”¨æˆ·å·²ç™»å½•ï¼Œç”¨æˆ·ä¿¡æ¯æ”¾å…¥ThreadLocal***************************\"); ThreadLocalUtil.addCurrentUser(user); return true; } log.info(\"***************************ç”¨æˆ·æœªç™»å½•ï¼Œ ThreadLocalæ— ä¿¡æ¯***************************\"); return true; } /** * æ¥å£è®¿é—®ç»“æŸåï¼Œä»ThreadLocalä¸­åˆ é™¤ç”¨æˆ·ä¿¡æ¯ * @param request * @param response * @param handler * @param ex * @throws Exception */ @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { log.info(\"***************************æ¥å£è°ƒç”¨ç»“æŸï¼Œ ä»ThreadLocalåˆ é™¤ç”¨æˆ·ä¿¡æ¯***************************\"); ThreadLocalUtil.remove(); } 6.2 å¼‚å¸¸å¤„ç† 6.2.1 feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´ ä»è¯·æ±‚å¤´ä¸­è·å–ç™»å½•token, ä¼šæœ‰ä¸ªé—®é¢˜, å¦‚æœä¸Šæ¸¸æ˜¯feginè°ƒç”¨, åˆ™è¯·æ±‚å¤´ä¼šä¸¢å¤±, æ‰€ä»¥éœ€è¦åœ¨feginè°ƒç”¨æ—¶æ‰‹åŠ¨è®¾ç½®token, å› ä¸ºfeignè°ƒç”¨ä¼šä½¿ç”¨æ–°çš„httpè¯·æ±‚ä¸”ä¸ä¼šæºå¸¦åŸæ¥httpçš„headerä¿¡æ¯\n@Bean public RequestInterceptor requestInterceptor() { //å¤„ç†feignè¿œç¨‹è°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´é—®é¢˜ return template -\u003e { HttpRequestUtil.getHttpHeader(Constant.AUTHORIZATION) .ifPresent(auth -\u003e template.header(Constant.AUTHORIZATION, auth)); HttpRequestUtil.getHttpHeader(Constant.POWER_MENU_ID) .ifPresent(auth -\u003e template.header(Constant.POWER_MENU_ID, auth)); HttpRequestUtil.getHttpHeader(Constant.X_FLAG) .ifPresent(auth -\u003e template.header(Constant.X_FLAG, auth)); HttpRequestUtil.getHttpHeader(Constant.PLATFORM_FLAG) .ifPresent(auth -\u003e template.header(Constant.PLATFORM_FLAG, auth)); }; } 6.2.2 å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´ å› ä¸ºthreadLocalæ˜¯çº¿ç¨‹å†…éƒ¨çš„, ä½¿ç”¨å¤šçº¿ç¨‹åthreadLocalä¼šä¸å†æœ‰æ•°æ®\nè§£å†³æ–¹æ¡ˆ:\næ‰‹åŠ¨ä¸ºå­çº¿ç¨‹é‡Œçš„requstè®¾ç½®è¯·æ±‚å¤´ ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆ, å°†threadLocalä¸­çš„æ•°æ®åœ¨å­çº¿ç¨‹ä¸­å†è®¾ç½®ä¸€é è·å–ç”¨æˆ·ä¿¡æ¯å·¥å…·ç±» spring security æ¡†æ¶é»˜è®¤ä¹Ÿæ²¡æœ‰è§£å†³\nspring security å¦‚ä½•åœ¨å­çº¿ç¨‹ä¸­è·å–çˆ¶çº¿ç¨‹ä¸­çš„ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼ˆæ›´æ”¹å®‰å…¨ç­–ç•¥ï¼‰ - precedeforetime - åšå®¢å›­ (cnblogs.com) 7. æ‰©å±• 7.1 InheritableThreadLocal InheritableThreadLocalç±»ç»§æ‰¿å¹¶é‡å†™äº†ThreadLocalçš„3ä¸ªå‡½æ•°ï¼š\npublic class InheritableThreadLocal\u003cT\u003e extends ThreadLocal\u003cT\u003e { /** * è¯¥å‡½æ•°åœ¨çˆ¶çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹ï¼Œå‘å­çº¿ç¨‹å¤åˆ¶InheritableThreadLocalå˜é‡æ—¶ä½¿ç”¨ */ protected T childValue(T parentValue) { return parentValue; } /** * ç”±äºé‡å†™äº†getMapï¼Œæ“ä½œInheritableThreadLocalæ—¶ï¼Œ * å°†åªå½±å“Threadç±»ä¸­çš„inheritableThreadLocalså˜é‡ï¼Œ * ä¸threadLocalså˜é‡ä¸å†æœ‰å…³ç³» */ ThreadLocalMap getMap(Thread t) { return t.inheritableThreadLocals; } /** * ç±»ä¼¼äºgetMapï¼Œæ“ä½œInheritableThreadLocalæ—¶ï¼Œ * å°†åªå½±å“Threadç±»ä¸­çš„inheritableThreadLocalså˜é‡ï¼Œ * ä¸threadLocalså˜é‡ä¸å†æœ‰å…³ç³» */ void createMap(Thread t, T firstValue) { t.inheritableThreadLocals = new ThreadLocalMap(this, firstValue); } } çº¿ç¨‹é—´ä¼ å€¼å®ç°åŸç†\nçº¿ç¨‹åˆå§‹åŒ–æ—¶å°†æ•°æ®ä» inheritableThreadLocals å–å‡ºå¹¶è®¾ç½®\nthreadç±»\npublic class Thread implements Runnable { ......(å…¶ä»–æºç ) /* * å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼Œä¸»è¦å­˜å‚¨è¯¥çº¿ç¨‹è‡ªèº«çš„ThreadLocal */ ThreadLocal.ThreadLocalMap threadLocals = null; /* * InheritableThreadLocalï¼Œè‡ªçˆ¶çº¿ç¨‹é›†æˆè€Œæ¥çš„ThreadLocalMapï¼Œ * ä¸»è¦ç”¨äºçˆ¶å­çº¿ç¨‹é—´ThreadLocalå˜é‡çš„ä¼ é€’ * æœ¬æ–‡ä¸»è¦è®¨è®ºçš„å°±æ˜¯è¿™ä¸ªThreadLocalMap */ ThreadLocal.ThreadLocalMap inheritableThreadLocals = null; ......(å…¶ä»–æºç ) } çº¿ç¨‹åˆå§‹åŒ–\n/** * é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¾ç½®inheritThreadLocalså¯ä¼ é€’ */ private void init(ThreadGroup g, Runnable target, String name, long stackSize) { init(g, target, name, stackSize, null, true); } /** * åˆå§‹åŒ–ä¸€ä¸ªçº¿ç¨‹. * æ­¤å‡½æ•°æœ‰ä¸¤å¤„è°ƒç”¨ï¼Œ * 1ã€ä¸Šé¢çš„ init()ï¼Œä¸ä¼ AccessControlContextï¼ŒinheritThreadLocals=true * 2ã€ä¼ é€’AccessControlContextï¼ŒinheritThreadLocals=false */ private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc, boolean inheritThreadLocals) { ......ï¼ˆå…¶ä»–ä»£ç ï¼‰ if (inheritThreadLocals \u0026\u0026 parent.inheritableThreadLocals != null) this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); ......ï¼ˆå…¶ä»–ä»£ç ï¼‰ } æ‰€ä»¥åªæœ‰çº¿ç¨‹åˆ›å»ºæ—¶æ‰ä¼š æ‰§è¡Œå€¼ä¼ é€’\n7.2 TransmittableThreadLocal(TTL) é˜¿é‡Œæä¾›çš„ åœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ï¼Œæä¾›ThreadLocalå€¼çš„ä¼ é€’åŠŸèƒ½ï¼Œè§£å†³å¼‚æ­¥æ‰§è¡Œæ—¶ä¸Šä¸‹æ–‡ä¼ é€’çš„é—®é¢˜ã€‚\nå…¶åº•å±‚æ˜¯ å°†æ•°æ®ä»çˆ¶çº¿ç¨‹ä¸­å–å‡ºæ¥, å†æ‰‹åŠ¨è®¾ç½®åˆ°å­çº¿ç¨‹ä¸­\nTransmittableThreadLocal (TTL) ThreadLocalï¼Œä¸€ç¯‡æ–‡ç« å°±å¤Ÿäº† - çŸ¥ä¹ (zhihu.com) ThreadLocalæºç åˆ†æ - ç®€ä¹¦ (jianshu.com) ThreadLocalä¸ºä»€ä¹ˆä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ - Chenæ´‹ - åšå®¢å›­ (cnblogs.com) Java-ThreadLocalä¸‰ç§ä½¿ç”¨åœºæ™¯_ç”¨å¿ƒå»è¿½æ¢¦çš„åšå®¢-CSDNåšå®¢_java threadlocalåœºæ™¯ ThreadLocalå­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼ˆspringbootï¼‰_ç¥éƒ½ç‡•çš„åšå®¢-CSDNåšå®¢_threadlocalå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ InheritableThreadLocalè¯¦è§£ - ç®€ä¹¦ (jianshu.com) ThreadLocal é¢è¯•å¤ºå‘½11è¿é—®_Youngä¸¶çš„åšå®¢-CSDNåšå®¢ ","wordCount":"8560","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-04T05:49:41.137225003Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/threadLocal.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.com/zh/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>ğŸ </a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80.html>javaåŸºç¡€</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91.html>å¹¶å‘</a> <span>></span></ul></nav><h1 class=post-title>ThreadLocalåŸç†ä»¥åŠå¸¸è§é—®é¢˜</h1><div class=post-description>ThreadLocalåŸç†</div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;æ›´æ–°:&nbsp;2023-09-04&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></ul><span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv>1</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1-threadlocal%e6%98%af%e4%bb%80%e4%b9%88 aria-label="1. ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ">1. ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ</a></li><li><a href=#2-threadlocal%e7%9a%84%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0 aria-label="2. ThreadLocalçš„å…·ä½“å®ç°">2. ThreadLocalçš„å…·ä½“å®ç°</a><ul><li><a href=#21-threadlocal%e7%bb%93%e6%9e%84 aria-label="2.1 ThreadLocalç»“æ„">2.1 ThreadLocalç»“æ„</a></li><li><a href=#22-%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0 aria-label="2.2 å…·ä½“å®ç°">2.2 å…·ä½“å®ç°</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e5%93%88%e5%b8%8c%e5%86%b2%e7%aa%81%e7%9a%84%e5%9b%9b%e7%a7%8d%e6%96%b9%e6%b3%95 aria-label=è§£å†³å“ˆå¸Œå†²çªçš„å››ç§æ–¹æ³•>è§£å†³å“ˆå¸Œå†²çªçš„å››ç§æ–¹æ³•</a></li><li><a href=#23-%e5%bc%95%e7%94%a8%e5%85%b3%e7%b3%bb aria-label="2.3 å¼•ç”¨å…³ç³»">2.3 å¼•ç”¨å…³ç³»</a><ul><li><a href=#231-threadlocal%e5%bc%95%e7%94%a8%e5%85%b3%e7%b3%bb aria-label="2.3.1 threadLocalå¼•ç”¨å…³ç³»">2.3.1 threadLocalå¼•ç”¨å…³ç³»</a></li><li><a href=#232-%e6%89%a9%e5%b1%95 aria-label="2.3.2 æ‰©å±•">2.3.2 æ‰©å±•</a></li></ul></li></ul></li><li><a href=#3-%e6%ba%90%e7%a0%81%e8%a7%a3%e8%af%bb aria-label="3. æºç è§£è¯»">3. æºç è§£è¯»</a><ul><li><a href=#31-%e4%bb%8eset%e6%96%b9%e6%b3%95%e5%bc%80%e5%a7%8b aria-label="3.1 ä»setæ–¹æ³•å¼€å§‹">3.1 ä»setæ–¹æ³•å¼€å§‹</a></li><li><a href=#32-threadlocal%e4%b8%ad%e7%9a%84get aria-label="3.2 ThreadLocalä¸­çš„get()">3.2 ThreadLocalä¸­çš„get()</a></li><li><a href=#33-threadlocalmap%e4%b8%ad%e7%9a%84remove aria-label="3.3 ThreadLocalMapä¸­çš„remove()">3.3 ThreadLocalMapä¸­çš„remove()</a></li></ul></li><li><a href=#4-%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2 aria-label="4. å†…å­˜æ³„éœ²">4. å†…å­˜æ³„éœ²</a><ul><li><a href=#41-threadlocal-%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f%e7%9a%84%e5%8e%9f%e5%9b%a0 aria-label="4.1 ThreadLocal å†…å­˜æ³„æ¼çš„åŸå› ">4.1 ThreadLocal å†…å­˜æ³„æ¼çš„åŸå› </a></li><li><a href=#42-threadlocal%e6%ad%a3%e7%a1%ae%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95 aria-label="4.2 ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•">4.2 ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•</a></li><li><a href=#43-%e6%80%bb%e7%bb%93 aria-label="4.3 æ€»ç»“">4.3 æ€»ç»“</a></li></ul></li><li><a href=#5-%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af aria-label="5. ä½¿ç”¨åœºæ™¯">5. ä½¿ç”¨åœºæ™¯</a><ul><li><a href=#51-%e5%9c%ba%e6%99%af%e4%b8%80%e4%bb%a3%e6%9b%bf%e5%8f%82%e6%95%b0%e7%9a%84%e6%98%be%e5%bc%8f%e4%bc%a0%e9%80%92 aria-label="5.1 åœºæ™¯ä¸€ï¼šä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’">5.1 åœºæ™¯ä¸€ï¼šä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’</a></li><li><a href=#52-%e5%9c%ba%e6%99%af%e4%ba%8c%e8%a7%a3%e5%86%b3%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98 aria-label="5.2 åœºæ™¯äºŒï¼šè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜">5.2 åœºæ™¯äºŒï¼šè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜</a></li><li><a href=#53-%e5%9c%ba%e6%99%af%e4%b8%89%e5%85%a8%e5%b1%80%e5%ad%98%e5%82%a8%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af aria-label="5.3 åœºæ™¯ä¸‰ï¼šå…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯">5.3 åœºæ™¯ä¸‰ï¼šå…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯</a></li></ul></li><li><a href=#6-%e5%ae%9e%e6%88%98 aria-label="6. å®æˆ˜">6. å®æˆ˜</a><ul><li><a href=#61-%e4%bb%a3%e7%a0%81 aria-label="6.1 ä»£ç ">6.1 ä»£ç </a></li><li><a href=#62-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86 aria-label="6.2 å¼‚å¸¸å¤„ç†">6.2 å¼‚å¸¸å¤„ç†</a><ul><li><a href=#621-feign%e8%b0%83%e7%94%a8%e4%b8%a2%e5%a4%b1%e8%af%b7%e6%b1%82%e5%a4%b4 aria-label="6.2.1 feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´">6.2.1 feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´</a></li><li><a href=#622-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e4%b8%ad%e4%b8%a2%e5%a4%b1%e8%af%b7%e6%b1%82%e5%a4%b4 aria-label="6.2.2 å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´">6.2.2 å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´</a></li></ul></li></ul></li><li><a href=#7-%e6%89%a9%e5%b1%95 aria-label="7. æ‰©å±•">7. æ‰©å±•</a><ul><li><a href=#71-inheritablethreadlocal aria-label="7.1 InheritableThreadLocal">7.1 InheritableThreadLocal</a></li><li><a href=#72-transmittablethreadlocalttl aria-label="7.2 TransmittableThreadLocal(TTL)">7.2 TransmittableThreadLocal(TTL)</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1-threadlocalæ˜¯ä»€ä¹ˆ>1. ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class=anchor aria-hidden=true href=#1-threadlocalæ˜¯ä»€ä¹ˆ>#</a></h1><p>ä»åå­—æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°<code>ThreadLocal</code> å«åšæœ¬åœ°çº¿ç¨‹å˜é‡ï¼Œæ„æ€æ˜¯è¯´ï¼Œ<code>ThreadLocal</code> ä¸­å¡«å……çš„çš„æ˜¯å½“å‰çº¿ç¨‹çš„å˜é‡ï¼Œè¯¥å˜é‡å¯¹å…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯å°é—­ä¸”éš”ç¦»çš„ï¼Œ<code>ThreadLocal</code> ä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨çš„å‰¯æœ¬å˜é‡ã€‚</p><p><strong>ç®€å•å®ç”¨</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>testThreadLocal</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> local <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        IntStream<span style=color:#ff7b72;font-weight:700>.</span>range<span style=color:#ff7b72;font-weight:700>(</span>0<span style=color:#ff7b72;font-weight:700>,</span> 10<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>.</span>forEach<span style=color:#ff7b72;font-weight:700>(</span>i <span style=color:#ff7b72;font-weight:700>-&gt;</span> <span style=color:#ff7b72>new</span> Thread<span style=color:#ff7b72;font-weight:700>(()</span> <span style=color:#ff7b72;font-weight:700>-&gt;</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            local<span style=color:#ff7b72;font-weight:700>.</span>set<span style=color:#ff7b72;font-weight:700>(</span>Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>().</span>getName<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;:&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> i<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                            System<span style=color:#ff7b72;font-weight:700>.</span>out<span style=color:#ff7b72;font-weight:700>.</span>println<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;çº¿ç¨‹ï¼š&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>().</span>getName<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;,local:&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> local<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}).</span>start<span style=color:#ff7b72;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>è¾“å‡ºç»“æœ<span style=color:#f85149>ï¼š</span>
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>0<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>0<span style=color:#ff7b72;font-weight:700>:</span>0
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>1<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>1<span style=color:#ff7b72;font-weight:700>:</span>1
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>2<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>2<span style=color:#ff7b72;font-weight:700>:</span>2
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>3<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>3<span style=color:#ff7b72;font-weight:700>:</span>3
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>4<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>4<span style=color:#ff7b72;font-weight:700>:</span>4
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>5<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>5<span style=color:#ff7b72;font-weight:700>:</span>5
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>6<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>6<span style=color:#ff7b72;font-weight:700>:</span>6
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>7<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>7<span style=color:#ff7b72;font-weight:700>:</span>7
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>8<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>8<span style=color:#ff7b72;font-weight:700>:</span>8
</span></span><span style=display:flex><span>çº¿ç¨‹<span style=color:#f85149>ï¼š</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>9<span style=color:#ff7b72;font-weight:700>,</span>local<span style=color:#ff7b72;font-weight:700>:</span>Thread<span style=color:#ff7b72;font-weight:700>-</span>9<span style=color:#ff7b72;font-weight:700>:</span>9
</span></span></code></pre></div><h1 id=2-threadlocalçš„å…·ä½“å®ç°>2. ThreadLocalçš„å…·ä½“å®ç°<a hidden class=anchor aria-hidden=true href=#2-threadlocalçš„å…·ä½“å®ç°>#</a></h1><h2 id=21-threadlocalç»“æ„>2.1 ThreadLocalç»“æ„<a hidden class=anchor aria-hidden=true href=#21-threadlocalç»“æ„>#</a></h2><p><img loading=lazy src=./threadLocal.assets/image-20220710170956658.png alt=image-20220710170956658></p><ol><li>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª ThreadLocalMap ï¼›</li><li>è¯¥ Map åº•å±‚ç”± Entry æ•°ç»„æ„æˆï¼Œå«æœ‰å¤šä¸ª Entry ï¼›</li><li>Entry ä¸­ key ä¸º ThreadLocal çš„å¼±å¼•ç”¨ï¼Œ value ä¸ºæˆ‘ä»¬ä¿å­˜çš„å€¼</li></ol><p>çº¿ç¨‹ä¸‹çš„threadLocalMap</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Thread</span> <span style=color:#ff7b72>implements</span> Runnable <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/* ThreadLocal values pertaining to this thread. This map is maintained
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * by the ThreadLocal class. */</span>
</span></span><span style=display:flex><span>    ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap threadLocals <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * InheritableThreadLocal values pertaining to this thread. This map is
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * maintained by the InheritableThreadLocal class.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap inheritableThreadLocals <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=22-å…·ä½“å®ç°>2.2 å…·ä½“å®ç°<a hidden class=anchor aria-hidden=true href=#22-å…·ä½“å®ç°>#</a></h2><p>ä»ç»“æ„å¯ä»¥çœ‹å‡º, æ¯ä¸ªçº¿ç¨‹åœ¨å‘ThreadLocalé‡Œå¡å€¼çš„æ—¶å€™ï¼Œå…¶å®éƒ½æ˜¯å‘è‡ªå·±æ‰€æŒæœ‰çš„ThreadLocalMapé‡Œå¡å…¥æ•°æ®ï¼›è¯»çš„æ—¶å€™åŒç†ï¼Œé¦–å…ˆä»è‡ªå·±çº¿ç¨‹ä¸­å–å‡ºè‡ªå·±æŒæœ‰çš„ThreadLocalMapï¼Œç„¶åå†æ ¹æ®ThreadLocalå¼•ç”¨ä½œä¸ºkeyå–å‡ºvalueï¼ŒåŸºäºä»¥ä¸Šæè¿°ï¼ŒThreadLocalå®ç°äº†å˜é‡çš„çº¿ç¨‹éš”ç¦»ï¼ˆå½“ç„¶ï¼Œæ¯•ç«Ÿå˜é‡å…¶å®éƒ½æ˜¯ä»è‡ªå·±å½“å‰çº¿ç¨‹å®ä¾‹ä¸­å–å‡ºæ¥çš„ï¼‰ã€‚</p><blockquote><p>æ‰€ä»¥åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­, ä¼šç”Ÿæˆ10ä¸ªmap, æ¯ä¸ªmapä¸­å°±åªæœ‰ä¸€ä¸ªå…ƒç´ , keyéƒ½æ˜¯<code>local</code>å˜é‡, valueæ˜¯çº¿ç¨‹åç§°</p></blockquote><p>ç”±æ­¤çœ‹å‡º , threadLocalåº•å±‚ä½¿ç”¨mapç»“æ„å­˜å‚¨ä¿¡æ¯, keyä¸ºå½“å‰çš„çº¿ç¨‹ä¸‹çš„threadLocalå¯¹è±¡, value æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡å€¼</p><p>å®ƒä¸hashMapæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„, æ¯”å¦‚ æ‰©å±•å› å­, åˆå§‹åŒ–å¤§å°ç­‰ç­‰, ä½†æ˜¯threadLocalè§£å†³hashå†²çªä½¿ç”¨çš„<strong>çº¿æ€§æ¢æµ‹</strong></p><blockquote><h2 id=è§£å†³å“ˆå¸Œå†²çªçš„å››ç§æ–¹æ³•>è§£å†³å“ˆå¸Œå†²çªçš„å››ç§æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#è§£å†³å“ˆå¸Œå†²çªçš„å››ç§æ–¹æ³•>#</a></h2><p><strong>1.å¼€æ”¾åœ°å€æ–¹æ³•(å†æ•£åˆ—æ³•)</strong></p><p>å¯ä»¥é€šä¿—ç†è§£ä¸ºæ‰€æœ‰çš„åœ°å€éƒ½å¯¹æ‰€æœ‰çš„æ•°å€¼å¼€æ”¾ï¼Œè€Œä¸æ˜¯é“¾å¼åœ°å€æ³•çš„å°é—­æ–¹å¼ï¼Œä¸€ä¸ªæ•°å€¼å›ºå®šåœ¨ä¸€ä¸ªç´¢å¼•åœ°å€ä½ç½®ã€‚<strong>p1=hash(key)å¦‚æœå†²çªå°±åœ¨p1åœ°å€çš„åŸºç¡€ä¸Š+1æˆ–è€…æ•£åˆ—å¤„ç†</strong>ï¼Œp2=hash(p1)&mldr;.</p><p>(1ï¼‰çº¿æ€§æ¢æµ‹</p><p>ã€€ã€€ã€€æŒ‰é¡ºåºå†³å®šå€¼æ—¶ï¼Œå¦‚æœæŸæ•°æ®çš„å€¼å·²ç»å­˜åœ¨ï¼Œåˆ™åœ¨åŸæ¥å€¼çš„åŸºç¡€ä¸Šå¾€ååŠ ä¸€ä¸ªå•ä½ï¼Œç›´è‡³ä¸å‘ç”Ÿå“ˆå¸Œå†²çªã€‚</p><p>ï¼ˆ2ï¼‰å†å¹³æ–¹æ¢æµ‹</p><p>ã€€ã€€ã€€æŒ‰é¡ºåºå†³å®šå€¼æ—¶ï¼Œå¦‚æœæŸæ•°æ®çš„å€¼å·²ç»å­˜åœ¨ï¼Œåˆ™åœ¨åŸæ¥å€¼çš„åŸºç¡€ä¸Šå…ˆåŠ 1çš„å¹³æ–¹ä¸ªå•ä½ï¼Œè‹¥ä»ç„¶å­˜åœ¨åˆ™åŠ 1çš„å¹³æ–¹ä¸ªå•ä½ã€‚éšä¹‹æ˜¯2çš„å¹³æ–¹ï¼Œ3çš„å¹³æ–¹ç­‰ç­‰ã€‚ç›´è‡³ä¸å‘ç”Ÿå“ˆå¸Œå†²çªã€‚</p><p><strong>å’Œçº¿æ€§æ¢æµ‹ç›¸æ¯”å°±æ˜¯æ”¹å˜æ¢æµ‹äº†æ­¥é•¿</strong>ã€‚å› ä¸ºå¦‚æœéƒ½æ˜¯+1æ¥æ¢æµ‹åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œæ•ˆç‡ä¼šå¾ˆå·®ã€‚</p><p><strong>2.é“¾å¼åœ°å€æ³•</strong></p><p>å¯¹äº<strong>ç›¸åŒçš„å€¼ï¼Œä½¿ç”¨é“¾è¡¨è¿›è¡Œè¿æ¥</strong>ã€‚ä½¿ç”¨æ•°ç»„å­˜å‚¨æ¯ä¸€ä¸ªé“¾è¡¨ã€‚<strong>ï¼ˆHashMapçš„å“ˆå¸Œå†²çªè§£å†³æ–¹æ³•ï¼‰</strong></p><p><strong>3.å»ºç«‹å…¬å…±æº¢å‡ºåŒº</strong></p><p>ã€€ã€€å»ºç«‹å…¬å…±æº¢å‡ºåŒºå­˜å‚¨æ‰€æœ‰å“ˆå¸Œå†²çªçš„æ•°æ®ã€‚</p><p><strong>4.å†å“ˆå¸Œæ³•</strong></p><p>ã€€ã€€å¯¹äºå†²çªçš„å“ˆå¸Œå€¼å†æ¬¡è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç›´è‡³æ²¡æœ‰å“ˆå¸Œå†²çªã€‚</p><p><a href=https://www.jianshu.com/p/a343dae4a818 target=_blank rel=noopener>ä¸€æ–‡ç†è§£å“ˆå¸Œå†²çªå››ç§è§£å†³æ–¹æ³• - ç®€ä¹¦ (jianshu.com)</a></p></blockquote><h2 id=23-å¼•ç”¨å…³ç³»>2.3 å¼•ç”¨å…³ç³»<a hidden class=anchor aria-hidden=true href=#23-å¼•ç”¨å…³ç³»>#</a></h2><h3 id=231-threadlocalå¼•ç”¨å…³ç³»>2.3.1 threadLocalå¼•ç”¨å…³ç³»<a hidden class=anchor aria-hidden=true href=#231-threadlocalå¼•ç”¨å…³ç³»>#</a></h3><p><img loading=lazy src=./threadLocal.assets/image-20220710171226838.png alt=image-20220710171226838></p><p>å¼•ç”¨å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><p>åœ¨æ•´ä¸ªå¼•ç”¨é“¾è·¯ä¸­ï¼Œåªæœ‰ ThreadLocal æ˜¯é‡‡ç”¨äº†å¼±å¼•ç”¨çš„æ–¹å¼è¿›è¡Œå£°æ˜çš„ã€‚</p><h3 id=232-æ‰©å±•>2.3.2 æ‰©å±•<a hidden class=anchor aria-hidden=true href=#232-æ‰©å±•>#</a></h3><p>Java ä¸­å¼•ç”¨æœ‰å››ç§æ–¹å¼ã€‚</p><p>å¼ºå¼•ç”¨ï¼š é€šè¿‡ <strong>new</strong> å…³é”®å­—äº§ç”Ÿçš„å¼•ç”¨å…³ç³»ï¼Œæ— è®ºä»»ä½•æƒ…å†µä¸‹ï¼Œåªè¦å¼ºå¼•ç”¨å…³ç³»è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ï¼›</p><p>è½¯å¼•ç”¨ï¼š <strong>SoftReference</strong> å†…å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œå‘ç”ŸGC, åƒåœ¾å›æ”¶å™¨å°±ä¼šå›æ”¶å®ƒ, å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚</p><p>å¼±å¼•ç”¨ï¼š å£°æ˜æ—¶ï¼Œé€šè¿‡ <strong>WeakReference</strong> åŒ…è£¹ï¼Œå¼ºåº¦æ¯”è½¯å¼•ç”¨æ›´å¼±ä¸€äº›ï¼Œè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¸ºæ­¢ã€‚å½“åƒåœ¾æ”¶é›†å™¨å¼€å§‹å·¥ä½œï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</p><p>è™šå¼•ç”¨ï¼šè™šå¼•ç”¨ä¹Ÿç§°ä¸ºâ€œå¹½çµå¼•ç”¨â€æˆ–è€…â€œå¹»å½±å¼•ç”¨â€ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„ å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™š å¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åªæ˜¯ä¸ºäº†èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</p><p>Javaä¸­æä¾›è¿™å››ç§å¼•ç”¨ç±»å‹ä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ ï¼š</p><ul><li>å¯ä»¥è®©ç¨‹åºå‘˜é€šè¿‡ä»£ç çš„æ–¹å¼å†³å®šæŸäº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</li><li>æœ‰åˆ©äºJVMè¿›è¡Œåƒåœ¾å›æ”¶ã€‚</li></ul><p><a href=../JVM/%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6/%e5%9b%9e%e6%94%b6%e5%89%8d%e6%8f%90.html>jvmå†…å­˜å›æ”¶å‰æ</a></p><p><a href=https://javaguide.cn/java/jvm/jvm-garbage-collection.html#%e5%bc%95%e7%94%a8%e7%b1%bb%e5%9e%8b%e6%80%bb%e7%bb%93 target=_blank rel=noopener>JVM åƒåœ¾å›æ”¶è¯¦è§£-å¼•ç”¨ç±»å‹ | JavaGuide</a></p><h1 id=3-æºç è§£è¯»>3. æºç è§£è¯»<a hidden class=anchor aria-hidden=true href=#3-æºç è§£è¯»>#</a></h1><h2 id=31-ä»setæ–¹æ³•å¼€å§‹>3.1 ä»setæ–¹æ³•å¼€å§‹<a hidden class=anchor aria-hidden=true href=#31-ä»setæ–¹æ³•å¼€å§‹>#</a></h2><blockquote><p>å› ä¸ºsetæ˜¯çº¿ç¨‹çº§åˆ«çš„, æ‰€æœ‰çš„æ“ä½œéƒ½åœ¨å½“å‰çº¿ç¨‹ä¸‹, æ‰€ä»¥setæ“ä½œæœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„</p></blockquote><p><strong>ThreadLocal.set(T value)</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>set</span><span style=color:#ff7b72;font-weight:700>(</span>T value<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    Thread t <span style=color:#ff7b72;font-weight:700>=</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>();</span> <span style=color:#8b949e;font-style:italic>// è·å–å½“å‰çº¿ç¨‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    ThreadLocalMap map <span style=color:#ff7b72;font-weight:700>=</span> getMap<span style=color:#ff7b72;font-weight:700>(</span>t<span style=color:#ff7b72;font-weight:700>);</span><span style=color:#8b949e;font-style:italic>// è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>map <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    	map<span style=color:#ff7b72;font-weight:700>.</span>set<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>);</span><span style=color:#8b949e;font-style:italic>// mapä¸ä¸ºç©ºåˆ™è°ƒç”¨mapçš„setæ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>    	createMap<span style=color:#ff7b72;font-weight:700>(</span>t<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>);</span><span style=color:#8b949e;font-style:italic>// mapä¸ºç©ºåˆ™è°ƒç”¨createMapæ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>å…ˆçœ‹çœ‹ map ä¸ºç©ºæ—¶ï¼Œ createMap æ–¹æ³•æ˜¯æ€ä¹ˆåˆ›å»º map çš„ã€‚</p><p><strong>ThreadLocal.createMap(Thread t, T firstValue)</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>createMap</span><span style=color:#ff7b72;font-weight:700>(</span>Thread t<span style=color:#ff7b72;font-weight:700>,</span> T firstValue<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä¸ºä¼ å…¥çš„çº¿ç¨‹å®ä¾‹åŒ–ä¸€ä¸ªmapï¼Œä¼ å…¥äº†è‡ªèº«çš„å¼•ç”¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    t<span style=color:#ff7b72;font-weight:700>.</span>threadLocals <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ThreadLocalMap<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> firstValue<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* æ„é€ ä¸€ä¸ªæœ€åˆåŒ…å« (firstKey, firstValue) çš„æ–°æ˜ å°„ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* ThreadLocalMaps æ˜¯æƒ°æ€§æ„å»ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæœ‰åœ¨è‡³å°‘æœ‰ä¸€ä¸ªæ¡ç›®å¯ä»¥æ”¾å…¥æ—¶æ‰åˆ›å»ºä¸€ä¸ªã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> firstKey<span style=color:#ff7b72;font-weight:700>,</span> Object firstValue<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    table <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Entry<span style=color:#ff7b72;font-weight:700>[</span>INITIAL_CAPACITY<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>int</span> i <span style=color:#ff7b72;font-weight:700>=</span> firstKey<span style=color:#ff7b72;font-weight:700>.</span>threadLocalHashCode <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#ff7b72;font-weight:700>(</span>INITIAL_CAPACITY <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    table<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Entry<span style=color:#ff7b72;font-weight:700>(</span>firstKey<span style=color:#ff7b72;font-weight:700>,</span> firstValue<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    size <span style=color:#ff7b72;font-weight:700>=</span> 1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    setThreshold<span style=color:#ff7b72;font-weight:700>(</span>INITIAL_CAPACITY<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>è¯¥æ„é€ æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹æ“ä½œï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªé»˜è®¤é•¿åº¦çš„ Entry æ•°ç»„</li><li>è®¡ç®—å‡ºä¼ å…¥çš„ ThreadLocal åº”åœ¨æ•°ç»„ä¸­çš„ä½ç½®</li><li>å®ä¾‹åŒ– Entry æ”¾åˆ°å¯¹åº”ä½ç½®ä¸Š</li><li>ThreadLocalMap å…ƒç´ æ•°ç½®ä¸º1</li><li>è®¾ç½®è¦è°ƒæ•´å¤§å°çš„ä¸‹ä¸€ä¸ªå€¼</li></ol><p>æˆ‘ä»¬çœ‹çœ‹ ThreadLocalMap çš„åŸºç¡€ä¿¡æ¯ï¼›</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* åˆå§‹å®¹é‡ - å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>int</span> INITIAL_CAPACITY <span style=color:#ff7b72;font-weight:700>=</span> 16<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* table,é•¿åº¦å¿…é¡»ä¸º 2 çš„å¹‚æ¬¡æ–¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> Entry<span style=color:#ff7b72;font-weight:700>[]</span> table<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* tableä¸­å…ƒç´ çš„ä¸ªæ•°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> <span style=color:#ff7b72>int</span> size <span style=color:#ff7b72;font-weight:700>=</span> 0<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* è¦è°ƒæ•´å¤§å°çš„ä¸‹ä¸€ä¸ªå¤§å°å€¼ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> <span style=color:#ff7b72>int</span> threshold<span style=color:#ff7b72;font-weight:700>;</span> <span style=color:#8b949e;font-style:italic>// é»˜è®¤å€¼ä¸º 0
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>* Entryå¯¹è±¡ç»§æ‰¿äº†å¼±å¼•ç”¨(å½“å‘ç”Ÿåƒåœ¾å›æ”¶æ—¶å°±ä¼šå›æ”¶)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>static</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Entry</span> <span style=color:#ff7b72>extends</span> WeakReference<span style=color:#ff7b72;font-weight:700>&lt;</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/** The value associated with this ThreadLocal. */</span>
</span></span><span style=display:flex><span>    Object value<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> k<span style=color:#ff7b72;font-weight:700>,</span> Object v<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>super</span><span style=color:#ff7b72;font-weight:700>(</span>k<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        value <span style=color:#ff7b72;font-weight:700>=</span> v<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>ä¸»è¦è¯´ä¸€ä¸‹è®¡ç®—ç´¢å¼•ï¼Œ<code>firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1)</code>ã€‚</p><ul><li><p>å…³äº<code>& (INITIAL_CAPACITY - 1)</code>,è¿™æ˜¯å–æ¨¡çš„ä¸€ç§æ–¹å¼ï¼Œå¯¹äº2çš„å¹‚ä½œä¸ºæ¨¡æ•°å–æ¨¡ï¼Œç”¨æ­¤ä»£æ›¿<code>%(2^n)</code>ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥å®¹é‡å¿…é¡»ä¸º2çš„å†¥ï¼Œåœ¨è¿™ä¸ªåœ°æ–¹ä¹Ÿå¾—åˆ°äº†è§£ç­”ï¼Œè‡³äºä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·è¿™é‡Œä¸è¿‡å¤šè§£é‡Šï¼ŒåŸç†å¾ˆç®€å•ã€‚</p></li><li><p>å…³äº<code>firstKey.threadLocalHashCode</code>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>int</span> threadLocalHashCode <span style=color:#ff7b72;font-weight:700>=</span> nextHashCode<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>int</span> <span style=color:#d2a8ff;font-weight:700>nextHashCode</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> nextHashCode<span style=color:#ff7b72;font-weight:700>.</span>getAndAdd<span style=color:#ff7b72;font-weight:700>(</span>HASH_INCREMENT<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> AtomicInteger nextHashCode <span style=color:#ff7b72;font-weight:700>=</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>new</span> AtomicInteger<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>int</span> HASH_INCREMENT <span style=color:#ff7b72;font-weight:700>=</span> 0x61c88647<span style=color:#ff7b72;font-weight:700>;</span>
</span></span></code></pre></div><p>å®šä¹‰äº†ä¸€ä¸ªAtomicIntegerç±»å‹ï¼Œæ¯æ¬¡è·å–å½“å‰å€¼å¹¶åŠ ä¸ŠHASH_INCREMENTï¼Œ<code>HASH_INCREMENT = 0x61c88647</code>,å…³äºè¿™ä¸ªå€¼å’Œ<code>æ–æ³¢é‚£å¥‘æ•£åˆ—</code>æœ‰å…³ï¼Œå…¶ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†è®©å“ˆå¸Œç èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨2çš„næ¬¡æ–¹çš„æ•°ç»„é‡Œ, ä¹Ÿå°±æ˜¯<code>Entry[] table</code>ä¸­ã€‚</p><blockquote><p>å¸¸è§çš„æ•£åˆ—æ–¹æ³•æ˜¯å–æ¨¡æ•£åˆ—, è€Œæ–æ³¢é‚£å¥‘æ•£åˆ—æ˜¯å¦ä¸€ç§æ•£åˆ—æ–¹æ³•</p><p><a href=https://zhuanlan.zhihu.com/p/40515974 target=_blank rel=noopener>ä» ThreadLocal çš„å®ç°çœ‹æ•£åˆ—ç®—æ³• - çŸ¥ä¹ (zhihu.com)</a></p></blockquote></li></ul><p>å†çœ‹å›setæ–¹æ³•</p><p><strong>ThreadLocalMap.set(ThreadLocal key, Object value)</strong></p><blockquote><p>ThreadLocalMapä½¿ç”¨<code>çº¿æ€§æ¢æµ‹æ³•</code>æ¥è§£å†³å“ˆå¸Œå†²çªï¼Œçº¿æ€§æ¢æµ‹æ³•çš„åœ°å€å¢é‡di = 1, 2, &mldr; , m-1ï¼Œå…¶ä¸­ï¼Œiä¸ºæ¢æµ‹æ¬¡æ•°ã€‚è¯¥æ–¹æ³•ä¸€æ¬¡æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ•´ä¸ªç©ºé—´éƒ½æ‰¾ä¸åˆ°ç©ºä½™çš„åœ°å€ï¼Œåˆ™äº§ç”Ÿæº¢å‡ºã€‚å‡è®¾å½“å‰tableé•¿åº¦ä¸º16ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè®¡ç®—å‡ºæ¥keyçš„hashå€¼ä¸º14ï¼Œå¦‚æœtable[14]ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶keyä¸å½“å‰keyä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº†hashå†²çªï¼Œè¿™ä¸ªæ—¶å€™å°†14åŠ 1å¾—åˆ°15ï¼Œå–table[15]è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ°0ï¼Œå–table[0],ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ã€‚æ‰€ä»¥ <code>å¯ä»¥æŠŠtableçœ‹æˆä¸€ä¸ªç¯å½¢æ•°ç»„</code>ã€‚</p><p>åœ¨setçš„æ—¶å€™, ä¼šå»åˆ¤æ–­ <code>entry==null</code> å’Œ <code>key==null</code>çš„å“ˆå¸Œæ§½, å¹¶åˆ é™¤è¿™äº›æ§½ä½, ç”±äºä½¿ç”¨çº¿æ€§æ¢æµ‹æ–¹å¼, è¿˜ä¼šæŒªåŠ¨å†²çªçš„keyçš„ä½ç½®, ä½¿å¾—ç›¸åŒkeyç´§å‡‘ä¸€èµ·</p></blockquote><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>set</span><span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> key<span style=color:#ff7b72;font-weight:700>,</span> Object value<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// We don&#39;t use a fast path as with get() because it is at
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#8b949e;font-style:italic>// least as common to use set() to create new entries as
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#8b949e;font-style:italic>// it is to replace existing ones, in which case, a fast
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#8b949e;font-style:italic>// path would fail more often than not.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>            Entry<span style=color:#ff7b72;font-weight:700>[]</span> tab <span style=color:#ff7b72;font-weight:700>=</span> table<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>int</span> len <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>.</span>length<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>     <span style=color:#8b949e;font-style:italic>// è·å–ThreadLocalçš„hashCodeï¼Œè®¡ç®—ç´¢å¼•ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>int</span> i <span style=color:#ff7b72;font-weight:700>=</span> key<span style=color:#ff7b72;font-weight:700>.</span>threadLocalHashCode <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#ff7b72;font-weight:700>(</span>len<span style=color:#ff7b72;font-weight:700>-</span>1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¯¥ç´¢å¼•ä½ç½®ä¸Šæ˜¯å¦æœ‰å…ƒç´ ï¼Œå¦‚æœæœ‰å…ƒç´ çš„è¯å°±è¿›è¡Œçº¿æ€§æ¢æµ‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Entry e <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>                 e <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                 e <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>[</span>i <span style=color:#ff7b72;font-weight:700>=</span> nextIndex<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>,</span> len<span style=color:#ff7b72;font-weight:700>)])</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> k <span style=color:#ff7b72;font-weight:700>=</span> e<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¯´æ˜è¯¥keyå·²ç»å­˜åœ¨ï¼Œåˆ™è¦†ç›–æ—§å€¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>k <span style=color:#ff7b72;font-weight:700>==</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#ff7b72;font-weight:700>.</span>value <span style=color:#ff7b72;font-weight:700>=</span> value<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>return</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>             * table[i]ä¸Šçš„keyä¸ºç©ºï¼Œè¯´æ˜è¢«å›æ”¶äº†ï¼ˆä¸Šé¢çš„å¼±å¼•ç”¨ä¸­æåˆ°è¿‡ï¼‰ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>             * è¿™ä¸ªæ—¶å€™è¯´æ˜æ”¹table[i]å¯ä»¥é‡æ–°ä½¿ç”¨ï¼Œç”¨æ–°çš„key-valueå°†å…¶æ›¿æ¢,å¹¶åˆ é™¤å…¶ä»–æ— æ•ˆçš„entry
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>             */</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>k <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    replaceStaleEntry<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>,</span> i<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>return</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¯¥ç´¢å¼•ä½ç½®ä¸Šæ²¡æœ‰å…ƒç´ ï¼Œåˆ™æ–°å»ºEntry
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            tab<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Entry<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>int</span> sz <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>++</span>size<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>     <span style=color:#8b949e;font-style:italic>// ä¸éœ€è¦æ¸…ç† ç©ºå“ˆå¸Œæ§½æˆ–è€…æ§½keyä¸ºnullçš„ï¼Œ å¹¶ä¸”å¤§äºç­‰äºæ‰©å®¹å€¼ï¼Œåˆ™è¿›è¡Œrehashï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>cleanSomeSlots<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>,</span> sz<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> sz <span style=color:#ff7b72;font-weight:700>&gt;=</span> threshold<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// é»˜è®¤16ï¼Œä»¥2çš„å€æ•°æ‰©å®¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                rehash<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**java
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>    /**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è·å–ç¯å½¢æ•°ç»„çš„ä¸‹ä¸€ä¸ªç´¢å¼•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>int</span> <span style=color:#d2a8ff;font-weight:700>nextIndex</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span> i<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>int</span> len<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>((</span>i <span style=color:#ff7b72;font-weight:700>+</span> 1 <span style=color:#ff7b72;font-weight:700>&lt;</span> len<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> i <span style=color:#ff7b72;font-weight:700>+</span> 1 <span style=color:#ff7b72;font-weight:700>:</span> 0<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è·å–ç¯å½¢æ•°ç»„çš„ä¸Šä¸€ä¸ªç´¢å¼•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>int</span> <span style=color:#d2a8ff;font-weight:700>prevIndex</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span> i<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>int</span> len<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>((</span>i <span style=color:#ff7b72;font-weight:700>-</span> 1 <span style=color:#ff7b72;font-weight:700>&gt;=</span> 0<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> i <span style=color:#ff7b72;font-weight:700>-</span> 1 <span style=color:#ff7b72;font-weight:700>:</span> len <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>replaceStaleEntry(ThreadLocal key, Object value, int staleSlot)</strong></p><p>// å¥½å¤æ‚, çœ‹çœ‹ç½‘ä¸Šæ–‡ç« ,ä»¥åæ·±å…¥äº†è§£å§</p><p><a href=https://www.jianshu.com/p/80866ca6c424 target=_blank rel=noopener>ThreadLocalæºç åˆ†æ - ç®€ä¹¦ (jianshu.com)</a></p><h2 id=32-threadlocalä¸­çš„get>3.2 ThreadLocalä¸­çš„get()<a hidden class=anchor aria-hidden=true href=#32-threadlocalä¸­çš„get>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> T <span style=color:#d2a8ff;font-weight:700>get</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//åŒsetæ–¹æ³•ç±»ä¼¼è·å–å¯¹åº”çº¿ç¨‹ä¸­çš„ThreadLocalMapå®ä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    Thread t <span style=color:#ff7b72;font-weight:700>=</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    ThreadLocalMap map <span style=color:#ff7b72;font-weight:700>=</span> getMap<span style=color:#ff7b72;font-weight:700>(</span>t<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>map <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry e <span style=color:#ff7b72;font-weight:700>=</span> map<span style=color:#ff7b72;font-weight:700>.</span>getEntry<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>e <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#d2a8ff;font-weight:700>@SuppressWarnings</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;unchecked&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>            T result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>T<span style=color:#ff7b72;font-weight:700>)</span>e<span style=color:#ff7b72;font-weight:700>.</span>value<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> result<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//ä¸ºç©ºè¿”å›åˆå§‹åŒ–å€¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> setInitialValue<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * åˆå§‹åŒ–è®¾å€¼çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«å­ç±»è¦†ç›–ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>protected</span> T <span style=color:#d2a8ff;font-weight:700>initialValue</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> T <span style=color:#d2a8ff;font-weight:700>setInitialValue</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//è·å–åˆå§‹åŒ–å€¼ï¼Œé»˜è®¤ä¸ºnull(å¦‚æœæ²¡æœ‰å­ç±»è¿›è¡Œè¦†ç›–)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    T value <span style=color:#ff7b72;font-weight:700>=</span> initialValue<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    Thread t <span style=color:#ff7b72;font-weight:700>=</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    ThreadLocalMap map <span style=color:#ff7b72;font-weight:700>=</span> getMap<span style=color:#ff7b72;font-weight:700>(</span>t<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//ä¸ä¸ºç©ºä¸ç”¨å†åˆå§‹åŒ–ï¼Œç›´æ¥è°ƒç”¨setæ“ä½œè®¾å€¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>map <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>        map<span style=color:#ff7b72;font-weight:700>.</span>set<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼ŒcreateMapåœ¨ä¸Šé¢ä»‹ç»set()çš„æ—¶å€™æœ‰ä»‹ç»è¿‡ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        createMap<span style=color:#ff7b72;font-weight:700>(</span>t<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> value<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>ThreadLocalMapä¸­çš„getEntry()</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#ff7b72>private</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry <span style=color:#d2a8ff;font-weight:700>getEntry</span><span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//æ ¹æ®keyè®¡ç®—ç´¢å¼•ï¼Œè·å–entry
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>int</span> i <span style=color:#ff7b72;font-weight:700>=</span> key<span style=color:#ff7b72;font-weight:700>.</span>threadLocalHashCode <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#ff7b72;font-weight:700>(</span>table<span style=color:#ff7b72;font-weight:700>.</span>length <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry e <span style=color:#ff7b72;font-weight:700>=</span> table<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>e <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> e<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>==</span> key<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> e<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> getEntryAfterMiss<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>,</span> i<span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * é€šè¿‡ç›´æ¥è®¡ç®—å‡ºæ¥çš„keyæ‰¾ä¸åˆ°å¯¹äºçš„valueçš„æ—¶å€™é€‚ç”¨è¿™ä¸ªæ–¹æ³•.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry <span style=color:#d2a8ff;font-weight:700>getEntryAfterMiss</span><span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> key<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>int</span> i<span style=color:#ff7b72;font-weight:700>,</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry<span style=color:#ff7b72;font-weight:700>[]</span> tab <span style=color:#ff7b72;font-weight:700>=</span> table<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>int</span> len <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>.</span>length<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>while</span> <span style=color:#ff7b72;font-weight:700>(</span>e <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> k <span style=color:#ff7b72;font-weight:700>=</span> e<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>k <span style=color:#ff7b72;font-weight:700>==</span> key<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> e<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>k <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//æ¸…é™¤æ— æ•ˆçš„entry
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                expungeStaleEntry<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//åŸºäºçº¿æ€§æ¢æµ‹æ³•å‘åæ‰«æ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                i <span style=color:#ff7b72;font-weight:700>=</span> nextIndex<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>,</span> len<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            e <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=33-threadlocalmapä¸­çš„remove>3.3 ThreadLocalMapä¸­çš„remove()<a hidden class=anchor aria-hidden=true href=#33-threadlocalmapä¸­çš„remove>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>remove</span><span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry<span style=color:#ff7b72;font-weight:700>[]</span> tab <span style=color:#ff7b72;font-weight:700>=</span> table<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>int</span> len <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>.</span>length<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//è®¡ç®—ç´¢å¼•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>int</span> i <span style=color:#ff7b72;font-weight:700>=</span> key<span style=color:#ff7b72;font-weight:700>.</span>threadLocalHashCode <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#ff7b72;font-weight:700>(</span>len<span style=color:#ff7b72;font-weight:700>-</span>1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//è¿›è¡Œçº¿æ€§æ¢æµ‹ï¼ŒæŸ¥æ‰¾æ­£ç¡®çš„key
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap<span style=color:#ff7b72;font-weight:700>.</span>Entry e <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>             e <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>             e <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>[</span>i <span style=color:#ff7b72;font-weight:700>=</span> nextIndex<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>,</span> len<span style=color:#ff7b72;font-weight:700>)])</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>e<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>==</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//è°ƒç”¨weakrefrenceçš„clear()æ¸…é™¤å¼•ç”¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                e<span style=color:#ff7b72;font-weight:700>.</span>clear<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//è¿ç»­æ®µæ¸…é™¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                expungeStaleEntry<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h1 id=4-å†…å­˜æ³„éœ²>4. å†…å­˜æ³„éœ²<a hidden class=anchor aria-hidden=true href=#4-å†…å­˜æ³„éœ²>#</a></h1><h2 id=41-threadlocal-å†…å­˜æ³„æ¼çš„åŸå› >4.1 ThreadLocal å†…å­˜æ³„æ¼çš„åŸå› <a hidden class=anchor aria-hidden=true href=#41-threadlocal-å†…å­˜æ³„æ¼çš„åŸå› >#</a></h2><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒhreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalä¸å­˜åœ¨å¤–éƒ¨<strong>å¼ºå¼•ç”¨</strong>æ—¶ï¼ŒKey(ThreadLocal)åŠ¿å¿…ä¼šè¢«GCå›æ”¶ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ThreadLocalMapä¸­keyä¸ºnullï¼Œ è€Œvalueè¿˜å­˜åœ¨ç€å¼ºå¼•ç”¨ï¼Œåªæœ‰theadçº¿ç¨‹é€€å‡ºä»¥å,valueçš„å¼ºå¼•ç”¨é“¾æ¡æ‰ä¼šæ–­æ‰ã€‚</p><p>ä½†å¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼š</p><blockquote><p>Thread Ref -> Thread -> ThreaLocalMap -> Entry -> value</p></blockquote><p>æ°¸è¿œæ— æ³•å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚, <strong>æ‰€ä»¥æ³„éœ²çš„æ˜¯valueå€¼</strong></p><h2 id=42-threadlocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•>4.2 ThreadLocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#42-threadlocalæ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•>#</a></h2><ol><li>æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocaléƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•æ¸…é™¤æ•°æ®</li></ol><blockquote><p>å…¶å®è°ƒç”¨set()å’Œget() éƒ½æœ‰å¯èƒ½ä¹Ÿä¼šæ¸…é™¤æ•°æ®</p><p>ThreadLocalä¼šåœ¨ä»¥ä¸‹è¿‡ç¨‹ä¸­æ¸…ç†è¿‡æœŸèŠ‚ç‚¹ï¼š</p><ol><li>è°ƒç”¨set()æ–¹æ³•æ—¶ï¼Œé‡‡æ ·æ¸…ç†ã€å…¨é‡æ¸…ç†ï¼Œæ‰©å®¹æ—¶è¿˜ä¼šç»§ç»­æ£€æŸ¥ã€‚</li><li>è°ƒç”¨get()æ–¹æ³•ï¼Œæ²¡æœ‰ç›´æ¥å‘½ä¸­ï¼Œå‘åç¯å½¢æŸ¥æ‰¾æ—¶ã€‚</li><li>è°ƒç”¨remove()æ—¶ï¼Œé™¤äº†æ¸…ç†å½“å‰Entryï¼Œè¿˜ä¼šå‘åç»§ç»­æ¸…ç†ã€‚</li></ol></blockquote><ol start=2><li>ä½¿ç”¨ThreadLocalæ—¶ï¼Œä¸€èˆ¬å»ºè®®å°†å…¶å£°æ˜ä¸ºstatic finalçš„ï¼Œé¿å…é¢‘ç¹åˆ›å»ºThreadLocalå®ä¾‹ã€‚</li></ol><h2 id=43-æ€»ç»“>4.3 æ€»ç»“<a hidden class=anchor aria-hidden=true href=#43-æ€»ç»“>#</a></h2><p>ç”±äºThreadä¸­åŒ…å«å˜é‡ThreadLocalMapï¼Œå› æ­¤ThreadLocalMapä¸Threadçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·é•¿ï¼Œå¦‚æœéƒ½æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyï¼Œéƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>ä½†æ˜¯ä½¿ç”¨<strong>å¼±å¼•ç”¨</strong>å¯ä»¥å¤šä¸€å±‚ä¿éšœï¼šå¼±å¼•ç”¨ThreadLocalä¸ä¼šå†…å­˜æ³„æ¼ï¼Œå¯¹åº”çš„valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨set(),get(),remove()çš„æ—¶å€™ä¼šè¢«æ¸…é™¤ã€‚</p><p>å› æ­¤ï¼ŒThreadLocalå†…å­˜æ³„æ¼çš„æ ¹æºæ˜¯ï¼šç”±äºThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè€Œä¸æ˜¯å› ä¸ºå¼±å¼•ç”¨ã€‚</p><p><a href=https://zhuanlan.zhihu.com/p/102571059 target=_blank rel=noopener>ThreadLocalçš„å†…å­˜æ³„éœ²ï¼Ÿä»€ä¹ˆåŸå› ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ - çŸ¥ä¹ (zhihu.com)</a></p><h1 id=5-ä½¿ç”¨åœºæ™¯>5. ä½¿ç”¨åœºæ™¯<a hidden class=anchor aria-hidden=true href=#5-ä½¿ç”¨åœºæ™¯>#</a></h1><h2 id=51-åœºæ™¯ä¸€ä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’>5.1 åœºæ™¯ä¸€ï¼šä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’<a hidden class=anchor aria-hidden=true href=#51-åœºæ™¯ä¸€ä»£æ›¿å‚æ•°çš„æ˜¾å¼ä¼ é€’>#</a></h2><p>å½“æˆ‘ä»¬åœ¨å†™APIæ¥å£çš„æ—¶å€™ï¼Œé€šå¸¸Controllerå±‚ä¼šæ¥å—æ¥è‡ªå‰ç«¯çš„å…¥å‚ï¼Œå½“è¿™ä¸ªæ¥å£åŠŸèƒ½æ¯”è¾ƒå¤æ‚çš„æ—¶å€™ï¼Œå¯èƒ½æˆ‘ä»¬è°ƒç”¨çš„Serviceå±‚å†…éƒ¨è¿˜è°ƒç”¨äº† å¾ˆå¤šå…¶ä»–çš„å¾ˆå¤šæ–¹æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¯ä¸ªè°ƒç”¨çš„æ–¹æ³•ä¸ŠåŠ ä¸Šéœ€è¦ä¼ é€’çš„å‚æ•°ã€‚</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†å‚æ•°å­˜å…¥ThreadLocalä¸­ï¼Œé‚£ä¹ˆå°±ä¸ç”¨æ˜¾å¼çš„ä¼ é€’å‚æ•°äº†ï¼Œè€Œæ˜¯åªéœ€è¦ThreadLocalä¸­è·å–å³å¯ã€‚</p><p>è¿™ä¸ªåœºæ™¯å…¶å®ä½¿ç”¨çš„æ¯”è¾ƒå°‘ï¼Œä¸€æ–¹é¢æ˜¾å¼ä¼ å‚æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå¦ä¸€æ–¹é¢æˆ‘ä»¬å¯ä»¥å°†å¤šä¸ªå‚æ•°å°è£…ä¸ºå¯¹è±¡å»ä¼ é€’ã€‚</p><h2 id=52-åœºæ™¯äºŒè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜>5.2 åœºæ™¯äºŒï¼šè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜<a hidden class=anchor aria-hidden=true href=#52-åœºæ™¯äºŒè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜>#</a></h2><p>åœ¨Springçš„Webé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†ä¸šåŠ¡åˆ†ä¸ºControllerå±‚ï¼ŒServiceå±‚ï¼ŒDaoå±‚ï¼Œ æˆ‘ä»¬éƒ½çŸ¥é“@Autowiredæ³¨è§£é»˜è®¤ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œé‚£ä¹ˆä¸åŒè¯·æ±‚çº¿ç¨‹è¿›æ¥ä¹‹åï¼Œç”±äºDaoå±‚ä½¿ç”¨å•ä¾‹ï¼Œé‚£ä¹ˆè´Ÿè´£æ•°æ®åº“è¿æ¥çš„Connectionä¹Ÿåªæœ‰ä¸€ä¸ªï¼Œ å¦‚æœæ¯ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½å»è¿æ¥æ•°æ®åº“ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆçº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ï¼ŒSpringæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ</p><p>åœ¨Springé¡¹ç›®ä¸­Daoå±‚ä¸­è£…é…çš„Connectionè‚¯å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…¶è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡‡ç”¨ThreadLocalæ–¹æ³•ï¼Œå½“æ¯ä¸ªè¯·æ±‚çº¿ç¨‹ä½¿ç”¨Connectionçš„æ—¶å€™ï¼Œ éƒ½ä¼šä»ThreadLocalè·å–ä¸€æ¬¡ï¼Œå¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰è¿›è¡Œè¿‡æ•°æ®åº“è¿æ¥ï¼Œè¿æ¥åå­˜å…¥ThreadLocalä¸­ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚çº¿ç¨‹éƒ½ä¿å­˜æœ‰ä¸€ä»½ è‡ªå·±çš„Connectionã€‚äºæ˜¯ä¾¿è§£å†³äº†çº¿ç¨‹å®‰å…¨é—®é¢˜</p><p>ThreadLocalåœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯ä¸ºè§£å†³å¹¶å‘é—®é¢˜è€Œæä¾›ä¸€ç§æ–¹æ¡ˆï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä»½è‡ªå·±çš„æ•°æ®ï¼Œè¾¾åˆ°çº¿ç¨‹éš”ç¦»çš„æ•ˆæœã€‚</p><h2 id=53-åœºæ™¯ä¸‰å…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯>5.3 åœºæ™¯ä¸‰ï¼šå…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯<a hidden class=anchor aria-hidden=true href=#53-åœºæ™¯ä¸‰å…¨å±€å­˜å‚¨ç”¨æˆ·ä¿¡æ¯>#</a></h2><p>åœ¨ç°åœ¨çš„ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œå‰åç«¯åˆ†ç¦»å·²åŸºæœ¬æˆä¸ºå¸¸æ€ï¼Œåˆ†ç¦»ä¹‹åå¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯å°±æˆäº†ä¸€ä»¶éº»çƒ¦äº‹ï¼Œé€šå¸¸åœ¨ç”¨æˆ·ç™»å½•åï¼Œ ç”¨æˆ·ä¿¡æ¯ä¼šä¿å­˜åœ¨Sessionæˆ–è€…Tokenä¸­ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¦‚æœä½¿ç”¨å¸¸è§„çš„æ‰‹æ®µå»è·å–ç”¨æˆ·ä¿¡æ¯ä¼šå¾ˆè´¹åŠ²ï¼Œæ‹¿Sessionæ¥è¯´ï¼Œæˆ‘ä»¬è¦åœ¨æ¥å£å‚æ•°ä¸­åŠ ä¸ŠHttpServletRequestå¯¹è±¡ï¼Œç„¶åè°ƒç”¨ getSessionæ–¹æ³•ï¼Œä¸”æ¯ä¸€ä¸ªéœ€è¦ç”¨æˆ·ä¿¡æ¯çš„æ¥å£éƒ½è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œæ‰èƒ½è·å–Sessionï¼Œè¿™æ ·å®ç°å°±å¾ˆéº»çƒ¦äº†ã€‚</p><p>åœ¨å®é™…çš„ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šä¸ä¼šé‡‡ç”¨ä¸Šé¢æ‰€è¯´çš„è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ä½¿ç”¨ThreadLocalï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©åœ¨æ‹¦æˆªå™¨çš„ä¸šåŠ¡ä¸­ï¼Œ è·å–åˆ°ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åå­˜å…¥ThreadLocalï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹åœ¨ä»»ä½•åœ°æ–¹å¦‚æœéœ€è¦æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯éƒ½å¯ä»¥ä½¿ç”¨ThreadLocalçš„get()æ–¹æ³•</p><blockquote><p>(å¼‚æ­¥ç¨‹åºä¸­ThreadLocalæ˜¯ä¸å¯é çš„, å› ä¸ºthreadLocalæ˜¯çº¿ç¨‹çº§åˆ«çš„, æ‰€ä»¥åªè¦å¼€äº†æ–°çº¿ç¨‹éƒ½ä¼šä¸¢å¤±ä¿¡æ¯</p><p>ä¾‹å¦‚, ä½¿ç”¨äº†<strong>çº¿ç¨‹æ± , future, feginè°ƒç”¨</strong> å°±ä¼šä¸¢å¤±threadlocalé‡Œçš„æ•°æ®(é™¤éthreadLocalæ˜¯å…¨å±€çš„)</p></blockquote><h1 id=6-å®æˆ˜>6. å®æˆ˜<a hidden class=anchor aria-hidden=true href=#6-å®æˆ˜>#</a></h1><h2 id=61-ä»£ç >6.1 ä»£ç <a hidden class=anchor aria-hidden=true href=#61-ä»£ç >#</a></h2><p>å…·ä½“å®ç°æµç¨‹ï¼š</p><ul><li>åœ¨ç™»å½•ä¸šåŠ¡ä»£ç ä¸­ï¼Œå½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œç”Ÿæˆä¸€ä¸ªç™»å½•å‡­è¯å­˜å‚¨åˆ°redisä¸­ï¼Œå°†å‡­è¯ä¸­çš„å­—ç¬¦ä¸²ä¿å­˜åœ¨cookieä¸­è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li><li>ä½¿ç”¨ä¸€ä¸ªæ‹¦æˆªå™¨æ‹¦æˆªè¯·æ±‚ï¼Œä»cookieä¸­è·å–å‡­è¯å­—ç¬¦ä¸²ä¸redisä¸­çš„å‡­è¯è¿›è¡ŒåŒ¹é…ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°ThreadLocalä¸­ï¼Œåœ¨æœ¬æ¬¡è¯·æ±‚ä¸­æŒæœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå³å¯åœ¨åç»­æ“ä½œä¸­ä½¿ç”¨åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</li></ul><p><strong>å®šä¹‰å·¥å…·ç±»æ“ä½œ[ThreadLocal]ï¼ˆå­˜æ”¾ï¼Œè·å–ï¼Œåˆ é™¤ç”¨æˆ·ä¿¡æ¯ï¼‰</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ThreadLocalUtil</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         * ä¿å­˜ç”¨æˆ·å¯¹è±¡çš„ThreadLocal  åœ¨æ‹¦æˆªå™¨æ“ä½œ æ·»åŠ ã€åˆ é™¤ç›¸å…³ç”¨æˆ·æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>FeginUser<span style=color:#ff7b72;font-weight:700>&gt;</span> userThreadLocal <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>FeginUser<span style=color:#ff7b72;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         * æ·»åŠ å½“å‰ç™»å½•ç”¨æˆ·æ–¹æ³•  åœ¨æ‹¦æˆªå™¨æ–¹æ³•æ‰§è¡Œå‰è°ƒç”¨è®¾ç½®è·å–ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         * @param user
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>addCurrentUser</span><span style=color:#ff7b72;font-weight:700>(</span>FeginUser user<span style=color:#ff7b72;font-weight:700>){</span>
</span></span><span style=display:flex><span>            userThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>set<span style=color:#ff7b72;font-weight:700>(</span>user<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         * è·å–å½“å‰ç™»å½•ç”¨æˆ·æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> FeginUser <span style=color:#d2a8ff;font-weight:700>getCurrentUser</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> userThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         * åˆ é™¤å½“å‰ç™»å½•ç”¨æˆ·æ–¹æ³•  åœ¨æ‹¦æˆªå™¨æ–¹æ³•æ‰§è¡Œå ç§»é™¤å½“å‰ç”¨æˆ·å¯¹è±¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>remove</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>            userThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>remove<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>æ‹¦æˆªå™¨</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Component</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UserInfoInterceptor</span> <span style=color:#ff7b72>implements</span> HandlerInterceptor  <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> UserInfoUtil userInfoUtil<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è¯·æ±‚æ‰§è¡Œå‰æ‰§è¡Œçš„ï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ”¾å…¥ThreadLocal
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param request
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param response
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param handler
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @throws Exception
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>boolean</span> <span style=color:#d2a8ff;font-weight:700>preHandle</span><span style=color:#ff7b72;font-weight:700>(</span>HttpServletRequest request<span style=color:#ff7b72;font-weight:700>,</span> HttpServletResponse response<span style=color:#ff7b72;font-weight:700>,</span> Object handler<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throws</span> Exception <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        FeginUser user<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>             user <span style=color:#ff7b72;font-weight:700>=</span> userInfoUtil<span style=color:#ff7b72;font-weight:700>.</span>getUser<span style=color:#ff7b72;font-weight:700>(</span>request<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span><span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>CustomException e<span style=color:#ff7b72;font-weight:700>){</span>
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;***************************ç”¨æˆ·æœªç™»å½•ï¼Œ ThreadLocalæ— ä¿¡æ¯***************************&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>!=</span>user<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;***************************ç”¨æˆ·å·²ç™»å½•ï¼Œç”¨æˆ·ä¿¡æ¯æ”¾å…¥ThreadLocal***************************&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            ThreadLocalUtil<span style=color:#ff7b72;font-weight:700>.</span>addCurrentUser<span style=color:#ff7b72;font-weight:700>(</span>user<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;***************************ç”¨æˆ·æœªç™»å½•ï¼Œ ThreadLocalæ— ä¿¡æ¯***************************&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * æ¥å£è®¿é—®ç»“æŸåï¼Œä»ThreadLocalä¸­åˆ é™¤ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param request
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param response
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param handler
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ex
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @throws Exception
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>afterCompletion</span><span style=color:#ff7b72;font-weight:700>(</span>HttpServletRequest request<span style=color:#ff7b72;font-weight:700>,</span> HttpServletResponse response<span style=color:#ff7b72;font-weight:700>,</span> Object handler<span style=color:#ff7b72;font-weight:700>,</span> Exception ex<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throws</span> Exception <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;***************************æ¥å£è°ƒç”¨ç»“æŸï¼Œ ä»ThreadLocalåˆ é™¤ç”¨æˆ·ä¿¡æ¯***************************&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        ThreadLocalUtil<span style=color:#ff7b72;font-weight:700>.</span>remove<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=62-å¼‚å¸¸å¤„ç†>6.2 å¼‚å¸¸å¤„ç†<a hidden class=anchor aria-hidden=true href=#62-å¼‚å¸¸å¤„ç†>#</a></h2><h3 id=621-feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´>6.2.1 feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´<a hidden class=anchor aria-hidden=true href=#621-feignè°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´>#</a></h3><p>ä»è¯·æ±‚å¤´ä¸­è·å–ç™»å½•token, ä¼šæœ‰ä¸ªé—®é¢˜, å¦‚æœä¸Šæ¸¸æ˜¯feginè°ƒç”¨, åˆ™è¯·æ±‚å¤´ä¼šä¸¢å¤±, æ‰€ä»¥éœ€è¦åœ¨feginè°ƒç”¨æ—¶æ‰‹åŠ¨è®¾ç½®token, <strong>å› ä¸ºfeignè°ƒç”¨ä¼šä½¿ç”¨æ–°çš„httpè¯·æ±‚ä¸”ä¸ä¼šæºå¸¦åŸæ¥httpçš„headerä¿¡æ¯</strong></p><blockquote><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> RequestInterceptor <span style=color:#d2a8ff;font-weight:700>requestInterceptor</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//å¤„ç†feignè¿œç¨‹è°ƒç”¨ä¸¢å¤±è¯·æ±‚å¤´é—®é¢˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> template <span style=color:#ff7b72;font-weight:700>-&gt;</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            HttpRequestUtil<span style=color:#ff7b72;font-weight:700>.</span>getHttpHeader<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>AUTHORIZATION<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>.</span>ifPresent<span style=color:#ff7b72;font-weight:700>(</span>auth <span style=color:#ff7b72;font-weight:700>-&gt;</span> template<span style=color:#ff7b72;font-weight:700>.</span>header<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>AUTHORIZATION<span style=color:#ff7b72;font-weight:700>,</span> auth<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>            HttpRequestUtil<span style=color:#ff7b72;font-weight:700>.</span>getHttpHeader<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>POWER_MENU_ID<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>.</span>ifPresent<span style=color:#ff7b72;font-weight:700>(</span>auth <span style=color:#ff7b72;font-weight:700>-&gt;</span> template<span style=color:#ff7b72;font-weight:700>.</span>header<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>POWER_MENU_ID<span style=color:#ff7b72;font-weight:700>,</span> auth<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>            HttpRequestUtil<span style=color:#ff7b72;font-weight:700>.</span>getHttpHeader<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>X_FLAG<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>.</span>ifPresent<span style=color:#ff7b72;font-weight:700>(</span>auth <span style=color:#ff7b72;font-weight:700>-&gt;</span> template<span style=color:#ff7b72;font-weight:700>.</span>header<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>X_FLAG<span style=color:#ff7b72;font-weight:700>,</span> auth<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>            HttpRequestUtil<span style=color:#ff7b72;font-weight:700>.</span>getHttpHeader<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>PLATFORM_FLAG<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>.</span>ifPresent<span style=color:#ff7b72;font-weight:700>(</span>auth <span style=color:#ff7b72;font-weight:700>-&gt;</span> template<span style=color:#ff7b72;font-weight:700>.</span>header<span style=color:#ff7b72;font-weight:700>(</span>Constant<span style=color:#ff7b72;font-weight:700>.</span>PLATFORM_FLAG<span style=color:#ff7b72;font-weight:700>,</span> auth<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>};</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div></blockquote><h3 id=622-å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´>6.2.2 å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´<a hidden class=anchor aria-hidden=true href=#622-å¤šçº¿ç¨‹ä¸­ä¸¢å¤±è¯·æ±‚å¤´>#</a></h3><p>å› ä¸ºthreadLocalæ˜¯çº¿ç¨‹å†…éƒ¨çš„, ä½¿ç”¨å¤šçº¿ç¨‹åthreadLocalä¼šä¸å†æœ‰æ•°æ®</p><p>è§£å†³æ–¹æ¡ˆ:</p><ol><li>æ‰‹åŠ¨ä¸ºå­çº¿ç¨‹é‡Œçš„requstè®¾ç½®è¯·æ±‚å¤´</li><li>ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆ, å°†threadLocalä¸­çš„æ•°æ®åœ¨å­çº¿ç¨‹ä¸­å†è®¾ç½®ä¸€é</li></ol><p><a href=../../spring/%e8%8e%b7%e5%8f%96%e7%94%a8%e6%88%b7%e4%bf%a1%e6%81%af%e5%b7%a5%e5%85%b7%e7%b1%bb.html>è·å–ç”¨æˆ·ä¿¡æ¯å·¥å…·ç±»</a></p><blockquote><p>spring security æ¡†æ¶é»˜è®¤ä¹Ÿæ²¡æœ‰è§£å†³</p><p><a href=https://www.cnblogs.com/precedeforetime/p/14601101.html target=_blank rel=noopener>spring security å¦‚ä½•åœ¨å­çº¿ç¨‹ä¸­è·å–çˆ¶çº¿ç¨‹ä¸­çš„ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼ˆæ›´æ”¹å®‰å…¨ç­–ç•¥ï¼‰ - precedeforetime - åšå®¢å›­ (cnblogs.com)</a></p></blockquote><h1 id=7-æ‰©å±•>7. æ‰©å±•<a hidden class=anchor aria-hidden=true href=#7-æ‰©å±•>#</a></h1><h2 id=71-inheritablethreadlocal>7.1 InheritableThreadLocal<a hidden class=anchor aria-hidden=true href=#71-inheritablethreadlocal>#</a></h2><p>InheritableThreadLocalç±»ç»§æ‰¿å¹¶é‡å†™äº†ThreadLocalçš„3ä¸ªå‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>InheritableThreadLocal</span><span style=color:#ff7b72;font-weight:700>&lt;</span>T<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#ff7b72>extends</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>T<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è¯¥å‡½æ•°åœ¨çˆ¶çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹ï¼Œå‘å­çº¿ç¨‹å¤åˆ¶InheritableThreadLocalå˜é‡æ—¶ä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>protected</span> T <span style=color:#d2a8ff;font-weight:700>childValue</span><span style=color:#ff7b72;font-weight:700>(</span>T parentValue<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> parentValue<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ç”±äºé‡å†™äº†getMapï¼Œæ“ä½œInheritableThreadLocalæ—¶ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * å°†åªå½±å“Threadç±»ä¸­çš„inheritableThreadLocalså˜é‡ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ä¸threadLocalså˜é‡ä¸å†æœ‰å…³ç³»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    ThreadLocalMap <span style=color:#d2a8ff;font-weight:700>getMap</span><span style=color:#ff7b72;font-weight:700>(</span>Thread t<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#ff7b72>return</span> t<span style=color:#ff7b72;font-weight:700>.</span>inheritableThreadLocals<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ç±»ä¼¼äºgetMapï¼Œæ“ä½œInheritableThreadLocalæ—¶ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * å°†åªå½±å“Threadç±»ä¸­çš„inheritableThreadLocalså˜é‡ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ä¸threadLocalså˜é‡ä¸å†æœ‰å…³ç³»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>createMap</span><span style=color:#ff7b72;font-weight:700>(</span>Thread t<span style=color:#ff7b72;font-weight:700>,</span> T firstValue<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        t<span style=color:#ff7b72;font-weight:700>.</span>inheritableThreadLocals <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ThreadLocalMap<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> firstValue<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>çº¿ç¨‹é—´ä¼ å€¼å®ç°åŸç†</strong></p><p>çº¿ç¨‹åˆå§‹åŒ–æ—¶å°†æ•°æ®ä» inheritableThreadLocals å–å‡ºå¹¶è®¾ç½®</p><p><strong>threadç±»</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Thread</span> <span style=color:#ff7b72>implements</span> Runnable <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#ff7b72;font-weight:700>......(</span>å…¶ä»–æºç <span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/* 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼Œä¸»è¦å­˜å‚¨è¯¥çº¿ç¨‹è‡ªèº«çš„ThreadLocal
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap threadLocals <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * InheritableThreadLocalï¼Œè‡ªçˆ¶çº¿ç¨‹é›†æˆè€Œæ¥çš„ThreadLocalMapï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ä¸»è¦ç”¨äºçˆ¶å­çº¿ç¨‹é—´ThreadLocalå˜é‡çš„ä¼ é€’
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * æœ¬æ–‡ä¸»è¦è®¨è®ºçš„å°±æ˜¯è¿™ä¸ªThreadLocalMap
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>ThreadLocalMap inheritableThreadLocals <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>......(</span>å…¶ä»–æºç <span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>çº¿ç¨‹åˆå§‹åŒ–</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¾ç½®inheritThreadLocalså¯ä¼ é€’
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>init</span><span style=color:#ff7b72;font-weight:700>(</span>ThreadGroup g<span style=color:#ff7b72;font-weight:700>,</span> Runnable target<span style=color:#ff7b72;font-weight:700>,</span> String name<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff7b72>long</span> stackSize<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        init<span style=color:#ff7b72;font-weight:700>(</span>g<span style=color:#ff7b72;font-weight:700>,</span> target<span style=color:#ff7b72;font-weight:700>,</span> name<span style=color:#ff7b72;font-weight:700>,</span> stackSize<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * åˆå§‹åŒ–ä¸€ä¸ªçº¿ç¨‹.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * æ­¤å‡½æ•°æœ‰ä¸¤å¤„è°ƒç”¨ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 1ã€ä¸Šé¢çš„ init()ï¼Œä¸ä¼ AccessControlContextï¼ŒinheritThreadLocals=true
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 2ã€ä¼ é€’AccessControlContextï¼ŒinheritThreadLocals=false
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>init</span><span style=color:#ff7b72;font-weight:700>(</span>ThreadGroup g<span style=color:#ff7b72;font-weight:700>,</span> Runnable target<span style=color:#ff7b72;font-weight:700>,</span> String name<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff7b72>long</span> stackSize<span style=color:#ff7b72;font-weight:700>,</span> AccessControlContext acc<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff7b72>boolean</span> inheritThreadLocals<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>......</span><span style=color:#f85149>ï¼ˆ</span>å…¶ä»–ä»£ç <span style=color:#f85149>ï¼‰</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>inheritThreadLocals <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> parent<span style=color:#ff7b72;font-weight:700>.</span>inheritableThreadLocals <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>inheritableThreadLocals <span style=color:#ff7b72;font-weight:700>=</span>
</span></span><span style=display:flex><span>                ThreadLocal<span style=color:#ff7b72;font-weight:700>.</span>createInheritedMap<span style=color:#ff7b72;font-weight:700>(</span>parent<span style=color:#ff7b72;font-weight:700>.</span>inheritableThreadLocals<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>......</span><span style=color:#f85149>ï¼ˆ</span>å…¶ä»–ä»£ç <span style=color:#f85149>ï¼‰</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p><strong>æ‰€ä»¥åªæœ‰çº¿ç¨‹åˆ›å»ºæ—¶æ‰ä¼š æ‰§è¡Œå€¼ä¼ é€’</strong></p></blockquote><h2 id=72-transmittablethreadlocalttl>7.2 TransmittableThreadLocal(TTL)<a hidden class=anchor aria-hidden=true href=#72-transmittablethreadlocalttl>#</a></h2><p>é˜¿é‡Œæä¾›çš„ åœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ï¼Œæä¾›<code>ThreadLocal</code>å€¼çš„ä¼ é€’åŠŸèƒ½ï¼Œè§£å†³å¼‚æ­¥æ‰§è¡Œæ—¶ä¸Šä¸‹æ–‡ä¼ é€’çš„é—®é¢˜ã€‚</p><blockquote><p>å…¶åº•å±‚æ˜¯ å°†æ•°æ®ä»çˆ¶çº¿ç¨‹ä¸­å–å‡ºæ¥, å†æ‰‹åŠ¨è®¾ç½®åˆ°å­çº¿ç¨‹ä¸­</p></blockquote><p><a href=https://github.com/alibaba/transmittable-thread-local target=_blank rel=noopener>TransmittableThreadLocal (TTL)</a></p><p><a href=https://zhuanlan.zhihu.com/p/102744180 target=_blank rel=noopener>ThreadLocalï¼Œä¸€ç¯‡æ–‡ç« å°±å¤Ÿäº† - çŸ¥ä¹ (zhihu.com)</a></p><p><a href=https://www.jianshu.com/p/80866ca6c424 target=_blank rel=noopener>ThreadLocalæºç åˆ†æ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href=https://www.cnblogs.com/cy0628/p/15086201.html target=_blank rel=noopener>ThreadLocalä¸ºä»€ä¹ˆä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ - Chenæ´‹ - åšå®¢å›­ (cnblogs.com)</a></p><p><a href=https://blog.csdn.net/qq_33240556/article/details/121071209 target=_blank rel=noopener>Java-ThreadLocalä¸‰ç§ä½¿ç”¨åœºæ™¯_ç”¨å¿ƒå»è¿½æ¢¦çš„åšå®¢-CSDNåšå®¢_java threadlocalåœºæ™¯</a></p><p><a href=https://blog.csdn.net/qq_39632561/article/details/115425564 target=_blank rel=noopener>ThreadLocalå­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼ˆspringbootï¼‰_ç¥éƒ½ç‡•çš„åšå®¢-CSDNåšå®¢_threadlocalå­˜å‚¨ç”¨æˆ·ä¿¡æ¯</a></p><p><a href=https://www.jianshu.com/p/94ba4a918ff5 target=_blank rel=noopener>InheritableThreadLocalè¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href=https://blog.csdn.net/agonie201218/article/details/125933740 target=_blank rel=noopener>ThreadLocal é¢è¯•å¤ºå‘½11è¿é—®_Youngä¸¶çš„åšå®¢-CSDNåšå®¢</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/%E5%B9%B6%E5%8F%91.html>å¹¶å‘</a></li><li><a href=https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E7%BD%91%E7%BB%9C/TCP.html><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>TCP</span></a>
<a class=next href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E6%9D%82%E9%A1%B9/timingwheel.html><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>timingwheel</span></a></nav></footer></article></main><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>