<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ForkJoin | ç±³äºŒ</title><meta name=keywords content=" å‰è¨€, 1. å·¥ä½œçªƒå–ç®—æ³•, 2. æºç è§£é‡Š, 2.1 ForkJoinTask, 2.2 ForkJoinWorkerThread, 2.3 ForkJoinPool, 2.4 WorkQueue, 2.5 runState, æ€»ç»“"><meta name=description content=" java çš„forkjoin"><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/fork_join.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/fork_join.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="ForkJoin"><meta property="og:description" content=" java çš„forkjoin"><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/fork_join.html"><meta property="article:section" content="javaåŠå…¶æ¡†æ¶"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-01T16:11:13+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ForkJoin"><meta name=twitter:description content=" java çš„forkjoin"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":5,"name":"ForkJoin","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/fork_join.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ForkJoin","name":"ForkJoin","description":" java çš„forkjoin","keywords":[" å‰è¨€"," 1. å·¥ä½œçªƒå–ç®—æ³•"," 2. æºç è§£é‡Š"," 2.1 ForkJoinTask"," 2.2 ForkJoinWorkerThread"," 2.3 ForkJoinPool"," 2.4 WorkQueue"," 2.5 runState"," æ€»ç»“"],"articleBody":"[toc]\nå‰è¨€ å®ƒé€šè¿‡ ã€Œ åˆ†è€Œæ²»ä¹‹ ã€ çš„æ–¹æ³•å°è¯•å°†æ‰€æœ‰å¯ç”¨çš„å¤„ç†å™¨å†…æ ¸ä½¿ç”¨èµ·æ¥å¸®åŠ©åŠ é€Ÿå¹¶è¡Œå¤„ç†ã€‚\nåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¿™ç§ ã€Œ åˆ†è€Œæ²»ä¹‹ ã€çš„æ–¹æ³•æ„å‘³ç€æ¡†æ¶é¦–å…ˆè¦ fork ï¼Œé€’å½’åœ°å°†ä»»åŠ¡åˆ†è§£ä¸ºè¾ƒå°çš„ç‹¬ç«‹å­ä»»åŠ¡ï¼Œç›´åˆ°å®ƒä»¬è¶³å¤Ÿç®€å•ä»¥ä¾¿å¼‚æ­¥æ‰§è¡Œã€‚ç„¶åï¼Œjoin éƒ¨åˆ†å¼€å§‹å·¥ä½œï¼Œå°†æ‰€æœ‰å­ä»»åŠ¡çš„ç»“æœé€’å½’åœ°è¿æ¥æˆå•ä¸ªç»“æœï¼Œæˆ–è€…åœ¨è¿”å› void çš„ä»»åŠ¡çš„æƒ…å†µä¸‹ï¼Œç¨‹åºåªæ˜¯ç­‰å¾…æ¯ä¸ªå­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚\nFork/Joinæ¡†æ¶æ˜¯ä¸€ä¸ªå®ç°äº†ExecutorServiceæ¥å£çš„å¤šçº¿ç¨‹å¤„ç†å™¨ï¼Œå®ƒä¸“ä¸ºé‚£äº›å¯ä»¥é€šè¿‡é€’å½’åˆ†è§£æˆæ›´ç»†å°çš„ä»»åŠ¡è€Œè®¾è®¡ï¼Œæœ€å¤§åŒ–çš„åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨æ¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚\nä¸å…¶ä»–ExecutorServiceç›¸å…³çš„å®ç°ç›¸åŒçš„æ˜¯ï¼ŒFork/Joinæ¡†æ¶ä¼šå°†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚è€Œä¸ä¹‹ä¸åŒçš„æ˜¯ï¼ŒFork/Joinæ¡†æ¶åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä½¿ç”¨äº†å·¥ä½œçªƒå–ç®—æ³•ã€‚\nForkJoin æœ‰ä¸¤å¤§æ ¸å¿ƒæ€æƒ³ï¼š\nåˆ†æ²»ç®—æ³•ï¼› å·¥ä½œå¯†å–ï¼šä¸ºäº†å……åˆ†åˆ©ç”¨ cpu èµ„æºï¼Œä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±é˜Ÿåˆ—çš„ä»»åŠ¡ä¹‹åï¼Œä¸ä¼šç©ºé—²ï¼Œè€Œæ˜¯ä»å…¶å®ƒé˜Ÿåˆ—é‡Œå¯»æ‰¾ä»»åŠ¡ã€‚ ä½¿ç”¨åœºæ™¯:\nForkJoinPool ä¸æ˜¯ä¸ºäº†æ›¿ä»£ ExecutorServiceï¼Œè€Œæ˜¯å®ƒçš„è¡¥å……ï¼Œåœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸‹æ€§èƒ½æ¯” ExecutorService æ›´å¥½ã€‚\nForkJoinPool ä¸»è¦ç”¨äºå®ç°â€œåˆ†è€Œæ²»ä¹‹â€çš„ç®—æ³•ï¼Œç‰¹åˆ«æ˜¯åˆ†æ²»ä¹‹åé€’å½’è°ƒç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚ quick sort ç­‰ã€‚\nForkJoinPool æœ€é€‚åˆçš„æ˜¯è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ I/Oï¼Œçº¿ç¨‹é—´åŒæ­¥ï¼Œsleep() ç­‰ä¼šé€ æˆçº¿ç¨‹é•¿æ—¶é—´é˜»å¡çš„æƒ…å†µæ—¶ï¼Œæœ€å¥½é…åˆä½¿ç”¨ ManagedBlockerã€‚\nManagedBlocker å®ƒå¯ä»¥æ§åˆ¶åœ¨é˜»å¡æ—¶å¢åŠ å¹¶è¡Œæ•°, è¿™æ ·å°±ä¸ä¼šå¡æ­»äº†\n18 Fork/Joinæ¡†æ¶ Â· æ·±å…¥æµ…å‡ºJavaå¤šçº¿ç¨‹ (redspider.group) ä¸€æ–‡ç§’æ‡‚ Java Fork/Join - Java ä¸€æ–‡ç§’æ‡‚ - ç®€å•æ•™ç¨‹ï¼Œç®€å•ç¼–ç¨‹ (twle.cn) åœ¨Java8 parallelStream()ä¸­ä½¿ç”¨I/O + ManagedBlockeræœ‰ä»€ä¹ˆé—®é¢˜å—? - ITå®åº“ (itbaoku.cn) å…³äºForkJoinPoolä½¿ç”¨ManagedBlockeré˜²çº¿ç¨‹é˜»å¡è€Œé™ä½ååé‡çš„è¯´æ˜_heng_zouçš„åšå®¢-CSDNåšå®¢_forkjoin é˜»å¡ ManagedBlockerçš„ä½¿ç”¨å’Œæ·±å…¥ç†è§£ForkJoin æœ‰å¾…æå‡\n1. å·¥ä½œçªƒå–ç®—æ³• å·¥ä½œçªƒå–ç®—æ³•æŒ‡çš„æ˜¯åœ¨å¤šçº¿ç¨‹æ‰§è¡Œä¸åŒä»»åŠ¡é˜Ÿåˆ—çš„è¿‡ç¨‹ä¸­ï¼ŒæŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±é˜Ÿåˆ—çš„ä»»åŠ¡åä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚\nå·¥ä½œçªƒå–æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹çªƒå–å¦ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†å‡å°‘ä¸¤ä¸ªä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨åŒç«¯é˜Ÿåˆ—æ¥å­˜å‚¨ä»»åŠ¡ã€‚è¢«çªƒå–çš„ä»»åŠ¡çº¿ç¨‹éƒ½ä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–å…¶ä»–ä»»åŠ¡çš„çº¿ç¨‹ä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‰§è¡Œä»»åŠ¡ã€‚\nå¦å¤–ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨çªƒå–ä»»åŠ¡æ—¶è¦æ˜¯æ²¡æœ‰å…¶ä»–å¯ç”¨çš„ä»»åŠ¡äº†ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ä»¥ç­‰å¾…å†æ¬¡â€œå·¥ä½œâ€ã€‚\nå·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹ï¼š å……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ã€‚\nå·¥ä½œçªƒå–ç®—æ³•çš„ç¼ºç‚¹ï¼š åœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚å¹¶ä¸”è¯¥ç®—æ³•ä¼šæ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚\n2. æºç è§£é‡Š 2.1 ForkJoinTask ForkJoinTaskä»£è¡¨è¿è¡Œåœ¨ForkJoinPoolä¸­çš„ä»»åŠ¡ã€‚\nä¸»è¦æ–¹æ³•ï¼š\nfork() åœ¨å½“å‰çº¿ç¨‹è¿è¡Œçš„çº¿ç¨‹æ± ä¸­å®‰æ’ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œã€‚ç®€å•çš„ç†è§£å°±æ˜¯å†åˆ›å»ºä¸€ä¸ªå­ä»»åŠ¡ã€‚ join() å½“ä»»åŠ¡å®Œæˆçš„æ—¶å€™è¿”å›è®¡ç®—ç»“æœã€‚ invoke() å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœå¿…è¦ï¼Œç­‰å¾…è®¡ç®—å®Œæˆã€‚ å­ç±»ï¼š\nRecursiveAction ä¸€ä¸ªé€’å½’æ— ç»“æœçš„ForkJoinTaskï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ RecursiveTask ä¸€ä¸ªé€’å½’æœ‰ç»“æœçš„ForkJoinTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰ ForkJoinTaskæ˜¯ä¸€ä¸ªç±»ä¼¼æ™®é€šçº¿ç¨‹çš„å®ä½“ï¼Œä½†æ˜¯æ¯”æ™®é€šçº¿ç¨‹è½»é‡å¾—å¤šã€‚\nfork()æ–¹æ³•:ä½¿ç”¨çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹å¼‚æ­¥æäº¤ä»»åŠ¡\n// æœ¬æ–‡æ‰€æœ‰ä»£ç éƒ½å¼•è‡ªJava 8 public final ForkJoinTask\u003cV\u003e fork() { Thread t; // ForkJoinWorkerThreadæ˜¯æ‰§è¡ŒForkJoinTaskçš„ä¸“æœ‰çº¿ç¨‹ï¼Œç”±ForkJoinPoolç®¡ç† // å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ForkJoinä¸“æœ‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†ä»»åŠ¡pushåˆ°å½“å‰çº¿ç¨‹æ‰€è´Ÿè´£çš„é˜Ÿåˆ—é‡Œå» if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ((ForkJoinWorkerThread)t).workQueue.push(this); else // å¦‚æœä¸æ˜¯åˆ™å°†çº¿ç¨‹åŠ å…¥é˜Ÿåˆ— // æ²¡æœ‰æ˜¾å¼åˆ›å»ºForkJoinPoolçš„æ—¶å€™èµ°è¿™é‡Œï¼Œæäº¤ä»»åŠ¡åˆ°é»˜è®¤çš„commonçº¿ç¨‹æ± ä¸­ ForkJoinPool.common.externalPush(this); return this; } å…¶å®fork()åªåšäº†ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯æŠŠä»»åŠ¡æ¨å…¥å½“å‰å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—é‡Œã€‚\njoin()æ–¹æ³•ï¼šç­‰å¾…å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹å¤„ç†å®Œæ¯•ï¼Œè·å¾—è¿”å›å€¼ã€‚æ¥çœ‹ä¸‹join()çš„æºç ï¼š\npublic final V join() { int s; // doJoin()æ–¹æ³•æ¥è·å–å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ if ((s = doJoin() \u0026 DONE_MASK) != NORMAL) // ä»»åŠ¡å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸ reportException(s); // ä»»åŠ¡æ­£å¸¸å®Œæˆï¼Œè·å–è¿”å›å€¼ return getRawResult(); } /** * doJoin()æ–¹æ³•ç”¨æ¥è¿”å›å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ **/ private int doJoin() { int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w; // å…ˆåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œå®Œæ¯•ç›´æ¥è¿”å›ç»“æœï¼ˆæ‰§è¡ŒçŠ¶æ€ï¼‰ return (s = status) \u003c 0 ? s : // å¦‚æœæ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ForkJoinWorkThreadçº¿ç¨‹ ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ? // å¦‚æœæ˜¯ï¼Œå…ˆåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¤„äºå·¥ä½œé˜Ÿåˆ—é¡¶ç«¯ï¼ˆæ„å‘³ç€ä¸‹ä¸€ä¸ªå°±æ‰§è¡Œå®ƒï¼‰ // tryUnpush()æ–¹æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¤„äºå½“å‰å·¥ä½œé˜Ÿåˆ—é¡¶ç«¯ï¼Œæ˜¯è¿”å›true // doExec()æ–¹æ³•æ‰§è¡Œä»»åŠ¡ (w = (wt = (ForkJoinWorkerThread)t).workQueue). // å¦‚æœæ˜¯å¤„äºé¡¶ç«¯å¹¶ä¸”ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœ tryUnpush(this) \u0026\u0026 (s = doExec()) \u003c 0 ? s : // å¦‚æœä¸åœ¨é¡¶ç«¯æˆ–è€…åœ¨é¡¶ç«¯å´æ²¡æœªæ‰§è¡Œå®Œæ¯•ï¼Œé‚£å°±è°ƒç”¨awitJoin()æ‰§è¡Œä»»åŠ¡ // awaitJoin()ï¼šä½¿ç”¨è‡ªæ—‹ä½¿ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œè¿”å›ç»“æœ wt.pool.awaitJoin(w, this, 0L) : // å¦‚æœä¸æ˜¯ForkJoinWorkThreadçº¿ç¨‹ï¼Œæ‰§è¡ŒexternalAwaitDone()è¿”å›ä»»åŠ¡ç»“æœ externalAwaitDone(); } æˆ‘ä»¬åœ¨ä¹‹å‰ä»‹ç»è¿‡è¯´Thread.join()ä¼šä½¿çº¿ç¨‹é˜»å¡ï¼Œè€ŒForkJoinPool.join()ä¼šä½¿çº¿ç¨‹å…äºé˜»å¡ï¼Œä¸‹é¢æ˜¯ForkJoinPool.join()çš„æµç¨‹å›¾ï¼š\n2.2 ForkJoinWorkerThread ForkJoinWorkerThreadä»£è¡¨ForkJoinPoolçº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚\n/** * Default ForkJoinWorkerThreadFactory implementation; creates a * new ForkJoinWorkerThread. */ static final class DefaultForkJoinWorkerThreadFactory implements ForkJoinWorkerThreadFactory { public final ForkJoinWorkerThread newThread(ForkJoinPool pool) { return new ForkJoinWorkerThread(pool); } } 2.3 ForkJoinPool ForkJoinPoolæ˜¯ç”¨äºæ‰§è¡ŒForkJoinTaskä»»åŠ¡çš„æ‰§è¡Œï¼ˆçº¿ç¨‹ï¼‰æ± ã€‚\nForkJoinPoolç®¡ç†ç€æ‰§è¡Œæ± ä¸­çš„çº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ­¤å¤–ï¼Œæ‰§è¡Œæ± æ˜¯å¦è¿˜æ¥å—ä»»åŠ¡ï¼Œæ˜¾ç¤ºçº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ä¹Ÿæ˜¯åœ¨è¿™é‡Œå¤„ç†ã€‚\næˆ‘ä»¬æ¥å¤§è‡´çœ‹ä¸‹ForkJoinPoolçš„æºç ï¼š\n@sun.misc.Contended public class ForkJoinPool extends AbstractExecutorService { // ä»»åŠ¡é˜Ÿåˆ— volatile WorkQueue[] workQueues; // çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ volatile int runState; // åˆ›å»ºForkJoinWorkerThreadçš„é»˜è®¤å·¥å‚ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°é‡å†™ public static final ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactory; // å…¬ç”¨çš„çº¿ç¨‹æ± ï¼Œå…¶è¿è¡ŒçŠ¶æ€ä¸å—shutdown()å’ŒshutdownNow()çš„å½±å“ static final ForkJoinPool common; // ç§æœ‰æ„é€ æ–¹æ³•ï¼Œæ²¡æœ‰ä»»ä½•å®‰å…¨æ£€æŸ¥å’Œå‚æ•°æ ¡éªŒï¼Œç”±makeCommonPoolç›´æ¥è°ƒç”¨ // å…¶ä»–æ„é€ æ–¹æ³•éƒ½æ˜¯æºè‡ªäºæ­¤æ–¹æ³• // parallelism: å¹¶è¡Œåº¦ï¼Œ // é»˜è®¤è°ƒç”¨java.lang.Runtime.availableProcessors() æ–¹æ³•è¿”å›å¯ç”¨å¤„ç†å™¨çš„æ•°é‡ private ForkJoinPool(int parallelism, ForkJoinWorkerThreadFactory factory, // å·¥ä½œçº¿ç¨‹å·¥å‚ UncaughtExceptionHandler handler, // æ‹’ç»ä»»åŠ¡çš„handler int mode, // åŒæ­¥æ¨¡å¼ String workerNamePrefix) { // çº¿ç¨‹åprefix this.workerNamePrefix = workerNamePrefix; this.factory = factory; this.ueh = handler; this.config = (parallelism \u0026 SMASK) | mode; long np = (long)(-parallelism); // offset ctl counts this.ctl = ((np \u003c\u003c AC_SHIFT) \u0026 AC_MASK) | ((np \u003c\u003c TC_SHIFT) \u0026 TC_MASK); } /** * Creates and returns the common pool, respecting user settings * specified via system properties. * jdk8 æä¾›äº†ä¸€ä¸ªç®€å•çš„pool,(é»˜è®¤å¹¶è¡Œæ•°æ˜¯cpuæ ¸æ•°-1), Lambdaä¸­(æ‰€æœ‰)çš„å¹¶è¡Œæµç”¨çš„å°±æ˜¯è¿™ä¸ªæ–¹æ³•,æ‰€ä»¥ä¹±ç”¨å¹¶è¡Œæµå¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡å¡æ­» */ private static ForkJoinPool makeCommonPool() { int parallelism = -1; ForkJoinWorkerThreadFactory factory = null; UncaughtExceptionHandler handler = null; try { // ignore exceptions in accessing/parsing properties String pp = System.getProperty (\"java.util.concurrent.ForkJoinPool.common.parallelism\"); String fp = System.getProperty (\"java.util.concurrent.ForkJoinPool.common.threadFactory\"); String hp = System.getProperty (\"java.util.concurrent.ForkJoinPool.common.exceptionHandler\"); if (pp != null) parallelism = Integer.parseInt(pp); if (fp != null) factory = ((ForkJoinWorkerThreadFactory)ClassLoader. getSystemClassLoader().loadClass(fp).newInstance()); if (hp != null) handler = ((UncaughtExceptionHandler)ClassLoader. getSystemClassLoader().loadClass(hp).newInstance()); } catch (Exception ignore) { } if (factory == null) { if (System.getSecurityManager() == null) factory = defaultForkJoinWorkerThreadFactory; else // use security-managed default factory = new InnocuousForkJoinWorkerThreadFactory(); } if (parallelism \u003c 0 \u0026\u0026 // default 1 less than #cores (parallelism = Runtime.getRuntime().availableProcessors() - 1) \u003c= 0) parallelism = 1; if (parallelism \u003e MAX_CAP) parallelism = MAX_CAP; return new ForkJoinPool(parallelism, factory, handler, LIFO_QUEUE,\"ForkJoinPool.commonPool-worker-\"); } } 2.4 WorkQueue åŒç«¯é˜Ÿåˆ—ï¼ŒForkJoinTaskä»¬å­˜æ”¾åœ¨è¿™é‡Œã€‚\nå½“å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œä¼šä»é˜Ÿåˆ—é¦–å–ä»»åŠ¡æ¥æ‰§è¡Œï¼ˆFIFOï¼‰ï¼›å¦‚æœæ˜¯çªƒå–å…¶ä»–é˜Ÿåˆ—çš„ä»»åŠ¡æ—¶ï¼Œçªƒå–çš„ä»»åŠ¡ä½äºæ‰€å±ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼ˆLIFOï¼‰ã€‚\nForkJoinPoolä¸ä¼ ç»Ÿçº¿ç¨‹æ± æœ€æ˜¾è‘—çš„åŒºåˆ«å°±æ˜¯å®ƒç»´æŠ¤äº†ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—æ•°ç»„ï¼ˆvolatile WorkQueue[] workQueuesï¼ŒForkJoinPoolä¸­çš„æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼‰ã€‚\narray åˆå§‹å®¹é‡ 8192ï¼› ç¬¬ä¸€ä¸ªä»»åŠ¡æ”¾åœ¨ 4096ï¼Œä¼¼ä¹æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿå†…å­˜çš„åŸå› ï¼› 8191 çš„ä½ç½®æ”¾å…¥ä»»åŠ¡ä¹‹åï¼Œè¿˜æ˜¯ä¼šå›åˆ° 0 çš„ä½ç½®ï¼› åˆå§‹ base = top = 4096ï¼› ä»ä¸Šé¢æ”¾å…¥ä¸€ä¸ªä»»åŠ¡ top + 1ï¼Œä¸ä¼šä»ä¸‹é¢æ”¾å…¥ä»»åŠ¡ï¼› LIFO æ¨¡å¼è‡ªå·±çº¿ç¨‹ä»ä¸Šé¢å–èµ°ä»»åŠ¡ top - 1ï¼› FIFO æ¨¡å¼è‡ªå·±çº¿ç¨‹ä»ä¸‹é¢å–èµ°ä»»åŠ¡ base + 1ï¼› è¢«å…¶å®ƒçº¿ç¨‹ä»ä¸‹é¢çªƒå–ä»»åŠ¡ï¼Œbase + 1ï¼Œå…¶å®ƒçº¿ç¨‹ä¸ä¼šä»ä¸Šé¢çªƒå–ä»»åŠ¡ï¼› æ•°ç»„ size ç”± top - base è·å¾—ï¼› ä» 8191 å›åˆ° 0 ä¹‹åï¼Œtop å’Œ base ä¼šç»§ç»­å¾€ä¸ŠåŠ ï¼Œç´¢å¼•å€¼é€šè¿‡å–ä½™è·å¾—ã€‚ static final int INITIAL_QUEUE_CAPACITY = 1 \u003c\u003c 13; // 2^13 = 8192 static final int MAXIMUM_QUEUE_CAPACITY = 1 \u003c\u003c 26; // 2^26 = 67108864 å¦‚æœé˜Ÿåˆ—é•¿åº¦ä¸å¤Ÿäº†,ä¼šè‡ªåŠ¨ä¸¤å€æ‰©å®¹çš„\n/** * Callback from ForkJoinWorkerThread constructor to establish and * record its WorkQueue. * * @param wt the worker thread * @return the worker's queue */ final WorkQueue registerWorker(ForkJoinWorkerThread wt) { UncaughtExceptionHandler handler; wt.setDaemon(true); // configure thread if ((handler = ueh) != null) wt.setUncaughtExceptionHandler(handler); WorkQueue w = new WorkQueue(this, wt); int i = 0; // assign a pool index int mode = config \u0026 MODE_MASK; int rs = lockRunState(); try { WorkQueue[] ws; int n; // skip if no array if ((ws = workQueues) != null \u0026\u0026 (n = ws.length) \u003e 0) { int s = indexSeed += SEED_INCREMENT; // unlikely to collide int m = n - 1; i = ((s \u003c\u003c 1) | 1) \u0026 m; // odd-numbered indices if (ws[i] != null) { // collision int probes = 0; // step by approx half n int step = (n \u003c= 4) ? 2 : ((n \u003e\u003e\u003e 1) \u0026 EVENMASK) + 2; while (ws[i = (i + step) \u0026 m] != null) { if (++probes \u003e= n) { // è¿™é‡Œç”¨ copyOf è¿›è¡Œå¤åˆ¶, è¿™æ®µä»£ç å¤ªéš¾è¯»äº†,ä»¥åå†æ¥åˆ†æå§ workQueues = ws = Arrays.copyOf(ws, n \u003c\u003c= 1); m = n - 1; probes = 0; } } } w.hint = s; // use as random seed w.config = i | mode; w.scanState = i; // publication fence ws[i] = w; } } finally { unlockRunState(rs, rs \u0026 ~RSLOCK); } wt.setName(workerNamePrefix.concat(Integer.toString(i \u003e\u003e\u003e 1))); return w; } 2.5 runState ForkJoinPoolçš„è¿è¡ŒçŠ¶æ€ã€‚SHUTDOWNçŠ¶æ€ç”¨è´Ÿæ•°è¡¨ç¤ºï¼Œå…¶ä»–ç”¨2çš„å¹‚æ¬¡è¡¨ç¤ºã€‚\næ€»ç»“ å¯¹äºä¸€ä¸ª new ForkJoinPool()ï¼Œæ‰§è¡Œä»»åŠ¡å…¨æµç¨‹å¦‚ä¸‹ï¼š\nForkJoinPool åˆå§‹åŒ– parallelism size = cpu é€»è¾‘æ ¸å¿ƒæ•°ï¼Œæ²¡æœ‰é˜Ÿåˆ—ï¼Œæ²¡æœ‰çº¿ç¨‹ï¼›\nå‘ ForkJoinPool æäº¤ä¸€ä¸ªä»»åŠ¡ï¼›\nåˆå§‹åŒ–é˜Ÿåˆ—æ•°ç»„ï¼Œå®¹é‡ä¸º 2 * Max { parallelism size, 2 ^ n }ï¼›\nåˆ›å»ºä¸€ä¸ªæ²¡æœ‰çº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œå®¹é‡ä¸º 2 ^ 13ï¼Œéšæœºæ”¾åœ¨é˜Ÿåˆ—æ•°ç»„çš„æŸä¸€ä¸ªå¶æ•°ç´¢å¼•å¤„ï¼›\nä»»åŠ¡å­˜å…¥è¿™ä¸ªé˜Ÿåˆ—ç´¢å¼•å€¼ä¸º 2 ^ 12 å¤„ï¼›\nå†åˆ›å»ºä¸€ä¸ªæœ‰çº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œå®¹é‡ä¸º 2 ^ 13ï¼Œéšæœºæ”¾åœ¨é˜Ÿåˆ—æ•°ç»„çš„æŸä¸€ä¸ªå¥‡æ•°ç´¢å¼•å¤„ï¼›\nçº¿ç¨‹å¯åŠ¨ï¼›\nçº¿ç¨‹ä»éšæœºä¸€ä¸ªé˜Ÿåˆ—å¼€å§‹ï¼Œéå†æ‰€æœ‰é˜Ÿåˆ—ï¼Œæœ€ç»ˆæ‰«ææ‰¾åˆ°å‰é¢æäº¤çš„ä»»åŠ¡ï¼Œå¹¶ä»å…¶æ‰€åœ¨é˜Ÿåˆ—å–å‡ºï¼›\nçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œæ‹†åˆ†å‡ºä¸¤ä¸ªå­ä»»åŠ¡ï¼›\nå¦‚æœç”¨ invokeAll æäº¤ï¼Œåˆ™ä¸€ä¸ªè¿›å…¥çº¿ç¨‹æ‰€åœ¨é˜Ÿåˆ—ï¼Œå¦ä¸€ä¸ªç›´æ¥åœ¨çº¿ç¨‹é‡Œæ‰§è¡Œï¼› å¦‚æœç”¨ fork æäº¤ï¼Œåˆ™ä¸¤ä¸ªéƒ½è¿›å…¥çº¿ç¨‹æ‰€åœ¨é˜Ÿåˆ—ï¼› æäº¤çš„å­ä»»åŠ¡è§¦å‘åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼ŒåŠä¸å…¶å¯¹åº”çš„é˜Ÿåˆ—ï¼Œè¿˜æ˜¯åœ¨å¥‡æ•°ç´¢å¼•å¤„ï¼›\næäº¤çš„å­ä»»åŠ¡å¯èƒ½ä»ç„¶è¢«å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œå¯èƒ½è¢«å…¶å®ƒçº¿ç¨‹çªƒå–ï¼›\nçº¿ç¨‹åœ¨å­ä»»åŠ¡å¤„ joinï¼Œjoin æœŸé—´ä¼šå°è¯•ä»çªƒå–è‡ªå·±ä»»åŠ¡çš„çº¿ç¨‹é‚£é‡Œçªƒå–ä»»åŠ¡æ‰§è¡Œï¼›\nä¼˜å…ˆçªƒå–é˜Ÿåˆ—åº•éƒ¨ï¼› é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡åˆ™çªƒå–å…¶æ­£åœ¨ join çš„ä»»åŠ¡ï¼› è¿˜æ²¡æœ‰åˆ™é˜»å¡è‡ªå·±ç­‰å¾…è¢«å”¤é†’ï¼Œåœ¨é˜»å¡ä¹‹å‰ä¼šè¡¥å¿ä¸€ä¸ªæ´»è·ƒçº¿ç¨‹ï¼› æäº¤çš„å­ä»»åŠ¡ä¸ç®¡è¢«å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä»ä¼šé‡å¤ä¸Šè¿°æ‹†åˆ†ã€æäº¤ã€çªƒå–ã€é˜»å¡æµç¨‹ï¼›\nå½“ä»»åŠ¡è¢«æ‹†åˆ†çš„è¶³å¤Ÿç»†ï¼Œåˆ™ä¼šçœŸæ­£å¼€å§‹è®¡ç®—ï¼›\nè®¡ç®—å®Œæˆä»é€’å½’ä¸€å±‚ä¸€å±‚è¿”å›ï¼›\næœ€ç»ˆæ‰€æœ‰å­ä»»åŠ¡éƒ½å®Œæˆï¼Œå¾—åˆ°ç»“æœï¼›\nå¦‚æœä¸å†æäº¤ä»»åŠ¡ï¼Œæ‰€æœ‰çº¿ç¨‹æ‰«æä¸åˆ°ä»»åŠ¡è¿›å…¥ inactive çŠ¶æ€ï¼›\næœ€ç»ˆï¼Œæ‰€æœ‰çº¿ç¨‹é”€æ¯ï¼Œæ‰€æœ‰å¥‡æ•°ç´¢å¼•ä½çš„é˜Ÿåˆ—å›æ”¶ï¼ŒForkJoinPool ä¸­åªå‰©ä¸‹ä¸€ä¸ªæœ€åˆåˆ›å»ºçš„åœ¨å¶æ•°ç´¢å¼•ä½çš„é˜Ÿåˆ—ã€‚\nthread_fork/joinå¹¶å‘æ¡†æ¶2 - dengzy - åšå®¢å›­ (cnblogs.com) [ç¬”è®°][Java7å¹¶å‘ç¼–ç¨‹å®æˆ˜æ‰‹å†Œ]5.Forkï¼¼Join(Java1.7æ–°ç‰¹æ€§)æ¡†æ¶_ä»£ç æœ‰æ¯’çš„åšå®¢-CSDNåšå®¢ Javaå¹¶å‘ç³»åˆ—ï¼ˆ12ï¼‰â€”â€”ForkJoinæ¡†æ¶æºç è§£æï¼ˆä¸Šï¼‰ - çŸ¥ä¹ (zhihu.com) Javaå¹¶å‘ç³»åˆ—ï¼ˆ12ï¼‰â€”â€”ForkJoinæ¡†æ¶æºç è§£æï¼ˆä¸‹ï¼‰ - çŸ¥ä¹ (zhihu.com) ","wordCount":"4417","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-01T16:11:13.282466672Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/fork_join.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.com/zh/search.html title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>ğŸ </a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80.html>javaåŸºç¡€</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91.html>å¹¶å‘</a> <span>></span></ul></nav><h1 class=post-title>ForkJoin</h1><div class=post-description>java çš„forkjoin</div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;æ›´æ–°:&nbsp;2023-09-01&nbsp;Â·&nbsp;9 åˆ†é’Ÿ&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></ul><span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=å‰è¨€>å‰è¨€</a></li><li><a href=#1-%e5%b7%a5%e4%bd%9c%e7%aa%83%e5%8f%96%e7%ae%97%e6%b3%95 aria-label="1. å·¥ä½œçªƒå–ç®—æ³•">1. å·¥ä½œçªƒå–ç®—æ³•</a></li><li><a href=#2-%e6%ba%90%e7%a0%81%e8%a7%a3%e9%87%8a aria-label="2. æºç è§£é‡Š">2. æºç è§£é‡Š</a><ul><li><a href=#21-forkjointask aria-label="2.1 ForkJoinTask">2.1 ForkJoinTask</a></li><li><a href=#22-forkjoinworkerthread aria-label="2.2 ForkJoinWorkerThread">2.2 ForkJoinWorkerThread</a></li><li><a href=#23-forkjoinpool aria-label="2.3 ForkJoinPool">2.3 ForkJoinPool</a></li><li><a href=#24-workqueue aria-label="2.4 WorkQueue">2.4 WorkQueue</a></li><li><a href=#25-runstate aria-label="2.5 runState">2.5 runState</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=å‰è¨€>å‰è¨€<a hidden class=anchor aria-hidden=true href=#å‰è¨€>#</a></h1><p>å®ƒé€šè¿‡ ã€Œ åˆ†è€Œæ²»ä¹‹ ã€ çš„æ–¹æ³•å°è¯•å°†æ‰€æœ‰å¯ç”¨çš„å¤„ç†å™¨å†…æ ¸ä½¿ç”¨èµ·æ¥å¸®åŠ©åŠ é€Ÿå¹¶è¡Œå¤„ç†ã€‚</p><p>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¿™ç§ ã€Œ åˆ†è€Œæ²»ä¹‹ ã€çš„æ–¹æ³•æ„å‘³ç€æ¡†æ¶é¦–å…ˆè¦ <code>fork</code> ï¼Œé€’å½’åœ°å°†ä»»åŠ¡åˆ†è§£ä¸ºè¾ƒå°çš„ç‹¬ç«‹å­ä»»åŠ¡ï¼Œç›´åˆ°å®ƒä»¬è¶³å¤Ÿç®€å•ä»¥ä¾¿å¼‚æ­¥æ‰§è¡Œã€‚ç„¶åï¼Œ<code>join</code> éƒ¨åˆ†å¼€å§‹å·¥ä½œï¼Œå°†æ‰€æœ‰å­ä»»åŠ¡çš„ç»“æœé€’å½’åœ°è¿æ¥æˆå•ä¸ªç»“æœï¼Œæˆ–è€…åœ¨è¿”å› void çš„ä»»åŠ¡çš„æƒ…å†µä¸‹ï¼Œç¨‹åºåªæ˜¯ç­‰å¾…æ¯ä¸ªå­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p><p>Fork/Joinæ¡†æ¶æ˜¯ä¸€ä¸ªå®ç°äº†ExecutorServiceæ¥å£çš„å¤šçº¿ç¨‹å¤„ç†å™¨ï¼Œå®ƒä¸“ä¸ºé‚£äº›å¯ä»¥é€šè¿‡é€’å½’åˆ†è§£æˆæ›´ç»†å°çš„ä»»åŠ¡è€Œè®¾è®¡ï¼Œæœ€å¤§åŒ–çš„åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨æ¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p><p>ä¸å…¶ä»–ExecutorServiceç›¸å…³çš„å®ç°ç›¸åŒçš„æ˜¯ï¼ŒFork/Joinæ¡†æ¶ä¼šå°†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚è€Œä¸ä¹‹ä¸åŒçš„æ˜¯ï¼ŒFork/Joinæ¡†æ¶åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä½¿ç”¨äº†<strong>å·¥ä½œçªƒå–ç®—æ³•</strong>ã€‚</p><p>ForkJoin æœ‰ä¸¤å¤§æ ¸å¿ƒæ€æƒ³ï¼š</p><ul><li>åˆ†æ²»ç®—æ³•ï¼›</li><li>å·¥ä½œå¯†å–ï¼šä¸ºäº†å……åˆ†åˆ©ç”¨ cpu èµ„æºï¼Œä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±é˜Ÿåˆ—çš„ä»»åŠ¡ä¹‹åï¼Œä¸ä¼šç©ºé—²ï¼Œè€Œæ˜¯ä»å…¶å®ƒé˜Ÿåˆ—é‡Œå¯»æ‰¾ä»»åŠ¡ã€‚</li></ul><p><strong>ä½¿ç”¨åœºæ™¯</strong>:</p><ol><li><p>ForkJoinPool ä¸æ˜¯ä¸ºäº†æ›¿ä»£ ExecutorServiceï¼Œè€Œæ˜¯å®ƒçš„è¡¥å……ï¼Œåœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸‹æ€§èƒ½æ¯” ExecutorService æ›´å¥½ã€‚</p></li><li><p>ForkJoinPool ä¸»è¦ç”¨äºå®ç°â€œåˆ†è€Œæ²»ä¹‹â€çš„ç®—æ³•ï¼Œç‰¹åˆ«æ˜¯åˆ†æ²»ä¹‹åé€’å½’è°ƒç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚ quick sort ç­‰ã€‚</p></li><li><p>ForkJoinPool æœ€é€‚åˆçš„æ˜¯è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ I/Oï¼Œçº¿ç¨‹é—´åŒæ­¥ï¼Œsleep() ç­‰ä¼šé€ æˆçº¿ç¨‹é•¿æ—¶é—´é˜»å¡çš„æƒ…å†µæ—¶ï¼Œæœ€å¥½é…åˆä½¿ç”¨ ManagedBlockerã€‚</p><blockquote><p>ManagedBlocker å®ƒå¯ä»¥æ§åˆ¶åœ¨é˜»å¡æ—¶å¢åŠ å¹¶è¡Œæ•°, è¿™æ ·å°±ä¸ä¼šå¡æ­»äº†</p></blockquote></li></ol><p><a href=http://concurrent.redspider.group/article/03/18.html target=_blank rel=noopener>18 Fork/Joinæ¡†æ¶ Â· æ·±å…¥æµ…å‡ºJavaå¤šçº¿ç¨‹ (redspider.group)</a></p><p><a href=https://www.twle.cn/c/yufei/javatm/javatm-basic-forkjoin.html target=_blank rel=noopener>ä¸€æ–‡ç§’æ‡‚ Java Fork/Join - Java ä¸€æ–‡ç§’æ‡‚ - ç®€å•æ•™ç¨‹ï¼Œç®€å•ç¼–ç¨‹ (twle.cn)</a></p><p><a href=https://www.itbaoku.cn/post/2147877/do target=_blank rel=noopener>åœ¨Java8 parallelStream()ä¸­ä½¿ç”¨I/O + ManagedBlockeræœ‰ä»€ä¹ˆé—®é¢˜å—? - ITå®åº“ (itbaoku.cn)</a></p><p><a href=https://blog.csdn.net/heng_zou/article/details/118193846 target=_blank rel=noopener>å…³äºForkJoinPoolä½¿ç”¨ManagedBlockeré˜²çº¿ç¨‹é˜»å¡è€Œé™ä½ååé‡çš„è¯´æ˜_heng_zouçš„åšå®¢-CSDNåšå®¢_forkjoin é˜»å¡</a></p><p><b style=color:red>ManagedBlockerçš„ä½¿ç”¨å’Œæ·±å…¥ç†è§£ForkJoin æœ‰å¾…æå‡</b></p><h1 id=1-å·¥ä½œçªƒå–ç®—æ³•>1. å·¥ä½œçªƒå–ç®—æ³•<a hidden class=anchor aria-hidden=true href=#1-å·¥ä½œçªƒå–ç®—æ³•>#</a></h1><p>å·¥ä½œçªƒå–ç®—æ³•æŒ‡çš„æ˜¯åœ¨å¤šçº¿ç¨‹æ‰§è¡Œä¸åŒä»»åŠ¡é˜Ÿåˆ—çš„è¿‡ç¨‹ä¸­ï¼ŒæŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±é˜Ÿåˆ—çš„ä»»åŠ¡åä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚</p><p>å·¥ä½œçªƒå–æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=http://concurrent.redspider.group/article/03/imgs/%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E7%AE%97%E6%B3%95%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=å·¥ä½œçªƒå–ç®—æ³•æµç¨‹></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹çªƒå–å¦ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†å‡å°‘ä¸¤ä¸ªä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨<strong>åŒç«¯é˜Ÿåˆ—</strong>æ¥å­˜å‚¨ä»»åŠ¡ã€‚è¢«çªƒå–çš„ä»»åŠ¡çº¿ç¨‹éƒ½ä»åŒç«¯é˜Ÿåˆ—çš„<strong>å¤´éƒ¨</strong>æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–å…¶ä»–ä»»åŠ¡çš„çº¿ç¨‹ä»åŒç«¯é˜Ÿåˆ—çš„<strong>å°¾éƒ¨</strong>æ‰§è¡Œä»»åŠ¡ã€‚</p><p>å¦å¤–ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨çªƒå–ä»»åŠ¡æ—¶è¦æ˜¯æ²¡æœ‰å…¶ä»–å¯ç”¨çš„ä»»åŠ¡äº†ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè¿›å…¥<strong>é˜»å¡çŠ¶æ€</strong>ä»¥ç­‰å¾…å†æ¬¡â€œå·¥ä½œâ€ã€‚</p><p><img loading=lazy src=forkJoin.assets/image-20230830172212889.png alt=image-20230830172212889></p><p>å·¥ä½œçªƒå–ç®—æ³•çš„<strong>ä¼˜ç‚¹</strong>ï¼š å……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ã€‚</p><p>å·¥ä½œçªƒå–ç®—æ³•çš„<strong>ç¼ºç‚¹</strong>ï¼š åœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚å¹¶ä¸”è¯¥ç®—æ³•ä¼šæ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚</p><h1 id=2-æºç è§£é‡Š>2. æºç è§£é‡Š<a hidden class=anchor aria-hidden=true href=#2-æºç è§£é‡Š>#</a></h1><p><img loading=lazy src=https://pic1.zhimg.com/v2-f8a4fa79f5e6b83671c3401f57b2f98c_r.jpg alt=img></p><h2 id=21-forkjointask>2.1 ForkJoinTask<a hidden class=anchor aria-hidden=true href=#21-forkjointask>#</a></h2><p>ForkJoinTaskä»£è¡¨è¿è¡Œåœ¨ForkJoinPoolä¸­çš„ä»»åŠ¡ã€‚</p><p>ä¸»è¦æ–¹æ³•ï¼š</p><ul><li>fork() åœ¨å½“å‰çº¿ç¨‹è¿è¡Œçš„çº¿ç¨‹æ± ä¸­å®‰æ’ä¸€ä¸ªå¼‚æ­¥æ‰§è¡Œã€‚ç®€å•çš„ç†è§£å°±æ˜¯å†åˆ›å»ºä¸€ä¸ªå­ä»»åŠ¡ã€‚</li><li>join() å½“ä»»åŠ¡å®Œæˆçš„æ—¶å€™è¿”å›è®¡ç®—ç»“æœã€‚</li><li>invoke() å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœå¿…è¦ï¼Œç­‰å¾…è®¡ç®—å®Œæˆã€‚</li></ul><p>å­ç±»ï¼š</p><ul><li>RecursiveAction ä¸€ä¸ªé€’å½’æ— ç»“æœçš„ForkJoinTaskï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰</li><li>RecursiveTask ä¸€ä¸ªé€’å½’æœ‰ç»“æœçš„ForkJoinTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰</li></ul><p>ForkJoinTaskæ˜¯ä¸€ä¸ªç±»ä¼¼æ™®é€šçº¿ç¨‹çš„å®ä½“ï¼Œä½†æ˜¯æ¯”æ™®é€šçº¿ç¨‹è½»é‡å¾—å¤šã€‚</p><p><strong>fork()æ–¹æ³•</strong>:ä½¿ç”¨çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹å¼‚æ­¥æäº¤ä»»åŠ¡</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æœ¬æ–‡æ‰€æœ‰ä»£ç éƒ½å¼•è‡ªJava 8
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>final</span> ForkJoinTask<span style=color:#ff7b72;font-weight:700>&lt;</span>V<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>fork</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    Thread t<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ForkJoinWorkerThreadæ˜¯æ‰§è¡ŒForkJoinTaskçš„ä¸“æœ‰çº¿ç¨‹ï¼Œç”±ForkJoinPoolç®¡ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ForkJoinä¸“æœ‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†ä»»åŠ¡pushåˆ°å½“å‰çº¿ç¨‹æ‰€è´Ÿè´£çš„é˜Ÿåˆ—é‡Œå»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>t <span style=color:#ff7b72;font-weight:700>=</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72>instanceof</span> ForkJoinWorkerThread<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>((</span>ForkJoinWorkerThread<span style=color:#ff7b72;font-weight:700>)</span>t<span style=color:#ff7b72;font-weight:700>).</span>workQueue<span style=color:#ff7b72;font-weight:700>.</span>push<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>
</span></span><span style=display:flex><span>         <span style=color:#8b949e;font-style:italic>// å¦‚æœä¸æ˜¯åˆ™å°†çº¿ç¨‹åŠ å…¥é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// æ²¡æœ‰æ˜¾å¼åˆ›å»ºForkJoinPoolçš„æ—¶å€™èµ°è¿™é‡Œï¼Œæäº¤ä»»åŠ¡åˆ°é»˜è®¤çš„commonçº¿ç¨‹æ± ä¸­
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        ForkJoinPool<span style=color:#ff7b72;font-weight:700>.</span>common<span style=color:#ff7b72;font-weight:700>.</span>externalPush<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>å…¶å®fork()åªåšäº†ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯<strong>æŠŠä»»åŠ¡æ¨å…¥å½“å‰å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—é‡Œ</strong>ã€‚</p><p><strong>join()æ–¹æ³•</strong>ï¼šç­‰å¾…å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹å¤„ç†å®Œæ¯•ï¼Œè·å¾—è¿”å›å€¼ã€‚æ¥çœ‹ä¸‹join()çš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>final</span> V <span style=color:#d2a8ff;font-weight:700>join</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>int</span> s<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// doJoin()æ–¹æ³•æ¥è·å–å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>s <span style=color:#ff7b72;font-weight:700>=</span> doJoin<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> DONE_MASK<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>!=</span> NORMAL<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä»»åŠ¡å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        reportException<span style=color:#ff7b72;font-weight:700>(</span>s<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä»»åŠ¡æ­£å¸¸å®Œæˆï¼Œè·å–è¿”å›å€¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> getRawResult<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * doJoin()æ–¹æ³•ç”¨æ¥è¿”å›å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> <span style=color:#ff7b72>int</span> <span style=color:#d2a8ff;font-weight:700>doJoin</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>int</span> s<span style=color:#ff7b72;font-weight:700>;</span> Thread t<span style=color:#ff7b72;font-weight:700>;</span> ForkJoinWorkerThread wt<span style=color:#ff7b72;font-weight:700>;</span> ForkJoinPool<span style=color:#ff7b72;font-weight:700>.</span>WorkQueue w<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å…ˆåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œå®Œæ¯•ç›´æ¥è¿”å›ç»“æœï¼ˆæ‰§è¡ŒçŠ¶æ€ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>(</span>s <span style=color:#ff7b72;font-weight:700>=</span> status<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&lt;</span> 0 <span style=color:#ff7b72;font-weight:700>?</span> s <span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¦‚æœæ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ForkJoinWorkThreadçº¿ç¨‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72;font-weight:700>((</span>t <span style=color:#ff7b72;font-weight:700>=</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72>instanceof</span> ForkJoinWorkerThread<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¦‚æœæ˜¯ï¼Œå…ˆåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¤„äºå·¥ä½œé˜Ÿåˆ—é¡¶ç«¯ï¼ˆæ„å‘³ç€ä¸‹ä¸€ä¸ªå°±æ‰§è¡Œå®ƒï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// tryUnpush()æ–¹æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¤„äºå½“å‰å·¥ä½œé˜Ÿåˆ—é¡¶ç«¯ï¼Œæ˜¯è¿”å›true
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// doExec()æ–¹æ³•æ‰§è¡Œä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72;font-weight:700>(</span>w <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>wt <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>ForkJoinWorkerThread<span style=color:#ff7b72;font-weight:700>)</span>t<span style=color:#ff7b72;font-weight:700>).</span>workQueue<span style=color:#ff7b72;font-weight:700>).</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¦‚æœæ˜¯å¤„äºé¡¶ç«¯å¹¶ä¸”ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        tryUnpush<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>(</span>s <span style=color:#ff7b72;font-weight:700>=</span> doExec<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>&lt;</span> 0 <span style=color:#ff7b72;font-weight:700>?</span> s <span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¦‚æœä¸åœ¨é¡¶ç«¯æˆ–è€…åœ¨é¡¶ç«¯å´æ²¡æœªæ‰§è¡Œå®Œæ¯•ï¼Œé‚£å°±è°ƒç”¨awitJoin()æ‰§è¡Œä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// awaitJoin()ï¼šä½¿ç”¨è‡ªæ—‹ä½¿ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œè¿”å›ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        wt<span style=color:#ff7b72;font-weight:700>.</span>pool<span style=color:#ff7b72;font-weight:700>.</span>awaitJoin<span style=color:#ff7b72;font-weight:700>(</span>w<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> 0L<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¦‚æœä¸æ˜¯ForkJoinWorkThreadçº¿ç¨‹ï¼Œæ‰§è¡ŒexternalAwaitDone()è¿”å›ä»»åŠ¡ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    externalAwaitDone<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬åœ¨ä¹‹å‰ä»‹ç»è¿‡è¯´Thread.join()ä¼šä½¿çº¿ç¨‹é˜»å¡ï¼Œè€ŒForkJoinPool.join()ä¼šä½¿çº¿ç¨‹å…äºé˜»å¡ï¼Œä¸‹é¢æ˜¯ForkJoinPool.join()çš„æµç¨‹å›¾ï¼š</p><p><img loading=lazy src=http://concurrent.redspider.group/article/03/imgs/join%E6%B5%81%E7%A8%8B%E5%9B%BE.png alt=joinæµç¨‹å›¾></p><h2 id=22-forkjoinworkerthread>2.2 ForkJoinWorkerThread<a hidden class=anchor aria-hidden=true href=#22-forkjoinworkerthread>#</a></h2><p>ForkJoinWorkerThreadä»£è¡¨ForkJoinPoolçº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚</p><p><img loading=lazy src=forkJoin.assets/874963-20180523163540976-673113189.png alt=img>
<img loading=lazy src=forkJoin.assets/874963-20180523163529873-1907395587.png alt=img>
<img loading=lazy src=forkJoin.assets/874963-20180523163554075-1223888829.png alt=img></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * Default ForkJoinWorkerThreadFactory implementation; creates a
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * new ForkJoinWorkerThread.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DefaultForkJoinWorkerThreadFactory</span> <span style=color:#ff7b72>implements</span> ForkJoinWorkerThreadFactory <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>final</span> ForkJoinWorkerThread <span style=color:#d2a8ff;font-weight:700>newThread</span><span style=color:#ff7b72;font-weight:700>(</span>ForkJoinPool pool<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> ForkJoinWorkerThread<span style=color:#ff7b72;font-weight:700>(</span>pool<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=23-forkjoinpool>2.3 ForkJoinPool<a hidden class=anchor aria-hidden=true href=#23-forkjoinpool>#</a></h2><p>ForkJoinPoolæ˜¯ç”¨äºæ‰§è¡ŒForkJoinTaskä»»åŠ¡çš„æ‰§è¡Œï¼ˆçº¿ç¨‹ï¼‰æ± ã€‚</p><p>ForkJoinPoolç®¡ç†ç€æ‰§è¡Œæ± ä¸­çš„çº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ­¤å¤–ï¼Œæ‰§è¡Œæ± æ˜¯å¦è¿˜æ¥å—ä»»åŠ¡ï¼Œæ˜¾ç¤ºçº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ä¹Ÿæ˜¯åœ¨è¿™é‡Œå¤„ç†ã€‚</p><p>æˆ‘ä»¬æ¥å¤§è‡´çœ‹ä¸‹ForkJoinPoolçš„æºç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@sun.misc.Contended</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ForkJoinPool</span> <span style=color:#ff7b72>extends</span> AbstractExecutorService <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä»»åŠ¡é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>volatile</span> WorkQueue<span style=color:#ff7b72;font-weight:700>[]</span> workQueues<span style=color:#ff7b72;font-weight:700>;</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>volatile</span> <span style=color:#ff7b72>int</span> runState<span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»ºForkJoinWorkerThreadçš„é»˜è®¤å·¥å‚ï¼Œå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°é‡å†™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactory<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å…¬ç”¨çš„çº¿ç¨‹æ± ï¼Œå…¶è¿è¡ŒçŠ¶æ€ä¸å—shutdown()å’ŒshutdownNow()çš„å½±å“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> ForkJoinPool common<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç§æœ‰æ„é€ æ–¹æ³•ï¼Œæ²¡æœ‰ä»»ä½•å®‰å…¨æ£€æŸ¥å’Œå‚æ•°æ ¡éªŒï¼Œç”±makeCommonPoolç›´æ¥è°ƒç”¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// å…¶ä»–æ„é€ æ–¹æ³•éƒ½æ˜¯æºè‡ªäºæ­¤æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// parallelism: å¹¶è¡Œåº¦ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// é»˜è®¤è°ƒç”¨java.lang.Runtime.availableProcessors() æ–¹æ³•è¿”å›å¯ç”¨å¤„ç†å™¨çš„æ•°é‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>private</span> <span style=color:#d2a8ff;font-weight:700>ForkJoinPool</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span> parallelism<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                         ForkJoinWorkerThreadFactory factory<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#8b949e;font-style:italic>// å·¥ä½œçº¿ç¨‹å·¥å‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                         UncaughtExceptionHandler handler<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#8b949e;font-style:italic>// æ‹’ç»ä»»åŠ¡çš„handler
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                         <span style=color:#ff7b72>int</span> mode<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#8b949e;font-style:italic>// åŒæ­¥æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                         String workerNamePrefix<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span> <span style=color:#8b949e;font-style:italic>// çº¿ç¨‹åprefix
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>workerNamePrefix <span style=color:#ff7b72;font-weight:700>=</span> workerNamePrefix<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>factory <span style=color:#ff7b72;font-weight:700>=</span> factory<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>ueh <span style=color:#ff7b72;font-weight:700>=</span> handler<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>config <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>parallelism <span style=color:#ff7b72;font-weight:700>&amp;</span> SMASK<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>|</span> mode<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>long</span> np <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>long</span><span style=color:#ff7b72;font-weight:700>)(-</span>parallelism<span style=color:#ff7b72;font-weight:700>);</span> <span style=color:#8b949e;font-style:italic>// offset ctl counts
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>ctl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>np <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> AC_SHIFT<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> AC_MASK<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>|</span> <span style=color:#ff7b72;font-weight:700>((</span>np <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> TC_SHIFT<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> TC_MASK<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * Creates and returns the common pool, respecting user settings
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * specified via system properties.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * jdk8 æä¾›äº†ä¸€ä¸ªç®€å•çš„pool,(é»˜è®¤å¹¶è¡Œæ•°æ˜¯cpuæ ¸æ•°-1), Lambdaä¸­(æ‰€æœ‰)çš„å¹¶è¡Œæµç”¨çš„å°±æ˜¯è¿™ä¸ªæ–¹æ³•,æ‰€ä»¥ä¹±ç”¨å¹¶è¡Œæµå¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡å¡æ­»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> ForkJoinPool <span style=color:#d2a8ff;font-weight:700>makeCommonPool</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>int</span> parallelism <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>-</span>1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        ForkJoinWorkerThreadFactory factory <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        UncaughtExceptionHandler handler <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>  <span style=color:#8b949e;font-style:italic>// ignore exceptions in accessing/parsing properties
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            String pp <span style=color:#ff7b72;font-weight:700>=</span> System<span style=color:#ff7b72;font-weight:700>.</span>getProperty
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;java.util.concurrent.ForkJoinPool.common.parallelism&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            String fp <span style=color:#ff7b72;font-weight:700>=</span> System<span style=color:#ff7b72;font-weight:700>.</span>getProperty
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;java.util.concurrent.ForkJoinPool.common.threadFactory&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            String hp <span style=color:#ff7b72;font-weight:700>=</span> System<span style=color:#ff7b72;font-weight:700>.</span>getProperty
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;java.util.concurrent.ForkJoinPool.common.exceptionHandler&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>pp <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                parallelism <span style=color:#ff7b72;font-weight:700>=</span> Integer<span style=color:#ff7b72;font-weight:700>.</span>parseInt<span style=color:#ff7b72;font-weight:700>(</span>pp<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>fp <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                factory <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>ForkJoinWorkerThreadFactory<span style=color:#ff7b72;font-weight:700>)</span>ClassLoader<span style=color:#ff7b72;font-weight:700>.</span>
</span></span><span style=display:flex><span>                           <span style=color:#d2a8ff;font-weight:700>getSystemClassLoader</span><span style=color:#ff7b72;font-weight:700>().</span>loadClass<span style=color:#ff7b72;font-weight:700>(</span>fp<span style=color:#ff7b72;font-weight:700>).</span>newInstance<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>hp <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                handler <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>UncaughtExceptionHandler<span style=color:#ff7b72;font-weight:700>)</span>ClassLoader<span style=color:#ff7b72;font-weight:700>.</span>
</span></span><span style=display:flex><span>                           <span style=color:#d2a8ff;font-weight:700>getSystemClassLoader</span><span style=color:#ff7b72;font-weight:700>().</span>loadClass<span style=color:#ff7b72;font-weight:700>(</span>hp<span style=color:#ff7b72;font-weight:700>).</span>newInstance<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Exception ignore<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>factory <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>System<span style=color:#ff7b72;font-weight:700>.</span>getSecurityManager<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                factory <span style=color:#ff7b72;font-weight:700>=</span> defaultForkJoinWorkerThreadFactory<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>else</span> <span style=color:#8b949e;font-style:italic>// use security-managed default
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                factory <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> InnocuousForkJoinWorkerThreadFactory<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>parallelism <span style=color:#ff7b72;font-weight:700>&lt;</span> 0 <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#8b949e;font-style:italic>// default 1 less than #cores
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72;font-weight:700>(</span>parallelism <span style=color:#ff7b72;font-weight:700>=</span> Runtime<span style=color:#ff7b72;font-weight:700>.</span>getRuntime<span style=color:#ff7b72;font-weight:700>().</span>availableProcessors<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&lt;=</span> 0<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>            parallelism <span style=color:#ff7b72;font-weight:700>=</span> 1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>parallelism <span style=color:#ff7b72;font-weight:700>&gt;</span> MAX_CAP<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>            parallelism <span style=color:#ff7b72;font-weight:700>=</span> MAX_CAP<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> ForkJoinPool<span style=color:#ff7b72;font-weight:700>(</span>parallelism<span style=color:#ff7b72;font-weight:700>,</span> factory<span style=color:#ff7b72;font-weight:700>,</span> handler<span style=color:#ff7b72;font-weight:700>,</span> LIFO_QUEUE<span style=color:#ff7b72;font-weight:700>,</span><span style=color:#a5d6ff>&#34;ForkJoinPool.commonPool-worker-&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=24-workqueue>2.4 WorkQueue<a hidden class=anchor aria-hidden=true href=#24-workqueue>#</a></h2><p>åŒç«¯é˜Ÿåˆ—ï¼ŒForkJoinTaskä»¬å­˜æ”¾åœ¨è¿™é‡Œã€‚</p><p>å½“å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œä¼šä»é˜Ÿåˆ—é¦–å–ä»»åŠ¡æ¥æ‰§è¡Œï¼ˆFIFOï¼‰ï¼›å¦‚æœæ˜¯çªƒå–å…¶ä»–é˜Ÿåˆ—çš„ä»»åŠ¡æ—¶ï¼Œçªƒå–çš„ä»»åŠ¡ä½äºæ‰€å±ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼ˆLIFOï¼‰ã€‚</p><p>ForkJoinPoolä¸ä¼ ç»Ÿçº¿ç¨‹æ± æœ€æ˜¾è‘—çš„åŒºåˆ«å°±æ˜¯å®ƒç»´æŠ¤äº†ä¸€ä¸ª<strong>å·¥ä½œé˜Ÿåˆ—æ•°ç»„</strong>ï¼ˆvolatile WorkQueue[] workQueuesï¼ŒForkJoinPoolä¸­çš„<strong>æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—</strong>ï¼‰ã€‚</p><p><img loading=lazy src=https://pic3.zhimg.com/v2-f9986f1e66a50778bbac48eb851e540e_r.jpg alt=img></p><blockquote><ul><li>array åˆå§‹å®¹é‡ 8192ï¼›</li><li>ç¬¬ä¸€ä¸ªä»»åŠ¡æ”¾åœ¨ 4096ï¼Œä¼¼ä¹æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿå†…å­˜çš„åŸå› ï¼›</li><li>8191 çš„ä½ç½®æ”¾å…¥ä»»åŠ¡ä¹‹åï¼Œè¿˜æ˜¯ä¼šå›åˆ° 0 çš„ä½ç½®ï¼›</li><li>åˆå§‹ base = top = 4096ï¼›</li><li>ä»ä¸Šé¢æ”¾å…¥ä¸€ä¸ªä»»åŠ¡ top + 1ï¼Œä¸ä¼šä»ä¸‹é¢æ”¾å…¥ä»»åŠ¡ï¼›</li><li>LIFO æ¨¡å¼è‡ªå·±çº¿ç¨‹ä»ä¸Šé¢å–èµ°ä»»åŠ¡ top - 1ï¼›</li><li>FIFO æ¨¡å¼è‡ªå·±çº¿ç¨‹ä»ä¸‹é¢å–èµ°ä»»åŠ¡ base + 1ï¼›</li><li>è¢«å…¶å®ƒçº¿ç¨‹ä»ä¸‹é¢çªƒå–ä»»åŠ¡ï¼Œbase + 1ï¼Œå…¶å®ƒçº¿ç¨‹ä¸ä¼šä»ä¸Šé¢çªƒå–ä»»åŠ¡ï¼›</li><li>æ•°ç»„ size ç”± top - base è·å¾—ï¼›</li><li>ä» 8191 å›åˆ° 0 ä¹‹åï¼Œtop å’Œ base ä¼šç»§ç»­å¾€ä¸ŠåŠ ï¼Œç´¢å¼•å€¼é€šè¿‡å–ä½™è·å¾—ã€‚</li></ul></blockquote><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>int</span> INITIAL_QUEUE_CAPACITY <span style=color:#ff7b72;font-weight:700>=</span> 1 <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> 13<span style=color:#ff7b72;font-weight:700>;</span> <span style=color:#8b949e;font-style:italic>// 2^13 =  8192
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>int</span> MAXIMUM_QUEUE_CAPACITY <span style=color:#ff7b72;font-weight:700>=</span> 1 <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> 26<span style=color:#ff7b72;font-weight:700>;</span> <span style=color:#8b949e;font-style:italic>// 2^26 = 67108864
</span></span></span></code></pre></div><p><strong>å¦‚æœé˜Ÿåˆ—é•¿åº¦ä¸å¤Ÿäº†,ä¼šè‡ªåŠ¨ä¸¤å€æ‰©å®¹çš„</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * Callback from ForkJoinWorkerThread constructor to establish and
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * record its WorkQueue.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param wt the worker thread
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return the worker&#39;s queue
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>final</span> WorkQueue <span style=color:#d2a8ff;font-weight:700>registerWorker</span><span style=color:#ff7b72;font-weight:700>(</span>ForkJoinWorkerThread wt<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        UncaughtExceptionHandler handler<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        wt<span style=color:#ff7b72;font-weight:700>.</span>setDaemon<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>                           <span style=color:#8b949e;font-style:italic>// configure thread
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>handler <span style=color:#ff7b72;font-weight:700>=</span> ueh<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>            wt<span style=color:#ff7b72;font-weight:700>.</span>setUncaughtExceptionHandler<span style=color:#ff7b72;font-weight:700>(</span>handler<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        WorkQueue w <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> WorkQueue<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> wt<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>int</span> i <span style=color:#ff7b72;font-weight:700>=</span> 0<span style=color:#ff7b72;font-weight:700>;</span>                                    <span style=color:#8b949e;font-style:italic>// assign a pool index
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>int</span> mode <span style=color:#ff7b72;font-weight:700>=</span> config <span style=color:#ff7b72;font-weight:700>&amp;</span> MODE_MASK<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>int</span> rs <span style=color:#ff7b72;font-weight:700>=</span> lockRunState<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            WorkQueue<span style=color:#ff7b72;font-weight:700>[]</span> ws<span style=color:#ff7b72;font-weight:700>;</span> <span style=color:#ff7b72>int</span> n<span style=color:#ff7b72;font-weight:700>;</span>                    <span style=color:#8b949e;font-style:italic>// skip if no array
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>ws <span style=color:#ff7b72;font-weight:700>=</span> workQueues<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>(</span>n <span style=color:#ff7b72;font-weight:700>=</span> ws<span style=color:#ff7b72;font-weight:700>.</span>length<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&gt;</span> 0<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>int</span> s <span style=color:#ff7b72;font-weight:700>=</span> indexSeed <span style=color:#ff7b72;font-weight:700>+=</span> SEED_INCREMENT<span style=color:#ff7b72;font-weight:700>;</span>  <span style=color:#8b949e;font-style:italic>// unlikely to collide
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>int</span> m <span style=color:#ff7b72;font-weight:700>=</span> n <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>s <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> 1<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>|</span> 1<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> m<span style=color:#ff7b72;font-weight:700>;</span>               <span style=color:#8b949e;font-style:italic>// odd-numbered indices
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>ws<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>                  <span style=color:#8b949e;font-style:italic>// collision
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    <span style=color:#ff7b72>int</span> probes <span style=color:#ff7b72;font-weight:700>=</span> 0<span style=color:#ff7b72;font-weight:700>;</span>                   <span style=color:#8b949e;font-style:italic>// step by approx half n
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    <span style=color:#ff7b72>int</span> step <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>n <span style=color:#ff7b72;font-weight:700>&lt;=</span> 4<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> 2 <span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72;font-weight:700>((</span>n <span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> 1<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> EVENMASK<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>+</span> 2<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>while</span> <span style=color:#ff7b72;font-weight:700>(</span>ws<span style=color:#ff7b72;font-weight:700>[</span>i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>i <span style=color:#ff7b72;font-weight:700>+</span> step<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> m<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(++</span>probes <span style=color:#ff7b72;font-weight:700>&gt;=</span> n<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#8b949e;font-style:italic>// è¿™é‡Œç”¨ copyOf è¿›è¡Œå¤åˆ¶, è¿™æ®µä»£ç å¤ªéš¾è¯»äº†,ä»¥åå†æ¥åˆ†æå§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                            workQueues <span style=color:#ff7b72;font-weight:700>=</span> ws <span style=color:#ff7b72;font-weight:700>=</span> Arrays<span style=color:#ff7b72;font-weight:700>.</span>copyOf<span style=color:#ff7b72;font-weight:700>(</span>ws<span style=color:#ff7b72;font-weight:700>,</span> n <span style=color:#ff7b72;font-weight:700>&lt;&lt;=</span> 1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                            m <span style=color:#ff7b72;font-weight:700>=</span> n <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                            probes <span style=color:#ff7b72;font-weight:700>=</span> 0<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                w<span style=color:#ff7b72;font-weight:700>.</span>hint <span style=color:#ff7b72;font-weight:700>=</span> s<span style=color:#ff7b72;font-weight:700>;</span>                           <span style=color:#8b949e;font-style:italic>// use as random seed
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                w<span style=color:#ff7b72;font-weight:700>.</span>config <span style=color:#ff7b72;font-weight:700>=</span> i <span style=color:#ff7b72;font-weight:700>|</span> mode<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                w<span style=color:#ff7b72;font-weight:700>.</span>scanState <span style=color:#ff7b72;font-weight:700>=</span> i<span style=color:#ff7b72;font-weight:700>;</span>                      <span style=color:#8b949e;font-style:italic>// publication fence
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                ws<span style=color:#ff7b72;font-weight:700>[</span>i<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>=</span> w<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>finally</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            unlockRunState<span style=color:#ff7b72;font-weight:700>(</span>rs<span style=color:#ff7b72;font-weight:700>,</span> rs <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#ff7b72;font-weight:700>~</span>RSLOCK<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        wt<span style=color:#ff7b72;font-weight:700>.</span>setName<span style=color:#ff7b72;font-weight:700>(</span>workerNamePrefix<span style=color:#ff7b72;font-weight:700>.</span>concat<span style=color:#ff7b72;font-weight:700>(</span>Integer<span style=color:#ff7b72;font-weight:700>.</span>toString<span style=color:#ff7b72;font-weight:700>(</span>i <span style=color:#ff7b72;font-weight:700>&gt;&gt;&gt;</span> 1<span style=color:#ff7b72;font-weight:700>)));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> w<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><img loading=lazy src=forkJoin.assets/1363696-20200507171234445-1579744101.jpg alt=img></p><h2 id=25-runstate>2.5 runState<a hidden class=anchor aria-hidden=true href=#25-runstate>#</a></h2><p>ForkJoinPoolçš„è¿è¡ŒçŠ¶æ€ã€‚<strong>SHUTDOWN</strong>çŠ¶æ€ç”¨è´Ÿæ•°è¡¨ç¤ºï¼Œå…¶ä»–ç”¨2çš„å¹‚æ¬¡è¡¨ç¤ºã€‚</p><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>å¯¹äºä¸€ä¸ª new ForkJoinPool()ï¼Œæ‰§è¡Œä»»åŠ¡å…¨æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>ForkJoinPool åˆå§‹åŒ– parallelism size = cpu é€»è¾‘æ ¸å¿ƒæ•°ï¼Œæ²¡æœ‰é˜Ÿåˆ—ï¼Œæ²¡æœ‰çº¿ç¨‹ï¼›</p></li><li><p>å‘ ForkJoinPool æäº¤ä¸€ä¸ªä»»åŠ¡ï¼›</p></li><li><p>åˆå§‹åŒ–é˜Ÿåˆ—æ•°ç»„ï¼Œå®¹é‡ä¸º 2 * Max { parallelism size, 2 ^ n }ï¼›</p></li><li><p>åˆ›å»ºä¸€ä¸ªæ²¡æœ‰çº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œå®¹é‡ä¸º 2 ^ 13ï¼Œéšæœºæ”¾åœ¨é˜Ÿåˆ—æ•°ç»„çš„æŸä¸€ä¸ªå¶æ•°ç´¢å¼•å¤„ï¼›</p></li><li><p>ä»»åŠ¡å­˜å…¥è¿™ä¸ªé˜Ÿåˆ—ç´¢å¼•å€¼ä¸º 2 ^ 12 å¤„ï¼›</p></li><li><p>å†åˆ›å»ºä¸€ä¸ªæœ‰çº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œå®¹é‡ä¸º 2 ^ 13ï¼Œéšæœºæ”¾åœ¨é˜Ÿåˆ—æ•°ç»„çš„æŸä¸€ä¸ªå¥‡æ•°ç´¢å¼•å¤„ï¼›</p></li><li><p>çº¿ç¨‹å¯åŠ¨ï¼›</p></li><li><p>çº¿ç¨‹ä»éšæœºä¸€ä¸ªé˜Ÿåˆ—å¼€å§‹ï¼Œéå†æ‰€æœ‰é˜Ÿåˆ—ï¼Œæœ€ç»ˆæ‰«ææ‰¾åˆ°å‰é¢æäº¤çš„ä»»åŠ¡ï¼Œå¹¶ä»å…¶æ‰€åœ¨é˜Ÿåˆ—å–å‡ºï¼›</p></li><li><p>çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œæ‹†åˆ†å‡ºä¸¤ä¸ªå­ä»»åŠ¡ï¼›</p><ul><li>å¦‚æœç”¨ invokeAll æäº¤ï¼Œåˆ™ä¸€ä¸ªè¿›å…¥çº¿ç¨‹æ‰€åœ¨é˜Ÿåˆ—ï¼Œå¦ä¸€ä¸ªç›´æ¥åœ¨çº¿ç¨‹é‡Œæ‰§è¡Œï¼›</li><li>å¦‚æœç”¨ fork æäº¤ï¼Œåˆ™ä¸¤ä¸ªéƒ½è¿›å…¥çº¿ç¨‹æ‰€åœ¨é˜Ÿåˆ—ï¼›</li></ul></li><li><p>æäº¤çš„å­ä»»åŠ¡è§¦å‘åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼ŒåŠä¸å…¶å¯¹åº”çš„é˜Ÿåˆ—ï¼Œè¿˜æ˜¯åœ¨å¥‡æ•°ç´¢å¼•å¤„ï¼›</p></li><li><p>æäº¤çš„å­ä»»åŠ¡å¯èƒ½ä»ç„¶è¢«å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œå¯èƒ½è¢«å…¶å®ƒçº¿ç¨‹çªƒå–ï¼›</p></li><li><p>çº¿ç¨‹åœ¨å­ä»»åŠ¡å¤„ joinï¼Œjoin æœŸé—´ä¼šå°è¯•ä»çªƒå–è‡ªå·±ä»»åŠ¡çš„çº¿ç¨‹é‚£é‡Œçªƒå–ä»»åŠ¡æ‰§è¡Œï¼›</p><ul><li>ä¼˜å…ˆçªƒå–é˜Ÿåˆ—åº•éƒ¨ï¼›</li><li>é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡åˆ™çªƒå–å…¶æ­£åœ¨ join çš„ä»»åŠ¡ï¼›</li><li>è¿˜æ²¡æœ‰åˆ™é˜»å¡è‡ªå·±ç­‰å¾…è¢«å”¤é†’ï¼Œåœ¨é˜»å¡ä¹‹å‰ä¼šè¡¥å¿ä¸€ä¸ªæ´»è·ƒçº¿ç¨‹ï¼›</li></ul></li><li><p>æäº¤çš„å­ä»»åŠ¡ä¸ç®¡è¢«å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä»ä¼šé‡å¤ä¸Šè¿°æ‹†åˆ†ã€æäº¤ã€çªƒå–ã€é˜»å¡æµç¨‹ï¼›</p></li><li><p>å½“ä»»åŠ¡è¢«æ‹†åˆ†çš„è¶³å¤Ÿç»†ï¼Œåˆ™ä¼šçœŸæ­£å¼€å§‹è®¡ç®—ï¼›</p></li><li><p>è®¡ç®—å®Œæˆä»é€’å½’ä¸€å±‚ä¸€å±‚è¿”å›ï¼›</p></li><li><p>æœ€ç»ˆæ‰€æœ‰å­ä»»åŠ¡éƒ½å®Œæˆï¼Œå¾—åˆ°ç»“æœï¼›</p></li><li><p>å¦‚æœä¸å†æäº¤ä»»åŠ¡ï¼Œæ‰€æœ‰çº¿ç¨‹æ‰«æä¸åˆ°ä»»åŠ¡è¿›å…¥ inactive çŠ¶æ€ï¼›</p></li><li><p>æœ€ç»ˆï¼Œæ‰€æœ‰çº¿ç¨‹é”€æ¯ï¼Œæ‰€æœ‰å¥‡æ•°ç´¢å¼•ä½çš„é˜Ÿåˆ—å›æ”¶ï¼ŒForkJoinPool ä¸­åªå‰©ä¸‹ä¸€ä¸ªæœ€åˆåˆ›å»ºçš„åœ¨å¶æ•°ç´¢å¼•ä½çš„é˜Ÿåˆ—ã€‚</p></li></ul><p><a href=https://www.cnblogs.com/dengzy/p/5808170.html target=_blank rel=noopener>thread_fork/joinå¹¶å‘æ¡†æ¶2 - dengzy - åšå®¢å›­ (cnblogs.com)</a></p><p>[<a href=https://blog.csdn.net/mr_zhuqiang/article/details/48300229 target=_blank rel=noopener>ç¬”è®°][Java7å¹¶å‘ç¼–ç¨‹å®æˆ˜æ‰‹å†Œ]5.Forkï¼¼Join(Java1.7æ–°ç‰¹æ€§)æ¡†æ¶_ä»£ç æœ‰æ¯’çš„åšå®¢-CSDNåšå®¢</a></p><p><a href=https://zhuanlan.zhihu.com/p/281875848 target=_blank rel=noopener>Javaå¹¶å‘ç³»åˆ—ï¼ˆ12ï¼‰â€”â€”ForkJoinæ¡†æ¶æºç è§£æï¼ˆä¸Šï¼‰ - çŸ¥ä¹ (zhihu.com)</a></p><p><a href=https://zhuanlan.zhihu.com/p/281896040 target=_blank rel=noopener>Javaå¹¶å‘ç³»åˆ—ï¼ˆ12ï¼‰â€”â€”ForkJoinæ¡†æ¶æºç è§£æï¼ˆä¸‹ï¼‰ - çŸ¥ä¹ (zhihu.com)</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/%E5%B9%B6%E5%8F%91.html>å¹¶å‘</a></li><li><a href=https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springBoot/filter.html><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>filter</span></a>
<a class=next href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/git%E5%92%8Csvn.html><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>gitå’Œsvn</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>