<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>å¹¶å‘å®¹å™¨é›†åˆ | ç±³äºŒ</title><meta name=keywords content=" 1. å¹¶å‘å®¹å™¨ç±»ä»‹ç», 2. ConcurrentHashMap, 2.1  jdk1.7å®ç°, putæ“ä½œ, 2.2 jdk1.8 å®ç°, putæ“ä½œ, transfer() æ‰©å®¹æ“ä½œ, getæ“ä½œ, 2.3 é¢è¯•é¢˜"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E9%9B%86%E5%90%88.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E9%9B%86%E5%90%88.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="å¹¶å‘å®¹å™¨é›†åˆ"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E9%9B%86%E5%90%88.html"><meta property="article:section" content="javaåŠå…¶æ¡†æ¶"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-30T16:23:43+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="å¹¶å‘å®¹å™¨é›†åˆ"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":5,"name":"å¹¶å‘å®¹å™¨é›†åˆ","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E9%9B%86%E5%90%88.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"å¹¶å‘å®¹å™¨é›†åˆ","name":"å¹¶å‘å®¹å™¨é›†åˆ","description":"     ","keywords":[" 1. å¹¶å‘å®¹å™¨ç±»ä»‹ç»"," 2. ConcurrentHashMap"," 2.1  jdk1.7å®ç°"," putæ“ä½œ"," 2.2 jdk1.8 å®ç°"," putæ“ä½œ"," transfer() æ‰©å®¹æ“ä½œ"," getæ“ä½œ"," 2.3 é¢è¯•é¢˜"],"articleBody":"[TOC]\n1. å¹¶å‘å®¹å™¨ç±»ä»‹ç» 2. ConcurrentHashMap 2.1 jdk1.7å®ç° åœ¨JDK1.7ç‰ˆæœ¬ä¸­ï¼ŒConcurrentHashMapçš„æ•°æ®ç»“æ„æ˜¯ç”±ä¸€ä¸ªSegmentæ•°ç»„å’Œå¤šä¸ªHashEntryç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nSegmentæ•°ç»„çš„æ„ä¹‰å°±æ˜¯å°†ä¸€ä¸ªå¤§çš„tableåˆ†å‰²æˆå¤šä¸ªå°çš„tableæ¥è¿›è¡ŒåŠ é”ï¼Œè€Œæ¯ä¸€ä¸ªSegmentå…ƒç´ å­˜å‚¨çš„æ˜¯HashEntryæ•°ç»„+é“¾è¡¨ï¼Œè¿™ä¸ªå’ŒHashMapçš„æ•°æ®å­˜å‚¨ç»“æ„ä¸€æ ·\nputæ“ä½œ å¯¹äºConcurrentHashMapçš„æ•°æ®æ’å…¥ï¼Œè¿™é‡Œè¦è¿›è¡Œä¸¤æ¬¡Hashå»å®šä½æ•°æ®çš„å­˜å‚¨ä½ç½®\nstatic class Segment\u003cK,V\u003e extends ReentrantLock implements Serializable { } ä»ä¸ŠSegmentçš„ç»§æ‰¿ä½“ç³»å¯ä»¥çœ‹å‡ºï¼ŒSegmentå®ç°äº†ReentrantLock,ä¹Ÿå°±å¸¦æœ‰é”çš„åŠŸèƒ½ï¼Œ\nå½“æ‰§è¡Œputæ“ä½œæ—¶ï¼Œä¼šè¿›è¡Œç¬¬ä¸€æ¬¡keyçš„hashæ¥å®šä½Segmentçš„ä½ç½®ï¼Œå¦‚æœè¯¥Segmentè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå³é€šè¿‡CASæ“ä½œè¿›è¡Œèµ‹å€¼ï¼Œç„¶åè¿›è¡Œç¬¬äºŒæ¬¡hashæ“ä½œï¼Œæ‰¾åˆ°ç›¸åº”çš„HashEntryçš„ä½ç½®ï¼Œè¿™é‡Œä¼šåˆ©ç”¨ç»§æ‰¿è¿‡æ¥çš„é”çš„ç‰¹æ€§ï¼Œåœ¨å°†æ•°æ®æ’å…¥æŒ‡å®šçš„HashEntryä½ç½®æ—¶ï¼ˆé“¾è¡¨çš„å°¾ç«¯ï¼‰ï¼Œä¼šé€šè¿‡ç»§æ‰¿ReentrantLockçš„tryLockï¼ˆï¼‰æ–¹æ³•å°è¯•å»è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸå°±ç›´æ¥æ’å…¥ç›¸åº”çš„ä½ç½®ï¼Œå¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å–è¯¥Segmentçš„é”ï¼Œé‚£å½“å‰çº¿ç¨‹ä¼šä»¥è‡ªæ—‹çš„æ–¹å¼å»ç»§ç»­çš„è°ƒç”¨tryLockï¼ˆï¼‰æ–¹æ³•å»è·å–é”ï¼Œè¶…è¿‡æŒ‡å®šæ¬¡æ•°å°±æŒ‚èµ·ï¼Œç­‰å¾…å”¤é†’\nç®€å•çš„è¯´, ä¼šé€šè¿‡ä¸¤æ¬¡hashåˆ†åˆ«æ‰¾åˆ°å¯¹åº”çš„Segmentå’ŒhashEntryçš„ä½ç½®, ç„¶åå†æ’è¿›å», æ¯ä¸ªSegmentéƒ½æ˜¯ReentrantLocké”, æ‰€ä»¥åœ¨Segmentä¸ŠåŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨\n2.2 jdk1.8 å®ç° JDK1.8çš„å®ç°å·²ç»æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨Synchronizedå’ŒCASæ¥æ“ä½œï¼Œæ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„HashMapï¼Œè™½ç„¶åœ¨JDK1.8ä¸­è¿˜èƒ½çœ‹åˆ°Segmentçš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬\nè¿™äº›æ˜¯æ„æˆConcurrentHashMapå®ç°ç»“æ„çš„åŸºç¡€ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹åŸºæœ¬å±æ€§ï¼š\n// nodeæ•°ç»„æœ€å¤§å®¹é‡ï¼š2^30=1073741824 private static final int MAXIMUM_CAPACITY = 1 \u003c\u003c 30 ; // é»˜è®¤åˆå§‹å€¼ï¼Œå¿…é¡»æ˜¯2çš„å¹‚æ•° private static final int DEFAULT_CAPACITY = 16 ; //æ•°ç»„å¯èƒ½æœ€å¤§å€¼ï¼Œéœ€è¦ä¸toArrayï¼ˆï¼‰ç›¸å…³æ–¹æ³•å…³è” static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8 ; //å¹¶å‘çº§åˆ«ï¼Œé—ç•™ä¸‹æ¥çš„ï¼Œä¸ºå…¼å®¹ä»¥å‰çš„ç‰ˆæœ¬ private static final int DEFAULT_CONCURRENCY_LEVEL = 16 ; // è´Ÿè½½å› å­ private static final float LOAD_FACTOR = 0.75f; // é“¾è¡¨è½¬çº¢é»‘æ ‘é˜€å€¼,\u003e 8 é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ static final int TREEIFY_THRESHOLD = 8 ; //æ ‘è½¬é“¾è¡¨é˜€å€¼ï¼Œå°äºç­‰äº6ï¼ˆtranferæ—¶ï¼Œlcã€hc=0ä¸¤ä¸ªè®¡æ•°å™¨åˆ†åˆ«++è®°å½•åŸbinã€æ–°binTreeNodeæ•°é‡ï¼Œ\u003c=UNTREEIFY_THRESHOLD åˆ™untreeify(lo)ï¼‰ static final int UNTREEIFY_THRESHOLD = 6 ; static final int MIN_TREEIFY_CAPACITY = 64 ; private static final int MIN_TRANSFER_STRIDE = 16 ; private static int RESIZE_STAMP_BITS = 16 ; // 2^15-1ï¼Œhelp resizeçš„æœ€å¤§çº¿ç¨‹æ•° private static final int MAX_RESIZERS = ( 1 \u003c\u003c ( 32 - RESIZE_STAMP_BITS)) - 1 ; // 32-16=16ï¼ŒsizeCtlä¸­è®°å½•sizeå¤§å°çš„åç§»é‡ private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS; // forwarding nodesçš„hashå€¼ static final int MOVED = - 1 ; // æ ‘æ ¹èŠ‚ç‚¹çš„hashå€¼ static final int TREEBIN = - 2 ; // ReservationNodeçš„hashå€¼ static final int RESERVED = - 3 ; // å¯ç”¨å¤„ç†å™¨æ•°é‡ static final int NCPU = Runtime.getRuntime().availableProcessors(); //å­˜æ”¾nodeçš„æ•°ç»„ transient volatile Node\u003cK,V\u003e[] table; /*æ§åˆ¶æ ‡è¯†ç¬¦ï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹çš„æ“ä½œï¼Œä¸åŒçš„å€¼æœ‰ä¸åŒçš„å«ä¹‰ *å½“ä¸ºè´Ÿæ•°æ—¶ï¼š- 1 ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–ï¼Œ-Nä»£è¡¨æœ‰N- 1 ä¸ªçº¿ç¨‹æ­£åœ¨ è¿›è¡Œæ‰©å®¹ *å½“ä¸º 0 æ—¶ï¼šä»£è¡¨å½“æ—¶çš„tableè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ– *å½“ä¸ºæ­£æ•°æ—¶ï¼šè¡¨ç¤ºåˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å° */ private transient volatile int sizeCtl; ConcurrentHashMap (int initialCapacity) æ„é€ å‡½æ•°æ€»ç»“ä¸‹ï¼š\næ„é€ å‡½æ•°ä¸­å¹¶ä¸ä¼šåˆå§‹åŒ–å“ˆå¸Œè¡¨ï¼›\næ„é€ å‡½æ•°ä¸­ä»…è®¾ç½®å“ˆå¸Œè¡¨å¤§å°çš„å˜é‡ sizeCtlï¼›\ninitialCapacity å¹¶ä¸æ˜¯å“ˆå¸Œè¡¨å¤§å°ï¼›\nå“ˆå¸Œè¡¨å¤§å°ä¸º initialCapacity*1.5+1 åï¼Œå‘ä¸Šå–æœ€å°çš„ 2 çš„ n æ¬¡æ–¹ã€‚å¦‚æœè¶…è¿‡æœ€å¤§å®¹é‡ä¸€åŠï¼Œé‚£ä¹ˆå°±æ˜¯æœ€å¤§å®¹é‡ã€‚\nputæ“ä½œ final V putVal(K key, V value, boolean onlyIfAbsent){ if (key == null || value == null) throw new NullPointerException(); int hash = spread(key.hashCode()); //ä¸¤æ¬¡hashï¼Œå‡å°‘hashå†²çªï¼Œå¯ä»¥å‡åŒ€åˆ†å¸ƒ int binCount = 0; for (Node\u003cK,V\u003e[] tab = table;;) { Node\u003cK,V\u003e f; int n, i, fh; if (tab == null || (n = tab.length) == 0) tab = initTable();//è¿™é‡Œå°±æ˜¯ä¸Šé¢æ„é€ æ–¹æ³•æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨è¿™é‡Œè¿›è¡Œåˆ¤æ–­ï¼Œä¸ºnullå°±è°ƒç”¨initTableè¿›è¡Œåˆå§‹åŒ–ï¼Œå±äºæ‡’æ±‰æ¨¡å¼åˆå§‹åŒ– else if ((f = tabAt(tab, i = (n - 1) \u0026 hash)) == null) { //å¦‚æœiä½ç½®æ²¡æœ‰æ•°æ®ï¼Œå°±ç›´æ¥æ— é”æ’å…¥ if ( casTabAt(tab, i, null,new Node\u003cK,V\u003e(hash, key, value, null)) ) break; // no lock when adding to empty bin } else if ((fh = f.hash) == MOVED) //å¦‚æœåœ¨è¿›è¡Œæ‰©å®¹ï¼Œåˆ™å…ˆè¾…åŠ©æ‰©å®¹æ“ä½œ (å¤šçº¿ç¨‹åŒæ­¥è¿›è¡Œæ‰©å®¹) tab = helpTransfer(tab, f); else { V oldVal = null; synchronized (f) { //å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œé‚£å°±è¦è¿›è¡ŒåŠ é”æ“ä½œï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨hashå†²çªï¼Œé”ä½é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„å¤´ç»“ç‚¹ if (tabAt(tab, i) == f) { if (fh \u003e= 0) {//è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯é“¾è¡¨ç»“æ„ binCount = 1; for (Node\u003cK,V\u003e e = f;; ++binCount) { K ek; //è¿™é‡Œæ¶‰åŠåˆ°ç›¸åŒçš„keyè¿›è¡Œputå°±ä¼šè¦†ç›–åŸå…ˆçš„value if (e.hash == hash \u0026\u0026 ((ek = e.key) == key || (ek != null \u0026\u0026 key.equals(ek)))) { oldVal = e.val; if (!onlyIfAbsent) // hashmap æ”¯æŒä»…ä¸å­˜åœ¨æ—¶æ’å…¥, æ•…æ­¤åˆ¤æ–­ e.val = value; break; } Node\u003cK,V\u003e pred = e; if ((e = e.next) == null) { pred.next = new Node\u003cK,V\u003e(hash, key, value, null); //æ’å…¥é“¾è¡¨å°¾éƒ¨ break; } } } else if (f instanceof TreeBin) { //çº¢é»‘æ ‘ç»“æ„ Node\u003cK,V\u003e p; binCount = 2; //çº¢é»‘æ ‘ç»“æ„æ—‹è½¬æ’å…¥ if ((p = ((TreeBin\u003cK,V\u003e)f).putTreeVal(hash, key, value)) != null) { oldVal = p.val; if (!onlyIfAbsent) p.val = value; } } } } if (binCount != 0) {//å¦‚æœé“¾è¡¨çš„é•¿åº¦å¤§äº8æ—¶å°±ä¼šè¿›è¡Œçº¢é»‘æ ‘çš„è½¬æ¢ if (binCount \u003e= TREEIFY_THRESHOLD) treeifyBin(tab, i); // treeifyBin()æ–¹æ³•é‡Œåˆ¤æ–­éœ€è¦æ•°ç»„å¤§å°è¶…è¿‡64,æ‰ä¼šå˜çº¢é»‘æ ‘, å’ŒhashMapä¸€æ · if (oldVal != null) return oldVal; break; } } } addCount(1L, binCount); //ç»Ÿè®¡sizeï¼Œå¹¶ä¸”æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ return null; } è¿™ä¸ªputçš„è¿‡ç¨‹å¾ˆæ¸…æ™°ï¼Œå¯¹å½“å‰çš„tableè¿›è¡Œæ— æ¡ä»¶è‡ªå¾ªç¯ç›´åˆ°putæˆåŠŸï¼Œå¯ä»¥åˆ†æˆä»¥ä¸‹å…­æ­¥æµç¨‹æ¥æ¦‚è¿°\nå¦‚æœæ²¡æœ‰åˆå§‹åŒ–å°±å…ˆè°ƒç”¨**initTableï¼ˆï¼‰**æ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹ å¦‚æœæ²¡æœ‰hashå†²çªå°±ç›´æ¥CASæ’å…¥ å¦‚æœè¿˜åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œå°±å…ˆè¿›è¡Œæ‰©å®¹ helpTransfer(tab, f) å¦‚æœå­˜åœ¨hashå†²çªï¼Œå°±åŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯é“¾è¡¨å½¢å¼å°±ç›´æ¥éå†åˆ°å°¾ç«¯æ’å…¥ï¼Œä¸€ç§æ˜¯çº¢é»‘æ ‘å°±æŒ‰ç…§çº¢é»‘æ ‘ç»“æ„æ’å…¥ï¼Œ æœ€åä¸€ä¸ªå¦‚æœHashå†²çªæ—¶ä¼šå½¢æˆNodeé“¾è¡¨ï¼Œåœ¨é“¾è¡¨é•¿åº¦è¶…è¿‡8ï¼ŒNodeæ•°ç»„è¶…è¿‡64æ—¶ä¼šå°†é“¾è¡¨ç»“æ„è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„ç»“æ„ï¼Œbreakå†ä¸€æ¬¡è¿›å…¥å¾ªç¯ å¦‚æœæ·»åŠ æˆåŠŸå°±è°ƒç”¨**addCountï¼ˆï¼‰**æ–¹æ³•ç»Ÿè®¡sizeï¼Œå¹¶ä¸”æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ æ–°å¢æ§½ç‚¹å€¼æ—¶çš„çº¿ç¨‹å®‰å…¨\næ­¤æ—¶ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåšäº†å››å¤„ä¼˜åŒ–ï¼š\né€šè¿‡è‡ªæ—‹æ­»å¾ªç¯ä¿è¯ä¸€å®šå¯ä»¥æ–°å¢æˆåŠŸã€‚ åœ¨æ–°å¢ä¹‹å‰ï¼Œé€šè¿‡ for (Node[] tab = table;;)è¿™æ ·çš„æ­»å¾ªç¯æ¥ä¿è¯æ–°å¢ä¸€å®šå¯ä»¥æˆåŠŸï¼Œä¸€æ—¦æ–°å¢æˆåŠŸï¼Œå°±å¯ä»¥é€€å‡ºå½“å‰æ­»å¾ªç¯ï¼Œæ–°å¢å¤±è´¥çš„è¯ï¼Œä¼šé‡å¤æ–°å¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ–°å¢æˆåŠŸä¸ºæ­¢ã€‚\nå½“å‰æ§½ç‚¹ä¸ºç©ºæ—¶ï¼Œé€šè¿‡ CAS æ–°å¢ã€‚ Java è¿™é‡Œçš„å†™æ³•éå¸¸ä¸¥è°¨ï¼Œæ²¡æœ‰åœ¨åˆ¤æ–­æ§½ç‚¹ä¸ºç©ºçš„æƒ…å†µä¸‹ç›´æ¥èµ‹å€¼ï¼Œå› ä¸ºåœ¨åˆ¤æ–­æ§½ç‚¹ä¸ºç©ºå’Œèµ‹å€¼çš„ç¬é—´ï¼Œå¾ˆæœ‰å¯èƒ½æ§½ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹å¤åˆ¶äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨ CAS ç®—æ³•ï¼Œèƒ½å¤Ÿä¿è¯æ§½ç‚¹ä¸ºç©ºçš„æƒ…å†µä¸‹èµ‹å€¼æˆåŠŸï¼Œå¦‚æœæ°å¥½æ§½ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹èµ‹å€¼ï¼Œå½“å‰ CAS æ“ä½œå¤±è´¥ï¼Œä¼šå†æ¬¡æ‰§è¡Œ for è‡ªæ—‹ï¼Œå†èµ°æ§½ç‚¹æœ‰å€¼çš„ put æµç¨‹ï¼Œè¿™é‡Œå°±æ˜¯è‡ªæ—‹ + CAS çš„ç»“åˆã€‚\nå½“å‰æ§½ç‚¹æœ‰å€¼ï¼Œé”ä½å½“å‰æ§½ç‚¹ã€‚ put æ—¶ï¼Œå¦‚æœå½“å‰æ§½ç‚¹æœ‰å€¼ï¼Œå°±æ˜¯ key çš„ hash å†²çªçš„æƒ…å†µï¼Œæ­¤æ—¶æ§½ç‚¹ä¸Šå¯èƒ½æ˜¯é“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼Œæˆ‘ä»¬é€šè¿‡é”ä½æ§½ç‚¹ï¼Œæ¥ä¿è¯åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¯¹æ§½ç‚¹è¿›è¡Œä¿®æ”¹\nV oldVal = null;//é”å®šå½“å‰æ§½ç‚¹ï¼Œå…¶ä½™çº¿ç¨‹ä¸èƒ½æ“ä½œï¼Œä¿è¯äº†å®‰å…¨ synchronized (f) { ... } çº¢é»‘æ ‘æ—‹è½¬æ—¶ï¼Œé”ä½çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¿è¯åŒä¸€æ—¶åˆ»ï¼Œå½“å‰çº¢é»‘æ ‘åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ—‹è½¬ ConcurrentHashMapæ ¸å¿ƒåŸç†ï¼Œå½»åº•ç»™æ•´æ˜ç™½äº†_Java_AIä¹”æ²»_InfoQå†™ä½œç¤¾åŒº transfer() æ‰©å®¹æ“ä½œ transfer æ–¹æ³•çš„ä¸»è¦æ€è·¯æ˜¯ï¼š\né¦–å…ˆéœ€è¦æŠŠè€æ•°ç»„çš„å€¼å…¨éƒ¨æ‹·è´åˆ°æ‰©å®¹ä¹‹åçš„æ–°æ•°ç»„ä¸Šï¼Œå…ˆä»æ•°ç»„çš„é˜Ÿå°¾å¼€å§‹æ‹·è´ï¼›\næ‹·è´æ•°ç»„çš„æ§½ç‚¹æ—¶ï¼Œå…ˆæŠŠåŸæ•°ç»„æ§½ç‚¹é”ä½ï¼Œä¿è¯åŸæ•°ç»„æ§½ç‚¹ä¸èƒ½æ“ä½œï¼ŒæˆåŠŸæ‹·è´åˆ°æ–°æ•°ç»„æ—¶ï¼ŒæŠŠåŸæ•°ç»„æ§½ç‚¹èµ‹å€¼ä¸ºè½¬ç§»èŠ‚ç‚¹ï¼›\nè¿™æ—¶å¦‚æœæœ‰æ–°æ•°æ®æ­£å¥½éœ€è¦ put åˆ°æ­¤æ§½ç‚¹æ—¶ï¼Œå‘ç°æ§½ç‚¹ä¸ºè½¬ç§»èŠ‚ç‚¹ï¼Œå°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œæ‰€ä»¥åœ¨æ‰©å®¹å®Œæˆä¹‹å‰ï¼Œè¯¥æ§½ç‚¹å¯¹åº”çš„æ•°æ®æ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼›\nä»æ•°ç»„çš„å°¾éƒ¨æ‹·è´åˆ°å¤´éƒ¨ï¼Œæ¯æ‹·è´æˆåŠŸä¸€æ¬¡ï¼Œå°±æŠŠåŸæ•°ç»„ä¸­çš„èŠ‚ç‚¹è®¾ç½®æˆè½¬ç§»èŠ‚ç‚¹ï¼›\nç›´åˆ°æ‰€æœ‰æ•°ç»„æ•°æ®éƒ½æ‹·è´åˆ°æ–°æ•°ç»„æ—¶ï¼Œç›´æ¥æŠŠæ–°æ•°ç»„æ•´ä¸ªèµ‹å€¼ç»™æ•°ç»„å®¹å™¨ï¼Œæ‹·è´å®Œæˆã€‚\næ‰©å®¹æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡åœ¨åŸæ•°ç»„ä¸Šè®¾ç½®è½¬ç§»èŠ‚ç‚¹ï¼Œput æ—¶ç¢°åˆ°è½¬ç§»èŠ‚ç‚¹æ—¶ä¼šç­‰å¾…æ‰©å®¹æˆåŠŸä¹‹åæ‰èƒ½ put çš„ç­–ç•¥ï¼Œæ¥ä¿è¯äº†æ•´ä¸ªæ‰©å®¹è¿‡ç¨‹ä¸­è‚¯å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºæ•°ç»„çš„æ§½ç‚¹ä¸€æ—¦è¢«è®¾ç½®æˆè½¬ç§»èŠ‚ç‚¹ï¼Œåœ¨æ²¡æœ‰æ‰©å®¹å®Œæˆä¹‹å‰ï¼Œæ˜¯æ— æ³•è¿›è¡Œæ“ä½œçš„\nä¼šä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ¥åšæ‰©å®¹(æ•°æ®è¿ç§»), é€šè¿‡ ForwardingNode (è½¬ç§»èŠ‚ç‚¹) æ¥è¡¨ç¤ºæ˜¯å¦è¢«è¿ç§»è¿‡ åŠ ä¸Š synchronized æ¥ä¿è¯çº¿ç¨‹å®‰å…¨\nè¿™é‡Œçš„å¤šçº¿ç¨‹ä¸æ˜¯æ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ± å»è¿ç§», è€Œæ˜¯è®© æ“ä½œæ•°æ®çš„çº¿ç¨‹ æš‚åœæ“ä½œæ¥å¸®å¿™å¤„ç†æ•°æ®è¿ç§»(ä¾‹å¦‚putæ—¶å°±ä¼šæœ‰è¿™ä¸ªå¤„ç†) (ç§°ä¸ºè¾…åŠ©æ‰©å®¹æˆ–è€…å¤šçº¿ç¨‹æ‰©å®¹)\ngetæ“ä½œ ConcurrentHashMapçš„getæ“ä½œçš„æµç¨‹å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆæ¸…æ™°ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤æ¥æè¿°\nè®¡ç®—hashå€¼ï¼Œå®šä½åˆ°è¯¥tableç´¢å¼•ä½ç½®ï¼Œå¦‚æœæ˜¯é¦–èŠ‚ç‚¹ç¬¦åˆå°±è¿”å› å¦‚æœé‡åˆ°æ‰©å®¹çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ ‡å¿—æ­£åœ¨æ‰©å®¹èŠ‚ç‚¹ForwardingNodeçš„findæ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥èŠ‚ç‚¹ï¼ŒåŒ¹é…å°±è¿”å› ä»¥ä¸Šéƒ½ä¸ç¬¦åˆçš„è¯ï¼Œå°±å¾€ä¸‹éå†èŠ‚ç‚¹ï¼ŒåŒ¹é…å°±è¿”å›ï¼Œå¦åˆ™æœ€åå°±è¿”å›null ä¸‹å›¾è¡¨ç¤ºæœ‰èŠ‚ç‚¹æˆä¸ºäº†é“¾è¡¨ä¸­çš„å…ƒç´ \nå…¶ä¸­\"xkj11\" ä¸\"xkj9\" hashå†²çª, åˆ™\"11\"æˆä¸º\"9\"çš„åé©±èŠ‚ç‚¹, æ‰€ä»¥ç›´æ¥çœ‹tabæ˜¯æ‰¾ä¸åˆ°\"xkj11\"çš„, æ‰€ä»¥getæ—¶ä¼šæ‰¾åˆ°\"xkj9\"(çš„hashå€¼) ç„¶åæ¯”è¾ƒkeyå€¼æ˜¯å¦ç›¸ç­‰, æ‰èƒ½ç¡®å®šæ˜¯å¦ä¸ºè¯¥å€¼\nConcurrentHashMapåº•å±‚å®ç°åŸç†(JDK1.7 \u0026 1.8) - ç®€ä¹¦ (jianshu.com) 2.3 é¢è¯•é¢˜ ConcurrentHashMap çš„ get æ–¹æ³•æ˜¯å¦è¦åŠ é”ï¼Œä¸ºä»€ä¹ˆï¼Ÿ\nget æ–¹æ³•ä¸éœ€è¦åŠ é”ã€‚å› ä¸º Node çš„å…ƒç´  value å’ŒæŒ‡é’ˆ next æ˜¯ç”¨ volatile ä¿®é¥°çš„ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹Aä¿®æ”¹èŠ‚ç‚¹çš„ value æˆ–è€…æ–°å¢èŠ‚ç‚¹çš„æ—¶å€™æ˜¯å¯¹çº¿ç¨‹Bå¯è§çš„ã€‚è¿™ä¹Ÿæ˜¯å®ƒæ¯”å…¶ä»–å¹¶å‘é›†åˆæ¯”å¦‚ Hashtableã€ç”¨ Collections.synchronizedMap()åŒ…è£…çš„ HashMap æ•ˆç‡é«˜çš„åŸå› ä¹‹ä¸€ã€‚\nConcurrentHashMap æ”¯æŒ key æˆ–è€… value ä¸º null å—ï¼Ÿ\nä¸æ”¯æŒ\nConcurrentHashMap é¢è¯•é¢˜_å­¦ä¹ ä½¿æˆ‘å¯ä¹çš„åšå®¢-CSDNåšå®¢_concurrenthashmapé¢è¯•é¢˜ ","wordCount":"4005","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-30T16:23:43.416699883Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E9%9B%86%E5%90%88.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.com/zh/search.html title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>ğŸ </a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80.html>javaåŸºç¡€</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91.html>å¹¶å‘</a> <span>></span></ul></nav><h1 class=post-title>å¹¶å‘å®¹å™¨é›†åˆ</h1><div class=post-description></div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;æ›´æ–°:&nbsp;2023-08-30&nbsp;Â·&nbsp;8 åˆ†é’Ÿ&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></ul><span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1-%e5%b9%b6%e5%8f%91%e5%ae%b9%e5%99%a8%e7%b1%bb%e4%bb%8b%e7%bb%8d aria-label="1. å¹¶å‘å®¹å™¨ç±»ä»‹ç»">1. å¹¶å‘å®¹å™¨ç±»ä»‹ç»</a></li><li><a href=#2-concurrenthashmap aria-label="2. ConcurrentHashMap">2. ConcurrentHashMap</a><ul><li><a href=#21--jdk17%e5%ae%9e%e7%8e%b0 aria-label="2.1  jdk1.7å®ç°">2.1 jdk1.7å®ç°</a><ul><ul><li><a href=#put%e6%93%8d%e4%bd%9c aria-label=putæ“ä½œ>putæ“ä½œ</a></li></ul></ul></li><li><a href=#22-jdk18-%e5%ae%9e%e7%8e%b0 aria-label="2.2 jdk1.8 å®ç°">2.2 jdk1.8 å®ç°</a><ul><li><a href=#put%e6%93%8d%e4%bd%9c-1 aria-label=putæ“ä½œ>putæ“ä½œ</a></li><li><a href=#transfer-%e6%89%a9%e5%ae%b9%e6%93%8d%e4%bd%9c aria-label="transfer() æ‰©å®¹æ“ä½œ">transfer() æ‰©å®¹æ“ä½œ</a></li><li><a href=#get%e6%93%8d%e4%bd%9c aria-label=getæ“ä½œ>getæ“ä½œ</a></li></ul></li><li><a href=#23-%e9%9d%a2%e8%af%95%e9%a2%98 aria-label="2.3 é¢è¯•é¢˜">2.3 é¢è¯•é¢˜</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[TOC]</p><h1 id=1-å¹¶å‘å®¹å™¨ç±»ä»‹ç»>1. å¹¶å‘å®¹å™¨ç±»ä»‹ç»<a hidden class=anchor aria-hidden=true href=#1-å¹¶å‘å®¹å™¨ç±»ä»‹ç»>#</a></h1><p><img loading=lazy src=http://concurrent.redspider.group/article/03/imgs/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.png alt=img></p><h1 id=2-concurrenthashmap>2. ConcurrentHashMap<a hidden class=anchor aria-hidden=true href=#2-concurrenthashmap>#</a></h1><h2 id=21--jdk17å®ç°>2.1 jdk1.7å®ç°<a hidden class=anchor aria-hidden=true href=#21--jdk17å®ç°>#</a></h2><p>åœ¨JDK1.7ç‰ˆæœ¬ä¸­ï¼ŒConcurrentHashMapçš„æ•°æ®ç»“æ„æ˜¯ç”±ä¸€ä¸ªSegmentæ•°ç»„å’Œå¤šä¸ªHashEntryç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img loading=lazy src=https://upload-images.jianshu.io/upload_images/5220087-8c5b0cc951e61398.png?imageMogr2/auto-orient/strip%7cimageView2/2/w/767/format/webp alt=img></p><p>Segmentæ•°ç»„çš„æ„ä¹‰å°±æ˜¯å°†ä¸€ä¸ªå¤§çš„tableåˆ†å‰²æˆå¤šä¸ªå°çš„tableæ¥è¿›è¡ŒåŠ é”ï¼Œè€Œæ¯ä¸€ä¸ªSegmentå…ƒç´ å­˜å‚¨çš„æ˜¯HashEntryæ•°ç»„+é“¾è¡¨ï¼Œè¿™ä¸ªå’ŒHashMapçš„æ•°æ®å­˜å‚¨ç»“æ„ä¸€æ ·</p><h4 id=putæ“ä½œ>putæ“ä½œ<a hidden class=anchor aria-hidden=true href=#putæ“ä½œ>#</a></h4><p>å¯¹äºConcurrentHashMapçš„æ•°æ®æ’å…¥ï¼Œè¿™é‡Œè¦è¿›è¡Œä¸¤æ¬¡Hashå»å®šä½æ•°æ®çš„å­˜å‚¨ä½ç½®</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>static</span> <span style=color:#ff7b72>class</span>  <span style=color:#f0883e;font-weight:700>Segment</span><span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#ff7b72>extends</span>  ReentrantLock <span style=color:#ff7b72>implements</span>  Serializable <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>ä»ä¸ŠSegmentçš„ç»§æ‰¿ä½“ç³»å¯ä»¥çœ‹å‡ºï¼ŒSegmentå®ç°äº†ReentrantLock,ä¹Ÿå°±å¸¦æœ‰é”çš„åŠŸèƒ½ï¼Œ</p><p>å½“æ‰§è¡Œputæ“ä½œæ—¶ï¼Œä¼šè¿›è¡Œç¬¬ä¸€æ¬¡keyçš„hashæ¥å®šä½Segmentçš„ä½ç½®ï¼Œå¦‚æœè¯¥Segmentè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå³é€šè¿‡CASæ“ä½œè¿›è¡Œèµ‹å€¼ï¼Œç„¶åè¿›è¡Œç¬¬äºŒæ¬¡hashæ“ä½œï¼Œæ‰¾åˆ°ç›¸åº”çš„HashEntryçš„ä½ç½®ï¼Œè¿™é‡Œä¼šåˆ©ç”¨ç»§æ‰¿è¿‡æ¥çš„é”çš„ç‰¹æ€§ï¼Œåœ¨å°†æ•°æ®æ’å…¥æŒ‡å®šçš„HashEntryä½ç½®æ—¶ï¼ˆé“¾è¡¨çš„å°¾ç«¯ï¼‰ï¼Œä¼šé€šè¿‡ç»§æ‰¿ReentrantLockçš„tryLockï¼ˆï¼‰æ–¹æ³•å°è¯•å»è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸå°±ç›´æ¥æ’å…¥ç›¸åº”çš„ä½ç½®ï¼Œå¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å–è¯¥Segmentçš„é”ï¼Œé‚£å½“å‰çº¿ç¨‹ä¼šä»¥è‡ªæ—‹çš„æ–¹å¼å»ç»§ç»­çš„è°ƒç”¨tryLockï¼ˆï¼‰æ–¹æ³•å»è·å–é”ï¼Œè¶…è¿‡æŒ‡å®šæ¬¡æ•°å°±æŒ‚èµ·ï¼Œç­‰å¾…å”¤é†’</p><blockquote><p>ç®€å•çš„è¯´, ä¼šé€šè¿‡ä¸¤æ¬¡hashåˆ†åˆ«æ‰¾åˆ°å¯¹åº”çš„Segmentå’ŒhashEntryçš„ä½ç½®, ç„¶åå†æ’è¿›å», æ¯ä¸ªSegmentéƒ½æ˜¯ReentrantLocké”, æ‰€ä»¥åœ¨Segmentä¸ŠåŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p></blockquote><h2 id=22-jdk18-å®ç°>2.2 jdk1.8 å®ç°<a hidden class=anchor aria-hidden=true href=#22-jdk18-å®ç°>#</a></h2><p>JDK1.8çš„å®ç°å·²ç»æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨Synchronizedå’ŒCASæ¥æ“ä½œï¼Œ<strong>æ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„HashMap</strong>ï¼Œè™½ç„¶åœ¨JDK1.8ä¸­è¿˜èƒ½çœ‹åˆ°Segmentçš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬</p><p><img loading=lazy src=https://upload-images.jianshu.io/upload_images/5220087-63281d7b737f1109.png?imageMogr2/auto-orient/strip%7cimageView2/2/w/453/format/webp alt=img></p><p>è¿™äº›æ˜¯æ„æˆConcurrentHashMapå®ç°ç»“æ„çš„åŸºç¡€ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹åŸºæœ¬å±æ€§ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// nodeæ•°ç»„æœ€å¤§å®¹é‡ï¼š2^30=1073741824  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  MAXIMUM_CAPACITY <span style=color:#ff7b72;font-weight:700>=</span>  1  <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span>  30    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// é»˜è®¤åˆå§‹å€¼ï¼Œå¿…é¡»æ˜¯2çš„å¹‚æ•°  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  DEFAULT_CAPACITY <span style=color:#ff7b72;font-weight:700>=</span>  16    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//æ•°ç»„å¯èƒ½æœ€å¤§å€¼ï¼Œéœ€è¦ä¸toArrayï¼ˆï¼‰ç›¸å…³æ–¹æ³•å…³è”  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  MAX_ARRAY_SIZE <span style=color:#ff7b72;font-weight:700>=</span> Integer<span style=color:#ff7b72;font-weight:700>.</span>MAX_VALUE <span style=color:#ff7b72;font-weight:700>-</span>  8    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//å¹¶å‘çº§åˆ«ï¼Œé—ç•™ä¸‹æ¥çš„ï¼Œä¸ºå…¼å®¹ä»¥å‰çš„ç‰ˆæœ¬  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  DEFAULT_CONCURRENCY_LEVEL <span style=color:#ff7b72;font-weight:700>=</span>  16    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è´Ÿè½½å› å­  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>float</span>  LOAD_FACTOR <span style=color:#ff7b72;font-weight:700>=</span>  0<span style=color:#ff7b72;font-weight:700>.</span>75f<span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// é“¾è¡¨è½¬çº¢é»‘æ ‘é˜€å€¼,&gt; 8 é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  TREEIFY_THRESHOLD <span style=color:#ff7b72;font-weight:700>=</span>  8    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//æ ‘è½¬é“¾è¡¨é˜€å€¼ï¼Œå°äºç­‰äº6ï¼ˆtranferæ—¶ï¼Œlcã€hc=0ä¸¤ä¸ªè®¡æ•°å™¨åˆ†åˆ«++è®°å½•åŸbinã€æ–°binTreeNodeæ•°é‡ï¼Œ&lt;=UNTREEIFY_THRESHOLD åˆ™untreeify(lo)ï¼‰  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  UNTREEIFY_THRESHOLD <span style=color:#ff7b72;font-weight:700>=</span>  6    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  MIN_TREEIFY_CAPACITY <span style=color:#ff7b72;font-weight:700>=</span>  64    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  MIN_TRANSFER_STRIDE <span style=color:#ff7b72;font-weight:700>=</span>  16    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>int</span>  RESIZE_STAMP_BITS <span style=color:#ff7b72;font-weight:700>=</span>  16    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// 2^15-1ï¼Œhelp resizeçš„æœ€å¤§çº¿ç¨‹æ•°  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  MAX_RESIZERS <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>    1  <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#ff7b72;font-weight:700>(</span>    32  <span style=color:#ff7b72;font-weight:700>-</span> RESIZE_STAMP_BITS<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>-</span>  1    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// 32-16=16ï¼ŒsizeCtlä¸­è®°å½•sizeå¤§å°çš„åç§»é‡  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  RESIZE_STAMP_SHIFT <span style=color:#ff7b72;font-weight:700>=</span>  32  <span style=color:#ff7b72;font-weight:700>-</span> RESIZE_STAMP_BITS<span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// forwarding nodesçš„hashå€¼  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  MOVED     <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>-</span>    1    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// æ ‘æ ¹èŠ‚ç‚¹çš„hashå€¼  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  TREEBIN   <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>-</span>    2    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ReservationNodeçš„hashå€¼  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  RESERVED  <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>-</span>    3    <span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// å¯ç”¨å¤„ç†å™¨æ•°é‡  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>static</span>  <span style=color:#ff7b72>final</span>  <span style=color:#ff7b72>int</span>  NCPU <span style=color:#ff7b72;font-weight:700>=</span> Runtime<span style=color:#ff7b72;font-weight:700>.</span>getRuntime<span style=color:#ff7b72;font-weight:700>().</span>availableProcessors<span style=color:#ff7b72;font-weight:700>();</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>//å­˜æ”¾nodeçš„æ•°ç»„  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>transient</span>  <span style=color:#ff7b72>volatile</span>  Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;[]</span> table<span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>/*æ§åˆ¶æ ‡è¯†ç¬¦ï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹çš„æ“ä½œï¼Œä¸åŒçš„å€¼æœ‰ä¸åŒçš„å«ä¹‰  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  *å½“ä¸ºè´Ÿæ•°æ—¶ï¼š-    1    ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–ï¼Œ-Nä»£è¡¨æœ‰N-    1    ä¸ªçº¿ç¨‹æ­£åœ¨ è¿›è¡Œæ‰©å®¹  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  *å½“ä¸º    0    æ—¶ï¼šä»£è¡¨å½“æ—¶çš„tableè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>  *å½“ä¸ºæ­£æ•°æ—¶ï¼šè¡¨ç¤ºåˆå§‹åŒ–æˆ–è€…ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span>  <span style=color:#ff7b72>transient</span>  <span style=color:#ff7b72>volatile</span>  <span style=color:#ff7b72>int</span>  sizeCtl<span style=color:#ff7b72;font-weight:700>;</span>  
</span></span></code></pre></div><p><strong>ConcurrentHashMap (int initialCapacity) æ„é€ å‡½æ•°æ€»ç»“ä¸‹ï¼š</strong></p><ol><li><p>æ„é€ å‡½æ•°ä¸­å¹¶ä¸ä¼šåˆå§‹åŒ–å“ˆå¸Œè¡¨ï¼›</p></li><li><p>æ„é€ å‡½æ•°ä¸­ä»…è®¾ç½®å“ˆå¸Œè¡¨å¤§å°çš„å˜é‡ sizeCtlï¼›</p></li><li><p>initialCapacity å¹¶ä¸æ˜¯å“ˆå¸Œè¡¨å¤§å°ï¼›</p></li><li><p>å“ˆå¸Œè¡¨å¤§å°ä¸º <strong>initialCapacity*1.5+1 åï¼Œå‘ä¸Šå–æœ€å°çš„ 2 çš„ n æ¬¡æ–¹</strong>ã€‚å¦‚æœè¶…è¿‡æœ€å¤§å®¹é‡ä¸€åŠï¼Œé‚£ä¹ˆå°±æ˜¯æœ€å¤§å®¹é‡ã€‚</p></li></ol><h3 id=putæ“ä½œ-1>putæ“ä½œ<a hidden class=anchor aria-hidden=true href=#putæ“ä½œ-1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>final</span> V <span style=color:#d2a8ff;font-weight:700>putVal</span><span style=color:#ff7b72;font-weight:700>(</span>K key<span style=color:#ff7b72;font-weight:700>,</span> V value<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>boolean</span> onlyIfAbsent<span style=color:#ff7b72;font-weight:700>){</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>key <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>||</span> value <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> NullPointerException<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>int</span> hash <span style=color:#ff7b72;font-weight:700>=</span> spread<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>.</span>hashCode<span style=color:#ff7b72;font-weight:700>());</span>  <span style=color:#8b949e;font-style:italic>//ä¸¤æ¬¡hashï¼Œå‡å°‘hashå†²çªï¼Œå¯ä»¥å‡åŒ€åˆ†å¸ƒ  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>int</span> binCount <span style=color:#ff7b72;font-weight:700>=</span> 0<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;[]</span> tab <span style=color:#ff7b72;font-weight:700>=</span> table<span style=color:#ff7b72;font-weight:700>;;)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;</span> f<span style=color:#ff7b72;font-weight:700>;</span> <span style=color:#ff7b72>int</span> n<span style=color:#ff7b72;font-weight:700>,</span> i<span style=color:#ff7b72;font-weight:700>,</span> fh<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>tab <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#ff7b72;font-weight:700>(</span>n <span style=color:#ff7b72;font-weight:700>=</span> tab<span style=color:#ff7b72;font-weight:700>.</span>length<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>==</span> 0<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                tab <span style=color:#ff7b72;font-weight:700>=</span> initTable<span style=color:#ff7b72;font-weight:700>();</span><span style=color:#8b949e;font-style:italic>//è¿™é‡Œå°±æ˜¯ä¸Šé¢æ„é€ æ–¹æ³•æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨è¿™é‡Œè¿›è¡Œåˆ¤æ–­ï¼Œä¸ºnullå°±è°ƒç”¨initTableè¿›è¡Œåˆå§‹åŒ–ï¼Œå±äºæ‡’æ±‰æ¨¡å¼åˆå§‹åŒ–  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>f <span style=color:#ff7b72;font-weight:700>=</span> tabAt<span style=color:#ff7b72;font-weight:700>(</span>tab<span style=color:#ff7b72;font-weight:700>,</span> i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>n <span style=color:#ff7b72;font-weight:700>-</span> 1<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>&amp;</span> hash<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span> <span style=color:#8b949e;font-style:italic>//å¦‚æœiä½ç½®æ²¡æœ‰æ•°æ®ï¼Œå°±ç›´æ¥æ— é”æ’å…¥  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span> casTabAt<span style=color:#ff7b72;font-weight:700>(</span>tab<span style=color:#ff7b72;font-weight:700>,</span> i<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>,</span><span style=color:#ff7b72>new</span> Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;(</span>hash<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>break</span><span style=color:#ff7b72;font-weight:700>;</span>                   <span style=color:#8b949e;font-style:italic>// no lock when adding to empty bin
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>fh <span style=color:#ff7b72;font-weight:700>=</span> f<span style=color:#ff7b72;font-weight:700>.</span>hash<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>==</span> MOVED<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#8b949e;font-style:italic>//å¦‚æœåœ¨è¿›è¡Œæ‰©å®¹ï¼Œåˆ™å…ˆè¾…åŠ©æ‰©å®¹æ“ä½œ (å¤šçº¿ç¨‹åŒæ­¥è¿›è¡Œæ‰©å®¹)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                tab <span style=color:#ff7b72;font-weight:700>=</span> helpTransfer<span style=color:#ff7b72;font-weight:700>(</span>tab<span style=color:#ff7b72;font-weight:700>,</span> f<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                V oldVal <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>synchronized</span> <span style=color:#ff7b72;font-weight:700>(</span>f<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span> <span style=color:#8b949e;font-style:italic>//å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œé‚£å°±è¦è¿›è¡ŒåŠ é”æ“ä½œï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨hashå†²çªï¼Œé”ä½é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„å¤´ç»“ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>tabAt<span style=color:#ff7b72;font-weight:700>(</span>tab<span style=color:#ff7b72;font-weight:700>,</span> i<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>==</span> f<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>fh <span style=color:#ff7b72;font-weight:700>&gt;=</span> 0<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span><span style=color:#8b949e;font-style:italic>//è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯é“¾è¡¨ç»“æ„  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                            binCount <span style=color:#ff7b72;font-weight:700>=</span> 1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;</span> e <span style=color:#ff7b72;font-weight:700>=</span> f<span style=color:#ff7b72;font-weight:700>;;</span> <span style=color:#ff7b72;font-weight:700>++</span>binCount<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                                K ek<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#8b949e;font-style:italic>//è¿™é‡Œæ¶‰åŠåˆ°ç›¸åŒçš„keyè¿›è¡Œputå°±ä¼šè¦†ç›–åŸå…ˆçš„value  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>e<span style=color:#ff7b72;font-weight:700>.</span>hash <span style=color:#ff7b72;font-weight:700>==</span> hash <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#ff7b72;font-weight:700>((</span>ek <span style=color:#ff7b72;font-weight:700>=</span> e<span style=color:#ff7b72;font-weight:700>.</span>key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>==</span> key <span style=color:#ff7b72;font-weight:700>||</span>
</span></span><span style=display:flex><span>                                     <span style=color:#ff7b72;font-weight:700>(</span>ek <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> key<span style=color:#ff7b72;font-weight:700>.</span>equals<span style=color:#ff7b72;font-weight:700>(</span>ek<span style=color:#ff7b72;font-weight:700>))))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                                    oldVal <span style=color:#ff7b72;font-weight:700>=</span> e<span style=color:#ff7b72;font-weight:700>.</span>val<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>onlyIfAbsent<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#8b949e;font-style:italic>// hashmap æ”¯æŒä»…ä¸å­˜åœ¨æ—¶æ’å…¥, æ•…æ­¤åˆ¤æ–­
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                                        e<span style=color:#ff7b72;font-weight:700>.</span>val <span style=color:#ff7b72;font-weight:700>=</span> value<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#ff7b72>break</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                                Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;</span> pred <span style=color:#ff7b72;font-weight:700>=</span> e<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>e <span style=color:#ff7b72;font-weight:700>=</span> e<span style=color:#ff7b72;font-weight:700>.</span>next<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                                    pred<span style=color:#ff7b72;font-weight:700>.</span>next <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;(</span>hash<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>);</span> <span style=color:#8b949e;font-style:italic>//æ’å…¥é“¾è¡¨å°¾éƒ¨  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                                    <span style=color:#ff7b72>break</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>f <span style=color:#ff7b72>instanceof</span> TreeBin<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>  <span style=color:#8b949e;font-style:italic>//çº¢é»‘æ ‘ç»“æ„  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                            Node<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;</span> p<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                            binCount <span style=color:#ff7b72;font-weight:700>=</span> 2<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#8b949e;font-style:italic>//çº¢é»‘æ ‘ç»“æ„æ—‹è½¬æ’å…¥  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>((</span>p <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>TreeBin<span style=color:#ff7b72;font-weight:700>&lt;</span>K<span style=color:#ff7b72;font-weight:700>,</span>V<span style=color:#ff7b72;font-weight:700>&gt;)</span>f<span style=color:#ff7b72;font-weight:700>).</span>putTreeVal<span style=color:#ff7b72;font-weight:700>(</span>hash<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>,</span> value<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                                oldVal <span style=color:#ff7b72;font-weight:700>=</span> p<span style=color:#ff7b72;font-weight:700>.</span>val<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>onlyIfAbsent<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                                    p<span style=color:#ff7b72;font-weight:700>.</span>val <span style=color:#ff7b72;font-weight:700>=</span> value<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>binCount <span style=color:#ff7b72;font-weight:700>!=</span> 0<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span><span style=color:#8b949e;font-style:italic>//å¦‚æœé“¾è¡¨çš„é•¿åº¦å¤§äº8æ—¶å°±ä¼šè¿›è¡Œçº¢é»‘æ ‘çš„è½¬æ¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>binCount <span style=color:#ff7b72;font-weight:700>&gt;=</span> TREEIFY_THRESHOLD<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        treeifyBin<span style=color:#ff7b72;font-weight:700>(</span>tab<span style=color:#ff7b72;font-weight:700>,</span> i<span style=color:#ff7b72;font-weight:700>);</span> <span style=color:#8b949e;font-style:italic>// treeifyBin()æ–¹æ³•é‡Œåˆ¤æ–­éœ€è¦æ•°ç»„å¤§å°è¶…è¿‡64,æ‰ä¼šå˜çº¢é»‘æ ‘, å’ŒhashMapä¸€æ ·
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>oldVal <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>return</span> oldVal<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>break</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        addCount<span style=color:#ff7b72;font-weight:700>(</span>1L<span style=color:#ff7b72;font-weight:700>,</span> binCount<span style=color:#ff7b72;font-weight:700>);</span>  <span style=color:#8b949e;font-style:italic>//ç»Ÿè®¡sizeï¼Œå¹¶ä¸”æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹  
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>è¿™ä¸ªputçš„è¿‡ç¨‹å¾ˆæ¸…æ™°ï¼Œå¯¹å½“å‰çš„tableè¿›è¡Œæ— æ¡ä»¶è‡ªå¾ªç¯ç›´åˆ°putæˆåŠŸï¼Œå¯ä»¥åˆ†æˆä»¥ä¸‹å…­æ­¥æµç¨‹æ¥æ¦‚è¿°</p><blockquote><ol><li>å¦‚æœæ²¡æœ‰åˆå§‹åŒ–å°±å…ˆè°ƒç”¨**initTableï¼ˆï¼‰**æ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–è¿‡ç¨‹</li><li>å¦‚æœæ²¡æœ‰hashå†²çªå°±ç›´æ¥CASæ’å…¥</li><li>å¦‚æœè¿˜åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œå°±å…ˆè¿›è¡Œæ‰©å®¹ <strong>helpTransfer(tab, f)</strong></li><li>å¦‚æœå­˜åœ¨hashå†²çªï¼Œå°±åŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯é“¾è¡¨å½¢å¼å°±ç›´æ¥éå†åˆ°å°¾ç«¯æ’å…¥ï¼Œä¸€ç§æ˜¯çº¢é»‘æ ‘å°±æŒ‰ç…§çº¢é»‘æ ‘ç»“æ„æ’å…¥ï¼Œ</li><li>æœ€åä¸€ä¸ªå¦‚æœHashå†²çªæ—¶ä¼šå½¢æˆNodeé“¾è¡¨ï¼Œåœ¨é“¾è¡¨é•¿åº¦è¶…è¿‡8ï¼ŒNodeæ•°ç»„è¶…è¿‡64æ—¶ä¼šå°†é“¾è¡¨ç»“æ„è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„ç»“æ„ï¼Œbreakå†ä¸€æ¬¡è¿›å…¥å¾ªç¯</li><li>å¦‚æœæ·»åŠ æˆåŠŸå°±è°ƒç”¨**addCountï¼ˆï¼‰**æ–¹æ³•ç»Ÿè®¡sizeï¼Œå¹¶ä¸”æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</li></ol></blockquote><p><strong>æ–°å¢æ§½ç‚¹å€¼æ—¶çš„çº¿ç¨‹å®‰å…¨</strong></p><p>æ­¤æ—¶ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåšäº†å››å¤„ä¼˜åŒ–ï¼š</p><ol><li>é€šè¿‡è‡ªæ—‹æ­»å¾ªç¯ä¿è¯ä¸€å®šå¯ä»¥æ–°å¢æˆåŠŸã€‚</li></ol><p>åœ¨æ–°å¢ä¹‹å‰ï¼Œé€šè¿‡ for (Node&lt;K,V>[] tab = table;;)è¿™æ ·çš„æ­»å¾ªç¯æ¥ä¿è¯æ–°å¢ä¸€å®šå¯ä»¥æˆåŠŸï¼Œä¸€æ—¦æ–°å¢æˆåŠŸï¼Œå°±å¯ä»¥é€€å‡ºå½“å‰æ­»å¾ªç¯ï¼Œæ–°å¢å¤±è´¥çš„è¯ï¼Œä¼šé‡å¤æ–°å¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ–°å¢æˆåŠŸä¸ºæ­¢ã€‚</p><ol start=2><li>å½“å‰æ§½ç‚¹ä¸ºç©ºæ—¶ï¼Œé€šè¿‡ CAS æ–°å¢ã€‚</li></ol><p>Java è¿™é‡Œçš„å†™æ³•éå¸¸ä¸¥è°¨ï¼Œæ²¡æœ‰åœ¨åˆ¤æ–­æ§½ç‚¹ä¸ºç©ºçš„æƒ…å†µä¸‹ç›´æ¥èµ‹å€¼ï¼Œå› ä¸ºåœ¨åˆ¤æ–­æ§½ç‚¹ä¸ºç©ºå’Œèµ‹å€¼çš„ç¬é—´ï¼Œå¾ˆæœ‰å¯èƒ½æ§½ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹å¤åˆ¶äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨ CAS ç®—æ³•ï¼Œèƒ½å¤Ÿä¿è¯æ§½ç‚¹ä¸ºç©ºçš„æƒ…å†µä¸‹èµ‹å€¼æˆåŠŸï¼Œå¦‚æœæ°å¥½æ§½ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹èµ‹å€¼ï¼Œå½“å‰ CAS æ“ä½œå¤±è´¥ï¼Œä¼šå†æ¬¡æ‰§è¡Œ for è‡ªæ—‹ï¼Œå†èµ°æ§½ç‚¹æœ‰å€¼çš„ put æµç¨‹ï¼Œè¿™é‡Œå°±æ˜¯è‡ªæ—‹ + CAS çš„ç»“åˆã€‚</p><ol start=3><li>å½“å‰æ§½ç‚¹æœ‰å€¼ï¼Œé”ä½å½“å‰æ§½ç‚¹ã€‚</li></ol><p>put æ—¶ï¼Œå¦‚æœå½“å‰æ§½ç‚¹æœ‰å€¼ï¼Œå°±æ˜¯ key çš„ hash å†²çªçš„æƒ…å†µï¼Œæ­¤æ—¶æ§½ç‚¹ä¸Šå¯èƒ½æ˜¯é“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼Œæˆ‘ä»¬é€šè¿‡é”ä½æ§½ç‚¹ï¼Œæ¥ä¿è¯åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¯¹æ§½ç‚¹è¿›è¡Œä¿®æ”¹</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>V oldVal <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span><span style=color:#8b949e;font-style:italic>//é”å®šå½“å‰æ§½ç‚¹ï¼Œå…¶ä½™çº¿ç¨‹ä¸èƒ½æ“ä½œï¼Œä¿è¯äº†å®‰å…¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>synchronized</span> <span style=color:#ff7b72;font-weight:700>(</span>f<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span> <span style=color:#ff7b72;font-weight:700>...</span> <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><ol start=4><li>çº¢é»‘æ ‘æ—‹è½¬æ—¶ï¼Œé”ä½çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¿è¯åŒä¸€æ—¶åˆ»ï¼Œå½“å‰çº¢é»‘æ ‘åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ—‹è½¬</li></ol><p><a href=https://xie.infoq.cn/article/901e4fa89353a6dfb63490c3d target=_blank rel=noopener>ConcurrentHashMapæ ¸å¿ƒåŸç†ï¼Œå½»åº•ç»™æ•´æ˜ç™½äº†_Java_AIä¹”æ²»_InfoQå†™ä½œç¤¾åŒº</a></p><h3 id=transfer-æ‰©å®¹æ“ä½œ>transfer() æ‰©å®¹æ“ä½œ<a hidden class=anchor aria-hidden=true href=#transfer-æ‰©å®¹æ“ä½œ>#</a></h3><p>transfer æ–¹æ³•çš„ä¸»è¦æ€è·¯æ˜¯ï¼š</p><ol><li><p>é¦–å…ˆéœ€è¦æŠŠè€æ•°ç»„çš„å€¼å…¨éƒ¨æ‹·è´åˆ°æ‰©å®¹ä¹‹åçš„æ–°æ•°ç»„ä¸Šï¼Œå…ˆä»æ•°ç»„çš„é˜Ÿå°¾å¼€å§‹æ‹·è´ï¼›</p></li><li><p>æ‹·è´æ•°ç»„çš„æ§½ç‚¹æ—¶ï¼Œå…ˆæŠŠåŸæ•°ç»„æ§½ç‚¹é”ä½ï¼Œä¿è¯åŸæ•°ç»„æ§½ç‚¹ä¸èƒ½æ“ä½œï¼ŒæˆåŠŸæ‹·è´åˆ°æ–°æ•°ç»„æ—¶ï¼ŒæŠŠåŸæ•°ç»„æ§½ç‚¹èµ‹å€¼ä¸ºè½¬ç§»èŠ‚ç‚¹ï¼›</p></li><li><p>è¿™æ—¶å¦‚æœæœ‰æ–°æ•°æ®æ­£å¥½éœ€è¦ put åˆ°æ­¤æ§½ç‚¹æ—¶ï¼Œå‘ç°æ§½ç‚¹ä¸ºè½¬ç§»èŠ‚ç‚¹ï¼Œå°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œæ‰€ä»¥åœ¨æ‰©å®¹å®Œæˆä¹‹å‰ï¼Œè¯¥æ§½ç‚¹å¯¹åº”çš„æ•°æ®æ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼›</p></li><li><p>ä»æ•°ç»„çš„å°¾éƒ¨æ‹·è´åˆ°å¤´éƒ¨ï¼Œæ¯æ‹·è´æˆåŠŸä¸€æ¬¡ï¼Œå°±æŠŠåŸæ•°ç»„ä¸­çš„èŠ‚ç‚¹è®¾ç½®æˆè½¬ç§»èŠ‚ç‚¹ï¼›</p></li><li><p>ç›´åˆ°æ‰€æœ‰æ•°ç»„æ•°æ®éƒ½æ‹·è´åˆ°æ–°æ•°ç»„æ—¶ï¼Œç›´æ¥æŠŠæ–°æ•°ç»„æ•´ä¸ªèµ‹å€¼ç»™æ•°ç»„å®¹å™¨ï¼Œæ‹·è´å®Œæˆã€‚</p></li></ol><p>æ‰©å®¹æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡åœ¨åŸæ•°ç»„ä¸Šè®¾ç½®è½¬ç§»èŠ‚ç‚¹ï¼Œput æ—¶ç¢°åˆ°è½¬ç§»èŠ‚ç‚¹æ—¶ä¼šç­‰å¾…æ‰©å®¹æˆåŠŸä¹‹åæ‰èƒ½ put çš„ç­–ç•¥ï¼Œæ¥ä¿è¯äº†æ•´ä¸ªæ‰©å®¹è¿‡ç¨‹ä¸­è‚¯å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºæ•°ç»„çš„æ§½ç‚¹ä¸€æ—¦è¢«è®¾ç½®æˆè½¬ç§»èŠ‚ç‚¹ï¼Œåœ¨æ²¡æœ‰æ‰©å®¹å®Œæˆä¹‹å‰ï¼Œæ˜¯æ— æ³•è¿›è¡Œæ“ä½œçš„</p><blockquote><p>ä¼šä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ¥åšæ‰©å®¹(æ•°æ®è¿ç§»), é€šè¿‡ ForwardingNode (è½¬ç§»èŠ‚ç‚¹) æ¥è¡¨ç¤ºæ˜¯å¦è¢«è¿ç§»è¿‡ åŠ ä¸Š synchronized æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p><p>è¿™é‡Œçš„å¤šçº¿ç¨‹ä¸æ˜¯æ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ± å»è¿ç§», è€Œæ˜¯è®© <strong>æ“ä½œæ•°æ®çš„çº¿ç¨‹ æš‚åœæ“ä½œæ¥å¸®å¿™å¤„ç†æ•°æ®è¿ç§»</strong>(ä¾‹å¦‚putæ—¶å°±ä¼šæœ‰è¿™ä¸ªå¤„ç†) (ç§°ä¸ºè¾…åŠ©æ‰©å®¹æˆ–è€…å¤šçº¿ç¨‹æ‰©å®¹)</p></blockquote><h3 id=getæ“ä½œ>getæ“ä½œ<a hidden class=anchor aria-hidden=true href=#getæ“ä½œ>#</a></h3><p>ConcurrentHashMapçš„getæ“ä½œçš„æµç¨‹å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆæ¸…æ™°ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤æ¥æè¿°</p><ol><li>è®¡ç®—hashå€¼ï¼Œå®šä½åˆ°è¯¥tableç´¢å¼•ä½ç½®ï¼Œå¦‚æœæ˜¯é¦–èŠ‚ç‚¹ç¬¦åˆå°±è¿”å›</li><li>å¦‚æœé‡åˆ°æ‰©å®¹çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ ‡å¿—æ­£åœ¨æ‰©å®¹èŠ‚ç‚¹ForwardingNodeçš„findæ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥èŠ‚ç‚¹ï¼ŒåŒ¹é…å°±è¿”å›</li><li>ä»¥ä¸Šéƒ½ä¸ç¬¦åˆçš„è¯ï¼Œå°±å¾€ä¸‹éå†èŠ‚ç‚¹ï¼ŒåŒ¹é…å°±è¿”å›ï¼Œå¦åˆ™æœ€åå°±è¿”å›null</li></ol><p>ä¸‹å›¾è¡¨ç¤ºæœ‰èŠ‚ç‚¹æˆä¸ºäº†é“¾è¡¨ä¸­çš„å…ƒç´ </p><p><img loading=lazy src=https://gitee.com/xiaokunji/my-images/raw/master/myMD/hashMap%e6%88%90%e9%93%be%e8%a1%a8.png alt=image-20220508220132620></p><blockquote><p>å…¶ä¸­"xkj11" ä¸"xkj9" hashå†²çª, åˆ™"11"æˆä¸º"9"çš„åé©±èŠ‚ç‚¹, æ‰€ä»¥ç›´æ¥çœ‹tabæ˜¯æ‰¾ä¸åˆ°"xkj11"çš„, æ‰€ä»¥getæ—¶ä¼šæ‰¾åˆ°"xkj9"(çš„hashå€¼) ç„¶åæ¯”è¾ƒkeyå€¼æ˜¯å¦ç›¸ç­‰, æ‰èƒ½ç¡®å®šæ˜¯å¦ä¸ºè¯¥å€¼</p></blockquote><p><a href=https://www.jianshu.com/p/865c813f2726 target=_blank rel=noopener>ConcurrentHashMapåº•å±‚å®ç°åŸç†(JDK1.7 & 1.8) - ç®€ä¹¦ (jianshu.com)</a></p><h2 id=23-é¢è¯•é¢˜>2.3 é¢è¯•é¢˜<a hidden class=anchor aria-hidden=true href=#23-é¢è¯•é¢˜>#</a></h2><p><strong>ConcurrentHashMap çš„ get æ–¹æ³•æ˜¯å¦è¦åŠ é”ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</strong></p><p>get æ–¹æ³•ä¸éœ€è¦åŠ é”ã€‚å› ä¸º Node çš„å…ƒç´  value å’ŒæŒ‡é’ˆ next æ˜¯ç”¨ <strong>volatile ä¿®é¥°</strong>çš„ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹Aä¿®æ”¹èŠ‚ç‚¹çš„ value æˆ–è€…æ–°å¢èŠ‚ç‚¹çš„æ—¶å€™æ˜¯å¯¹çº¿ç¨‹Bå¯è§çš„ã€‚è¿™ä¹Ÿæ˜¯å®ƒæ¯”å…¶ä»–å¹¶å‘é›†åˆæ¯”å¦‚ Hashtableã€ç”¨ Collections.synchronizedMap()åŒ…è£…çš„ HashMap æ•ˆç‡é«˜çš„åŸå› ä¹‹ä¸€ã€‚</p><p><strong>ConcurrentHashMap æ”¯æŒ key æˆ–è€… value ä¸º null å—ï¼Ÿ</strong></p><p>ä¸æ”¯æŒ</p><p><a href=https://blog.csdn.net/qq_40826814/article/details/115328565 target=_blank rel=noopener>ConcurrentHashMap é¢è¯•é¢˜_å­¦ä¹ ä½¿æˆ‘å¯ä¹çš„åšå®¢-CSDNåšå®¢_concurrenthashmapé¢è¯•é¢˜</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/%E5%B9%B6%E5%8F%91.html>å¹¶å‘</a></li><li><a href=https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis/%E6%A0%87%E7%AD%BE%E7%9A%84%E4%BD%BF%E7%94%A8.html><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>æ ‡ç­¾çš„ä½¿ç”¨</span></a>
<a class=next href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E7%AE%97%E6%B3%95/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8.html><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>å¸ƒéš†è¿‡æ»¤å™¨</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>