<!DOCTYPE html>
<html dir="auto" lang="zh"><head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="x-ua-compatible"/><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"/><meta content="index, follow" name="robots"/><title>缓存 | 米二</title>
<meta content=" 前言, 一级缓存, 一级缓存失效的四种情况, 禁用一级缓存, 二级缓存, 禁用二级缓存" name="keywords"/><meta content="mybatis的一级缓存和二级环境" name="description"/><meta content="xkj" name="author"/><link href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis/%E7%BC%93%E5%AD%98.html" rel="canonical"/><link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.dc6bd2c841ee388e899e13872ae986c0e847e8b957d6714ad6ddc628ef2d17ff.css" integrity="sha256-3GvSyEHuOI6JnhOHKumGwOhH6LlX1nFK1t3GKO8tF/8=" rel="preload stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js"></script><link href="https://xiaokunji.com/img/Q.svg" rel="icon"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="16x16" type="image/png"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="32x32" type="image/png"/><link href="https://xiaokunji.com/Q.svg" rel="apple-touch-icon"/><link href="https://xiaokunji.com/Q.svg" rel="mask-icon"/><meta content="#2e2e33" name="theme-color"/><meta content="#2e2e33" name="msapplication-TileColor"/><link href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis/%E7%BC%93%E5%AD%98.html" hreflang="zh" rel="alternate"/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta content="缓存" property="og:title"/><meta content="mybatis的一级缓存和二级环境" property="og:description"/><meta content="article" property="og:type"/><meta content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis/%E7%BC%93%E5%AD%98.html" property="og:url"/><meta content="java及其框架" property="article:section"/><meta content="2023-08-22T00:00:00+00:00" property="article:published_time"/><meta content="2023-09-04T00:18:25+08:00" property="article:modified_time"/><meta content="summary" name="twitter:card"/><meta content="缓存" name="twitter:title"/><meta content="mybatis的一级缓存和二级环境" name="twitter:description"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"缓存","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis/%E7%BC%93%E5%AD%98.html"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"缓存","name":"缓存","description":"mybatis的一级缓存和二级环境","keywords":[" 前言"," 一级缓存"," 一级缓存失效的四种情况"," 禁用一级缓存"," 二级缓存"," 禁用二级缓存"],"articleBody":"[TOC]\n前言 和大多数持久化框架一样，MyBatis 提供了一级缓存和二级缓存的支持。默认情况下，MyBatis 只开启一级缓存。\nMyBatis提供了一级缓存和二级缓存\n一级缓存：也称为本地缓存，用于保存用户在一次会话过程中查询的结果，用户一次会话中只能使用一个sqlSession，一级缓存是自动开启的，不允许关闭。 二级缓存：也称为全局缓存，是mapper级别的缓存，是针对一个表的查结果的存储，可以共享给所有针对这张表的查询的用户。也就是说对于mapper级别的缓存不同的sqlsession是可以共享的。 一级缓存 一级缓存是基于 PerpetualCache（MyBatis自带）的 HashMap 本地缓存，作用范围为 session 域内,它存储的SqlSession中的BaseExecutor之中。当 session flush（刷新）或者 close（关闭）之后，该 session 中所有的 cache（缓存）就会被清空。\n在参数和 SQL 完全一样的情况下，我们使用同一个 SqlSession 对象调用同一个 mapper 的方法，往往只执行一次 SQL。因为使用 SqlSession 第一次查询后，MyBatis 会将其放在缓存中，再次查询时，如果没有刷新，并且缓存没有超时的情况下，SqlSession 会取出当前缓存的数据，而不会再次发送 SQL 到数据库。\n由于 SqlSession 是相互隔离的，所以如果你使用不同的 SqlSession 对象，即使调用相同的 Mapper、参数和方法，MyBatis 还是会再次发送 SQL 到数据库执行，返回结果。\n示例:\npackage net.biancheng.test; import java.io.IOException; import java.io.InputStream; import java.util.List; import org.apache.ibatis.io.Resources; import org.apache.ibatis.session.SqlSession; import org.apache.ibatis.session.SqlSessionFactory; import org.apache.ibatis.session.SqlSessionFactoryBuilder; import org.apache.log4j.Logger; import net.biancheng.po.Website; public class Test { public static Logger logger = Logger.getLogger(Test.class); public static void main(String[] args) throws IOException { InputStream config = Resources.getResourceAsStream(\"mybatis-config.xml\"); // 根据配置文件构建 SqlSessionFactory ssf = new SqlSessionFactoryBuilder().build(config); SqlSession ss = ssf.openSession(); Website site = ss.selectOne(\"net.biancheng.mapper.WebsiteMapper.selectWebsiteById\", 1); logger.debug(\"使用同一个sqlsession再执行一次\"); Website site2 = ss.selectOne(\"net.biancheng.mapper.WebsiteMapper.selectWebsiteById\", 1); // 请注意，当我们使用二级缓存的时候，sqlSession调用了 commit方法后才会生效 ss.commit(); logger.debug(\"现在创建一个新的SqlSeesion对象在执行一次\"); SqlSession ss2 = ssf.openSession(); Website site3 = ss2.selectOne(\"net.biancheng.mapper.WebsiteMapper.selectWebsiteById\", 1); // 请注意，当我们使用二级缓存的时候，sqlSession调用了 commit方法后才会生效 ss2.commit(); } } 结果如下:\nDEBUG [main] - ==\u003e Preparing: SELECT * FROM website WHERE id=? DEBUG [main] - ==\u003e Parameters: 1(Integer) DEBUG [main] - \u003c== Total: 1 DEBUG [main] - 使用同一个sqlsession再执行一次 DEBUG [main] - 现在创建一个新的SqlSeesion对象在执行一次 DEBUG [main] - ==\u003e Preparing: SELECT * FROM website WHERE id=? DEBUG [main] - ==\u003e Parameters: 1(Integer) DEBUG [main] - \u003c== Total: 1 从运行结果可以看出，第一个 SqlSession 实际只发生过一次查询，而第二次查询就从缓存中取出了，也就是 SqlSession 层面的一级缓存。为了克服这个问题，我们往往需要配置二级缓存，使得缓存在 SqlSessionFactory 层面上能够提供给各个 SqlSession 对象共享。\n一级缓存失效的四种情况 sqlsession变了 缓存失效 sqlsession不变,查询条件不同，一级缓存失效 sqlsession不变,中间发生了增删改操作，一级缓存失败 sqlsession不变,手动清除缓存，一级缓存失败 spring结合mybatis后，一级缓存作用：\n在未开启事务的情况之下，每次查询，spring都会关闭旧的sqlSession而创建新的sqlSession,因此此时的一级缓存是不起作用的\n在开启事务的情况之下，spring使用ThreadLocal获取当前资源绑定同一个sqlSession，因此此时一级缓存是有效的。\n由于spring使用了代理, 所以在代理结束时就关闭了sqlsession, 导致一级缓存失效\nSpring整合MyBatis时一级缓存失效问题_xingze_W的博客-CSDN博客_spring整合mybatis一级缓存 mybatis一级缓存失效的四种情况 - 简书 (jianshu.com) 禁用一级缓存 mybatis: configuration: cache-enabled: false #禁用二级缓存 local-cache-scope: statement #默认指定为session级别 指定缓存statement级别后, mybatis会删除缓存\norg.apache.ibatis.executor.BaseExecutor#query(MappedStatement, Object, RowBounds, ResultHandler, CacheKey, BoundSql)\npublic \u003cE\u003e List\u003cE\u003e query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException { ErrorContext.instance().resource(ms.getResource()).activity(\"executing a query\").object(ms.getId()); if (closed) throw new ExecutorException(\"Executor was closed.\"); if (queryStack == 0 \u0026\u0026 ms.isFlushCacheRequired()) { clearLocalCache(); } List\u003cE\u003e list; try { queryStack++; list = resultHandler == null ? (List\u003cE\u003e) localCache.getObject(key) : null; if (list != null) { handleLocallyCachedOutputParameters(ms, key, parameter, boundSql); } else { list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql); } } finally { queryStack--; } if (queryStack == 0) { for (DeferredLoad deferredLoad : deferredLoads) { deferredLoad.load(); } // 此处做了删除 if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) { clearLocalCache(); // issue #482 } } return list; } 二级缓存 二级缓存是全局缓存，作用域超出 session 范围之外，可以被所有 SqlSession 共享。二级缓存的作用域是namespace，也就是作用范围是同一个命名空间\n开启二级缓存后，会使用CachingExecutor装饰Executor，进入一级缓存的查询流程前，先在CachingExecutor进行二级缓存的查询，具体的工作流程如下所示。\n二级缓存开启后，同一个namespace下的所有操作语句，都影响着同一个Cache，即二级缓存被多个SqlSession共享，是一个全局的变量。 当开启缓存后，数据的查询执行的流程就是 二级缓存 -\u003e 一级缓存 -\u003e 数据库。\n禁用二级缓存 mybatis: configuration: cache-enabled: false #禁用二级缓存, 默认为true mybatis的二级缓存是本地实现的, 在分布式环境中, 容易产生脏数据 , 所以一般会使用redis这种第三方存储来使用二级缓存\nSpringBoot+Mybatis一级缓存和二级缓存详解 - 郑晓龙 - 博客园 (cnblogs.com) mybatis 二级缓存失效_给我五分钟，带你彻底掌握MyBatis的缓存工作原理_Tfifthe的博客-CSDN博客 MyBatis缓存（一级缓存和二级缓存） (biancheng.net) MyBatis|缓存机制 - 简书 (jianshu.com) springboot+mybatis一级缓存启用/禁用问题_NongYeting的博客-CSDN博客_springboot关闭mybatis缓存 ","wordCount":"2174","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-04T00:18:25+08:00","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis/%E7%BC%93%E5%AD%98.html"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class="dark" id="top"><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class="header"><nav class="nav"><div class="logo"><a accesskey="h" href="https://xiaokunji.com/zh/" title="米二 (Alt + H)"><img alt="" aria-label="logo" height="35" src="https://xiaokunji.com/img/Q.svg"/>米二</a><div class="logo-switches"><button accesskey="t" id="theme-toggle" title="(Alt + T)"><svg fill="none" height="18" id="moon" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg><svg fill="none" height="18" id="sun" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg></button><ul class="lang-switch"><li>|</li><li><a aria-label="English" href="https://xiaokunji.com/en/" title="English">English</a></li></ul></div></div><ul id="menu"><li><a href="https://xiaokunji.com/zh/" title="🏠主页"><span>🏠主页</span></a></li><li><a accesskey="/" href="https://xiaokunji.com/zh/search" title="🔍搜索 (Alt + /)"><span>🔍搜索</span></a></li><li><a href="https://xiaokunji.com/zh/post.html" title="📚文章"><span>📚文章</span></a></li><li><a href="https://xiaokunji.com/zh/archives.html" title="⏱时间轴"><span>⏱时间轴</span></a></li><li><a href="https://xiaokunji.com/zh/tags.html" title="🔖标签"><span>🔖标签</span></a></li><li><a href="https://xiaokunji.com/zh/categories.html" title="📖分类"><span>📖分类</span></a></li><li><a href="https://xiaokunji.com/zh/links.html" title="🤝友链"><span>🤝友链</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><nav aria-label="breadcrumb"><ul><a href="https://xiaokunji.com/zh/">🏠</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">java及其框架</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/mybatis.html">mybatis</a> <span>&gt;</span></ul></nav><h1 class="post-title">缓存</h1><div class="post-description">mybatis的一级缓存和二级环境</div><div class="post-meta">创建:&amp;nbsp;&lt;span title='2023-08-22 00:00:00 +0000 UTC'&gt;2023-08-22&lt;/span&gt;&amp;nbsp;·&amp;nbsp;更新:&amp;nbsp;2023-09-04&amp;nbsp;·&amp;nbsp;xkj
 | 分类:  <ul class="post-categories-meta" style="display:inline"><a href="https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">java及其框架</a></ul><span id="busuanzi_container_page_pv"> | 访问: <span id="busuanzi_value_page_pv">1</span></span></div></header><aside class="toc-container wide" id="toc-container"><div class="toc"><details open=""><summary accesskey="c" title="(Alt + C)"><span class="details">目录</span></summary><div class="inner"><ul><li><a aria-label="前言" href="#%e5%89%8d%e8%a8%80">前言</a></li><li><a aria-label="一级缓存" href="#%e4%b8%80%e7%ba%a7%e7%bc%93%e5%ad%98">一级缓存</a><ul><li><a aria-label="一级缓存失效的四种情况" href="#%e4%b8%80%e7%ba%a7%e7%bc%93%e5%ad%98%e5%a4%b1%e6%95%88%e7%9a%84%e5%9b%9b%e7%a7%8d%e6%83%85%e5%86%b5">一级缓存失效的四种情况</a></li><li><a aria-label="禁用一级缓存" href="#%e7%a6%81%e7%94%a8%e4%b8%80%e7%ba%a7%e7%bc%93%e5%ad%98">禁用一级缓存</a></li></ul></li><li><a aria-label="二级缓存" href="#%e4%ba%8c%e7%ba%a7%e7%bc%93%e5%ad%98">二级缓存</a><ul><li><a aria-label="禁用二级缓存" href="#%e7%a6%81%e7%94%a8%e4%ba%8c%e7%ba%a7%e7%bc%93%e5%ad%98">禁用二级缓存</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class="post-content"><p>[TOC]</p><h1 id="前言">前言<a aria-hidden="true" class="anchor" hidden="" href="#前言">#</a></h1><p>和大多数持久化框架一样，MyBatis 提供了一级缓存和二级缓存的支持。默认情况下，MyBatis 只开启一级缓存。</p><p>MyBatis提供了一级缓存和二级缓存</p><ul><li>一级缓存：也称为本地缓存，用于保存用户在一次会话过程中查询的结果，用户一次会话中只能使用一个sqlSession，一级缓存是自动开启的，不允许关闭。</li><li>二级缓存：也称为全局缓存，是mapper级别的缓存，是针对一个表的查结果的存储，可以共享给所有针对这张表的查询的用户。也就是说对于mapper级别的缓存不同的sqlsession是可以共享的。</li></ul><h1 id="一级缓存">一级缓存<a aria-hidden="true" class="anchor" hidden="" href="#一级缓存">#</a></h1><p>一级缓存是基于 PerpetualCache（MyBatis自带）的 HashMap 本地缓存，作用范围为 session 域内,它存储的SqlSession中的BaseExecutor之中。当 session flush（刷新）或者 close（关闭）之后，该 session 中所有的 cache（缓存）就会被清空。</p><p>在参数和 SQL 完全一样的情况下，我们使用同一个 SqlSession 对象调用同一个 mapper 的方法，往往只执行一次 SQL。因为使用 SqlSession 第一次查询后，MyBatis 会将其放在缓存中，再次查询时，如果没有刷新，并且缓存没有超时的情况下，SqlSession 会取出当前缓存的数据，而不会再次发送 SQL 到数据库。</p><p>由于 SqlSession 是相互隔离的，所以如果你使用不同的 SqlSession 对象，即使调用相同的 Mapper、参数和方法，MyBatis 还是会再次发送 SQL 到数据库执行，返回结果。</p><p>示例:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">package</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">net.biancheng.test</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">java.io.IOException</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">java.io.InputStream</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">java.util.List</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">org.apache.ibatis.io.Resources</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">org.apache.ibatis.session.SqlSession</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">org.apache.ibatis.session.SqlSessionFactory</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">org.apache.ibatis.session.SqlSessionFactoryBuilder</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">org.apache.log4j.Logger</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">import</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">net.biancheng.po.Website</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:700">Test</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">static</span><span style="color:#6e7681"> </span>Logger<span style="color:#6e7681"> </span>logger<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Logger.getLogger(Test.class);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">static</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">main</span>(String<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>args)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>IOException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>InputStream<span style="color:#6e7681"> </span>config<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Resources.getResourceAsStream(<span style="color:#a5d6ff">"mybatis-config.xml"</span>);<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// 根据配置文件构建</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>SqlSessionFactory<span style="color:#6e7681"> </span>ssf<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>SqlSessionFactoryBuilder().build(config);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>SqlSession<span style="color:#6e7681"> </span>ss<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ssf.openSession();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>Website<span style="color:#6e7681"> </span>site<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ss.selectOne(<span style="color:#a5d6ff">"net.biancheng.mapper.WebsiteMapper.selectWebsiteById"</span>,<span style="color:#6e7681"> </span>1);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>logger.debug(<span style="color:#a5d6ff">"使用同一个sqlsession再执行一次"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>Website<span style="color:#6e7681"> </span>site2<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ss.selectOne(<span style="color:#a5d6ff">"net.biancheng.mapper.WebsiteMapper.selectWebsiteById"</span>,<span style="color:#6e7681"> </span>1);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// 请注意，当我们使用二级缓存的时候，sqlSession调用了 commit方法后才会生效</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>ss.commit();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>logger.debug(<span style="color:#a5d6ff">"现在创建一个新的SqlSeesion对象在执行一次"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>SqlSession<span style="color:#6e7681"> </span>ss2<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ssf.openSession();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>Website<span style="color:#6e7681"> </span>site3<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ss2.selectOne(<span style="color:#a5d6ff">"net.biancheng.mapper.WebsiteMapper.selectWebsiteById"</span>,<span style="color:#6e7681"> </span>1);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// 请注意，当我们使用二级缓存的时候，sqlSession调用了 commit方法后才会生效</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>ss2.commit();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>结果如下:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-fallback" data-lang="fallback"><span style="display:flex"><span>DEBUG [main] - ==&gt;  Preparing: SELECT * FROM website WHERE id=?
</span></span><span style="display:flex"><span>DEBUG [main] - ==&gt; Parameters: 1(Integer)
</span></span><span style="display:flex"><span>DEBUG [main] - &lt;==      Total: 1
</span></span><span style="display:flex"><span>DEBUG [main] - 使用同一个sqlsession再执行一次
</span></span><span style="display:flex"><span>DEBUG [main] - 现在创建一个新的SqlSeesion对象在执行一次
</span></span><span style="display:flex"><span>DEBUG [main] - ==&gt;  Preparing: SELECT * FROM website WHERE id=?
</span></span><span style="display:flex"><span>DEBUG [main] - ==&gt; Parameters: 1(Integer)
</span></span><span style="display:flex"><span>DEBUG [main] - &lt;==      Total: 1
</span></span></code></pre></div><p>从运行结果可以看出，第一个 SqlSession 实际只发生过一次查询，而第二次查询就从缓存中取出了，也就是 SqlSession 层面的一级缓存。为了克服这个问题，我们往往需要配置二级缓存，使得缓存在 SqlSessionFactory 层面上能够提供给各个 SqlSession 对象共享。</p><h2 id="一级缓存失效的四种情况">一级缓存失效的四种情况<a aria-hidden="true" class="anchor" hidden="" href="#一级缓存失效的四种情况">#</a></h2><ol><li>sqlsession变了 缓存失效</li><li>sqlsession不变,查询条件不同，一级缓存失效</li><li>sqlsession不变,中间发生了增删改操作，一级缓存失败</li><li>sqlsession不变,手动清除缓存，一级缓存失败</li></ol><blockquote><p>spring结合mybatis后，一级缓存作用：</p><ul><li><p>在未开启事务的情况之下，每次查询，spring都会关闭旧的sqlSession而创建新的sqlSession,因此此时的一级缓存是不起作用的</p></li><li><p>在开启事务的情况之下，spring使用ThreadLocal获取当前资源绑定同一个sqlSession，因此此时一级缓存是有效的。</p><p>由于spring使用了代理, 所以在代理结束时就关闭了sqlsession, 导致一级缓存失效</p></li></ul></blockquote><p><a href="https://blog.csdn.net/qq_42220174/article/details/102993338" rel="noopener" target="_blank">Spring整合MyBatis时一级缓存失效问题_xingze_W的博客-CSDN博客_spring整合mybatis一级缓存</a></p><p><a href="https://www.jianshu.com/p/2521ccc7a7df" rel="noopener" target="_blank">mybatis一级缓存失效的四种情况 - 简书 (jianshu.com)</a></p><h2 id="禁用一级缓存">禁用一级缓存<a aria-hidden="true" class="anchor" hidden="" href="#禁用一级缓存">#</a></h2><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#7ee787">mybatis</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#7ee787">configuration</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">cache-enabled</span>:<span style="color:#6e7681"> </span><span style="color:#79c0ff">false</span><span style="color:#6e7681">  </span><span style="color:#8b949e;font-style:italic">#禁用二级缓存</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">local-cache-scope</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">statement </span><span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">#默认指定为session级别</span><span style="color:#6e7681">
</span></span></span></code></pre></div><p>指定缓存statement级别后, mybatis会删除缓存</p><p><code>org.apache.ibatis.executor.BaseExecutor#query(MappedStatement, Object, RowBounds, ResultHandler, CacheKey, BoundSql)</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&lt;</span>E<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>E<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">query</span>(MappedStatement<span style="color:#6e7681"> </span>ms,<span style="color:#6e7681"> </span>Object<span style="color:#6e7681"> </span>parameter,<span style="color:#6e7681"> </span>RowBounds<span style="color:#6e7681"> </span>rowBounds,<span style="color:#6e7681"> </span>ResultHandler<span style="color:#6e7681"> </span>resultHandler,<span style="color:#6e7681"> </span>CacheKey<span style="color:#6e7681"> </span>key,<span style="color:#6e7681"> </span>BoundSql<span style="color:#6e7681"> </span>boundSql)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>SQLException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>ErrorContext.instance().resource(ms.getResource()).activity(<span style="color:#a5d6ff">"executing a query"</span>).object(ms.getId());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(closed)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ExecutorException(<span style="color:#a5d6ff">"Executor was closed."</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(queryStack<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>0<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&amp;&amp;</span><span style="color:#6e7681"> </span>ms.isFlushCacheRequired())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>clearLocalCache();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>E<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>list;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>queryStack<span style="color:#ff7b72;font-weight:700">++</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>list<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>resultHandler<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">?</span><span style="color:#6e7681"> </span>(List<span style="color:#ff7b72;font-weight:700">&lt;</span>E<span style="color:#ff7b72;font-weight:700">&gt;</span>)<span style="color:#6e7681"> </span>localCache.getObject(key)<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(list<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>handleLocallyCachedOutputParameters(ms,<span style="color:#6e7681"> </span>key,<span style="color:#6e7681"> </span>parameter,<span style="color:#6e7681"> </span>boundSql);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>list<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>queryFromDatabase(ms,<span style="color:#6e7681"> </span>parameter,<span style="color:#6e7681"> </span>rowBounds,<span style="color:#6e7681"> </span>resultHandler,<span style="color:#6e7681"> </span>key,<span style="color:#6e7681"> </span>boundSql);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">finally</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>queryStack<span style="color:#ff7b72;font-weight:700">--</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(queryStack<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>0)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(DeferredLoad<span style="color:#6e7681"> </span>deferredLoad<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>deferredLoads)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>deferredLoad.load();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// 此处做了删除</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(configuration.getLocalCacheScope()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>LocalCacheScope.STATEMENT)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>clearLocalCache();<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// issue #482</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>list;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><h1 id="二级缓存">二级缓存<a aria-hidden="true" class="anchor" hidden="" href="#二级缓存">#</a></h1><p>二级缓存是全局缓存，作用域超出 session 范围之外，可以被所有 SqlSession 共享。二级缓存的作用域是namespace，也就是作用范围是同一个命名空间</p><p>开启二级缓存后，会使用CachingExecutor装饰Executor，进入一级缓存的查询流程前，先在CachingExecutor进行二级缓存的查询，具体的工作流程如下所示。</p><p><img alt="img" loading="lazy" src="%E7%BC%93%E5%AD%98.assets/15083002-cfdb77a351f8fc73.webp"/></p><p>二级缓存开启后，同一个namespace下的所有操作语句，都影响着同一个Cache，即二级缓存被多个SqlSession共享，是一个全局的变量。
当开启缓存后，数据的查询执行的流程就是 二级缓存 -&gt; 一级缓存 -&gt; 数据库。</p><h2 id="禁用二级缓存">禁用二级缓存<a aria-hidden="true" class="anchor" hidden="" href="#禁用二级缓存">#</a></h2><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#7ee787">mybatis</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#7ee787">configuration</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">cache-enabled</span>:<span style="color:#6e7681"> </span><span style="color:#79c0ff">false</span><span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">#禁用二级缓存, 默认为true</span><span style="color:#6e7681">
</span></span></span></code></pre></div><p><strong>mybatis的二级缓存是本地实现的, 在分布式环境中, 容易产生脏数据 , 所以一般会使用redis这种第三方存储来使用二级缓存</strong></p><p><a href="https://www.cnblogs.com/zhengxl5566/p/11868656.html" rel="noopener" target="_blank">SpringBoot+Mybatis一级缓存和二级缓存详解 - 郑晓龙 - 博客园 (cnblogs.com)</a></p><p><a href="https://blog.csdn.net/weixin_28689507/article/details/112337488" rel="noopener" target="_blank">mybatis 二级缓存失效_给我五分钟，带你彻底掌握MyBatis的缓存工作原理_Tfifthe的博客-CSDN博客</a></p><p><a href="http://c.biancheng.net/mybatis/cache.html" rel="noopener" target="_blank">MyBatis缓存（一级缓存和二级缓存） (biancheng.net)</a></p><p><a href="https://www.jianshu.com/p/b4522c9212fb" rel="noopener" target="_blank">MyBatis|缓存机制 - 简书 (jianshu.com)</a></p><p><a href="https://blog.csdn.net/NongYeting/article/details/106408985" rel="noopener" target="_blank">springboot+mybatis一级缓存启用/禁用问题_NongYeting的博客-CSDN博客_springboot关闭mybatis缓存</a></p></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xiaokunji.com/zh/tags/Mybatis.html">Mybatis</a></li><li><a href="https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">java及其框架</a></li></ul><nav class="paginav"><a class="prev" href="https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E7%AE%97%E6%B3%95/%E7%BA%A2%E9%BB%91%E6%A0%91.html"><span class="title">« 上一页</span><br/><span>红黑树</span>
</a><a class="next" href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/JVM/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E5%9B%9E%E6%94%B6%E5%89%8D%E6%8F%90.html"><span class="title">下一页 »</span><br/><span>回收前提</span></a></nav></footer></article></main><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><footer class="footer"><span>Copyright
©
-2023
<a href="https://xiaokunji.com/zh/" style="color:#939393">米二</a>
All Rights Reserved
</span><span id="busuanzi_container"><span class="fa fa-user">用户数:</span><span id="busuanzi_value_site_uv"></span>
<span class="fa fa-eye">访问数:</span><span id="busuanzi_value_site_pv"></span></span></footer><a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)"><svg fill="currentcolor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>