<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nacos | 米二</title><meta name=keywords content=" 前言, 1. 概念, 2. 架构, 3. 安装, 3.1 Nacos Server 有两种运行模式：, 3.1.1 standalone 模式, 3.1.2 cluster 模式, 集群节点(此处是在同一台机器上,所以用ip区分), 4. 注册中心, 4.1 基本使用, 4.2 在不写本机地址时,nacos如何发现ip的, 5. 配置中心, 5.1 动态配置, 5.1.1 使用, 5.1.2 原理详解, 5.1.2.1 采用延迟线程池定时执行 监听 文件是否有修改, 5.1.2.2 通过长轮询的方式获得修改过的文件及其内容, 5.1.2.3 拿到配置后通过applicationContext更新到项目内存中, 5.1.3 总结, A&amp;Q"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/nacos/><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/nacos/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Nacos"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/nacos/"><meta property="article:section" content="java及其框架"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-26T15:51:06+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nacos"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":5,"name":"Nacos","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/nacos/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nacos","name":"Nacos","description":"     ","keywords":[" 前言"," 1. 概念"," 2. 架构"," 3. 安装"," 3.1 Nacos Server 有两种运行模式："," 3.1.1 standalone 模式"," 3.1.2 cluster 模式"," 集群节点(此处是在同一台机器上,所以用ip区分)"," 4. 注册中心"," 4.1 基本使用"," 4.2 在不写本机地址时,nacos如何发现ip的"," 5. 配置中心"," 5.1 动态配置"," 5.1.1 使用"," 5.1.2 原理详解"," 5.1.2.1 采用延迟线程池定时执行 监听 文件是否有修改"," 5.1.2.2 通过长轮询的方式获得修改过的文件及其内容"," 5.1.2.3 拿到配置后通过applicationContext更新到项目内存中"," 5.1.3 总结"," A\u0026Q"],"articleBody":"[toc]\n前言 阿里开源的注册中心和配置中心\nNacos 官方文档 Nacos 源码 1. 概念 Name Space\n用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。\nConfiguration\n配置文件\nData ID\nNacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。\nGroup\nNacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。\nVirtual Cluster\n同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。\n如图: Nacos 概念 2. 架构 3. 安装 Nacos Server下载地址：\nhttps://github.com/alibaba/nacos/releases 下载解压后打开bin目录\n/work/nacos/bin/startup.sh -m standalone\nwindows: startup.cmd -m standalone\n启动完后访问后台\nNacos Server的后台访问地址：\nhttp://192.168.10.13:8848/nacos/index.html\n默认账号和密码为：nacos/nacos\n3.1 Nacos Server 有两种运行模式： standalone cluster (默认模式) 3.1.1 standalone 模式 此模式一般用于 demo 和测试，不用改任何配置，直接敲以下命令执行\n3.1.2 cluster 模式 cluster 模式需要依赖 MySQL，然后改两个配置文件：\nconf/cluster.conf conf/application.properties conf/cluster.conf\n# 集群节点(此处是在同一台机器上,所以用ip区分) 192.168.10.13:8841 192.168.10.13:8845 192.168.10.13:8848 conf/application.properties\nspring.datasource.platform=mysql db.num=1 db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8\u0026connectTimeout=1000\u0026socketTimeout=3000\u0026autoReconnect=true\u0026useUnicode=true\u0026useSSL=false\u0026serverTimezone=UTC\u0026AllowPublicKeyRetrieval=True db.user.0=test db.password.0=xiaokunji 每个节点上需要改这两个文件\n注意在application.properties文件中修改端口\n启动后 任意节点都能进入管理界面\n阿里巴巴NACOS（3）- 部署Nacos的生产集群环境-阿里云开发者社区 (aliyun.com) 一般集群部署需要搭配NGINX, 这样就可以统一管理对外ip, 且需要利用NGINX的故障转移策略, nacos本身不具备故障转移\nNacos 集群部署 - CanntBelieve - 博客园 (cnblogs.com) 4. 注册中心 参数解释\n参数 描述 com.alibaba.nacos.naming.log.level Naming客户端的日志级别，改属性通过客户端启动时通过命令行加参数指定 注：默认为info spring.cloud.nacos.discovery.heart-beat-interval nacos客户端向服务端发送心跳的时间间隔，默认5s\n注：客户端向服务端每隔5s向服务端发送心跳请求，进行服务续租，告诉服务端该实例IP健康。若在3次心跳的间隔时间(默认15s)内服务端没有接受到该实例的心跳请求，则认为该实例不健康，该实例将无法被消费。如果再次经历3次心跳的间隔时间，服务端接受到该实例的请求，那么会立刻将其设置外健康，并可以被消费，若未接受到，则删除该实例的注册信息。推荐配置为5s，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值。 spring.cloud.nacos.discovery.heart-beat-timeout: 服务端没有接受到客户端心跳请求就将其设为不健康的时间间隔，默认为15s. 注：推荐值该值为15s即可，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值。 spring.cloud.nacos.discovery.log-name: nacos客户端会在启动时打印一部分发送注册请求信息和异常日志，可以通过日志查看注册的nacos集群地址、服务名、nameSpace、IP、元数据等内容，文件名默认为naming.log . 注:推荐将该日志的位置设置为和其他日志在一个文件夹下 spring.cloud.nacos.discovery.metadata: 给服务添加一些标签，例如属于什么业务线，该元数据会持久化存储在服务端，但是客户端消费时不会获取到此值，默认为空. 注:推荐为空，我们可以通过已经注册的服务名来找到具体的业务线，无需添加metadata spring.cloud.nacos.discovery.namespace: 命名空间ID，Nacos通过不同的命名空间来区分不同的环境，进行数据隔离，服务消费时只能消费到对应命名空间下的服务。 spring.cloud.nacos.discovery.naming-load-cache-at-start: 默认为false。客户端在启动时是否读取本地配置项(一个文件)来获取服务列表. 注：推荐该值为false，若改成true。则客户端会在本地的一个文件中保存服务信息，当下次宕机启动时，会优先读取本地的配置对外提供服务。 spring.cloud.nacos.discovery.port: 向nacos注册服务时，服务对应的端口号 . 注:无需修改，默认为应用对外提供服务的端口号,server.port spring.cloud.nacos.discovery.register-enabled: 该项目是否向注册中心注册服务，默认为true . 注：如果服务从注册中心只消费服务，没有对外提供服务，那么该值可设置为false，可减少客户端线程池的创建，无需向服务端发送心跳请求，提高性能。 spring.cloud.nacos.discovery.server-addr nacos集群地址。注：多个IP可以通过“，”号隔离，例如192.168.80.1:8848,192.168.80.1:8848 填写域名时前缀不要加上http:// spring.cloud.nacos.discovery.service: 项目向注册中心注册服务时的服务名，默认为spring.application.name 变量 . 注:该服务名必须使用小写，因为nacos服务名区分大小写，如果服务名不完全匹配，那么无法调用服务 spring.cloud.nacos.discovery.watch-delay: 默认为30s。客户端在启动时会创建一个线程池，该线程定期去查询服务端的信息列表，该请求不会立刻返回，默认等待30s，若在30s内，服务端信息列表发生变化，则该请求立刻返回，通知客户端拉取服务端的服务信息列表，若30s内，没有变化，则30s时该请求返回响应，客户端服务列表不变，再次发生该请求。 注：推荐该值为30s即可，无需修改 spring.cloud.nacos.discovery.watch.enabled: 默认为true,客户端在启动时会创建一个线程池，该线程定期去查询服务端的信息列表，该请求不会立刻返回，默认等待30s，若在30s内，服务端信息列表发生变化，则该请求立刻返回，通知客户端拉取服务端的服务信息列表，若30s内，没有变化，则30s时该请求返回响应，客户端服务列表不变，再次发生该请求。 注:推荐该功能为true，这是nacos类似长连接推送服务变化的功能，不要关闭 spring.cloud.nacos.discovery.weight: nacos支持服务端基于权重的负载均衡，该值默认为1 . 注:建议该值保持默认即可，因为代码可能会部署到不同的服务器上，无法确保某台服务器的配置一定较好，如果有需要修改该值的需求，可以上控制台修改，这样可以保证对应IP服务器的权重值较高 watch-delay 有什么作用?\n4.1 基本使用 pom.xml\ncom.alibaba.cloud spring-cloud-starter-alibaba-nacos-discovery 2.2.1.RELEASE 使用配置文件如下:\nspring: cloud: nacos: -- 配置中心 config: namespace: xkjNamespace server-addr: 192.168.2.101:8841,192.168.2.101:8845,192.168.2.101:8848 group: xkjGroup -- 注册中心 discovery: server-addr: ${spring.cloud.nacos.config.server-addr} cluster-name: xkjCluster -- 此处是命名空间的id namespace: xkjNamespace service: javaDemoDiscovery group: xkjGroup application: name: javaDemo 4.2 在不写本机地址时,nacos如何发现ip的 与 Eureka使用了同一个工具类, 有spring-cloud-common提供的 InetUtils 类, 因此两者获取ip是同样的原理,详见 [Eureka文章](https://github.com/xiaokunji/myNotes/blob/main/java 及其框架/Spring Cloud/Eureka.md)\n简单来说就是遍历所有网卡, 去除一些回旋地址,忽略地址等规则取索引最小的, 默认返回本地地址\n5. 配置中心 在 Nacos Spring Cloud 中，dataId 的完整格式如下：\n${prefix}-${spring.profile.active}.${file-extension}\nprefix 默认为所属工程配置spring.application.name 的值（即：nacos-provider），也可以通过配置项 spring.cloud.nacos.config.prefix来配置； spring.profile.active 即为当前环境对应的 profile，详情可以参考 Spring Boot文档。 注意：当spring.profile.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension} file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类型；默认为 properties ； Nacos 入门教程_cristianoxm的博客-CSDN博客_nacos 教程 pom.xml\ncom.alibaba.cloud spring-cloud-starter-alibaba-nacos-config 2.2.1.RELEASE 配置文件:\n新增bootstrap.yml文件，配置信息写在该文件里。（问题：如放在application.yml会导致项目启动报找不到配置属性错误，原因：application.yml与bootstrap.yml加载顺序优先级问题。）\nspring: application: name: javaDemo cloud: nacos: server-addr: ${spring.cloud.client.ip-address}:8848 config: namespace: xkjNamespace file-extension: yml shared-configs: - data-id: mysqlTest.yml refresh: true group: xkjGroup extension-configs: - data-id: MyTest.yml refresh: true group: xkjGroup group: xkjGroup # 该配置如果放在share和extentsion配置的前面,将覆盖其下的组 java使用类:\n@Value(\"${my.name:本地值name}\") private String name; @Value(\"${person.name:本地值person.name}\") private String person_name; @Value(\"${personAge:本地值personAge}\") private String personAge; @Value(\"${personName:本地值personName}\") private String personName; 5.1 动态配置 5.1.1 使用 通常获取配置文件的方式\n@Value\n@ConfigurationProperties(Prefix)\n如果是在运行时要动态更新的话，\n第一种方式要在bean上加@RefreshScope 第二种方式是自动支持的。\n5.1.2 原理详解 5.1.2.1 采用延迟线程池定时执行\"监听\"文件是否有修改 服务启动后就回轮询的打印图上信息, 当有配置被改动时, 这个[] 就会包含数据了, 可想而知这是监听日志了, 那就找到这段代码\nClientWorker.java\nclass LongPollingRunnable implements Runnable { private int taskId; public LongPollingRunnable(int taskId) { this.taskId = taskId; } @Override public void run() { List\u003cCacheData\u003e cacheDatas = new ArrayList\u003cCacheData\u003e(); List\u003cString\u003e inInitializingCacheList = new ArrayList\u003cString\u003e(); try { // check failover config for (CacheData cacheData : cacheMap.get().values()) { if (cacheData.getTaskId() == taskId) { cacheDatas.add(cacheData); try { checkLocalConfig(cacheData); if (cacheData.isUseLocalConfigInfo()) { cacheData.checkListenerMd5(); } } catch (Exception e) { LOGGER.error(\"get local config info error\", e); } } } // check server config List\u003cString\u003e changedGroupKeys = checkUpdateDataIds(cacheDatas, inInitializingCacheList); LOGGER.info(\"get changedGroupKeys:\" + changedGroupKeys); // 省略剩下代码 ..... } } } 从这里就能看出, 先是对配置做了一些检查, 然后就打印结果, 而且这个是在run方法里, 说明这里肯定是开了线程在跑的, 找到调用LongPollingRunnable这个类的地方\n还是在同一个类中, 发现是在execute中执行的, 那就是弄了一个线程池, 而且这里是在for循环里, 看一下任务, 就会联想到多个配置文件的情况, 同时监听的\npublic void checkConfigInfo() { // 分任务 int listenerSize = cacheMap.get().size(); // 向上取整为批数 int longingTaskCount = (int) Math.ceil(listenerSize / ParamUtil.getPerTaskConfigSize()); if (longingTaskCount \u003e currentLongingTaskCount) { for (int i = (int) currentLongingTaskCount; i \u003c longingTaskCount; i++) { // 要判断任务是否在执行 这块需要好好想想。 任务列表现在是无序的。变化过程可能有问题 executorService.execute(new LongPollingRunnable(i)); } currentLongingTaskCount = longingTaskCount; } } 看一下这个线程池的参数.\n@SuppressWarnings(\"PMD.ThreadPoolCreationRule\") public ClientWorker(final HttpAgent agent, final ConfigFilterChainManager configFilterChainManager, final Properties properties) { this.agent = agent; this.configFilterChainManager = configFilterChainManager; // Initialize the timeout parameter init(properties); executor = Executors.newScheduledThreadPool(1, new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread t = new Thread(r); t.setName(\"com.alibaba.nacos.client.Worker.\" + agent.getName()); t.setDaemon(true); return t; } }); // 执行的线程池 executorService = Executors.newScheduledThreadPool(Runtime.getRuntime().availableProcessors(), new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread t = new Thread(r); t.setName(\"com.alibaba.nacos.client.Worker.longPolling.\" + agent.getName()); t.setDaemon(true); return t; } }); executor.scheduleWithFixedDelay(new Runnable() { @Override public void run() { try { checkConfigInfo(); } catch (Throwable e) { LOGGER.error(\"[\" + agent.getName() + \"] [sub-check] rotate check error\", e); } } }, 1L, 10L, TimeUnit.MILLISECONDS); } 还会发现这里还有个延迟线程池,而且只有一个线程数, 发现里面执行了checkConfigInfo(), 这刚好LongPollingRunnable 类执行的所在方法.\n至此, 它的定时执行就清楚了, 它开了一个单线程的延时线程池,每隔10ms执行一次, 线程里再用线程池去\"监听\"文件是否有修改\n但是我们发现日志间隔并不是10ms,而且这个间隔也太小了, 肯定不合理\n5.1.2.2 通过长轮询的方式获得修改过的文件及其内容 去看一下它是如何\"监听\", 跟进com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateDataIds\n/** * 从Server获取值变化了的DataID列表。返回的对象里只有dataId和group是有效的。 保证不返回NULL。 */ List\u003cString\u003e checkUpdateDataIds(List\u003cCacheData\u003e cacheDatas, List\u003cString\u003e inInitializingCacheList) throws IOException { // 构造参数- 通过配置dataId/group/tenant等数据来指定文件 StringBuilder sb = new StringBuilder(); for (CacheData cacheData : cacheDatas) { if (!cacheData.isUseLocalConfigInfo()) { sb.append(cacheData.dataId).append(WORD_SEPARATOR); sb.append(cacheData.group).append(WORD_SEPARATOR); if (StringUtils.isBlank(cacheData.tenant)) { sb.append(cacheData.getMd5()).append(LINE_SEPARATOR); } else { sb.append(cacheData.getMd5()).append(WORD_SEPARATOR); sb.append(cacheData.getTenant()).append(LINE_SEPARATOR); } if (cacheData.isInitializing()) { // cacheData 首次出现在cacheMap中\u0026首次check更新 inInitializingCacheList .add(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant)); } } } boolean isInitializingCacheList = !inInitializingCacheList.isEmpty(); // 核心方法- 检查更新文件 return checkUpdateConfigStr(sb.toString(), isInitializingCacheList); } com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateConfigStr\n/** * 从Server获取值变化了的DataID列表。返回的对象里只有dataId和group是有效的。 保证不返回NULL。 */ List\u003cString\u003e checkUpdateConfigStr(String probeUpdateString, boolean isInitializingCacheList) throws IOException { List\u003cString\u003e params = new ArrayList\u003cString\u003e(2); params.add(Constants.PROBE_MODIFY_REQUEST); params.add(probeUpdateString); List\u003cString\u003e headers = new ArrayList\u003cString\u003e(2); headers.add(\"Long-Pulling-Timeout\"); // 设置长轮询的过期时间 headers.add(\"\" + timeout); // told server do not hang me up if new initializing cacheData added in if (isInitializingCacheList) { headers.add(\"Long-Pulling-Timeout-No-Hangup\"); headers.add(\"true\"); } if (StringUtils.isBlank(probeUpdateString)) { return Collections.emptyList(); } try { // In order to prevent the server from handling the delay of the client's long task, // increase the client's read timeout to avoid this problem. long readTimeoutMs = timeout + (long) Math.round(timeout \u003e\u003e 1); // 长轮询请求 HttpResult result = agent.httpPost(Constants.CONFIG_CONTROLLER_PATH + \"/listener\", headers, params, agent.getEncode(), readTimeoutMs); if (HttpURLConnection.HTTP_OK == result.code) { setHealthServer(true); // 解析返参 return parseUpdateDataIdResponse(result.content); } else { setHealthServer(false); LOGGER.error(\"[{}] [check-update] get changed dataId error, code: {}\", agent.getName(), result.code); } } catch (IOException e) { setHealthServer(false); LOGGER.error(\"[\" + agent.getName() + \"] [check-update] get changed dataId exception\", e); throw e; } return Collections.emptyList(); } 就会发现它是发了一个请求过去, 然后通过parseUpdateDataIdResponse(result.content) 方法解析出返参里面的 dataId/group/tenant等数据\n这个请求中设置了一些长轮询的参数,表示这是一个长轮询的请求\n长轮询: 客户端发起Long Polling，此时如果服务端没有相关数据，会hold住请求，直到服务端有相关数据，或者等待一定时间超时才会返回。返回后，客户端又会立即再次发起下一次Long Polling。\n这里只是拿到了一个dataId和group等数据,那什么时候拿到具体的配置信息呢? 继续往下看 LongPollingRunnable#run\n// 检查更新的dataId List\u003cString\u003e changedGroupKeys = checkUpdateDataIds(cacheDatas, inInitializingCacheList); LOGGER.info(\"get changedGroupKeys:\" + changedGroupKeys); // 遍历这些文件 for (String groupKey : changedGroupKeys) { String[] key = GroupKey.parseKey(groupKey); String dataId = key[0]; String group = key[1]; String tenant = null; if (key.length == 3) { tenant = key[2]; } try { // 获得具体配置 String[] ct = getServerConfig(dataId, group, tenant, 3000L); CacheData cache = cacheMap.get().get(GroupKey.getKeyTenant(dataId, group, tenant)); // 把内容直接写到cacheMap中 cache.setContent(ct[0]); if (null != ct[1]) { cache.setType(ct[1]); } LOGGER.info(\"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}\", agent.getName(), dataId, group, tenant, cache.getMd5(), ContentUtils.truncateContent(ct[0]), ct[1]); } catch (NacosException ioe) { String message = String.format( \"[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s\", agent.getName(), dataId, group, tenant); LOGGER.error(message, ioe); } } for (CacheData cacheData : cacheDatas) { if (!cacheData.isInitializing() || inInitializingCacheList .contains(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant))) { // 检查md5 cacheData.checkListenerMd5(); cacheData.setInitializing(false); } } // ....省略剩下代码 } com.alibaba.nacos.client.config.impl.ClientWorker#getServerConfig 获得具体配置的方法\npublic String[] getServerConfig(String dataId, String group, String tenant, long readTimeout) throws NacosException { String[] ct = new String[2]; if (StringUtils.isBlank(group)) { group = Constants.DEFAULT_GROUP; } HttpResult result = null; try { List\u003cString\u003e params = null; if (StringUtils.isBlank(tenant)) { params = new ArrayList\u003cString\u003e(Arrays.asList(\"dataId\", dataId, \"group\", group)); } else { params = new ArrayList\u003cString\u003e(Arrays.asList(\"dataId\", dataId, \"group\", group, \"tenant\", tenant)); } // 通过get请求,获得具体配置 result = agent.httpGet(Constants.CONFIG_CONTROLLER_PATH, null, params, agent.getEncode(), readTimeout); } catch (IOException e) { String message = String.format( \"[%s] [sub-server] get server config exception, dataId=%s, group=%s, tenant=%s\", agent.getName(), dataId, group, tenant); LOGGER.error(message, e); throw new NacosException(NacosException.SERVER_ERROR, e); } switch (result.code) { case HttpURLConnection.HTTP_OK: // 先放到本地文件中 LocalConfigInfoProcessor.saveSnapshot(agent.getName(), dataId, group, tenant, result.content); // 将请求返参放入ct数组中 ct[0] = result.content; if (result.headers.containsKey(CONFIG_TYPE)) { ct[1] = result.headers.get(CONFIG_TYPE).get(0); } else { ct[1] = ConfigType.TEXT.getType(); } return ct; case HttpURLConnection.HTTP_NOT_FOUND: // 省略剩下代码...... } 至此, 清楚了它是如何拿到具体配置的了, 它通过(一次post请求)长轮询的方式和服务端建立连接, 获得dataId/group等数据, 再通过这些参数发起get请求获得具体的配置文件内容,并写到本地缓存中使用\n5.1.2.3 拿到配置后通过applicationContext更新到项目内存中 它取到这些配置后,是如何写到项目的内存中并使其生效的呢?\ntry { String[] ct = getServerConfig(dataId, group, tenant, 3000L); CacheData cache = cacheMap.get().get(GroupKey.getKeyTenant(dataId, group, tenant)); cache.setContent(ct[0]); if (null != ct[1]) { cache.setType(ct[1]); } LOGGER.info(\"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}\", agent.getName(), dataId, group, tenant, cache.getMd5(), ContentUtils.truncateContent(ct[0]), ct[1]); } catch (NacosException ioe) { String message = String.format( \"[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s\", agent.getName(), dataId, group, tenant); LOGGER.error(message, ioe); } } for (CacheData cacheData : cacheDatas) { if (!cacheData.isInitializing() || inInitializingCacheList .contains(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant))) { // 检查md5 cacheData.checkListenerMd5(); cacheData.setInitializing(false); } } // 省略剩下代码..... } 在取到具体配置后,遍历cacheDatas数据,并检查md5, 跟进去看一下, 它开始出现监听器了\nvoid checkListenerMd5() { for (ManagerListenerWrap wrap : listeners) { if (!md5.equals(wrap.lastCallMd5)) { safeNotifyListener(dataId, group, content, type, md5, wrap); } } } private void safeNotifyListener(final String dataId, final String group, final String content, final String type, final String md5, final ManagerListenerWrap listenerWrap) { final Listener listener = listenerWrap.listener; Runnable job = new Runnable() { @Override public void run() { ClassLoader myClassLoader = Thread.currentThread().getContextClassLoader(); ClassLoader appClassLoader = listener.getClass().getClassLoader(); try { if (listener instanceof AbstractSharedListener) { AbstractSharedListener adapter = (AbstractSharedListener) listener; adapter.fillContext(dataId, group); LOGGER.info(\"[{}] [notify-context] dataId={}, group={}, md5={}\", name, dataId, group, md5); } // 执行回调之前先将线程classloader设置为具体webapp的classloader，以免回调方法中调用spi接口是出现异常或错用（多应用部署才会有该问题）。 Thread.currentThread().setContextClassLoader(appClassLoader); ConfigResponse cr = new ConfigResponse(); cr.setDataId(dataId); cr.setGroup(group); cr.setContent(content); configFilterChainManager.doFilter(null, cr); String contentTmp = cr.getContent(); // 处理配置信息 listener.receiveConfigInfo(contentTmp); // compare lastContent and content if (listener instanceof AbstractConfigChangeListener) { Map data = ConfigChangeHandler.getInstance().parseChangeData(listenerWrap.lastContent, content, type); ConfigChangeEvent event = new ConfigChangeEvent(data); ((AbstractConfigChangeListener)listener).receiveConfigChange(event); listenerWrap.lastContent = content; } listenerWrap.lastCallMd5 = md5; LOGGER.info(\"[{}] [notify-ok] dataId={}, group={}, md5={}, listener={} \", name, dataId, group, md5, listener); } catch (NacosException de) { LOGGER.error(\"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} errCode={} errMsg={}\", name, dataId, group, md5, listener, de.getErrCode(), de.getErrMsg()); } catch (Throwable t) { LOGGER.error(\"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} tx={}\", name, dataId, group, md5, listener, t.getCause()); } finally { Thread.currentThread().setContextClassLoader(myClassLoader); } } }; final long startNotify = System.currentTimeMillis(); try { if (null != listener.getExecutor()) { listener.getExecutor().execute(job); } else { job.run(); } } catch (Throwable t) { LOGGER.error(\"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} throwable={}\", name, dataId, group, md5, listener, t.getCause()); } final long finishNotify = System.currentTimeMillis(); LOGGER.info(\"[{}] [notify-listener] time cost={}ms in ClientWorker, dataId={}, group={}, md5={}, listener={} \", name, (finishNotify - startNotify), dataId, group, md5, listener); } 这么长的代码,核心就是处理了那个runable, 其中调用了listener.receiveConfigInfo(contentTmp) 方法处理的监听器,它是一个抽象类, 找到它的实现类\ncom.alibaba.cloud.nacos.refresh.NacosContextRefresher\nprivate void registerNacosListener(final String groupKey, final String dataKey) { String key = NacosPropertySourceRepository.getMapKey(dataKey, groupKey); Listener listener = listenerMap.computeIfAbsent(key, lst -\u003e new AbstractSharedListener() { @Override public void innerReceive(String dataId, String group, String configInfo) { refreshCountIncrement(); nacosRefreshHistory.addRefreshRecord(dataId, group, configInfo); // todo feature: support single refresh for listening // 通过applicationContext的事件去更新配置 applicationContext.publishEvent( new RefreshEvent(this, null, \"Refresh Nacos config\")); if (log.isDebugEnabled()) { log.debug(String.format( \"Refresh Nacos config group=%s,dataId=%s,configInfo=%s\", group, dataId, configInfo)); } } }); try { configService.addListener(dataKey, groupKey, listener); } catch (NacosException e) { log.warn(String.format( \"register fail for nacos listener ,dataId=[%s],group=[%s]\", dataKey, groupKey), e); } } 至此, 清楚了获得的配置是如何生效的, 它将获得发生修改过的文件, 如果md5不一样了, 则执行监听器,通过applicationContext 更新配置到项目内存中\n明明已经知道了哪些文件被修改了,为啥还有比对md5, 因为可能是没有修改具体内容,只是点了编辑并保存\nmd5用的是java的digest和位移,md5可能存在冲突, 那怎么解决冲突问题的?\n5.1.3 总结 1.Nacos 客户端会循环请求服务端变更的数据，并且超时时间设置为30s，当配置发生变化时，请求的响应会立即返回，否则会一直等到 29.5s+ 之后再返回响应 2.Nacos 客户端能够实时感知到服务端配置发生了变化。 3.实时感知是建立在客户端拉和服务端“推”的基础上，但是这里的服务端“推”需要打上引号，因为服务端和客户端直接本质上还是通过 http 进行数据通讯的，之所以有“推”的感觉，是因为服务端主动将变更后的数据通过 http 的 response 对象提前写入了。 Long Polling长轮询详解 - 简书 (jianshu.com) NACOS动态配置 - barryzhou - 博客园 (cnblogs.com) spring boot 配置文件动态更新原理 以Nacos为例 - 二奎 - 博客园 (cnblogs.com) Nacos 配置中心原理分析 -第一篇- 简书 (jianshu.com) Nacos 配置中心原理分析 -第二篇 - 简书 (jianshu.com) A\u0026Q nacos集群架构?\n答: 和Eureka集群架构一样,他的数据是点对点的, 本身是主从结构,也就是说会产生过半选举,脑裂等知识点, 默认支持cap理论中的ap模式. 生产部署nacos集群时,推荐通过NGINX给nacos集群做负载均衡\n浅谈Nacos中的CAP - 包子卖完了嘛 - 博客园 (cnblogs.com) nacos如何实现动态配置?\n答: 使用长轮询机制,由客户端定时发起请求询问服务端是否有修改, 如果存在修改则通过applicationContext的publishEvent更新内存中的配置\n一次请求后将阻塞29.5s+, 才会发起下一次请求, 如果遇到服务端存在修改文件, 则会立即返回.\n定时机制是开了一个延时线程池,其中只有一个线程,每隔10ms发起一次请求, 服务启动时该任务就执行了\n","wordCount":"7013","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-26T15:51:06.004503443Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/nacos/"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="米二 (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>米二</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://xiaokunji.com/zh/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://xiaokunji.com/zh/post title=📚文章><span>📚文章</span></a></li><li><a href=https://xiaokunji.com/zh/archives/ title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://xiaokunji.com/zh/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://xiaokunji.com/zh/categories title=📖分类><span>📖分类</span></a></li><li><a href=https://xiaokunji.com/zh/links title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>米二</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/>java及其框架</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/>Spring_Cloud</a> <span>></span></ul></nav><h1 class=post-title>Nacos</h1><div class=post-description></div><div class=post-meta><span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;·&nbsp;14 分钟&nbsp;·&nbsp;xkj
&nbsp;|&nbsp;分类: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/>java及其框架</a></ul><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#1-%e6%a6%82%e5%bf%b5 aria-label="1. 概念">1. 概念</a></li><li><a href=#2-%e6%9e%b6%e6%9e%84 aria-label="2. 架构">2. 架构</a></li><li><a href=#3-%e5%ae%89%e8%a3%85 aria-label="3. 安装">3. 安装</a><ul><li><a href=#31-nacos-server-%e6%9c%89%e4%b8%a4%e7%a7%8d%e8%bf%90%e8%a1%8c%e6%a8%a1%e5%bc%8f aria-label="3.1 Nacos Server 有两种运行模式：">3.1 Nacos Server 有两种运行模式：</a><ul><li><a href=#311-standalone-%e6%a8%a1%e5%bc%8f aria-label="3.1.1 standalone 模式">3.1.1 standalone 模式</a></li><li><a href=#312-cluster-%e6%a8%a1%e5%bc%8f aria-label="3.1.2 cluster 模式">3.1.2 cluster 模式</a></li></ul></li></ul></li><li><a href=#4-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83 aria-label="4. 注册中心">4. 注册中心</a><ul><li><a href=#41-%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 aria-label="4.1 基本使用">4.1 基本使用</a></li><li><a href=#42-%e5%9c%a8%e4%b8%8d%e5%86%99%e6%9c%ac%e6%9c%ba%e5%9c%b0%e5%9d%80%e6%97%b6nacos%e5%a6%82%e4%bd%95%e5%8f%91%e7%8e%b0ip%e7%9a%84 aria-label="4.2 在不写本机地址时,nacos如何发现ip的">4.2 在不写本机地址时,nacos如何发现ip的</a></li></ul></li><li><a href=#5-%e9%85%8d%e7%bd%ae%e4%b8%ad%e5%bf%83 aria-label="5. 配置中心">5. 配置中心</a><ul><li><a href=#51-%e5%8a%a8%e6%80%81%e9%85%8d%e7%bd%ae aria-label="5.1 动态配置">5.1 动态配置</a><ul><li><a href=#511-%e4%bd%bf%e7%94%a8 aria-label="5.1.1 使用">5.1.1 使用</a></li><li><a href=#512-%e5%8e%9f%e7%90%86%e8%af%a6%e8%a7%a3 aria-label="5.1.2 原理详解">5.1.2 原理详解</a><ul><li><a href=#5121-%e9%87%87%e7%94%a8%e5%bb%b6%e8%bf%9f%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%ae%9a%e6%97%b6%e6%89%a7%e8%a1%8c%e7%9b%91%e5%90%ac%e6%96%87%e4%bb%b6%e6%98%af%e5%90%a6%e6%9c%89%e4%bf%ae%e6%94%b9 aria-label="5.1.2.1 采用延迟线程池定时执行&amp;quot;监听&amp;quot;文件是否有修改">5.1.2.1 采用延迟线程池定时执行"监听"文件是否有修改</a></li><li><a href=#5122-%e9%80%9a%e8%bf%87%e9%95%bf%e8%bd%ae%e8%af%a2%e7%9a%84%e6%96%b9%e5%bc%8f%e8%8e%b7%e5%be%97%e4%bf%ae%e6%94%b9%e8%bf%87%e7%9a%84%e6%96%87%e4%bb%b6%e5%8f%8a%e5%85%b6%e5%86%85%e5%ae%b9 aria-label="5.1.2.2 通过长轮询的方式获得修改过的文件及其内容">5.1.2.2 通过长轮询的方式获得修改过的文件及其内容</a></li><li><a href=#5123-%e6%8b%bf%e5%88%b0%e9%85%8d%e7%bd%ae%e5%90%8e%e9%80%9a%e8%bf%87applicationcontext%e6%9b%b4%e6%96%b0%e5%88%b0%e9%a1%b9%e7%9b%ae%e5%86%85%e5%ad%98%e4%b8%ad aria-label="5.1.2.3 拿到配置后通过applicationContext更新到项目内存中">5.1.2.3 拿到配置后通过applicationContext更新到项目内存中</a></li></ul></li><li><a href=#513-%e6%80%bb%e7%bb%93 aria-label="5.1.3 总结">5.1.3 总结</a></li></ul></li></ul></li><li><a href=#aq aria-label=A&amp;amp;Q>A&amp;Q</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h1><p>阿里开源的注册中心和配置中心</p><p><img loading=lazy src=https://nacos.io/img/nacosMap.jpg alt=nacos_map></p><p><a href=https://nacos.io/zh-cn/docs/what-is-nacos.html target=_blank rel=noopener>Nacos 官方文档</a></p><p><a href=https://github.com/alibaba/nacos target=_blank rel=noopener>Nacos 源码</a></p><h1 id=1-概念>1. 概念<a hidden class=anchor aria-hidden=true href=#1-概念>#</a></h1><p><strong>Name Space</strong></p><p>用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。Namespace 的常用场景之一是<strong>不同环境的配置</strong>的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。</p><p><strong>Configuration</strong></p><p>配置文件</p><p><strong>Data ID</strong></p><p>Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。</p><p><strong>Group</strong></p><p>Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</p><p><strong>Virtual Cluster</strong></p><p>同一个服务下的所有服务实例组成一个默认集群, 集群可以被进一步按需求划分，划分的单位可以是虚拟集群。</p><blockquote><p>如图: <img src=https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos服务集群.png alt=image-20220124164513719 style=zoom:50%></p></blockquote><p><img loading=lazy src=https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561217857314-95ab332c-acfb-40b2-957a-aae26c2b5d71.jpeg alt=nacos_data_model></p><p><a href=https://nacos.io/zh-cn/docs/concepts.html target=_blank rel=noopener>Nacos 概念</a></p><h1 id=2-架构>2. 架构<a hidden class=anchor aria-hidden=true href=#2-架构>#</a></h1><p><img loading=lazy src=https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561217892717-1418fb9b-7faa-4324-87b9-f1740329f564.jpeg alt=nacos_arch.jpg></p><p><img loading=lazy src=https://cdn.nlark.com/yuque/0/2019/png/338441/1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png alt=nacos-logic.jpg></p><h1 id=3-安装>3. 安装<a hidden class=anchor aria-hidden=true href=#3-安装>#</a></h1><p>Nacos Server下载地址：</p><p><a href=https://github.com/alibaba/nacos/releases target=_blank rel=noopener>https://github.com/alibaba/nacos/releases</a></p><p>下载解压后打开bin目录</p><p><code>/work/nacos/bin/startup.sh -m standalone</code></p><blockquote><p>windows: <code>startup.cmd -m standalone</code></p></blockquote><p>启动完后访问后台</p><p>Nacos Server的后台访问地址：</p><p>http://192.168.10.13:8848/nacos/index.html</p><p>默认账号和密码为：<code>nacos/nacos</code></p><p><img loading=lazy src=https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos%e5%90%af%e5%8a%a8%e6%97%a5%e5%bf%97.png alt=image-20220109225601199></p><h2 id=31-nacos-server-有两种运行模式>3.1 Nacos Server 有两种运行模式：<a hidden class=anchor aria-hidden=true href=#31-nacos-server-有两种运行模式>#</a></h2><ul><li>standalone</li><li>cluster (默认模式)</li></ul><h3 id=311-standalone-模式>3.1.1 standalone 模式<a hidden class=anchor aria-hidden=true href=#311-standalone-模式>#</a></h3><p>此模式一般用于 demo 和测试，不用改任何配置，直接敲以下命令执行</p><h3 id=312-cluster-模式>3.1.2 cluster 模式<a hidden class=anchor aria-hidden=true href=#312-cluster-模式>#</a></h3><p>cluster 模式需要依赖 MySQL，然后改两个配置文件：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>conf/cluster.conf
</span></span><span style=display:flex><span>conf/application.properties
</span></span></code></pre></div><p><strong><code>conf/cluster.conf</code></strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#8b949e;font-style:italic># 集群节点(此处是在同一台机器上,所以用ip区分)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#a5d6ff>192.168.10.13</span><span style=color:#f85149>:</span><span style=color:#79c0ff>8841</span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>192.168.10.13</span><span style=color:#f85149>:</span><span style=color:#79c0ff>8845</span>
</span></span><span style=display:flex><span><span style=color:#a5d6ff>192.168.10.13</span><span style=color:#f85149>:</span><span style=color:#79c0ff>8848</span>
</span></span></code></pre></div><p><strong><code>conf/application.properties</code></strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span>spring.datasource.platform<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>mysql</span>
</span></span><span style=display:flex><span>db.num<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>db.url.0<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC&amp;AllowPublicKeyRetrieval=True</span>
</span></span><span style=display:flex><span>db.user.0<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>test</span>
</span></span><span style=display:flex><span>db.password.0<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>xiaokunji</span>
</span></span></code></pre></div><blockquote><p>每个节点上需要改这两个文件</p><p>注意在application.properties文件中修改端口</p></blockquote><p>启动后 任意节点都能进入管理界面</p><p><img loading=lazy src=https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos%e6%8e%a7%e5%88%b6%e5%8f%b0-%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86.png alt=image-20220110000124372></p><p><a href=https://developer.aliyun.com/article/738219 target=_blank rel=noopener>阿里巴巴NACOS（3）- 部署Nacos的生产集群环境-阿里云开发者社区 (aliyun.com)</a></p><blockquote><p>一般集群部署需要搭配NGINX, 这样就可以统一管理对外ip, 且需要利用NGINX的故障转移策略, nacos本身不具备故障转移</p></blockquote><p><a href=https://www.cnblogs.com/FlyAway2013/p/11201250.html target=_blank rel=noopener>Nacos 集群部署 - CanntBelieve - 博客园 (cnblogs.com)</a></p><h1 id=4-注册中心>4. 注册中心<a hidden class=anchor aria-hidden=true href=#4-注册中心>#</a></h1><p><strong>参数解释</strong></p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td><code>com.alibaba.nacos.naming.log.level</code></td><td>Naming客户端的日志级别，改属性通过客户端启动时通过命令行加参数指定 注：默认为info</td></tr><tr><td>spring.cloud.nacos.discovery.heart-beat-interval</td><td>nacos客户端向服务端发送心跳的时间间隔，默认5s<br>注：客户端向服务端每隔5s向服务端发送心跳请求，进行服务续租，告诉服务端该实例IP健康。若在3次心跳的间隔时间(默认15s)内服务端没有接受到该实例的心跳请求，则认为该实例不健康，该实例将无法被消费。如果再次经历3次心跳的间隔时间，服务端接受到该实例的请求，那么会立刻将其设置外健康，并可以被消费，若未接受到，则删除该实例的注册信息。推荐配置为5s，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值。</td></tr><tr><td>spring.cloud.nacos.discovery.heart-beat-timeout:</td><td>服务端没有接受到客户端心跳请求就将其设为不健康的时间间隔，默认为15s. 注：推荐值该值为15s即可，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可以适当减少该值。</td></tr><tr><td>spring.cloud.nacos.discovery.log-name:</td><td>nacos客户端会在启动时打印一部分发送注册请求信息和异常日志，可以通过日志查看注册的nacos集群地址、服务名、nameSpace、IP、元数据等内容，文件名默认为naming.log . 注:推荐将该日志的位置设置为和其他日志在一个文件夹下</td></tr><tr><td>spring.cloud.nacos.discovery.metadata:</td><td>给服务添加一些标签，例如属于什么业务线，该元数据会持久化存储在服务端，但是客户端消费时不会获取到此值，默认为空. 注:推荐为空，我们可以通过已经注册的服务名来找到具体的业务线，无需添加metadata</td></tr><tr><td>spring.cloud.nacos.discovery.namespace:</td><td>命名空间ID，Nacos通过不同的命名空间来区分不同的环境，进行数据隔离，服务消费时只能消费到对应命名空间下的服务。</td></tr><tr><td>spring.cloud.nacos.discovery.naming-load-cache-at-start:</td><td>默认为false。客户端在启动时是否读取本地配置项(一个文件)来获取服务列表. 注：推荐该值为false，若改成true。则客户端会在本地的一个文件中保存服务信息，当下次宕机启动时，会优先读取本地的配置对外提供服务。</td></tr><tr><td>spring.cloud.nacos.discovery.port:</td><td>向nacos注册服务时，服务对应的端口号 . 注:无需修改，默认为应用对外提供服务的端口号,server.port</td></tr><tr><td>spring.cloud.nacos.discovery.register-enabled:</td><td>该项目是否向注册中心注册服务，默认为true . 注：如果服务从注册中心只消费服务，没有对外提供服务，那么该值可设置为false，可减少客户端线程池的创建，无需向服务端发送心跳请求，提高性能。</td></tr><tr><td>spring.cloud.nacos.discovery.server-addr</td><td>nacos集群地址。注：多个IP可以通过“，”号隔离，例如<code>192.168.80.1:8848,192.168.80.1:8848</code> 填写域名时前缀不要加上http://</td></tr><tr><td>spring.cloud.nacos.discovery.service:</td><td>项目向注册中心注册服务时的服务名，默认为spring.application.name 变量 . 注:该服务名必须使用小写，因为nacos服务名区分大小写，如果服务名不完全匹配，那么无法调用服务</td></tr><tr><td>spring.cloud.nacos.discovery.watch-delay:</td><td>默认为30s。客户端在启动时会创建一个线程池，该线程定期去查询服务端的信息列表，该请求不会立刻返回，默认等待30s，若在30s内，服务端信息列表发生变化，则该请求立刻返回，通知客户端拉取服务端的服务信息列表，若30s内，没有变化，则30s时该请求返回响应，客户端服务列表不变，再次发生该请求。 注：推荐该值为30s即可，无需修改</td></tr><tr><td>spring.cloud.nacos.discovery.watch.enabled:</td><td>默认为true,客户端在启动时会创建一个线程池，该线程定期去查询服务端的信息列表，该请求不会立刻返回，默认等待30s，若在30s内，服务端信息列表发生变化，则该请求立刻返回，通知客户端拉取服务端的服务信息列表，若30s内，没有变化，则30s时该请求返回响应，客户端服务列表不变，再次发生该请求。 注:推荐该功能为true，这是nacos类似长连接推送服务变化的功能，不要关闭</td></tr><tr><td>spring.cloud.nacos.discovery.weight:</td><td>nacos支持服务端基于权重的负载均衡，该值默认为1 . 注:建议该值保持默认即可，因为代码可能会部署到不同的服务器上，无法确保某台服务器的配置一定较好，如果有需要修改该值的需求，可以上控制台修改，这样可以保证对应IP服务器的权重值较高</td></tr></tbody></table><blockquote><p><b style=color:red>watch-delay 有什么作用?</b></p></blockquote><h2 id=41-基本使用>4.1 基本使用<a hidden class=anchor aria-hidden=true href=#41-基本使用>#</a></h2><p>pom.xml</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>   <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&lt;version&gt;</span>2.2.1.RELEASE<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>使用配置文件如下:</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>   
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>cloud</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nacos</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        	</span>-- <span style=color:#a5d6ff>配置中心</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjNamespace</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>server-addr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>192.168.2.101</span>:<span style=color:#a5d6ff>8841</span>,<span style=color:#a5d6ff>192.168.2.101</span>:<span style=color:#a5d6ff>8845</span>,<span style=color:#a5d6ff>192.168.2.101</span>:<span style=color:#a5d6ff>8848</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>group</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjGroup</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>-- <span style=color:#a5d6ff>注册中心</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>discovery</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>server-addr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>${spring.cloud.nacos.config.server-addr}</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>cluster-name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjCluster</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>-- <span style=color:#a5d6ff>此处是命名空间的id</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjNamespace</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>service</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>javaDemoDiscovery</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#7ee787>group</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjGroup</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>application</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>javaDemo</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id=42-在不写本机地址时nacos如何发现ip的>4.2 在不写本机地址时,nacos如何发现ip的<a hidden class=anchor aria-hidden=true href=#42-在不写本机地址时nacos如何发现ip的>#</a></h2><p>与 <code>Eureka</code>使用了同一个工具类, 有spring-cloud-common提供的 <code>InetUtils</code> 类, 因此两者获取ip是同样的原理,详见 [Eureka文章](<a href=https://github.com/xiaokunji/myNotes/blob/main/java target=_blank rel=noopener>https://github.com/xiaokunji/myNotes/blob/main/java</a>
及其框架/Spring Cloud/Eureka.md)</p><blockquote><p>简单来说就是遍历所有网卡, 去除一些回旋地址,忽略地址等规则取索引最小的, 默认返回本地地址</p></blockquote><h1 id=5-配置中心>5. 配置中心<a hidden class=anchor aria-hidden=true href=#5-配置中心>#</a></h1><p>在 Nacos Spring Cloud 中，dataId 的完整格式如下：</p><p><code>${prefix}-${spring.profile.active}.${file-extension}</code></p><blockquote><ul><li>prefix 默认为所属工程配置spring.application.name 的值（即：nacos-provider），也可以通过配置项 spring.cloud.nacos.config.prefix来配置；</li><li>spring.profile.active 即为当前环境对应的 profile，详情可以参考 Spring Boot文档。 注意：当spring.profile.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension}</li><li>file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类型；默认为 properties ；</li></ul></blockquote><p><a href=https://blog.csdn.net/cristianoxm/article/details/113639172 target=_blank rel=noopener>Nacos 入门教程_cristianoxm的博客-CSDN博客_nacos 教程</a></p><p>pom.xml</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>        <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&lt;version&gt;</span>2.2.1.RELEASE<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>配置文件:</p><blockquote><p>新增bootstrap.yml文件，配置信息写在该文件里。（问题：如放在application.yml会导致项目启动报找不到配置属性错误，原因：application.yml与bootstrap.yml加载顺序优先级问题。）</p></blockquote><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>application</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>javaDemo</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>cloud</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>nacos</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>server-addr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>${spring.cloud.client.ip-address}:8848</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>config</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjNamespace</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>file-extension</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>yml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>shared-configs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#7ee787>data-id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mysqlTest.yml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>refresh</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>true</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>group</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjGroup</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>extension-configs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#7ee787>data-id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>MyTest.yml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>refresh</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>true</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>group</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjGroup</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>group</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>xkjGroup</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># 该配置如果放在share和extentsion配置的前面,将覆盖其下的组</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>java使用类:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Value</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;${my.name:本地值name}&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String name<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Value</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;${person.name:本地值person.name}&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String person_name<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Value</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;${personAge:本地值personAge}&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String personAge<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Value</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;${personName:本地值personName}&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String personName<span style=color:#ff7b72;font-weight:700>;</span>
</span></span></code></pre></div><p><img loading=lazy src=https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos-%e9%85%8d%e7%bd%ae%e4%b8%ad%e5%bf%83-%e4%bd%bf%e7%94%a8.png alt=image-20220306005109148></p><h2 id=51-动态配置>5.1 动态配置<a hidden class=anchor aria-hidden=true href=#51-动态配置>#</a></h2><h3 id=511-使用>5.1.1 使用<a hidden class=anchor aria-hidden=true href=#511-使用>#</a></h3><p>通常获取配置文件的方式</p><ol><li><p><code>@Value</code></p></li><li><p><code>@ConfigurationProperties(Prefix)</code></p></li></ol><p>如果是在运行时要动态更新的话，</p><p>第一种方式要在bean上加<code>@RefreshScope</code></p><p>第二种方式是自动支持的。</p><h3 id=512-原理详解>5.1.2 原理详解<a hidden class=anchor aria-hidden=true href=#512-原理详解>#</a></h3><p><img loading=lazy src=https://gitee.com/xiaokunji/my-images/raw/master/myMD/nacos%e5%8a%a8%e6%80%81%e9%85%8d%e7%bd%ae%e6%97%a5%e5%bf%97.png alt=image-20220308002516886></p><h4 id=5121-采用延迟线程池定时执行监听文件是否有修改>5.1.2.1 采用延迟线程池定时执行"监听"文件是否有修改<a hidden class=anchor aria-hidden=true href=#5121-采用延迟线程池定时执行监听文件是否有修改>#</a></h4><p>服务启动后就回轮询的打印图上信息, 当有配置被改动时, 这个<code>[]</code> 就会包含数据了, 可想而知这是监听日志了, 那就找到这段代码</p><p><strong><code>ClientWorker.java</code></strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>LongPollingRunnable</span> <span style=color:#ff7b72>implements</span> Runnable <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>int</span> taskId<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#d2a8ff;font-weight:700>LongPollingRunnable</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span> taskId<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>taskId <span style=color:#ff7b72;font-weight:700>=</span> taskId<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>run</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            List<span style=color:#ff7b72;font-weight:700>&lt;</span>CacheData<span style=color:#ff7b72;font-weight:700>&gt;</span> cacheDatas <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ArrayList<span style=color:#ff7b72;font-weight:700>&lt;</span>CacheData<span style=color:#ff7b72;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>            List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> inInitializingCacheList <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ArrayList<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// check failover config
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>CacheData cacheData <span style=color:#ff7b72;font-weight:700>:</span> cacheMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>values<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>getTaskId<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>==</span> taskId<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        cacheDatas<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            checkLocalConfig<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>isUseLocalConfigInfo<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                                cacheData<span style=color:#ff7b72;font-weight:700>.</span>checkListenerMd5<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Exception e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;get local config info error&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// check server config
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> changedGroupKeys <span style=color:#ff7b72;font-weight:700>=</span> checkUpdateDataIds<span style=color:#ff7b72;font-weight:700>(</span>cacheDatas<span style=color:#ff7b72;font-weight:700>,</span> inInitializingCacheList<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;get changedGroupKeys:&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> changedGroupKeys<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>//              省略剩下代码  .....
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>从这里就能看出, 先是对配置做了一些检查, 然后就打印结果, 而且这个是在run方法里, 说明这里肯定是开了线程在跑的, 找到调用<code>LongPollingRunnable</code>这个类的地方</p><p>还是在同一个类中, 发现是在execute中执行的, 那就是弄了一个线程池, 而且这里是在for循环里, 看一下任务, 就会联想到多个配置文件的情况, 同时监听的</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>checkConfigInfo</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 分任务
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>int</span> listenerSize <span style=color:#ff7b72;font-weight:700>=</span> cacheMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>size<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 向上取整为批数
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>int</span> longingTaskCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span><span style=color:#ff7b72;font-weight:700>)</span> Math<span style=color:#ff7b72;font-weight:700>.</span>ceil<span style=color:#ff7b72;font-weight:700>(</span>listenerSize <span style=color:#ff7b72;font-weight:700>/</span> ParamUtil<span style=color:#ff7b72;font-weight:700>.</span>getPerTaskConfigSize<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>longingTaskCount <span style=color:#ff7b72;font-weight:700>&gt;</span> currentLongingTaskCount<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span> i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>int</span><span style=color:#ff7b72;font-weight:700>)</span> currentLongingTaskCount<span style=color:#ff7b72;font-weight:700>;</span> i <span style=color:#ff7b72;font-weight:700>&lt;</span> longingTaskCount<span style=color:#ff7b72;font-weight:700>;</span> i<span style=color:#ff7b72;font-weight:700>++)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 要判断任务是否在执行 这块需要好好想想。 任务列表现在是无序的。变化过程可能有问题
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                executorService<span style=color:#ff7b72;font-weight:700>.</span>execute<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>new</span> LongPollingRunnable<span style=color:#ff7b72;font-weight:700>(</span>i<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            currentLongingTaskCount <span style=color:#ff7b72;font-weight:700>=</span> longingTaskCount<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>看一下这个线程池的参数.</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@SuppressWarnings</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;PMD.ThreadPoolCreationRule&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#d2a8ff;font-weight:700>ClientWorker</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>final</span> HttpAgent agent<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> ConfigFilterChainManager configFilterChainManager<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> Properties properties<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>agent <span style=color:#ff7b72;font-weight:700>=</span> agent<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>configFilterChainManager <span style=color:#ff7b72;font-weight:700>=</span> configFilterChainManager<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// Initialize the timeout parameter
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        init<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        executor <span style=color:#ff7b72;font-weight:700>=</span> Executors<span style=color:#ff7b72;font-weight:700>.</span>newScheduledThreadPool<span style=color:#ff7b72;font-weight:700>(</span>1<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>new</span> ThreadFactory<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>public</span> Thread <span style=color:#d2a8ff;font-weight:700>newThread</span><span style=color:#ff7b72;font-weight:700>(</span>Runnable r<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                Thread t <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Thread<span style=color:#ff7b72;font-weight:700>(</span>r<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                t<span style=color:#ff7b72;font-weight:700>.</span>setName<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;com.alibaba.nacos.client.Worker.&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                t<span style=color:#ff7b72;font-weight:700>.</span>setDaemon<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> t<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>});</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 执行的线程池
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        executorService <span style=color:#ff7b72;font-weight:700>=</span> Executors<span style=color:#ff7b72;font-weight:700>.</span>newScheduledThreadPool<span style=color:#ff7b72;font-weight:700>(</span>Runtime<span style=color:#ff7b72;font-weight:700>.</span>getRuntime<span style=color:#ff7b72;font-weight:700>().</span>availableProcessors<span style=color:#ff7b72;font-weight:700>(),</span> <span style=color:#ff7b72>new</span> ThreadFactory<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>public</span> Thread <span style=color:#d2a8ff;font-weight:700>newThread</span><span style=color:#ff7b72;font-weight:700>(</span>Runnable r<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                Thread t <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Thread<span style=color:#ff7b72;font-weight:700>(</span>r<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                t<span style=color:#ff7b72;font-weight:700>.</span>setName<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;com.alibaba.nacos.client.Worker.longPolling.&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                t<span style=color:#ff7b72;font-weight:700>.</span>setDaemon<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> t<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        executor<span style=color:#ff7b72;font-weight:700>.</span>scheduleWithFixedDelay<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>new</span> Runnable<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>run</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    checkConfigInfo<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Throwable e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;] [sub-check] rotate check error&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>},</span> 1L<span style=color:#ff7b72;font-weight:700>,</span> 10L<span style=color:#ff7b72;font-weight:700>,</span> TimeUnit<span style=color:#ff7b72;font-weight:700>.</span>MILLISECONDS<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>还会发现这里还有个延迟线程池,而且只有一个线程数, 发现里面执行了<code>checkConfigInfo()</code>, 这刚好<code>LongPollingRunnable</code> 类执行的所在方法.</p><p>至此, 它的定时执行就清楚了, <strong>它开了一个单线程的延时线程池,每隔10ms执行一次, 线程里再用线程池去"监听"文件是否有修改</strong></p><p>但是我们发现日志间隔并不是10ms,而且这个间隔也太小了, 肯定不合理</p><h4 id=5122-通过长轮询的方式获得修改过的文件及其内容>5.1.2.2 通过长轮询的方式获得修改过的文件及其内容<a hidden class=anchor aria-hidden=true href=#5122-通过长轮询的方式获得修改过的文件及其内容>#</a></h4><p>去看一下它是如何"监听", 跟进<code>com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateDataIds</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 从Server获取值变化了的DataID列表。返回的对象里只有dataId和group是有效的。 保证不返回NULL。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>checkUpdateDataIds</span><span style=color:#ff7b72;font-weight:700>(</span>List<span style=color:#ff7b72;font-weight:700>&lt;</span>CacheData<span style=color:#ff7b72;font-weight:700>&gt;</span> cacheDatas<span style=color:#ff7b72;font-weight:700>,</span> List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> inInitializingCacheList<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throws</span> IOException <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 构造参数- 通过配置dataId/group/tenant等数据来指定文件
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        StringBuilder sb <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> StringBuilder<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>CacheData cacheData <span style=color:#ff7b72;font-weight:700>:</span> cacheDatas<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>isUseLocalConfigInfo<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                sb<span style=color:#ff7b72;font-weight:700>.</span>append<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>dataId<span style=color:#ff7b72;font-weight:700>).</span>append<span style=color:#ff7b72;font-weight:700>(</span>WORD_SEPARATOR<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                sb<span style=color:#ff7b72;font-weight:700>.</span>append<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>group<span style=color:#ff7b72;font-weight:700>).</span>append<span style=color:#ff7b72;font-weight:700>(</span>WORD_SEPARATOR<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isBlank<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>tenant<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    sb<span style=color:#ff7b72;font-weight:700>.</span>append<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>getMd5<span style=color:#ff7b72;font-weight:700>()).</span>append<span style=color:#ff7b72;font-weight:700>(</span>LINE_SEPARATOR<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    sb<span style=color:#ff7b72;font-weight:700>.</span>append<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>getMd5<span style=color:#ff7b72;font-weight:700>()).</span>append<span style=color:#ff7b72;font-weight:700>(</span>WORD_SEPARATOR<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    sb<span style=color:#ff7b72;font-weight:700>.</span>append<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>getTenant<span style=color:#ff7b72;font-weight:700>()).</span>append<span style=color:#ff7b72;font-weight:700>(</span>LINE_SEPARATOR<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>isInitializing<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// cacheData 首次出现在cacheMap中&amp;首次check更新
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    inInitializingCacheList
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span>GroupKey<span style=color:#ff7b72;font-weight:700>.</span>getKeyTenant<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> cacheData<span style=color:#ff7b72;font-weight:700>.</span>group<span style=color:#ff7b72;font-weight:700>,</span> cacheData<span style=color:#ff7b72;font-weight:700>.</span>tenant<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>boolean</span> isInitializingCacheList <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>!</span>inInitializingCacheList<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 核心方法- 检查更新文件
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> checkUpdateConfigStr<span style=color:#ff7b72;font-weight:700>(</span>sb<span style=color:#ff7b72;font-weight:700>.</span>toString<span style=color:#ff7b72;font-weight:700>(),</span> isInitializingCacheList<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><code>com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateConfigStr</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 从Server获取值变化了的DataID列表。返回的对象里只有dataId和group是有效的。 保证不返回NULL。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>checkUpdateConfigStr</span><span style=color:#ff7b72;font-weight:700>(</span>String probeUpdateString<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>boolean</span> isInitializingCacheList<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throws</span> IOException <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> params <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ArrayList<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;(</span>2<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        params<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span>Constants<span style=color:#ff7b72;font-weight:700>.</span>PROBE_MODIFY_REQUEST<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        params<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span>probeUpdateString<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> headers <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ArrayList<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;(</span>2<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        headers<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;Long-Pulling-Timeout&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 设置长轮询的过期时间
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        headers<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> timeout<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// told server do not hang me up if new initializing cacheData added in
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>isInitializingCacheList<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            headers<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;Long-Pulling-Timeout-No-Hangup&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            headers<span style=color:#ff7b72;font-weight:700>.</span>add<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;true&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isBlank<span style=color:#ff7b72;font-weight:700>(</span>probeUpdateString<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> Collections<span style=color:#ff7b72;font-weight:700>.</span>emptyList<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// In order to prevent the server from handling the delay of the client&#39;s long task,
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#8b949e;font-style:italic>// increase the client&#39;s read timeout to avoid this problem.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>long</span> readTimeoutMs <span style=color:#ff7b72;font-weight:700>=</span> timeout <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>long</span><span style=color:#ff7b72;font-weight:700>)</span> Math<span style=color:#ff7b72;font-weight:700>.</span>round<span style=color:#ff7b72;font-weight:700>(</span>timeout <span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> 1<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 长轮询请求
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            HttpResult result <span style=color:#ff7b72;font-weight:700>=</span> agent<span style=color:#ff7b72;font-weight:700>.</span>httpPost<span style=color:#ff7b72;font-weight:700>(</span>Constants<span style=color:#ff7b72;font-weight:700>.</span>CONFIG_CONTROLLER_PATH <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;/listener&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> headers<span style=color:#ff7b72;font-weight:700>,</span> params<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                agent<span style=color:#ff7b72;font-weight:700>.</span>getEncode<span style=color:#ff7b72;font-weight:700>(),</span> readTimeoutMs<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>HttpURLConnection<span style=color:#ff7b72;font-weight:700>.</span>HTTP_OK <span style=color:#ff7b72;font-weight:700>==</span> result<span style=color:#ff7b72;font-weight:700>.</span>code<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                setHealthServer<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 解析返参
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>return</span> parseUpdateDataIdResponse<span style=color:#ff7b72;font-weight:700>(</span>result<span style=color:#ff7b72;font-weight:700>.</span>content<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                setHealthServer<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [check-update] get changed dataId error, code: {}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span> result<span style=color:#ff7b72;font-weight:700>.</span>code<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>IOException e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            setHealthServer<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;] [check-update] get changed dataId exception&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> e<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> Collections<span style=color:#ff7b72;font-weight:700>.</span>emptyList<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>就会发现它是发了一个请求过去, 然后通过<code>parseUpdateDataIdResponse(result.content)</code> 方法解析出返参里面的 dataId/group/tenant等数据</p><p>这个请求中设置了一些长轮询的参数,表示这是一个长轮询的请求</p><blockquote><p><strong>长轮询:</strong> 客户端发起Long Polling，此时如果服务端没有相关数据，会hold住请求，直到服务端有相关数据，或者等待一定时间超时才会返回。返回后，客户端又会立即再次发起下一次Long Polling。</p></blockquote><p>这里只是拿到了一个dataId和group等数据,那什么时候拿到具体的配置信息呢? 继续往下看 <code>LongPollingRunnable#run</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 检查更新的dataId
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> changedGroupKeys <span style=color:#ff7b72;font-weight:700>=</span> checkUpdateDataIds<span style=color:#ff7b72;font-weight:700>(</span>cacheDatas<span style=color:#ff7b72;font-weight:700>,</span> inInitializingCacheList<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;get changedGroupKeys:&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> changedGroupKeys<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#8b949e;font-style:italic>// 遍历这些文件
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>String groupKey <span style=color:#ff7b72;font-weight:700>:</span> changedGroupKeys<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    String<span style=color:#ff7b72;font-weight:700>[]</span> key <span style=color:#ff7b72;font-weight:700>=</span> GroupKey<span style=color:#ff7b72;font-weight:700>.</span>parseKey<span style=color:#ff7b72;font-weight:700>(</span>groupKey<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    String dataId <span style=color:#ff7b72;font-weight:700>=</span> key<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>                    String group <span style=color:#ff7b72;font-weight:700>=</span> key<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>                    String tenant <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>.</span>length <span style=color:#ff7b72;font-weight:700>==</span> 3<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        tenant <span style=color:#ff7b72;font-weight:700>=</span> key<span style=color:#ff7b72;font-weight:700>[</span>2<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic>// 获得具体配置
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                        String<span style=color:#ff7b72;font-weight:700>[]</span> ct <span style=color:#ff7b72;font-weight:700>=</span> getServerConfig<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>,</span> 3000L<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        CacheData cache <span style=color:#ff7b72;font-weight:700>=</span> cacheMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>get<span style=color:#ff7b72;font-weight:700>(</span>GroupKey<span style=color:#ff7b72;font-weight:700>.</span>getKeyTenant<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic>// 把内容直接写到cacheMap中
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                        cache<span style=color:#ff7b72;font-weight:700>.</span>setContent<span style=color:#ff7b72;font-weight:700>(</span>ct<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>!=</span> ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>])</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            cache<span style=color:#ff7b72;font-weight:700>.</span>setType<span style=color:#ff7b72;font-weight:700>(</span>ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                        LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>,</span> cache<span style=color:#ff7b72;font-weight:700>.</span>getMd5<span style=color:#ff7b72;font-weight:700>(),</span>
</span></span><span style=display:flex><span>                            ContentUtils<span style=color:#ff7b72;font-weight:700>.</span>truncateContent<span style=color:#ff7b72;font-weight:700>(</span>ct<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]),</span> ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>NacosException ioe<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        String message <span style=color:#ff7b72;font-weight:700>=</span> String<span style=color:#ff7b72;font-weight:700>.</span>format<span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>                            <span style=color:#a5d6ff>&#34;[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span>message<span style=color:#ff7b72;font-weight:700>,</span> ioe<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>CacheData cacheData <span style=color:#ff7b72;font-weight:700>:</span> cacheDatas<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>isInitializing<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>||</span> inInitializingCacheList
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>.</span>contains<span style=color:#ff7b72;font-weight:700>(</span>GroupKey<span style=color:#ff7b72;font-weight:700>.</span>getKeyTenant<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> cacheData<span style=color:#ff7b72;font-weight:700>.</span>group<span style=color:#ff7b72;font-weight:700>,</span> cacheData<span style=color:#ff7b72;font-weight:700>.</span>tenant<span style=color:#ff7b72;font-weight:700>)))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic>// 检查md5
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                        cacheData<span style=color:#ff7b72;font-weight:700>.</span>checkListenerMd5<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                        cacheData<span style=color:#ff7b72;font-weight:700>.</span>setInitializing<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ....省略剩下代码
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><code>com.alibaba.nacos.client.config.impl.ClientWorker#getServerConfig</code> 获得具体配置的方法</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#ff7b72>public</span> String<span style=color:#ff7b72;font-weight:700>[]</span> <span style=color:#d2a8ff;font-weight:700>getServerConfig</span><span style=color:#ff7b72;font-weight:700>(</span>String dataId<span style=color:#ff7b72;font-weight:700>,</span> String group<span style=color:#ff7b72;font-weight:700>,</span> String tenant<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>long</span> readTimeout<span style=color:#ff7b72;font-weight:700>)</span>  <span style=color:#ff7b72>throws</span> NacosException <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String<span style=color:#ff7b72;font-weight:700>[]</span> ct <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> String<span style=color:#ff7b72;font-weight:700>[</span>2<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isBlank<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            group <span style=color:#ff7b72;font-weight:700>=</span> Constants<span style=color:#ff7b72;font-weight:700>.</span>DEFAULT_GROUP<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HttpResult result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            List<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> params <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isBlank<span style=color:#ff7b72;font-weight:700>(</span>tenant<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                params <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ArrayList<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;(</span>Arrays<span style=color:#ff7b72;font-weight:700>.</span>asList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dataId&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;group&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                params <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ArrayList<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;(</span>Arrays<span style=color:#ff7b72;font-weight:700>.</span>asList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dataId&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;group&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;tenant&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 通过get请求,获得具体配置
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            result <span style=color:#ff7b72;font-weight:700>=</span> agent<span style=color:#ff7b72;font-weight:700>.</span>httpGet<span style=color:#ff7b72;font-weight:700>(</span>Constants<span style=color:#ff7b72;font-weight:700>.</span>CONFIG_CONTROLLER_PATH<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>,</span> params<span style=color:#ff7b72;font-weight:700>,</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getEncode<span style=color:#ff7b72;font-weight:700>(),</span> readTimeout<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>IOException e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            String message <span style=color:#ff7b72;font-weight:700>=</span> String<span style=color:#ff7b72;font-weight:700>.</span>format<span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;[%s] [sub-server] get server config exception, dataId=%s, group=%s, tenant=%s&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span>
</span></span><span style=display:flex><span>                dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span>message<span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> NacosException<span style=color:#ff7b72;font-weight:700>(</span>NacosException<span style=color:#ff7b72;font-weight:700>.</span>SERVER_ERROR<span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>switch</span> <span style=color:#ff7b72;font-weight:700>(</span>result<span style=color:#ff7b72;font-weight:700>.</span>code<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>case</span> HttpURLConnection<span style=color:#ff7b72;font-weight:700>.</span>HTTP_OK<span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 先放到本地文件中
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                LocalConfigInfoProcessor<span style=color:#ff7b72;font-weight:700>.</span>saveSnapshot<span style=color:#ff7b72;font-weight:700>(</span>agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>,</span> result<span style=color:#ff7b72;font-weight:700>.</span>content<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 将请求返参放入ct数组中
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                ct<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>=</span> result<span style=color:#ff7b72;font-weight:700>.</span>content<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>result<span style=color:#ff7b72;font-weight:700>.</span>headers<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>CONFIG_TYPE<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>=</span> result<span style=color:#ff7b72;font-weight:700>.</span>headers<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>CONFIG_TYPE<span style=color:#ff7b72;font-weight:700>).</span>get<span style=color:#ff7b72;font-weight:700>(</span>0<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]</span> <span style=color:#ff7b72;font-weight:700>=</span> ConfigType<span style=color:#ff7b72;font-weight:700>.</span>TEXT<span style=color:#ff7b72;font-weight:700>.</span>getType<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> ct<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>             <span style=color:#ff7b72>case</span> HttpURLConnection<span style=color:#ff7b72;font-weight:700>.</span>HTTP_NOT_FOUND<span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//  省略剩下代码......
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>至此, 清楚了它是如何拿到具体配置的了, <strong>它通过(一次post请求)长轮询的方式和服务端建立连接, 获得dataId/group等数据, 再通过这些参数发起get请求获得具体的配置文件内容,并写到本地缓存中使用</strong></p><h4 id=5123-拿到配置后通过applicationcontext更新到项目内存中>5.1.2.3 拿到配置后通过applicationContext更新到项目内存中<a hidden class=anchor aria-hidden=true href=#5123-拿到配置后通过applicationcontext更新到项目内存中>#</a></h4><p>它取到这些配置后,是如何写到项目的内存中并使其生效的呢?</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        String<span style=color:#ff7b72;font-weight:700>[]</span> ct <span style=color:#ff7b72;font-weight:700>=</span> getServerConfig<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>,</span> 3000L<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        CacheData cache <span style=color:#ff7b72;font-weight:700>=</span> cacheMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>get<span style=color:#ff7b72;font-weight:700>(</span>GroupKey<span style=color:#ff7b72;font-weight:700>.</span>getKeyTenant<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>                        cache<span style=color:#ff7b72;font-weight:700>.</span>setContent<span style=color:#ff7b72;font-weight:700>(</span>ct<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>!=</span> ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>])</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            cache<span style=color:#ff7b72;font-weight:700>.</span>setType<span style=color:#ff7b72;font-weight:700>(</span>ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                        LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>,</span> cache<span style=color:#ff7b72;font-weight:700>.</span>getMd5<span style=color:#ff7b72;font-weight:700>(),</span>
</span></span><span style=display:flex><span>                            ContentUtils<span style=color:#ff7b72;font-weight:700>.</span>truncateContent<span style=color:#ff7b72;font-weight:700>(</span>ct<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]),</span> ct<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>NacosException ioe<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        String message <span style=color:#ff7b72;font-weight:700>=</span> String<span style=color:#ff7b72;font-weight:700>.</span>format<span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>                            <span style=color:#a5d6ff>&#34;[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            agent<span style=color:#ff7b72;font-weight:700>.</span>getName<span style=color:#ff7b72;font-weight:700>(),</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> tenant<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span>message<span style=color:#ff7b72;font-weight:700>,</span> ioe<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>CacheData cacheData <span style=color:#ff7b72;font-weight:700>:</span> cacheDatas<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>isInitializing<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>||</span> inInitializingCacheList
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>.</span>contains<span style=color:#ff7b72;font-weight:700>(</span>GroupKey<span style=color:#ff7b72;font-weight:700>.</span>getKeyTenant<span style=color:#ff7b72;font-weight:700>(</span>cacheData<span style=color:#ff7b72;font-weight:700>.</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> cacheData<span style=color:#ff7b72;font-weight:700>.</span>group<span style=color:#ff7b72;font-weight:700>,</span> cacheData<span style=color:#ff7b72;font-weight:700>.</span>tenant<span style=color:#ff7b72;font-weight:700>)))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#8b949e;font-style:italic>// 检查md5
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                        cacheData<span style=color:#ff7b72;font-weight:700>.</span>checkListenerMd5<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                        cacheData<span style=color:#ff7b72;font-weight:700>.</span>setInitializing<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 省略剩下代码.....
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>在取到具体配置后,遍历cacheDatas数据,并检查md5, 跟进去看一下, 它开始出现监听器了</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>checkListenerMd5</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>ManagerListenerWrap wrap <span style=color:#ff7b72;font-weight:700>:</span> listeners<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>md5<span style=color:#ff7b72;font-weight:700>.</span>equals<span style=color:#ff7b72;font-weight:700>(</span>wrap<span style=color:#ff7b72;font-weight:700>.</span>lastCallMd5<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                safeNotifyListener<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> content<span style=color:#ff7b72;font-weight:700>,</span> type<span style=color:#ff7b72;font-weight:700>,</span> md5<span style=color:#ff7b72;font-weight:700>,</span> wrap<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>safeNotifyListener</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>final</span> String dataId<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> String group<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> String content<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> String type<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                    <span style=color:#ff7b72>final</span> String md5<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> ManagerListenerWrap listenerWrap<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>final</span> Listener listener <span style=color:#ff7b72;font-weight:700>=</span> listenerWrap<span style=color:#ff7b72;font-weight:700>.</span>listener<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Runnable job <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Runnable<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>run</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                ClassLoader myClassLoader <span style=color:#ff7b72;font-weight:700>=</span> Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>().</span>getContextClassLoader<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                ClassLoader appClassLoader <span style=color:#ff7b72;font-weight:700>=</span> listener<span style=color:#ff7b72;font-weight:700>.</span>getClass<span style=color:#ff7b72;font-weight:700>().</span>getClassLoader<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>listener <span style=color:#ff7b72>instanceof</span> AbstractSharedListener<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        AbstractSharedListener adapter <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>(</span>AbstractSharedListener<span style=color:#ff7b72;font-weight:700>)</span> listener<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                        adapter<span style=color:#ff7b72;font-weight:700>.</span>fillContext<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [notify-context] dataId={}, group={}, md5={}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> name<span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> md5<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// 执行回调之前先将线程classloader设置为具体webapp的classloader，以免回调方法中调用spi接口是出现异常或错用（多应用部署才会有该问题）。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>().</span>setContextClassLoader<span style=color:#ff7b72;font-weight:700>(</span>appClassLoader<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    ConfigResponse cr <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ConfigResponse<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                    cr<span style=color:#ff7b72;font-weight:700>.</span>setDataId<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    cr<span style=color:#ff7b72;font-weight:700>.</span>setGroup<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    cr<span style=color:#ff7b72;font-weight:700>.</span>setContent<span style=color:#ff7b72;font-weight:700>(</span>content<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    configFilterChainManager<span style=color:#ff7b72;font-weight:700>.</span>doFilter<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>,</span> cr<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    String contentTmp <span style=color:#ff7b72;font-weight:700>=</span> cr<span style=color:#ff7b72;font-weight:700>.</span>getContent<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// 处理配置信息
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    listener<span style=color:#ff7b72;font-weight:700>.</span>receiveConfigInfo<span style=color:#ff7b72;font-weight:700>(</span>contentTmp<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// compare lastContent and content
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>listener <span style=color:#ff7b72>instanceof</span> AbstractConfigChangeListener<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        Map data <span style=color:#ff7b72;font-weight:700>=</span> ConfigChangeHandler<span style=color:#ff7b72;font-weight:700>.</span>getInstance<span style=color:#ff7b72;font-weight:700>().</span>parseChangeData<span style=color:#ff7b72;font-weight:700>(</span>listenerWrap<span style=color:#ff7b72;font-weight:700>.</span>lastContent<span style=color:#ff7b72;font-weight:700>,</span> content<span style=color:#ff7b72;font-weight:700>,</span> type<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        ConfigChangeEvent event <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ConfigChangeEvent<span style=color:#ff7b72;font-weight:700>(</span>data<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff7b72;font-weight:700>((</span>AbstractConfigChangeListener<span style=color:#ff7b72;font-weight:700>)</span>listener<span style=color:#ff7b72;font-weight:700>).</span>receiveConfigChange<span style=color:#ff7b72;font-weight:700>(</span>event<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        listenerWrap<span style=color:#ff7b72;font-weight:700>.</span>lastContent <span style=color:#ff7b72;font-weight:700>=</span> content<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    listenerWrap<span style=color:#ff7b72;font-weight:700>.</span>lastCallMd5 <span style=color:#ff7b72;font-weight:700>=</span> md5<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [notify-ok] dataId={}, group={}, md5={}, listener={} &#34;</span><span style=color:#ff7b72;font-weight:700>,</span> name<span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> md5<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                        listener<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>NacosException de<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [notify-error] dataId={}, group={}, md5={}, listener={} errCode={} errMsg={}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> name<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                        dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> md5<span style=color:#ff7b72;font-weight:700>,</span> listener<span style=color:#ff7b72;font-weight:700>,</span> de<span style=color:#ff7b72;font-weight:700>.</span>getErrCode<span style=color:#ff7b72;font-weight:700>(),</span> de<span style=color:#ff7b72;font-weight:700>.</span>getErrMsg<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Throwable t<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [notify-error] dataId={}, group={}, md5={}, listener={} tx={}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> name<span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                        md5<span style=color:#ff7b72;font-weight:700>,</span> listener<span style=color:#ff7b72;font-weight:700>,</span> t<span style=color:#ff7b72;font-weight:700>.</span>getCause<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>finally</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    Thread<span style=color:#ff7b72;font-weight:700>.</span>currentThread<span style=color:#ff7b72;font-weight:700>().</span>setContextClassLoader<span style=color:#ff7b72;font-weight:700>(</span>myClassLoader<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>long</span> startNotify <span style=color:#ff7b72;font-weight:700>=</span> System<span style=color:#ff7b72;font-weight:700>.</span>currentTimeMillis<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>!=</span> listener<span style=color:#ff7b72;font-weight:700>.</span>getExecutor<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                listener<span style=color:#ff7b72;font-weight:700>.</span>getExecutor<span style=color:#ff7b72;font-weight:700>().</span>execute<span style=color:#ff7b72;font-weight:700>(</span>job<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                job<span style=color:#ff7b72;font-weight:700>.</span>run<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Throwable t<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            LOGGER<span style=color:#ff7b72;font-weight:700>.</span>error<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [notify-error] dataId={}, group={}, md5={}, listener={} throwable={}&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> name<span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                md5<span style=color:#ff7b72;font-weight:700>,</span> listener<span style=color:#ff7b72;font-weight:700>,</span> t<span style=color:#ff7b72;font-weight:700>.</span>getCause<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>long</span> finishNotify <span style=color:#ff7b72;font-weight:700>=</span> System<span style=color:#ff7b72;font-weight:700>.</span>currentTimeMillis<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        LOGGER<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;[{}] [notify-listener] time cost={}ms in ClientWorker, dataId={}, group={}, md5={}, listener={} &#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>            name<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72;font-weight:700>(</span>finishNotify <span style=color:#ff7b72;font-weight:700>-</span> startNotify<span style=color:#ff7b72;font-weight:700>),</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> md5<span style=color:#ff7b72;font-weight:700>,</span> listener<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>这么长的代码,核心就是处理了那个runable, 其中调用了<code>listener.receiveConfigInfo(contentTmp)</code> 方法处理的监听器,它是一个抽象类, 找到它的实现类</p><p><code>com.alibaba.cloud.nacos.refresh.NacosContextRefresher</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>registerNacosListener</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>final</span> String groupKey<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>final</span> String dataKey<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>		String key <span style=color:#ff7b72;font-weight:700>=</span> NacosPropertySourceRepository<span style=color:#ff7b72;font-weight:700>.</span>getMapKey<span style=color:#ff7b72;font-weight:700>(</span>dataKey<span style=color:#ff7b72;font-weight:700>,</span> groupKey<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>		Listener listener <span style=color:#ff7b72;font-weight:700>=</span> listenerMap<span style=color:#ff7b72;font-weight:700>.</span>computeIfAbsent<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>				lst <span style=color:#ff7b72;font-weight:700>-&gt;</span> <span style=color:#ff7b72>new</span> AbstractSharedListener<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>					<span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>innerReceive</span><span style=color:#ff7b72;font-weight:700>(</span>String dataId<span style=color:#ff7b72;font-weight:700>,</span> String group<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>							String configInfo<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>						refreshCountIncrement<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>						nacosRefreshHistory<span style=color:#ff7b72;font-weight:700>.</span>addRefreshRecord<span style=color:#ff7b72;font-weight:700>(</span>dataId<span style=color:#ff7b72;font-weight:700>,</span> group<span style=color:#ff7b72;font-weight:700>,</span> configInfo<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>						<span style=color:#8b949e;font-style:italic>// todo feature: support single refresh for listening
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                        <span style=color:#8b949e;font-style:italic>// 通过applicationContext的事件去更新配置
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>						applicationContext<span style=color:#ff7b72;font-weight:700>.</span>publishEvent<span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>								<span style=color:#ff7b72>new</span> RefreshEvent<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;Refresh Nacos config&#34;</span><span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>						<span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>log<span style=color:#ff7b72;font-weight:700>.</span>isDebugEnabled<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>							log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span>String<span style=color:#ff7b72;font-weight:700>.</span>format<span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>									<span style=color:#a5d6ff>&#34;Refresh Nacos config group=%s,dataId=%s,configInfo=%s&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>									group<span style=color:#ff7b72;font-weight:700>,</span> dataId<span style=color:#ff7b72;font-weight:700>,</span> configInfo<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>						<span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>					<span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#ff7b72;font-weight:700>});</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>			configService<span style=color:#ff7b72;font-weight:700>.</span>addListener<span style=color:#ff7b72;font-weight:700>(</span>dataKey<span style=color:#ff7b72;font-weight:700>,</span> groupKey<span style=color:#ff7b72;font-weight:700>,</span> listener<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>NacosException e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>			log<span style=color:#ff7b72;font-weight:700>.</span>warn<span style=color:#ff7b72;font-weight:700>(</span>String<span style=color:#ff7b72;font-weight:700>.</span>format<span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>					<span style=color:#a5d6ff>&#34;register fail for nacos listener ,dataId=[%s],group=[%s]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataKey<span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>					groupKey<span style=color:#ff7b72;font-weight:700>),</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>至此, 清楚了获得的配置是如何生效的, 它将获得发生修改过的文件, 如果md5不一样了, 则执行监听器,通过applicationContext 更新配置到项目内存中</p><blockquote><p>明明已经知道了哪些文件被修改了,为啥还有比对md5, 因为可能是没有修改具体内容,只是点了编辑并保存</p><p><span style=color:red>md5用的是java的digest和位移,md5可能存在冲突, 那怎么解决冲突问题的?</span></p></blockquote><h3 id=513-总结>5.1.3 总结<a hidden class=anchor aria-hidden=true href=#513-总结>#</a></h3><ul><li>1.Nacos 客户端会循环请求服务端变更的数据，并且超时时间设置为30s，当配置发生变化时，请求的响应会立即返回，否则会一直等到 29.5s+ 之后再返回响应</li><li>2.Nacos 客户端能够实时感知到服务端配置发生了变化。</li><li>3.实时感知是建立在客户端拉和服务端“推”的基础上，但是这里的服务端“推”需要打上引号，因为服务端和客户端直接本质上还是通过 http 进行数据通讯的，之所以有“推”的感觉，是因为服务端主动将变更后的数据通过 http 的 response 对象提前写入了。</li></ul><p><a href="https://www.jianshu.com/p/d3f66b1eb748?isappinstalled=0" target=_blank rel=noopener>Long Polling长轮询详解 - 简书 (jianshu.com)</a></p><p><a href=https://www.cnblogs.com/barry-blog/articles/14305358.html target=_blank rel=noopener>NACOS动态配置 - barryzhou - 博客园 (cnblogs.com)</a></p><p><a href=https://www.cnblogs.com/hankuikui/p/12084193.html target=_blank rel=noopener>spring boot 配置文件动态更新原理 以Nacos为例 - 二奎 - 博客园 (cnblogs.com)</a></p><p><a href=https://www.jianshu.com/p/38b5452c9fec target=_blank rel=noopener>Nacos 配置中心原理分析 -第一篇- 简书 (jianshu.com)</a></p><p><a href=https://www.jianshu.com/p/acb9b1093a54 target=_blank rel=noopener>Nacos 配置中心原理分析 -第二篇 - 简书 (jianshu.com)</a></p><h1 id=aq>A&amp;Q<a hidden class=anchor aria-hidden=true href=#aq>#</a></h1><ol><li><p>nacos集群架构?</p><p><strong>答</strong>: 和Eureka集群架构一样,他的数据是点对点的, 本身是主从结构,也就是说会产生过半选举,脑裂等知识点, 默认支持cap理论中的ap模式. 生产部署nacos集群时,推荐通过NGINX给nacos集群做负载均衡</p><p><a href=https://www.cnblogs.com/songfeifeine/p/14321014.html target=_blank rel=noopener>浅谈Nacos中的CAP - 包子卖完了嘛 - 博客园 (cnblogs.com)</a></p></li><li><p>nacos如何实现动态配置?</p><p>答: 使用长轮询机制,由客户端定时发起请求询问服务端是否有修改, 如果存在修改则通过applicationContext的publishEvent更新内存中的配置</p><blockquote><p>一次请求后将阻塞29.5s+, 才会发起下一次请求, 如果遇到服务端存在修改文件, 则会立即返回.</p><p>定时机制是开了一个延时线程池,其中只有一个线程,每隔10ms发起一次请求, 服务启动时该任务就执行了</p></blockquote></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/spring_cloud/>Spring_Cloud</a></li><li><a href=https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/>java及其框架</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%B7%AE%E5%BC%82/mysql%E4%B8%8Eoracle/><span class=title>« 上一页</span><br><span>MySQL与Oracle</span></a>
<a class=next href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/java/netty/><span class=title>下一页 »</span><br><span>Netty</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>米二</a>
All Rights Reserved</span>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container><span class="fa fa-user">用户数:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">访问数:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>