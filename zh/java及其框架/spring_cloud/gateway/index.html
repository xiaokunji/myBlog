<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Gateway | ç±³äºŒ</title><meta name=keywords content=" 1.ä»‹ç», 1.2**æœ¯è¯­**, 1.2**æµç¨‹:**, 2.ä½¿ç”¨, 2.1 è·¯ç”±, 2.2 æ–­è¨€å™¨,, å¾—åˆ°key, org.springframework.cloud.gateway.support.NameUtils.class,, putè¿›map,å­˜èµ·æ¥, org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator.class,, æ ¹æ®åå­—å–å€¼, org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator.class, 2.3 è¿‡æ»¤å™¨, 2.3.1 GlobalFilter, 2.3.2 GatewayFilter, 2.3.3 è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚,          - StripPrefix=1,          - PrefixPath=/jportal,          - RewritePath=/jpxkj/(?<segment>.*),/jportal/${segment}, 2.4 åŠ å…¥æ³¨å†Œä¸­å¿ƒ, å¢åŠ é…ç½®, 3. é™æµç®—æ³•, 1ã€è®¡æ•°å™¨ï¼ˆå›ºå®šçª—å£ï¼‰ç®—æ³•, 2ã€æ»‘åŠ¨çª—å£ç®—æ³•, 3ã€æ¼æ¡¶ç®—æ³•, 4ã€ä»¤ç‰Œæ¡¶ç®—æ³•"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/gateway/><link crossorigin=anonymous href=/myBlog/assets/css/stylesheet.a2492b1919558dad2b0783841b531329520921f957f354ded4c3fc4d21dcc77f.css integrity="sha256-okkrGRlVja0rB4OEG1MTKVIJIflX81Te1MP8TSHcx38=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/myBlog/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.github.io/myBlog/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.github.io/myBlog/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.github.io/myBlog/img/Q.gif><link rel=apple-touch-icon href=https://xiaokunji.github.io/myBlog/Q.gif><link rel=mask-icon href=https://xiaokunji.github.io/myBlog/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/gateway/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Gateway"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/gateway/"><meta property="article:section" content="javaåŠå…¶æ¡†æ¶"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gateway"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":3,"name":"Gateway","item":"https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/gateway/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Gateway","name":"Gateway","description":"     ","keywords":[" 1.ä»‹ç»"," 1.2**æœ¯è¯­**"," 1.2**æµç¨‹:**"," 2.ä½¿ç”¨"," 2.1 è·¯ç”±"," 2.2 æ–­è¨€å™¨",""," å¾—åˆ°key"," org.springframework.cloud.gateway.support.NameUtils.class",""," putè¿›map,å­˜èµ·æ¥"," org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator.class",""," æ ¹æ®åå­—å–å€¼"," org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator.class"," 2.3 è¿‡æ»¤å™¨"," 2.3.1 GlobalFilter"," 2.3.2 GatewayFilter"," 2.3.3 è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚","          - StripPrefix=1","          - PrefixPath=/jportal","          - RewritePath=/jpxkj/(?\u003csegment\u003e.*), /jportal/${segment}"," 2.4 åŠ å…¥æ³¨å†Œä¸­å¿ƒ"," å¢åŠ é…ç½®"," 3. é™æµç®—æ³•"," 1ã€è®¡æ•°å™¨ï¼ˆå›ºå®šçª—å£ï¼‰ç®—æ³•"," 2ã€æ»‘åŠ¨çª—å£ç®—æ³•"," 3ã€æ¼æ¡¶ç®—æ³•"," 4ã€ä»¤ç‰Œæ¡¶ç®—æ³•"],"articleBody":"[toc]\n1.ä»‹ç» Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚\nSpring Cloud Gateway ä½œä¸º Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£ Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ã€ç›‘æ§ã€åŸ‹ç‚¹å’Œé™æµç­‰ã€‚\nSpring Cloud Gateway çš„ç‰¹å¾ï¼š\nåŸºäº Spring Framework 5ï¼ŒProject Reactor å’Œ Spring Boot 2.0 åŠ¨æ€è·¯ç”± Predicates å’Œ Filters ä½œç”¨äºç‰¹å®šè·¯ç”± é›†æˆ Hystrix æ–­è·¯å™¨ é›†æˆ Spring Cloud DiscoveryClient æ˜“äºç¼–å†™çš„ Predicates å’Œ Filters é™æµ è·¯å¾„é‡å†™ 1.2æœ¯è¯­ Routeï¼ˆè·¯ç”±ï¼‰ï¼šè¿™æ˜¯ç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”±ä¸€ä¸ª IDï¼Œä¸€ä¸ªç›®æ ‡ URIï¼Œä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨å®šä¹‰ã€‚å¦‚æœæ–­è¨€ä¸ºçœŸï¼Œåˆ™è·¯ç”±åŒ¹é…ã€‚-\u003e ç†è§£ä¸ºåˆ†å‘(æ”¹å˜)è·¯å¾„ Predicateï¼ˆæ–­è¨€ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ª Java 8 çš„ Predicateã€‚è¾“å…¥ç±»å‹æ˜¯ä¸€ä¸ª ServerWebExchangeã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥åŒ¹é…æ¥è‡ª HTTP è¯·æ±‚çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ headers æˆ–å‚æ•°ã€‚-\u003e æŒ‰æŒ‡å®šçš„è·¯å¾„æ‹¦æˆª Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼šè¿™æ˜¯org.springframework.cloud.gateway.filter.GatewayFilterçš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä¿®æ”¹è¯·æ±‚å’Œå“åº”ã€‚-\u003e æ‹¦æˆªä¸‹çš„è·¯å¾„å¯ä»¥åšä¸€äº›æ“ä½œ 1.2æµç¨‹: å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚ è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆâ€œpreâ€ï¼‰æˆ–ä¹‹åï¼ˆâ€œpostâ€ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚\nè¯·æ±‚ä¼šä¸¤æ¬¡ç»è¿‡filter -\u003e è¿›æ¥æ—¶å’Œå‡ºå»æ—¶\n2.ä½¿ç”¨ pom.xml\n1 2 3 4 org.springframework.cloud spring-cloud-starter-gateway æ³¨æ„,webå’Œè·¯ç”±ä¸èƒ½åŒæ—¶å¼•è¿›\n2.1 è·¯ç”± è·¯ç”±æ˜¯ç”¨æ¥åˆ†å‘çš„,è¿™æ˜¯åŸºç¡€,åé¢çš„è¿‡æ»¤å™¨å’Œæ–­è¨€å™¨éƒ½æ˜¯ä¸ºè·¯ç”±æœåŠ¡çš„.\nSpring Cloud Gateway ç½‘å…³è·¯ç”±æœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼š\nåœ¨é…ç½®æ–‡ä»¶ yml ä¸­é…ç½® é€šè¿‡@Beanè‡ªå®šä¹‰ RouteLocatorï¼Œåœ¨å¯åŠ¨ä¸»ç±» Application ä¸­é…ç½® è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œå»ºè®®ä½¿ç”¨ yml æ–¹å¼è¿›é…ç½®ã€‚\napplication.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 server: port: 8081 spring: cloud: gateway: routes: - id: neo_route uri: http://www.ityouknow.com predicates: - Path=/spring-cloud logging: level: org.springframework.cloud.gateway: trace org.springframework.http.server.reactive: debug org.springframework.web.reactive: debug reactor.ipc.netty: debug å„å­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š\nidï¼šæˆ‘ä»¬è‡ªå®šä¹‰çš„è·¯ç”± IDï¼Œä¿æŒå”¯ä¸€ uriï¼šç›®æ ‡æœåŠ¡åœ°å€ predicatesï¼šè·¯ç”±æ¡ä»¶ï¼ŒPredicate æ¥å—ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ç»“æœã€‚è¯¥æ¥å£åŒ…å«å¤šç§é»˜è®¤æ–¹æ³•æ¥å°† Predicate ç»„åˆæˆå…¶ä»–å¤æ‚çš„é€»è¾‘ï¼ˆæ¯”å¦‚ï¼šä¸ï¼Œæˆ–ï¼Œéï¼‰ã€‚ filtersï¼šè¿‡æ»¤è§„åˆ™ï¼Œæœ¬ç¤ºä¾‹æš‚æ—¶æ²¡ç”¨ã€‚ routesä¸‹å¯ä»¥æœ‰å¾ˆå¤šid,predicatesä¸‹å¯ä»¥æœ‰å¾ˆå¤šè¿‡æ»¤å·¥å‚,\nä¸Šé¢è¿™æ®µé…ç½®çš„æ„æ€æ˜¯ï¼Œé…ç½®äº†ä¸€ä¸ª id ä¸º neo_route çš„è·¯ç”±è§„åˆ™ï¼Œå½“è®¿é—®åœ°å€ http://localhost:8080/spring-cloudæ—¶ä¼šè‡ªåŠ¨è½¬å‘åˆ°åœ°å€ï¼šhttp://www.ityouknow.com/spring-cloudã€‚\nè½¬å‘åŠŸèƒ½åŒæ ·å¯ä»¥é€šè¿‡ä»£ç æ¥å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨ç±» GateWayApplication ä¸­æ·»åŠ æ–¹æ³• customRouteLocator() æ¥å®šåˆ¶è½¬å‘è§„åˆ™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @SpringBootApplication public class GateWayApplication { public static void main(String[] args) { SpringApplication.run(GateWayApplication.class, args); } @Bean public RouteLocator customRouteLocator(RouteLocatorBuilder builder) { return builder.routes() .route(\"path_route\", r -\u003e r.path(\"/about\") .uri(\"http://ityouknow.com\")) .build(); } } ä¸Šé¢é…ç½®äº†ä¸€ä¸ª id ä¸º path_route çš„è·¯ç”±ï¼Œå½“è®¿é—®åœ°å€http://localhost:8080/aboutæ—¶ä¼šè‡ªåŠ¨è½¬å‘åˆ°åœ°å€ï¼šhttp://www.ityouknow.com/aboutå’Œä¸Šé¢çš„è½¬å‘æ•ˆæœä¸€æ ·ï¼Œåªæ˜¯è¿™é‡Œè½¬å‘çš„æ˜¯ä»¥é¡¹ç›®åœ°å€/aboutæ ¼å¼çš„è¯·æ±‚åœ°å€ã€‚\nä¸Šé¢ä¸¤ä¸ªç¤ºä¾‹ä¸­ uri éƒ½æ˜¯æŒ‡å‘äº†æˆ‘çš„ä¸ªäººç½‘ç«™ï¼Œåœ¨å®é™…é¡¹ç›®ä½¿ç”¨ä¸­å¯ä»¥å°† uri æŒ‡å‘å¯¹å¤–æä¾›æœåŠ¡çš„é¡¹ç›®åœ°å€ï¼Œç»Ÿä¸€å¯¹å¤–è¾“å‡ºæ¥å£ã€‚\nå…¶å®ä¸ä¸€å®šå†™åœ¨applicationé‡Œ,å†™åˆ°ä»»æ„ä¸€ä¸ªä¼šè¢«åŠ è½½çš„ç±»ä¸­éƒ½å¯ä»¥,@component æ”¾åœ¨ç±»ä¸Šå°±ä¼šè¢«åŠ è½½\n2.2 æ–­è¨€å™¨ Spring Cloud Gateway æ˜¯é€šè¿‡ Spring WebFlux çš„ HandlerMapping åšä¸ºåº•å±‚æ”¯æŒæ¥åŒ¹é…åˆ°è½¬å‘è·¯ç”±ï¼ŒSpring Cloud Gateway å†…ç½®äº†å¾ˆå¤š Predicates å·¥å‚ï¼Œè¿™äº› Predicates å·¥å‚é€šè¿‡ä¸åŒçš„ HTTP è¯·æ±‚å‚æ•°æ¥åŒ¹é…ï¼Œå¤šä¸ª Predicates å·¥å‚å¯ä»¥ç»„åˆä½¿ç”¨ã€‚\napplication.yml\n1 2 3 4 5 6 7 8 9 10 spring: cloud: gateway: routes: - id: host_foo_path_headers_to_httpbin uri: http://ityouknow.com predicates: - Host=**.foo.org - Path=/headers - After=2018-01-20T06:06:06+08:00[Asia/Shanghai] predicatesä¸‹çš„é…ç½®ä½¿ç”¨çš„éƒ½æ˜¯æ–­è¨€å·¥å‚\nHost -\u003e HostRoutePredicateFactory\nPath -\u003e PathRoutePredicateFactory åªéœ€è¦å†™å‰ç¼€,(åé¢çš„RoutePredicateFactoryä¸ç”¨å†™,ä¹Ÿä¸èƒ½å†™);\nspringcloudæ˜¯æŠŠæ‰€æœ‰çš„æ–­è¨€å·¥å‚åŠ è½½è¿›æ¥,ç„¶åå¾—åˆ°ç±»å,å»æ‰åç¼€ä½œä¸ºkey,ç±»å¯¹è±¡ä½œä¸ºvaule,ç„¶åæ‹¿ç€é…ç½®æ–‡ä»¶ä¸­çš„å€¼å»getå‡ºå€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 æºç : ############ # å¾—åˆ°key # org.springframework.cloud.gateway.support.NameUtils.class public static String normalizeRoutePredicateName(Class\u003c? extends RoutePredicateFactory\u003e clazz) { return removeGarbage(clazz.getSimpleName().replace(RoutePredicateFactory.class.getSimpleName(), \"\")); } ############ # putè¿›map,å­˜èµ·æ¥ # org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator.class public RouteDefinitionRouteLocator(RouteDefinitionLocator routeDefinitionLocator, List\u003cRoutePredicateFactory\u003e predicates, List\u003cGatewayFilterFactory\u003e gatewayFilterFactories, GatewayProperties gatewayProperties, ConversionService conversionService) { this.routeDefinitionLocator = routeDefinitionLocator; this.conversionService = conversionService; initFactories(predicates); gatewayFilterFactories.forEach( factory -\u003e this.gatewayFilterFactories.put(factory.name(), factory)); this.gatewayProperties = gatewayProperties; } ############ # æ ¹æ®åå­—å–å€¼ # org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator.class @SuppressWarnings(\"unchecked\") private List\u003cGatewayFilter\u003e loadGatewayFilters(String id, List\u003cFilterDefinition\u003e filterDefinitions) { List\u003cGatewayFilter\u003e filters = filterDefinitions.stream().map(definition -\u003e { GatewayFilterFactory factory = this.gatewayFilterFactories .get(definition.getName()); if (factory == null) { throw new IllegalArgumentException( \"Unable to find GatewayFilterFactory with name \" + definition.getName()); } # ... åé¢è¿˜æœ‰å¾ˆå¤š,ä¸ç²˜è´´å‡ºæ¥äº† } 2.3 è¿‡æ»¤å™¨ Spring Cloud Gateway çš„ Filter çš„ç”Ÿå‘½å‘¨æœŸä¸åƒ Zuul çš„é‚£ä¹ˆä¸°å¯Œï¼Œå®ƒåªæœ‰ä¸¤ä¸ªï¼šâ€œpreâ€ å’Œ â€œpostâ€ã€‚\nPREï¼š è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±++ä¹‹å‰è°ƒç”¨++ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚\nPOSTï¼šè¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡++ä»¥åæ‰§è¡Œ++ã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„ HTTP Headerã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰ã€‚ Spring Cloud Gateway çš„ Filter åˆ†ä¸ºä¸¤ç§ï¼š\nGatewayFilter\nGlobalFilter\nGlobalFilter ä¼šåº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œè€Œ GatewayFilter å°†åº”ç”¨åˆ°å•ä¸ªè·¯ç”±æˆ–è€…ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±ä¸Šã€‚GatewayFilteryeråŠ ä¸Šé…ç½®åä¹Ÿå¯ä»¥å˜æˆå…¨å±€è¿‡æ»¤(è¿˜ä¸å¦‚ç›´æ¥å†™æˆå…¨å±€è¿‡æ»¤å™¨å‘¢)\n2.3.1 GlobalFilter ç›´æ¥ä¸Šè‡ªå®šä¹‰çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package com.example.demo.filter; import java.util.ArrayList; import java.util.List; import java.util.Optional; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.cloud.gateway.filter.GatewayFilterChain; import org.springframework.cloud.gateway.filter.GlobalFilter; import org.springframework.core.Ordered; import org.springframework.core.io.buffer.DataBuffer; import org.springframework.http.server.reactive.ServerHttpResponse; import org.springframework.stereotype.Component; import org.springframework.web.server.ServerWebExchange; import reactor.core.publisher.Mono; @Component // è®©æ¡†æ¶åŠ è½½è¿™ä¸ªç±» public class TestGlobalFilter implements GlobalFilter, Ordered { // ç»§æ‰¿ GlobalFilter å°±æ˜¯å…¨å±€è¿‡æ»¤å™¨äº† private static final Logger log = LoggerFactory.getLogger(TestGlobalFilter.class); // è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šå° @Override public int getOrder() { return 0; } // å¯ä»¥åœ¨è¿™é‡Œå¹²å¾ˆå¤šå¾ˆå¤šäº‹æƒ…,æ¯”å¦‚éªŒè¯è¯·æ±‚å¤´ä¿¡æ¯ @Override public Mono\u003cVoid\u003e filter(ServerWebExchange exchange, GatewayFilterChain chain) { log.info(\"è¿™æ˜¯gateway-filter,{}\",exchange); String value = exchange.getRequest().getPath().value(); System.out.println(\"è¿‡æ»¤å™¨....\"+value); List\u003cString\u003e name = Optional.ofNullable(exchange.getRequest().getHeaders().get(\"name\")).orElse(new ArrayList\u003cString\u003e()); System.out.println(\"è¿‡æ»¤å™¨....å¤´ä¿¡æ¯-name:\"+name); if (name.contains(\"xkj\")) { ServerHttpResponse response = exchange.getResponse(); response.getHeaders().add(\"name\", \"xkj\"); byte[] datas = \"éæ³•è¯·æ±‚\".getBytes(); DataBuffer buffer = response.bufferFactory().wrap(datas); return response.writeWith(Mono.just(buffer));// ä¸æ­£å¸¸æƒ…å†µæ—¶è¿”å› } // è¿™é‡Œåªæ˜¯å¯¹è¿›æ¥çš„é“¾æ¥å¤„ç†äº†,åœ¨åé¢åŠ then(mono)æ–¹æ³•å°±å¯ä»¥å¤„ç†å‡ºå»æ—¶çš„é“¾æ¥,monoå°±æ˜¯å…·ä½“çš„æ“ä½œ,å¯ä»¥ç”¨æ¥è®°å½•é“¾æ¥ä½¿ç”¨æ—¶é—´ç­‰ return chain.filter(exchange); } } è¿‡æ»¤é€šè¿‡åä¼šç»è¿‡è·¯ç”±æ‹¦æˆªå¹¶è½¬å‘å•¦\n2.3.2 GatewayFilter ç›´æ¥ä¸Šè‡ªå®šä¹‰çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 package com.example.demo.filter; import java.util.ArrayList; import java.util.List; import java.util.Optional; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.cloud.gateway.filter.GatewayFilter; import org.springframework.cloud.gateway.filter.GatewayFilterChain; import org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory; import org.springframework.cloud.gateway.route.RouteLocator; import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder; import org.springframework.context.annotation.Bean; import org.springframework.core.Ordered; import org.springframework.core.io.buffer.DataBuffer; import org.springframework.http.server.reactive.ServerHttpResponse; import org.springframework.stereotype.Component; import org.springframework.web.server.ServerWebExchange; import reactor.core.publisher.Mono; @Component // ç»§æ‰¿GatewayFilter å°±æ˜¯è¿‡æ»¤å™¨äº† public class TestFilter implements GatewayFilter, Ordered { private static final Logger log = LoggerFactory.getLogger(TestFilter.class); @Override public int getOrder() { return 0; } // å’Œå…¨å±€çš„å·®ä¸å¤š @Override public Mono\u003cVoid\u003e filter(ServerWebExchange exchange, GatewayFilterChain chain) { log.info(\"è¿™æ˜¯gateway-filter,{}\",exchange); String value = exchange.getRequest().getPath().value(); System.out.println(\"è¿‡æ»¤å™¨....\"+value); List\u003cString\u003e ages = Optional.ofNullable(exchange.getRequest().getHeaders().get(\"age\")).orElse(new ArrayList\u003c\u003e()); if (ages.contains(\"20\")) { ServerHttpResponse response = exchange.getResponse(); response.getHeaders().add(\"name\", \"xkj\"); byte[] datas = \"éæ³•è¯·æ±‚\".getBytes(); DataBuffer buffer = response.bufferFactory().wrap(datas); return response.writeWith(Mono.just(buffer)); } return chain.filter(exchange); } // å†™å¥½è¿‡æ»¤å™¨å,å°±è¦é€šè¿‡è·¯ç”±æ¥ç”Ÿæ•ˆäº†,å’Œå‰é¢çš„è·¯ç”±æ¡ˆä¾‹ä¸€æ · @Bean public RouteLocator customerRouteLocator(RouteLocatorBuilder builder) { log.info(\"è¿™æ˜¯gateway-customerRouteLocator,{}\",builder); return builder.routes() .route(r -\u003e r.path(\"/jp1/**\") .filters(f -\u003e f.rewritePath(\"/jp1/\", \"/jportal/\").filter(new TestFilter()) ) .uri(\"http://localhost:5766\") .order(0) .id(\"test_route1\") ) .build(); } } 2.3.3 è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚ å‰é¢è¯´åˆ°,è·¯ç”±å»ºè®®å†™é…ç½®,ä½†æ˜¯è·¯ç”±é‡Œåªèƒ½å†™å·¥å‚,æ‰€ä»¥æ¥ä¸‹æ¥ä»‹ç»è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚\nè¿‡æ»¤å™¨å·¥å‚çš„é¡¶çº§æ¥å£æ˜¯GatewayFilterFactoryï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç»§æ‰¿å®ƒçš„ä¸¤ä¸ªæŠ½è±¡ç±»æ¥ç®€åŒ–å¼€å‘AbstractGatewayFilterFactoryå’ŒAbstractNameValueGatewayFilterFactoryï¼Œè¿™ä¸¤ä¸ªæŠ½è±¡ç±»çš„åŒºåˆ«å°±æ˜¯å‰è€…æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼ˆåƒStripPrefixï¼‰ï¼Œåè€…æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼ˆåƒAddResponseHeaderå’Œæˆ‘ä»¬è¿™ç§ï¼‰ã€‚\napplication.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 spring: cloud: gateway: routes: - id: jportal_route uri: http://localhost:5766/ predicates: - Path=/jpxkj/** filters: - Test=name,xkj # - StripPrefix=1 # - PrefixPath=/jportal - RewritePath=/jpxkj/, /jportal/ # - RewritePath=/jpxkj/(?.*), /jportal/${segment} é‡ç‚¹è§£é‡Šfiltersé‡Œé¢çš„\nfiltersä¸‹é¢å…¨æ˜¯å·¥å‚\nTestæ˜¯è‡ªå·±å†™çš„å·¥å‚,åŒæ ·åªèƒ½å†™å‰ç¼€,åŸç†å’Œæ–­è¨€å·¥å‚ä¸€æ ·\n- StripPrefix : æˆªæ–­,ä¼šæˆªæ–­è·¯å¾„,æ•°å­—è¡¨ç¤ºæˆªæ–­ä¸€ä¸ª(ä¸æ‡‚å°±çœ‹æºç ) - prefixPath : åŠ å‰ç¼€,ä¼šåœ¨uriåé¢åŠ ä¸Šè¿™ä¸ªå‰ç¼€ - RewritePath : é‡å®šå‘,æŠŠ/jpxkj/çš„è¿™æ®µè·¯å¾„å˜æˆ/jportal/,åŸç†å°±æ˜¯ç”¨äº†replaceAll()æ–¹æ³• ä¸¤ä¸ªRewritePathèƒ½å®ç°åŒæ ·çš„æ•ˆæœ,å®˜ç½‘æ¡ˆä¾‹æ˜¯å¤æ‚çš„,æˆ‘ä¹Ÿä¸æ‡‚éå¾—å†™å¤æ‚,è¿˜æ˜¯ä¸¤è€…æœ‰åŒºåˆ«? StripPrefix,PrefixPathç»„åˆå®ç°äº†RewritePathçš„åŠŸèƒ½ å·¥å‚ç±»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package com.example.demo.filter; import org.springframework.cloud.gateway.filter.GatewayFilter; import org.springframework.cloud.gateway.filter.factory.AbstractNameValueGatewayFilterFactory; import org.springframework.http.server.reactive.ServerHttpRequest; import org.springframework.stereotype.Component; @Component public class TestGatewayFilterFactory extends AbstractNameValueGatewayFilterFactory { //è¿™æ˜¯æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ç±» @Override public GatewayFilter apply(NameValueConfig config) { System.out.println(\"----TestGatewayFilterFactory:\"+config); return new TestFilter();// è¿™æ˜¯å‰é¢å†™å¥½çš„è¿‡æ»¤å™¨ // ä¹Ÿå¯ä»¥ç°åœºå†™ä¸€ä¸ª //\treturn (exchange, chain) -\u003e { //\tServerHttpRequest request = exchange.getRequest().mutate() //\t.header(config.getName(), config.getValue()) //\t.build(); // //\treturn chain.filter(exchange.mutate().request(request).build()); //\t}; } } 2.4 åŠ å…¥æ³¨å†Œä¸­å¿ƒ å‰é¢ä½¿ç”¨çš„è·¯å¾„å…¨æ˜¯æŒ‡å®šçš„,åœ¨ç”Ÿäº§ä¸­,è‚¯å®šè¦åŠ å…¥æ³¨å†Œä¸­å¿ƒ application.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 # å¢åŠ é…ç½® spring: application: name: gateway-server-test cloud: gateway: discovery: locator: enabled: true eureka: client: service-url: defaultZone: http://10.101.90.171:10000/eureka/ åŠ å…¥é…ç½®å,ç½‘å…³ä¸­å¿ƒä¼šæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ,æ³¨å†Œä¸­å¿ƒé‡Œæ‰€æœ‰çš„åº”ç”¨éƒ½ä¼šæˆä¸ºuri,åç§°éƒ½æ˜¯å¤§å†™,è¿™ä¸ªè¦æ³¨æ„\npom.xml\n1 2 3 4 org.springframework.cloud spring-cloud-starter-netflix-eureka-client å¯åŠ¨ç±»åŠ ä¸Šæ³¨è§£@EnableDiscoveryClient\nè·¯å¾„ç”¨lb://${appName} å°±å¯ä»¥äº†, application.ymlå°±æ˜¯è¿™æ ·äº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 spring: cloud: gateway: discovery: locator: enabled: true # lowerCaseServiceId: true # åº”ç”¨åå˜å°å†™ routes: - id: jportal_route uri: lb://JPORTAL-XKJ predicates: - Path=/jpxkj/** filters: - Test1=name,xkj 3. é™æµç®—æ³• 1ã€è®¡æ•°å™¨ï¼ˆå›ºå®šçª—å£ï¼‰ç®—æ³• è®¡æ•°å™¨ç®—æ³•æ˜¯ä½¿ç”¨è®¡æ•°å™¨åœ¨å‘¨æœŸå†…ç´¯åŠ è®¿é—®æ¬¡æ•°ï¼Œå½“è¾¾åˆ°è®¾å®šçš„é™æµå€¼æ—¶ï¼Œè§¦å‘é™æµç­–ç•¥ã€‚ä¸‹ä¸€ä¸ªå‘¨æœŸå¼€å§‹æ—¶ï¼Œè¿›è¡Œæ¸…é›¶ï¼Œé‡æ–°è®¡æ•°ã€‚\næ­¤ç®—æ³•åœ¨å•æœºè¿˜æ˜¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®ç°éƒ½éå¸¸ç®€å•ï¼Œä½¿ç”¨redisçš„incråŸå­è‡ªå¢æ€§å’Œçº¿ç¨‹å®‰å…¨å³å¯è½»æ¾å®ç°ã€‚\nè¿™ä¸ªç®—æ³•é€šå¸¸ç”¨äºQPSé™æµå’Œç»Ÿè®¡æ€»è®¿é—®é‡ï¼Œå¯¹äºç§’çº§ä»¥ä¸Šçš„æ—¶é—´å‘¨æœŸæ¥è¯´ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸´ç•Œé—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š\nå‡è®¾1minå†…æœåŠ¡å™¨çš„è´Ÿè½½èƒ½åŠ›ä¸º100ï¼Œå› æ­¤ä¸€ä¸ªå‘¨æœŸçš„è®¿é—®é‡é™åˆ¶åœ¨100ï¼Œç„¶è€Œåœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸçš„æœ€å5ç§’å’Œä¸‹ä¸€ä¸ªå‘¨æœŸçš„å¼€å§‹5ç§’æ—¶é—´æ®µå†…ï¼Œåˆ†åˆ«æ¶Œå…¥100çš„è®¿é—®é‡ï¼Œè™½ç„¶æ²¡æœ‰è¶…è¿‡æ¯ä¸ªå‘¨æœŸçš„é™åˆ¶é‡ï¼Œä½†æ˜¯æ•´ä½“ä¸Š10ç§’å†…å·²è¾¾åˆ°200çš„è®¿é—®é‡ï¼Œå·²è¿œè¿œè¶…è¿‡æœåŠ¡å™¨çš„è´Ÿè½½èƒ½åŠ›ï¼Œç”±æ­¤å¯è§ï¼Œè®¡æ•°å™¨ç®—æ³•æ–¹å¼é™æµå¯¹äºå‘¨æœŸæ¯”è¾ƒé•¿çš„é™æµï¼Œå­˜åœ¨å¾ˆå¤§çš„å¼Šç«¯ã€‚\n2ã€æ»‘åŠ¨çª—å£ç®—æ³• æ»‘åŠ¨çª—å£ç®—æ³•æ˜¯å°†æ—¶é—´å‘¨æœŸåˆ†ä¸ºNä¸ªå°å‘¨æœŸï¼Œåˆ†åˆ«è®°å½•æ¯ä¸ªå°å‘¨æœŸå†…è®¿é—®æ¬¡æ•°ï¼Œå¹¶ä¸”æ ¹æ®æ—¶é—´æ»‘åŠ¨åˆ é™¤è¿‡æœŸçš„å°å‘¨æœŸã€‚\nå¦‚ä¸‹å›¾ï¼Œå‡è®¾æ—¶é—´å‘¨æœŸä¸º1minï¼Œå°†1minå†åˆ†ä¸º2ä¸ªå°å‘¨æœŸï¼Œç»Ÿè®¡æ¯ä¸ªå°å‘¨æœŸçš„è®¿é—®æ•°é‡ï¼Œåˆ™å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ—¶é—´å‘¨æœŸå†…ï¼Œè®¿é—®æ•°é‡ä¸º75ï¼Œç¬¬äºŒä¸ªæ—¶é—´å‘¨æœŸå†…ï¼Œè®¿é—®æ•°é‡ä¸º100ï¼Œè¶…è¿‡100çš„è®¿é—®åˆ™è¢«é™æµæ‰äº†ã€‚\nç”±æ­¤å¯è§ï¼Œå½“æ»‘åŠ¨çª—å£çš„æ ¼å­åˆ’åˆ†çš„è¶Šå¤šï¼Œé‚£ä¹ˆæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±è¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚\næ»‘åŠ¨çª—å£ç®—æ³•è™½ç„¶è§£å†³äº†å›ºå®šçª—å£çš„ä¸´ç•Œé—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦åˆ°è¾¾é™æµåï¼Œè¯·æ±‚éƒ½ä¼šç›´æ¥æš´åŠ›è¢«æ‹’ç»ã€‚é…±ç´«æˆ‘ä»¬ä¼šæŸå¤±ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œè¿™å…¶å®å¯¹äºäº§å“æ¥è¯´ï¼Œå¹¶ä¸å¤ªå‹å¥½ã€‚\né¢è¯•å¿…å¤‡ï¼š4ç§ç»å…¸é™æµç®—æ³•è®²è§£ - çŸ¥ä¹ (zhihu.com) 3ã€æ¼æ¡¶ç®—æ³• æ¼æ¡¶ç®—æ³•æ˜¯è®¿é—®è¯·æ±‚åˆ°è¾¾æ—¶ç›´æ¥æ”¾å…¥æ¼æ¡¶ï¼Œå¦‚å½“å‰å®¹é‡å·²è¾¾åˆ°ä¸Šé™ï¼ˆé™æµå€¼ï¼‰ï¼Œåˆ™è¿›è¡Œä¸¢å¼ƒï¼ˆè§¦å‘é™æµç­–ç•¥ï¼‰ã€‚æ¼æ¡¶ä»¥å›ºå®šçš„é€Ÿç‡è¿›è¡Œé‡Šæ”¾è®¿é—®è¯·æ±‚ï¼ˆå³è¯·æ±‚é€šè¿‡ï¼‰ï¼Œç›´åˆ°æ¼æ¡¶ä¸ºç©ºã€‚\né¢å¯¹çªå‘æµé‡çš„æ—¶å€™ï¼Œæ¼æ¡¶ç®—æ³•è¿˜æ˜¯å¾ªè§„è¹ˆçŸ©åœ°å¤„ç†è¯·æ±‚ï¼Œè¿™å°±ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„å•¦ã€‚æµé‡å˜çªå‘æ—¶ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›ç³»ç»Ÿå°½é‡å¿«ç‚¹å¤„ç†è¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒå˜›ã€‚è€Œä¸”æµé‡çš„æµå…¥å’Œæµå‡ºæ— æ³•æ§åˆ¶, é¢å¯¹çªå‘æµé‡å¤„ç†èƒ½åŠ›ä¸ä½³\n4ã€ä»¤ç‰Œæ¡¶ç®—æ³• ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ç¨‹åºä»¥rï¼ˆr=æ—¶é—´å‘¨æœŸ/é™æµå€¼ï¼‰çš„é€Ÿåº¦å‘ä»¤ç‰Œæ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼Œç›´åˆ°ä»¤ç‰Œæ¡¶æ»¡ï¼Œè¯·æ±‚åˆ°è¾¾æ—¶å‘ä»¤ç‰Œæ¡¶è¯·æ±‚ä»¤ç‰Œï¼Œå¦‚è·å–åˆ°ä»¤ç‰Œåˆ™é€šè¿‡è¯·æ±‚ï¼Œå¦åˆ™è§¦å‘é™æµç­–ç•¥\nå¹¶ä¸èƒ½è¯´æ˜ä»¤ç‰Œæ¡¶ä¸€å®šæ¯”æ¼æ´å¥½ï¼Œå¥¹ä»¬ä½¿ç”¨åœºæ™¯ä¸ä¸€æ ·ã€‚\nä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ”¾åœ¨æœåŠ¡ç«¯ï¼Œç”¨æ¥ä¿æŠ¤æœåŠ¡ç«¯ï¼ˆè‡ªå·±ï¼‰ï¼Œä¸»è¦ç”¨æ¥å¯¹è°ƒç”¨è€…é¢‘ç‡è¿›è¡Œé™æµï¼Œä¸ºçš„æ˜¯ä¸è®©è‡ªå·±è¢«å‹å®ã€‚æ‰€ä»¥å¦‚æœè‡ªå·±æœ¬èº«æœ‰å¤„ç†èƒ½åŠ›çš„æ—¶å€™ï¼Œå¦‚æœæµé‡çªå‘ï¼ˆå®é™…æ¶ˆè´¹èƒ½åŠ›å¼ºäºé…ç½®çš„æµé‡é™åˆ¶=æ¡¶å¤§å°ï¼‰ï¼Œé‚£ä¹ˆå®é™…å¤„ç†é€Ÿç‡å¯ä»¥è¶…è¿‡é…ç½®çš„é™åˆ¶ï¼ˆæ¡¶å¤§å°ï¼‰ã€‚ è€Œæ¼æ¡¶ç®—æ³•ï¼Œæ”¾åœ¨è°ƒç”¨æ–¹ï¼Œè¿™æ˜¯ç”¨æ¥ä¿æŠ¤ä»–äººï¼Œä¹Ÿå°±æ˜¯ä¿æŠ¤ä»–æ‰€è°ƒç”¨çš„ç³»ç»Ÿã€‚ä¸»è¦åœºæ™¯æ˜¯ï¼Œå½“è°ƒç”¨çš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿæœ¬èº«æ²¡æœ‰ä¿æŠ¤æœºåˆ¶ï¼Œæˆ–è€…æœ‰æµé‡é™åˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„è°ƒç”¨é€Ÿåº¦ä¸èƒ½è¶…è¿‡ä»–çš„é™åˆ¶ï¼Œç”±äºæˆ‘ä»¬ä¸èƒ½æ›´æ”¹ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œæ‰€ä»¥åªæœ‰åœ¨ä¸»è°ƒæ–¹æ§åˆ¶ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿æµé‡çªå‘ï¼Œä¹Ÿå¿…é¡»èˆå¼ƒã€‚å› ä¸ºæ¶ˆè´¹èƒ½åŠ›æ˜¯ç¬¬ä¸‰æ–¹å†³å®šçš„ã€‚ Spring Cloud Gatewayç³»åˆ—ã€12ã€‘ é™æµç®—æ³•ä½¿ç”¨æ¡ˆä¾‹è¯¦è§£åŠæºç åˆ†æ_äº‘çƒŸæˆé›¨TDçš„åšå®¢-CSDNåšå®¢ å¸¸è§é™æµç®—æ³•ä»‹ç»ï¼ˆæ¼æ¡¶ç®—æ³•ã€ä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰åŠå®ç°â€“å¾…æ•´ç† - æœˆæŸ“éœœå - åšå®¢å›­ (cnblogs.com) æ‰©å±•é˜…è¯»: é«˜å¯ç”¨ä¹‹é™æµ-07-token bucket ä»¤ç‰Œæ¡¶ç®—æ³• | Echo Blog (houbb.github.io) ","wordCount":"5240","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-08-22T00:00:00Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/gateway/"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.github.io/myBlog/img/Q.gif"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.github.io/myBlog/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.github.io/myBlog/img/Q.gif alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.github.io/myBlog/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.github.io/zh/myBlog/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/post title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/archives/ title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/tags title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/categories title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/links title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.github.io/myBlog/zh/>content</a> <span>></span>
<a href=https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/>javaåŠå…¶æ¡†æ¶</a> <span>></span>
<a href=https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/spring_cloud/>Spring_Cloud</a> <span>></span></ul></nav><h1 class=post-title>Gateway</h1><div class=post-description></div><div class=post-meta><span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;11 åˆ†é’Ÿ&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.github.io/myBlog/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/>javaåŠå…¶æ¡†æ¶</a></ul><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv></span></span>
<script src=https://cdn.staticfile.org/twikoo//twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://xiaokunji.github.io/myBlog/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:null,region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script>&nbsp;| è¯„è®º: &nbsp; <span id=comment_count></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1%e4%bb%8b%e7%bb%8d aria-label=1.ä»‹ç»>1.ä»‹ç»</a><ul><li><a href=#12%e6%9c%af%e8%af%ad aria-label=1.2æœ¯è¯­>1.2<strong>æœ¯è¯­</strong></a></li><li><a href=#12%e6%b5%81%e7%a8%8b aria-label=1.2æµç¨‹:>1.2<strong>æµç¨‹:</strong></a></li></ul></li><li><a href=#2%e4%bd%bf%e7%94%a8 aria-label=2.ä½¿ç”¨>2.ä½¿ç”¨</a><ul><li><a href=#21-%e8%b7%af%e7%94%b1 aria-label="2.1 è·¯ç”±">2.1 è·¯ç”±</a></li><li><a href=#22-%e6%96%ad%e8%a8%80%e5%99%a8 aria-label="2.2 æ–­è¨€å™¨">2.2 æ–­è¨€å™¨</a></li><li><a href=#23-%e8%bf%87%e6%bb%a4%e5%99%a8 aria-label="2.3 è¿‡æ»¤å™¨">2.3 è¿‡æ»¤å™¨</a><ul><li><a href=#231-globalfilter aria-label="2.3.1 GlobalFilter">2.3.1 GlobalFilter</a></li><li><a href=#232-gatewayfilter aria-label="2.3.2 GatewayFilter">2.3.2 GatewayFilter</a></li><li><a href=#233-%e8%87%aa%e5%ae%9a%e4%b9%89%e8%bf%87%e6%bb%a4%e5%b7%a5%e5%8e%82 aria-label="2.3.3 è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚">2.3.3 è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚</a></li></ul></li><li><a href=#24-%e5%8a%a0%e5%85%a5%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83 aria-label="2.4 åŠ å…¥æ³¨å†Œä¸­å¿ƒ">2.4 åŠ å…¥æ³¨å†Œä¸­å¿ƒ</a></li></ul></li><li><a href=#3-%e9%99%90%e6%b5%81%e7%ae%97%e6%b3%95 aria-label="3. é™æµç®—æ³•">3. é™æµç®—æ³•</a><ul><li><a href=#1%e8%ae%a1%e6%95%b0%e5%99%a8%e5%9b%ba%e5%ae%9a%e7%aa%97%e5%8f%a3%e7%ae%97%e6%b3%95 aria-label=1ã€è®¡æ•°å™¨ï¼ˆå›ºå®šçª—å£ï¼‰ç®—æ³•>1ã€è®¡æ•°å™¨ï¼ˆå›ºå®šçª—å£ï¼‰ç®—æ³•</a></li><li><a href=#2%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3%e7%ae%97%e6%b3%95 aria-label=2ã€æ»‘åŠ¨çª—å£ç®—æ³•>2ã€æ»‘åŠ¨çª—å£ç®—æ³•</a></li><li><a href=#3%e6%bc%8f%e6%a1%b6%e7%ae%97%e6%b3%95 aria-label=3ã€æ¼æ¡¶ç®—æ³•>3ã€æ¼æ¡¶ç®—æ³•</a></li><li><a href=#4%e4%bb%a4%e7%89%8c%e6%a1%b6%e7%ae%97%e6%b3%95 aria-label=4ã€ä»¤ç‰Œæ¡¶ç®—æ³•>4ã€ä»¤ç‰Œæ¡¶ç®—æ³•</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1ä»‹ç»>1.ä»‹ç»<a hidden class=anchor aria-hidden=true href=#1ä»‹ç»>#</a></h1><p>â€ƒâ€ƒSpring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚</p><p>â€ƒâ€ƒSpring Cloud Gateway ä½œä¸º Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ï¼Œç›®æ ‡æ˜¯æ›¿ä»£ Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ã€ç›‘æ§ã€åŸ‹ç‚¹å’Œé™æµç­‰ã€‚</p><p>Spring Cloud Gateway çš„ç‰¹å¾ï¼š</p><ul><li>åŸºäº Spring Framework 5ï¼ŒProject Reactor å’Œ Spring Boot 2.0
åŠ¨æ€è·¯ç”±</li><li>Predicates å’Œ Filters ä½œç”¨äºç‰¹å®šè·¯ç”±</li><li>é›†æˆ Hystrix æ–­è·¯å™¨</li><li>é›†æˆ Spring Cloud DiscoveryClient</li><li>æ˜“äºç¼–å†™çš„ Predicates å’Œ Filters</li><li>é™æµ</li><li>è·¯å¾„é‡å†™</li></ul><h2 id=12æœ¯è¯­>1.2<strong>æœ¯è¯­</strong><a hidden class=anchor aria-hidden=true href=#12æœ¯è¯­>#</a></h2><ul><li><strong>Routeï¼ˆè·¯ç”±ï¼‰</strong>ï¼šè¿™æ˜¯ç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”±ä¸€ä¸ª IDï¼Œä¸€ä¸ªç›®æ ‡ URIï¼Œä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨å®šä¹‰ã€‚å¦‚æœæ–­è¨€ä¸ºçœŸï¼Œåˆ™è·¯ç”±åŒ¹é…ã€‚-> ç†è§£ä¸ºåˆ†å‘(æ”¹å˜)è·¯å¾„</li><li><strong>Predicateï¼ˆæ–­è¨€ï¼‰</strong>ï¼šè¿™æ˜¯ä¸€ä¸ª Java 8 çš„ Predicateã€‚è¾“å…¥ç±»å‹æ˜¯ä¸€ä¸ª ServerWebExchangeã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥åŒ¹é…æ¥è‡ª HTTP è¯·æ±‚çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ headers æˆ–å‚æ•°ã€‚-> æŒ‰æŒ‡å®šçš„è·¯å¾„æ‹¦æˆª</li><li><strong>Filterï¼ˆè¿‡æ»¤å™¨ï¼‰</strong>ï¼šè¿™æ˜¯org.springframework.cloud.gateway.filter.GatewayFilterçš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä¿®æ”¹è¯·æ±‚å’Œå“åº”ã€‚-> æ‹¦æˆªä¸‹çš„è·¯å¾„å¯ä»¥åšä¸€äº›æ“ä½œ</li></ul><h2 id=12æµç¨‹>1.2<strong>æµç¨‹:</strong><a hidden class=anchor aria-hidden=true href=#12æµç¨‹>#</a></h2><p><img loading=lazy src=http://favorites.ren/assets/images/2018/springcloud/spring-cloud-gateway.png alt=img></p><p>å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚
è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆâ€œpreâ€ï¼‰æˆ–ä¹‹åï¼ˆâ€œpostâ€ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p><blockquote><p><u>è¯·æ±‚ä¼šä¸¤æ¬¡ç»è¿‡filter -> è¿›æ¥æ—¶å’Œå‡ºå»æ—¶</u></p></blockquote><h1 id=2ä½¿ç”¨>2.ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#2ä½¿ç”¨>#</a></h1><p>pom.xml</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>æ³¨æ„,webå’Œè·¯ç”±ä¸èƒ½åŒæ—¶å¼•è¿›</p></blockquote><h2 id=21-è·¯ç”±>2.1 è·¯ç”±<a hidden class=anchor aria-hidden=true href=#21-è·¯ç”±>#</a></h2><p>è·¯ç”±æ˜¯ç”¨æ¥åˆ†å‘çš„,è¿™æ˜¯åŸºç¡€,åé¢çš„è¿‡æ»¤å™¨å’Œæ–­è¨€å™¨éƒ½æ˜¯ä¸ºè·¯ç”±æœåŠ¡çš„.</p><p>Spring Cloud Gateway ç½‘å…³è·¯ç”±æœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼š</p><ol><li>åœ¨é…ç½®æ–‡ä»¶ yml ä¸­é…ç½®</li><li>é€šè¿‡<code>@Bean</code>è‡ªå®šä¹‰ RouteLocatorï¼Œåœ¨å¯åŠ¨ä¸»ç±» Application ä¸­é…ç½®</li></ol><p>è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œå»ºè®®ä½¿ç”¨ yml æ–¹å¼è¿›é…ç½®ã€‚</p><p>application.yml</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>neo_route</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>http://www.ityouknow.com</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>Path=/spring-cloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>org.springframework.cloud.gateway</span>: <span style=color:#ae81ff>trace</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>org.springframework.http.server.reactive</span>: <span style=color:#ae81ff>debug</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>org.springframework.web.reactive</span>: <span style=color:#ae81ff>debug</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>reactor.ipc.netty</span>: <span style=color:#ae81ff>debug</span>
</span></span></code></pre></td></tr></table></div></div><p>å„å­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>idï¼šæˆ‘ä»¬è‡ªå®šä¹‰çš„è·¯ç”± IDï¼Œä¿æŒå”¯ä¸€</li><li>uriï¼šç›®æ ‡æœåŠ¡åœ°å€</li><li>predicatesï¼šè·¯ç”±æ¡ä»¶ï¼ŒPredicate æ¥å—ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ç»“æœã€‚è¯¥æ¥å£åŒ…å«å¤šç§é»˜è®¤æ–¹æ³•æ¥å°† Predicate ç»„åˆæˆå…¶ä»–å¤æ‚çš„é€»è¾‘ï¼ˆæ¯”å¦‚ï¼šä¸ï¼Œæˆ–ï¼Œéï¼‰ã€‚</li><li>filtersï¼šè¿‡æ»¤è§„åˆ™ï¼Œæœ¬ç¤ºä¾‹æš‚æ—¶æ²¡ç”¨ã€‚</li></ul><blockquote><p>routesä¸‹å¯ä»¥æœ‰å¾ˆå¤šid,predicatesä¸‹å¯ä»¥æœ‰å¾ˆå¤šè¿‡æ»¤å·¥å‚,</p></blockquote><p>ä¸Šé¢è¿™æ®µé…ç½®çš„æ„æ€æ˜¯ï¼Œé…ç½®äº†ä¸€ä¸ª id ä¸º neo_route çš„è·¯ç”±è§„åˆ™ï¼Œå½“è®¿é—®åœ°å€ <code>http://localhost:8080/spring-cloud</code>æ—¶ä¼šè‡ªåŠ¨è½¬å‘åˆ°åœ°å€ï¼š<code>http://www.ityouknow.com/spring-cloud</code>ã€‚</p><p>è½¬å‘åŠŸèƒ½åŒæ ·å¯ä»¥é€šè¿‡ä»£ç æ¥å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨ç±» GateWayApplication ä¸­æ·»åŠ æ–¹æ³• customRouteLocator() æ¥å®šåˆ¶è½¬å‘è§„åˆ™ã€‚</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GateWayApplication</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		SpringApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>GateWayApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> RouteLocator <span style=color:#a6e22e>customRouteLocator</span><span style=color:#f92672>(</span>RouteLocatorBuilder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>routes</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>.</span><span style=color:#a6e22e>route</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;path_route&#34;</span><span style=color:#f92672>,</span> r <span style=color:#f92672>-&gt;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>path</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/about&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://ityouknow.com&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢é…ç½®äº†ä¸€ä¸ª id ä¸º path_route çš„è·¯ç”±ï¼Œå½“è®¿é—®åœ°å€<code>http://localhost:8080/about</code>æ—¶ä¼šè‡ªåŠ¨è½¬å‘åˆ°åœ°å€ï¼š<code>http://www.ityouknow.com/about</code>å’Œä¸Šé¢çš„è½¬å‘æ•ˆæœä¸€æ ·ï¼Œåªæ˜¯è¿™é‡Œè½¬å‘çš„æ˜¯ä»¥é¡¹ç›®åœ°å€/aboutæ ¼å¼çš„è¯·æ±‚åœ°å€ã€‚</p><p>ä¸Šé¢ä¸¤ä¸ªç¤ºä¾‹ä¸­ uri éƒ½æ˜¯æŒ‡å‘äº†æˆ‘çš„ä¸ªäººç½‘ç«™ï¼Œåœ¨å®é™…é¡¹ç›®ä½¿ç”¨ä¸­å¯ä»¥å°† uri æŒ‡å‘å¯¹å¤–æä¾›æœåŠ¡çš„é¡¹ç›®åœ°å€ï¼Œç»Ÿä¸€å¯¹å¤–è¾“å‡ºæ¥å£ã€‚</p><blockquote><p>å…¶å®ä¸ä¸€å®šå†™åœ¨applicationé‡Œ,å†™åˆ°ä»»æ„ä¸€ä¸ªä¼šè¢«åŠ è½½çš„ç±»ä¸­éƒ½å¯ä»¥,@component æ”¾åœ¨ç±»ä¸Šå°±ä¼šè¢«åŠ è½½</p></blockquote><h2 id=22-æ–­è¨€å™¨>2.2 æ–­è¨€å™¨<a hidden class=anchor aria-hidden=true href=#22-æ–­è¨€å™¨>#</a></h2><p>Spring Cloud Gateway æ˜¯é€šè¿‡ Spring WebFlux çš„ HandlerMapping åšä¸ºåº•å±‚æ”¯æŒæ¥åŒ¹é…åˆ°è½¬å‘è·¯ç”±ï¼ŒSpring Cloud Gateway å†…ç½®äº†å¾ˆå¤š Predicates å·¥å‚ï¼Œè¿™äº› Predicates å·¥å‚é€šè¿‡ä¸åŒçš„ HTTP è¯·æ±‚å‚æ•°æ¥åŒ¹é…ï¼Œå¤šä¸ª Predicates å·¥å‚å¯ä»¥ç»„åˆä½¿ç”¨ã€‚</p><p>application.yml</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>       - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>host_foo_path_headers_to_httpbin</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>http://ityouknow.com</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>Host=**.foo.org</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>Path=/headers</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>After=2018-01-20T06:06:06+08:00[Asia/Shanghai]</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>predicatesä¸‹çš„é…ç½®ä½¿ç”¨çš„éƒ½æ˜¯æ–­è¨€å·¥å‚</p></blockquote><ul><li><p>Host -> HostRoutePredicateFactory</p></li><li><p>Path -> PathRoutePredicateFactory
åªéœ€è¦å†™å‰ç¼€,(åé¢çš„RoutePredicateFactoryä¸ç”¨å†™,ä¹Ÿä¸èƒ½å†™);</p><p><u>springcloudæ˜¯æŠŠæ‰€æœ‰çš„æ–­è¨€å·¥å‚åŠ è½½è¿›æ¥,ç„¶åå¾—åˆ°ç±»å,å»æ‰åç¼€ä½œä¸ºkey,ç±»å¯¹è±¡ä½œä¸ºvaule,ç„¶åæ‹¿ç€é…ç½®æ–‡ä»¶ä¸­çš„å€¼å»getå‡ºå€¼</u></p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>æºç :
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>############</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> å¾—åˆ°key
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>springframework</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cloud</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gateway</span><span style=color:#f92672>.</span><span style=color:#a6e22e>support</span><span style=color:#f92672>.</span><span style=color:#a6e22e>NameUtils</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>normalizeRoutePredicateName</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> RoutePredicateFactory<span style=color:#f92672>&gt;</span> clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> removeGarbage<span style=color:#f92672>(</span>clazz<span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>replace</span><span style=color:#f92672>(</span>RoutePredicateFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getSimpleName</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>   
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>############</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> putè¿›map<span style=color:#f92672>,</span>å­˜èµ·æ¥
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>springframework</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cloud</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gateway</span><span style=color:#f92672>.</span><span style=color:#a6e22e>route</span><span style=color:#f92672>.</span><span style=color:#a6e22e>RouteDefinitionRouteLocator</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RouteDefinitionRouteLocator</span><span style=color:#f92672>(</span>RouteDefinitionLocator routeDefinitionLocator<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>RoutePredicateFactory<span style=color:#f92672>&gt;</span> predicates<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>GatewayFilterFactory<span style=color:#f92672>&gt;</span> gatewayFilterFactories<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			GatewayProperties gatewayProperties<span style=color:#f92672>,</span> ConversionService conversionService<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>routeDefinitionLocator</span> <span style=color:#f92672>=</span> routeDefinitionLocator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>conversionService</span> <span style=color:#f92672>=</span> conversionService<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		initFactories<span style=color:#f92672>(</span>predicates<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		gatewayFilterFactories<span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>				factory <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gatewayFilterFactories</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>factory<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>(),</span> factory<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gatewayProperties</span> <span style=color:#f92672>=</span> gatewayProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>############</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> æ ¹æ®åå­—å–å€¼
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>springframework</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cloud</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gateway</span><span style=color:#f92672>.</span><span style=color:#a6e22e>route</span><span style=color:#f92672>.</span><span style=color:#a6e22e>RouteDefinitionRouteLocator</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>GatewayFilter<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>loadGatewayFilters</span><span style=color:#f92672>(</span>String id<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>			List<span style=color:#f92672>&lt;</span>FilterDefinition<span style=color:#f92672>&gt;</span> filterDefinitions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>GatewayFilter<span style=color:#f92672>&gt;</span> filters <span style=color:#f92672>=</span> filterDefinitions<span style=color:#f92672>.</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>().</span><span style=color:#a6e22e>map</span><span style=color:#f92672>(</span>definition <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			GatewayFilterFactory factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>gatewayFilterFactories</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>definition<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>factory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>						<span style=color:#e6db74>&#34;Unable to find GatewayFilterFactory with name &#34;</span>
</span></span><span style=display:flex><span>								<span style=color:#f92672>+</span> definition<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>...</span> åé¢è¿˜æœ‰å¾ˆå¤š<span style=color:#f92672>,</span>ä¸ç²˜è´´å‡ºæ¥äº†
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=23-è¿‡æ»¤å™¨>2.3 è¿‡æ»¤å™¨<a hidden class=anchor aria-hidden=true href=#23-è¿‡æ»¤å™¨>#</a></h2><p>Spring Cloud Gateway çš„ Filter çš„ç”Ÿå‘½å‘¨æœŸä¸åƒ Zuul çš„é‚£ä¹ˆä¸°å¯Œï¼Œå®ƒåªæœ‰ä¸¤ä¸ªï¼šâ€œpreâ€ å’Œ â€œpostâ€ã€‚</p><ul><li><p>PREï¼š è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±++ä¹‹å‰è°ƒç”¨++ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚</p></li><li><p>POSTï¼šè¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡++ä»¥åæ‰§è¡Œ++ã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„ HTTP Headerã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰ã€‚
Spring Cloud Gateway çš„ Filter åˆ†ä¸ºä¸¤ç§ï¼š</p></li><li><p>GatewayFilter</p></li><li><p>GlobalFilter</p><p>GlobalFilter ä¼šåº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Šï¼Œè€Œ GatewayFilter å°†åº”ç”¨åˆ°å•ä¸ªè·¯ç”±æˆ–è€…ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±ä¸Šã€‚GatewayFilteryeråŠ ä¸Šé…ç½®åä¹Ÿå¯ä»¥å˜æˆå…¨å±€è¿‡æ»¤(è¿˜ä¸å¦‚ç›´æ¥å†™æˆå…¨å±€è¿‡æ»¤å™¨å‘¢)</p></li></ul><h3 id=231-globalfilter>2.3.1 GlobalFilter<a hidden class=anchor aria-hidden=true href=#231-globalfilter>#</a></h3><p>ç›´æ¥ä¸Šè‡ªå®šä¹‰çš„</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.example.demo.filter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.ArrayList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Optional<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.GlobalFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.Ordered<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.io.buffer.DataBuffer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.server.reactive.ServerHttpResponse<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.server.ServerWebExchange<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> reactor.core.publisher.Mono<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>  <span style=color:#75715e>// è®©æ¡†æ¶åŠ è½½è¿™ä¸ªç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestGlobalFilter</span> <span style=color:#66d9ef>implements</span> GlobalFilter<span style=color:#f92672>,</span> Ordered <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»§æ‰¿ GlobalFilter å°±æ˜¯å…¨å±€è¿‡æ»¤å™¨äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>TestGlobalFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šå°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getOrder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¯ä»¥åœ¨è¿™é‡Œå¹²å¾ˆå¤šå¾ˆå¤šäº‹æƒ…,æ¯”å¦‚éªŒè¯è¯·æ±‚å¤´ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Mono<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>ServerWebExchange exchange<span style=color:#f92672>,</span> GatewayFilterChain chain<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è¿™æ˜¯gateway-filter,{}&#34;</span><span style=color:#f92672>,</span>exchange<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		String value <span style=color:#f92672>=</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequest</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>().</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è¿‡æ»¤å™¨....&#34;</span><span style=color:#f92672>+</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> name <span style=color:#f92672>=</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>ofNullable</span><span style=color:#f92672>(</span>exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequest</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>orElse</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;());</span>
</span></span><span style=display:flex><span>		System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è¿‡æ»¤å™¨....å¤´ä¿¡æ¯-name:&#34;</span><span style=color:#f92672>+</span>name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xkj&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			ServerHttpResponse response <span style=color:#f92672>=</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getResponse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			response<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;xkj&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> datas <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;éæ³•è¯·æ±‚&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			DataBuffer buffer <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>bufferFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>datas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>writeWith</span><span style=color:#f92672>(</span>Mono<span style=color:#f92672>.</span><span style=color:#a6e22e>just</span><span style=color:#f92672>(</span>buffer<span style=color:#f92672>));</span><span style=color:#75715e>// ä¸æ­£å¸¸æƒ…å†µæ—¶è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è¿™é‡Œåªæ˜¯å¯¹è¿›æ¥çš„é“¾æ¥å¤„ç†äº†,åœ¨åé¢åŠ then(mono)æ–¹æ³•å°±å¯ä»¥å¤„ç†å‡ºå»æ—¶çš„é“¾æ¥,monoå°±æ˜¯å…·ä½“çš„æ“ä½œ,å¯ä»¥ç”¨æ¥è®°å½•é“¾æ¥ä½¿ç”¨æ—¶é—´ç­‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>exchange<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>è¿‡æ»¤é€šè¿‡åä¼šç»è¿‡è·¯ç”±æ‹¦æˆªå¹¶è½¬å‘å•¦</p></blockquote><h3 id=232-gatewayfilter>2.3.2 GatewayFilter<a hidden class=anchor aria-hidden=true href=#232-gatewayfilter>#</a></h3><p>ç›´æ¥ä¸Šè‡ªå®šä¹‰çš„</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.example.demo.filter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.ArrayList<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Optional<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.Logger<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.slf4j.LoggerFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.GatewayFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.factory.StripPrefixGatewayFilterFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.route.RouteLocator<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.Ordered<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.io.buffer.DataBuffer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.server.reactive.ServerHttpResponse<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.server.ServerWebExchange<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> reactor.core.publisher.Mono<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»§æ‰¿GatewayFilter å°±æ˜¯è¿‡æ»¤å™¨äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestFilter</span> <span style=color:#66d9ef>implements</span> GatewayFilter<span style=color:#f92672>,</span> Ordered <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger log <span style=color:#f92672>=</span> LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>TestFilter<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getOrder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å’Œå…¨å±€çš„å·®ä¸å¤š
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Mono<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>ServerWebExchange exchange<span style=color:#f92672>,</span> GatewayFilterChain chain<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è¿™æ˜¯gateway-filter,{}&#34;</span><span style=color:#f92672>,</span>exchange<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		String value <span style=color:#f92672>=</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequest</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getPath</span><span style=color:#f92672>().</span><span style=color:#a6e22e>value</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è¿‡æ»¤å™¨....&#34;</span><span style=color:#f92672>+</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> ages <span style=color:#f92672>=</span> Optional<span style=color:#f92672>.</span><span style=color:#a6e22e>ofNullable</span><span style=color:#f92672>(</span>exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequest</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;age&#34;</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>orElse</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;());</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ages<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;20&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			ServerHttpResponse response <span style=color:#f92672>=</span> exchange<span style=color:#f92672>.</span><span style=color:#a6e22e>getResponse</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			response<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaders</span><span style=color:#f92672>().</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;xkj&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> datas <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;éæ³•è¯·æ±‚&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			DataBuffer buffer <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>bufferFactory</span><span style=color:#f92672>().</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>datas<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>writeWith</span><span style=color:#f92672>(</span>Mono<span style=color:#f92672>.</span><span style=color:#a6e22e>just</span><span style=color:#f92672>(</span>buffer<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> chain<span style=color:#f92672>.</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span>exchange<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å†™å¥½è¿‡æ»¤å™¨å,å°±è¦é€šè¿‡è·¯ç”±æ¥ç”Ÿæ•ˆäº†,å’Œå‰é¢çš„è·¯ç”±æ¡ˆä¾‹ä¸€æ ·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> RouteLocator <span style=color:#a6e22e>customerRouteLocator</span><span style=color:#f92672>(</span>RouteLocatorBuilder builder<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		 log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;è¿™æ˜¯gateway-customerRouteLocator,{}&#34;</span><span style=color:#f92672>,</span>builder<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>routes</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>.</span><span style=color:#a6e22e>route</span><span style=color:#f92672>(</span>r <span style=color:#f92672>-&gt;</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>path</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/jp1/**&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>											<span style=color:#f92672>.</span><span style=color:#a6e22e>filters</span><span style=color:#f92672>(</span>f <span style=color:#f92672>-&gt;</span>  f<span style=color:#f92672>.</span><span style=color:#a6e22e>rewritePath</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/jp1/&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;/jportal/&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>filter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TestFilter<span style=color:#f92672>())</span> <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>											<span style=color:#f92672>.</span><span style=color:#a6e22e>uri</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://localhost:5766&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>											<span style=color:#f92672>.</span><span style=color:#a6e22e>order</span><span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>											<span style=color:#f92672>.</span><span style=color:#a6e22e>id</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;test_route1&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>					 	<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>					 <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=233-è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚>2.3.3 è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚<a hidden class=anchor aria-hidden=true href=#233-è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚>#</a></h3><p>å‰é¢è¯´åˆ°,è·¯ç”±å»ºè®®å†™é…ç½®,ä½†æ˜¯è·¯ç”±é‡Œåªèƒ½å†™å·¥å‚,æ‰€ä»¥æ¥ä¸‹æ¥ä»‹ç»è‡ªå®šä¹‰è¿‡æ»¤å·¥å‚</p><p>è¿‡æ»¤å™¨å·¥å‚çš„é¡¶çº§æ¥å£æ˜¯<code>GatewayFilterFactory</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç»§æ‰¿å®ƒçš„ä¸¤ä¸ªæŠ½è±¡ç±»æ¥ç®€åŒ–å¼€å‘<code>AbstractGatewayFilterFactory</code>å’Œ<code>AbstractNameValueGatewayFilterFactory</code>ï¼Œè¿™ä¸¤ä¸ªæŠ½è±¡ç±»çš„åŒºåˆ«å°±æ˜¯å‰è€…æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼ˆåƒStripPrefixï¼‰ï¼Œåè€…æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼ˆåƒAddResponseHeaderå’Œæˆ‘ä»¬è¿™ç§ï¼‰ã€‚</p><p><img loading=lazy src=http://favorites.ren/assets/images/2018/springcloud/spring-cloud-gateway3.png alt=img></p><p>application.yml</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>jportal_route</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>http://localhost:5766/</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>Path=/jpxkj/**</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>Test=name,xkj</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#          - StripPrefix=1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#          - PrefixPath=/jportal</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>RewritePath=/jpxkj/, /jportal/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#          - RewritePath=/jpxkj/(?&lt;segment&gt;.*), /jportal/${segment}</span>
</span></span><span style=display:flex><span>  
</span></span></code></pre></td></tr></table></div></div><blockquote><p>é‡ç‚¹è§£é‡Šfiltersé‡Œé¢çš„</p></blockquote><p>filtersä¸‹é¢å…¨æ˜¯å·¥å‚</p><p>Testæ˜¯è‡ªå·±å†™çš„å·¥å‚,åŒæ ·åªèƒ½å†™å‰ç¼€,åŸç†å’Œæ–­è¨€å·¥å‚ä¸€æ ·</p><pre><code>- StripPrefix : æˆªæ–­,ä¼šæˆªæ–­è·¯å¾„,æ•°å­—è¡¨ç¤ºæˆªæ–­ä¸€ä¸ª(ä¸æ‡‚å°±çœ‹æºç )   
  
- prefixPath  : åŠ å‰ç¼€,ä¼šåœ¨uriåé¢åŠ ä¸Šè¿™ä¸ªå‰ç¼€   
  
- RewritePath : é‡å®šå‘,æŠŠ/jpxkj/çš„è¿™æ®µè·¯å¾„å˜æˆ/jportal/,åŸç†å°±æ˜¯ç”¨äº†replaceAll()æ–¹æ³•    
  
ä¸¤ä¸ªRewritePathèƒ½å®ç°åŒæ ·çš„æ•ˆæœ,å®˜ç½‘æ¡ˆä¾‹æ˜¯å¤æ‚çš„,æˆ‘ä¹Ÿä¸æ‡‚éå¾—å†™å¤æ‚,è¿˜æ˜¯ä¸¤è€…æœ‰åŒºåˆ«?   

  StripPrefix,PrefixPathç»„åˆå®ç°äº†RewritePathçš„åŠŸèƒ½
</code></pre><p>å·¥å‚ç±»</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.example.demo.filter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.GatewayFilter<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.cloud.gateway.filter.factory.AbstractNameValueGatewayFilterFactory<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.http.server.reactive.ServerHttpRequest<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.stereotype.Component<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestGatewayFilterFactory</span> <span style=color:#66d9ef>extends</span> AbstractNameValueGatewayFilterFactory <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//è¿™æ˜¯æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> GatewayFilter <span style=color:#a6e22e>apply</span><span style=color:#f92672>(</span>NameValueConfig config<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;----TestGatewayFilterFactory:&#34;</span><span style=color:#f92672>+</span>config<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TestFilter<span style=color:#f92672>();</span><span style=color:#75715e>// è¿™æ˜¯å‰é¢å†™å¥½çš„è¿‡æ»¤å™¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// ä¹Ÿå¯ä»¥ç°åœºå†™ä¸€ä¸ª
</span></span></span><span style=display:flex><span><span style=color:#75715e>//		return (exchange, chain) -&gt; {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//			ServerHttpRequest request = exchange.getRequest().mutate()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//					.header(config.getName(), config.getValue())
</span></span></span><span style=display:flex><span><span style=color:#75715e>//					.build();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//			return chain.filter(exchange.mutate().request(request).build());
</span></span></span><span style=display:flex><span><span style=color:#75715e>//		};
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=24-åŠ å…¥æ³¨å†Œä¸­å¿ƒ>2.4 åŠ å…¥æ³¨å†Œä¸­å¿ƒ<a hidden class=anchor aria-hidden=true href=#24-åŠ å…¥æ³¨å†Œä¸­å¿ƒ>#</a></h2><p>å‰é¢ä½¿ç”¨çš„è·¯å¾„å…¨æ˜¯æŒ‡å®šçš„,åœ¨ç”Ÿäº§ä¸­,è‚¯å®šè¦åŠ å…¥æ³¨å†Œä¸­å¿ƒ
<code>application.yml</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># å¢åŠ é…ç½®</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>application</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gateway-server-test</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>discovery</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>locator</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>eureka</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>client</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service-url</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>defaultZone</span>: <span style=color:#ae81ff>http://10.101.90.171:10000/eureka/</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>åŠ å…¥é…ç½®å,ç½‘å…³ä¸­å¿ƒä¼šæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ,æ³¨å†Œä¸­å¿ƒé‡Œæ‰€æœ‰çš„åº”ç”¨éƒ½ä¼šæˆä¸ºuri,åç§°éƒ½æ˜¯å¤§å†™,è¿™ä¸ªè¦æ³¨æ„</p></blockquote><p>pom.xml</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯åŠ¨ç±»åŠ ä¸Šæ³¨è§£<code>@EnableDiscoveryClient</code></p><p>è·¯å¾„ç”¨<code>lb://${appName}</code> å°±å¯ä»¥äº†,
application.ymlå°±æ˜¯è¿™æ ·äº†</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>discovery</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>locator</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#          lowerCaseServiceId: true # åº”ç”¨åå˜å°å†™</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>id</span>: <span style=color:#ae81ff>jportal_route</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>lb://JPORTAL-XKJ</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>predicates</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>Path=/jpxkj/**</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>Test1=name,xkj</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=3-é™æµç®—æ³•>3. é™æµç®—æ³•<a hidden class=anchor aria-hidden=true href=#3-é™æµç®—æ³•>#</a></h1><h2 id=1è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•>1ã€è®¡æ•°å™¨ï¼ˆå›ºå®šçª—å£ï¼‰ç®—æ³•<a hidden class=anchor aria-hidden=true href=#1è®¡æ•°å™¨å›ºå®šçª—å£ç®—æ³•>#</a></h2><p>è®¡æ•°å™¨ç®—æ³•æ˜¯ä½¿ç”¨è®¡æ•°å™¨åœ¨å‘¨æœŸå†…ç´¯åŠ è®¿é—®æ¬¡æ•°ï¼Œå½“è¾¾åˆ°è®¾å®šçš„é™æµå€¼æ—¶ï¼Œè§¦å‘é™æµç­–ç•¥ã€‚ä¸‹ä¸€ä¸ªå‘¨æœŸå¼€å§‹æ—¶ï¼Œè¿›è¡Œæ¸…é›¶ï¼Œé‡æ–°è®¡æ•°ã€‚</p><p>æ­¤ç®—æ³•åœ¨å•æœºè¿˜æ˜¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®ç°éƒ½éå¸¸ç®€å•ï¼Œä½¿ç”¨redisçš„incråŸå­è‡ªå¢æ€§å’Œçº¿ç¨‹å®‰å…¨å³å¯è½»æ¾å®ç°ã€‚</p><p><img loading=lazy src="Gateway.assets/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LqR54Of5oiQ6ZuoY3Nkbg==,size_20,color_FFFFFF,t_70,g_se,x_16.png" alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p>è¿™ä¸ªç®—æ³•é€šå¸¸ç”¨äºQPSé™æµå’Œç»Ÿè®¡æ€»è®¿é—®é‡ï¼Œå¯¹äºç§’çº§ä»¥ä¸Šçš„æ—¶é—´å‘¨æœŸæ¥è¯´ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯<strong>ä¸´ç•Œé—®é¢˜</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img loading=lazy src="Gateway.assets/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LqR54Of5oiQ6ZuoY3Nkbg==,size_20,color_FFFFFF,t_70,g_se,x_16-16654735261195.png" alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p>å‡è®¾1minå†…æœåŠ¡å™¨çš„è´Ÿè½½èƒ½åŠ›ä¸º100ï¼Œå› æ­¤ä¸€ä¸ªå‘¨æœŸçš„è®¿é—®é‡é™åˆ¶åœ¨100ï¼Œç„¶è€Œ<u>åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸçš„æœ€å5ç§’å’Œä¸‹ä¸€ä¸ªå‘¨æœŸçš„å¼€å§‹5ç§’æ—¶é—´æ®µå†…ï¼Œåˆ†åˆ«æ¶Œå…¥100çš„è®¿é—®é‡ï¼Œè™½ç„¶æ²¡æœ‰è¶…è¿‡æ¯ä¸ªå‘¨æœŸçš„é™åˆ¶é‡ï¼Œä½†æ˜¯æ•´ä½“ä¸Š10ç§’å†…å·²è¾¾åˆ°200çš„è®¿é—®é‡</u>ï¼Œå·²è¿œè¿œè¶…è¿‡æœåŠ¡å™¨çš„è´Ÿè½½èƒ½åŠ›ï¼Œç”±æ­¤å¯è§ï¼Œè®¡æ•°å™¨ç®—æ³•æ–¹å¼é™æµå¯¹äºå‘¨æœŸæ¯”è¾ƒé•¿çš„é™æµï¼Œå­˜åœ¨å¾ˆå¤§çš„å¼Šç«¯ã€‚</p><h2 id=2æ»‘åŠ¨çª—å£ç®—æ³•>2ã€æ»‘åŠ¨çª—å£ç®—æ³•<a hidden class=anchor aria-hidden=true href=#2æ»‘åŠ¨çª—å£ç®—æ³•>#</a></h2><p>æ»‘åŠ¨çª—å£ç®—æ³•æ˜¯å°†æ—¶é—´å‘¨æœŸåˆ†ä¸ºNä¸ªå°å‘¨æœŸï¼Œåˆ†åˆ«è®°å½•æ¯ä¸ªå°å‘¨æœŸå†…è®¿é—®æ¬¡æ•°ï¼Œå¹¶ä¸”æ ¹æ®æ—¶é—´æ»‘åŠ¨åˆ é™¤è¿‡æœŸçš„å°å‘¨æœŸã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œå‡è®¾æ—¶é—´å‘¨æœŸä¸º1minï¼Œå°†1minå†åˆ†ä¸º2ä¸ªå°å‘¨æœŸï¼Œç»Ÿè®¡æ¯ä¸ªå°å‘¨æœŸçš„è®¿é—®æ•°é‡ï¼Œåˆ™å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªæ—¶é—´å‘¨æœŸå†…ï¼Œè®¿é—®æ•°é‡ä¸º75ï¼Œç¬¬äºŒä¸ªæ—¶é—´å‘¨æœŸå†…ï¼Œè®¿é—®æ•°é‡ä¸º100ï¼Œè¶…è¿‡100çš„è®¿é—®åˆ™è¢«é™æµæ‰äº†ã€‚</p><p><img loading=lazy src="Gateway.assets/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LqR54Of5oiQ6ZuoY3Nkbg==,size_20,color_FFFFFF,t_70,g_se,x_16-16654735808358.png" alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p>ç”±æ­¤å¯è§ï¼Œå½“æ»‘åŠ¨çª—å£çš„æ ¼å­åˆ’åˆ†çš„è¶Šå¤šï¼Œé‚£ä¹ˆæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±è¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚</p><p>æ»‘åŠ¨çª—å£ç®—æ³•è™½ç„¶è§£å†³äº†å›ºå®šçª—å£çš„ä¸´ç•Œé—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦åˆ°è¾¾é™æµåï¼Œè¯·æ±‚éƒ½ä¼šç›´æ¥æš´åŠ›è¢«æ‹’ç»ã€‚é…±ç´«æˆ‘ä»¬ä¼šæŸå¤±ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œè¿™å…¶å®å¯¹äºäº§å“æ¥è¯´ï¼Œå¹¶ä¸å¤ªå‹å¥½ã€‚</p><p><a href=https://zhuanlan.zhihu.com/p/376564740 target=_blank rel=noopener>é¢è¯•å¿…å¤‡ï¼š4ç§ç»å…¸é™æµç®—æ³•è®²è§£ - çŸ¥ä¹ (zhihu.com)</a></p><h2 id=3æ¼æ¡¶ç®—æ³•>3ã€æ¼æ¡¶ç®—æ³•<a hidden class=anchor aria-hidden=true href=#3æ¼æ¡¶ç®—æ³•>#</a></h2><p>æ¼æ¡¶ç®—æ³•æ˜¯è®¿é—®è¯·æ±‚åˆ°è¾¾æ—¶ç›´æ¥æ”¾å…¥æ¼æ¡¶ï¼Œå¦‚å½“å‰å®¹é‡å·²è¾¾åˆ°ä¸Šé™ï¼ˆé™æµå€¼ï¼‰ï¼Œåˆ™è¿›è¡Œä¸¢å¼ƒï¼ˆè§¦å‘é™æµç­–ç•¥ï¼‰ã€‚æ¼æ¡¶ä»¥å›ºå®šçš„é€Ÿç‡è¿›è¡Œé‡Šæ”¾è®¿é—®è¯·æ±‚ï¼ˆå³è¯·æ±‚é€šè¿‡ï¼‰ï¼Œç›´åˆ°æ¼æ¡¶ä¸ºç©ºã€‚</p><p><img loading=lazy src="Gateway.assets/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LqR54Of5oiQ6ZuoY3Nkbg==,size_12,color_FFFFFF,t_70,g_se,x_16.png" alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><p><strong>é¢å¯¹çªå‘æµé‡çš„æ—¶å€™</strong>ï¼Œæ¼æ¡¶ç®—æ³•è¿˜æ˜¯å¾ªè§„è¹ˆçŸ©åœ°å¤„ç†è¯·æ±‚ï¼Œè¿™å°±ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„å•¦ã€‚<strong>æµé‡å˜çªå‘æ—¶</strong>ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›ç³»ç»Ÿå°½é‡å¿«ç‚¹å¤„ç†è¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒå˜›ã€‚è€Œä¸”æµé‡çš„æµå…¥å’Œæµå‡ºæ— æ³•æ§åˆ¶, é¢å¯¹çªå‘æµé‡å¤„ç†èƒ½åŠ›ä¸ä½³</p><h2 id=4ä»¤ç‰Œæ¡¶ç®—æ³•>4ã€ä»¤ç‰Œæ¡¶ç®—æ³•<a hidden class=anchor aria-hidden=true href=#4ä»¤ç‰Œæ¡¶ç®—æ³•>#</a></h2><p>ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯ç¨‹åºä»¥rï¼ˆr=æ—¶é—´å‘¨æœŸ/é™æµå€¼ï¼‰çš„é€Ÿåº¦å‘ä»¤ç‰Œæ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼Œç›´åˆ°ä»¤ç‰Œæ¡¶æ»¡ï¼Œè¯·æ±‚åˆ°è¾¾æ—¶å‘ä»¤ç‰Œæ¡¶è¯·æ±‚ä»¤ç‰Œï¼Œå¦‚è·å–åˆ°ä»¤ç‰Œåˆ™é€šè¿‡è¯·æ±‚ï¼Œå¦åˆ™è§¦å‘é™æµç­–ç•¥</p><p><img loading=lazy src="Gateway.assets/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LqR54Of5oiQ6ZuoY3Nkbg==,size_16,color_FFFFFF,t_70,g_se,x_16.png" alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°></p><blockquote><p>å¹¶ä¸èƒ½è¯´æ˜ä»¤ç‰Œæ¡¶ä¸€å®šæ¯”æ¼æ´å¥½ï¼Œå¥¹ä»¬ä½¿ç”¨åœºæ™¯ä¸ä¸€æ ·ã€‚</p><ul><li>ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œ<strong>æ”¾åœ¨æœåŠ¡ç«¯ï¼Œç”¨æ¥ä¿æŠ¤æœåŠ¡ç«¯ï¼ˆè‡ªå·±ï¼‰</strong>ï¼Œä¸»è¦ç”¨æ¥å¯¹è°ƒç”¨è€…é¢‘ç‡è¿›è¡Œé™æµï¼Œä¸ºçš„æ˜¯ä¸è®©è‡ªå·±è¢«å‹å®ã€‚æ‰€ä»¥å¦‚æœè‡ªå·±æœ¬èº«æœ‰å¤„ç†èƒ½åŠ›çš„æ—¶å€™ï¼Œå¦‚æœæµé‡çªå‘ï¼ˆå®é™…æ¶ˆè´¹èƒ½åŠ›å¼ºäºé…ç½®çš„æµé‡é™åˆ¶=æ¡¶å¤§å°ï¼‰ï¼Œé‚£ä¹ˆå®é™…å¤„ç†é€Ÿç‡å¯ä»¥è¶…è¿‡é…ç½®çš„é™åˆ¶ï¼ˆæ¡¶å¤§å°ï¼‰ã€‚</li><li>è€Œæ¼æ¡¶ç®—æ³•ï¼Œ<strong>æ”¾åœ¨è°ƒç”¨æ–¹ï¼Œè¿™æ˜¯ç”¨æ¥ä¿æŠ¤ä»–äºº</strong>ï¼Œä¹Ÿå°±æ˜¯ä¿æŠ¤ä»–æ‰€è°ƒç”¨çš„ç³»ç»Ÿã€‚ä¸»è¦åœºæ™¯æ˜¯ï¼Œå½“è°ƒç”¨çš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿæœ¬èº«æ²¡æœ‰ä¿æŠ¤æœºåˆ¶ï¼Œæˆ–è€…æœ‰æµé‡é™åˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„è°ƒç”¨é€Ÿåº¦ä¸èƒ½è¶…è¿‡ä»–çš„é™åˆ¶ï¼Œç”±äºæˆ‘ä»¬ä¸èƒ½æ›´æ”¹ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œæ‰€ä»¥åªæœ‰åœ¨ä¸»è°ƒæ–¹æ§åˆ¶ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿æµé‡çªå‘ï¼Œä¹Ÿå¿…é¡»èˆå¼ƒã€‚å› ä¸ºæ¶ˆè´¹èƒ½åŠ›æ˜¯ç¬¬ä¸‰æ–¹å†³å®šçš„ã€‚</li></ul></blockquote><p><a href=https://blog.csdn.net/qq_43437874/article/details/121631446 target=_blank rel=noopener>Spring Cloud Gatewayç³»åˆ—ã€12ã€‘ é™æµç®—æ³•ä½¿ç”¨æ¡ˆä¾‹è¯¦è§£åŠæºç åˆ†æ_äº‘çƒŸæˆé›¨TDçš„åšå®¢-CSDNåšå®¢</a></p><p><a href=https://www.cnblogs.com/shoshana-kong/p/14759604.html target=_blank rel=noopener>å¸¸è§é™æµç®—æ³•ä»‹ç»ï¼ˆæ¼æ¡¶ç®—æ³•ã€ä»¤ç‰Œæ¡¶ç®—æ³•ï¼‰åŠå®ç°&ndash;å¾…æ•´ç† - æœˆæŸ“éœœå - åšå®¢å›­ (cnblogs.com)</a></p><p>æ‰©å±•é˜…è¯»: <a href=https://houbb.github.io/2018/12/23/ha-limit-07-token-bucket#%e5%8e%9f%e7%90%86 target=_blank rel=noopener>é«˜å¯ç”¨ä¹‹é™æµ-07-token bucket ä»¤ç‰Œæ¡¶ç®—æ³• | Echo Blog (houbb.github.io)</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.github.io/myBlog/zh/tags/spring_cloud/>Spring_Cloud</a></li><li><a href=https://xiaokunji.github.io/myBlog/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/>javaåŠå…¶æ¡†æ¶</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.github.io/myBlog/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91/forkjoin/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>ForkJoin</span></a>
<a class=next href=https://xiaokunji.github.io/myBlog/zh/%E7%BB%BC%E5%90%88/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/git%E5%92%8Csvn/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>gitå’Œsvn</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.github.io/myBlog/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>