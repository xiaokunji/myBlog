<!DOCTYPE html>
<html dir="auto" lang="zh"><head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"/><meta content="index, follow" name="robots"/><title>openFeign | ç±³äºŒ</title>
<meta content=" å‰è¨€, Feign çš„å¯åŠ¨åŸç†, æ³¨å…¥@Import, æ·»åŠ å…¨å±€é…ç½®, æ³¨å†Œ FeignClient æ¥å£, FeignClientFactoryBean , æ„é€  feign.Builderå¯¹è±¡, åŠ¨æ€ä»£ç†ç”Ÿæˆ, ç”Ÿæˆä»£ç†ç±», Feign å¦‚ä½•è´Ÿè½½å‡è¡¡, æ—¥å¿—é…ç½®, ä½¿ç”¨okHttp, ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥" name="keywords"/><meta content="OpenFeginå¯åŠ¨åŸç†ä»¥åŠæºç è§£æ" name="description"/><meta content="xkj" name="author"/><link href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/OpenFeign.html" rel="canonical"/><link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.dc6bd2c841ee388e899e13872ae986c0e847e8b957d6714ad6ddc628ef2d17ff.css" integrity="sha256-3GvSyEHuOI6JnhOHKumGwOhH6LlX1nFK1t3GKO8tF/8=" rel="preload stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js"></script><link href="https://xiaokunji.com/img/Q.svg" rel="icon"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="16x16" type="image/png"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="32x32" type="image/png"/><link href="https://xiaokunji.com/Q.svg" rel="apple-touch-icon"/><link href="https://xiaokunji.com/Q.svg" rel="mask-icon"/><meta content="#2e2e33" name="theme-color"/><meta content="#2e2e33" name="msapplication-TileColor"/><link href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/OpenFeign.html" hreflang="zh" rel="alternate"/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta content="openFeign" property="og:title"/><meta content="OpenFeginå¯åŠ¨åŸç†ä»¥åŠæºç è§£æ" property="og:description"/><meta content="article" property="og:type"/><meta content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/OpenFeign.html" property="og:url"/><meta content="javaåŠå…¶æ¡†æ¶" property="article:section"/><meta content="2023-09-01T00:00:00+00:00" property="article:published_time"/><meta content="2023-11-01T17:59:53+08:00" property="article:modified_time"/><meta content="summary" name="twitter:card"/><meta content="openFeign" name="twitter:title"/><meta content="OpenFeginå¯åŠ¨åŸç†ä»¥åŠæºç è§£æ" name="twitter:description"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"openFeign","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/OpenFeign.html"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"openFeign","name":"openFeign","description":"OpenFeginå¯åŠ¨åŸç†ä»¥åŠæºç è§£æ","keywords":[" å‰è¨€"," Feign çš„å¯åŠ¨åŸç†"," æ³¨å…¥@Import"," æ·»åŠ å…¨å±€é…ç½®"," æ³¨å†Œ FeignClient æ¥å£"," FeignClientFactoryBean "," æ„é€  feign.Builderå¯¹è±¡"," åŠ¨æ€ä»£ç†ç”Ÿæˆ"," ç”Ÿæˆä»£ç†ç±»"," Feign å¦‚ä½•è´Ÿè½½å‡è¡¡"," æ—¥å¿—é…ç½®"," ä½¿ç”¨okHttp"," ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥"],"articleBody":"[toc]\nå‰è¨€ OpenFeign å…¨ç§° Spring Cloud OpenFeignï¼Œå®ƒæ˜¯ Spring å®˜æ–¹æ¨å‡ºçš„ä¸€ç§å£°æ˜å¼æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œå®ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†æ›¿ä»£è¿›å…¥åœæ›´ç»´æŠ¤çŠ¶æ€çš„ Feignã€‚OpenFeign æ˜¯ Spring Cloud å¯¹ Feign çš„äºŒæ¬¡å°è£…ï¼Œå®ƒå…·æœ‰ Feign çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶åœ¨ Feign çš„åŸºç¡€ä¸Šå¢åŠ äº†å¯¹ Spring MVC æ³¨è§£çš„æ”¯æŒï¼Œä¾‹å¦‚ @RequestMappingã€@GetMapping å’Œ @PostMapping ç­‰ã€‚\nOpenFeignï¼šSpring Cloudå£°æ˜å¼æœåŠ¡è°ƒç”¨ç»„ä»¶ï¼ˆéå¸¸è¯¦ç»†ï¼‰ (biancheng.net) æœ¬æ–‡ç« åŸºäºopenFeign 2.X\nFeign çš„å¯åŠ¨åŸç† æ³¨å…¥@Import æˆ‘ä»¬åœ¨ä½¿ç”¨OpenFeginæ—¶, éœ€è¦åŠ @EnableFeignClients, æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ³¨è§£\n@Retention(RetentionPolicy.RUNTIME) @Target(ElementType.TYPE) @Documented @Import(FeignClientsRegistrar.class) public @interface EnableFeignClients {...} é‡ç‚¹åœ¨ç¬¬å››ä¸ª @Import ä¸Šï¼Œä¸€èˆ¬ä½¿ç”¨æ­¤æ³¨è§£éƒ½æ˜¯æƒ³è¦åŠ¨æ€æ³¨å†Œ Spring Bean çš„\nclass FeignClientsRegistrar implements ImportBeanDefinitionRegistrar, ResourceLoaderAware, EnvironmentAware { // ..... // èµ„æºåŠ è½½å™¨ï¼Œå¯ä»¥åŠ è½½ classpath ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ private ResourceLoader resourceLoader; // ä¸Šä¸‹æ–‡ï¼Œå¯é€šè¿‡è¯¥ç¯å¢ƒè·å–å½“å‰åº”ç”¨é…ç½®å±æ€§ç­‰ private Environment environment; @Override public void setEnvironment(Environment environment) { this.environment = environment; } @Override public void setResourceLoader(ResourceLoader resourceLoader) { this.resourceLoader = resourceLoader; } @Override public void registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) { // æ³¨å†Œ ï¼ EnableFeignClients æä¾›çš„è‡ªå®šä¹‰é…ç½®ç±»ä¸­çš„ç›¸å…³ Bean å®ä¾‹ registerDefaultConfiguration(metadata,registry); // æ‰«æ packgeï¼Œæ³¨å†Œè¢« @FeignClient ä¿®é¥°çš„æ¥å£ç±»ä¸º IOC Bean registerFeignClients(metadata, registry); } // ..... } å…¶ä¸­ ImportBeanDefinitionRegistrar è´Ÿè´£åŠ¨æ€æ³¨å…¥ IOC Beanï¼Œå®ƒæœ‰ä¸€ä¸ªregisterBeanDefinitions(), ç”¨æ¥åšbeançš„æ³¨å…¥å…·ä½“é€»è¾‘,\nFeignClientsRegistraråˆ†åˆ«æ³¨å…¥äº† Feign é…ç½®ç±»ã€FeignClient Bean,\næ·»åŠ å…¨å±€é…ç½® registerDefaultConfiguration æ–¹æ³•æµç¨‹å¦‚ä¸‹\nè·å– @EnableFeignClients æ³¨è§£ä¸Šçš„å±æ€§ä»¥åŠå¯¹åº” Value ç”Ÿæˆ FeignClientSpecificationï¼ˆå­˜å‚¨ Feign ä¸­çš„é…ç½®ç±»ï¼‰ å¯¹åº”çš„æ„é€ å™¨ BeanDefinitionBuilder FeignClientSpecification Bean åç§°ä¸º default. + @EnableFeignClients ä¿®é¥°ç±»å…¨é™å®šåç§° + FeignClientSpecification @EnableFeignClients defaultConfiguration é»˜è®¤ä¸º {}ï¼Œå¦‚æœæ²¡æœ‰ç›¸å…³é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ FeignClientsConfiguration å¹¶ç»“åˆ name å¡«å……åˆ° FeignClientSpecificationï¼Œæœ€ç»ˆæ³¨å†Œä¸º IOC Bean æ³¨å†Œ FeignClient æ¥å£ å°†é‡ç‚¹æ”¾åœ¨ registerFeignClients ä¸Šï¼Œè¯¥æ–¹æ³•ä¸»è¦å°±æ˜¯å°†ä¿®é¥°äº† @FeignClient çš„æ¥å£æ³¨å†Œä¸º IOC Bean\næ‰«æ @EnableFeignClients æ³¨è§£ï¼Œå¦‚æœæœ‰ clientsï¼Œåˆ™åŠ è½½æŒ‡å®šæ¥å£ï¼Œä¸ºç©ºåˆ™æ ¹æ® scanner è§„åˆ™æ‰«æå‡ºä¿®é¥°äº† @FeignClient çš„æ¥å£\nè·å– @FeignClient ä¸Šå¯¹åº”çš„å±æ€§ï¼Œæ ¹æ® configuration å±æ€§å»åˆ›å»ºæ¥å£çº§çš„ FeignClientSpecification é…ç½®ç±» IOC Bean\nå°† @FeignClient çš„å±æ€§è®¾ç½®åˆ° FeignClientFactoryBean å¯¹è±¡ä¸Šï¼Œå¹¶æ³¨å†Œ IOC Bean\n@FengnClient ä¿®é¥°çš„æ¥å£å®é™…ä¸Šä½¿ç”¨äº† Spring çš„ä»£ç†å·¥å‚ç”Ÿæˆä»£ç†ç±»ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæŠŠä¿®é¥°äº† @FeignClient æ¥å£çš„ BeanDefinition è®¾ç½®ä¸º FeignClientFactoryBean ç±»å‹ï¼Œè€Œ FeignClientFactoryBean ç»§æ‰¿è‡ª FactoryBean\nä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬å®šä¹‰ @FeignClient ä¿®é¥°æ¥å£æ—¶ï¼Œæ³¨å†Œåˆ° IOC å®¹å™¨ä¸­ Bean ç±»å‹å˜æˆäº† FeignClientFactoryBean\nåœ¨ Spring ä¸­ï¼ŒFactoryBean æ˜¯ä¸€ä¸ªå·¥å‚ Beanï¼Œç”¨æ¥åˆ›å»ºä»£ç† Beanã€‚å·¥å‚ Bean æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Beanï¼Œå¯¹äºéœ€è¦è·å– Bean çš„æ¶ˆè´¹è€…è€Œè¨€ï¼Œå®ƒæ˜¯ä¸çŸ¥é“ Bean æ˜¯æ™®é€š Bean æˆ–æ˜¯å·¥å‚ Bean çš„ã€‚å·¥å‚ Bean è¿”å›çš„å®ä¾‹ä¸æ˜¯å·¥å‚ Bean æœ¬èº«ï¼Œè€Œæ˜¯ä¼šè¿”å›æ‰§è¡Œäº†å·¥å‚ Bean ä¸­ FactoryBean#getObject é€»è¾‘çš„å®ä¾‹\nä»¥åå¯ä»¥å†™ä¸€ç¯‡FactoryBeançš„æ–‡ç« \nFeignClientFactoryBean è·å¾—å…·ä½“beançš„æ–¹æ³•\næ„é€  feign.Builderå¯¹è±¡ \u003cT\u003e T getTarget() { FeignContext context = applicationContext.getBean(FeignContext.class); // æ‹¿åˆ° Feign.Builder Feign.Builder builder = feign(context); if (!StringUtils.hasText(url)) { if (!name.startsWith(\"http\")) { url = \"http://\" + name; } else { url = name; } url += cleanPath(); // é€šè¿‡è´Ÿè½½æ‹¿åˆ°bean return (T) loadBalance(builder, context, new HardCodedTarget\u003c\u003e(type, name, url)); } ....// çœç•¥ä»£ç  } org.springframework.cloud.openfeign.FeignClientFactoryBean#feign\nprotected Feign.Builder feign(FeignContext context) { FeignLoggerFactory loggerFactory = get(context, FeignLoggerFactory.class); Logger logger = loggerFactory.create(type); // ä»contextæ‹¿å‡º encoder , Decoder , Contract å¯¹è±¡ Feign.Builder builder = get(context, Feign.Builder.class) // required values .logger(logger) .encoder(get(context, Encoder.class)) .decoder(get(context, Decoder.class)) .contract(get(context, Contract.class)); // é…ç½®feign, ä¾‹å¦‚ è¶…æ—¶ã€é‡è¯•ã€404 é…ç½®, é”™è¯¯Encode, æ‹¦æˆªå™¨ç­‰ç­‰ configureFeign(context, builder); return builder; } åŠ¨æ€ä»£ç†ç”Ÿæˆ org.springframework.cloud.openfeign.FeignClientFactoryBean#loadBalance\nClientï¼š Feign å‘é€è¯·æ±‚ä»¥åŠæ¥æ”¶å“åº”ç­‰éƒ½æ˜¯ç”± Client å®Œæˆï¼Œè¯¥ç±»é»˜è®¤ Client.Defaultï¼Œå¦å¤–æ”¯æŒ HttpClientã€OkHttp ç­‰å®¢æˆ·ç«¯\nç„¶åè¿›å…¥org.springframework.cloud.openfeign.HystrixTargeter#target\nç„¶åæ„å»ºäº†feginå¯¹è±¡ feign.Feign.Builder#target(feign.Target)\npublic \u003cT\u003e T target(Target\u003cT\u003e target) { return build().newInstance(target); } public Feign build() { Client client = Capability.enrich(this.client, capabilities); Retryer retryer = Capability.enrich(this.retryer, capabilities); List\u003cRequestInterceptor\u003e requestInterceptors = this.requestInterceptors.stream() .map(ri -\u003e Capability.enrich(ri, capabilities)) .collect(Collectors.toList()); Logger logger = Capability.enrich(this.logger, capabilities); Contract contract = Capability.enrich(this.contract, capabilities); Options options = Capability.enrich(this.options, capabilities); Encoder encoder = Capability.enrich(this.encoder, capabilities); Decoder decoder = Capability.enrich(this.decoder, capabilities); InvocationHandlerFactory invocationHandlerFactory = Capability.enrich(this.invocationHandlerFactory, capabilities); QueryMapEncoder queryMapEncoder = Capability.enrich(this.queryMapEncoder, capabilities); SynchronousMethodHandler.Factory synchronousMethodHandlerFactory = new SynchronousMethodHandler.Factory(client, retryer, requestInterceptors, logger, logLevel, decode404, closeAfterDecode, propagationPolicy, forceDecoding); ParseHandlersByName handlersByName = new ParseHandlersByName(contract, options, encoder, decoder, queryMapEncoder, errorDecoder, synchronousMethodHandlerFactory); return new ReflectiveFeign(handlersByName, invocationHandlerFactory, queryMapEncoder); } } ç”Ÿæˆä»£ç†ç±» feign.ReflectiveFeign#newInstance\nnewInstance æ–¹æ³•å¯¹ @FeignClient ä¿®é¥°çš„æ¥å£ä¸­ SpringMvc ç­‰é…ç½®è¿›è¡Œè§£æè½¬æ¢ï¼Œå¯¹æ¥å£ç±»ä¸­çš„æ–¹æ³•è¿›è¡Œå½’ç±»ï¼Œç”ŸæˆåŠ¨æ€ä»£ç†ç±»\næ ¹æ® newInstance æ–¹æ³•æŒ‰ç…§è¡Œä¸ºå¤§è‡´åˆ’åˆ†ï¼Œå…±åšäº†å››ä»¶äº‹\nå¤„ç† @FeignCLient æ³¨è§£ï¼ˆSpringMvc æ³¨è§£ç­‰ï¼‰å°è£…ä¸º MethodHandler åŒ…è£…ç±» éå†æ¥å£ä¸­æ‰€æœ‰æ–¹æ³•ï¼Œè¿‡æ»¤ Object æ–¹æ³•ï¼Œå¹¶å°†é»˜è®¤æ–¹æ³•ä»¥åŠ FeignClient æ–¹æ³•åˆ†ç±», å¹¶åˆ›å»ºæ”¶é›†èµ·æ¥ åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹åº”çš„ InvocationHandler å¹¶åˆ›å»º Proxy å®ä¾‹ æ¥å£å†… default æ–¹æ³• ç»‘å®šåŠ¨æ€ä»£ç†ç±» MethodHandler å°†æ–¹æ³•å‚æ•°ã€æ–¹æ³•è¿”å›å€¼ã€å‚æ•°é›†åˆã€è¯·æ±‚ç±»å‹ã€è¯·æ±‚è·¯å¾„è¿›è¡Œè§£æå­˜å‚¨\nåœ¨åˆ›å»ºInvocationHandleræ—¶, åˆ›å»ºçš„å…¶å®ç°ç±»æ˜¯ feign.ReflectiveFeign.FeignInvocationHandler\nInvocationHandler handler = factory.create(target, methodToHandler); public interface InvocationHandlerFactory { InvocationHandler create(Target target, Map\u003cMethod, MethodHandler\u003e dispatch); /** * Like {@link InvocationHandler#invoke(Object, java.lang.reflect.Method, Object[])}, except for a * single method. */ interface MethodHandler { Object invoke(Object[] argv) throws Throwable; } static final class Default implements InvocationHandlerFactory { @Override public InvocationHandler create(Target target, Map\u003cMethod, MethodHandler\u003e dispatch) { return new ReflectiveFeign.FeignInvocationHandler(target, dispatch); } } } ä»¥ä¸Š, åœ¨é¡¹ç›®å¯åŠ¨æ—¶å¤„ç†\nä»¥åè¡¥ä¸€ç¯‡jdkåŠ¨æ€ä»£ç†\nåœ¨æˆ‘ä»¬è°ƒç”¨ @FeignClient æ¥å£æ—¶ï¼Œä¼šè¢« FeignInvocationHandler#invoke æ‹¦æˆªï¼Œå¹¶åœ¨åŠ¨æ€ä»£ç†æ–¹æ³•ä¸­æ‰§è¡Œä¸‹è¿°é€»è¾‘\næ¥å£æ³¨è§£ä¿¡æ¯å°è£…ä¸º HTTP Request é€šè¿‡ Ribbon è·å–æœåŠ¡åˆ—è¡¨ï¼Œå¹¶å¯¹æœåŠ¡åˆ—è¡¨è¿›è¡Œè´Ÿè½½å‡è¡¡è°ƒç”¨ï¼ˆæœåŠ¡åè½¬æ¢ä¸º ip+portï¼‰ è¯·æ±‚è°ƒç”¨åï¼Œå°†è¿”å›çš„æ•°æ®å°è£…ä¸º HTTP Responseï¼Œç»§è€Œè½¬æ¢ä¸ºæ¥å£ä¸­çš„è¿”å›ç±»å‹ feign.ReflectiveFeign.FeignInvocationHandler#invoke\n@Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { if (\"equals\".equals(method.getName())) { try { Object otherHandler = args.length \u003e 0 \u0026\u0026 args[0] != null ? Proxy.getInvocationHandler(args[0]) : null; return equals(otherHandler); } catch (IllegalArgumentException e) { return false; } } else if (\"hashCode\".equals(method.getName())) { return hashCode(); } else if (\"toString\".equals(method.getName())) { return toString(); } // è¿™ä¸ªdispatch å°±æ˜¯ methodToHandler é›†åˆ // å…¶ç»“æ„ : private final Map dispatch; return dispatch.get(method).invoke(args); // å®ƒåå°„çš„æ—¶å€™ç”¨çš„æ˜¯Methodç±», æ‰€ä»¥feignæ¥å£æ˜¯å…è®¸é‡è½½çš„, mybatisçš„åå°„xmlçš„æ¥å£ä¸å…è®¸é‡è½½çš„ } æ‰§è¡Œå…·ä½“æ–¹æ³•çš„invoke\nfeign.SynchronousMethodHandler#invoke\n@Override public Object invoke(Object[] argv) throws Throwable { // æ„å»º Request æ¨¡ç‰ˆç±» RequestTemplate template = buildTemplateFromArgs.create(argv); // å­˜æ”¾è¿æ¥ã€è¶…æ—¶æ—¶é—´ç­‰é…ç½®ç±» Options options = findOptions(argv); å¤±è´¥é‡è¯•ç­–ç•¥ç±» Retryer retryer = this.retryer.clone(); while (true) { try { // æ‰§è¡Œ return executeAndDecode(template, options); } catch (RetryableException e) { try { // é‡è¯•æ“ä½œ retryer.continueOrPropagate(e); } catch (RetryableException th) { Throwable cause = th.getCause(); if (propagationPolicy == UNWRAP \u0026\u0026 cause != null) { throw cause; } else { throw th; } } if (logLevel != Logger.Level.NONE) { logger.logRetry(metadata.configKey(), logLevel); } continue; } } } Object executeAndDecode(RequestTemplate template, Options options) throws Throwable { Request request = targetRequest(template); if (logLevel != Logger.Level.NONE) { logger.logRequest(metadata.configKey(), logLevel, request); } Response response; long start = System.nanoTime(); try { // æ‰§è¡Œ response = client.execute(request, options); // ensure the request is set. TODO: remove in Feign 12 response = response.toBuilder() .request(request) .requestTemplate(template) .build(); } catch (IOException e) { if (logLevel != Logger.Level.NONE) { logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime(start)); } throw errorExecuting(request, e); } long elapsedTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start); if (decoder != null) // decode è´£ä»»é“¾ return decoder.decode(response, metadata.returnType()); ......// çœç•¥ä»£ç  } ç„¶å org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient#execute\nç„¶å com.netflix.client.AbstractLoadBalancerAwareClient#executeWithLoadBalancer(S, com.netflix.client.config.IClientConfig)\næ‰§è¡Œè¿œç«¯è°ƒç”¨é€»è¾‘ä¸­ä½¿ç”¨åˆ°äº† Rxjava ï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡åº•å±‚è·å– server åå°†æœåŠ¡åç§°è½¬å˜ä¸º ip+port çš„æ–¹å¼\npublic T executeWithLoadBalancer(final S request, final IClientConfig requestConfig) throws ClientException { LoadBalancerCommand\u003cT\u003e command = buildLoadBalancerCommand(request, requestConfig); try { return command.submit( // è¿™ç‰¹ä¹ˆæ˜¯ä¸ªå‚æ•°-----å‚æ•°å¼€å§‹ new ServerOperation\u003cT\u003e() { @Override public Observable\u003cT\u003e call(Server server) { // æ‹¿åˆ°äº†å…·ä½“çš„ip+port URI finalUri = reconstructURIWithServer(server, request.getUri()); S requestForServer = (S) request.replaceUri(finalUri); try { return Observable.just(AbstractLoadBalancerAwareClient.this.execute(requestForServer, requestConfig)); } catch (Exception e) { return Observable.error(e); } } })// å‚æ•°ç»“æŸ .toBlocking() .single(); } catch (Exception e) { Throwable t = e.getCause(); if (t instanceof ClientException) { throw (ClientException) t; } else { throw new ClientException(e); } } } public Observable submit(final ServerOperation operation) {} submitæ–¹æ³•æœ‰ä¸ªå…¥å‚, å°±æ˜¯é‚£ä¸€å¤§å¨\nç½‘ç»œè°ƒç”¨é»˜è®¤ä½¿ç”¨ JDK çš„ HttpURLConnectionï¼Œå¯ä»¥é…ç½®ä½¿ç”¨ HttpClient æˆ–è€… OkHttp\nå…·ä½“æ€ä¹ˆæ‹¿åˆ°ipå’Œportçš„, å°±æ˜¯æ¥ä¸‹æ¥çš„è´Ÿè´£å‡è¡¡çŸ¥è¯†äº†\nFeign å¦‚ä½•è´Ÿè½½å‡è¡¡ ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ç”Ÿäº§è€…æ³¨å†Œå¤šä¸ªæœåŠ¡ï¼Œæ¶ˆè´¹è€…è°ƒç”¨æ—¶éœ€è¦ä½¿ç”¨è´Ÿè½½å‡è¡¡ä»ä¸­ è½®è¯¢æœºåˆ¶é€‰å–ä¸€ä¸ªå¥åº·å¹¶ä¸”å¯ç”¨çš„ç”Ÿäº§è€…æœåŠ¡\né»˜è®¤æ˜¯è½®è¯¢æœºåˆ¶, å¯ä»¥ä¿®æ”¹\nopenFegin 2.X æ‰æœ‰è´Ÿè½½å‡è¡¡ , 3.0 ä¹‹åå°±ç§»é™¤äº†Ribbon, ä¸€èˆ¬ç”¨spring-cloud-starter-loadbalancerä»£æ›¿\ncom.netflix.loadbalancer.reactive.LoadBalancerCommand#selectServer\nå› ä¸º Feign å†…éƒ¨é›†æˆ Ribbonï¼Œæ‰€ä»¥ä¹Ÿæ”¯æŒæ­¤ç‰¹æ€§ï¼Œä¸€èµ·çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆåšçš„\ngetServerFromLoadBalancer()\npublic Server getServerFromLoadBalancer(@Nullable URI original, @Nullable Object loadBalancerKey) throws ClientException { String host = null; int port = -1; if (original != null) { host = original.getHost(); } if (original != null) { Pair\u003cString, Integer\u003e schemeAndPort = deriveSchemeAndPortFromPartialUri(original); port = schemeAndPort.second(); } // Various Supported Cases // The loadbalancer to use and the instances it has is based on how it was registered // In each of these cases, the client might come in using Full Url or Partial URL ILoadBalancer lb = getLoadBalancer(); if (host == null) { // Partial URI or no URI Case // well we have to just get the right instances from lb - or we fall back if (lb != null){ // é€‰æ‹©å‡ºåˆé€‚çš„æœåŠ¡ Server svc = lb.chooseServer(loadBalancerKey); if (svc == null){ throw new ClientException(ClientException.ErrorType.GENERAL, \"Load balancer does not have available server for client: \" + clientName); } host = svc.getHost(); if (host == null){ throw new ClientException(ClientException.ErrorType.GENERAL, \"Invalid Server for :\" + svc); } logger.debug(\"{} using LB returned Server: {} for request {}\", new Object[]{clientName, svc, original}); return svc; } ......// çœç•¥ä»£ç  è¿›å…¥æŒ‰ç©ºé—´ä½ç½®è·å–æœåŠ¡\ncom.netflix.loadbalancer.ZoneAwareLoadBalancer#chooseServer\n/** * æœ€ç»ˆéƒ½æ˜¯ä½¿ç”¨çˆ¶çº§çš„ chooseServer() * å¦‚æœæœ‰å¤šä¸ªåŒºåŸŸ, å°±éšæœºé€‰ä¸€ä¸ª */ public Server chooseServer(Object key) { // å¦‚æœåªæœ‰ä¸€ä¸ªåŒºåŸŸç›´æ¥ä½¿ç”¨çˆ¶çº§çš„ if (!ENABLED.get() || getLoadBalancerStats().getAvailableZones().size() \u003c= 1) { logger.debug(\"Zone aware logic disabled or there is only one zone\"); return super.chooseServer(key); } Server server = null; try { LoadBalancerStats lbStats = getLoadBalancerStats(); Map\u003cString, ZoneSnapshot\u003e zoneSnapshot = ZoneAvoidanceRule.createSnapshot(lbStats); logger.debug(\"Zone snapshots: {}\", zoneSnapshot); if (triggeringLoad == null) { triggeringLoad = DynamicPropertyFactory.getInstance().getDoubleProperty( \"ZoneAwareNIWSDiscoveryLoadBalancer.\" + this.getName() + \".triggeringLoadPerServerThreshold\", 0.2d); } if (triggeringBlackoutPercentage == null) { triggeringBlackoutPercentage = DynamicPropertyFactory.getInstance().getDoubleProperty( \"ZoneAwareNIWSDiscoveryLoadBalancer.\" + this.getName() + \".avoidZoneWithBlackoutPercetage\", 0.99999d); } // æ‹¿åˆ°å¯ç”¨çš„åŒºåŸŸåˆ—è¡¨ Set\u003cString\u003e availableZones = ZoneAvoidanceRule.getAvailableZones(zoneSnapshot, triggeringLoad.get(), triggeringBlackoutPercentage.get()); logger.debug(\"Available zones: {}\", availableZones); if (availableZones != null \u0026\u0026 availableZones.size() \u003c zoneSnapshot.keySet().size()) { // éšæœºç®—ä¸€ä¸ªåŒºåŸŸ String zone = ZoneAvoidanceRule.randomChooseZone(zoneSnapshot, availableZones); logger.debug(\"Zone chosen: {}\", zone); if (zone != null) { // æ‹¿åˆ°å…·ä½“çš„è´Ÿè½½å‡è¡¡è§„åˆ™ BaseLoadBalancer zoneLoadBalancer = getLoadBalancer(zone); // æ ¹æ®è§„åˆ™è·å–æœåŠ¡ä¿¡æ¯ server = zoneLoadBalancer.chooseServer(key); } } } catch (Exception e) { logger.error(\"Error choosing server using zone aware logic for load balancer={}\", name, e); } if (server != null) { return server; } else { logger.debug(\"Zone avoidance logic is not invoked.\"); return super.chooseServer(key); } å¯ç”¨çš„åˆ¤æ–­åŒ…æ‹¬ æ˜¯å¦æœ‰å­˜æ´»èŠ‚ç‚¹; ç†”æ–­æ¬¡æ•°ä¸èƒ½å¤ªå¤šç­‰ç­‰\næ‹¿åˆ°è´Ÿè½½å‡è¡¡å¯¹è±¡\ncom.netflix.loadbalancer.ZoneAwareLoadBalancer#getLoadBalancer\nBaseLoadBalancer getLoadBalancer(String zone) { zone = zone.toLowerCase(); BaseLoadBalancer loadBalancer = balancers.get(zone); if (loadBalancer == null) { // We need to create rule object for load balancer for each zone // æ‹¿åˆ°å…·ä½“çš„è§„åˆ™ , é»˜è®¤æ˜¯è½®è¯¢ IRule rule = cloneRule(this.getRule()); loadBalancer = new BaseLoadBalancer(this.getName() + \"_\" + zone, rule, this.getLoadBalancerStats()); BaseLoadBalancer prev = balancers.putIfAbsent(zone, loadBalancer); if (prev != null) { loadBalancer = prev; } } return loadBalancer; } com.netflix.loadbalancer.BaseLoadBalancer#getRule\nprivate final static IRule DEFAULT_RULE = new RoundRobinRule(); protected IRule rule = DEFAULT_RULE; public IRule getRule() { return rule; } æ‹¿åˆ°è§„åˆ™å, è°ƒç”¨chooseServer()\ncom.netflix.loadbalancer.BaseLoadBalancer#chooseServer\nè°ƒç”¨äº†å…¶ä¸‹å®ç°ç±»\ncom.netflix.loadbalancer.RoundRobinRule#choose(com.netflix.loadbalancer.ILoadBalancer, java.lang.Object)\npublic Server choose(ILoadBalancer lb, Object key) { if (lb == null) { log.warn(\"no load balancer\"); return null; } Server server = null; int count = 0; while (server == null \u0026\u0026 count++ \u003c 10) { List\u003cServer\u003e reachableServers = lb.getReachableServers(); // æ‰€æœ‰æœåŠ¡çš„ip + port List\u003cServer\u003e allServers = lb.getAllServers(); int upCount = reachableServers.size(); int serverCount = allServers.size(); if ((upCount == 0) || (serverCount == 0)) { log.warn(\"No up servers available from load balancer: \" + lb); return null; } // ä¸‹ä¸€ä¸ªæœåŠ¡çš„ä¸‹æ ‡ int nextServerIndex = incrementAndGetModulo(serverCount); server = allServers.get(nextServerIndex); if (server == null) { /* Transient. */ Thread.yield(); continue; } if (server.isAlive() \u0026\u0026 (server.isReadyToServe())) { return (server); } // Next. server = null; } if (count \u003e= 10) { log.warn(\"No available alive servers after 10 tries from load balancer: \" + lb); } return server; } com.netflix.loadbalancer.RoundRobinRule#incrementAndGetModulo\nprivate int incrementAndGetModulo(int modulo) { for (;;) { // AtomicInteger nextServerCyclicCounter = nextServerCyclicCounter = new AtomicInteger(0); ç±»åˆå§‹åŒ–æ—¶ åˆå§‹åŒ–äº†å˜é‡ int current = nextServerCyclicCounter.get(); int next = (current + 1) % modulo; if (nextServerCyclicCounter.compareAndSet(current, next)) return next; } } æ—¥å¿—é…ç½® 3ã€openFeignæ—¥å¿—é…ç½®_æé’±è‡ªå¾‹çš„åšå®¢-CSDNåšå®¢_openfeignæ—¥å¿— æ³¨æ„: feignè°ƒè¯•æ—¥å¿—æ˜¯debugçº§åˆ«è¾“å‡º,springbooté»˜è®¤çš„æ—¥å¿—çº§åˆ«æ˜¯infoï¼Œæ‰€ä»¥è¦è°ƒèŠ‚springbootçš„æ—¥å¿—çº§åˆ«(å¯ä»¥æŒ‡å®šç›®å½•çš„è°ƒèŠ‚)\nä½¿ç”¨okHttp Feignã€httpclientã€OkHttp3 ç»“åˆä½¿ç”¨ - ç–¯ç‹‚åˆ›å®¢åœˆ - åšå®¢å›­ (cnblogs.com) ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥ OpenFeignä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥_ä¸€è§‰ç¡è¿‡å¤´çš„èœé¸¡çš„åšå®¢-CSDNåšå®¢_openfeignè´Ÿè½½å‡è¡¡ æŒæ¡ SpringCloud OpenFeign æ ¸å¿ƒåŸç† - çŸ¥ä¹ (zhihu.com) æ¨èæ–‡ç« :\nä¸‡å­—é•¿æ–‡ | æ·±å…¥ç†è§£ OpenFeign çš„æ¶æ„åŸç† (qq.com) ","wordCount":"3750","inLanguage":"zh","datePublished":"2023-09-01T00:00:00Z","dateModified":"2023-11-01T17:59:53+08:00","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/OpenFeign.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class="dark" id="top"><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class="header"><nav class="nav"><div class="logo"><a accesskey="h" href="https://xiaokunji.com/zh/" title="ç±³äºŒ (Alt + H)"><img alt="" aria-label="logo" height="35" src="https://xiaokunji.com/img/Q.svg"/>ç±³äºŒ</a><div class="logo-switches"><button accesskey="t" id="theme-toggle" title="(Alt + T)"><svg fill="none" height="18" id="moon" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg><svg fill="none" height="18" id="sun" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg></button><ul class="lang-switch"><li>|</li><li><a aria-label="English" href="https://xiaokunji.com/en/" title="English">English</a></li></ul></div></div><ul id="menu"><li><a href="https://xiaokunji.com/zh/" title="ğŸ ä¸»é¡µ"><span>ğŸ ä¸»é¡µ</span></a></li><li><a accesskey="/" href="https://xiaokunji.com/zh/search" title="ğŸ”æœç´¢ (Alt + /)"><span>ğŸ”æœç´¢</span></a></li><li><a href="https://xiaokunji.com/zh/post.html" title="ğŸ“šæ–‡ç« "><span>ğŸ“šæ–‡ç« </span></a></li><li><a href="https://xiaokunji.com/zh/archives.html" title="â±æ—¶é—´è½´"><span>â±æ—¶é—´è½´</span></a></li><li><a href="https://xiaokunji.com/zh/tags.html" title="ğŸ”–æ ‡ç­¾"><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href="https://xiaokunji.com/zh/categories.html" title="ğŸ“–åˆ†ç±»"><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href="https://xiaokunji.com/zh/links.html" title="ğŸ¤å‹é“¾"><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><nav aria-label="breadcrumb"><ul><a href="https://xiaokunji.com/zh/">ğŸ </a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">javaåŠå…¶æ¡†æ¶</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud.html">SpringCloud</a> <span>&gt;</span></ul></nav><h1 class="post-title">openFeign</h1><div class="post-description">OpenFeginå¯åŠ¨åŸç†ä»¥åŠæºç è§£æ</div><div class="post-meta">åˆ›å»º:&amp;nbsp;&lt;span title='2023-09-01 00:00:00 +0000 UTC'&gt;2023-09-01&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;æ›´æ–°:&amp;nbsp;2023-11-01&amp;nbsp;Â·&amp;nbsp;xkj
Â |Â åˆ†ç±»: Â <ul class="post-categories-meta" style="display:inline"><a href="https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">javaåŠå…¶æ¡†æ¶</a></ul><span id="busuanzi_container_page_pv">Â | è®¿é—®: <span id="busuanzi_value_page_pv">1</span></span></div></header><aside class="toc-container wide" id="toc-container"><div class="toc"><details open=""><summary accesskey="c" title="(Alt + C)"><span class="details">ç›®å½•</span></summary><div class="inner"><ul><li><a aria-label="å‰è¨€" href="#%e5%89%8d%e8%a8%80">å‰è¨€</a></li><li><a aria-label="Feign çš„å¯åŠ¨åŸç†" href="#feign-%e7%9a%84%e5%90%af%e5%8a%a8%e5%8e%9f%e7%90%86">Feign çš„å¯åŠ¨åŸç†</a><ul><li><a aria-label="æ³¨å…¥@Import" href="#%e6%b3%a8%e5%85%a5import">æ³¨å…¥@Import</a></li><li><a aria-label="æ·»åŠ å…¨å±€é…ç½®" href="#%e6%b7%bb%e5%8a%a0%e5%85%a8%e5%b1%80%e9%85%8d%e7%bd%ae">æ·»åŠ å…¨å±€é…ç½®</a></li><li><a aria-label="æ³¨å†Œ FeignClient æ¥å£" href="#%e6%b3%a8%e5%86%8c-feignclient-%e6%8e%a5%e5%8f%a3">æ³¨å†Œ FeignClient æ¥å£</a></li><li><a aria-label="FeignClientFactoryBean" href="#feignclientfactorybean">FeignClientFactoryBean</a><ul><li><a aria-label="æ„é€  feign.Builderå¯¹è±¡" href="#%e6%9e%84%e9%80%a0-feignbuilder%e5%af%b9%e8%b1%a1">æ„é€  feign.Builderå¯¹è±¡</a></li><li><a aria-label="åŠ¨æ€ä»£ç†ç”Ÿæˆ" href="#%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86%e7%94%9f%e6%88%90">åŠ¨æ€ä»£ç†ç”Ÿæˆ</a></li><li><a aria-label="ç”Ÿæˆä»£ç†ç±»" href="#%e7%94%9f%e6%88%90%e4%bb%a3%e7%90%86%e7%b1%bb">ç”Ÿæˆä»£ç†ç±»</a></li></ul></li></ul></li><li><a aria-label="Feign å¦‚ä½•è´Ÿè½½å‡è¡¡" href="#feign-%e5%a6%82%e4%bd%95%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1">Feign å¦‚ä½•è´Ÿè½½å‡è¡¡</a></li><li><a aria-label="æ—¥å¿—é…ç½®" href="#%e6%97%a5%e5%bf%97%e9%85%8d%e7%bd%ae">æ—¥å¿—é…ç½®</a></li><li><a aria-label="ä½¿ç”¨okHttp" href="#%e4%bd%bf%e7%94%a8okhttp">ä½¿ç”¨okHttp</a></li><li><a aria-label="ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥" href="#%e4%bf%ae%e6%94%b9%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ad%96%e7%95%a5">ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class="post-content"><p>[toc]</p><h1 id="å‰è¨€">å‰è¨€<a aria-hidden="true" class="anchor" hidden="" href="#å‰è¨€">#</a></h1><p>OpenFeign å…¨ç§° Spring Cloud OpenFeignï¼Œå®ƒæ˜¯ Spring å®˜æ–¹æ¨å‡ºçš„ä¸€ç§å£°æ˜å¼æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œå®ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†æ›¿ä»£è¿›å…¥åœæ›´ç»´æŠ¤çŠ¶æ€çš„ Feignã€‚OpenFeign æ˜¯ Spring Cloud å¯¹ Feign çš„äºŒæ¬¡å°è£…ï¼Œå®ƒå…·æœ‰ Feign çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶åœ¨ Feign çš„åŸºç¡€ä¸Šå¢åŠ äº†å¯¹ Spring MVC æ³¨è§£çš„æ”¯æŒï¼Œä¾‹å¦‚ @RequestMappingã€@GetMapping å’Œ @PostMapping ç­‰ã€‚</p><p><a href="http://c.biancheng.net/springcloud/open-feign.html" rel="noopener" target="_blank">OpenFeignï¼šSpring Cloudå£°æ˜å¼æœåŠ¡è°ƒç”¨ç»„ä»¶ï¼ˆéå¸¸è¯¦ç»†ï¼‰ (biancheng.net)</a></p><blockquote><p>æœ¬æ–‡ç« åŸºäºopenFeign 2.X</p></blockquote><h1 id="feign-çš„å¯åŠ¨åŸç†">Feign çš„å¯åŠ¨åŸç†<a aria-hidden="true" class="anchor" hidden="" href="#feign-çš„å¯åŠ¨åŸç†">#</a></h1><h2 id="æ³¨å…¥import">æ³¨å…¥@Import<a aria-hidden="true" class="anchor" hidden="" href="#æ³¨å…¥import">#</a></h2><p>æˆ‘ä»¬åœ¨ä½¿ç”¨OpenFeginæ—¶, éœ€è¦åŠ <code>@EnableFeignClients</code>, æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ³¨è§£</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#d2a8ff;font-weight:700">@Retention</span>(RetentionPolicy.RUNTIME)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#d2a8ff;font-weight:700">@Target</span>(ElementType.TYPE)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#d2a8ff;font-weight:700">@Documented</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#d2a8ff;font-weight:700">@Import</span>(FeignClientsRegistrar.class)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">@interface</span><span style="color:#6e7681"> </span>EnableFeignClients<span style="color:#6e7681"> </span>{...}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>é‡ç‚¹åœ¨ç¬¬å››ä¸ª @Import ä¸Šï¼Œä¸€èˆ¬ä½¿ç”¨æ­¤æ³¨è§£éƒ½æ˜¯æƒ³è¦åŠ¨æ€æ³¨å†Œ Spring Bean çš„</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:700">FeignClientsRegistrar</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">implements</span><span style="color:#6e7681"> </span>ImportBeanDefinitionRegistrar,<span style="color:#6e7681"> </span>ResourceLoaderAware,<span style="color:#6e7681"> </span>EnvironmentAware<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#8b949e;font-style:italic">// .....</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#8b949e;font-style:italic">// èµ„æºåŠ è½½å™¨ï¼Œå¯ä»¥åŠ è½½ classpath ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span>ResourceLoader<span style="color:#6e7681"> </span>resourceLoader;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#8b949e;font-style:italic">// ä¸Šä¸‹æ–‡ï¼Œå¯é€šè¿‡è¯¥ç¯å¢ƒè·å–å½“å‰åº”ç”¨é…ç½®å±æ€§ç­‰</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span>Environment<span style="color:#6e7681"> </span>environment;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">setEnvironment</span>(Environment<span style="color:#6e7681"> </span>environment)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">this</span>.environment<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>environment;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">setResourceLoader</span>(ResourceLoader<span style="color:#6e7681"> </span>resourceLoader)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">this</span>.resourceLoader<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>resourceLoader;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">registerBeanDefinitions</span>(AnnotationMetadata<span style="color:#6e7681"> </span>metadata,<span style="color:#6e7681"> </span>BeanDefinitionRegistry<span style="color:#6e7681"> </span>registry)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">   </span><span style="color:#8b949e;font-style:italic">// æ³¨å†Œ ï¼ EnableFeignClients æä¾›çš„è‡ªå®šä¹‰é…ç½®ç±»ä¸­çš„ç›¸å…³ Bean å®ä¾‹</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>registerDefaultConfiguration(metadata,registry);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// æ‰«æ packgeï¼Œæ³¨å†Œè¢« @FeignClient ä¿®é¥°çš„æ¥å£ç±»ä¸º IOC Bean</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>registerFeignClients(metadata,<span style="color:#6e7681"> </span>registry);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// .....</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>å…¶ä¸­ ImportBeanDefinitionRegistrar è´Ÿè´£åŠ¨æ€æ³¨å…¥ IOC Beanï¼Œå®ƒæœ‰ä¸€ä¸ª<code>registerBeanDefinitions()</code>, ç”¨æ¥åšbeançš„æ³¨å…¥å…·ä½“é€»è¾‘,</p><p>FeignClientsRegistraråˆ†åˆ«æ³¨å…¥äº† Feign é…ç½®ç±»ã€FeignClient Bean,</p><h2 id="æ·»åŠ å…¨å±€é…ç½®">æ·»åŠ å…¨å±€é…ç½®<a aria-hidden="true" class="anchor" hidden="" href="#æ·»åŠ å…¨å±€é…ç½®">#</a></h2><p>registerDefaultConfiguration æ–¹æ³•æµç¨‹å¦‚ä¸‹</p><ol><li>è·å– @EnableFeignClients æ³¨è§£ä¸Šçš„å±æ€§ä»¥åŠå¯¹åº” Value</li><li>ç”Ÿæˆ FeignClientSpecificationï¼ˆå­˜å‚¨ Feign ä¸­çš„é…ç½®ç±»ï¼‰ å¯¹åº”çš„æ„é€ å™¨ BeanDefinitionBuilder</li><li>FeignClientSpecification Bean åç§°ä¸º default. + @EnableFeignClients ä¿®é¥°ç±»å…¨é™å®šåç§° + FeignClientSpecification</li><li>@EnableFeignClients defaultConfiguration é»˜è®¤ä¸º {}ï¼Œå¦‚æœæ²¡æœ‰ç›¸å…³é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ FeignClientsConfiguration å¹¶ç»“åˆ name å¡«å……åˆ° FeignClientSpecificationï¼Œæœ€ç»ˆæ³¨å†Œä¸º IOC Bean</li></ol><h2 id="æ³¨å†Œ-feignclient-æ¥å£">æ³¨å†Œ FeignClient æ¥å£<a aria-hidden="true" class="anchor" hidden="" href="#æ³¨å†Œ-feignclient-æ¥å£">#</a></h2><p>å°†é‡ç‚¹æ”¾åœ¨ registerFeignClients ä¸Šï¼Œè¯¥æ–¹æ³•ä¸»è¦å°±æ˜¯å°†ä¿®é¥°äº† @FeignClient çš„æ¥å£æ³¨å†Œä¸º IOC Bean</p><ol><li><p>æ‰«æ @EnableFeignClients æ³¨è§£ï¼Œå¦‚æœæœ‰ clientsï¼Œåˆ™åŠ è½½æŒ‡å®šæ¥å£ï¼Œä¸ºç©ºåˆ™æ ¹æ® scanner è§„åˆ™æ‰«æå‡ºä¿®é¥°äº† @FeignClient çš„æ¥å£</p></li><li><p>è·å– @FeignClient ä¸Šå¯¹åº”çš„å±æ€§ï¼Œæ ¹æ® configuration å±æ€§å»åˆ›å»ºæ¥å£çº§çš„ FeignClientSpecification é…ç½®ç±» IOC Bean</p></li><li><p>å°† @FeignClient çš„å±æ€§è®¾ç½®åˆ° <strong>FeignClientFactoryBean</strong> å¯¹è±¡ä¸Šï¼Œå¹¶æ³¨å†Œ IOC Bean</p></li></ol><p>@FengnClient ä¿®é¥°çš„æ¥å£å®é™…ä¸Šä½¿ç”¨äº† Spring çš„ä»£ç†å·¥å‚ç”Ÿæˆä»£ç†ç±»ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæŠŠä¿®é¥°äº† @FeignClient æ¥å£çš„ BeanDefinition è®¾ç½®ä¸º FeignClientFactoryBean ç±»å‹ï¼Œè€Œ FeignClientFactoryBean ç»§æ‰¿è‡ª FactoryBean</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬å®šä¹‰ @FeignClient ä¿®é¥°æ¥å£æ—¶ï¼Œæ³¨å†Œåˆ° IOC å®¹å™¨ä¸­ Bean ç±»å‹å˜æˆäº† FeignClientFactoryBean</p><blockquote><p>åœ¨ Spring ä¸­ï¼ŒFactoryBean æ˜¯ä¸€ä¸ªå·¥å‚ Beanï¼Œç”¨æ¥åˆ›å»ºä»£ç† Beanã€‚å·¥å‚ Bean æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Beanï¼Œå¯¹äºéœ€è¦è·å– Bean çš„æ¶ˆè´¹è€…è€Œè¨€ï¼Œå®ƒæ˜¯ä¸çŸ¥é“ Bean æ˜¯æ™®é€š Bean æˆ–æ˜¯å·¥å‚ Bean çš„ã€‚<strong>å·¥å‚ Bean è¿”å›çš„å®ä¾‹ä¸æ˜¯å·¥å‚ Bean æœ¬èº«ï¼Œè€Œæ˜¯ä¼šè¿”å›æ‰§è¡Œäº†å·¥å‚ Bean ä¸­ <code>FactoryBean#getObject</code> é€»è¾‘çš„å®ä¾‹</strong></p><p><strong>ä»¥åå¯ä»¥å†™ä¸€ç¯‡FactoryBeançš„æ–‡ç« </strong></p></blockquote><h2 id="feignclientfactorybean">FeignClientFactoryBean<a aria-hidden="true" class="anchor" hidden="" href="#feignclientfactorybean">#</a></h2><p>è·å¾—å…·ä½“beançš„æ–¹æ³•</p><h3 id="æ„é€ -feignbuilderå¯¹è±¡">æ„é€  feign.Builderå¯¹è±¡<a aria-hidden="true" class="anchor" hidden="" href="#æ„é€ -feignbuilderå¯¹è±¡">#</a></h3><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72;font-weight:700">&lt;</span>T<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>T<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">getTarget</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>FeignContext<span style="color:#6e7681"> </span>context<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>applicationContext.getBean(FeignContext.class);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// æ‹¿åˆ° Feign.Builder</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>Feign.Builder<span style="color:#6e7681"> </span>builder<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>feign(context);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>StringUtils.hasText(url))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>name.startsWith(<span style="color:#a5d6ff">"http"</span>))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>url<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">"http://"</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>name;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>url<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>name;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span>url<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+=</span><span style="color:#6e7681"> </span>cleanPath();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// é€šè¿‡è´Ÿè½½æ‹¿åˆ°bean</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>(T)<span style="color:#6e7681"> </span>loadBalance(builder,<span style="color:#6e7681"> </span>context,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">					</span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>HardCodedTarget<span style="color:#ff7b72;font-weight:700">&lt;&gt;</span>(type,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681"> </span>url));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>....<span style="color:#8b949e;font-style:italic">// çœç•¥ä»£ç </span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><code>org.springframework.cloud.openfeign.FeignClientFactoryBean#feign</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">protected</span><span style="color:#6e7681"> </span>Feign.Builder<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">feign</span>(FeignContext<span style="color:#6e7681"> </span>context)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>FeignLoggerFactory<span style="color:#6e7681"> </span>loggerFactory<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>get(context,<span style="color:#6e7681"> </span>FeignLoggerFactory.class);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>Logger<span style="color:#6e7681"> </span>logger<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>loggerFactory.create(type);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// ä»contextæ‹¿å‡º encoder , Decoder , Contract å¯¹è±¡</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>Feign.Builder<span style="color:#6e7681"> </span>builder<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>get(context,<span style="color:#6e7681"> </span>Feign.Builder.class)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span><span style="color:#8b949e;font-style:italic">// required values</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>.logger(logger)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>.encoder(get(context,<span style="color:#6e7681"> </span>Encoder.class))<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>.decoder(get(context,<span style="color:#6e7681"> </span>Decoder.class))<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>.contract(get(context,<span style="color:#6e7681"> </span>Contract.class));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// é…ç½®feign, ä¾‹å¦‚ è¶…æ—¶ã€é‡è¯•ã€404 é…ç½®, é”™è¯¯Encode, æ‹¦æˆªå™¨ç­‰ç­‰</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>configureFeign(context,<span style="color:#6e7681"> </span>builder);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>builder;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><h3 id="åŠ¨æ€ä»£ç†ç”Ÿæˆ">åŠ¨æ€ä»£ç†ç”Ÿæˆ<a aria-hidden="true" class="anchor" hidden="" href="#åŠ¨æ€ä»£ç†ç”Ÿæˆ">#</a></h3><p><code>org.springframework.cloud.openfeign.FeignClientFactoryBean#loadBalance</code></p><p><img alt="img" loading="lazy" src="https://pic1.zhimg.com/v2-59460fe19618f681b7efc5e28d578f84_r.jpg"/></p><blockquote><p>Clientï¼š Feign å‘é€è¯·æ±‚ä»¥åŠæ¥æ”¶å“åº”ç­‰éƒ½æ˜¯ç”± Client å®Œæˆï¼Œè¯¥ç±»é»˜è®¤ Client.Defaultï¼Œå¦å¤–æ”¯æŒ HttpClientã€OkHttp ç­‰å®¢æˆ·ç«¯</p></blockquote><p>ç„¶åè¿›å…¥<code>org.springframework.cloud.openfeign.HystrixTargeter#target</code></p><p>ç„¶åæ„å»ºäº†feginå¯¹è±¡ <code>feign.Feign.Builder#target(feign.Target&lt;T&gt;)</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&lt;</span>T<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>T<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">target</span>(Target<span style="color:#ff7b72;font-weight:700">&lt;</span>T<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>target)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>build().newInstance(target);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Feign<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">build</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Client<span style="color:#6e7681"> </span>client<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.client,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Retryer<span style="color:#6e7681"> </span>retryer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.retryer,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>RequestInterceptor<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>requestInterceptors<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">this</span>.requestInterceptors.stream()<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>.map(ri<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-&gt;</span><span style="color:#6e7681"> </span>Capability.enrich(ri,<span style="color:#6e7681"> </span>capabilities))<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>.collect(Collectors.toList());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Logger<span style="color:#6e7681"> </span>logger<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.logger,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Contract<span style="color:#6e7681"> </span>contract<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.contract,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Options<span style="color:#6e7681"> </span>options<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.options,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Encoder<span style="color:#6e7681"> </span>encoder<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.encoder,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>Decoder<span style="color:#6e7681"> </span>decoder<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.decoder,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>InvocationHandlerFactory<span style="color:#6e7681"> </span>invocationHandlerFactory<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>Capability.enrich(<span style="color:#ff7b72">this</span>.invocationHandlerFactory,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>QueryMapEncoder<span style="color:#6e7681"> </span>queryMapEncoder<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Capability.enrich(<span style="color:#ff7b72">this</span>.queryMapEncoder,<span style="color:#6e7681"> </span>capabilities);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>SynchronousMethodHandler.Factory<span style="color:#6e7681"> </span>synchronousMethodHandlerFactory<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>SynchronousMethodHandler.Factory(client,<span style="color:#6e7681"> </span>retryer,<span style="color:#6e7681"> </span>requestInterceptors,<span style="color:#6e7681"> </span>logger,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">              </span>logLevel,<span style="color:#6e7681"> </span>decode404,<span style="color:#6e7681"> </span>closeAfterDecode,<span style="color:#6e7681"> </span>propagationPolicy,<span style="color:#6e7681"> </span>forceDecoding);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>ParseHandlersByName<span style="color:#6e7681"> </span>handlersByName<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ParseHandlersByName(contract,<span style="color:#6e7681"> </span>options,<span style="color:#6e7681"> </span>encoder,<span style="color:#6e7681"> </span>decoder,<span style="color:#6e7681"> </span>queryMapEncoder,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">              </span>errorDecoder,<span style="color:#6e7681"> </span>synchronousMethodHandlerFactory);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ReflectiveFeign(handlersByName,<span style="color:#6e7681"> </span>invocationHandlerFactory,<span style="color:#6e7681"> </span>queryMapEncoder);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><h3 id="ç”Ÿæˆä»£ç†ç±»">ç”Ÿæˆä»£ç†ç±»<a aria-hidden="true" class="anchor" hidden="" href="#ç”Ÿæˆä»£ç†ç±»">#</a></h3><p><code>feign.ReflectiveFeign#newInstance</code></p><p>newInstance æ–¹æ³•å¯¹ @FeignClient ä¿®é¥°çš„æ¥å£ä¸­ SpringMvc ç­‰é…ç½®è¿›è¡Œè§£æè½¬æ¢ï¼Œå¯¹æ¥å£ç±»ä¸­çš„æ–¹æ³•è¿›è¡Œå½’ç±»ï¼Œç”ŸæˆåŠ¨æ€ä»£ç†ç±»</p><p><img alt="img" loading="lazy" src="https://pic3.zhimg.com/v2-c0a894f64c4e2f83ea9e6665d255f4d6_r.jpg"/></p><p>æ ¹æ® newInstance æ–¹æ³•æŒ‰ç…§è¡Œä¸ºå¤§è‡´åˆ’åˆ†ï¼Œå…±åšäº†å››ä»¶äº‹</p><ol><li>å¤„ç† @FeignCLient æ³¨è§£ï¼ˆSpringMvc æ³¨è§£ç­‰ï¼‰å°è£…ä¸º MethodHandler åŒ…è£…ç±»</li><li>éå†æ¥å£ä¸­æ‰€æœ‰æ–¹æ³•ï¼Œè¿‡æ»¤ Object æ–¹æ³•ï¼Œå¹¶å°†é»˜è®¤æ–¹æ³•ä»¥åŠ FeignClient æ–¹æ³•åˆ†ç±», å¹¶åˆ›å»ºæ”¶é›†èµ·æ¥</li><li>åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹åº”çš„ InvocationHandler å¹¶åˆ›å»º Proxy å®ä¾‹</li><li>æ¥å£å†… default æ–¹æ³• ç»‘å®šåŠ¨æ€ä»£ç†ç±»</li></ol><p>MethodHandler å°†æ–¹æ³•å‚æ•°ã€æ–¹æ³•è¿”å›å€¼ã€å‚æ•°é›†åˆã€è¯·æ±‚ç±»å‹ã€è¯·æ±‚è·¯å¾„è¿›è¡Œè§£æå­˜å‚¨</p><p><img alt="img" loading="lazy" src="https://pic4.zhimg.com/v2-002dea2e65375c3bd1d84f61702c668f_r.jpg"/></p><p>åœ¨åˆ›å»ºInvocationHandleræ—¶, åˆ›å»ºçš„å…¶å®ç°ç±»æ˜¯ <code>feign.ReflectiveFeign.FeignInvocationHandler</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span>InvocationHandler<span style="color:#6e7681"> </span>handler<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>factory.create(target,<span style="color:#6e7681"> </span>methodToHandler);<span style="color:#6e7681">
</span></span></span></code></pre></div><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">interface</span> <span style="color:#f0883e;font-weight:700">InvocationHandlerFactory</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>InvocationHandler<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">create</span>(Target<span style="color:#6e7681"> </span>target,<span style="color:#6e7681"> </span>Map<span style="color:#ff7b72;font-weight:700">&lt;</span>Method,<span style="color:#6e7681"> </span>MethodHandler<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>dispatch);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#8b949e;font-style:italic">/**
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">   * Like {@link InvocationHandler#invoke(Object, java.lang.reflect.Method, Object[])}, except for a
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">   * single method.
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">   */</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#ff7b72">interface</span> <span style="color:#f0883e;font-weight:700">MethodHandler</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>Object<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">invoke</span>(Object<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>argv)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>Throwable;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#ff7b72">static</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:700">Default</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">implements</span><span style="color:#6e7681"> </span>InvocationHandlerFactory<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>InvocationHandler<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">create</span>(Target<span style="color:#6e7681"> </span>target,<span style="color:#6e7681"> </span>Map<span style="color:#ff7b72;font-weight:700">&lt;</span>Method,<span style="color:#6e7681"> </span>MethodHandler<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>dispatch)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ReflectiveFeign.FeignInvocationHandler(target,<span style="color:#6e7681"> </span>dispatch);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><strong>ä»¥ä¸Š, åœ¨é¡¹ç›®å¯åŠ¨æ—¶å¤„ç†</strong></p><p style="color:red">ä»¥åè¡¥ä¸€ç¯‡jdkåŠ¨æ€ä»£ç†</p><p>åœ¨æˆ‘ä»¬è°ƒç”¨ @FeignClient æ¥å£æ—¶ï¼Œä¼šè¢« <code>FeignInvocationHandler#invoke</code> æ‹¦æˆªï¼Œå¹¶åœ¨åŠ¨æ€ä»£ç†æ–¹æ³•ä¸­æ‰§è¡Œä¸‹è¿°é€»è¾‘</p><ol><li>æ¥å£æ³¨è§£ä¿¡æ¯å°è£…ä¸º HTTP Request</li><li>é€šè¿‡ Ribbon è·å–æœåŠ¡åˆ—è¡¨ï¼Œå¹¶å¯¹æœåŠ¡åˆ—è¡¨è¿›è¡Œè´Ÿè½½å‡è¡¡è°ƒç”¨ï¼ˆæœåŠ¡åè½¬æ¢ä¸º ip+portï¼‰</li><li>è¯·æ±‚è°ƒç”¨åï¼Œå°†è¿”å›çš„æ•°æ®å°è£…ä¸º HTTP Responseï¼Œç»§è€Œè½¬æ¢ä¸ºæ¥å£ä¸­çš„è¿”å›ç±»å‹</li></ol><p><code>feign.ReflectiveFeign.FeignInvocationHandler#invoke</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Object<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">invoke</span>(Object<span style="color:#6e7681"> </span>proxy,<span style="color:#6e7681"> </span>Method<span style="color:#6e7681"> </span>method,<span style="color:#6e7681"> </span>Object<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>args)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>Throwable<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#a5d6ff">"equals"</span>.equals(method.getName()))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>Object<span style="color:#6e7681"> </span>otherHandler<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>args.length<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>0<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&amp;&amp;</span><span style="color:#6e7681"> </span>args<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">?</span><span style="color:#6e7681"> </span>Proxy.getInvocationHandler(args<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span>)<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>equals(otherHandler);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(IllegalArgumentException<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">false</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#a5d6ff">"hashCode"</span>.equals(method.getName()))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>hashCode();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#a5d6ff">"toString"</span>.equals(method.getName()))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>toString();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span><span style="color:#8b949e;font-style:italic">// è¿™ä¸ªdispatch å°±æ˜¯ methodToHandler é›†åˆ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// å…¶ç»“æ„ : private final Map&lt;Method, MethodHandler&gt; dispatch;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>dispatch.get(method).invoke(args);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// å®ƒåå°„çš„æ—¶å€™ç”¨çš„æ˜¯Methodç±», æ‰€ä»¥feignæ¥å£æ˜¯å…è®¸é‡è½½çš„, mybatisçš„åå°„xmlçš„æ¥å£ä¸å…è®¸é‡è½½çš„</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>æ‰§è¡Œå…·ä½“æ–¹æ³•çš„invoke</p><p><code>feign.SynchronousMethodHandler#invoke</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Object<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">invoke</span>(Object<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>argv)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>Throwable<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#8b949e;font-style:italic">// æ„å»º Request æ¨¡ç‰ˆç±»</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>RequestTemplate<span style="color:#6e7681"> </span>template<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>buildTemplateFromArgs.create(argv);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#8b949e;font-style:italic">// å­˜æ”¾è¿æ¥ã€è¶…æ—¶æ—¶é—´ç­‰é…ç½®ç±»</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>Options<span style="color:#6e7681"> </span>options<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>findOptions(argv);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>å¤±è´¥é‡è¯•ç­–ç•¥ç±»<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>Retryer<span style="color:#6e7681"> </span>retryer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">this</span>.retryer.clone();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">while</span><span style="color:#6e7681"> </span>(<span style="color:#79c0ff">true</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span><span style="color:#8b949e;font-style:italic">// æ‰§è¡Œ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>executeAndDecode(template,<span style="color:#6e7681"> </span>options);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(RetryableException<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// é‡è¯•æ“ä½œ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>retryer.continueOrPropagate(e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(RetryableException<span style="color:#6e7681"> </span>th)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>Throwable<span style="color:#6e7681"> </span>cause<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>th.getCause();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(propagationPolicy<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>UNWRAP<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&amp;&amp;</span><span style="color:#6e7681"> </span>cause<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span>cause;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span>th;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(logLevel<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span>Logger.Level.NONE)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>logger.logRetry(metadata.configKey(),<span style="color:#6e7681"> </span>logLevel);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">continue</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>Object<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">executeAndDecode</span>(RequestTemplate<span style="color:#6e7681"> </span>template,<span style="color:#6e7681"> </span>Options<span style="color:#6e7681"> </span>options)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>Throwable<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>Request<span style="color:#6e7681"> </span>request<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>targetRequest(template);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(logLevel<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span>Logger.Level.NONE)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>logger.logRequest(metadata.configKey(),<span style="color:#6e7681"> </span>logLevel,<span style="color:#6e7681"> </span>request);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>Response<span style="color:#6e7681"> </span>response;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">long</span><span style="color:#6e7681"> </span>start<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>System.nanoTime();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// æ‰§è¡Œ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>response<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>client.execute(request,<span style="color:#6e7681"> </span>options);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#8b949e;font-style:italic">// ensure the request is set. TODO: remove in Feign 12</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>response<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>response.toBuilder()<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>.request(request)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>.requestTemplate(template)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>.build();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(IOException<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(logLevel<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span>Logger.Level.NONE)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>logger.logIOException(metadata.configKey(),<span style="color:#6e7681"> </span>logLevel,<span style="color:#6e7681"> </span>e,<span style="color:#6e7681"> </span>elapsedTime(start));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span>errorExecuting(request,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">long</span><span style="color:#6e7681"> </span>elapsedTime<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>TimeUnit.NANOSECONDS.toMillis(System.nanoTime()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-</span><span style="color:#6e7681"> </span>start);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(decoder<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// decode è´£ä»»é“¾</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>decoder.decode(response,<span style="color:#6e7681"> </span>metadata.returnType());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>......<span style="color:#8b949e;font-style:italic">// çœç•¥ä»£ç </span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>ç„¶å <code>org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient#execute</code></p><p>ç„¶å <code>com.netflix.client.AbstractLoadBalancerAwareClient#executeWithLoadBalancer(S, com.netflix.client.config.IClientConfig)</code></p><p>æ‰§è¡Œè¿œç«¯è°ƒç”¨é€»è¾‘ä¸­ä½¿ç”¨åˆ°äº† Rxjava ï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡åº•å±‚è·å– server åå°†æœåŠ¡åç§°è½¬å˜ä¸º ip+port çš„æ–¹å¼</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681"> </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>T<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">executeWithLoadBalancer</span>(<span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>S<span style="color:#6e7681"> </span>request,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>IClientConfig<span style="color:#6e7681"> </span>requestConfig)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>ClientException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>LoadBalancerCommand<span style="color:#ff7b72;font-weight:700">&lt;</span>T<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>command<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>buildLoadBalancerCommand(request,<span style="color:#6e7681"> </span>requestConfig);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>command.submit(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// è¿™ç‰¹ä¹ˆæ˜¯ä¸ªå‚æ•°-----å‚æ•°å¼€å§‹</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ServerOperation<span style="color:#ff7b72;font-weight:700">&lt;</span>T<span style="color:#ff7b72;font-weight:700">&gt;</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Observable<span style="color:#ff7b72;font-weight:700">&lt;</span>T<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">call</span>(Server<span style="color:#6e7681"> </span>server)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#8b949e;font-style:italic">// æ‹¿åˆ°äº†å…·ä½“çš„ip+port</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>URI<span style="color:#6e7681"> </span>finalUri<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>reconstructURIWithServer(server,<span style="color:#6e7681"> </span>request.getUri());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>S<span style="color:#6e7681"> </span>requestForServer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>(S)<span style="color:#6e7681"> </span>request.replaceUri(finalUri);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>Observable.just(AbstractLoadBalancerAwareClient.this.execute(requestForServer,<span style="color:#6e7681"> </span>requestConfig));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>}<span style="color:#6e7681"> 
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Exception<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>Observable.error(e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>})<span style="color:#8b949e;font-style:italic">// å‚æ•°ç»“æŸ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>.toBlocking()<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>.single();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Exception<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>Throwable<span style="color:#6e7681"> </span>t<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>e.getCause();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(t<span style="color:#6e7681"> </span><span style="color:#ff7b72">instanceof</span><span style="color:#6e7681"> </span>ClientException)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span>(ClientException)<span style="color:#6e7681"> </span>t;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ClientException(e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><code>public Observable&lt;T&gt; submit(final ServerOperation&lt;T&gt; operation) {}</code> submitæ–¹æ³•æœ‰ä¸ªå…¥å‚, å°±æ˜¯é‚£ä¸€å¤§å¨</p><p>ç½‘ç»œè°ƒç”¨é»˜è®¤ä½¿ç”¨ JDK çš„ HttpURLConnectionï¼Œå¯ä»¥é…ç½®ä½¿ç”¨ HttpClient æˆ–è€… OkHttp</p><p><img alt="img" loading="lazy" src="https://pic1.zhimg.com/v2-2b2d7f7222de6b178cde89ecb7f86114_r.jpg"/></p><blockquote><p>å…·ä½“æ€ä¹ˆæ‹¿åˆ°ipå’Œportçš„, å°±æ˜¯æ¥ä¸‹æ¥çš„è´Ÿè´£å‡è¡¡çŸ¥è¯†äº†</p></blockquote><h1 id="feign-å¦‚ä½•è´Ÿè½½å‡è¡¡">Feign å¦‚ä½•è´Ÿè½½å‡è¡¡<a aria-hidden="true" class="anchor" hidden="" href="#feign-å¦‚ä½•è´Ÿè½½å‡è¡¡">#</a></h1><p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ç”Ÿäº§è€…æ³¨å†Œå¤šä¸ªæœåŠ¡ï¼Œæ¶ˆè´¹è€…è°ƒç”¨æ—¶éœ€è¦ä½¿ç”¨è´Ÿè½½å‡è¡¡ä»ä¸­ <strong>è½®è¯¢æœºåˆ¶é€‰å–ä¸€ä¸ªå¥åº·å¹¶ä¸”å¯ç”¨çš„ç”Ÿäº§è€…æœåŠ¡</strong></p><blockquote><p>é»˜è®¤æ˜¯è½®è¯¢æœºåˆ¶, å¯ä»¥ä¿®æ”¹</p><p>openFegin 2.X æ‰æœ‰è´Ÿè½½å‡è¡¡ , 3.0 ä¹‹åå°±ç§»é™¤äº†Ribbon, ä¸€èˆ¬ç”¨<code>spring-cloud-starter-loadbalancer</code>ä»£æ›¿</p></blockquote><p><img alt="img" loading="lazy" src="https://pic4.zhimg.com/v2-cd503dcf36feb0ed270ffa0a5f4bd39f_r.jpg"/></p><p><code>com.netflix.loadbalancer.reactive.LoadBalancerCommand#selectServer</code></p><p>å› ä¸º Feign å†…éƒ¨é›†æˆ Ribbonï¼Œæ‰€ä»¥ä¹Ÿæ”¯æŒæ­¤ç‰¹æ€§ï¼Œä¸€èµ·çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆåšçš„</p><p><img alt="img" loading="lazy" src="https://pic3.zhimg.com/v2-a1fe59424d9c6a2c86172373e541af46_r.jpg"/></p><p><strong>getServerFromLoadBalancer()</strong></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Server<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">getServerFromLoadBalancer</span>(<span style="color:#d2a8ff;font-weight:700">@Nullable</span><span style="color:#6e7681"> </span>URI<span style="color:#6e7681"> </span>original,<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">@Nullable</span><span style="color:#6e7681"> </span>Object<span style="color:#6e7681"> </span>loadBalancerKey)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>ClientException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>String<span style="color:#6e7681"> </span>host<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>port<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-</span>1;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(original<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>host<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>original.getHost();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(original<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>Pair<span style="color:#ff7b72;font-weight:700">&lt;</span>String,<span style="color:#6e7681"> </span>Integer<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>schemeAndPort<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>deriveSchemeAndPortFromPartialUri(original);<span style="color:#6e7681">        
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>port<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>schemeAndPort.second();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// Various Supported Cases</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// The loadbalancer to use and the instances it has is based on how it was registered</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// In each of these cases, the client might come in using Full Url or Partial URL</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>ILoadBalancer<span style="color:#6e7681"> </span>lb<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>getLoadBalancer();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(host<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// Partial URI or no URI Case</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// well we have to just get the right instances from lb - or we fall back</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(lb<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>){<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// é€‰æ‹©å‡ºåˆé€‚çš„æœåŠ¡</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>Server<span style="color:#6e7681"> </span>svc<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>lb.chooseServer(loadBalancerKey);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(svc<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>){<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ClientException(ClientException.ErrorType.GENERAL,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#a5d6ff">"Load balancer does not have available server for client: "</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                                    </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>clientName);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>host<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>svc.getHost();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(host<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>){<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ClientException(ClientException.ErrorType.GENERAL,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#a5d6ff">"Invalid Server for :"</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>svc);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>logger.debug(<span style="color:#a5d6ff">"{} using LB returned Server: {} for request {}"</span>,<span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>Object<span style="color:#ff7b72;font-weight:700">[]</span>{clientName,<span style="color:#6e7681"> </span>svc,<span style="color:#6e7681"> </span>original});<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>svc;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681"> 
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>......<span style="color:#8b949e;font-style:italic">// çœç•¥ä»£ç </span><span style="color:#6e7681">
</span></span></span></code></pre></div><p>è¿›å…¥æŒ‰ç©ºé—´ä½ç½®è·å–æœåŠ¡</p><p><code>com.netflix.loadbalancer.ZoneAwareLoadBalancer#chooseServer</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/**
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">* æœ€ç»ˆéƒ½æ˜¯ä½¿ç”¨çˆ¶çº§çš„ chooseServer()
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">* å¦‚æœæœ‰å¤šä¸ªåŒºåŸŸ, å°±éšæœºé€‰ä¸€ä¸ª
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">*/</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Server<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">chooseServer</span>(Object<span style="color:#6e7681"> </span>key)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// å¦‚æœåªæœ‰ä¸€ä¸ªåŒºåŸŸç›´æ¥ä½¿ç”¨çˆ¶çº§çš„</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>ENABLED.get()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">||</span><span style="color:#6e7681"> </span>getLoadBalancerStats().getAvailableZones().size()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&lt;=</span><span style="color:#6e7681"> </span>1)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>logger.debug(<span style="color:#a5d6ff">"Zone aware logic disabled or there is only one zone"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">super</span>.chooseServer(key);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>Server<span style="color:#6e7681"> </span>server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>LoadBalancerStats<span style="color:#6e7681"> </span>lbStats<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>getLoadBalancerStats();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>Map<span style="color:#ff7b72;font-weight:700">&lt;</span>String,<span style="color:#6e7681"> </span>ZoneSnapshot<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>zoneSnapshot<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ZoneAvoidanceRule.createSnapshot(lbStats);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>logger.debug(<span style="color:#a5d6ff">"Zone snapshots: {}"</span>,<span style="color:#6e7681"> </span>zoneSnapshot);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(triggeringLoad<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>triggeringLoad<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>DynamicPropertyFactory.getInstance().getDoubleProperty(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#a5d6ff">"ZoneAwareNIWSDiscoveryLoadBalancer."</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">this</span>.getName()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">".triggeringLoadPerServerThreshold"</span>,<span style="color:#6e7681"> </span>0.2d);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(triggeringBlackoutPercentage<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>triggeringBlackoutPercentage<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>DynamicPropertyFactory.getInstance().getDoubleProperty(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#a5d6ff">"ZoneAwareNIWSDiscoveryLoadBalancer."</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">this</span>.getName()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">".avoidZoneWithBlackoutPercetage"</span>,<span style="color:#6e7681"> </span>0.99999d);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// æ‹¿åˆ°å¯ç”¨çš„åŒºåŸŸåˆ—è¡¨</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>Set<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>availableZones<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ZoneAvoidanceRule.getAvailableZones(zoneSnapshot,<span style="color:#6e7681"> </span>triggeringLoad.get(),<span style="color:#6e7681"> </span>triggeringBlackoutPercentage.get());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>logger.debug(<span style="color:#a5d6ff">"Available zones: {}"</span>,<span style="color:#6e7681"> </span>availableZones);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(availableZones<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&amp;&amp;</span><span style="color:#6e7681">  </span>availableZones.size()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&lt;</span><span style="color:#6e7681"> </span>zoneSnapshot.keySet().size())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// éšæœºç®—ä¸€ä¸ªåŒºåŸŸ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>String<span style="color:#6e7681"> </span>zone<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ZoneAvoidanceRule.randomChooseZone(zoneSnapshot,<span style="color:#6e7681"> </span>availableZones);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>logger.debug(<span style="color:#a5d6ff">"Zone chosen: {}"</span>,<span style="color:#6e7681"> </span>zone);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(zone<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#8b949e;font-style:italic">// æ‹¿åˆ°å…·ä½“çš„è´Ÿè½½å‡è¡¡è§„åˆ™</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>BaseLoadBalancer<span style="color:#6e7681"> </span>zoneLoadBalancer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>getLoadBalancer(zone);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#8b949e;font-style:italic">// æ ¹æ®è§„åˆ™è·å–æœåŠ¡ä¿¡æ¯</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>zoneLoadBalancer.chooseServer(key);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Exception<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>logger.error(<span style="color:#a5d6ff">"Error choosing server using zone aware logic for load balancer={}"</span>,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>server;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>logger.debug(<span style="color:#a5d6ff">"Zone avoidance logic is not invoked."</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">super</span>.chooseServer(key);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><blockquote><p>å¯ç”¨çš„åˆ¤æ–­åŒ…æ‹¬ æ˜¯å¦æœ‰å­˜æ´»èŠ‚ç‚¹; ç†”æ–­æ¬¡æ•°ä¸èƒ½å¤ªå¤šç­‰ç­‰</p></blockquote><p>æ‹¿åˆ°è´Ÿè½½å‡è¡¡å¯¹è±¡</p><p><code>com.netflix.loadbalancer.ZoneAwareLoadBalancer#getLoadBalancer</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span>BaseLoadBalancer<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">getLoadBalancer</span>(String<span style="color:#6e7681"> </span>zone)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>zone<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>zone.toLowerCase();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>BaseLoadBalancer<span style="color:#6e7681"> </span>loadBalancer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>balancers.get(zone);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(loadBalancer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        	</span><span style="color:#8b949e;font-style:italic">// We need to create rule object for load balancer for each zone</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// æ‹¿åˆ°å…·ä½“çš„è§„åˆ™ , é»˜è®¤æ˜¯è½®è¯¢</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        	</span>IRule<span style="color:#6e7681"> </span>rule<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>cloneRule(<span style="color:#ff7b72">this</span>.getRule());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>loadBalancer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>BaseLoadBalancer(<span style="color:#ff7b72">this</span>.getName()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">"_"</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>zone,<span style="color:#6e7681"> </span>rule,<span style="color:#6e7681"> </span><span style="color:#ff7b72">this</span>.getLoadBalancerStats());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>BaseLoadBalancer<span style="color:#6e7681"> </span>prev<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>balancers.putIfAbsent(zone,<span style="color:#6e7681"> </span>loadBalancer);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(prev<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            	</span>loadBalancer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>prev;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> 
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>loadBalancer;<span style="color:#6e7681">        
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><code>com.netflix.loadbalancer.BaseLoadBalancer#getRule</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">static</span><span style="color:#6e7681"> </span>IRule<span style="color:#6e7681"> </span>DEFAULT_RULE<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>RoundRobinRule();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">protected</span><span style="color:#6e7681"> </span>IRule<span style="color:#6e7681"> </span>rule<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>DEFAULT_RULE;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>IRule<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">getRule</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>rule;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>æ‹¿åˆ°è§„åˆ™å, è°ƒç”¨chooseServer()</p><p><code>com.netflix.loadbalancer.BaseLoadBalancer#chooseServer</code></p><p>è°ƒç”¨äº†å…¶ä¸‹å®ç°ç±»</p><p><code>com.netflix.loadbalancer.RoundRobinRule#choose(com.netflix.loadbalancer.ILoadBalancer, java.lang.Object)</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Server<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">choose</span>(ILoadBalancer<span style="color:#6e7681"> </span>lb,<span style="color:#6e7681"> </span>Object<span style="color:#6e7681"> </span>key)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(lb<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>log.warn(<span style="color:#a5d6ff">"no load balancer"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>Server<span style="color:#6e7681"> </span>server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>count<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>0;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">while</span><span style="color:#6e7681"> </span>(server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&amp;&amp;</span><span style="color:#6e7681"> </span>count<span style="color:#ff7b72;font-weight:700">++</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&lt;</span><span style="color:#6e7681"> </span>10)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>Server<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>reachableServers<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>lb.getReachableServers();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// æ‰€æœ‰æœåŠ¡çš„ip + port</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>Server<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>allServers<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>lb.getAllServers();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>upCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>reachableServers.size();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>serverCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>allServers.size();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>((upCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>0)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">||</span><span style="color:#6e7681"> </span>(serverCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>0))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>log.warn(<span style="color:#a5d6ff">"No up servers available from load balancer: "</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>lb);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// ä¸‹ä¸€ä¸ªæœåŠ¡çš„ä¸‹æ ‡</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>nextServerIndex<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>incrementAndGetModulo(serverCount);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>allServers.get(nextServerIndex);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">/* Transient. */</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>Thread.yield();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">continue</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(server.isAlive()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&amp;&amp;</span><span style="color:#6e7681"> </span>(server.isReadyToServe()))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>(server);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// Next.</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>server<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(count<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&gt;=</span><span style="color:#6e7681"> </span>10)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>log.warn(<span style="color:#a5d6ff">"No available alive servers after 10 tries from load balancer: "</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>lb);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>server;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><code>com.netflix.loadbalancer.RoundRobinRule#incrementAndGetModulo</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">incrementAndGetModulo</span>(<span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>modulo)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(;;)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// AtomicInteger nextServerCyclicCounter = nextServerCyclicCounter = new AtomicInteger(0);  ç±»åˆå§‹åŒ–æ—¶ åˆå§‹åŒ–äº†å˜é‡</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>current<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>nextServerCyclicCounter.get();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>next<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>(current<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>1)<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">%</span><span style="color:#6e7681"> </span>modulo;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(nextServerCyclicCounter.compareAndSet(current,<span style="color:#6e7681"> </span>next))<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>next;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><h1 id="æ—¥å¿—é…ç½®">æ—¥å¿—é…ç½®<a aria-hidden="true" class="anchor" hidden="" href="#æ—¥å¿—é…ç½®">#</a></h1><p><a href="https://blog.csdn.net/weixin_43472934/article/details/122253068" rel="noopener" target="_blank">3ã€openFeignæ—¥å¿—é…ç½®_æé’±è‡ªå¾‹çš„åšå®¢-CSDNåšå®¢_openfeignæ—¥å¿—</a></p><blockquote><p>æ³¨æ„: feignè°ƒè¯•æ—¥å¿—æ˜¯debugçº§åˆ«è¾“å‡º,springbooté»˜è®¤çš„æ—¥å¿—çº§åˆ«æ˜¯infoï¼Œæ‰€ä»¥è¦è°ƒèŠ‚springbootçš„æ—¥å¿—çº§åˆ«(å¯ä»¥æŒ‡å®šç›®å½•çš„è°ƒèŠ‚)</p></blockquote><h1 id="ä½¿ç”¨okhttp">ä½¿ç”¨okHttp<a aria-hidden="true" class="anchor" hidden="" href="#ä½¿ç”¨okhttp">#</a></h1><p><a href="https://www.cnblogs.com/crazymakercircle/p/11968479.html" rel="noopener" target="_blank">Feignã€httpclientã€OkHttp3 ç»“åˆä½¿ç”¨ - ç–¯ç‹‚åˆ›å®¢åœˆ - åšå®¢å›­ (cnblogs.com)</a></p><h1 id="ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥">ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥<a aria-hidden="true" class="anchor" hidden="" href="#ä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥">#</a></h1><p><a href="https://blog.csdn.net/qq_39825705/article/details/125175303" rel="noopener" target="_blank">OpenFeignä¿®æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥_ä¸€è§‰ç¡è¿‡å¤´çš„èœé¸¡çš„åšå®¢-CSDNåšå®¢_openfeignè´Ÿè½½å‡è¡¡</a></p><p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy" src="./OpenFeign.assets/ef9f43296f38477a9b00d608d75428c6.png"/></p><p><a href="https://zhuanlan.zhihu.com/p/346273428" rel="noopener" target="_blank">æŒæ¡ SpringCloud OpenFeign æ ¸å¿ƒåŸç† - çŸ¥ä¹ (zhihu.com)</a></p><p>æ¨èæ–‡ç« :</p><p><a href="https://mp.weixin.qq.com/s/h-DyoZ-4MRXDUHrGooYfyA" rel="noopener" target="_blank">ä¸‡å­—é•¿æ–‡ | æ·±å…¥ç†è§£ OpenFeign çš„æ¶æ„åŸç† (qq.com)</a></p></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xiaokunji.com/zh/tags/spring_cloud.html">spring_cloud</a></li><li><a href="https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">javaåŠå…¶æ¡†æ¶</a></li></ul><nav class="paginav"><a class="prev" href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Nacos.html"><span class="title">Â« ä¸Šä¸€é¡µ</span><br/><span>Nacos</span>
</a><a class="next" href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Sleuth.html"><span class="title">ä¸‹ä¸€é¡µ Â»</span><br/><span>Sleuth</span></a></nav></footer></article></main><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><footer class="footer"><span>Copyright
Â©
-2023
<a href="https://xiaokunji.com/zh/" style="color:#939393">ç±³äºŒ</a>
All Rights Reserved
</span><span id="busuanzi_container"><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id="busuanzi_value_site_uv"></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id="busuanzi_value_site_pv"></span></span></footer><a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)"><svg fill="currentcolor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>