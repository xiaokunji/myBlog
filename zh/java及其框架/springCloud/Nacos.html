<!DOCTYPE html>
<html dir="auto" lang="zh"><head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"/><meta content="index, follow" name="robots"/><title>Nacos | ç±³äºŒ</title>
<meta content=" å‰è¨€, 1. æ¦‚å¿µ, 2. æ¶æ„, 3. å®‰è£…, 3.1 Nacos Server æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š, 3.1.1 standalone æ¨¡å¼, 3.1.2 cluster æ¨¡å¼, é›†ç¾¤èŠ‚ç‚¹(æ­¤å¤„æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Š,æ‰€ä»¥ç”¨ipåŒºåˆ†), 4. æ³¨å†Œä¸­å¿ƒ, 4.1 åŸºæœ¬ä½¿ç”¨, 4.2 åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶,nacoså¦‚ä½•å‘ç°ipçš„, 5. é…ç½®ä¸­å¿ƒ, 5.1 åŠ¨æ€é…ç½®, 5.1.1 ä½¿ç”¨, 5.1.2 åŸç†è¯¦è§£, 5.1.2.1 é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œ ç›‘å¬ æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹, 5.1.2.2 é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹, 5.1.2.3 æ‹¿åˆ°é…ç½®åé€šè¿‡applicationContextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­, 5.1.3 æ€»ç»“, A&amp;Q" name="keywords"/><meta content="nacosåŸºæœ¬ä½¿ç”¨ä»¥åŠåŠ¨æ€é…ç½®åŸç†" name="description"/><meta content="xkj" name="author"/><link href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Nacos.html" rel="canonical"/><link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.dc6bd2c841ee388e899e13872ae986c0e847e8b957d6714ad6ddc628ef2d17ff.css" integrity="sha256-3GvSyEHuOI6JnhOHKumGwOhH6LlX1nFK1t3GKO8tF/8=" rel="preload stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js"></script><link href="https://xiaokunji.com/img/Q.svg" rel="icon"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="16x16" type="image/png"/><link href="https://xiaokunji.com/img/Q.svg" rel="icon" sizes="32x32" type="image/png"/><link href="https://xiaokunji.com/Q.svg" rel="apple-touch-icon"/><link href="https://xiaokunji.com/Q.svg" rel="mask-icon"/><meta content="#2e2e33" name="theme-color"/><meta content="#2e2e33" name="msapplication-TileColor"/><link href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Nacos.html" hreflang="zh" rel="alternate"/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta content="Nacos" property="og:title"/><meta content="nacosåŸºæœ¬ä½¿ç”¨ä»¥åŠåŠ¨æ€é…ç½®åŸç†" property="og:description"/><meta content="article" property="og:type"/><meta content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Nacos.html" property="og:url"/><meta content="javaåŠå…¶æ¡†æ¶" property="article:section"/><meta content="2023-09-01T00:00:00+00:00" property="article:published_time"/><meta content="2023-11-01T17:44:19+08:00" property="article:modified_time"/><meta content="summary" name="twitter:card"/><meta content="Nacos" name="twitter:title"/><meta content="nacosåŸºæœ¬ä½¿ç”¨ä»¥åŠåŠ¨æ€é…ç½®åŸç†" name="twitter:description"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"Nacos","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Nacos.html"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nacos","name":"Nacos","description":"nacosåŸºæœ¬ä½¿ç”¨ä»¥åŠåŠ¨æ€é…ç½®åŸç†","keywords":[" å‰è¨€"," 1. æ¦‚å¿µ"," 2. æ¶æ„"," 3. å®‰è£…"," 3.1 Nacos Server æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š"," 3.1.1 standalone æ¨¡å¼"," 3.1.2 cluster æ¨¡å¼"," é›†ç¾¤èŠ‚ç‚¹(æ­¤å¤„æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Š,æ‰€ä»¥ç”¨ipåŒºåˆ†)"," 4. æ³¨å†Œä¸­å¿ƒ"," 4.1 åŸºæœ¬ä½¿ç”¨"," 4.2 åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶,nacoså¦‚ä½•å‘ç°ipçš„"," 5. é…ç½®ä¸­å¿ƒ"," 5.1 åŠ¨æ€é…ç½®"," 5.1.1 ä½¿ç”¨"," 5.1.2 åŸç†è¯¦è§£"," 5.1.2.1 é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œ ç›‘å¬ æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹"," 5.1.2.2 é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹"," 5.1.2.3 æ‹¿åˆ°é…ç½®åé€šè¿‡applicationContextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­"," 5.1.3 æ€»ç»“"," A\u0026Q"],"articleBody":"[toc]\nå‰è¨€ é˜¿é‡Œå¼€æºçš„æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ\nNacos å®˜æ–¹æ–‡æ¡£ Nacos æºç  1. æ¦‚å¿µ Name Space\nç”¨äºè¿›è¡Œç§Ÿæˆ·ç²’åº¦çš„é…ç½®éš”ç¦»ã€‚ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥å­˜åœ¨ç›¸åŒçš„ Group æˆ– Data ID çš„é…ç½®ã€‚Namespace çš„å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯ä¸åŒç¯å¢ƒçš„é…ç½®çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰ã€‚\nConfiguration\né…ç½®æ–‡ä»¶\nData ID\nNacos ä¸­çš„æŸä¸ªé…ç½®é›†çš„ IDã€‚é…ç½®é›† ID æ˜¯ç»„ç»‡åˆ’åˆ†é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚Data ID é€šå¸¸ç”¨äºç»„ç»‡åˆ’åˆ†ç³»ç»Ÿçš„é…ç½®é›†ã€‚ä¸€ä¸ªç³»ç»Ÿæˆ–è€…åº”ç”¨å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®é›†ï¼Œæ¯ä¸ªé…ç½®é›†éƒ½å¯ä»¥è¢«ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°æ ‡è¯†ã€‚Data ID é€šå¸¸é‡‡ç”¨ç±» Java åŒ…ï¼ˆå¦‚ com.taobao.tc.refund.log.levelï¼‰çš„å‘½åè§„åˆ™ä¿è¯å…¨å±€å”¯ä¸€æ€§ã€‚æ­¤å‘½åè§„åˆ™éå¼ºåˆ¶ã€‚\nGroup\nNacos ä¸­çš„ä¸€ç»„é…ç½®é›†ï¼Œæ˜¯ç»„ç»‡é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚é€šè¿‡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ Buy æˆ– Trade ï¼‰å¯¹é…ç½®é›†è¿›è¡Œåˆ†ç»„ï¼Œä»è€ŒåŒºåˆ† Data ID ç›¸åŒçš„é…ç½®é›†ã€‚å½“æ‚¨åœ¨ Nacos ä¸Šåˆ›å»ºä¸€ä¸ªé…ç½®æ—¶ï¼Œå¦‚æœæœªå¡«å†™é…ç½®åˆ†ç»„çš„åç§°ï¼Œåˆ™é…ç½®åˆ†ç»„çš„åç§°é»˜è®¤é‡‡ç”¨ DEFAULT_GROUP ã€‚é…ç½®åˆ†ç»„çš„å¸¸è§åœºæ™¯ï¼šä¸åŒçš„åº”ç”¨æˆ–ç»„ä»¶ä½¿ç”¨äº†ç›¸åŒçš„é…ç½®ç±»å‹ï¼Œå¦‚ database_url é…ç½®å’Œ MQ_topic é…ç½®ã€‚\nVirtual Cluster\nåŒä¸€ä¸ªæœåŠ¡ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹ç»„æˆä¸€ä¸ªé»˜è®¤é›†ç¾¤, é›†ç¾¤å¯ä»¥è¢«è¿›ä¸€æ­¥æŒ‰éœ€æ±‚åˆ’åˆ†ï¼Œåˆ’åˆ†çš„å•ä½å¯ä»¥æ˜¯è™šæ‹Ÿé›†ç¾¤ã€‚\nå¦‚å›¾: Nacos æ¦‚å¿µ 2. æ¶æ„ 3. å®‰è£… Nacos Serverä¸‹è½½åœ°å€ï¼š\nhttps://github.com/alibaba/nacos/releases ä¸‹è½½è§£å‹åæ‰“å¼€binç›®å½•\n/work/nacos/bin/startup.sh -m standalone\nwindows: startup.cmd -m standalone\nå¯åŠ¨å®Œåè®¿é—®åå°\nNacos Serverçš„åå°è®¿é—®åœ°å€ï¼š\nhttp://192.168.10.13:8848/nacos/index.html\né»˜è®¤è´¦å·å’Œå¯†ç ä¸ºï¼šnacos/nacos\n3.1 Nacos Server æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š standalone cluster (é»˜è®¤æ¨¡å¼) 3.1.1 standalone æ¨¡å¼ æ­¤æ¨¡å¼ä¸€èˆ¬ç”¨äº demo å’Œæµ‹è¯•ï¼Œä¸ç”¨æ”¹ä»»ä½•é…ç½®ï¼Œç›´æ¥æ•²ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œ\n3.1.2 cluster æ¨¡å¼ cluster æ¨¡å¼éœ€è¦ä¾èµ– MySQLï¼Œç„¶åæ”¹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼š\nconf/cluster.conf conf/application.properties conf/cluster.conf\n# é›†ç¾¤èŠ‚ç‚¹(æ­¤å¤„æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Š,æ‰€ä»¥ç”¨ipåŒºåˆ†) 192.168.10.13:8841 192.168.10.13:8845 192.168.10.13:8848 conf/application.properties\nspring.datasource.platform=mysql db.num=1 db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8\u0026connectTimeout=1000\u0026socketTimeout=3000\u0026autoReconnect=true\u0026useUnicode=true\u0026useSSL=false\u0026serverTimezone=UTC\u0026AllowPublicKeyRetrieval=True db.user.0=test db.password.0=xiaokunji æ¯ä¸ªèŠ‚ç‚¹ä¸Šéœ€è¦æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶\næ³¨æ„åœ¨application.propertiesæ–‡ä»¶ä¸­ä¿®æ”¹ç«¯å£\nå¯åŠ¨å ä»»æ„èŠ‚ç‚¹éƒ½èƒ½è¿›å…¥ç®¡ç†ç•Œé¢\né˜¿é‡Œå·´å·´NACOSï¼ˆ3ï¼‰- éƒ¨ç½²Nacosçš„ç”Ÿäº§é›†ç¾¤ç¯å¢ƒ-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com) ä¸€èˆ¬é›†ç¾¤éƒ¨ç½²éœ€è¦æ­é…NGINX, è¿™æ ·å°±å¯ä»¥ç»Ÿä¸€ç®¡ç†å¯¹å¤–ip, ä¸”éœ€è¦åˆ©ç”¨NGINXçš„æ•…éšœè½¬ç§»ç­–ç•¥, nacosæœ¬èº«ä¸å…·å¤‡æ•…éšœè½¬ç§»\nNacos é›†ç¾¤éƒ¨ç½² - CanntBelieve - åšå®¢å›­ (cnblogs.com) 4. æ³¨å†Œä¸­å¿ƒ å‚æ•°è§£é‡Š\nå‚æ•° æè¿° com.alibaba.nacos.naming.log.level Namingå®¢æˆ·ç«¯çš„æ—¥å¿—çº§åˆ«ï¼Œæ”¹å±æ€§é€šè¿‡å®¢æˆ·ç«¯å¯åŠ¨æ—¶é€šè¿‡å‘½ä»¤è¡ŒåŠ å‚æ•°æŒ‡å®š æ³¨ï¼šé»˜è®¤ä¸ºinfo spring.cloud.nacos.discovery.heart-beat-interval nacoså®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤5s\næ³¨ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ¯éš”5så‘æœåŠ¡ç«¯å‘é€å¿ƒè·³è¯·æ±‚ï¼Œè¿›è¡ŒæœåŠ¡ç»­ç§Ÿï¼Œå‘Šè¯‰æœåŠ¡ç«¯è¯¥å®ä¾‹IPå¥åº·ã€‚è‹¥åœ¨3æ¬¡å¿ƒè·³çš„é—´éš”æ—¶é—´(é»˜è®¤15s)å†…æœåŠ¡ç«¯æ²¡æœ‰æ¥å—åˆ°è¯¥å®ä¾‹çš„å¿ƒè·³è¯·æ±‚ï¼Œåˆ™è®¤ä¸ºè¯¥å®ä¾‹ä¸å¥åº·ï¼Œè¯¥å®ä¾‹å°†æ— æ³•è¢«æ¶ˆè´¹ã€‚å¦‚æœå†æ¬¡ç»å†3æ¬¡å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°è¯¥å®ä¾‹çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä¼šç«‹åˆ»å°†å…¶è®¾ç½®å¤–å¥åº·ï¼Œå¹¶å¯ä»¥è¢«æ¶ˆè´¹ï¼Œè‹¥æœªæ¥å—åˆ°ï¼Œåˆ™åˆ é™¤è¯¥å®ä¾‹çš„æ³¨å†Œä¿¡æ¯ã€‚æ¨èé…ç½®ä¸º5sï¼Œå¦‚æœæœ‰çš„ä¸šåŠ¡çº¿å¸Œæœ›æœåŠ¡ä¸‹çº¿æˆ–è€…å‡ºæ•…éšœæ—¶å¸Œæœ›å°½å¿«è¢«å‘ç°ï¼Œå¯ä»¥é€‚å½“å‡å°‘è¯¥å€¼ã€‚ spring.cloud.nacos.discovery.heart-beat-timeout: æœåŠ¡ç«¯æ²¡æœ‰æ¥å—åˆ°å®¢æˆ·ç«¯å¿ƒè·³è¯·æ±‚å°±å°†å…¶è®¾ä¸ºä¸å¥åº·çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º15s. æ³¨ï¼šæ¨èå€¼è¯¥å€¼ä¸º15så³å¯ï¼Œå¦‚æœæœ‰çš„ä¸šåŠ¡çº¿å¸Œæœ›æœåŠ¡ä¸‹çº¿æˆ–è€…å‡ºæ•…éšœæ—¶å¸Œæœ›å°½å¿«è¢«å‘ç°ï¼Œå¯ä»¥é€‚å½“å‡å°‘è¯¥å€¼ã€‚ spring.cloud.nacos.discovery.log-name: nacoså®¢æˆ·ç«¯ä¼šåœ¨å¯åŠ¨æ—¶æ‰“å°ä¸€éƒ¨åˆ†å‘é€æ³¨å†Œè¯·æ±‚ä¿¡æ¯å’Œå¼‚å¸¸æ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹æ³¨å†Œçš„nacosé›†ç¾¤åœ°å€ã€æœåŠ¡åã€nameSpaceã€IPã€å…ƒæ•°æ®ç­‰å†…å®¹ï¼Œæ–‡ä»¶åé»˜è®¤ä¸ºnaming.log . æ³¨:æ¨èå°†è¯¥æ—¥å¿—çš„ä½ç½®è®¾ç½®ä¸ºå’Œå…¶ä»–æ—¥å¿—åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ spring.cloud.nacos.discovery.metadata: ç»™æœåŠ¡æ·»åŠ ä¸€äº›æ ‡ç­¾ï¼Œä¾‹å¦‚å±äºä»€ä¹ˆä¸šåŠ¡çº¿ï¼Œè¯¥å…ƒæ•°æ®ä¼šæŒä¹…åŒ–å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¶ˆè´¹æ—¶ä¸ä¼šè·å–åˆ°æ­¤å€¼ï¼Œé»˜è®¤ä¸ºç©º. æ³¨:æ¨èä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å·²ç»æ³¨å†Œçš„æœåŠ¡åæ¥æ‰¾åˆ°å…·ä½“çš„ä¸šåŠ¡çº¿ï¼Œæ— éœ€æ·»åŠ metadata spring.cloud.nacos.discovery.namespace: å‘½åç©ºé—´IDï¼ŒNacosé€šè¿‡ä¸åŒçš„å‘½åç©ºé—´æ¥åŒºåˆ†ä¸åŒçš„ç¯å¢ƒï¼Œè¿›è¡Œæ•°æ®éš”ç¦»ï¼ŒæœåŠ¡æ¶ˆè´¹æ—¶åªèƒ½æ¶ˆè´¹åˆ°å¯¹åº”å‘½åç©ºé—´ä¸‹çš„æœåŠ¡ã€‚ spring.cloud.nacos.discovery.naming-load-cache-at-start: é»˜è®¤ä¸ºfalseã€‚å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶æ˜¯å¦è¯»å–æœ¬åœ°é…ç½®é¡¹(ä¸€ä¸ªæ–‡ä»¶)æ¥è·å–æœåŠ¡åˆ—è¡¨. æ³¨ï¼šæ¨èè¯¥å€¼ä¸ºfalseï¼Œè‹¥æ”¹æˆtrueã€‚åˆ™å®¢æˆ·ç«¯ä¼šåœ¨æœ¬åœ°çš„ä¸€ä¸ªæ–‡ä»¶ä¸­ä¿å­˜æœåŠ¡ä¿¡æ¯ï¼Œå½“ä¸‹æ¬¡å®•æœºå¯åŠ¨æ—¶ï¼Œä¼šä¼˜å…ˆè¯»å–æœ¬åœ°çš„é…ç½®å¯¹å¤–æä¾›æœåŠ¡ã€‚ spring.cloud.nacos.discovery.port: å‘nacosæ³¨å†ŒæœåŠ¡æ—¶ï¼ŒæœåŠ¡å¯¹åº”çš„ç«¯å£å· . æ³¨:æ— éœ€ä¿®æ”¹ï¼Œé»˜è®¤ä¸ºåº”ç”¨å¯¹å¤–æä¾›æœåŠ¡çš„ç«¯å£å·,server.port spring.cloud.nacos.discovery.register-enabled: è¯¥é¡¹ç›®æ˜¯å¦å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œé»˜è®¤ä¸ºtrue . æ³¨ï¼šå¦‚æœæœåŠ¡ä»æ³¨å†Œä¸­å¿ƒåªæ¶ˆè´¹æœåŠ¡ï¼Œæ²¡æœ‰å¯¹å¤–æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆè¯¥å€¼å¯è®¾ç½®ä¸ºfalseï¼Œå¯å‡å°‘å®¢æˆ·ç«¯çº¿ç¨‹æ± çš„åˆ›å»ºï¼Œæ— éœ€å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³è¯·æ±‚ï¼Œæé«˜æ€§èƒ½ã€‚ spring.cloud.nacos.discovery.server-addr nacosé›†ç¾¤åœ°å€ã€‚æ³¨ï¼šå¤šä¸ªIPå¯ä»¥é€šè¿‡â€œï¼Œâ€å·éš”ç¦»ï¼Œä¾‹å¦‚192.168.80.1:8848,192.168.80.1:8848 å¡«å†™åŸŸåæ—¶å‰ç¼€ä¸è¦åŠ ä¸Šhttp:// spring.cloud.nacos.discovery.service: é¡¹ç›®å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æ—¶çš„æœåŠ¡åï¼Œé»˜è®¤ä¸ºspring.application.name å˜é‡ . æ³¨:è¯¥æœåŠ¡åå¿…é¡»ä½¿ç”¨å°å†™ï¼Œå› ä¸ºnacosæœåŠ¡ååŒºåˆ†å¤§å°å†™ï¼Œå¦‚æœæœåŠ¡åä¸å®Œå…¨åŒ¹é…ï¼Œé‚£ä¹ˆæ— æ³•è°ƒç”¨æœåŠ¡ spring.cloud.nacos.discovery.watch-delay: é»˜è®¤ä¸º30sã€‚å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹å®šæœŸå»æŸ¥è¯¢æœåŠ¡ç«¯çš„ä¿¡æ¯åˆ—è¡¨ï¼Œè¯¥è¯·æ±‚ä¸ä¼šç«‹åˆ»è¿”å›ï¼Œé»˜è®¤ç­‰å¾…30sï¼Œè‹¥åœ¨30så†…ï¼ŒæœåŠ¡ç«¯ä¿¡æ¯åˆ—è¡¨å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¯¥è¯·æ±‚ç«‹åˆ»è¿”å›ï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡ç«¯çš„æœåŠ¡ä¿¡æ¯åˆ—è¡¨ï¼Œè‹¥30så†…ï¼Œæ²¡æœ‰å˜åŒ–ï¼Œåˆ™30sæ—¶è¯¥è¯·æ±‚è¿”å›å“åº”ï¼Œå®¢æˆ·ç«¯æœåŠ¡åˆ—è¡¨ä¸å˜ï¼Œå†æ¬¡å‘ç”Ÿè¯¥è¯·æ±‚ã€‚ æ³¨ï¼šæ¨èè¯¥å€¼ä¸º30så³å¯ï¼Œæ— éœ€ä¿®æ”¹ spring.cloud.nacos.discovery.watch.enabled: é»˜è®¤ä¸ºtrue,å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹å®šæœŸå»æŸ¥è¯¢æœåŠ¡ç«¯çš„ä¿¡æ¯åˆ—è¡¨ï¼Œè¯¥è¯·æ±‚ä¸ä¼šç«‹åˆ»è¿”å›ï¼Œé»˜è®¤ç­‰å¾…30sï¼Œè‹¥åœ¨30så†…ï¼ŒæœåŠ¡ç«¯ä¿¡æ¯åˆ—è¡¨å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¯¥è¯·æ±‚ç«‹åˆ»è¿”å›ï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡ç«¯çš„æœåŠ¡ä¿¡æ¯åˆ—è¡¨ï¼Œè‹¥30så†…ï¼Œæ²¡æœ‰å˜åŒ–ï¼Œåˆ™30sæ—¶è¯¥è¯·æ±‚è¿”å›å“åº”ï¼Œå®¢æˆ·ç«¯æœåŠ¡åˆ—è¡¨ä¸å˜ï¼Œå†æ¬¡å‘ç”Ÿè¯¥è¯·æ±‚ã€‚ æ³¨:æ¨èè¯¥åŠŸèƒ½ä¸ºtrueï¼Œè¿™æ˜¯nacosç±»ä¼¼é•¿è¿æ¥æ¨é€æœåŠ¡å˜åŒ–çš„åŠŸèƒ½ï¼Œä¸è¦å…³é—­ spring.cloud.nacos.discovery.weight: nacosæ”¯æŒæœåŠ¡ç«¯åŸºäºæƒé‡çš„è´Ÿè½½å‡è¡¡ï¼Œè¯¥å€¼é»˜è®¤ä¸º1 . æ³¨:å»ºè®®è¯¥å€¼ä¿æŒé»˜è®¤å³å¯ï¼Œå› ä¸ºä»£ç å¯èƒ½ä¼šéƒ¨ç½²åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œæ— æ³•ç¡®ä¿æŸå°æœåŠ¡å™¨çš„é…ç½®ä¸€å®šè¾ƒå¥½ï¼Œå¦‚æœæœ‰éœ€è¦ä¿®æ”¹è¯¥å€¼çš„éœ€æ±‚ï¼Œå¯ä»¥ä¸Šæ§åˆ¶å°ä¿®æ”¹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¯¹åº”IPæœåŠ¡å™¨çš„æƒé‡å€¼è¾ƒé«˜ watch-delay æœ‰ä»€ä¹ˆä½œç”¨?\n4.1 åŸºæœ¬ä½¿ç”¨ pom.xml\ncom.alibaba.cloud spring-cloud-starter-alibaba-nacos-discovery 2.2.1.RELEASE ä½¿ç”¨é…ç½®æ–‡ä»¶å¦‚ä¸‹:\nspring: cloud: nacos: -- é…ç½®ä¸­å¿ƒ config: namespace: xkjNamespace server-addr: 192.168.2.101:8841,192.168.2.101:8845,192.168.2.101:8848 group: xkjGroup -- æ³¨å†Œä¸­å¿ƒ discovery: server-addr: ${spring.cloud.nacos.config.server-addr} cluster-name: xkjCluster -- æ­¤å¤„æ˜¯å‘½åç©ºé—´çš„id namespace: xkjNamespace service: javaDemoDiscovery group: xkjGroup application: name: javaDemo 4.2 åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶,nacoså¦‚ä½•å‘ç°ipçš„ ä¸ Eurekaä½¿ç”¨äº†åŒä¸€ä¸ªå·¥å…·ç±», æœ‰spring-cloud-commonæä¾›çš„ InetUtils ç±», å› æ­¤ä¸¤è€…è·å–ipæ˜¯åŒæ ·çš„åŸç†,è¯¦è§ EurekaåŸç†è¯¦è§£ ç®€å•æ¥è¯´å°±æ˜¯éå†æ‰€æœ‰ç½‘å¡, å»é™¤ä¸€äº›å›æ—‹åœ°å€,å¿½ç•¥åœ°å€ç­‰è§„åˆ™å–ç´¢å¼•æœ€å°çš„, é»˜è®¤è¿”å›æœ¬åœ°åœ°å€\n5. é…ç½®ä¸­å¿ƒ åœ¨ Nacos Spring Cloud ä¸­ï¼ŒdataId çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š\n${prefix}-${spring.profile.active}.${file-extension}\nprefix é»˜è®¤ä¸ºæ‰€å±å·¥ç¨‹é…ç½®spring.application.name çš„å€¼ï¼ˆå³ï¼šnacos-providerï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.prefixæ¥é…ç½®ï¼› spring.profile.active å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ Spring Bootæ–‡æ¡£ã€‚ æ³¨æ„ï¼šå½“spring.profile.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ ${prefix}.${file-extension} file-exetension ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ properties å’Œ yaml ç±»å‹ï¼›é»˜è®¤ä¸º properties ï¼› Nacos å…¥é—¨æ•™ç¨‹_cristianoxmçš„åšå®¢-CSDNåšå®¢_nacos æ•™ç¨‹ pom.xml\ncom.alibaba.cloud spring-cloud-starter-alibaba-nacos-config 2.2.1.RELEASE é…ç½®æ–‡ä»¶:\næ–°å¢bootstrap.ymlæ–‡ä»¶ï¼Œé…ç½®ä¿¡æ¯å†™åœ¨è¯¥æ–‡ä»¶é‡Œã€‚ï¼ˆé—®é¢˜ï¼šå¦‚æ”¾åœ¨application.ymlä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨æŠ¥æ‰¾ä¸åˆ°é…ç½®å±æ€§é”™è¯¯ï¼ŒåŸå› ï¼šapplication.ymlä¸bootstrap.ymlåŠ è½½é¡ºåºä¼˜å…ˆçº§é—®é¢˜ã€‚ï¼‰\nspring: application: name: javaDemo cloud: nacos: server-addr: ${spring.cloud.client.ip-address}:8848 config: namespace: xkjNamespace file-extension: yml shared-configs: - data-id: mysqlTest.yml refresh: true group: xkjGroup extension-configs: - data-id: MyTest.yml refresh: true group: xkjGroup group: xkjGroup # è¯¥é…ç½®å¦‚æœæ”¾åœ¨shareå’Œextentsioné…ç½®çš„å‰é¢,å°†è¦†ç›–å…¶ä¸‹çš„ç»„ javaä½¿ç”¨ç±»:\n@Value(\"${my.name:æœ¬åœ°å€¼name}\") private String name; @Value(\"${person.name:æœ¬åœ°å€¼person.name}\") private String person_name; @Value(\"${personAge:æœ¬åœ°å€¼personAge}\") private String personAge; @Value(\"${personName:æœ¬åœ°å€¼personName}\") private String personName; 5.1 åŠ¨æ€é…ç½® 5.1.1 ä½¿ç”¨ é€šå¸¸è·å–é…ç½®æ–‡ä»¶çš„æ–¹å¼\n@Value\n@ConfigurationProperties(Prefix)\nå¦‚æœæ˜¯åœ¨è¿è¡Œæ—¶è¦åŠ¨æ€æ›´æ–°çš„è¯ï¼Œ\nç¬¬ä¸€ç§æ–¹å¼è¦åœ¨beanä¸ŠåŠ @RefreshScope ç¬¬äºŒç§æ–¹å¼æ˜¯è‡ªåŠ¨æ”¯æŒçš„ã€‚\n5.1.2 åŸç†è¯¦è§£ 5.1.2.1 é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œ\"ç›‘å¬\"æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹ æœåŠ¡å¯åŠ¨åå°±å›è½®è¯¢çš„æ‰“å°å›¾ä¸Šä¿¡æ¯, å½“æœ‰é…ç½®è¢«æ”¹åŠ¨æ—¶, è¿™ä¸ª[] å°±ä¼šåŒ…å«æ•°æ®äº†, å¯æƒ³è€ŒçŸ¥è¿™æ˜¯ç›‘å¬æ—¥å¿—äº†, é‚£å°±æ‰¾åˆ°è¿™æ®µä»£ç \nClientWorker.java\nclass LongPollingRunnable implements Runnable { private int taskId; public LongPollingRunnable(int taskId) { this.taskId = taskId; } @Override public void run() { List\u003cCacheData\u003e cacheDatas = new ArrayList\u003cCacheData\u003e(); List\u003cString\u003e inInitializingCacheList = new ArrayList\u003cString\u003e(); try { // check failover config for (CacheData cacheData : cacheMap.get().values()) { if (cacheData.getTaskId() == taskId) { cacheDatas.add(cacheData); try { checkLocalConfig(cacheData); if (cacheData.isUseLocalConfigInfo()) { cacheData.checkListenerMd5(); } } catch (Exception e) { LOGGER.error(\"get local config info error\", e); } } } // check server config List\u003cString\u003e changedGroupKeys = checkUpdateDataIds(cacheDatas, inInitializingCacheList); LOGGER.info(\"get changedGroupKeys:\" + changedGroupKeys); // çœç•¥å‰©ä¸‹ä»£ç  ..... } } } ä»è¿™é‡Œå°±èƒ½çœ‹å‡º, å…ˆæ˜¯å¯¹é…ç½®åšäº†ä¸€äº›æ£€æŸ¥, ç„¶åå°±æ‰“å°ç»“æœ, è€Œä¸”è¿™ä¸ªæ˜¯åœ¨runæ–¹æ³•é‡Œ, è¯´æ˜è¿™é‡Œè‚¯å®šæ˜¯å¼€äº†çº¿ç¨‹åœ¨è·‘çš„, æ‰¾åˆ°è°ƒç”¨LongPollingRunnableè¿™ä¸ªç±»çš„åœ°æ–¹\nè¿˜æ˜¯åœ¨åŒä¸€ä¸ªç±»ä¸­, å‘ç°æ˜¯åœ¨executeä¸­æ‰§è¡Œçš„, é‚£å°±æ˜¯å¼„äº†ä¸€ä¸ªçº¿ç¨‹æ± , è€Œä¸”è¿™é‡Œæ˜¯åœ¨forå¾ªç¯é‡Œ, çœ‹ä¸€ä¸‹ä»»åŠ¡, å°±ä¼šè”æƒ³åˆ°å¤šä¸ªé…ç½®æ–‡ä»¶çš„æƒ…å†µ, åŒæ—¶ç›‘å¬çš„\npublic void checkConfigInfo() { // åˆ†ä»»åŠ¡ int listenerSize = cacheMap.get().size(); // å‘ä¸Šå–æ•´ä¸ºæ‰¹æ•° int longingTaskCount = (int) Math.ceil(listenerSize / ParamUtil.getPerTaskConfigSize()); if (longingTaskCount \u003e currentLongingTaskCount) { for (int i = (int) currentLongingTaskCount; i \u003c longingTaskCount; i++) { // è¦åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åœ¨æ‰§è¡Œ è¿™å—éœ€è¦å¥½å¥½æƒ³æƒ³ã€‚ ä»»åŠ¡åˆ—è¡¨ç°åœ¨æ˜¯æ— åºçš„ã€‚å˜åŒ–è¿‡ç¨‹å¯èƒ½æœ‰é—®é¢˜ executorService.execute(new LongPollingRunnable(i)); } currentLongingTaskCount = longingTaskCount; } } çœ‹ä¸€ä¸‹è¿™ä¸ªçº¿ç¨‹æ± çš„å‚æ•°.\n@SuppressWarnings(\"PMD.ThreadPoolCreationRule\") public ClientWorker(final HttpAgent agent, final ConfigFilterChainManager configFilterChainManager, final Properties properties) { this.agent = agent; this.configFilterChainManager = configFilterChainManager; // Initialize the timeout parameter init(properties); executor = Executors.newScheduledThreadPool(1, new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread t = new Thread(r); t.setName(\"com.alibaba.nacos.client.Worker.\" + agent.getName()); t.setDaemon(true); return t; } }); // æ‰§è¡Œçš„çº¿ç¨‹æ±  executorService = Executors.newScheduledThreadPool(Runtime.getRuntime().availableProcessors(), new ThreadFactory() { @Override public Thread newThread(Runnable r) { Thread t = new Thread(r); t.setName(\"com.alibaba.nacos.client.Worker.longPolling.\" + agent.getName()); t.setDaemon(true); return t; } }); executor.scheduleWithFixedDelay(new Runnable() { @Override public void run() { try { checkConfigInfo(); } catch (Throwable e) { LOGGER.error(\"[\" + agent.getName() + \"] [sub-check] rotate check error\", e); } } }, 1L, 10L, TimeUnit.MILLISECONDS); } è¿˜ä¼šå‘ç°è¿™é‡Œè¿˜æœ‰ä¸ªå»¶è¿Ÿçº¿ç¨‹æ± ,è€Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ•°, å‘ç°é‡Œé¢æ‰§è¡Œäº†checkConfigInfo(), è¿™åˆšå¥½LongPollingRunnable ç±»æ‰§è¡Œçš„æ‰€åœ¨æ–¹æ³•.\nè‡³æ­¤, å®ƒçš„å®šæ—¶æ‰§è¡Œå°±æ¸…æ¥šäº†, å®ƒå¼€äº†ä¸€ä¸ªå•çº¿ç¨‹çš„å»¶æ—¶çº¿ç¨‹æ± ,æ¯éš”10msæ‰§è¡Œä¸€æ¬¡, çº¿ç¨‹é‡Œå†ç”¨çº¿ç¨‹æ± å»\"ç›‘å¬\"æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹\nä½†æ˜¯æˆ‘ä»¬å‘ç°æ—¥å¿—é—´éš”å¹¶ä¸æ˜¯10ms,è€Œä¸”è¿™ä¸ªé—´éš”ä¹Ÿå¤ªå°äº†, è‚¯å®šä¸åˆç†\n5.1.2.2 é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹ å»çœ‹ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•\"ç›‘å¬\", è·Ÿè¿›com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateDataIds\n/** * ä»Serverè·å–å€¼å˜åŒ–äº†çš„DataIDåˆ—è¡¨ã€‚è¿”å›çš„å¯¹è±¡é‡Œåªæœ‰dataIdå’Œgroupæ˜¯æœ‰æ•ˆçš„ã€‚ ä¿è¯ä¸è¿”å›NULLã€‚ */ List\u003cString\u003e checkUpdateDataIds(List\u003cCacheData\u003e cacheDatas, List\u003cString\u003e inInitializingCacheList) throws IOException { // æ„é€ å‚æ•°- é€šè¿‡é…ç½®dataId/group/tenantç­‰æ•°æ®æ¥æŒ‡å®šæ–‡ä»¶ StringBuilder sb = new StringBuilder(); for (CacheData cacheData : cacheDatas) { if (!cacheData.isUseLocalConfigInfo()) { sb.append(cacheData.dataId).append(WORD_SEPARATOR); sb.append(cacheData.group).append(WORD_SEPARATOR); if (StringUtils.isBlank(cacheData.tenant)) { sb.append(cacheData.getMd5()).append(LINE_SEPARATOR); } else { sb.append(cacheData.getMd5()).append(WORD_SEPARATOR); sb.append(cacheData.getTenant()).append(LINE_SEPARATOR); } if (cacheData.isInitializing()) { // cacheData é¦–æ¬¡å‡ºç°åœ¨cacheMapä¸­\u0026é¦–æ¬¡checkæ›´æ–° inInitializingCacheList .add(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant)); } } } boolean isInitializingCacheList = !inInitializingCacheList.isEmpty(); // æ ¸å¿ƒæ–¹æ³•- æ£€æŸ¥æ›´æ–°æ–‡ä»¶ return checkUpdateConfigStr(sb.toString(), isInitializingCacheList); } com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateConfigStr\n/** * ä»Serverè·å–å€¼å˜åŒ–äº†çš„DataIDåˆ—è¡¨ã€‚è¿”å›çš„å¯¹è±¡é‡Œåªæœ‰dataIdå’Œgroupæ˜¯æœ‰æ•ˆçš„ã€‚ ä¿è¯ä¸è¿”å›NULLã€‚ */ List\u003cString\u003e checkUpdateConfigStr(String probeUpdateString, boolean isInitializingCacheList) throws IOException { List\u003cString\u003e params = new ArrayList\u003cString\u003e(2); params.add(Constants.PROBE_MODIFY_REQUEST); params.add(probeUpdateString); List\u003cString\u003e headers = new ArrayList\u003cString\u003e(2); headers.add(\"Long-Pulling-Timeout\"); // è®¾ç½®é•¿è½®è¯¢çš„è¿‡æœŸæ—¶é—´ headers.add(\"\" + timeout); // told server do not hang me up if new initializing cacheData added in if (isInitializingCacheList) { headers.add(\"Long-Pulling-Timeout-No-Hangup\"); headers.add(\"true\"); } if (StringUtils.isBlank(probeUpdateString)) { return Collections.emptyList(); } try { // In order to prevent the server from handling the delay of the client's long task, // increase the client's read timeout to avoid this problem. long readTimeoutMs = timeout + (long) Math.round(timeout \u003e\u003e 1); // é•¿è½®è¯¢è¯·æ±‚ HttpResult result = agent.httpPost(Constants.CONFIG_CONTROLLER_PATH + \"/listener\", headers, params, agent.getEncode(), readTimeoutMs); if (HttpURLConnection.HTTP_OK == result.code) { setHealthServer(true); // è§£æè¿”å‚ return parseUpdateDataIdResponse(result.content); } else { setHealthServer(false); LOGGER.error(\"[{}] [check-update] get changed dataId error, code: {}\", agent.getName(), result.code); } } catch (IOException e) { setHealthServer(false); LOGGER.error(\"[\" + agent.getName() + \"] [check-update] get changed dataId exception\", e); throw e; } return Collections.emptyList(); } å°±ä¼šå‘ç°å®ƒæ˜¯å‘äº†ä¸€ä¸ªè¯·æ±‚è¿‡å», ç„¶åé€šè¿‡parseUpdateDataIdResponse(result.content) æ–¹æ³•è§£æå‡ºè¿”å‚é‡Œé¢çš„ dataId/group/tenantç­‰æ•°æ®\nè¿™ä¸ªè¯·æ±‚ä¸­è®¾ç½®äº†ä¸€äº›é•¿è½®è¯¢çš„å‚æ•°,è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé•¿è½®è¯¢çš„è¯·æ±‚\né•¿è½®è¯¢: å®¢æˆ·ç«¯å‘èµ·Long Pollingï¼Œæ­¤æ—¶å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰ç›¸å…³æ•°æ®ï¼Œä¼šholdä½è¯·æ±‚ï¼Œç›´åˆ°æœåŠ¡ç«¯æœ‰ç›¸å…³æ•°æ®ï¼Œæˆ–è€…ç­‰å¾…ä¸€å®šæ—¶é—´è¶…æ—¶æ‰ä¼šè¿”å›ã€‚è¿”å›åï¼Œå®¢æˆ·ç«¯åˆä¼šç«‹å³å†æ¬¡å‘èµ·ä¸‹ä¸€æ¬¡Long Pollingã€‚\nè¿™é‡Œåªæ˜¯æ‹¿åˆ°äº†ä¸€ä¸ªdataIdå’Œgroupç­‰æ•°æ®,é‚£ä»€ä¹ˆæ—¶å€™æ‹¿åˆ°å…·ä½“çš„é…ç½®ä¿¡æ¯å‘¢? ç»§ç»­å¾€ä¸‹çœ‹ LongPollingRunnable#run\n// æ£€æŸ¥æ›´æ–°çš„dataId List\u003cString\u003e changedGroupKeys = checkUpdateDataIds(cacheDatas, inInitializingCacheList); LOGGER.info(\"get changedGroupKeys:\" + changedGroupKeys); // éå†è¿™äº›æ–‡ä»¶ for (String groupKey : changedGroupKeys) { String[] key = GroupKey.parseKey(groupKey); String dataId = key[0]; String group = key[1]; String tenant = null; if (key.length == 3) { tenant = key[2]; } try { // è·å¾—å…·ä½“é…ç½® String[] ct = getServerConfig(dataId, group, tenant, 3000L); CacheData cache = cacheMap.get().get(GroupKey.getKeyTenant(dataId, group, tenant)); // æŠŠå†…å®¹ç›´æ¥å†™åˆ°cacheMapä¸­ cache.setContent(ct[0]); if (null != ct[1]) { cache.setType(ct[1]); } LOGGER.info(\"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}\", agent.getName(), dataId, group, tenant, cache.getMd5(), ContentUtils.truncateContent(ct[0]), ct[1]); } catch (NacosException ioe) { String message = String.format( \"[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s\", agent.getName(), dataId, group, tenant); LOGGER.error(message, ioe); } } for (CacheData cacheData : cacheDatas) { if (!cacheData.isInitializing() || inInitializingCacheList .contains(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant))) { // æ£€æŸ¥md5 cacheData.checkListenerMd5(); cacheData.setInitializing(false); } } // ....çœç•¥å‰©ä¸‹ä»£ç  } com.alibaba.nacos.client.config.impl.ClientWorker#getServerConfig è·å¾—å…·ä½“é…ç½®çš„æ–¹æ³•\npublic String[] getServerConfig(String dataId, String group, String tenant, long readTimeout) throws NacosException { String[] ct = new String[2]; if (StringUtils.isBlank(group)) { group = Constants.DEFAULT_GROUP; } HttpResult result = null; try { List\u003cString\u003e params = null; if (StringUtils.isBlank(tenant)) { params = new ArrayList\u003cString\u003e(Arrays.asList(\"dataId\", dataId, \"group\", group)); } else { params = new ArrayList\u003cString\u003e(Arrays.asList(\"dataId\", dataId, \"group\", group, \"tenant\", tenant)); } // é€šè¿‡getè¯·æ±‚,è·å¾—å…·ä½“é…ç½® result = agent.httpGet(Constants.CONFIG_CONTROLLER_PATH, null, params, agent.getEncode(), readTimeout); } catch (IOException e) { String message = String.format( \"[%s] [sub-server] get server config exception, dataId=%s, group=%s, tenant=%s\", agent.getName(), dataId, group, tenant); LOGGER.error(message, e); throw new NacosException(NacosException.SERVER_ERROR, e); } switch (result.code) { case HttpURLConnection.HTTP_OK: // å…ˆæ”¾åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ LocalConfigInfoProcessor.saveSnapshot(agent.getName(), dataId, group, tenant, result.content); // å°†è¯·æ±‚è¿”å‚æ”¾å…¥ctæ•°ç»„ä¸­ ct[0] = result.content; if (result.headers.containsKey(CONFIG_TYPE)) { ct[1] = result.headers.get(CONFIG_TYPE).get(0); } else { ct[1] = ConfigType.TEXT.getType(); } return ct; case HttpURLConnection.HTTP_NOT_FOUND: // çœç•¥å‰©ä¸‹ä»£ç ...... } è‡³æ­¤, æ¸…æ¥šäº†å®ƒæ˜¯å¦‚ä½•æ‹¿åˆ°å…·ä½“é…ç½®çš„äº†, å®ƒé€šè¿‡(ä¸€æ¬¡postè¯·æ±‚)é•¿è½®è¯¢çš„æ–¹å¼å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥, è·å¾—dataId/groupç­‰æ•°æ®, å†é€šè¿‡è¿™äº›å‚æ•°å‘èµ·getè¯·æ±‚è·å¾—å…·ä½“çš„é…ç½®æ–‡ä»¶å†…å®¹,å¹¶å†™åˆ°æœ¬åœ°ç¼“å­˜ä¸­ä½¿ç”¨\n5.1.2.3 æ‹¿åˆ°é…ç½®åé€šè¿‡applicationContextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­ å®ƒå–åˆ°è¿™äº›é…ç½®å,æ˜¯å¦‚ä½•å†™åˆ°é¡¹ç›®çš„å†…å­˜ä¸­å¹¶ä½¿å…¶ç”Ÿæ•ˆçš„å‘¢?\ntry { String[] ct = getServerConfig(dataId, group, tenant, 3000L); CacheData cache = cacheMap.get().get(GroupKey.getKeyTenant(dataId, group, tenant)); cache.setContent(ct[0]); if (null != ct[1]) { cache.setType(ct[1]); } LOGGER.info(\"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}\", agent.getName(), dataId, group, tenant, cache.getMd5(), ContentUtils.truncateContent(ct[0]), ct[1]); } catch (NacosException ioe) { String message = String.format( \"[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s\", agent.getName(), dataId, group, tenant); LOGGER.error(message, ioe); } } for (CacheData cacheData : cacheDatas) { if (!cacheData.isInitializing() || inInitializingCacheList .contains(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant))) { // æ£€æŸ¥md5 cacheData.checkListenerMd5(); cacheData.setInitializing(false); } } // çœç•¥å‰©ä¸‹ä»£ç ..... } åœ¨å–åˆ°å…·ä½“é…ç½®å,éå†cacheDatasæ•°æ®,å¹¶æ£€æŸ¥md5, è·Ÿè¿›å»çœ‹ä¸€ä¸‹, å®ƒå¼€å§‹å‡ºç°ç›‘å¬å™¨äº†\nvoid checkListenerMd5() { for (ManagerListenerWrap wrap : listeners) { if (!md5.equals(wrap.lastCallMd5)) { safeNotifyListener(dataId, group, content, type, md5, wrap); } } } private void safeNotifyListener(final String dataId, final String group, final String content, final String type, final String md5, final ManagerListenerWrap listenerWrap) { final Listener listener = listenerWrap.listener; Runnable job = new Runnable() { @Override public void run() { ClassLoader myClassLoader = Thread.currentThread().getContextClassLoader(); ClassLoader appClassLoader = listener.getClass().getClassLoader(); try { if (listener instanceof AbstractSharedListener) { AbstractSharedListener adapter = (AbstractSharedListener) listener; adapter.fillContext(dataId, group); LOGGER.info(\"[{}] [notify-context] dataId={}, group={}, md5={}\", name, dataId, group, md5); } // æ‰§è¡Œå›è°ƒä¹‹å‰å…ˆå°†çº¿ç¨‹classloaderè®¾ç½®ä¸ºå…·ä½“webappçš„classloaderï¼Œä»¥å…å›è°ƒæ–¹æ³•ä¸­è°ƒç”¨spiæ¥å£æ˜¯å‡ºç°å¼‚å¸¸æˆ–é”™ç”¨ï¼ˆå¤šåº”ç”¨éƒ¨ç½²æ‰ä¼šæœ‰è¯¥é—®é¢˜ï¼‰ã€‚ Thread.currentThread().setContextClassLoader(appClassLoader); ConfigResponse cr = new ConfigResponse(); cr.setDataId(dataId); cr.setGroup(group); cr.setContent(content); configFilterChainManager.doFilter(null, cr); String contentTmp = cr.getContent(); // å¤„ç†é…ç½®ä¿¡æ¯ listener.receiveConfigInfo(contentTmp); // compare lastContent and content if (listener instanceof AbstractConfigChangeListener) { Map data = ConfigChangeHandler.getInstance().parseChangeData(listenerWrap.lastContent, content, type); ConfigChangeEvent event = new ConfigChangeEvent(data); ((AbstractConfigChangeListener)listener).receiveConfigChange(event); listenerWrap.lastContent = content; } listenerWrap.lastCallMd5 = md5; LOGGER.info(\"[{}] [notify-ok] dataId={}, group={}, md5={}, listener={} \", name, dataId, group, md5, listener); } catch (NacosException de) { LOGGER.error(\"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} errCode={} errMsg={}\", name, dataId, group, md5, listener, de.getErrCode(), de.getErrMsg()); } catch (Throwable t) { LOGGER.error(\"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} tx={}\", name, dataId, group, md5, listener, t.getCause()); } finally { Thread.currentThread().setContextClassLoader(myClassLoader); } } }; final long startNotify = System.currentTimeMillis(); try { if (null != listener.getExecutor()) { listener.getExecutor().execute(job); } else { job.run(); } } catch (Throwable t) { LOGGER.error(\"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} throwable={}\", name, dataId, group, md5, listener, t.getCause()); } final long finishNotify = System.currentTimeMillis(); LOGGER.info(\"[{}] [notify-listener] time cost={}ms in ClientWorker, dataId={}, group={}, md5={}, listener={} \", name, (finishNotify - startNotify), dataId, group, md5, listener); } è¿™ä¹ˆé•¿çš„ä»£ç ,æ ¸å¿ƒå°±æ˜¯å¤„ç†äº†é‚£ä¸ªrunable, å…¶ä¸­è°ƒç”¨äº†listener.receiveConfigInfo(contentTmp) æ–¹æ³•å¤„ç†çš„ç›‘å¬å™¨,å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±», æ‰¾åˆ°å®ƒçš„å®ç°ç±»\ncom.alibaba.cloud.nacos.refresh.NacosContextRefresher\nprivate void registerNacosListener(final String groupKey, final String dataKey) { String key = NacosPropertySourceRepository.getMapKey(dataKey, groupKey); Listener listener = listenerMap.computeIfAbsent(key, lst -\u003e new AbstractSharedListener() { @Override public void innerReceive(String dataId, String group, String configInfo) { refreshCountIncrement(); nacosRefreshHistory.addRefreshRecord(dataId, group, configInfo); // todo feature: support single refresh for listening // é€šè¿‡applicationContextçš„äº‹ä»¶å»æ›´æ–°é…ç½® applicationContext.publishEvent( new RefreshEvent(this, null, \"Refresh Nacos config\")); if (log.isDebugEnabled()) { log.debug(String.format( \"Refresh Nacos config group=%s,dataId=%s,configInfo=%s\", group, dataId, configInfo)); } } }); try { configService.addListener(dataKey, groupKey, listener); } catch (NacosException e) { log.warn(String.format( \"register fail for nacos listener ,dataId=[%s],group=[%s]\", dataKey, groupKey), e); } } è‡³æ­¤, æ¸…æ¥šäº†è·å¾—çš„é…ç½®æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„, å®ƒå°†è·å¾—å‘ç”Ÿä¿®æ”¹è¿‡çš„æ–‡ä»¶, å¦‚æœmd5ä¸ä¸€æ ·äº†, åˆ™æ‰§è¡Œç›‘å¬å™¨,é€šè¿‡applicationContext æ›´æ–°é…ç½®åˆ°é¡¹ç›®å†…å­˜ä¸­\næ˜æ˜å·²ç»çŸ¥é“äº†å“ªäº›æ–‡ä»¶è¢«ä¿®æ”¹äº†,ä¸ºå•¥è¿˜æœ‰æ¯”å¯¹md5, å› ä¸ºå¯èƒ½æ˜¯æ²¡æœ‰ä¿®æ”¹å…·ä½“å†…å®¹,åªæ˜¯ç‚¹äº†ç¼–è¾‘å¹¶ä¿å­˜\nmd5ç”¨çš„æ˜¯javaçš„digestå’Œä½ç§»,md5å¯èƒ½å­˜åœ¨å†²çª, é‚£æ€ä¹ˆè§£å†³å†²çªé—®é¢˜çš„?\n5.1.3 æ€»ç»“ 1.Nacos å®¢æˆ·ç«¯ä¼šå¾ªç¯è¯·æ±‚æœåŠ¡ç«¯å˜æ›´çš„æ•°æ®ï¼Œå¹¶ä¸”è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º30sï¼Œå½“é…ç½®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¯·æ±‚çš„å“åº”ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™ä¼šä¸€ç›´ç­‰åˆ° 29.5s+ ä¹‹åå†è¿”å›å“åº” 2.Nacos å®¢æˆ·ç«¯èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥åˆ°æœåŠ¡ç«¯é…ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚ 3.å®æ—¶æ„ŸçŸ¥æ˜¯å»ºç«‹åœ¨å®¢æˆ·ç«¯æ‹‰å’ŒæœåŠ¡ç«¯â€œæ¨â€çš„åŸºç¡€ä¸Šï¼Œä½†æ˜¯è¿™é‡Œçš„æœåŠ¡ç«¯â€œæ¨â€éœ€è¦æ‰“ä¸Šå¼•å·ï¼Œå› ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç›´æ¥æœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡ http è¿›è¡Œæ•°æ®é€šè®¯çš„ï¼Œä¹‹æ‰€ä»¥æœ‰â€œæ¨â€çš„æ„Ÿè§‰ï¼Œæ˜¯å› ä¸ºæœåŠ¡ç«¯ä¸»åŠ¨å°†å˜æ›´åçš„æ•°æ®é€šè¿‡ http çš„ response å¯¹è±¡æå‰å†™å…¥äº†ã€‚ Long Pollingé•¿è½®è¯¢è¯¦è§£ - ç®€ä¹¦ (jianshu.com) NACOSåŠ¨æ€é…ç½® - barryzhou - åšå®¢å›­ (cnblogs.com) spring boot é…ç½®æ–‡ä»¶åŠ¨æ€æ›´æ–°åŸç† ä»¥Nacosä¸ºä¾‹ - äºŒå¥ - åšå®¢å›­ (cnblogs.com) Nacos é…ç½®ä¸­å¿ƒåŸç†åˆ†æ -ç¬¬ä¸€ç¯‡- ç®€ä¹¦ (jianshu.com) Nacos é…ç½®ä¸­å¿ƒåŸç†åˆ†æ -ç¬¬äºŒç¯‡ - ç®€ä¹¦ (jianshu.com) A\u0026Q nacosé›†ç¾¤æ¶æ„?\nç­”: å’ŒEurekaé›†ç¾¤æ¶æ„ä¸€æ ·,ä»–çš„æ•°æ®æ˜¯ç‚¹å¯¹ç‚¹çš„, æœ¬èº«æ˜¯ä¸»ä»ç»“æ„,ä¹Ÿå°±æ˜¯è¯´ä¼šäº§ç”Ÿè¿‡åŠé€‰ä¸¾,è„‘è£‚ç­‰çŸ¥è¯†ç‚¹, é»˜è®¤æ”¯æŒcapç†è®ºä¸­çš„apæ¨¡å¼. ç”Ÿäº§éƒ¨ç½²nacosé›†ç¾¤æ—¶,æ¨èé€šè¿‡NGINXç»™nacosé›†ç¾¤åšè´Ÿè½½å‡è¡¡\næµ…è°ˆNacosä¸­çš„CAP - åŒ…å­å–å®Œäº†å˜› - åšå®¢å›­ (cnblogs.com) nacoså¦‚ä½•å®ç°åŠ¨æ€é…ç½®?\nç­”: ä½¿ç”¨é•¿è½®è¯¢æœºåˆ¶,ç”±å®¢æˆ·ç«¯å®šæ—¶å‘èµ·è¯·æ±‚è¯¢é—®æœåŠ¡ç«¯æ˜¯å¦æœ‰ä¿®æ”¹, å¦‚æœå­˜åœ¨ä¿®æ”¹åˆ™é€šè¿‡applicationContextçš„publishEventæ›´æ–°å†…å­˜ä¸­çš„é…ç½®\nä¸€æ¬¡è¯·æ±‚åå°†é˜»å¡29.5s+, æ‰ä¼šå‘èµ·ä¸‹ä¸€æ¬¡è¯·æ±‚, å¦‚æœé‡åˆ°æœåŠ¡ç«¯å­˜åœ¨ä¿®æ”¹æ–‡ä»¶, åˆ™ä¼šç«‹å³è¿”å›.\nå®šæ—¶æœºåˆ¶æ˜¯å¼€äº†ä¸€ä¸ªå»¶æ—¶çº¿ç¨‹æ± ,å…¶ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹,æ¯éš”10mså‘èµ·ä¸€æ¬¡è¯·æ±‚, æœåŠ¡å¯åŠ¨æ—¶è¯¥ä»»åŠ¡å°±æ‰§è¡Œäº†\n","wordCount":"6949","inLanguage":"zh","datePublished":"2023-09-01T00:00:00Z","dateModified":"2023-11-01T17:44:19+08:00","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Nacos.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class="dark" id="top"><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class="header"><nav class="nav"><div class="logo"><a accesskey="h" href="https://xiaokunji.com/zh/" title="ç±³äºŒ (Alt + H)"><img alt="" aria-label="logo" height="35" src="https://xiaokunji.com/img/Q.svg"/>ç±³äºŒ</a><div class="logo-switches"><button accesskey="t" id="theme-toggle" title="(Alt + T)"><svg fill="none" height="18" id="moon" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path></svg><svg fill="none" height="18" id="sun" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg></button><ul class="lang-switch"><li>|</li><li><a aria-label="English" href="https://xiaokunji.com/en/" title="English">English</a></li></ul></div></div><ul id="menu"><li><a href="https://xiaokunji.com/zh/" title="ğŸ ä¸»é¡µ"><span>ğŸ ä¸»é¡µ</span></a></li><li><a accesskey="/" href="https://xiaokunji.com/zh/search" title="ğŸ”æœç´¢ (Alt + /)"><span>ğŸ”æœç´¢</span></a></li><li><a href="https://xiaokunji.com/zh/post.html" title="ğŸ“šæ–‡ç« "><span>ğŸ“šæ–‡ç« </span></a></li><li><a href="https://xiaokunji.com/zh/archives.html" title="â±æ—¶é—´è½´"><span>â±æ—¶é—´è½´</span></a></li><li><a href="https://xiaokunji.com/zh/tags.html" title="ğŸ”–æ ‡ç­¾"><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href="https://xiaokunji.com/zh/categories.html" title="ğŸ“–åˆ†ç±»"><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href="https://xiaokunji.com/zh/links.html" title="ğŸ¤å‹é“¾"><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><nav aria-label="breadcrumb"><ul><a href="https://xiaokunji.com/zh/">ğŸ </a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">javaåŠå…¶æ¡†æ¶</a> <span>&gt;</span>
<a href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud.html">SpringCloud</a> <span>&gt;</span></ul></nav><h1 class="post-title">Nacos</h1><div class="post-description">nacosåŸºæœ¬ä½¿ç”¨ä»¥åŠåŠ¨æ€é…ç½®åŸç†</div><div class="post-meta">åˆ›å»º:&amp;nbsp;&lt;span title='2023-09-01 00:00:00 +0000 UTC'&gt;2023-09-01&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;æ›´æ–°:&amp;nbsp;2023-11-01&amp;nbsp;Â·&amp;nbsp;xkj
Â |Â åˆ†ç±»: Â <ul class="post-categories-meta" style="display:inline"><a href="https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">javaåŠå…¶æ¡†æ¶</a></ul><span id="busuanzi_container_page_pv">Â | è®¿é—®: <span id="busuanzi_value_page_pv">1</span></span></div></header><aside class="toc-container wide" id="toc-container"><div class="toc"><details open=""><summary accesskey="c" title="(Alt + C)"><span class="details">ç›®å½•</span></summary><div class="inner"><ul><li><a aria-label="å‰è¨€" href="#%e5%89%8d%e8%a8%80">å‰è¨€</a></li><li><a aria-label="1. æ¦‚å¿µ" href="#1-%e6%a6%82%e5%bf%b5">1. æ¦‚å¿µ</a></li><li><a aria-label="2. æ¶æ„" href="#2-%e6%9e%b6%e6%9e%84">2. æ¶æ„</a></li><li><a aria-label="3. å®‰è£…" href="#3-%e5%ae%89%e8%a3%85">3. å®‰è£…</a><ul><li><a aria-label="3.1 Nacos Server æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š" href="#31-nacos-server-%e6%9c%89%e4%b8%a4%e7%a7%8d%e8%bf%90%e8%a1%8c%e6%a8%a1%e5%bc%8f">3.1 Nacos Server æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š</a><ul><li><a aria-label="3.1.1 standalone æ¨¡å¼" href="#311-standalone-%e6%a8%a1%e5%bc%8f">3.1.1 standalone æ¨¡å¼</a></li><li><a aria-label="3.1.2 cluster æ¨¡å¼" href="#312-cluster-%e6%a8%a1%e5%bc%8f">3.1.2 cluster æ¨¡å¼</a></li></ul></li></ul></li><li><a aria-label="4. æ³¨å†Œä¸­å¿ƒ" href="#4-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83">4. æ³¨å†Œä¸­å¿ƒ</a><ul><li><a aria-label="4.1 åŸºæœ¬ä½¿ç”¨" href="#41-%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8">4.1 åŸºæœ¬ä½¿ç”¨</a></li><li><a aria-label="4.2 åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶,nacoså¦‚ä½•å‘ç°ipçš„" href="#42-%e5%9c%a8%e4%b8%8d%e5%86%99%e6%9c%ac%e6%9c%ba%e5%9c%b0%e5%9d%80%e6%97%b6nacos%e5%a6%82%e4%bd%95%e5%8f%91%e7%8e%b0ip%e7%9a%84">4.2 åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶,nacoså¦‚ä½•å‘ç°ipçš„</a></li></ul></li><li><a aria-label="5. é…ç½®ä¸­å¿ƒ" href="#5-%e9%85%8d%e7%bd%ae%e4%b8%ad%e5%bf%83">5. é…ç½®ä¸­å¿ƒ</a><ul><li><a aria-label="5.1 åŠ¨æ€é…ç½®" href="#51-%e5%8a%a8%e6%80%81%e9%85%8d%e7%bd%ae">5.1 åŠ¨æ€é…ç½®</a><ul><li><a aria-label="5.1.1 ä½¿ç”¨" href="#511-%e4%bd%bf%e7%94%a8">5.1.1 ä½¿ç”¨</a></li><li><a aria-label="5.1.2 åŸç†è¯¦è§£" href="#512-%e5%8e%9f%e7%90%86%e8%af%a6%e8%a7%a3">5.1.2 åŸç†è¯¦è§£</a><ul><li><a aria-label="5.1.2.1 é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œ&amp;quot;ç›‘å¬&amp;quot;æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹" href="#5121-%e9%87%87%e7%94%a8%e5%bb%b6%e8%bf%9f%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%ae%9a%e6%97%b6%e6%89%a7%e8%a1%8c%e7%9b%91%e5%90%ac%e6%96%87%e4%bb%b6%e6%98%af%e5%90%a6%e6%9c%89%e4%bf%ae%e6%94%b9">5.1.2.1 é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œ"ç›‘å¬"æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹</a></li><li><a aria-label="5.1.2.2 é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹" href="#5122-%e9%80%9a%e8%bf%87%e9%95%bf%e8%bd%ae%e8%af%a2%e7%9a%84%e6%96%b9%e5%bc%8f%e8%8e%b7%e5%be%97%e4%bf%ae%e6%94%b9%e8%bf%87%e7%9a%84%e6%96%87%e4%bb%b6%e5%8f%8a%e5%85%b6%e5%86%85%e5%ae%b9">5.1.2.2 é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹</a></li><li><a aria-label="5.1.2.3 æ‹¿åˆ°é…ç½®åé€šè¿‡applicationContextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­" href="#5123-%e6%8b%bf%e5%88%b0%e9%85%8d%e7%bd%ae%e5%90%8e%e9%80%9a%e8%bf%87applicationcontext%e6%9b%b4%e6%96%b0%e5%88%b0%e9%a1%b9%e7%9b%ae%e5%86%85%e5%ad%98%e4%b8%ad">5.1.2.3 æ‹¿åˆ°é…ç½®åé€šè¿‡applicationContextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­</a></li></ul></li><li><a aria-label="5.1.3 æ€»ç»“" href="#513-%e6%80%bb%e7%bb%93">5.1.3 æ€»ç»“</a></li></ul></li></ul></li><li><a aria-label="A&amp;amp;Q" href="#aq">A&amp;Q</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class="post-content"><p>[toc]</p><h1 id="å‰è¨€">å‰è¨€<a aria-hidden="true" class="anchor" hidden="" href="#å‰è¨€">#</a></h1><p>é˜¿é‡Œå¼€æºçš„æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ</p><p><img alt="nacos_map" loading="lazy" src="https://nacos.io/img/nacosMap.jpg"/></p><p><a href="https://nacos.io/zh-cn/docs/what-is-nacos.html" rel="noopener" target="_blank">Nacos å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://github.com/alibaba/nacos" rel="noopener" target="_blank">Nacos æºç </a></p><h1 id="1-æ¦‚å¿µ">1. æ¦‚å¿µ<a aria-hidden="true" class="anchor" hidden="" href="#1-æ¦‚å¿µ">#</a></h1><p><strong>Name Space</strong></p><p>ç”¨äºè¿›è¡Œç§Ÿæˆ·ç²’åº¦çš„é…ç½®éš”ç¦»ã€‚ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥å­˜åœ¨ç›¸åŒçš„ Group æˆ– Data ID çš„é…ç½®ã€‚Namespace çš„å¸¸ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯<strong>ä¸åŒç¯å¢ƒçš„é…ç½®</strong>çš„åŒºåˆ†éš”ç¦»ï¼Œä¾‹å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºï¼ˆå¦‚é…ç½®ã€æœåŠ¡ï¼‰éš”ç¦»ç­‰ã€‚</p><p><strong>Configuration</strong></p><p>é…ç½®æ–‡ä»¶</p><p><strong>Data ID</strong></p><p>Nacos ä¸­çš„æŸä¸ªé…ç½®é›†çš„ IDã€‚é…ç½®é›† ID æ˜¯ç»„ç»‡åˆ’åˆ†é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚Data ID é€šå¸¸ç”¨äºç»„ç»‡åˆ’åˆ†ç³»ç»Ÿçš„é…ç½®é›†ã€‚ä¸€ä¸ªç³»ç»Ÿæˆ–è€…åº”ç”¨å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®é›†ï¼Œæ¯ä¸ªé…ç½®é›†éƒ½å¯ä»¥è¢«ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°æ ‡è¯†ã€‚Data ID é€šå¸¸é‡‡ç”¨ç±» Java åŒ…ï¼ˆå¦‚ com.taobao.tc.refund.log.levelï¼‰çš„å‘½åè§„åˆ™ä¿è¯å…¨å±€å”¯ä¸€æ€§ã€‚æ­¤å‘½åè§„åˆ™éå¼ºåˆ¶ã€‚</p><p><strong>Group</strong></p><p>Nacos ä¸­çš„ä¸€ç»„é…ç½®é›†ï¼Œæ˜¯ç»„ç»‡é…ç½®çš„ç»´åº¦ä¹‹ä¸€ã€‚é€šè¿‡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ Buy æˆ– Trade ï¼‰å¯¹é…ç½®é›†è¿›è¡Œåˆ†ç»„ï¼Œä»è€ŒåŒºåˆ† Data ID ç›¸åŒçš„é…ç½®é›†ã€‚å½“æ‚¨åœ¨ Nacos ä¸Šåˆ›å»ºä¸€ä¸ªé…ç½®æ—¶ï¼Œå¦‚æœæœªå¡«å†™é…ç½®åˆ†ç»„çš„åç§°ï¼Œåˆ™é…ç½®åˆ†ç»„çš„åç§°é»˜è®¤é‡‡ç”¨ DEFAULT_GROUP ã€‚é…ç½®åˆ†ç»„çš„å¸¸è§åœºæ™¯ï¼šä¸åŒçš„åº”ç”¨æˆ–ç»„ä»¶ä½¿ç”¨äº†ç›¸åŒçš„é…ç½®ç±»å‹ï¼Œå¦‚ database_url é…ç½®å’Œ MQ_topic é…ç½®ã€‚</p><p><strong>Virtual Cluster</strong></p><p>åŒä¸€ä¸ªæœåŠ¡ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹ç»„æˆä¸€ä¸ªé»˜è®¤é›†ç¾¤, é›†ç¾¤å¯ä»¥è¢«è¿›ä¸€æ­¥æŒ‰éœ€æ±‚åˆ’åˆ†ï¼Œåˆ’åˆ†çš„å•ä½å¯ä»¥æ˜¯è™šæ‹Ÿé›†ç¾¤ã€‚</p><blockquote><p>å¦‚å›¾: <img alt="image-20220124164513719" src="./Nacos.assets/1698831453037.jpg" style="zoom:50%"/></p></blockquote><p><img alt="nacos_data_model" loading="lazy" src="./Nacos.assets/1561217857314-95ab332c-acfb-40b2-957a-aae26c2b5d71.jpeg"/></p><p><a href="https://nacos.io/zh-cn/docs/concepts.html" rel="noopener" target="_blank">Nacos æ¦‚å¿µ</a></p><h1 id="2-æ¶æ„">2. æ¶æ„<a aria-hidden="true" class="anchor" hidden="" href="#2-æ¶æ„">#</a></h1><p><img alt="nacos_arch.jpg" loading="lazy" src="./Nacos.assets/1561217892717-1418fb9b-7faa-4324-87b9-f1740329f564.jpeg"/></p><p><img alt="nacos-logic.jpg" loading="lazy" src="./Nacos.assets/1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png"/></p><h1 id="3-å®‰è£…">3. å®‰è£…<a aria-hidden="true" class="anchor" hidden="" href="#3-å®‰è£…">#</a></h1><p>Nacos Serverä¸‹è½½åœ°å€ï¼š</p><p><a href="https://github.com/alibaba/nacos/releases" rel="noopener" target="_blank">https://github.com/alibaba/nacos/releases</a></p><p>ä¸‹è½½è§£å‹åæ‰“å¼€binç›®å½•</p><p><code>/work/nacos/bin/startup.sh -m standalone</code></p><blockquote><p>windows: <code>startup.cmd -m standalone</code></p></blockquote><p>å¯åŠ¨å®Œåè®¿é—®åå°</p><p>Nacos Serverçš„åå°è®¿é—®åœ°å€ï¼š</p><p>http://192.168.10.13:8848/nacos/index.html</p><p>é»˜è®¤è´¦å·å’Œå¯†ç ä¸ºï¼š<code>nacos/nacos</code></p><p><img alt="1698831533124" loading="lazy" src="./Nacos.assets/1698831533124.jpg"/></p><h2 id="31-nacos-server-æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼">3.1 Nacos Server æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š<a aria-hidden="true" class="anchor" hidden="" href="#31-nacos-server-æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼">#</a></h2><ul><li>standalone</li><li>cluster (é»˜è®¤æ¨¡å¼)</li></ul><h3 id="311-standalone-æ¨¡å¼">3.1.1 standalone æ¨¡å¼<a aria-hidden="true" class="anchor" hidden="" href="#311-standalone-æ¨¡å¼">#</a></h3><p>æ­¤æ¨¡å¼ä¸€èˆ¬ç”¨äº demo å’Œæµ‹è¯•ï¼Œä¸ç”¨æ”¹ä»»ä½•é…ç½®ï¼Œç›´æ¥æ•²ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œ</p><h3 id="312-cluster-æ¨¡å¼">3.1.2 cluster æ¨¡å¼<a aria-hidden="true" class="anchor" hidden="" href="#312-cluster-æ¨¡å¼">#</a></h3><p>cluster æ¨¡å¼éœ€è¦ä¾èµ– MySQLï¼Œç„¶åæ”¹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼š</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-fallback" data-lang="fallback"><span style="display:flex"><span>conf/cluster.conf
</span></span><span style="display:flex"><span>conf/application.properties
</span></span></code></pre></div><p><strong><code>conf/cluster.conf</code></strong></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-fallback" data-lang="fallback"><span style="display:flex"><span># é›†ç¾¤èŠ‚ç‚¹(æ­¤å¤„æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Š,æ‰€ä»¥ç”¨ipåŒºåˆ†)
</span></span><span style="display:flex"><span>192.168.10.13:8841
</span></span><span style="display:flex"><span>192.168.10.13:8845
</span></span><span style="display:flex"><span>192.168.10.13:8848
</span></span></code></pre></div><p><strong><code>conf/application.properties</code></strong></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-properties" data-lang="properties"><span style="display:flex"><span>spring.datasource.platform<span style="color:#ff7b72;font-weight:700">=</span><span style="color:#a5d6ff">mysql</span>
</span></span><span style="display:flex"><span>db.num<span style="color:#ff7b72;font-weight:700">=</span><span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex"><span>db.url.0<span style="color:#ff7b72;font-weight:700">=</span><span style="color:#a5d6ff">jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC&amp;AllowPublicKeyRetrieval=True</span>
</span></span><span style="display:flex"><span>db.user.0<span style="color:#ff7b72;font-weight:700">=</span><span style="color:#a5d6ff">test</span>
</span></span><span style="display:flex"><span>db.password.0<span style="color:#ff7b72;font-weight:700">=</span><span style="color:#a5d6ff">xiaokunji</span>
</span></span></code></pre></div><blockquote><p>æ¯ä¸ªèŠ‚ç‚¹ä¸Šéœ€è¦æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶</p><p>æ³¨æ„åœ¨application.propertiesæ–‡ä»¶ä¸­ä¿®æ”¹ç«¯å£</p></blockquote><p>å¯åŠ¨å ä»»æ„èŠ‚ç‚¹éƒ½èƒ½è¿›å…¥ç®¡ç†ç•Œé¢</p><p><img alt="1698831554955" loading="lazy" src="./Nacos.assets/1698831554955.jpg"/></p><p><a href="https://developer.aliyun.com/article/738219" rel="noopener" target="_blank">é˜¿é‡Œå·´å·´NACOSï¼ˆ3ï¼‰- éƒ¨ç½²Nacosçš„ç”Ÿäº§é›†ç¾¤ç¯å¢ƒ-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com)</a></p><blockquote><p>ä¸€èˆ¬é›†ç¾¤éƒ¨ç½²éœ€è¦æ­é…NGINX, è¿™æ ·å°±å¯ä»¥ç»Ÿä¸€ç®¡ç†å¯¹å¤–ip, ä¸”éœ€è¦åˆ©ç”¨NGINXçš„æ•…éšœè½¬ç§»ç­–ç•¥, nacosæœ¬èº«ä¸å…·å¤‡æ•…éšœè½¬ç§»</p></blockquote><p><a href="https://www.cnblogs.com/FlyAway2013/p/11201250.html" rel="noopener" target="_blank">Nacos é›†ç¾¤éƒ¨ç½² - CanntBelieve - åšå®¢å›­ (cnblogs.com)</a></p><h1 id="4-æ³¨å†Œä¸­å¿ƒ">4. æ³¨å†Œä¸­å¿ƒ<a aria-hidden="true" class="anchor" hidden="" href="#4-æ³¨å†Œä¸­å¿ƒ">#</a></h1><p><strong>å‚æ•°è§£é‡Š</strong></p><table><thead><tr><th>å‚æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>com.alibaba.nacos.naming.log.level</code></td><td>Namingå®¢æˆ·ç«¯çš„æ—¥å¿—çº§åˆ«ï¼Œæ”¹å±æ€§é€šè¿‡å®¢æˆ·ç«¯å¯åŠ¨æ—¶é€šè¿‡å‘½ä»¤è¡ŒåŠ å‚æ•°æŒ‡å®š æ³¨ï¼šé»˜è®¤ä¸ºinfo</td></tr><tr><td>spring.cloud.nacos.discovery.heart-beat-interval</td><td>nacoså®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤5s<br/>æ³¨ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ¯éš”5så‘æœåŠ¡ç«¯å‘é€å¿ƒè·³è¯·æ±‚ï¼Œè¿›è¡ŒæœåŠ¡ç»­ç§Ÿï¼Œå‘Šè¯‰æœåŠ¡ç«¯è¯¥å®ä¾‹IPå¥åº·ã€‚è‹¥åœ¨3æ¬¡å¿ƒè·³çš„é—´éš”æ—¶é—´(é»˜è®¤15s)å†…æœåŠ¡ç«¯æ²¡æœ‰æ¥å—åˆ°è¯¥å®ä¾‹çš„å¿ƒè·³è¯·æ±‚ï¼Œåˆ™è®¤ä¸ºè¯¥å®ä¾‹ä¸å¥åº·ï¼Œè¯¥å®ä¾‹å°†æ— æ³•è¢«æ¶ˆè´¹ã€‚å¦‚æœå†æ¬¡ç»å†3æ¬¡å¿ƒè·³çš„é—´éš”æ—¶é—´ï¼ŒæœåŠ¡ç«¯æ¥å—åˆ°è¯¥å®ä¾‹çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä¼šç«‹åˆ»å°†å…¶è®¾ç½®å¤–å¥åº·ï¼Œå¹¶å¯ä»¥è¢«æ¶ˆè´¹ï¼Œè‹¥æœªæ¥å—åˆ°ï¼Œåˆ™åˆ é™¤è¯¥å®ä¾‹çš„æ³¨å†Œä¿¡æ¯ã€‚æ¨èé…ç½®ä¸º5sï¼Œå¦‚æœæœ‰çš„ä¸šåŠ¡çº¿å¸Œæœ›æœåŠ¡ä¸‹çº¿æˆ–è€…å‡ºæ•…éšœæ—¶å¸Œæœ›å°½å¿«è¢«å‘ç°ï¼Œå¯ä»¥é€‚å½“å‡å°‘è¯¥å€¼ã€‚</td></tr><tr><td>spring.cloud.nacos.discovery.heart-beat-timeout:</td><td>æœåŠ¡ç«¯æ²¡æœ‰æ¥å—åˆ°å®¢æˆ·ç«¯å¿ƒè·³è¯·æ±‚å°±å°†å…¶è®¾ä¸ºä¸å¥åº·çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º15s. æ³¨ï¼šæ¨èå€¼è¯¥å€¼ä¸º15så³å¯ï¼Œå¦‚æœæœ‰çš„ä¸šåŠ¡çº¿å¸Œæœ›æœåŠ¡ä¸‹çº¿æˆ–è€…å‡ºæ•…éšœæ—¶å¸Œæœ›å°½å¿«è¢«å‘ç°ï¼Œå¯ä»¥é€‚å½“å‡å°‘è¯¥å€¼ã€‚</td></tr><tr><td>spring.cloud.nacos.discovery.log-name:</td><td>nacoså®¢æˆ·ç«¯ä¼šåœ¨å¯åŠ¨æ—¶æ‰“å°ä¸€éƒ¨åˆ†å‘é€æ³¨å†Œè¯·æ±‚ä¿¡æ¯å’Œå¼‚å¸¸æ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹æ³¨å†Œçš„nacosé›†ç¾¤åœ°å€ã€æœåŠ¡åã€nameSpaceã€IPã€å…ƒæ•°æ®ç­‰å†…å®¹ï¼Œæ–‡ä»¶åé»˜è®¤ä¸ºnaming.log . æ³¨:æ¨èå°†è¯¥æ—¥å¿—çš„ä½ç½®è®¾ç½®ä¸ºå’Œå…¶ä»–æ—¥å¿—åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹</td></tr><tr><td>spring.cloud.nacos.discovery.metadata:</td><td>ç»™æœåŠ¡æ·»åŠ ä¸€äº›æ ‡ç­¾ï¼Œä¾‹å¦‚å±äºä»€ä¹ˆä¸šåŠ¡çº¿ï¼Œè¯¥å…ƒæ•°æ®ä¼šæŒä¹…åŒ–å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¶ˆè´¹æ—¶ä¸ä¼šè·å–åˆ°æ­¤å€¼ï¼Œé»˜è®¤ä¸ºç©º. æ³¨:æ¨èä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å·²ç»æ³¨å†Œçš„æœåŠ¡åæ¥æ‰¾åˆ°å…·ä½“çš„ä¸šåŠ¡çº¿ï¼Œæ— éœ€æ·»åŠ metadata</td></tr><tr><td>spring.cloud.nacos.discovery.namespace:</td><td>å‘½åç©ºé—´IDï¼ŒNacosé€šè¿‡ä¸åŒçš„å‘½åç©ºé—´æ¥åŒºåˆ†ä¸åŒçš„ç¯å¢ƒï¼Œè¿›è¡Œæ•°æ®éš”ç¦»ï¼ŒæœåŠ¡æ¶ˆè´¹æ—¶åªèƒ½æ¶ˆè´¹åˆ°å¯¹åº”å‘½åç©ºé—´ä¸‹çš„æœåŠ¡ã€‚</td></tr><tr><td>spring.cloud.nacos.discovery.naming-load-cache-at-start:</td><td>é»˜è®¤ä¸ºfalseã€‚å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶æ˜¯å¦è¯»å–æœ¬åœ°é…ç½®é¡¹(ä¸€ä¸ªæ–‡ä»¶)æ¥è·å–æœåŠ¡åˆ—è¡¨. æ³¨ï¼šæ¨èè¯¥å€¼ä¸ºfalseï¼Œè‹¥æ”¹æˆtrueã€‚åˆ™å®¢æˆ·ç«¯ä¼šåœ¨æœ¬åœ°çš„ä¸€ä¸ªæ–‡ä»¶ä¸­ä¿å­˜æœåŠ¡ä¿¡æ¯ï¼Œå½“ä¸‹æ¬¡å®•æœºå¯åŠ¨æ—¶ï¼Œä¼šä¼˜å…ˆè¯»å–æœ¬åœ°çš„é…ç½®å¯¹å¤–æä¾›æœåŠ¡ã€‚</td></tr><tr><td>spring.cloud.nacos.discovery.port:</td><td>å‘nacosæ³¨å†ŒæœåŠ¡æ—¶ï¼ŒæœåŠ¡å¯¹åº”çš„ç«¯å£å· . æ³¨:æ— éœ€ä¿®æ”¹ï¼Œé»˜è®¤ä¸ºåº”ç”¨å¯¹å¤–æä¾›æœåŠ¡çš„ç«¯å£å·,server.port</td></tr><tr><td>spring.cloud.nacos.discovery.register-enabled:</td><td>è¯¥é¡¹ç›®æ˜¯å¦å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œé»˜è®¤ä¸ºtrue . æ³¨ï¼šå¦‚æœæœåŠ¡ä»æ³¨å†Œä¸­å¿ƒåªæ¶ˆè´¹æœåŠ¡ï¼Œæ²¡æœ‰å¯¹å¤–æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆè¯¥å€¼å¯è®¾ç½®ä¸ºfalseï¼Œå¯å‡å°‘å®¢æˆ·ç«¯çº¿ç¨‹æ± çš„åˆ›å»ºï¼Œæ— éœ€å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³è¯·æ±‚ï¼Œæé«˜æ€§èƒ½ã€‚</td></tr><tr><td>spring.cloud.nacos.discovery.server-addr</td><td>nacosé›†ç¾¤åœ°å€ã€‚æ³¨ï¼šå¤šä¸ªIPå¯ä»¥é€šè¿‡â€œï¼Œâ€å·éš”ç¦»ï¼Œä¾‹å¦‚<code>192.168.80.1:8848,192.168.80.1:8848</code> å¡«å†™åŸŸåæ—¶å‰ç¼€ä¸è¦åŠ ä¸Šhttp://</td></tr><tr><td>spring.cloud.nacos.discovery.service:</td><td>é¡¹ç›®å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æ—¶çš„æœåŠ¡åï¼Œé»˜è®¤ä¸ºspring.application.name å˜é‡ . æ³¨:è¯¥æœåŠ¡åå¿…é¡»ä½¿ç”¨å°å†™ï¼Œå› ä¸ºnacosæœåŠ¡ååŒºåˆ†å¤§å°å†™ï¼Œå¦‚æœæœåŠ¡åä¸å®Œå…¨åŒ¹é…ï¼Œé‚£ä¹ˆæ— æ³•è°ƒç”¨æœåŠ¡</td></tr><tr><td>spring.cloud.nacos.discovery.watch-delay:</td><td>é»˜è®¤ä¸º30sã€‚å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹å®šæœŸå»æŸ¥è¯¢æœåŠ¡ç«¯çš„ä¿¡æ¯åˆ—è¡¨ï¼Œè¯¥è¯·æ±‚ä¸ä¼šç«‹åˆ»è¿”å›ï¼Œé»˜è®¤ç­‰å¾…30sï¼Œè‹¥åœ¨30så†…ï¼ŒæœåŠ¡ç«¯ä¿¡æ¯åˆ—è¡¨å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¯¥è¯·æ±‚ç«‹åˆ»è¿”å›ï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡ç«¯çš„æœåŠ¡ä¿¡æ¯åˆ—è¡¨ï¼Œè‹¥30så†…ï¼Œæ²¡æœ‰å˜åŒ–ï¼Œåˆ™30sæ—¶è¯¥è¯·æ±‚è¿”å›å“åº”ï¼Œå®¢æˆ·ç«¯æœåŠ¡åˆ—è¡¨ä¸å˜ï¼Œå†æ¬¡å‘ç”Ÿè¯¥è¯·æ±‚ã€‚ æ³¨ï¼šæ¨èè¯¥å€¼ä¸º30så³å¯ï¼Œæ— éœ€ä¿®æ”¹</td></tr><tr><td>spring.cloud.nacos.discovery.watch.enabled:</td><td>é»˜è®¤ä¸ºtrue,å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹å®šæœŸå»æŸ¥è¯¢æœåŠ¡ç«¯çš„ä¿¡æ¯åˆ—è¡¨ï¼Œè¯¥è¯·æ±‚ä¸ä¼šç«‹åˆ»è¿”å›ï¼Œé»˜è®¤ç­‰å¾…30sï¼Œè‹¥åœ¨30så†…ï¼ŒæœåŠ¡ç«¯ä¿¡æ¯åˆ—è¡¨å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¯¥è¯·æ±‚ç«‹åˆ»è¿”å›ï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡ç«¯çš„æœåŠ¡ä¿¡æ¯åˆ—è¡¨ï¼Œè‹¥30så†…ï¼Œæ²¡æœ‰å˜åŒ–ï¼Œåˆ™30sæ—¶è¯¥è¯·æ±‚è¿”å›å“åº”ï¼Œå®¢æˆ·ç«¯æœåŠ¡åˆ—è¡¨ä¸å˜ï¼Œå†æ¬¡å‘ç”Ÿè¯¥è¯·æ±‚ã€‚ æ³¨:æ¨èè¯¥åŠŸèƒ½ä¸ºtrueï¼Œè¿™æ˜¯nacosç±»ä¼¼é•¿è¿æ¥æ¨é€æœåŠ¡å˜åŒ–çš„åŠŸèƒ½ï¼Œä¸è¦å…³é—­</td></tr><tr><td>spring.cloud.nacos.discovery.weight:</td><td>nacosæ”¯æŒæœåŠ¡ç«¯åŸºäºæƒé‡çš„è´Ÿè½½å‡è¡¡ï¼Œè¯¥å€¼é»˜è®¤ä¸º1 . æ³¨:å»ºè®®è¯¥å€¼ä¿æŒé»˜è®¤å³å¯ï¼Œå› ä¸ºä»£ç å¯èƒ½ä¼šéƒ¨ç½²åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œæ— æ³•ç¡®ä¿æŸå°æœåŠ¡å™¨çš„é…ç½®ä¸€å®šè¾ƒå¥½ï¼Œå¦‚æœæœ‰éœ€è¦ä¿®æ”¹è¯¥å€¼çš„éœ€æ±‚ï¼Œå¯ä»¥ä¸Šæ§åˆ¶å°ä¿®æ”¹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¯¹åº”IPæœåŠ¡å™¨çš„æƒé‡å€¼è¾ƒé«˜</td></tr></tbody></table><blockquote><p><b style="color:red">watch-delay æœ‰ä»€ä¹ˆä½œç”¨?</b></p></blockquote><h2 id="41-åŸºæœ¬ä½¿ç”¨">4.1 åŸºæœ¬ä½¿ç”¨<a aria-hidden="true" class="anchor" hidden="" href="#41-åŸºæœ¬ä½¿ç”¨">#</a></h2><p>pom.xml</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-xml" data-lang="xml"><span style="display:flex"><span>   <span style="color:#7ee787">&lt;dependency&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#7ee787">&lt;/groupId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style="color:#7ee787">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;version&gt;</span>2.2.1.RELEASE<span style="color:#7ee787">&lt;/version&gt;</span>
</span></span><span style="display:flex"><span>    <span style="color:#7ee787">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>ä½¿ç”¨é…ç½®æ–‡ä»¶å¦‚ä¸‹:</strong></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#7ee787">spring</span>:<span style="color:#6e7681">   
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">cloud</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">nacos</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        	</span>-- <span style="color:#a5d6ff">é…ç½®ä¸­å¿ƒ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#7ee787">config</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">namespace</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjNamespace</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">server-addr</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">192.168.2.101</span>:<span style="color:#a5d6ff">8841</span>,<span style="color:#a5d6ff">192.168.2.101</span>:<span style="color:#a5d6ff">8845</span>,<span style="color:#a5d6ff">192.168.2.101</span>:<span style="color:#a5d6ff">8848</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">group</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjGroup</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>-- <span style="color:#a5d6ff">æ³¨å†Œä¸­å¿ƒ</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#7ee787">discovery</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">server-addr</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">${spring.cloud.nacos.config.server-addr}</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">cluster-name</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjCluster</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>-- <span style="color:#a5d6ff">æ­¤å¤„æ˜¯å‘½åç©ºé—´çš„id</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">namespace</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjNamespace</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">service</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">javaDemoDiscovery</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#7ee787">group</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjGroup</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">application</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">name</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">javaDemo</span><span style="color:#6e7681">
</span></span></span></code></pre></div><h2 id="42-åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶nacoså¦‚ä½•å‘ç°ipçš„">4.2 åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶,nacoså¦‚ä½•å‘ç°ipçš„<a aria-hidden="true" class="anchor" hidden="" href="#42-åœ¨ä¸å†™æœ¬æœºåœ°å€æ—¶nacoså¦‚ä½•å‘ç°ipçš„">#</a></h2><p>ä¸ <code>Eureka</code>ä½¿ç”¨äº†åŒä¸€ä¸ªå·¥å…·ç±», æœ‰spring-cloud-commonæä¾›çš„ <code>InetUtils</code> ç±», å› æ­¤ä¸¤è€…è·å–ipæ˜¯åŒæ ·çš„åŸç†,è¯¦è§ <a href="Eureka.md">EurekaåŸç†è¯¦è§£</a></p><blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯éå†æ‰€æœ‰ç½‘å¡, å»é™¤ä¸€äº›å›æ—‹åœ°å€,å¿½ç•¥åœ°å€ç­‰è§„åˆ™å–ç´¢å¼•æœ€å°çš„, é»˜è®¤è¿”å›æœ¬åœ°åœ°å€</p></blockquote><h1 id="5-é…ç½®ä¸­å¿ƒ">5. é…ç½®ä¸­å¿ƒ<a aria-hidden="true" class="anchor" hidden="" href="#5-é…ç½®ä¸­å¿ƒ">#</a></h1><p>åœ¨ Nacos Spring Cloud ä¸­ï¼ŒdataId çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š</p><p><code>${prefix}-${spring.profile.active}.${file-extension}</code></p><blockquote><ul><li>prefix é»˜è®¤ä¸ºæ‰€å±å·¥ç¨‹é…ç½®spring.application.name çš„å€¼ï¼ˆå³ï¼šnacos-providerï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.prefixæ¥é…ç½®ï¼›</li><li>spring.profile.active å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ Spring Bootæ–‡æ¡£ã€‚ æ³¨æ„ï¼šå½“spring.profile.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ ${prefix}.${file-extension}</li><li>file-exetension ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ properties å’Œ yaml ç±»å‹ï¼›é»˜è®¤ä¸º properties ï¼›</li></ul></blockquote><p><a href="https://blog.csdn.net/cristianoxm/article/details/113639172" rel="noopener" target="_blank">Nacos å…¥é—¨æ•™ç¨‹_cristianoxmçš„åšå®¢-CSDNåšå®¢_nacos æ•™ç¨‹</a></p><p>pom.xml</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-xml" data-lang="xml"><span style="display:flex"><span>        <span style="color:#7ee787">&lt;dependency&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;groupId&gt;</span>com.alibaba.cloud<span style="color:#7ee787">&lt;/groupId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span style="color:#7ee787">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex"><span>            <span style="color:#7ee787">&lt;version&gt;</span>2.2.1.RELEASE<span style="color:#7ee787">&lt;/version&gt;</span>
</span></span><span style="display:flex"><span>        <span style="color:#7ee787">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>é…ç½®æ–‡ä»¶:</p><blockquote><p>æ–°å¢bootstrap.ymlæ–‡ä»¶ï¼Œé…ç½®ä¿¡æ¯å†™åœ¨è¯¥æ–‡ä»¶é‡Œã€‚ï¼ˆé—®é¢˜ï¼šå¦‚æ”¾åœ¨application.ymlä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨æŠ¥æ‰¾ä¸åˆ°é…ç½®å±æ€§é”™è¯¯ï¼ŒåŸå› ï¼šapplication.ymlä¸bootstrap.ymlåŠ è½½é¡ºåºä¼˜å…ˆçº§é—®é¢˜ã€‚ï¼‰</p></blockquote><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#7ee787">spring</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#7ee787">application</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">name</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">javaDemo</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">  </span><span style="color:#7ee787">cloud</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#7ee787">nacos</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#7ee787">server-addr</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">${spring.cloud.client.ip-address}:8848</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">      </span><span style="color:#7ee787">config</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">namespace</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjNamespace</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">file-extension</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">yml</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">shared-configs</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>- <span style="color:#7ee787">data-id</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">mysqlTest.yml</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#7ee787">refresh</span>:<span style="color:#6e7681"> </span><span style="color:#79c0ff">true</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#7ee787">group</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjGroup</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">extension-configs</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">          </span>- <span style="color:#7ee787">data-id</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">MyTest.yml</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#7ee787">refresh</span>:<span style="color:#6e7681"> </span><span style="color:#79c0ff">true</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#7ee787">group</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjGroup</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#7ee787">group</span>:<span style="color:#6e7681"> </span><span style="color:#a5d6ff">xkjGroup</span><span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic"># è¯¥é…ç½®å¦‚æœæ”¾åœ¨shareå’Œextentsioné…ç½®çš„å‰é¢,å°†è¦†ç›–å…¶ä¸‹çš„ç»„</span><span style="color:#6e7681">
</span></span></span></code></pre></div><p>javaä½¿ç”¨ç±»:</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#d2a8ff;font-weight:700">@Value</span>(<span style="color:#a5d6ff">"${my.name:æœ¬åœ°å€¼name}"</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>name;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#d2a8ff;font-weight:700">@Value</span>(<span style="color:#a5d6ff">"${person.name:æœ¬åœ°å€¼person.name}"</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>person_name;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#d2a8ff;font-weight:700">@Value</span>(<span style="color:#a5d6ff">"${personAge:æœ¬åœ°å€¼personAge}"</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>personAge;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#d2a8ff;font-weight:700">@Value</span>(<span style="color:#a5d6ff">"${personName:æœ¬åœ°å€¼personName}"</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>personName;<span style="color:#6e7681">
</span></span></span></code></pre></div><p><img alt="1698831651715(1)" loading="lazy" src="./Nacos.assets/1698831651715%281%29.jpg"/></p><h2 id="51-åŠ¨æ€é…ç½®">5.1 åŠ¨æ€é…ç½®<a aria-hidden="true" class="anchor" hidden="" href="#51-åŠ¨æ€é…ç½®">#</a></h2><h3 id="511-ä½¿ç”¨">5.1.1 ä½¿ç”¨<a aria-hidden="true" class="anchor" hidden="" href="#511-ä½¿ç”¨">#</a></h3><p>é€šå¸¸è·å–é…ç½®æ–‡ä»¶çš„æ–¹å¼</p><ol><li><p><code>@Value</code></p></li><li><p><code>@ConfigurationProperties(Prefix)</code></p></li></ol><p>å¦‚æœæ˜¯åœ¨è¿è¡Œæ—¶è¦åŠ¨æ€æ›´æ–°çš„è¯ï¼Œ</p><p>ç¬¬ä¸€ç§æ–¹å¼è¦åœ¨beanä¸ŠåŠ <code>@RefreshScope</code></p><p>ç¬¬äºŒç§æ–¹å¼æ˜¯è‡ªåŠ¨æ”¯æŒçš„ã€‚</p><h3 id="512-åŸç†è¯¦è§£">5.1.2 åŸç†è¯¦è§£<a aria-hidden="true" class="anchor" hidden="" href="#512-åŸç†è¯¦è§£">#</a></h3><p><img alt="1698831672668" loading="lazy" src="./Nacos.assets/1698831672668.jpg"/></p><h4 id="5121-é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œç›‘å¬æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹">5.1.2.1 é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œ"ç›‘å¬"æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹<a aria-hidden="true" class="anchor" hidden="" href="#5121-é‡‡ç”¨å»¶è¿Ÿçº¿ç¨‹æ± å®šæ—¶æ‰§è¡Œç›‘å¬æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹">#</a></h4><p>æœåŠ¡å¯åŠ¨åå°±å›è½®è¯¢çš„æ‰“å°å›¾ä¸Šä¿¡æ¯, å½“æœ‰é…ç½®è¢«æ”¹åŠ¨æ—¶, è¿™ä¸ª<code>[]</code> å°±ä¼šåŒ…å«æ•°æ®äº†, å¯æƒ³è€ŒçŸ¥è¿™æ˜¯ç›‘å¬æ—¥å¿—äº†, é‚£å°±æ‰¾åˆ°è¿™æ®µä»£ç </p><p><strong><code>ClientWorker.java</code></strong></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:700">LongPollingRunnable</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">implements</span><span style="color:#6e7681"> </span>Runnable<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>taskId;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">LongPollingRunnable</span>(<span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>taskId)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">this</span>.taskId<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>taskId;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">run</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>CacheData<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>cacheDatas<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ArrayList<span style="color:#ff7b72;font-weight:700">&lt;</span>CacheData<span style="color:#ff7b72;font-weight:700">&gt;</span>();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>inInitializingCacheList<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ArrayList<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span>();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// check failover config</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(CacheData<span style="color:#6e7681"> </span>cacheData<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>cacheMap.get().values())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(cacheData.getTaskId()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>taskId)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cacheDatas.add(cacheData);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>checkLocalConfig(cacheData);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(cacheData.isUseLocalConfigInfo())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                                </span>cacheData.checkListenerMd5();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Exception<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>LOGGER.error(<span style="color:#a5d6ff">"get local config info error"</span>,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// check server config</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>changedGroupKeys<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>checkUpdateDataIds(cacheDatas,<span style="color:#6e7681"> </span>inInitializingCacheList);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>LOGGER.info(<span style="color:#a5d6ff">"get changedGroupKeys:"</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>changedGroupKeys);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#8b949e;font-style:italic">//              çœç•¥å‰©ä¸‹ä»£ç   .....</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>ä»è¿™é‡Œå°±èƒ½çœ‹å‡º, å…ˆæ˜¯å¯¹é…ç½®åšäº†ä¸€äº›æ£€æŸ¥, ç„¶åå°±æ‰“å°ç»“æœ, è€Œä¸”è¿™ä¸ªæ˜¯åœ¨runæ–¹æ³•é‡Œ, è¯´æ˜è¿™é‡Œè‚¯å®šæ˜¯å¼€äº†çº¿ç¨‹åœ¨è·‘çš„, æ‰¾åˆ°è°ƒç”¨<code>LongPollingRunnable</code>è¿™ä¸ªç±»çš„åœ°æ–¹</p><p>è¿˜æ˜¯åœ¨åŒä¸€ä¸ªç±»ä¸­, å‘ç°æ˜¯åœ¨executeä¸­æ‰§è¡Œçš„, é‚£å°±æ˜¯å¼„äº†ä¸€ä¸ªçº¿ç¨‹æ± , è€Œä¸”è¿™é‡Œæ˜¯åœ¨forå¾ªç¯é‡Œ, çœ‹ä¸€ä¸‹ä»»åŠ¡, å°±ä¼šè”æƒ³åˆ°å¤šä¸ªé…ç½®æ–‡ä»¶çš„æƒ…å†µ, åŒæ—¶ç›‘å¬çš„</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">checkConfigInfo</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// åˆ†ä»»åŠ¡</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>listenerSize<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>cacheMap.get().size();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// å‘ä¸Šå–æ•´ä¸ºæ‰¹æ•°</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>longingTaskCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72">int</span>)<span style="color:#6e7681"> </span>Math.ceil(listenerSize<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">/</span><span style="color:#6e7681"> </span>ParamUtil.getPerTaskConfigSize());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(longingTaskCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>currentLongingTaskCount)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72">int</span><span style="color:#6e7681"> </span>i<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72">int</span>)<span style="color:#6e7681"> </span>currentLongingTaskCount;<span style="color:#6e7681"> </span>i<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&lt;</span><span style="color:#6e7681"> </span>longingTaskCount;<span style="color:#6e7681"> </span>i<span style="color:#ff7b72;font-weight:700">++</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// è¦åˆ¤æ–­ä»»åŠ¡æ˜¯å¦åœ¨æ‰§è¡Œ è¿™å—éœ€è¦å¥½å¥½æƒ³æƒ³ã€‚ ä»»åŠ¡åˆ—è¡¨ç°åœ¨æ˜¯æ— åºçš„ã€‚å˜åŒ–è¿‡ç¨‹å¯èƒ½æœ‰é—®é¢˜</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>executorService.execute(<span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>LongPollingRunnable(i));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>currentLongingTaskCount<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>longingTaskCount;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>çœ‹ä¸€ä¸‹è¿™ä¸ªçº¿ç¨‹æ± çš„å‚æ•°.</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#d2a8ff;font-weight:700">@SuppressWarnings</span>(<span style="color:#a5d6ff">"PMD.ThreadPoolCreationRule"</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">ClientWorker</span>(<span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>HttpAgent<span style="color:#6e7681"> </span>agent,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>ConfigFilterChainManager<span style="color:#6e7681"> </span>configFilterChainManager,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>Properties<span style="color:#6e7681"> </span>properties)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">this</span>.agent<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>agent;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">this</span>.configFilterChainManager<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>configFilterChainManager;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// Initialize the timeout parameter</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>init(properties);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>executor<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Executors.newScheduledThreadPool(1,<span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ThreadFactory()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Thread<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">newThread</span>(Runnable<span style="color:#6e7681"> </span>r)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>Thread<span style="color:#6e7681"> </span>t<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>Thread(r);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>t.setName(<span style="color:#a5d6ff">"com.alibaba.nacos.client.Worker."</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>agent.getName());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>t.setDaemon(<span style="color:#79c0ff">true</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>t;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>});<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span><span style="color:#8b949e;font-style:italic">// æ‰§è¡Œçš„çº¿ç¨‹æ± </span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>executorService<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Executors.newScheduledThreadPool(Runtime.getRuntime().availableProcessors(),<span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ThreadFactory()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>Thread<span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">newThread</span>(Runnable<span style="color:#6e7681"> </span>r)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>Thread<span style="color:#6e7681"> </span>t<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>Thread(r);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>t.setName(<span style="color:#a5d6ff">"com.alibaba.nacos.client.Worker.longPolling."</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>agent.getName());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>t.setDaemon(<span style="color:#79c0ff">true</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>t;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>});<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>executor.scheduleWithFixedDelay(<span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>Runnable()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">run</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>checkConfigInfo();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Throwable<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>LOGGER.error(<span style="color:#a5d6ff">"["</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>agent.getName()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">"] [sub-check] rotate check error"</span>,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>},<span style="color:#6e7681"> </span>1L,<span style="color:#6e7681"> </span>10L,<span style="color:#6e7681"> </span>TimeUnit.MILLISECONDS);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>è¿˜ä¼šå‘ç°è¿™é‡Œè¿˜æœ‰ä¸ªå»¶è¿Ÿçº¿ç¨‹æ± ,è€Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ•°, å‘ç°é‡Œé¢æ‰§è¡Œäº†<code>checkConfigInfo()</code>, è¿™åˆšå¥½<code>LongPollingRunnable</code> ç±»æ‰§è¡Œçš„æ‰€åœ¨æ–¹æ³•.</p><p>è‡³æ­¤, å®ƒçš„å®šæ—¶æ‰§è¡Œå°±æ¸…æ¥šäº†, <strong>å®ƒå¼€äº†ä¸€ä¸ªå•çº¿ç¨‹çš„å»¶æ—¶çº¿ç¨‹æ± ,æ¯éš”10msæ‰§è¡Œä¸€æ¬¡, çº¿ç¨‹é‡Œå†ç”¨çº¿ç¨‹æ± å»"ç›‘å¬"æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹</strong></p><p>ä½†æ˜¯æˆ‘ä»¬å‘ç°æ—¥å¿—é—´éš”å¹¶ä¸æ˜¯10ms,è€Œä¸”è¿™ä¸ªé—´éš”ä¹Ÿå¤ªå°äº†, è‚¯å®šä¸åˆç†</p><h4 id="5122-é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹">5.1.2.2 é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹<a aria-hidden="true" class="anchor" hidden="" href="#5122-é€šè¿‡é•¿è½®è¯¢çš„æ–¹å¼è·å¾—ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠå…¶å†…å®¹">#</a></h4><p>å»çœ‹ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•"ç›‘å¬", è·Ÿè¿›<code>com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateDataIds</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">/**
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">     * ä»Serverè·å–å€¼å˜åŒ–äº†çš„DataIDåˆ—è¡¨ã€‚è¿”å›çš„å¯¹è±¡é‡Œåªæœ‰dataIdå’Œgroupæ˜¯æœ‰æ•ˆçš„ã€‚ ä¿è¯ä¸è¿”å›NULLã€‚
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">     */</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">checkUpdateDataIds</span>(List<span style="color:#ff7b72;font-weight:700">&lt;</span>CacheData<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>cacheDatas,<span style="color:#6e7681"> </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>inInitializingCacheList)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>IOException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// æ„é€ å‚æ•°- é€šè¿‡é…ç½®dataId/group/tenantç­‰æ•°æ®æ¥æŒ‡å®šæ–‡ä»¶</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>StringBuilder<span style="color:#6e7681"> </span>sb<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>StringBuilder();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(CacheData<span style="color:#6e7681"> </span>cacheData<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>cacheDatas)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>cacheData.isUseLocalConfigInfo())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>sb.append(cacheData.dataId).append(WORD_SEPARATOR);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>sb.append(cacheData.group).append(WORD_SEPARATOR);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(StringUtils.isBlank(cacheData.tenant))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>sb.append(cacheData.getMd5()).append(LINE_SEPARATOR);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>sb.append(cacheData.getMd5()).append(WORD_SEPARATOR);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>sb.append(cacheData.getTenant()).append(LINE_SEPARATOR);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(cacheData.isInitializing())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#8b949e;font-style:italic">// cacheData é¦–æ¬¡å‡ºç°åœ¨cacheMapä¸­&amp;é¦–æ¬¡checkæ›´æ–°</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>inInitializingCacheList<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>.add(GroupKey.getKeyTenant(cacheData.dataId,<span style="color:#6e7681"> </span>cacheData.group,<span style="color:#6e7681"> </span>cacheData.tenant));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">boolean</span><span style="color:#6e7681"> </span>isInitializingCacheList<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!</span>inInitializingCacheList.isEmpty();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// æ ¸å¿ƒæ–¹æ³•- æ£€æŸ¥æ›´æ–°æ–‡ä»¶</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>checkUpdateConfigStr(sb.toString(),<span style="color:#6e7681"> </span>isInitializingCacheList);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><code>com.alibaba.nacos.client.config.impl.ClientWorker#checkUpdateConfigStr</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">/**
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">     * ä»Serverè·å–å€¼å˜åŒ–äº†çš„DataIDåˆ—è¡¨ã€‚è¿”å›çš„å¯¹è±¡é‡Œåªæœ‰dataIdå’Œgroupæ˜¯æœ‰æ•ˆçš„ã€‚ ä¿è¯ä¸è¿”å›NULLã€‚
</span></span></span><span style="display:flex"><span><span style="color:#8b949e;font-style:italic">     */</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">checkUpdateConfigStr</span>(String<span style="color:#6e7681"> </span>probeUpdateString,<span style="color:#6e7681"> </span><span style="color:#ff7b72">boolean</span><span style="color:#6e7681"> </span>isInitializingCacheList)<span style="color:#6e7681"> </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>IOException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>params<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ArrayList<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span>(2);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>params.add(Constants.PROBE_MODIFY_REQUEST);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>params.add(probeUpdateString);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>headers<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ArrayList<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span>(2);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>headers.add(<span style="color:#a5d6ff">"Long-Pulling-Timeout"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// è®¾ç½®é•¿è½®è¯¢çš„è¿‡æœŸæ—¶é—´</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>headers.add(<span style="color:#a5d6ff">""</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>timeout);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">// told server do not hang me up if new initializing cacheData added in</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(isInitializingCacheList)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>headers.add(<span style="color:#a5d6ff">"Long-Pulling-Timeout-No-Hangup"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>headers.add(<span style="color:#a5d6ff">"true"</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(StringUtils.isBlank(probeUpdateString))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>Collections.emptyList();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// In order to prevent the server from handling the delay of the client's long task,</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// increase the client's read timeout to avoid this problem.</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">long</span><span style="color:#6e7681"> </span>readTimeoutMs<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>timeout<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72">long</span>)<span style="color:#6e7681"> </span>Math.round(timeout<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">&gt;&gt;</span><span style="color:#6e7681"> </span>1);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// é•¿è½®è¯¢è¯·æ±‚</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>HttpResult<span style="color:#6e7681"> </span>result<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>agent.httpPost(Constants.CONFIG_CONTROLLER_PATH<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">"/listener"</span>,<span style="color:#6e7681"> </span>headers,<span style="color:#6e7681"> </span>params,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>agent.getEncode(),<span style="color:#6e7681"> </span>readTimeoutMs);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(HttpURLConnection.HTTP_OK<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>result.code)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>setHealthServer(<span style="color:#79c0ff">true</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// è§£æè¿”å‚</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>parseUpdateDataIdResponse(result.content);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>setHealthServer(<span style="color:#79c0ff">false</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>LOGGER.error(<span style="color:#a5d6ff">"[{}] [check-update] get changed dataId error, code: {}"</span>,<span style="color:#6e7681"> </span>agent.getName(),<span style="color:#6e7681"> </span>result.code);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(IOException<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>setHealthServer(<span style="color:#79c0ff">false</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>LOGGER.error(<span style="color:#a5d6ff">"["</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>agent.getName()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">"] [check-update] get changed dataId exception"</span>,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span>e;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>Collections.emptyList();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>å°±ä¼šå‘ç°å®ƒæ˜¯å‘äº†ä¸€ä¸ªè¯·æ±‚è¿‡å», ç„¶åé€šè¿‡<code>parseUpdateDataIdResponse(result.content)</code> æ–¹æ³•è§£æå‡ºè¿”å‚é‡Œé¢çš„ dataId/group/tenantç­‰æ•°æ®</p><p>è¿™ä¸ªè¯·æ±‚ä¸­è®¾ç½®äº†ä¸€äº›é•¿è½®è¯¢çš„å‚æ•°,è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé•¿è½®è¯¢çš„è¯·æ±‚</p><blockquote><p><strong>é•¿è½®è¯¢:</strong> å®¢æˆ·ç«¯å‘èµ·Long Pollingï¼Œæ­¤æ—¶å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰ç›¸å…³æ•°æ®ï¼Œä¼šholdä½è¯·æ±‚ï¼Œç›´åˆ°æœåŠ¡ç«¯æœ‰ç›¸å…³æ•°æ®ï¼Œæˆ–è€…ç­‰å¾…ä¸€å®šæ—¶é—´è¶…æ—¶æ‰ä¼šè¿”å›ã€‚è¿”å›åï¼Œå®¢æˆ·ç«¯åˆä¼šç«‹å³å†æ¬¡å‘èµ·ä¸‹ä¸€æ¬¡Long Pollingã€‚</p></blockquote><p>è¿™é‡Œåªæ˜¯æ‹¿åˆ°äº†ä¸€ä¸ªdataIdå’Œgroupç­‰æ•°æ®,é‚£ä»€ä¹ˆæ—¶å€™æ‹¿åˆ°å…·ä½“çš„é…ç½®ä¿¡æ¯å‘¢? ç»§ç»­å¾€ä¸‹çœ‹ <code>LongPollingRunnable#run</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// æ£€æŸ¥æ›´æ–°çš„dataId</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>changedGroupKeys<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>checkUpdateDataIds(cacheDatas,<span style="color:#6e7681"> </span>inInitializingCacheList);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>LOGGER.info(<span style="color:#a5d6ff">"get changedGroupKeys:"</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">+</span><span style="color:#6e7681"> </span>changedGroupKeys);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span><span style="color:#8b949e;font-style:italic">// éå†è¿™äº›æ–‡ä»¶</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(String<span style="color:#6e7681"> </span>groupKey<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>changedGroupKeys)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>String<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>GroupKey.parseKey(groupKey);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>String<span style="color:#6e7681"> </span>dataId<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>key<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>String<span style="color:#6e7681"> </span>group<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>key<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>String<span style="color:#6e7681"> </span>tenant<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(key.length<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">==</span><span style="color:#6e7681"> </span>3)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>tenant<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>key<span style="color:#ff7b72;font-weight:700">[</span>2<span style="color:#ff7b72;font-weight:700">]</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#8b949e;font-style:italic">// è·å¾—å…·ä½“é…ç½®</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>String<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>ct<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>getServerConfig(dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant,<span style="color:#6e7681"> </span>3000L);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>CacheData<span style="color:#6e7681"> </span>cache<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>cacheMap.get().get(GroupKey.getKeyTenant(dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#8b949e;font-style:italic">// æŠŠå†…å®¹ç›´æ¥å†™åˆ°cacheMapä¸­</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cache.setContent(ct<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span>ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>cache.setType(ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>LOGGER.info(<span style="color:#a5d6ff">"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}"</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>agent.getName(),<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant,<span style="color:#6e7681"> </span>cache.getMd5(),<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>ContentUtils.truncateContent(ct<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span>),<span style="color:#6e7681"> </span>ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(NacosException<span style="color:#6e7681"> </span>ioe)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>String<span style="color:#6e7681"> </span>message<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>String.format(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#a5d6ff">"[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s"</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>agent.getName(),<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>LOGGER.error(message,<span style="color:#6e7681"> </span>ioe);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(CacheData<span style="color:#6e7681"> </span>cacheData<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>cacheDatas)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>cacheData.isInitializing()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">||</span><span style="color:#6e7681"> </span>inInitializingCacheList<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>.contains(GroupKey.getKeyTenant(cacheData.dataId,<span style="color:#6e7681"> </span>cacheData.group,<span style="color:#6e7681"> </span>cacheData.tenant)))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#8b949e;font-style:italic">// æ£€æŸ¥md5</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cacheData.checkListenerMd5();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cacheData.setInitializing(<span style="color:#79c0ff">false</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#8b949e;font-style:italic">// ....çœç•¥å‰©ä¸‹ä»£ç </span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p><code>com.alibaba.nacos.client.config.impl.ClientWorker#getServerConfig</code> è·å¾—å…·ä½“é…ç½®çš„æ–¹æ³•</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span>String<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">getServerConfig</span>(String<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>tenant,<span style="color:#6e7681"> </span><span style="color:#ff7b72">long</span><span style="color:#6e7681"> </span>readTimeout)<span style="color:#6e7681">  </span><span style="color:#ff7b72">throws</span><span style="color:#6e7681"> </span>NacosException<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>String<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>ct<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>String<span style="color:#ff7b72;font-weight:700">[</span>2<span style="color:#ff7b72;font-weight:700">]</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(StringUtils.isBlank(group))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>group<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Constants.DEFAULT_GROUP;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>HttpResult<span style="color:#6e7681"> </span>result<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>List<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span><span style="color:#6e7681"> </span>params<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(StringUtils.isBlank(tenant))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>params<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ArrayList<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span>(Arrays.asList(<span style="color:#a5d6ff">"dataId"</span>,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">"group"</span>,<span style="color:#6e7681"> </span>group));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>params<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ArrayList<span style="color:#ff7b72;font-weight:700">&lt;</span>String<span style="color:#ff7b72;font-weight:700">&gt;</span>(Arrays.asList(<span style="color:#a5d6ff">"dataId"</span>,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">"group"</span>,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">"tenant"</span>,<span style="color:#6e7681"> </span>tenant));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#8b949e;font-style:italic">// é€šè¿‡getè¯·æ±‚,è·å¾—å…·ä½“é…ç½®</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>result<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>agent.httpGet(Constants.CONFIG_CONTROLLER_PATH,<span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>,<span style="color:#6e7681"> </span>params,<span style="color:#6e7681"> </span>agent.getEncode(),<span style="color:#6e7681"> </span>readTimeout);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(IOException<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>String<span style="color:#6e7681"> </span>message<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>String.format(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#a5d6ff">"[%s] [sub-server] get server config exception, dataId=%s, group=%s, tenant=%s"</span>,<span style="color:#6e7681"> </span>agent.getName(),<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>LOGGER.error(message,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">throw</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>NacosException(NacosException.SERVER_ERROR,<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>(result.code)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span>HttpURLConnection.HTTP_OK:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// å…ˆæ”¾åˆ°æœ¬åœ°æ–‡ä»¶ä¸­</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>LocalConfigInfoProcessor.saveSnapshot(agent.getName(),<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant,<span style="color:#6e7681"> </span>result.content);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#8b949e;font-style:italic">// å°†è¯·æ±‚è¿”å‚æ”¾å…¥ctæ•°ç»„ä¸­</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>ct<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>result.content;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(result.headers.containsKey(CONFIG_TYPE))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>result.headers.get(CONFIG_TYPE).get(0);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ConfigType.TEXT.getType();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>ct;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">             </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span>HttpURLConnection.HTTP_NOT_FOUND:<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#8b949e;font-style:italic">//  çœç•¥å‰©ä¸‹ä»£ç ......</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>è‡³æ­¤, æ¸…æ¥šäº†å®ƒæ˜¯å¦‚ä½•æ‹¿åˆ°å…·ä½“é…ç½®çš„äº†, <strong>å®ƒé€šè¿‡(ä¸€æ¬¡postè¯·æ±‚)é•¿è½®è¯¢çš„æ–¹å¼å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥, è·å¾—dataId/groupç­‰æ•°æ®, å†é€šè¿‡è¿™äº›å‚æ•°å‘èµ·getè¯·æ±‚è·å¾—å…·ä½“çš„é…ç½®æ–‡ä»¶å†…å®¹,å¹¶å†™åˆ°æœ¬åœ°ç¼“å­˜ä¸­ä½¿ç”¨</strong></p><h4 id="5123-æ‹¿åˆ°é…ç½®åé€šè¿‡applicationcontextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­">5.1.2.3 æ‹¿åˆ°é…ç½®åé€šè¿‡applicationContextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­<a aria-hidden="true" class="anchor" hidden="" href="#5123-æ‹¿åˆ°é…ç½®åé€šè¿‡applicationcontextæ›´æ–°åˆ°é¡¹ç›®å†…å­˜ä¸­">#</a></h4><p>å®ƒå–åˆ°è¿™äº›é…ç½®å,æ˜¯å¦‚ä½•å†™åˆ°é¡¹ç›®çš„å†…å­˜ä¸­å¹¶ä½¿å…¶ç”Ÿæ•ˆçš„å‘¢?</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681"> </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>String<span style="color:#ff7b72;font-weight:700">[]</span><span style="color:#6e7681"> </span>ct<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>getServerConfig(dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant,<span style="color:#6e7681"> </span>3000L);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>CacheData<span style="color:#6e7681"> </span>cache<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>cacheMap.get().get(GroupKey.getKeyTenant(dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cache.setContent(ct<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span>ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>cache.setType(ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>LOGGER.info(<span style="color:#a5d6ff">"[{}] [data-received] dataId={}, group={}, tenant={}, md5={}, content={}, type={}"</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>agent.getName(),<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant,<span style="color:#6e7681"> </span>cache.getMd5(),<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>ContentUtils.truncateContent(ct<span style="color:#ff7b72;font-weight:700">[</span>0<span style="color:#ff7b72;font-weight:700">]</span>),<span style="color:#6e7681"> </span>ct<span style="color:#ff7b72;font-weight:700">[</span>1<span style="color:#ff7b72;font-weight:700">]</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(NacosException<span style="color:#6e7681"> </span>ioe)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>String<span style="color:#6e7681"> </span>message<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>String.format(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span><span style="color:#a5d6ff">"[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s"</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                            </span>agent.getName(),<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>tenant);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>LOGGER.error(message,<span style="color:#6e7681"> </span>ioe);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(CacheData<span style="color:#6e7681"> </span>cacheData<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>cacheDatas)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>cacheData.isInitializing()<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">||</span><span style="color:#6e7681"> </span>inInitializingCacheList<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>.contains(GroupKey.getKeyTenant(cacheData.dataId,<span style="color:#6e7681"> </span>cacheData.group,<span style="color:#6e7681"> </span>cacheData.tenant)))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#8b949e;font-style:italic">// æ£€æŸ¥md5</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cacheData.checkListenerMd5();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>cacheData.setInitializing(<span style="color:#79c0ff">false</span>);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span><span style="color:#8b949e;font-style:italic">// çœç•¥å‰©ä¸‹ä»£ç .....</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>åœ¨å–åˆ°å…·ä½“é…ç½®å,éå†cacheDatasæ•°æ®,å¹¶æ£€æŸ¥md5, è·Ÿè¿›å»çœ‹ä¸€ä¸‹, å®ƒå¼€å§‹å‡ºç°ç›‘å¬å™¨äº†</p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">checkListenerMd5</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>(ManagerListenerWrap<span style="color:#6e7681"> </span>wrap<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>listeners)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#ff7b72;font-weight:700">!</span>md5.equals(wrap.lastCallMd5))<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>safeNotifyListener(dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>content,<span style="color:#6e7681"> </span>type,<span style="color:#6e7681"> </span>md5,<span style="color:#6e7681"> </span>wrap);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">safeNotifyListener</span>(<span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>content,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>type,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                                    </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>md5,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>ManagerListenerWrap<span style="color:#6e7681"> </span>listenerWrap)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>Listener<span style="color:#6e7681"> </span>listener<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>listenerWrap.listener;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>Runnable<span style="color:#6e7681"> </span>job<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>Runnable()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">run</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>ClassLoader<span style="color:#6e7681"> </span>myClassLoader<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>Thread.currentThread().getContextClassLoader();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>ClassLoader<span style="color:#6e7681"> </span>appClassLoader<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>listener.getClass().getClassLoader();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(listener<span style="color:#6e7681"> </span><span style="color:#ff7b72">instanceof</span><span style="color:#6e7681"> </span>AbstractSharedListener)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>AbstractSharedListener<span style="color:#6e7681"> </span>adapter<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>(AbstractSharedListener)<span style="color:#6e7681"> </span>listener;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>adapter.fillContext(dataId,<span style="color:#6e7681"> </span>group);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>LOGGER.info(<span style="color:#a5d6ff">"[{}] [notify-context] dataId={}, group={}, md5={}"</span>,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>md5);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#8b949e;font-style:italic">// æ‰§è¡Œå›è°ƒä¹‹å‰å…ˆå°†çº¿ç¨‹classloaderè®¾ç½®ä¸ºå…·ä½“webappçš„classloaderï¼Œä»¥å…å›è°ƒæ–¹æ³•ä¸­è°ƒç”¨spiæ¥å£æ˜¯å‡ºç°å¼‚å¸¸æˆ–é”™ç”¨ï¼ˆå¤šåº”ç”¨éƒ¨ç½²æ‰ä¼šæœ‰è¯¥é—®é¢˜ï¼‰ã€‚</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>Thread.currentThread().setContextClassLoader(appClassLoader);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>ConfigResponse<span style="color:#6e7681"> </span>cr<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ConfigResponse();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>cr.setDataId(dataId);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>cr.setGroup(group);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>cr.setContent(content);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>configFilterChainManager.doFilter(<span style="color:#79c0ff">null</span>,<span style="color:#6e7681"> </span>cr);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>String<span style="color:#6e7681"> </span>contentTmp<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>cr.getContent();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#8b949e;font-style:italic">// å¤„ç†é…ç½®ä¿¡æ¯</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>listener.receiveConfigInfo(contentTmp);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#8b949e;font-style:italic">// compare lastContent and content</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(listener<span style="color:#6e7681"> </span><span style="color:#ff7b72">instanceof</span><span style="color:#6e7681"> </span>AbstractConfigChangeListener)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>Map<span style="color:#6e7681"> </span>data<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>ConfigChangeHandler.getInstance().parseChangeData(listenerWrap.lastContent,<span style="color:#6e7681"> </span>content,<span style="color:#6e7681"> </span>type);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>ConfigChangeEvent<span style="color:#6e7681"> </span>event<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>ConfigChangeEvent(data);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>((AbstractConfigChangeListener)listener).receiveConfigChange(event);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>listenerWrap.lastContent<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>content;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>listenerWrap.lastCallMd5<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>md5;<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>LOGGER.info(<span style="color:#a5d6ff">"[{}] [notify-ok] dataId={}, group={}, md5={}, listener={} "</span>,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>md5,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>listener);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(NacosException<span style="color:#6e7681"> </span>de)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>LOGGER.error(<span style="color:#a5d6ff">"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} errCode={} errMsg={}"</span>,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>md5,<span style="color:#6e7681"> </span>listener,<span style="color:#6e7681"> </span>de.getErrCode(),<span style="color:#6e7681"> </span>de.getErrMsg());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Throwable<span style="color:#6e7681"> </span>t)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>LOGGER.error(<span style="color:#a5d6ff">"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} tx={}"</span>,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span>md5,<span style="color:#6e7681"> </span>listener,<span style="color:#6e7681"> </span>t.getCause());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">finally</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                    </span>Thread.currentThread().setContextClassLoader(myClassLoader);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>};<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">long</span><span style="color:#6e7681"> </span>startNotify<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>System.currentTimeMillis();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(<span style="color:#79c0ff">null</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">!=</span><span style="color:#6e7681"> </span>listener.getExecutor())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>listener.getExecutor().execute(job);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">else</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>job.run();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681"> </span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(Throwable<span style="color:#6e7681"> </span>t)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>LOGGER.error(<span style="color:#a5d6ff">"[{}] [notify-error] dataId={}, group={}, md5={}, listener={} throwable={}"</span>,<span style="color:#6e7681"> </span>name,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                </span>md5,<span style="color:#6e7681"> </span>listener,<span style="color:#6e7681"> </span>t.getCause());<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">long</span><span style="color:#6e7681"> </span>finishNotify<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>System.currentTimeMillis();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">        </span>LOGGER.info(<span style="color:#a5d6ff">"[{}] [notify-listener] time cost={}ms in ClientWorker, dataId={}, group={}, md5={}, listener={} "</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">            </span>name,<span style="color:#6e7681"> </span>(finishNotify<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-</span><span style="color:#6e7681"> </span>startNotify),<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>md5,<span style="color:#6e7681"> </span>listener);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>è¿™ä¹ˆé•¿çš„ä»£ç ,æ ¸å¿ƒå°±æ˜¯å¤„ç†äº†é‚£ä¸ªrunable, å…¶ä¸­è°ƒç”¨äº†<code>listener.receiveConfigInfo(contentTmp)</code> æ–¹æ³•å¤„ç†çš„ç›‘å¬å™¨,å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±», æ‰¾åˆ°å®ƒçš„å®ç°ç±»</p><p><code>com.alibaba.cloud.nacos.refresh.NacosContextRefresher</code></p><div class="highlight"><pre style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-java" data-lang="java"><span style="display:flex"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">private</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">registerNacosListener</span>(<span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>groupKey,<span style="color:#6e7681"> </span><span style="color:#ff7b72">final</span><span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>dataKey)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>String<span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>NacosPropertySourceRepository.getMapKey(dataKey,<span style="color:#6e7681"> </span>groupKey);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>Listener<span style="color:#6e7681"> </span>listener<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">=</span><span style="color:#6e7681"> </span>listenerMap.computeIfAbsent(key,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>lst<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:700">-&gt;</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>AbstractSharedListener()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">					</span><span style="color:#d2a8ff;font-weight:700">@Override</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">					</span><span style="color:#ff7b72">public</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">void</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:700">innerReceive</span>(String<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>String<span style="color:#6e7681"> </span>group,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">							</span>String<span style="color:#6e7681"> </span>configInfo)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">						</span>refreshCountIncrement();<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">						</span>nacosRefreshHistory.addRefreshRecord(dataId,<span style="color:#6e7681"> </span>group,<span style="color:#6e7681"> </span>configInfo);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">						</span><span style="color:#8b949e;font-style:italic">// todo feature: support single refresh for listening</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">                        </span><span style="color:#8b949e;font-style:italic">// é€šè¿‡applicationContextçš„äº‹ä»¶å»æ›´æ–°é…ç½®</span><span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">						</span>applicationContext.publishEvent(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">								</span><span style="color:#ff7b72">new</span><span style="color:#6e7681"> </span>RefreshEvent(<span style="color:#ff7b72">this</span>,<span style="color:#6e7681"> </span><span style="color:#79c0ff">null</span>,<span style="color:#6e7681"> </span><span style="color:#a5d6ff">"Refresh Nacos config"</span>));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">						</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>(log.isDebugEnabled())<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">							</span>log.debug(String.format(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">									</span><span style="color:#a5d6ff">"Refresh Nacos config group=%s,dataId=%s,configInfo=%s"</span>,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">									</span>group,<span style="color:#6e7681"> </span>dataId,<span style="color:#6e7681"> </span>configInfo));<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">						</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">					</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">				</span>});<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">try</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span>configService.addListener(dataKey,<span style="color:#6e7681"> </span>groupKey,<span style="color:#6e7681"> </span>listener);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">catch</span><span style="color:#6e7681"> </span>(NacosException<span style="color:#6e7681"> </span>e)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">			</span>log.warn(String.format(<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">					</span><span style="color:#a5d6ff">"register fail for nacos listener ,dataId=[%s],group=[%s]"</span>,<span style="color:#6e7681"> </span>dataKey,<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">					</span>groupKey),<span style="color:#6e7681"> </span>e);<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>è‡³æ­¤, æ¸…æ¥šäº†è·å¾—çš„é…ç½®æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„, å®ƒå°†è·å¾—å‘ç”Ÿä¿®æ”¹è¿‡çš„æ–‡ä»¶, å¦‚æœmd5ä¸ä¸€æ ·äº†, åˆ™æ‰§è¡Œç›‘å¬å™¨,é€šè¿‡applicationContext æ›´æ–°é…ç½®åˆ°é¡¹ç›®å†…å­˜ä¸­</p><blockquote><p>æ˜æ˜å·²ç»çŸ¥é“äº†å“ªäº›æ–‡ä»¶è¢«ä¿®æ”¹äº†,ä¸ºå•¥è¿˜æœ‰æ¯”å¯¹md5, å› ä¸ºå¯èƒ½æ˜¯æ²¡æœ‰ä¿®æ”¹å…·ä½“å†…å®¹,åªæ˜¯ç‚¹äº†ç¼–è¾‘å¹¶ä¿å­˜</p><p><span style="color:red">md5ç”¨çš„æ˜¯javaçš„digestå’Œä½ç§»,md5å¯èƒ½å­˜åœ¨å†²çª, é‚£æ€ä¹ˆè§£å†³å†²çªé—®é¢˜çš„?</span></p></blockquote><h3 id="513-æ€»ç»“">5.1.3 æ€»ç»“<a aria-hidden="true" class="anchor" hidden="" href="#513-æ€»ç»“">#</a></h3><ul><li>1.Nacos å®¢æˆ·ç«¯ä¼šå¾ªç¯è¯·æ±‚æœåŠ¡ç«¯å˜æ›´çš„æ•°æ®ï¼Œå¹¶ä¸”è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º30sï¼Œå½“é…ç½®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¯·æ±‚çš„å“åº”ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™ä¼šä¸€ç›´ç­‰åˆ° 29.5s+ ä¹‹åå†è¿”å›å“åº”</li><li>2.Nacos å®¢æˆ·ç«¯èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥åˆ°æœåŠ¡ç«¯é…ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚</li><li>3.å®æ—¶æ„ŸçŸ¥æ˜¯å»ºç«‹åœ¨å®¢æˆ·ç«¯æ‹‰å’ŒæœåŠ¡ç«¯â€œæ¨â€çš„åŸºç¡€ä¸Šï¼Œä½†æ˜¯è¿™é‡Œçš„æœåŠ¡ç«¯â€œæ¨â€éœ€è¦æ‰“ä¸Šå¼•å·ï¼Œå› ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç›´æ¥æœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡ http è¿›è¡Œæ•°æ®é€šè®¯çš„ï¼Œä¹‹æ‰€ä»¥æœ‰â€œæ¨â€çš„æ„Ÿè§‰ï¼Œæ˜¯å› ä¸ºæœåŠ¡ç«¯ä¸»åŠ¨å°†å˜æ›´åçš„æ•°æ®é€šè¿‡ http çš„ response å¯¹è±¡æå‰å†™å…¥äº†ã€‚</li></ul><p><a href="https://www.jianshu.com/p/d3f66b1eb748?isappinstalled=0" rel="noopener" target="_blank">Long Pollingé•¿è½®è¯¢è¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://www.cnblogs.com/barry-blog/articles/14305358.html" rel="noopener" target="_blank">NACOSåŠ¨æ€é…ç½® - barryzhou - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.cnblogs.com/hankuikui/p/12084193.html" rel="noopener" target="_blank">spring boot é…ç½®æ–‡ä»¶åŠ¨æ€æ›´æ–°åŸç† ä»¥Nacosä¸ºä¾‹ - äºŒå¥ - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.jianshu.com/p/38b5452c9fec" rel="noopener" target="_blank">Nacos é…ç½®ä¸­å¿ƒåŸç†åˆ†æ -ç¬¬ä¸€ç¯‡- ç®€ä¹¦ (jianshu.com)</a></p><p><a href="https://www.jianshu.com/p/acb9b1093a54" rel="noopener" target="_blank">Nacos é…ç½®ä¸­å¿ƒåŸç†åˆ†æ -ç¬¬äºŒç¯‡ - ç®€ä¹¦ (jianshu.com)</a></p><h1 id="aq">A&amp;Q<a aria-hidden="true" class="anchor" hidden="" href="#aq">#</a></h1><ol><li><p>nacosé›†ç¾¤æ¶æ„?</p><p><strong>ç­”</strong>: å’ŒEurekaé›†ç¾¤æ¶æ„ä¸€æ ·,ä»–çš„æ•°æ®æ˜¯ç‚¹å¯¹ç‚¹çš„, æœ¬èº«æ˜¯ä¸»ä»ç»“æ„,ä¹Ÿå°±æ˜¯è¯´ä¼šäº§ç”Ÿè¿‡åŠé€‰ä¸¾,è„‘è£‚ç­‰çŸ¥è¯†ç‚¹, é»˜è®¤æ”¯æŒcapç†è®ºä¸­çš„apæ¨¡å¼. ç”Ÿäº§éƒ¨ç½²nacosé›†ç¾¤æ—¶,æ¨èé€šè¿‡NGINXç»™nacosé›†ç¾¤åšè´Ÿè½½å‡è¡¡</p><p><a href="https://www.cnblogs.com/songfeifeine/p/14321014.html" rel="noopener" target="_blank">æµ…è°ˆNacosä¸­çš„CAP - åŒ…å­å–å®Œäº†å˜› - åšå®¢å›­ (cnblogs.com)</a></p></li><li><p>nacoså¦‚ä½•å®ç°åŠ¨æ€é…ç½®?</p><p>ç­”: ä½¿ç”¨é•¿è½®è¯¢æœºåˆ¶,ç”±å®¢æˆ·ç«¯å®šæ—¶å‘èµ·è¯·æ±‚è¯¢é—®æœåŠ¡ç«¯æ˜¯å¦æœ‰ä¿®æ”¹, å¦‚æœå­˜åœ¨ä¿®æ”¹åˆ™é€šè¿‡applicationContextçš„publishEventæ›´æ–°å†…å­˜ä¸­çš„é…ç½®</p><blockquote><p>ä¸€æ¬¡è¯·æ±‚åå°†é˜»å¡29.5s+, æ‰ä¼šå‘èµ·ä¸‹ä¸€æ¬¡è¯·æ±‚, å¦‚æœé‡åˆ°æœåŠ¡ç«¯å­˜åœ¨ä¿®æ”¹æ–‡ä»¶, åˆ™ä¼šç«‹å³è¿”å›.</p><p>å®šæ—¶æœºåˆ¶æ˜¯å¼€äº†ä¸€ä¸ªå»¶æ—¶çº¿ç¨‹æ± ,å…¶ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹,æ¯éš”10mså‘èµ·ä¸€æ¬¡è¯·æ±‚, æœåŠ¡å¯åŠ¨æ—¶è¯¥ä»»åŠ¡å°±æ‰§è¡Œäº†</p></blockquote></li></ol></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xiaokunji.com/zh/tags/spring_cloud.html">spring_cloud</a></li><li><a href="https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html">javaåŠå…¶æ¡†æ¶</a></li></ul><nav class="paginav"><a class="prev" href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/Gateway.html"><span class="title">Â« ä¸Šä¸€é¡µ</span><br/><span>Gateway</span>
</a><a class="next" href="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/springCloud/OpenFeign.html"><span class="title">ä¸‹ä¸€é¡µ Â»</span><br/><span>openFeign</span></a></nav></footer></article></main><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><footer class="footer"><span>Copyright
Â©
-2023
<a href="https://xiaokunji.com/zh/" style="color:#939393">ç±³äºŒ</a>
All Rights Reserved
</span><span id="busuanzi_container"><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id="busuanzi_value_site_uv"></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id="busuanzi_value_site_pv"></span></span></footer><a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)"><svg fill="currentcolor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>