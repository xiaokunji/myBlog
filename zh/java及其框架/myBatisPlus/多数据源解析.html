<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>å¤šæ•°æ®æºè§£æ | ç±³äºŒ</title><meta name=keywords content=" 1. ä½¿ç”¨, 1.1. å¼•åŒ…, 1.2 å¢åŠ é…ç½®, 1.3 ä½¿ç”¨@DSæ³¨è§£, 2. æºç , 2.1 Configurationæ–‡ä»¶,åŠ è½½é…ç½®ä¸beanæ³¨å…¥, 2.1.1  é…ç½®ç±», 2.2 æ³¨å†ŒDataSource, 2.2.1  è·å–æ‰€æœ‰çš„DataSource, 2.2.1.1 æ„å»ºDataSource, 2.2.2 å¯¹æ•°æ®æºåˆ†ç»„, 2.3 åˆ‡æ¢æ•°æ®æº, 2.3.1 DynamicDataSourceContextHolder, 2.3.2 DynamicDataSourceAnnotationInterceptor, 2.3.4  DynamicDataSourceAnnotationAdvisor, 2.4 æ•°æ®æºçš„å¤„ç†å™¨, 3. Q&amp;A, 3.1 @Transactional å’Œ @DS æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶,@DSå¤±æ•ˆçš„é—®é¢˜, 3.2  ä½äºV3.3.3ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="å¤šæ•°æ®æºè§£æ"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html"><meta property="article:section" content="javaåŠå…¶æ¡†æ¶"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-08T09:03:16+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="å¤šæ•°æ®æºè§£æ"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"å¤šæ•°æ®æºè§£æ","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"å¤šæ•°æ®æºè§£æ","name":"å¤šæ•°æ®æºè§£æ","description":"     ","keywords":[" 1. ä½¿ç”¨"," 1.1. å¼•åŒ…"," 1.2 å¢åŠ é…ç½®"," 1.3 ä½¿ç”¨@DSæ³¨è§£"," 2. æºç "," 2.1 Configurationæ–‡ä»¶, åŠ è½½é…ç½®ä¸beanæ³¨å…¥"," 2.1.1  é…ç½®ç±»"," 2.2 æ³¨å†ŒDataSource"," 2.2.1  è·å–æ‰€æœ‰çš„DataSource"," 2.2.1.1 æ„å»ºDataSource"," 2.2.2 å¯¹æ•°æ®æºåˆ†ç»„"," 2.3 åˆ‡æ¢æ•°æ®æº"," 2.3.1 DynamicDataSourceContextHolder"," 2.3.2 DynamicDataSourceAnnotationInterceptor"," 2.3.4  DynamicDataSourceAnnotationAdvisor"," 2.4 æ•°æ®æºçš„å¤„ç†å™¨"," 3. Q\u0026A"," 3.1 @Transactional å’Œ @DS æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶, @DSå¤±æ•ˆçš„é—®é¢˜"," 3.2  ä½äºV3.3.3ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜"],"articleBody":"[toc]\n1. ä½¿ç”¨ 1.1. å¼•åŒ… com.baomidou dynamic-datasource-spring-boot-starter 3.3.6 ç”¨æœ€æ–°ç‰ˆçš„å°±å¥½ Maven Repository: dynamic-datasource-spring-boot-starter ä¸è¿‡åšå¼€å‘çš„ç»éªŒæ¥çœ‹, åº”è¯¥é€‰ å€’æ•°ç¬¬äºŒä¸ªå¤§ç‰ˆæœ¬é‡Œæœ€æ–°çš„ç‰ˆæœ¬, è¿™æ ·æ—¢èƒ½ç”¨æ›´å¤šçš„åŠŸèƒ½,åˆèƒ½ä¿è¯æ²¡æœ‰å¤§bug, é™¤éæœ€æ–°ç‰ˆæœ¬æœ‰ä½ éœ€è¦çš„åŠŸèƒ½\n1.2 å¢åŠ é…ç½® spring: datasource: dynamic: primary: master #è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster, æ‰€ä»¥æ­¤å¤„ä¸å†™ä¹Ÿå¯ä»¥ strict: false #è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™å›æŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨ä¼šä½¿ç”¨é»˜è®¤æ•°æ®æº. datasource: master: # ç¬¬ä¸€ä¸ªæ•°æ®æºçš„åç§° url: jdbc:mysql://127.0.0.1:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.jdbc.Driver db_1: # ç¬¬äºŒä¸ªæ•°æ®æºçš„åç§° url: jdbc:gbase://127.0.0.1:5258/dynamic username: root password: 123456 driver-class-name: com.mysql.jdbc.Driver å¦‚æœæ˜¯å¤šä¸»å¤šä»æˆ–è€…ä¸€ä¸»å¤šä»ï¼Œé‚£ä¹ˆå°±ç”¨åˆ†ç»„çš„åŠŸèƒ½å®ç°, å³: æ•°æ®ç»„åç§°_xxxï¼Œä¸‹åˆ’çº¿å‰é¢çš„å°±æ˜¯æ•°æ®ç»„åç§°ï¼Œåé¢å°±æ˜¯æ•°æ®æºå, ç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚åˆ‡æ¢æ•°æ®æºæ—¶ï¼Œå¯ä»¥æŒ‡å®šå…·ä½“æ•°æ®æºåç§°ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç»„åç„¶åä¼šè‡ªåŠ¨é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢,\nä¾‹å¦‚: ä¸Šé¢é…ç½®ä¸­çš„\"db_1\", è¡¨ç¤ºdbåˆ†ç»„, 1 åç§°çš„æ•°æ®æº, å¦‚æœå†å¢åŠ ä¸€ä¸ª\"db_2\", åˆ™è¡¨ç¤ºè¿™ä¸¤ä¸ªæ•°æ®æºæ˜¯åŒä¸€ä¸ªåˆ†ç»„, å½“åœ¨@DSä¸­åªæŒ‡å®š\"db\", åˆ™ä¼šåœ¨è¿™ä¸ªåˆ†ç»„ä¸­é‡‡ç”¨è´Ÿè½½å‡è¡¡æ–¹å¼é€‰æ•°æ®æº(é»˜è®¤æ˜¯è½®è¯¢)\n1.3 ä½¿ç”¨@DSæ³¨è§£ @DSæ³¨è§£, æ˜¯ç”¨æ¥è¡¨ç¤ºä½¿ç”¨å“ªä¸ªæ•°æ®æºçš„, ä¹Ÿæ˜¯åˆ‡æ¢æ•°æ®æºåŠŸèƒ½çš„æ ¸å¿ƒæ³¨è§£, å®ƒå¯ä»¥ç”¨æ¥ç±»å’Œæ–¹æ³•ä¸Š, æ–¹æ³•ä¸Šçš„ä¼˜å…ˆçº§æ›´é«˜, ä¾‹å¦‚ serviceå±‚, Mapperå±‚,éƒ½å¯ä»¥, å¦‚æœæ²¡æœ‰é…ç½®,åˆ™ä¼šä½¿ç”¨é»˜è®¤æ•°æ®æº\n@Service @DS(\"master\") // åœ¨ç±»ä¸ŠåŠ  public class UserServiceImpl implements UserService { @Autowired private JdbcTemplate jdbcTemplate; public List\u003cMap\u003cString, Object\u003e\u003e selectAll() { return jdbcTemplate.queryForList(\"select * from user\"); } @Override @DS(\"db_1\") // åœ¨æ–¹æ³•ä¸ŠåŠ  public List\u003cMap\u003cString, Object\u003e\u003e selectByCondition() { return jdbcTemplate.queryForList(\"select * from user where age \u003e10\"); } } å®˜æ–¹å»ºè®®ä¸å»ºè®®@DSæ”¾åœ¨Mapperä¸Š, æ‰€ä»¥ç½‘ä¸Šæœ‰å¾ˆå¤šä¾‹å­æ˜¯æ”¾åœ¨serviceä¸Š,\nä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜, å½“åœ¨serviceä¸­éœ€è¦è®¿é—®ä¸¤ä¸ªæ•°æ®åº“æ—¶, å°±ä¼šæ— æ³•åˆ‡æ¢æ•°æ®æº, æ¯•ç«Ÿ@DSæ˜¯åŠ åœ¨serviceä¸Š, åœ¨åŒä¸€ä¸ªserviceä¸Šæ“ä½œ, è‡ªç„¶ä¸ä¼šåˆ‡æ¢, å®˜æ–¹ä¹Ÿç»™å‡ºè§£å†³æ–¹æ¡ˆ, åœ¨æ–¹æ³•ä¸Šè¿›ä¸€æ­¥æŒ‡å®šæ•°æ®æº, (ä¼ªä»£ç )ä¾‹å¦‚:\nclass Person { @Autowired dbService1 db_1; @Autowired dbService2 db_2; void test(){ db_1.save(); // å¦‚æœ db_2.save() ä¸æŒ‡å®šæ•°æ®æº, æ•°æ®æºä¼šä½¿ç”¨db_1 db_2.save(); } } @DS(\"db_1\") class dbService1 { void save(){ } } @DS(\"db_2\") class dbService2 { @DS(\"db_2\") void save(){ } } mybatis-plusä¸­å¤šæ•°æ®æºåˆ‡æ¢@DSæ³¨è§£åˆ°åº•æ”¾åœ¨å“ªä¸€å±‚åˆé€‚ï¼Ÿ @DSä¸å»ºè®®åŠ åœ¨mapperä¸Šçš„åŸå› æ˜¯? 2. æºç  ä¸€èˆ¬starterè‡ªåŠ¨é…ç½®ï¼Œéƒ½æ˜¯ä» META-INF/spring.factoriesæ–‡ä»¶ä¸­æŒ‡å®šè‡ªåŠ¨é…ç½®ç±»ï¼š\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration æ‰€ä»¥æ‰“å¼€ DynamicDataSourceAutoConfiguration æ–‡ä»¶\n2.1 Configurationæ–‡ä»¶, åŠ è½½é…ç½®ä¸beanæ³¨å…¥ // åŠ¨æ€æ•°æ®æºæ ¸å¿ƒè‡ªåŠ¨é…ç½®ç±» @Slf4j @Configuration @EnableConfigurationProperties(DynamicDataSourceProperties.class) // @AutoConfigureBefore æ³¨è§£çš„æ„æ€æ˜¯ åœ¨DataSourceAutoConfigurationå’ŒDruidDataSourceAutoConfigureä¹‹å‰å°±æ³¨å†Œå½“å‰bean // è¿™é‡Œç‰¹åˆ«æ³¨æ„ä¸€ä¸‹, åœ¨ V3.3.3 ä¹‹å‰, æ²¡æœ‰æŠŠDruidDataSourceAutoConfigureåŠ è¿›æ¥, æ‰€ä»¥å¯¼è‡´é¡¹ç›®ä¸­æœ‰druidæ—¶,æ•°æ®æºæ— æ³•åˆ‡æ¢æˆ–æ²¡æœ‰druidé…ç½®åˆ™æŠ¥é”™ @AutoConfigureBefore(value = DataSourceAutoConfiguration.class, name = \"com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure\") //å¼•å…¥äº†Druidçš„autoConfigå’Œå„ç§æ•°æ®æºè¿æ¥æ± çš„Creator @Import(value = {DynamicDataSourceCreatorAutoConfiguration.class, DynamicDataSourceAopConfiguration.class, DynamicDataSourceAssistConfiguration.class}) @ConditionalOnProperty(prefix = DynamicDataSourceProperties.PREFIX, name = \"enabled\", havingValue = \"true\", matchIfMissing = true) public class DynamicDataSourceAutoConfiguration { private final DynamicDataSourceProperties properties; //è¯»å–å¤šæ•°æ®æºé…ç½®ï¼Œæ³¨å…¥åˆ°springå®¹å™¨ä¸­ @Bean @ConditionalOnMissingBean public DynamicDataSourceProvider dynamicDataSourceProvider() { Map\u003cString, DataSourceProperty\u003e datasourceMap = properties.getDatasource(); return new YmlDynamicDataSourceProvider(datasourceMap); } //æ³¨å†Œè‡ªå·±çš„åŠ¨æ€å¤šæ•°æ®æºDataSource @Bean @ConditionalOnMissingBean public DataSource dataSource(DynamicDataSourceProvider dynamicDataSourceProvider) { DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource(); dataSource.setPrimary(properties.getPrimary()); dataSource.setStrict(properties.getStrict()); dataSource.setStrategy(properties.getStrategy()); dataSource.setProvider(dynamicDataSourceProvider); dataSource.setP6spy(properties.getP6spy()); dataSource.setSeata(properties.getSeata()); return dataSource; } //AOPåˆ‡é¢ï¼Œå¯¹DSæ³¨è§£è¿‡çš„æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œè¾¾åˆ°åˆ‡æ¢æ•°æ®æºçš„ç›®çš„ @Role(value = BeanDefinition.ROLE_INFRASTRUCTURE) @Bean @ConditionalOnMissingBean public DynamicDataSourceAnnotationAdvisor dynamicDatasourceAnnotationAdvisor(DsProcessor dsProcessor) { DynamicDataSourceAnnotationInterceptor interceptor = new DynamicDataSourceAnnotationInterceptor(properties.isAllowedPublicOnly(), dsProcessor); DynamicDataSourceAnnotationAdvisor advisor = new DynamicDataSourceAnnotationAdvisor(interceptor); advisor.setOrder(properties.getOrder()); return advisor; } //å…³äºåˆ†å¸ƒå¼äº‹åŠ¡åŠ å¼º @Role(value = BeanDefinition.ROLE_INFRASTRUCTURE) @ConditionalOnProperty(prefix = DynamicDataSourceProperties.PREFIX, name = \"seata\", havingValue = \"false\", matchIfMissing = true) @Bean public Advisor dynamicTransactionAdvisor() { AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); pointcut.setExpression(\"@annotation(com.baomidou.dynamic.datasource.annotation.DSTransactional)\"); return new DefaultPointcutAdvisor(pointcut, new DynamicTransactionAdvisor()); } //åŠ¨æ€å‚æ•°è§£æå™¨é“¾ @Bean @ConditionalOnMissingBean public DsProcessor dsProcessor() { DsHeaderProcessor headerProcessor = new DsHeaderProcessor(); DsSessionProcessor sessionProcessor = new DsSessionProcessor(); DsSpelExpressionProcessor spelExpressionProcessor = new DsSpelExpressionProcessor(); headerProcessor.setNextProcessor(sessionProcessor); sessionProcessor.setNextProcessor(spelExpressionProcessor); return headerProcessor; } } æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™é…ç½®çš„å‰ç¼€ä¸ºspring.datasource.dynamicçš„é…ç½®éƒ½ä¼šè¢«è¯»å–åˆ°DynamicDataSourcePropertiesç±»ï¼Œä½œä¸ºä¸€ä¸ªBeanæ³¨å…¥åˆ°Springå®¹å™¨ã€‚å…¶å®è¿™ç§è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯çš„æ–¹å¼åœ¨æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„ã€‚\n2.1.1 é…ç½®ç±» DynamicDataSourceProperties\n@ConfigurationProperties(prefix = DynamicDataSourceProperties.PREFIX) public class DynamicDataSourceProperties { public static final String PREFIX = \"spring.datasource.dynamic\"; public static final String HEALTH = PREFIX + \".health\"; /** * å¿…é¡»è®¾ç½®é»˜è®¤çš„åº“,é»˜è®¤master */ private String primary = \"master\"; /** * æ˜¯å¦å¯ç”¨ä¸¥æ ¼æ¨¡å¼,é»˜è®¤ä¸å¯åŠ¨. ä¸¥æ ¼æ¨¡å¼ä¸‹æœªåŒ¹é…åˆ°æ•°æ®æºç›´æ¥æŠ¥é”™, éä¸¥æ ¼æ¨¡å¼ä¸‹åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æºprimaryæ‰€è®¾ç½®çš„æ•°æ®æº */ private Boolean strict = false; // ....... } 2.2 æ³¨å†ŒDataSource åœ¨ DynamicDataSourceAutoConfiguration ç±»ä¸­, è¿˜åŠ è½½äº†DataSource, æˆ‘ä»¬çŸ¥é“ DataSourceæ˜¯springç”¨æ¥é“¾æ¥æ•°æ®åº“çš„,\nå®ƒæ³¨å†Œäº†ä¸€ä¸ªå®ç°ç±» DynamicRoutingDataSource, è¿™ä¸ªç±»è¿˜æœ‰ä¸€ä¸ªçˆ¶ç±»AbstractRoutingDataSource, æˆ‘ä»¬å…ˆçœ‹AbstractRoutingDataSource\n/** * æŠ½è±¡åŠ¨æ€è·å–æ•°æ®æº * * @author TaoYu * @since 2.2.0 */ public abstract class AbstractRoutingDataSource extends AbstractDataSource { //æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ï¼Œè®©å­ç±»å†³å®šæœ€ç»ˆä½¿ç”¨çš„æ•°æ®æº protected abstract DataSource determineDataSource(); //é‡å†™getConnection()æ–¹æ³•ï¼Œå®ç°åˆ‡æ¢æ•°æ®æºçš„åŠŸèƒ½ @Override public Connection getConnection() throws SQLException { //è¿™é‡Œxidæ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç† String xid = TransactionContext.getXID(); if (StringUtils.isEmpty(xid)) { //ä¸ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå°±æ˜¯ç›´æ¥è¿”å›ä¸€ä¸ªæ•°æ®è¿æ¥(å®ç°ç±»: ItemDataSource.class) return determineDataSource().getConnection(); } else { String ds = DynamicDataSourceContextHolder.peek(); ConnectionProxy connection = ConnectionFactory.getConnection(ds); return connection == null ? getConnectionProxy(ds, determineDataSource().getConnection()) : connection; } } } çˆ¶ç±»å¾ˆç®€å•, åªæ˜¯åŒºåˆ†äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å–connectçš„æ–¹å¼,æ‰€ä»¥å†æ¥çœ‹ä¸‹å…¶å­ç±»DynamicRoutingDataSource çš„å†…å®¹\n@Slf4j public class DynamicRoutingDataSource extends AbstractRoutingDataSource implements InitializingBean, DisposableBean { private static final String UNDERLINE = \"_\"; /** * æ‰€æœ‰æ•°æ®åº“ */ private final Map\u003cString, DataSource\u003e dataSourceMap = new ConcurrentHashMap\u003c\u003e(); /** * åˆ†ç»„æ•°æ®åº“ */ private final Map\u003cString, GroupDataSource\u003e groupDataSources = new ConcurrentHashMap\u003c\u003e(); @Setter private DynamicDataSourceProvider provider; @Setter private Class\u003c? extends DynamicDataSourceStrategy\u003e strategy = LoadBalanceDynamicDataSourceStrategy.class; @Setter private String primary = \"master\"; @Setter private Boolean strict = false; @Setter private Boolean p6spy = false; @Setter private Boolean seata = false; @Override public DataSource determineDataSource() { // è·å¾—æ•°æ®æº return getDataSource(DynamicDataSourceContextHolder.peek()); } private DataSource determinePrimaryDataSource() { log.debug(\"dynamic-datasource switch to the primary datasource\"); return groupDataSources.containsKey(primary) ? groupDataSources.get(primary).determineDataSource() : dataSourceMap.get(primary); } // beançš„å±æ€§åŠ è½½å®Œå, æ‰§è¡Œè¯¥æ–¹æ³• @Override public void afterPropertiesSet() throws Exception { // æ£€æŸ¥å¼€å¯äº†é…ç½®ä½†æ²¡æœ‰ç›¸å…³ä¾èµ– checkEnv(); // æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®æº, Keyæ˜¯æ•°æ®æºçš„åç§°ï¼ŒValueåˆ™æ˜¯DataSourceã€‚ Map\u003cString, DataSource\u003e dataSources = provider.loadDataSources(); // æ·»åŠ å¹¶åˆ†ç»„æ•°æ®æº for (Map.Entry\u003cString, DataSource\u003e dsItem : dataSources.entrySet()) { addDataSource(dsItem.getKey(), dsItem.getValue()); } // æ£€æµ‹é»˜è®¤æ•°æ®æºæ˜¯å¦è®¾ç½® if (groupDataSources.containsKey(primary)) { log.info(\"dynamic-datasource initial loaded [{}] datasource,primary group datasource named [{}]\", dataSources.size(), primary); } else if (dataSourceMap.containsKey(primary)) { log.info(\"dynamic-datasource initial loaded [{}] datasource,primary datasource named [{}]\", dataSources.size(), primary); } else { throw new RuntimeException(\"dynamic-datasource Please check the setting of primary\"); } } /** * è·å–æ•°æ®æº * * @param ds æ•°æ®æºåç§° * @return æ•°æ®æº */ public DataSource getDataSource(String ds) { if (StringUtils.isEmpty(ds)) { // æ²¡æœ‰dsæ³¨è§£, åˆ™é»˜è®¤ç”¨ Primary return determinePrimaryDataSource(); } else if (!groupDataSources.isEmpty() \u0026\u0026 groupDataSources.containsKey(ds)) { // å¦‚æœæœ‰ç»„, åˆ™ç”¨è´Ÿè½½å‡è¡¡çš„æ–¹å¼å–ä¸€ä¸ª log.debug(\"dynamic-datasource switch to the datasource named [{}]\", ds); return groupDataSources.get(ds).determineDataSource(); } else if (dataSourceMap.containsKey(ds)) { // æ²¡æœ‰ç»„, åˆ™ç›´æ¥å– log.debug(\"dynamic-datasource switch to the datasource named [{}]\", ds); return dataSourceMap.get(ds); } // ä¸¥æ ¼æ¨¡å¼ä¸‹ç›´æ¥æŠ¥é”™ if (strict) { throw new CannotFindDataSourceException(\"dynamic-datasource could not find a datasource named\" + ds); } return determinePrimaryDataSource(); } // ..... } å®ƒå®ç°äº†InitializingBeanæ¥å£ï¼Œè¿™ä¸ªæ¥å£éœ€è¦å®ç°afterPropertiesSet()æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªBeançš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œåœ¨Beanåˆå§‹åŒ–çš„æ—¶å€™åšä¸€äº›æ“ä½œ\n2.2.1 è·å–æ‰€æœ‰çš„DataSource å…ˆçœ‹ä¸€ä¸‹å®ƒæ˜¯æ€ä¹ˆè·å¾—æ•°æ®æºçš„? provider.loadDataSources() æ˜¯æŠ½è±¡æ–¹æ³•, æœ‰ä¸¤ä¸ªå®ç°\nYmlDynamicDataSourceProviderå’ŒAbstractJdbcDataSourceProvider, åœ¨DynamicDataSourceAutoConfiguration ç±»ä¸­, æ³¨å…¥çš„æ˜¯YmlDynamicDataSourceProvider, æ‰€ä»¥ç›´æ¥çœ‹å®ƒçš„å®ç° , æœ€åä¼šè·³è½¬åˆ°AbstractDataSourceProvider\n@Slf4j public abstract class AbstractDataSourceProvider implements DynamicDataSourceProvider { @Autowired private DefaultDataSourceCreator defaultDataSourceCreator; protected Map\u003cString, DataSource\u003e createDataSourceMap( Map\u003cString, DataSourceProperty\u003e dataSourcePropertiesMap) { Map\u003cString, DataSource\u003e dataSourceMap = new HashMap\u003c\u003e(dataSourcePropertiesMap.size() * 2); for (Map.Entry\u003cString, DataSourceProperty\u003e item : dataSourcePropertiesMap.entrySet()) { DataSourceProperty dataSourceProperty = item.getValue(); String poolName = dataSourceProperty.getPoolName(); if (poolName == null || \"\".equals(poolName)) { poolName = item.getKey(); } dataSourceProperty.setPoolName(poolName); // è¿™é‡Œçš„defaultDataSourceCreator.createDataSource()æ–¹æ³•ä½¿ç”¨åˆ°é€‚é…å™¨æ¨¡å¼ã€‚å› ä¸ºæ¯ç§é…ç½®æ•°æ®æºåˆ›å»ºçš„DataSourceå®ç°ç±»éƒ½ä¸ä¸€å®šç›¸åŒçš„ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®é…ç½®çš„æ•°æ®æºç±»å‹è¿›è¡Œå…·ä½“çš„DataSourceåˆ›å»ºã€‚ dataSourceMap.put(poolName, defaultDataSourceCreator.createDataSource(dataSourceProperty)); } return dataSourceMap; } } 2.2.1.1 æ„å»ºDataSource æ¥çœ‹ä¸€ä¸‹defaultDataSourceCreator.createDataSource()çš„é€»è¾‘\npublic DataSource createDataSource(DataSourceProperty dataSourceProperty) { DataSourceCreator dataSourceCreator = null; //this.creatorsæ˜¯æ‰€æœ‰é€‚é…çš„DataSourceCreatorå®ç°ç±» for (DataSourceCreator creator : this.creators) { //æ ¹æ®é…ç½®åŒ¹é…å¯¹åº”çš„dataSourceCreator if (creator.support(dataSourceProperty)) { //å¦‚æœåŒ¹é…ï¼Œåˆ™ä½¿ç”¨å¯¹åº”çš„dataSourceCreator dataSourceCreator = creator; break; } } if (dataSourceCreator == null) { throw new IllegalStateException(\"creator must not be null,please check the DataSourceCreator\"); } String publicKey = dataSourceProperty.getPublicKey(); if (StringUtils.isEmpty(publicKey)) { dataSourceProperty.setPublicKey(properties.getPublicKey()); } Boolean lazy = dataSourceProperty.getLazy(); if (lazy == null) { dataSourceProperty.setLazy(properties.getLazy()); } //ç„¶åå†è°ƒç”¨createDataSourceæ–¹æ³•è¿›è¡Œåˆ›å»ºå¯¹åº”DataSource DataSource dataSource = dataSourceCreator.createDataSource(dataSourceProperty); // (å¦‚æœæœ‰åˆ™è¿è¡Œ, å¯ä»¥è‡ªå®šä¹‰)è¿è¡Œ å»ºè¡¨è¯­å¥å’Œæ•°æ®è„šæœ¬ this.runScrip(dataSource, dataSourceProperty); return wrapDataSource(dataSource, dataSourceProperty); } åˆ›å»ºDataSourceçš„æœ‰å¾ˆå¤šå®ç°ç±», æ¯ç§æ•°æ®æºéƒ½æœ‰è‡ªå·±çš„å®ç°\nå¯¹åº”çš„å…¨éƒ¨å®ç°ç±»æ˜¯æ”¾åœ¨creatoråŒ…ä¸‹ï¼š\nåˆ›å»ºdataSourceå°±å¾ˆç®€å•äº†, å°±æ˜¯æŠŠè´¦å·/å¯†ç /urlç­‰å‚æ•°è®¾ç½®è¿›å»\n2.2.2 å¯¹æ•°æ®æºåˆ†ç»„ å†å›åˆ°ä¹‹å‰çš„ï¼Œå½“æ‹¿åˆ°DataSourceçš„Mapé›†åˆä¹‹åï¼Œå†åšä»€ä¹ˆå‘¢ï¼Ÿ\næ¥ç€è°ƒaddDataSource()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ ¹æ®ä¸‹åˆ’çº¿\"_â€œå¯¹æ•°æ®æºè¿›è¡Œåˆ†ç»„ï¼Œæœ€åæ”¾åˆ°groupDataSourcesæˆå‘˜å˜é‡é‡Œé¢ã€‚ com.baomidou.dynamic.datasource.DynamicRoutingDataSource#addDataSource\nprivate static final String UNDERLINE = \"_\"; // è½®è¯¢ç­–ç•¥ private Class\u003c? extends DynamicDataSourceStrategy\u003e strategy = LoadBalanceDynamicDataSourceStrategy.class; /** * æ–°æ•°æ®æºæ·»åŠ åˆ°åˆ†ç»„ * * @param ds æ–°æ•°æ®æºçš„åå­— * @param dataSource æ–°æ•°æ®æº */ private void addGroupDataSource(String ds, DataSource dataSource) { if (ds.contains(UNDERLINE)) { String group = ds.split(UNDERLINE)[0]; GroupDataSource groupDataSource = groupDataSources.get(group); if (groupDataSource == null) { try { //é¡ºä¾¿è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œstrategyé»˜è®¤æ˜¯LoadBalanceDynamicDataSourceStrategy groupDataSource = new GroupDataSource(group, strategy.getDeclaredConstructor().newInstance()); groupDataSources.put(group, groupDataSource); } catch (Exception e) { throw new RuntimeException(\"dynamic-datasource - add the datasource named \" + ds + \" error\", e); } } groupDataSource.addDatasource(ds, dataSource); } } è‡³æ­¤, é¡¹ç›®å¯åŠ¨æ—¶, å¤šæ•°æ®åšçš„äº‹å°±å®Œäº†, é‚£æˆ‘ä»¬æ‰§è¡Œsqlæ—¶, å®ƒæ˜¯æ€ä¹ˆåˆ‡æ¢çš„å‘¢?\n2.3 åˆ‡æ¢æ•°æ®æº åœ¨å‰é¢çš„DynamicRoutingDataSourceæˆ‘ä»¬çŸ¥é“, è¿™æ˜¯mybatisPluså†™çš„è·å–æ•°æ®æºçš„ç±» , å®ƒæœ€ç»ˆæ˜¯é€šè¿‡com.baomidou.dynamic.datasource.DynamicRoutingDataSource#determineDataSourceè·å¾—æ•°æ®æºçš„, åœ¨ 2.2.1 ä¹Ÿæœ‰æè¿°.\n@Override public DataSource determineDataSource() { // ä»threadLocalä¸­è·å–å½“å‰æ•°æ®æºkey (å°±æ˜¯@DSæ³¨è§£é‡Œçš„å­—ç¬¦ä¸²) String dsKey = DynamicDataSourceContextHolder.peek(); // æ ¹æ®keyè·å–æ•°æ®æº return getDataSource(dsKey); } é‚£ä¹ˆä¸Šé¢çš„DynamicDataSourceContextHolderè¿™ä¸ªç±»æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿæ³¨è§£@DSçš„å€¼åˆæ˜¯æ€ä¹ˆä¼ è¿›æ¥çš„å‘¢ï¼Ÿ\næˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªç±»\n2.3.1 DynamicDataSourceContextHolder /** * æ ¸å¿ƒåŸºäºThreadLocalçš„åˆ‡æ¢æ•°æ®æºå·¥å…·ç±» */ public final class DynamicDataSourceContextHolder { /** * ä¸ºä»€ä¹ˆè¦ç”¨é“¾è¡¨å­˜å‚¨(å‡†ç¡®çš„æ˜¯æ ˆ) * * ä¸ºäº†æ”¯æŒåµŒå¥—åˆ‡æ¢ï¼Œå¦‚ABCä¸‰ä¸ªserviceéƒ½æ˜¯ä¸åŒçš„æ•°æ®æº * å…¶ä¸­Açš„æŸä¸ªä¸šåŠ¡è¦è°ƒBçš„æ–¹æ³•ï¼ŒBçš„æ–¹æ³•éœ€è¦è°ƒç”¨Cçš„æ–¹æ³•ã€‚ä¸€çº§ä¸€çº§è°ƒç”¨åˆ‡æ¢ï¼Œå½¢æˆäº†é“¾ã€‚ * ä¼ ç»Ÿçš„åªè®¾ç½®å½“å‰çº¿ç¨‹çš„æ–¹å¼ä¸èƒ½æ»¡è¶³æ­¤ä¸šåŠ¡éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨æ ˆï¼Œåè¿›å…ˆå‡ºã€‚ * */ private static final ThreadLocal\u003cDeque\u003cString\u003e\u003e LOOKUP_KEY_HOLDER = new NamedThreadLocal\u003cDeque\u003cString\u003e\u003e(\"dynamic-datasource\") { @Override protected Deque\u003cString\u003e initialValue() { return new ArrayDeque\u003c\u003e(); } }; /** * è·å¾—å½“å‰çº¿ç¨‹æ•°æ®æº * * @return æ•°æ®æºåç§° */ public static String peek() { return LOOKUP_KEY_HOLDER.get().peek(); } /** * è®¾ç½®å½“å‰çº¿ç¨‹æ•°æ®æº * * å¦‚éå¿…è¦ä¸è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œè°ƒç”¨åç¡®ä¿æœ€ç»ˆæ¸…é™¤ * * * @param ds æ•°æ®æºåç§° */ public static String push(String ds) { String dataSourceStr = StringUtils.isEmpty(ds) ? \"\" : ds; LOOKUP_KEY_HOLDER.get().push(dataSourceStr); return dataSourceStr; } // .... } è¿™é‡Œç”¨çš„æ˜¯NamedThreadLocal, æ¯”ThreadLocalå¤šäº†ä¸€ä¸ªåå­—å­—æ®µè€Œå·², å¤§å®¶çŸ¥é“ThreadLocal çš„ç‰¹æ€§: çº¿ç¨‹éš”ç¦»/å†…å­˜æ³„éœ²é£é™©, æ‰€ä»¥ å½“å¼€å¤šçº¿ç¨‹ä¼šè®©å¤šæ•°æ®æºåˆ‡æ¢å¤±è´¥(çœ‹ä½ @DSæ³¨è§£æ‰“åœ¨å“ªå’Œå…·ä½“ä½¿ç”¨); ç½‘ä¸Šè¯´ç”¨åˆ° DynamicDataSourceContextHolderç±»æ—¶, éƒ½æ˜¯push()å’Œclean()/poll()ä¸€èµ·ä½¿ç”¨.å…¶å®å°±æ˜¯é¿å…å†…å­˜æ³„éœ²\næ—¢ç„¶æœ‰peek(), é‚£è‚¯å®šæœ‰push(), æˆ‘ä»¬æ¥åæ¨ä¸€ä¸‹, çœ‹ä¸€ä¸‹å“ªäº›åœ°æ–¹åœ¨è°ƒç”¨push(), å¯ä»¥å‘ç°æœ‰ä¸¤ä¸ªåœ°æ–¹, åˆ†åˆ«æ˜¯\nDynamicDataSourceAnnotationInterceptor å’Œ MasterSlaveAutoRoutingPlugin,\nMasterSlaveAutoRoutingPluginæ˜¯åšä¸»ä»æ•°æ®åº“åˆ‡æ¢çš„, æˆ‘ä»¬è‡ªç„¶çœ‹ DynamicDataSourceAnnotationInterceptor\n2.3.2 DynamicDataSourceAnnotationInterceptor public class DynamicDataSourceAnnotationInterceptor implements MethodInterceptor { /** * The identification of SPEL. */ private static final String DYNAMIC_PREFIX = \"#\"; private final DataSourceClassResolver dataSourceClassResolver; private final DsProcessor dsProcessor; public DynamicDataSourceAnnotationInterceptor(Boolean allowedPublicOnly, DsProcessor dsProcessor) { dataSourceClassResolver = new DataSourceClassResolver(allowedPublicOnly); this.dsProcessor = dsProcessor; } @Override public Object invoke(MethodInvocation invocation) throws Throwable { //æ‰¾åˆ°@DSæ³¨è§£çš„å±æ€§å€¼ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æºåç§° String dsKey = determineDatasourceKey(invocation); //æŠŠæ•°æ®æºåç§°pushåˆ°å½“å‰çº¿ç¨‹çš„æ ˆ DynamicDataSourceContextHolder.push(dsKey); try { //æ‰§è¡Œå½“å‰æ–¹æ³• return invocation.proceed(); } finally { //ä»æ ˆé‡Œé‡Šæ”¾æ•°æ®æº DynamicDataSourceContextHolder.poll(); } } private String determineDatasourceKey(MethodInvocation invocation) { // ä»æ–¹æ³•ä¸Šå’Œç±»ä¸Š è·å–key String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis()); // å¦‚æœæ•°æ®æºæ˜¯ä»¥ # å¼€å¤´, åˆ™è¿›å…¥dså¤„ç†å™¨, è¿™é‡Œç”¨çš„æ˜¯è´£ä»»é“¾æ¨¡å¼ return (!key.isEmpty() \u0026\u0026 key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key; } } å®ƒæ˜¯invokeæ–¹æ³•, ä¸€çœ‹å°±æ˜¯åå°„æ ‡å‡†å†™æ³•, çœ‹ä¸€ä¸‹å®ƒçš„çˆ¶ç±», MethodInterceptor, å®ƒå¯ä»¥å¯¹AOPçš„åˆ‡é¢è¿›è¡Œå¢å¼º,\nç®€å•æ¥è¯´, å¦‚æœè¢«åˆ‡åˆ°å, å°±ä¼šè°ƒç”¨è¿™ä¸ªinvokeæ–¹æ³•\nSpringåŠ¨æ€ä»£ç†ä¹‹MethodInterceptoræ‹¦æˆªå™¨è¯¦è§£ - ç®€ä¹¦ (jianshu.com) æˆ‘ä»¬ç»§ç»­çœ‹åˆ‡é¢æ˜¯å¦‚ä½•ä½¿ç”¨çš„, è€Œdså¤„ç†å™¨ç­‰ä¼šè®²\n2.3.4 DynamicDataSourceAnnotationAdvisor ç›´æ¥çœ‹ DynamicDataSourceAnnotationInterceptor åœ¨å“ªé‡Œç”¨åˆ°äº†, ä¼šå‘ç°å›åˆ°äº†DynamicDataSourceAutoConfigurationç±»\n@Role(value = BeanDefinition.ROLE_INFRASTRUCTURE) @Bean public Advisor dynamicDatasourceAnnotationAdvisor(DsProcessor dsProcessor) { // åˆ›å»ºæ‹¦æˆªå™¨ DynamicDataSourceAnnotationInterceptor interceptor = new DynamicDataSourceAnnotationInterceptor(properties.isAllowedPublicOnly(), dsProcessor); // æŠŠæ‹¦æˆªå™¨æ”¾åˆ°Advisorä¸Š DynamicDataSourceAnnotationAdvisor advisor = new DynamicDataSourceAnnotationAdvisor(interceptor); advisor.setOrder(properties.getOrder()); return advisor; } Advisoræ˜¯Spring AOPçš„é¡¶å±‚æŠ½è±¡ï¼Œç”¨æ¥ç®¡ç†Adviceå’ŒPointcut\n@Transactional ä¹Ÿæ˜¯ç”¨è¿™ç§æ–¹å¼åšçš„\nä» AbstractPointcutAdvisor å¼€å§‹ï¼š Spring AOP ä¹‹ Advisorã€PointcutAdvisor ä»‹ç» DynamicDataSourceAnnotationAdvisoræ˜¯ç”¨äºAOPåˆ‡é¢ç¼–ç¨‹çš„ï¼Œé’ˆå¯¹æ³¨è§£@DSçš„åˆ‡é¢è¿›è¡Œå¤„ç†ï¼š\npublic class DynamicDataSourceAnnotationAdvisor extends AbstractPointcutAdvisor implements BeanFactoryAware { private final Advice advice; private final Pointcut pointcut; // åˆå§‹åŒ–æ—¶è°ƒç”¨äº†æ„é€ æ–¹æ³• public DynamicDataSourceAnnotationAdvisor(@NonNull DynamicDataSourceAnnotationInterceptor dynamicDataSourceAnnotationInterceptor) { this.advice = dynamicDataSourceAnnotationInterceptor; this.pointcut = buildPointcut(); } @Override public Pointcut getPointcut() { return this.pointcut; } @Override public Advice getAdvice() { return this.advice; } private Pointcut buildPointcut() { Pointcut cpc = new AnnotationMatchingPointcut(DS.class, true); Pointcut mpc = new AnnotationMethodPoint(DS.class); //æ–¹æ³•ä¼˜äºç±» return new ComposablePointcut(cpc).union(mpc); } // ..... } æ‰€ä»¥æ€»çš„æ¥è¯´, å½“æ‰§è¡Œçš„æ–¹æ³•æˆ–è€…ç±»è¢« @DSåˆ‡åˆ°æ—¶, å°±ä¼šæ‰§è¡Œå¢å¼ºæ–¹æ³•, æŠŠæ•°æ®æºkeyæ”¾åˆ°threadLocalä¸­, è·å–æ•°æ®æºæ—¶ä»threadLocalä¸­æ‹¿åˆ°keyè¿›è€Œæ‹¿åˆ°æ•°æ®æº\nè‡³æ­¤, å¤šæ•°æ®æºçš„åˆå§‹åŒ–å’Œä½¿ç”¨æ—¶åˆ‡æ¢å°±ç»“æŸäº†\n2.4 æ•°æ®æºçš„å¤„ç†å™¨ åœ¨com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKeyå¤„, æœ‰è¯´è¿‡dså¤„ç†å™¨, å®ƒæ˜¯å¹²ä»€ä¹ˆçš„å‘¢?\næˆ‘ä»¬å¸¸ç”¨çš„æŒ‡å®šæ•°æ®æºçš„æ–¹å¼æ—¶æ˜¯ @DS(\"master\") @DS(\"salve_1\"), è¿™äº›éƒ½æ˜¯å›ºå®šå­—ç¬¦ä¸², å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®ç§Ÿæˆ·æ¥åˆ‡æ¢æ•°æ®æºå‘¢?æˆ–è€…å¼•å…¥ç°åº¦ç³»ç»ŸåæŒ‰Headerçš„å±æ€§æ¥åˆ‡æ¢å‘¢? å› æ­¤plusçš„æä¾›äº†å„ç§æ•°æ®æºçš„å¤„ç†å™¨\nDsHeaderProcessor : ä»headerä¸­è·å– DsSessionProcessor: ä»sessionä¸­è·å– DsSpelExpressionProcessor: è§£æSpelè¯­æ³•è·å– å¸¸è§çš„@vaule()æ³¨è§£å°±æ”¯æŒspelè¯­æ³•, ä»é…ç½®æ–‡ä»¶ä¸­å–å€¼æˆ–è€…å†™é»˜è®¤å€¼éƒ½æ˜¯spelè¯­æ³•\nç©è½¬Springä¸­å¼ºå¤§çš„spelè¡¨è¾¾å¼ï¼ - çŸ¥ä¹ (zhihu.com) ç»§ç»­ com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey, çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç \nprivate String determineDatasourceKey(MethodInvocation invocation) { String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis()); // dsProcessor.determineDatasource() ä»å¤„ç†å™¨è·å–æ•°æ®æº return (!key.isEmpty() \u0026\u0026 key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key; } dsProcessor åå‘å®šä½è¿™ä¸ªå˜é‡, ä¼šè¿½è¸ªåˆ°com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration#dsProcessor\n@Bean @ConditionalOnMissingBean public DsProcessor dsProcessor(BeanFactory beanFactory) { // å…ˆheaderå¤„ç†å™¨ DsHeaderProcessor headerProcessor = new DsHeaderProcessor(); DsSessionProcessor sessionProcessor = new DsSessionProcessor(); DsSpelExpressionProcessor spelExpressionProcessor = new DsSpelExpressionProcessor(); spelExpressionProcessor.setBeanResolver(new BeanFactoryResolver(beanFactory)); // å†sessionå¤„ç†å™¨ headerProcessor.setNextProcessor(sessionProcessor); // æœ€åspelå¤„ç†å™¨ sessionProcessor.setNextProcessor(spelExpressionProcessor); return headerProcessor; } å›åˆ°ä½¿ç”¨çš„åœ°æ–¹, è¿›å…¥æ–¹æ³•\ncom.baomidou.dynamic.datasource.processor.DsProcessor\n/** * å†³å®šæ•°æ®æº * * è°ƒç”¨åº•å±‚doDetermineDatasourceï¼Œ * å¦‚æœè¿”å›çš„æ˜¯nullåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªï¼Œå¦åˆ™ç›´æ¥è¿”å› * * * @param invocation æ–¹æ³•æ‰§è¡Œä¿¡æ¯ * @param key DSæ³¨è§£é‡Œçš„å†…å®¹ * @return æ•°æ®æºåç§° */ public String determineDatasource(MethodInvocation invocation, String key) { // keyçš„æ ¼å¼æ˜¯å¦åŒ¹é… if (matches(key)) { // è§£ææ•°æ®æºkey String datasource = doDetermineDatasource(invocation, key); if (datasource == null \u0026\u0026 nextProcessor != null) { // ä¸‹ä¸€ä¸ªå¤„ç†å™¨ return nextProcessor.determineDatasource(invocation, key); } return datasource; } if (nextProcessor != null) { return nextProcessor.determineDatasource(invocation, key); } return null; } æˆ‘ä»¬ä»¥DsHeaderProcessor ä¸ºä¾‹:\npublic class DsHeaderProcessor extends DsProcessor { /** * header prefix */ private static final String HEADER_PREFIX = \"#header\"; @Override public boolean matches(String key) { // æ˜¯å¦ ä»¥#header å¼€å¤´ return key.startsWith(HEADER_PREFIX); } @Override public String doDetermineDatasource(MethodInvocation invocation, String key) { HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); // ä»è¯·æ±‚å¤´ä¸­ç›´æ¥è·å–(å¾ˆç²—æš´,ç«Ÿç„¶è¿åˆ†éš”ç¬¦éƒ½ä¸ç”¨), æ¯”å¦‚@DS(\"#headeruserId\"), è¿™æ ·å°±ä¼šä»headerä¸­å–å‡ºuserIdå­—æ®µ return request.getHeader(key.substring(8));// åˆšå¥½æŠŠ #header è¿™å‡ ä¸ªå­—ç¬¦æˆªæ–­ } } sessionå¤„ç†å™¨æ˜¯ä»¥#session å¼€å¤´\næŒ‰é¡ºåºå¤„ç†éƒ½ä¸æ˜¯å, å°±ä¼šæŒ‰DsSpelExpressionProcessor å¤„ç†\nä¸¾ä¸€äº›ä¾‹å­:\n@DS(\"#headerUserId\") : å–headerä¸­çš„UserIdå­—æ®µä½œä¸ºæ•°æ®æºkey\n@DS(\"#sessionTentendId\") : å–sessionä¸­çš„TentendIdå­—æ®µä½œä¸ºæ•°æ®æºkey\n@DS(\"#person\"): æŠŠæ–¹æ³•ä¸Šçš„å˜é‡personçš„å€¼ä½œä¸ºæ•°æ®æºkey (SPELè¯­æ³•)\nå­¦ä¹ SPELè¯­æ³•å°±ä¼šå‘ç°å¾ˆå¤šå¥‡å¦™ç”¨æ³•, æ¯”å¦‚å¯ä¸è·å–æ–¹æ³•çš„å‚æ•°;æ–¹æ³•çš„è¿”å‚ç±»å‹; ç±»çš„åç§°ç­‰\n3. Q\u0026A 3.1 @Transactional å’Œ @DS æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶, @DSå¤±æ•ˆçš„é—®é¢˜ è¿™æ˜¯å› ä¸º @Transactional å¼€å¯äº‹åŠ¡å, å°±ä¸ä¼šé‡æ–°æ‹¿æ•°æ®æº,å› ä¸º@DSä¹Ÿå¾—é€šè¿‡åˆ‡é¢å»è·å–æ•°æ®æº, è¿™æ ·å°±å¯¼è‡´äº†@DSå¤±æ•ˆ.\nè¦è§£å†³çš„è¯, å°±åœ¨è¦åˆ‡æ¢æ•°æ®æºçš„æ–¹æ³•ä¸Šä¹Ÿæ‰“ä¸Š@DS, æˆ–è€…å¤šä¸ªæ•°æ®æºæœ‰ä¿®æ”¹æ“ä½œå¯ä»¥éƒ½æ‰“ä¸Šäº‹åŠ¡æ³¨è§£å¹¶æ”¹å˜ä¼ æ’­æœºåˆ¶,(ä½†è¿™å…¶å®æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„èŒƒç•´, è¿™æ ·æ“ä½œä¸èƒ½ä¿è¯äº‹åŠ¡äº†, plusä¹Ÿæä¾›äº†@DSTransactional æ¥æ”¯æŒ, ä¸å¤Ÿéœ€è¦å€ŸåŠ©seata)\n@Transactionalè·Ÿ@DSåŠ¨æ€æ•°æ®æºæ³¨è§£å†²çª_æ—èœ—ç‰›snailçš„åšå®¢-CSDNåšå®¢ å…³äº @DSTransactional ä»¥åå†è¡¥å……ä¸€ä¸‹\n3.2 ä½äºV3.3.3ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜ è¿™æ˜¯å› ä¸ºåœ¨V3.3.3ç‰ˆæœ¬ä¹‹å‰, DruidDataSourceAutoConfigureä¼šæ¯”DynamicDataSourceAutoConfigurationå…ˆæ³¨å†Œ, å¯¼è‡´æ•°æ®åº“æœ‰è¯»å–druidçš„é…ç½®, æ‰€ä»¥ä¼šå‡ºç° ,æ²¡æœ‰druidé…ç½®å¯åŠ¨æŠ¥é”™; æ•°æ®æºæ— æ³•åˆ‡æ¢ç­‰ç­‰åŸå› , å®˜æ–¹åœ¨V3.3.3è¿™ä¸ªç‰ˆæœ¬ä¿®å¤äº†, ä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬æœ‰ä¸ªå…¶ä»–çš„é‡ç‚¹bug,å®˜æ–¹ä¸è®©ä¸‹è½½, æ‰€ä»¥githubä¸Šæ‰¾ä¸åˆ°è¿™ä¸ªç‰ˆæœ¬çš„æè¿°, åªåœ¨å®˜ç½‘æœ‰æè¿°\nåˆ†ä¸¤æ­¥è§£å†³çš„,\nå»é™¤ druid pomåæ ‡ åœ¨ DynamicDataSourceAutoConfiguration ä¸ŠæŒ‡å®šä¼˜äº DruidDataSourceAutoConfigureåŠ è½½ è§£å†³åŠæ³•å°±æ˜¯æ’é™¤DruidDataSourceAutoConfigure ç±»;\nä½¿ç”¨dynamic-datasource-spring-boot-starteråšå¤šæ•°æ®æºåŠæºç åˆ†æ_0x2015çš„åšå®¢-CSDNåšå®¢ Mybatis-Pluså¤šæ•°æ®æºè§£æ - æ˜é‡‘ (juejin.cn) å¤šæ•°æ®æºå®˜ç½‘-ç‰ˆæœ¬è®°å½• Mybatis plusçš„å¤šæ•°æ®æº@DSåˆ‡æ¢ä¸ºä»€ä¹ˆä¸èµ·ä½œç”¨äº†ï¼Œè°çš„é”…ï¼Œ@Transactional ","wordCount":"7104","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-08T09:03:16.254783239Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.com/zh/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>ğŸ </a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus.html>myBatis-Plus</a> <span>></span></ul></nav><h1 class=post-title>å¤šæ•°æ®æºè§£æ</h1><div class=post-description></div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;æ›´æ–°:&nbsp;2023-09-08&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></ul><span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv>1</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1-%e4%bd%bf%e7%94%a8 aria-label="1. ä½¿ç”¨">1. ä½¿ç”¨</a><ul><li><a href=#11-%e5%bc%95%e5%8c%85 aria-label="1.1. å¼•åŒ…">1.1. å¼•åŒ…</a></li><li><a href=#12-%e5%a2%9e%e5%8a%a0%e9%85%8d%e7%bd%ae aria-label="1.2 å¢åŠ é…ç½®">1.2 å¢åŠ é…ç½®</a></li><li><a href=#13-%e4%bd%bf%e7%94%a8ds%e6%b3%a8%e8%a7%a3 aria-label="1.3 ä½¿ç”¨@DSæ³¨è§£">1.3 ä½¿ç”¨@DSæ³¨è§£</a></li></ul></li><li><a href=#2-%e6%ba%90%e7%a0%81 aria-label="2. æºç ">2. æºç </a><ul><li><a href=#21-configuration%e6%96%87%e4%bb%b6-%e5%8a%a0%e8%bd%bd%e9%85%8d%e7%bd%ae%e4%b8%8ebean%e6%b3%a8%e5%85%a5 aria-label="2.1 Configurationæ–‡ä»¶, åŠ è½½é…ç½®ä¸beanæ³¨å…¥">2.1 Configurationæ–‡ä»¶, åŠ è½½é…ç½®ä¸beanæ³¨å…¥</a><ul><li><a href=#211--%e9%85%8d%e7%bd%ae%e7%b1%bb aria-label="2.1.1  é…ç½®ç±»">2.1.1 é…ç½®ç±»</a></li></ul></li><li><a href=#22-%e6%b3%a8%e5%86%8cdatasource aria-label="2.2 æ³¨å†ŒDataSource">2.2 æ³¨å†ŒDataSource</a><ul><li><a href=#221--%e8%8e%b7%e5%8f%96%e6%89%80%e6%9c%89%e7%9a%84datasource aria-label="2.2.1  è·å–æ‰€æœ‰çš„DataSource">2.2.1 è·å–æ‰€æœ‰çš„DataSource</a><ul><li><a href=#2211-%e6%9e%84%e5%bb%badatasource aria-label="2.2.1.1 æ„å»ºDataSource">2.2.1.1 æ„å»ºDataSource</a></li></ul></li><li><a href=#222-%e5%af%b9%e6%95%b0%e6%8d%ae%e6%ba%90%e5%88%86%e7%bb%84 aria-label="2.2.2 å¯¹æ•°æ®æºåˆ†ç»„">2.2.2 å¯¹æ•°æ®æºåˆ†ç»„</a></li></ul></li><li><a href=#23-%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label="2.3 åˆ‡æ¢æ•°æ®æº">2.3 åˆ‡æ¢æ•°æ®æº</a><ul><li><a href=#231-dynamicdatasourcecontextholder aria-label="2.3.1 DynamicDataSourceContextHolder">2.3.1 DynamicDataSourceContextHolder</a></li><li><a href=#232-dynamicdatasourceannotationinterceptor aria-label="2.3.2 DynamicDataSourceAnnotationInterceptor">2.3.2 DynamicDataSourceAnnotationInterceptor</a></li><li><a href=#234--dynamicdatasourceannotationadvisor aria-label="2.3.4  DynamicDataSourceAnnotationAdvisor">2.3.4 DynamicDataSourceAnnotationAdvisor</a></li></ul></li><li><a href=#24-%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8 aria-label="2.4 æ•°æ®æºçš„å¤„ç†å™¨">2.4 æ•°æ®æºçš„å¤„ç†å™¨</a></li></ul></li><li><a href=#3-qa aria-label="3. Q&amp;amp;A">3. Q&amp;A</a><ul><li><a href=#31-transactional-%e5%92%8c-ds-%e6%b3%a8%e8%a7%a3%e4%b8%80%e8%b5%b7%e4%bd%bf%e7%94%a8%e6%97%b6-ds%e5%a4%b1%e6%95%88%e7%9a%84%e9%97%ae%e9%a2%98 aria-label="3.1 @Transactional å’Œ @DS æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶, @DSå¤±æ•ˆçš„é—®é¢˜">3.1 @Transactional å’Œ @DS æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶, @DSå¤±æ•ˆçš„é—®é¢˜</a></li><li><a href=#32--%e4%bd%8e%e4%ba%8ev333%e7%89%88%e6%9c%ac%e6%97%a0%e6%b3%95%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e9%97%ae%e9%a2%98 aria-label="3.2  ä½äºV3.3.3ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜">3.2 ä½äºV3.3.3ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1-ä½¿ç”¨>1. ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#1-ä½¿ç”¨>#</a></h1><h2 id=11-å¼•åŒ…>1.1. å¼•åŒ…<a hidden class=anchor aria-hidden=true href=#11-å¼•åŒ…>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;groupId&gt;</span>com.baomidou<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;version&gt;</span>3.3.6<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>ç”¨æœ€æ–°ç‰ˆçš„å°±å¥½ <a href=https://mvnrepository.com/artifact/com.baomidou/dynamic-datasource-spring-boot-starter target=_blank rel=noopener>Maven Repository: dynamic-datasource-spring-boot-starter</a></p><blockquote><p>ä¸è¿‡åšå¼€å‘çš„ç»éªŒæ¥çœ‹, åº”è¯¥é€‰ å€’æ•°ç¬¬äºŒä¸ªå¤§ç‰ˆæœ¬é‡Œæœ€æ–°çš„ç‰ˆæœ¬, è¿™æ ·æ—¢èƒ½ç”¨æ›´å¤šçš„åŠŸèƒ½,åˆèƒ½ä¿è¯æ²¡æœ‰å¤§bug, é™¤éæœ€æ–°ç‰ˆæœ¬æœ‰ä½ éœ€è¦çš„åŠŸèƒ½</p></blockquote><h2 id=12-å¢åŠ é…ç½®>1.2 å¢åŠ é…ç½®<a hidden class=anchor aria-hidden=true href=#12-å¢åŠ é…ç½®>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>datasource</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>dynamic</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>primary</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>master</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>#è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster, æ‰€ä»¥æ­¤å¤„ä¸å†™ä¹Ÿå¯ä»¥</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>strict</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>false</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>#è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™å›æŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨ä¼šä½¿ç”¨é»˜è®¤æ•°æ®æº.</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>datasource</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>master</span>:<span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># ç¬¬ä¸€ä¸ªæ•°æ®æºçš„åç§°</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jdbc:mysql://127.0.0.1:3306/dynamic</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>username</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>root</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>password</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>123456</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>driver-class-name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>com.mysql.jdbc.Driver</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>db_1</span>:<span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># ç¬¬äºŒä¸ªæ•°æ®æºçš„åç§°</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jdbc:gbase://127.0.0.1:5258/dynamic</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>username</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>root</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>password</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>123456</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>driver-class-name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>com.mysql.jdbc.Driver</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>å¦‚æœæ˜¯å¤šä¸»å¤šä»æˆ–è€…ä¸€ä¸»å¤šä»ï¼Œé‚£ä¹ˆå°±ç”¨åˆ†ç»„çš„åŠŸèƒ½å®ç°, å³: <strong>æ•°æ®ç»„åç§°_xxx</strong>ï¼Œä¸‹åˆ’çº¿å‰é¢çš„å°±æ˜¯æ•°æ®ç»„åç§°ï¼Œåé¢å°±æ˜¯æ•°æ®æºå, ç›¸åŒç»„åç§°çš„æ•°æ®æºä¼šæ”¾åœ¨ä¸€ä¸ªç»„ä¸‹ã€‚åˆ‡æ¢æ•°æ®æºæ—¶ï¼Œå¯ä»¥æŒ‡å®š<strong>å…·ä½“æ•°æ®æºåç§°</strong>ï¼Œä¹Ÿå¯ä»¥æŒ‡å®š<strong>ç»„å</strong>ç„¶åä¼šè‡ªåŠ¨é‡‡ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•åˆ‡æ¢,</p><p>ä¾‹å¦‚: ä¸Šé¢é…ç½®ä¸­çš„"db_1", è¡¨ç¤ºdbåˆ†ç»„, 1 åç§°çš„æ•°æ®æº, å¦‚æœå†å¢åŠ ä¸€ä¸ª"db_2", åˆ™è¡¨ç¤ºè¿™ä¸¤ä¸ªæ•°æ®æºæ˜¯åŒä¸€ä¸ªåˆ†ç»„, å½“åœ¨<code>@DS</code>ä¸­åªæŒ‡å®š"db", åˆ™ä¼šåœ¨è¿™ä¸ªåˆ†ç»„ä¸­é‡‡ç”¨è´Ÿè½½å‡è¡¡æ–¹å¼é€‰æ•°æ®æº(é»˜è®¤æ˜¯è½®è¯¢)</p><h2 id=13-ä½¿ç”¨dsæ³¨è§£>1.3 ä½¿ç”¨@DSæ³¨è§£<a hidden class=anchor aria-hidden=true href=#13-ä½¿ç”¨dsæ³¨è§£>#</a></h2><p>@DSæ³¨è§£, æ˜¯ç”¨æ¥è¡¨ç¤ºä½¿ç”¨å“ªä¸ªæ•°æ®æºçš„, ä¹Ÿæ˜¯åˆ‡æ¢æ•°æ®æºåŠŸèƒ½çš„æ ¸å¿ƒæ³¨è§£, <strong>å®ƒå¯ä»¥ç”¨æ¥ç±»å’Œæ–¹æ³•ä¸Š, æ–¹æ³•ä¸Šçš„ä¼˜å…ˆçº§æ›´é«˜</strong>, ä¾‹å¦‚ serviceå±‚, Mapperå±‚,éƒ½å¯ä»¥, å¦‚æœæ²¡æœ‰é…ç½®,åˆ™ä¼šä½¿ç”¨é»˜è®¤æ•°æ®æº</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Service</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;master&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#8b949e;font-style:italic>// åœ¨ç±»ä¸ŠåŠ 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UserServiceImpl</span> <span style=color:#ff7b72>implements</span> UserService <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> JdbcTemplate jdbcTemplate<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>public</span> List<span style=color:#ff7b72;font-weight:700>&lt;</span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> Object<span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#d2a8ff;font-weight:700>selectAll</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> jdbcTemplate<span style=color:#ff7b72;font-weight:700>.</span>queryForList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;select * from user&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_1&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#8b949e;font-style:italic>// åœ¨æ–¹æ³•ä¸ŠåŠ 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>public</span> List<span style=color:#ff7b72;font-weight:700>&lt;</span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> Object<span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#d2a8ff;font-weight:700>selectByCondition</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> jdbcTemplate<span style=color:#ff7b72;font-weight:700>.</span>queryForList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;select * from user where age &gt;10&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>å®˜æ–¹å»ºè®®ä¸å»ºè®®@DSæ”¾åœ¨Mapperä¸Š, æ‰€ä»¥ç½‘ä¸Šæœ‰å¾ˆå¤šä¾‹å­æ˜¯æ”¾åœ¨serviceä¸Š,</p><p>ä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜, å½“åœ¨serviceä¸­éœ€è¦è®¿é—®ä¸¤ä¸ªæ•°æ®åº“æ—¶, å°±ä¼šæ— æ³•åˆ‡æ¢æ•°æ®æº, æ¯•ç«Ÿ@DSæ˜¯åŠ åœ¨serviceä¸Š, åœ¨åŒä¸€ä¸ªserviceä¸Šæ“ä½œ, è‡ªç„¶ä¸ä¼šåˆ‡æ¢, å®˜æ–¹ä¹Ÿç»™å‡ºè§£å†³æ–¹æ¡ˆ, åœ¨æ–¹æ³•ä¸Šè¿›ä¸€æ­¥æŒ‡å®šæ•°æ®æº, (ä¼ªä»£ç )ä¾‹å¦‚:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Person</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    dbService1 db_1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    dbService2 db_2<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>test</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>        db_1<span style=color:#ff7b72;font-weight:700>.</span>save<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¦‚æœ db_2.save() ä¸æŒ‡å®šæ•°æ®æº, æ•°æ®æºä¼šä½¿ç”¨db_1
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        db_2<span style=color:#ff7b72;font-weight:700>.</span>save<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_1&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>dbService1</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>save</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_2&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>dbService2</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_2&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>save</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><a href=https://segmentfault.com/q/1010000041340273 target=_blank rel=noopener>mybatis-plusä¸­å¤šæ•°æ®æºåˆ‡æ¢@DSæ³¨è§£åˆ°åº•æ”¾åœ¨å“ªä¸€å±‚åˆé€‚ï¼Ÿ</a></p><p><a href=https://github.com/baomidou/dynamic-datasource-spring-boot-starter/issues/259 target=_blank rel=noopener>@DSä¸å»ºè®®åŠ åœ¨mapperä¸Šçš„åŸå› æ˜¯?</a></p><h1 id=2-æºç >2. æºç <a hidden class=anchor aria-hidden=true href=#2-æºç >#</a></h1><p>ä¸€èˆ¬starterè‡ªåŠ¨é…ç½®ï¼Œéƒ½æ˜¯ä» <strong>META-INF/spring.factories</strong>æ–‡ä»¶ä¸­æŒ‡å®šè‡ªåŠ¨é…ç½®ç±»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>org<span style=color:#ff7b72;font-weight:700>.</span>springframework<span style=color:#ff7b72;font-weight:700>.</span>boot<span style=color:#ff7b72;font-weight:700>.</span>autoconfigure<span style=color:#ff7b72;font-weight:700>.</span>EnableAutoConfiguration<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#f85149>\</span>
</span></span><span style=display:flex><span>com<span style=color:#ff7b72;font-weight:700>.</span>baomidou<span style=color:#ff7b72;font-weight:700>.</span>dynamic<span style=color:#ff7b72;font-weight:700>.</span>datasource<span style=color:#ff7b72;font-weight:700>.</span>spring<span style=color:#ff7b72;font-weight:700>.</span>boot<span style=color:#ff7b72;font-weight:700>.</span>autoconfigure<span style=color:#ff7b72;font-weight:700>.</span>DynamicDataSourceAutoConfiguration
</span></span></code></pre></div><p>æ‰€ä»¥æ‰“å¼€ <strong>DynamicDataSourceAutoConfiguration</strong> æ–‡ä»¶</p><h2 id=21-configurationæ–‡ä»¶-åŠ è½½é…ç½®ä¸beanæ³¨å…¥>2.1 Configurationæ–‡ä»¶, åŠ è½½é…ç½®ä¸beanæ³¨å…¥<a hidden class=anchor aria-hidden=true href=#21-configurationæ–‡ä»¶-åŠ è½½é…ç½®ä¸beanæ³¨å…¥>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åŠ¨æ€æ•°æ®æºæ ¸å¿ƒè‡ªåŠ¨é…ç½®ç±»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@EnableConfigurationProperties</span><span style=color:#ff7b72;font-weight:700>(</span>DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// @AutoConfigureBefore æ³¨è§£çš„æ„æ€æ˜¯ åœ¨DataSourceAutoConfigurationå’ŒDruidDataSourceAutoConfigureä¹‹å‰å°±æ³¨å†Œå½“å‰bean
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¿™é‡Œç‰¹åˆ«æ³¨æ„ä¸€ä¸‹, åœ¨ V3.3.3 ä¹‹å‰, æ²¡æœ‰æŠŠDruidDataSourceAutoConfigureåŠ è¿›æ¥, æ‰€ä»¥å¯¼è‡´é¡¹ç›®ä¸­æœ‰druidæ—¶,æ•°æ®æºæ— æ³•åˆ‡æ¢æˆ–æ²¡æœ‰druidé…ç½®åˆ™æŠ¥é”™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>@AutoConfigureBefore</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> DataSourceAutoConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>//å¼•å…¥äº†Druidçš„autoConfigå’Œå„ç§æ•°æ®æºè¿æ¥æ± çš„Creator
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>@Import</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>{</span>DynamicDataSourceCreatorAutoConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> DynamicDataSourceAopConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> DynamicDataSourceAssistConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@ConditionalOnProperty</span><span style=color:#ff7b72;font-weight:700>(</span>prefix <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>PREFIX<span style=color:#ff7b72;font-weight:700>,</span> name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;enabled&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> havingValue <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;true&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> matchIfMissing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceAutoConfiguration</span>  <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> DynamicDataSourceProperties properties<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//è¯»å–å¤šæ•°æ®æºé…ç½®ï¼Œæ³¨å…¥åˆ°springå®¹å™¨ä¸­
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DynamicDataSourceProvider <span style=color:#d2a8ff;font-weight:700>dynamicDataSourceProvider</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSourceProperty<span style=color:#ff7b72;font-weight:700>&gt;</span> datasourceMap <span style=color:#ff7b72;font-weight:700>=</span> properties<span style=color:#ff7b72;font-weight:700>.</span>getDatasource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> YmlDynamicDataSourceProvider<span style=color:#ff7b72;font-weight:700>(</span>datasourceMap<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//æ³¨å†Œè‡ªå·±çš„åŠ¨æ€å¤šæ•°æ®æºDataSource
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>dataSource</span><span style=color:#ff7b72;font-weight:700>(</span>DynamicDataSourceProvider dynamicDataSourceProvider<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DynamicRoutingDataSource dataSource <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicRoutingDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setPrimary<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getPrimary<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setStrict<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getStrict<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setStrategy<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getStrategy<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setProvider<span style=color:#ff7b72;font-weight:700>(</span>dynamicDataSourceProvider<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setP6spy<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getP6spy<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setSeata<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getSeata<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> dataSource<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//AOPåˆ‡é¢ï¼Œå¯¹DSæ³¨è§£è¿‡çš„æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œè¾¾åˆ°åˆ‡æ¢æ•°æ®æºçš„ç›®çš„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Role</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> BeanDefinition<span style=color:#ff7b72;font-weight:700>.</span>ROLE_INFRASTRUCTURE<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DynamicDataSourceAnnotationAdvisor <span style=color:#d2a8ff;font-weight:700>dynamicDatasourceAnnotationAdvisor</span><span style=color:#ff7b72;font-weight:700>(</span>DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DynamicDataSourceAnnotationInterceptor interceptor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>isAllowedPublicOnly<span style=color:#ff7b72;font-weight:700>(),</span> dsProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        DynamicDataSourceAnnotationAdvisor advisor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationAdvisor<span style=color:#ff7b72;font-weight:700>(</span>interceptor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        advisor<span style=color:#ff7b72;font-weight:700>.</span>setOrder<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getOrder<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> advisor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//å…³äºåˆ†å¸ƒå¼äº‹åŠ¡åŠ å¼º
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Role</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> BeanDefinition<span style=color:#ff7b72;font-weight:700>.</span>ROLE_INFRASTRUCTURE<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnProperty</span><span style=color:#ff7b72;font-weight:700>(</span>prefix <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>PREFIX<span style=color:#ff7b72;font-weight:700>,</span> name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;seata&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> havingValue <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;false&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> matchIfMissing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Advisor <span style=color:#d2a8ff;font-weight:700>dynamicTransactionAdvisor</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        AspectJExpressionPointcut pointcut <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AspectJExpressionPointcut<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        pointcut<span style=color:#ff7b72;font-weight:700>.</span>setExpression<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;@annotation(com.baomidou.dynamic.datasource.annotation.DSTransactional)&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> DefaultPointcutAdvisor<span style=color:#ff7b72;font-weight:700>(</span>pointcut<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>new</span> DynamicTransactionAdvisor<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//åŠ¨æ€å‚æ•°è§£æå™¨é“¾
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DsProcessor <span style=color:#d2a8ff;font-weight:700>dsProcessor</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DsHeaderProcessor headerProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsHeaderProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSessionProcessor sessionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSessionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSpelExpressionProcessor spelExpressionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSpelExpressionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        headerProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>sessionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        sessionProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>spelExpressionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> headerProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™é…ç½®çš„å‰ç¼€ä¸º<code>spring.datasource.dynamic</code>çš„é…ç½®éƒ½ä¼šè¢«è¯»å–åˆ°<code>DynamicDataSourceProperties</code>ç±»ï¼Œä½œä¸ºä¸€ä¸ªBeanæ³¨å…¥åˆ°Springå®¹å™¨ã€‚å…¶å®è¿™ç§è¯»å–é…ç½®æ–‡ä»¶ä¿¡æ¯çš„æ–¹å¼åœ¨æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„ã€‚</p><h3 id=211--é…ç½®ç±»>2.1.1 é…ç½®ç±»<a hidden class=anchor aria-hidden=true href=#211--é…ç½®ç±»>#</a></h3><p><strong>DynamicDataSourceProperties</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@ConfigurationProperties</span><span style=color:#ff7b72;font-weight:700>(</span>prefix <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>PREFIX<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceProperties</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String PREFIX <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;spring.datasource.dynamic&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String HEALTH <span style=color:#ff7b72;font-weight:700>=</span> PREFIX <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;.health&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> Â  Â  * å¿…é¡»è®¾ç½®é»˜è®¤çš„åº“,é»˜è®¤master
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> Â  Â  */</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>private</span> String primary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;master&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> Â  Â  * æ˜¯å¦å¯ç”¨ä¸¥æ ¼æ¨¡å¼,é»˜è®¤ä¸å¯åŠ¨. ä¸¥æ ¼æ¨¡å¼ä¸‹æœªåŒ¹é…åˆ°æ•°æ®æºç›´æ¥æŠ¥é”™, éä¸¥æ ¼æ¨¡å¼ä¸‹åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æºprimaryæ‰€è®¾ç½®çš„æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> Â  Â  */</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>private</span> Boolean strict <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// .......
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=22-æ³¨å†Œdatasource>2.2 æ³¨å†ŒDataSource<a hidden class=anchor aria-hidden=true href=#22-æ³¨å†Œdatasource>#</a></h2><p>åœ¨ <code>DynamicDataSourceAutoConfiguration</code> ç±»ä¸­, è¿˜åŠ è½½äº†DataSource, æˆ‘ä»¬çŸ¥é“ DataSourceæ˜¯springç”¨æ¥é“¾æ¥æ•°æ®åº“çš„,</p><p>å®ƒæ³¨å†Œäº†ä¸€ä¸ªå®ç°ç±» <code>DynamicRoutingDataSource</code>, è¿™ä¸ªç±»è¿˜æœ‰ä¸€ä¸ªçˆ¶ç±»<code>AbstractRoutingDataSource</code>, æˆ‘ä»¬å…ˆçœ‹<code>AbstractRoutingDataSource</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * æŠ½è±¡åŠ¨æ€è·å–æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * @author TaoYu
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * @since 2.2.0
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>abstract</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AbstractRoutingDataSource</span> <span style=color:#ff7b72>extends</span> AbstractDataSource <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#8b949e;font-style:italic>//æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ï¼Œè®©å­ç±»å†³å®šæœ€ç»ˆä½¿ç”¨çš„æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â <span style=color:#ff7b72>protected</span> <span style=color:#ff7b72>abstract</span> DataSource <span style=color:#d2a8ff;font-weight:700>determineDataSource</span><span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#8b949e;font-style:italic>//é‡å†™getConnection()æ–¹æ³•ï¼Œå®ç°åˆ‡æ¢æ•°æ®æºçš„åŠŸèƒ½
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>public</span> Connection <span style=color:#d2a8ff;font-weight:700>getConnection</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72>throws</span> SQLException <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â <span style=color:#8b949e;font-style:italic>//è¿™é‡Œxidæ¶‰åŠåˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â  Â  Â String xid <span style=color:#ff7b72;font-weight:700>=</span> TransactionContext<span style=color:#ff7b72;font-weight:700>.</span>getXID<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>xid<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â  Â  Â <span style=color:#8b949e;font-style:italic>//ä¸ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå°±æ˜¯ç›´æ¥è¿”å›ä¸€ä¸ªæ•°æ®è¿æ¥(å®ç°ç±»: ItemDataSource.class)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â  Â  Â  Â  Â <span style=color:#ff7b72>return</span> determineDataSource<span style=color:#ff7b72;font-weight:700>().</span>getConnection<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span> Â  Â  Â   <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â  Â  Â String ds <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>peek<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â  Â  Â ConnectionProxy connection <span style=color:#ff7b72;font-weight:700>=</span> ConnectionFactory<span style=color:#ff7b72;font-weight:700>.</span>getConnection<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â  Â  Â <span style=color:#ff7b72>return</span> connection <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>?</span> getConnectionProxy<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>,</span> determineDataSource<span style=color:#ff7b72;font-weight:700>().</span>getConnection<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>:</span> connection<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span> Â  Â  Â   <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span> Â   <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>çˆ¶ç±»å¾ˆç®€å•, åªæ˜¯åŒºåˆ†äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„å–connectçš„æ–¹å¼,æ‰€ä»¥å†æ¥çœ‹ä¸‹å…¶å­ç±»<code>DynamicRoutingDataSource</code> çš„å†…å®¹</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicRoutingDataSource</span> <span style=color:#ff7b72>extends</span> AbstractRoutingDataSource <span style=color:#ff7b72>implements</span> InitializingBean<span style=color:#ff7b72;font-weight:700>,</span> DisposableBean <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String UNDERLINE <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;_&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * æ‰€æœ‰æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSourceMap <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ConcurrentHashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * åˆ†ç»„æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> GroupDataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> groupDataSources <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ConcurrentHashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> DynamicDataSourceProvider provider<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Class<span style=color:#ff7b72;font-weight:700>&lt;?</span> <span style=color:#ff7b72>extends</span> DynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>&gt;</span> strategy <span style=color:#ff7b72;font-weight:700>=</span> LoadBalanceDynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String primary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;master&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean strict <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean p6spy <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean seata <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>determineDataSource</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è·å¾—æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> getDataSource<span style=color:#ff7b72;font-weight:700>(</span>DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>peek<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> DataSource <span style=color:#d2a8ff;font-weight:700>determinePrimaryDataSource</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource switch to the primary datasource&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>).</span>determineDataSource<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>:</span> dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// beançš„å±æ€§åŠ è½½å®Œå, æ‰§è¡Œè¯¥æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>afterPropertiesSet</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72>throws</span> Exception <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥å¼€å¯äº†é…ç½®ä½†æ²¡æœ‰ç›¸å…³ä¾èµ–
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        checkEnv<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®æº, Keyæ˜¯æ•°æ®æºçš„åç§°ï¼ŒValueåˆ™æ˜¯DataSourceã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSources <span style=color:#ff7b72;font-weight:700>=</span> provider<span style=color:#ff7b72;font-weight:700>.</span>loadDataSources<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ·»åŠ å¹¶åˆ†ç»„æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Map<span style=color:#ff7b72;font-weight:700>.</span>Entry<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dsItem <span style=color:#ff7b72;font-weight:700>:</span> dataSources<span style=color:#ff7b72;font-weight:700>.</span>entrySet<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            addDataSource<span style=color:#ff7b72;font-weight:700>(</span>dsItem<span style=color:#ff7b72;font-weight:700>.</span>getKey<span style=color:#ff7b72;font-weight:700>(),</span> dsItem<span style=color:#ff7b72;font-weight:700>.</span>getValue<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æµ‹é»˜è®¤æ•°æ®æºæ˜¯å¦è®¾ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource initial loaded [{}] datasource,primary group datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataSources<span style=color:#ff7b72;font-weight:700>.</span>size<span style=color:#ff7b72;font-weight:700>(),</span> primary<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource initial loaded [{}] datasource,primary datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataSources<span style=color:#ff7b72;font-weight:700>.</span>size<span style=color:#ff7b72;font-weight:700>(),</span> primary<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> RuntimeException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource Please check the setting of primary&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è·å–æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ds æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>getDataSource</span><span style=color:#ff7b72;font-weight:700>(</span>String ds<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// æ²¡æœ‰dsæ³¨è§£, åˆ™é»˜è®¤ç”¨ Primary
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>return</span> determinePrimaryDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å¦‚æœæœ‰ç»„, åˆ™ç”¨è´Ÿè½½å‡è¡¡çš„æ–¹å¼å–ä¸€ä¸ª
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource switch to the datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>).</span>determineDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// æ²¡æœ‰ç»„, åˆ™ç›´æ¥å–
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource switch to the datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä¸¥æ ¼æ¨¡å¼ä¸‹ç›´æ¥æŠ¥é”™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>strict<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> CannotFindDataSourceException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource could not find a datasource named&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> determinePrimaryDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// .....
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>å®ƒå®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£éœ€è¦å®ç°<code>afterPropertiesSet()</code>æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªBeançš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œåœ¨Beanåˆå§‹åŒ–çš„æ—¶å€™åšä¸€äº›æ“ä½œ</p><h3 id=221--è·å–æ‰€æœ‰çš„datasource>2.2.1 è·å–æ‰€æœ‰çš„DataSource<a hidden class=anchor aria-hidden=true href=#221--è·å–æ‰€æœ‰çš„datasource>#</a></h3><p>å…ˆçœ‹ä¸€ä¸‹å®ƒæ˜¯æ€ä¹ˆè·å¾—æ•°æ®æºçš„? <code>provider.loadDataSources()</code> æ˜¯æŠ½è±¡æ–¹æ³•, æœ‰ä¸¤ä¸ªå®ç°</p><p><code>YmlDynamicDataSourceProvider</code>å’Œ<code>AbstractJdbcDataSourceProvider</code>, åœ¨<code>DynamicDataSourceAutoConfiguration</code> ç±»ä¸­, æ³¨å…¥çš„æ˜¯<code>YmlDynamicDataSourceProvider</code>, æ‰€ä»¥ç›´æ¥çœ‹å®ƒçš„å®ç° , æœ€åä¼šè·³è½¬åˆ°<code>AbstractDataSourceProvider</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>abstract</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AbstractDataSourceProvider</span> <span style=color:#ff7b72>implements</span> DynamicDataSourceProvider <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> DefaultDataSourceCreator defaultDataSourceCreator<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>protected</span> Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>createDataSourceMap</span><span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>            Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSourceProperty<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSourcePropertiesMap<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSourceMap <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> HashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;(</span>dataSourcePropertiesMap<span style=color:#ff7b72;font-weight:700>.</span>size<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>*</span> 2<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Map<span style=color:#ff7b72;font-weight:700>.</span>Entry<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSourceProperty<span style=color:#ff7b72;font-weight:700>&gt;</span> item <span style=color:#ff7b72;font-weight:700>:</span> dataSourcePropertiesMap<span style=color:#ff7b72;font-weight:700>.</span>entrySet<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            DataSourceProperty dataSourceProperty <span style=color:#ff7b72;font-weight:700>=</span> item<span style=color:#ff7b72;font-weight:700>.</span>getValue<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            String poolName <span style=color:#ff7b72;font-weight:700>=</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>getPoolName<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>poolName <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#34;&#34;</span><span style=color:#ff7b72;font-weight:700>.</span>equals<span style=color:#ff7b72;font-weight:700>(</span>poolName<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                poolName <span style=color:#ff7b72;font-weight:700>=</span> item<span style=color:#ff7b72;font-weight:700>.</span>getKey<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>setPoolName<span style=color:#ff7b72;font-weight:700>(</span>poolName<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>//            è¿™é‡Œçš„defaultDataSourceCreator.createDataSource()æ–¹æ³•ä½¿ç”¨åˆ°é€‚é…å™¨æ¨¡å¼ã€‚å› ä¸ºæ¯ç§é…ç½®æ•°æ®æºåˆ›å»ºçš„DataSourceå®ç°ç±»éƒ½ä¸ä¸€å®šç›¸åŒçš„ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®é…ç½®çš„æ•°æ®æºç±»å‹è¿›è¡Œå…·ä½“çš„DataSourceåˆ›å»ºã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span>poolName<span style=color:#ff7b72;font-weight:700>,</span> defaultDataSourceCreator<span style=color:#ff7b72;font-weight:700>.</span>createDataSource<span style=color:#ff7b72;font-weight:700>(</span>dataSourceProperty<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> dataSourceMap<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=2211-æ„å»ºdatasource>2.2.1.1 æ„å»ºDataSource<a hidden class=anchor aria-hidden=true href=#2211-æ„å»ºdatasource>#</a></h4><p>æ¥çœ‹ä¸€ä¸‹<code>defaultDataSourceCreator.createDataSource()</code>çš„é€»è¾‘</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>createDataSource</span><span style=color:#ff7b72;font-weight:700>(</span>DataSourceProperty dataSourceProperty<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DataSourceCreator dataSourceCreator <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>//this.creatorsæ˜¯æ‰€æœ‰é€‚é…çš„DataSourceCreatorå®ç°ç±»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>DataSourceCreator creator <span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>creators<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>//æ ¹æ®é…ç½®åŒ¹é…å¯¹åº”çš„dataSourceCreator
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>creator<span style=color:#ff7b72;font-weight:700>.</span>support<span style=color:#ff7b72;font-weight:700>(</span>dataSourceProperty<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//å¦‚æœåŒ¹é…ï¼Œåˆ™ä½¿ç”¨å¯¹åº”çš„dataSourceCreator
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                dataSourceCreator <span style=color:#ff7b72;font-weight:700>=</span> creator<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>break</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>dataSourceCreator <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> IllegalStateException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;creator must not be null,please check the DataSourceCreator&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String publicKey <span style=color:#ff7b72;font-weight:700>=</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>getPublicKey<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>publicKey<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>setPublicKey<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getPublicKey<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Boolean lazy <span style=color:#ff7b72;font-weight:700>=</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>getLazy<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>lazy <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>setLazy<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getLazy<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>//ç„¶åå†è°ƒç”¨createDataSourceæ–¹æ³•è¿›è¡Œåˆ›å»ºå¯¹åº”DataSource
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DataSource dataSource <span style=color:#ff7b72;font-weight:700>=</span> dataSourceCreator<span style=color:#ff7b72;font-weight:700>.</span>createDataSource<span style=color:#ff7b72;font-weight:700>(</span>dataSourceProperty<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// (å¦‚æœæœ‰åˆ™è¿è¡Œ, å¯ä»¥è‡ªå®šä¹‰)è¿è¡Œ å»ºè¡¨è¯­å¥å’Œæ•°æ®è„šæœ¬
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>runScrip<span style=color:#ff7b72;font-weight:700>(</span>dataSource<span style=color:#ff7b72;font-weight:700>,</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> wrapDataSource<span style=color:#ff7b72;font-weight:700>(</span>dataSource<span style=color:#ff7b72;font-weight:700>,</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>åˆ›å»ºDataSourceçš„æœ‰å¾ˆå¤šå®ç°ç±», æ¯ç§æ•°æ®æºéƒ½æœ‰è‡ªå·±çš„å®ç°</p><p>å¯¹åº”çš„å…¨éƒ¨å®ç°ç±»æ˜¯æ”¾åœ¨creatoråŒ…ä¸‹ï¼š</p><p><img loading=lazy src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2319212a11c4446784d5ee196f8f67d7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp alt=img></p><p>åˆ›å»ºdataSourceå°±å¾ˆç®€å•äº†, å°±æ˜¯æŠŠè´¦å·/å¯†ç /urlç­‰å‚æ•°è®¾ç½®è¿›å»</p><h3 id=222-å¯¹æ•°æ®æºåˆ†ç»„>2.2.2 å¯¹æ•°æ®æºåˆ†ç»„<a hidden class=anchor aria-hidden=true href=#222-å¯¹æ•°æ®æºåˆ†ç»„>#</a></h3><p>å†å›åˆ°ä¹‹å‰çš„ï¼Œå½“æ‹¿åˆ°DataSourceçš„Mapé›†åˆä¹‹åï¼Œå†åšä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æ¥ç€è°ƒ<code>addDataSource()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ ¹æ®ä¸‹åˆ’çº¿"_&ldquo;å¯¹æ•°æ®æºè¿›è¡Œåˆ†ç»„ï¼Œæœ€åæ”¾åˆ°<code>groupDataSources</code>æˆå‘˜å˜é‡é‡Œé¢ã€‚ <code>com.baomidou.dynamic.datasource.DynamicRoutingDataSource#addDataSource</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String UNDERLINE <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;_&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è½®è¯¢ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>private</span> Class<span style=color:#ff7b72;font-weight:700>&lt;?</span> <span style=color:#ff7b72>extends</span> DynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>&gt;</span> strategy <span style=color:#ff7b72;font-weight:700>=</span> LoadBalanceDynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * æ–°æ•°æ®æºæ·»åŠ åˆ°åˆ†ç»„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ds         æ–°æ•°æ®æºçš„åå­—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param dataSource æ–°æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>addGroupDataSource</span><span style=color:#ff7b72;font-weight:700>(</span>String ds<span style=color:#ff7b72;font-weight:700>,</span> DataSource dataSource<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>.</span>contains<span style=color:#ff7b72;font-weight:700>(</span>UNDERLINE<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String group <span style=color:#ff7b72;font-weight:700>=</span> ds<span style=color:#ff7b72;font-weight:700>.</span>split<span style=color:#ff7b72;font-weight:700>(</span>UNDERLINE<span style=color:#ff7b72;font-weight:700>)[</span>0<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>        GroupDataSource groupDataSource <span style=color:#ff7b72;font-weight:700>=</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>groupDataSource <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//é¡ºä¾¿è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œstrategyé»˜è®¤æ˜¯LoadBalanceDynamicDataSourceStrategy
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                groupDataSource <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> GroupDataSource<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>,</span> strategy<span style=color:#ff7b72;font-weight:700>.</span>getDeclaredConstructor<span style=color:#ff7b72;font-weight:700>().</span>newInstance<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>,</span> groupDataSource<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Exception e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> RuntimeException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource - add the datasource named &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> ds <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34; error&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        groupDataSource<span style=color:#ff7b72;font-weight:700>.</span>addDatasource<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>,</span> dataSource<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>è‡³æ­¤, é¡¹ç›®å¯åŠ¨æ—¶, å¤šæ•°æ®åšçš„äº‹å°±å®Œäº†, é‚£æˆ‘ä»¬æ‰§è¡Œsqlæ—¶, å®ƒæ˜¯æ€ä¹ˆåˆ‡æ¢çš„å‘¢?</p><h2 id=23-åˆ‡æ¢æ•°æ®æº>2.3 åˆ‡æ¢æ•°æ®æº<a hidden class=anchor aria-hidden=true href=#23-åˆ‡æ¢æ•°æ®æº>#</a></h2><p>åœ¨å‰é¢çš„<code>DynamicRoutingDataSource</code>æˆ‘ä»¬çŸ¥é“, è¿™æ˜¯mybatisPluså†™çš„è·å–æ•°æ®æºçš„ç±» , å®ƒæœ€ç»ˆæ˜¯é€šè¿‡<code>com.baomidou.dynamic.datasource.DynamicRoutingDataSource#determineDataSource</code>è·å¾—æ•°æ®æºçš„, åœ¨ 2.2.1 ä¹Ÿæœ‰æè¿°.</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>determineDataSource</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä»threadLocalä¸­è·å–å½“å‰æ•°æ®æºkey (å°±æ˜¯@DSæ³¨è§£é‡Œçš„å­—ç¬¦ä¸²)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        String dsKey <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>peek<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ ¹æ®keyè·å–æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> getDataSource<span style=color:#ff7b72;font-weight:700>(</span>dsKey<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>é‚£ä¹ˆä¸Šé¢çš„<code>DynamicDataSourceContextHolder</code>è¿™ä¸ªç±»æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿæ³¨è§£@DSçš„å€¼åˆæ˜¯æ€ä¹ˆä¼ è¿›æ¥çš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªç±»</p><h3 id=231-dynamicdatasourcecontextholder>2.3.1 DynamicDataSourceContextHolder<a hidden class=anchor aria-hidden=true href=#231-dynamicdatasourcecontextholder>#</a></h3><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * æ ¸å¿ƒåŸºäºThreadLocalçš„åˆ‡æ¢æ•°æ®æºå·¥å…·ç±»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceContextHolder</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ä¸ºä»€ä¹ˆè¦ç”¨é“¾è¡¨å­˜å‚¨(å‡†ç¡®çš„æ˜¯æ ˆ)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ä¸ºäº†æ”¯æŒåµŒå¥—åˆ‡æ¢ï¼Œå¦‚ABCä¸‰ä¸ªserviceéƒ½æ˜¯ä¸åŒçš„æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * å…¶ä¸­Açš„æŸä¸ªä¸šåŠ¡è¦è°ƒBçš„æ–¹æ³•ï¼ŒBçš„æ–¹æ³•éœ€è¦è°ƒç”¨Cçš„æ–¹æ³•ã€‚ä¸€çº§ä¸€çº§è°ƒç”¨åˆ‡æ¢ï¼Œå½¢æˆäº†é“¾ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * ä¼ ç»Ÿçš„åªè®¾ç½®å½“å‰çº¿ç¨‹çš„æ–¹å¼ä¸èƒ½æ»¡è¶³æ­¤ä¸šåŠ¡éœ€æ±‚ï¼Œå¿…é¡»ä½¿ç”¨æ ˆï¼Œåè¿›å…ˆå‡ºã€‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;/pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>Deque<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> LOOKUP_KEY_HOLDER <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> NamedThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>Deque<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;&gt;(</span><span style=color:#a5d6ff>&#34;dynamic-datasource&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>protected</span> Deque<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>initialValue</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> ArrayDeque<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>};</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è·å¾—å½“å‰çº¿ç¨‹æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> String <span style=color:#d2a8ff;font-weight:700>peek</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> LOOKUP_KEY_HOLDER<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>peek<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * è®¾ç½®å½“å‰çº¿ç¨‹æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * å¦‚éå¿…è¦ä¸è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œè°ƒç”¨åç¡®ä¿æœ€ç»ˆæ¸…é™¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ds æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> String <span style=color:#d2a8ff;font-weight:700>push</span><span style=color:#ff7b72;font-weight:700>(</span>String ds<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String dataSourceStr <span style=color:#ff7b72;font-weight:700>=</span> StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> <span style=color:#a5d6ff>&#34;&#34;</span> <span style=color:#ff7b72;font-weight:700>:</span> ds<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        LOOKUP_KEY_HOLDER<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>push<span style=color:#ff7b72;font-weight:700>(</span>dataSourceStr<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> dataSourceStr<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ....
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>è¿™é‡Œç”¨çš„æ˜¯<code>NamedThreadLocal</code>, æ¯”<code>ThreadLocal</code>å¤šäº†ä¸€ä¸ªåå­—å­—æ®µè€Œå·², å¤§å®¶çŸ¥é“<code>ThreadLocal</code> çš„ç‰¹æ€§: çº¿ç¨‹éš”ç¦»/å†…å­˜æ³„éœ²é£é™©, æ‰€ä»¥ <strong>å½“å¼€å¤šçº¿ç¨‹ä¼šè®©å¤šæ•°æ®æºåˆ‡æ¢å¤±è´¥(çœ‹ä½ @DSæ³¨è§£æ‰“åœ¨å“ªå’Œå…·ä½“ä½¿ç”¨); ç½‘ä¸Šè¯´ç”¨åˆ° <code>DynamicDataSourceContextHolder</code>ç±»æ—¶, éƒ½æ˜¯<code>push()</code>å’Œ<code>clean()</code>/<code>poll()</code>ä¸€èµ·ä½¿ç”¨.å…¶å®å°±æ˜¯é¿å…å†…å­˜æ³„éœ²</strong></p><p>æ—¢ç„¶æœ‰<code>peek()</code>, é‚£è‚¯å®šæœ‰<code>push()</code>, æˆ‘ä»¬æ¥åæ¨ä¸€ä¸‹, çœ‹ä¸€ä¸‹å“ªäº›åœ°æ–¹åœ¨è°ƒç”¨<code>push()</code>, å¯ä»¥å‘ç°æœ‰ä¸¤ä¸ªåœ°æ–¹, åˆ†åˆ«æ˜¯</p><p><code>DynamicDataSourceAnnotationInterceptor</code> å’Œ <code>MasterSlaveAutoRoutingPlugin</code>,</p><p><code>MasterSlaveAutoRoutingPlugin</code>æ˜¯åšä¸»ä»æ•°æ®åº“åˆ‡æ¢çš„, æˆ‘ä»¬è‡ªç„¶çœ‹ <code>DynamicDataSourceAnnotationInterceptor</code></p><h3 id=232-dynamicdatasourceannotationinterceptor>2.3.2 DynamicDataSourceAnnotationInterceptor<a hidden class=anchor aria-hidden=true href=#232-dynamicdatasourceannotationinterceptor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceAnnotationInterceptor</span> <span style=color:#ff7b72>implements</span> MethodInterceptor <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> Â  Â  * The identification of SPEL.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> Â  Â  */</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String DYNAMIC_PREFIX <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;#&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> DataSourceClassResolver dataSourceClassResolver<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>public</span> <span style=color:#d2a8ff;font-weight:700>DynamicDataSourceAnnotationInterceptor</span><span style=color:#ff7b72;font-weight:700>(</span>Boolean allowedPublicOnly<span style=color:#ff7b72;font-weight:700>,</span> DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â dataSourceClassResolver <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DataSourceClassResolver<span style=color:#ff7b72;font-weight:700>(</span>allowedPublicOnly<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>dsProcessor <span style=color:#ff7b72;font-weight:700>=</span> dsProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span> Â   <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span> Â  Â <span style=color:#ff7b72>public</span> Object <span style=color:#d2a8ff;font-weight:700>invoke</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throws</span> Throwable <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â <span style=color:#8b949e;font-style:italic>//æ‰¾åˆ°@DSæ³¨è§£çš„å±æ€§å€¼ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â  Â  Â String dsKey <span style=color:#ff7b72;font-weight:700>=</span> determineDatasourceKey<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â <span style=color:#8b949e;font-style:italic>//æŠŠæ•°æ®æºåç§°pushåˆ°å½“å‰çº¿ç¨‹çš„æ ˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â  Â  Â DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>push<span style=color:#ff7b72;font-weight:700>(</span>dsKey<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â  Â  Â <span style=color:#8b949e;font-style:italic>//æ‰§è¡Œå½“å‰æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â  Â  Â  Â  Â <span style=color:#ff7b72>return</span> invocation<span style=color:#ff7b72;font-weight:700>.</span>proceed<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span> Â  Â  Â   <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>finally</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span> Â  Â  Â  Â  Â  Â <span style=color:#8b949e;font-style:italic>//ä»æ ˆé‡Œé‡Šæ”¾æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span> Â  Â  Â  Â  Â  Â DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>poll<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span> Â  Â  Â   <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span> Â   <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String <span style=color:#d2a8ff;font-weight:700>determineDatasourceKey</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä»æ–¹æ³•ä¸Šå’Œç±»ä¸Š è·å–key
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        String key <span style=color:#ff7b72;font-weight:700>=</span> dataSourceClassResolver<span style=color:#ff7b72;font-weight:700>.</span>findDSKey<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>.</span>getMethod<span style=color:#ff7b72;font-weight:700>(),</span> invocation<span style=color:#ff7b72;font-weight:700>.</span>getThis<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¦‚æœæ•°æ®æºæ˜¯ä»¥ # å¼€å¤´, åˆ™è¿›å…¥dså¤„ç†å™¨, è¿™é‡Œç”¨çš„æ˜¯è´£ä»»é“¾æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>(!</span>key<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> key<span style=color:#ff7b72;font-weight:700>.</span>startsWith<span style=color:#ff7b72;font-weight:700>(</span>DYNAMIC_PREFIX<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>?</span> dsProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>:</span> key<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>å®ƒæ˜¯invokeæ–¹æ³•, ä¸€çœ‹å°±æ˜¯åå°„æ ‡å‡†å†™æ³•, çœ‹ä¸€ä¸‹å®ƒçš„çˆ¶ç±», <code>MethodInterceptor</code>, å®ƒå¯ä»¥å¯¹AOPçš„åˆ‡é¢è¿›è¡Œå¢å¼º,</p><p>ç®€å•æ¥è¯´, å¦‚æœè¢«åˆ‡åˆ°å, å°±ä¼šè°ƒç”¨è¿™ä¸ªinvokeæ–¹æ³•</p><blockquote><p><a href=https://www.jianshu.com/p/71c4e8b8f09b target=_blank rel=noopener>SpringåŠ¨æ€ä»£ç†ä¹‹MethodInterceptoræ‹¦æˆªå™¨è¯¦è§£ - ç®€ä¹¦ (jianshu.com)</a></p></blockquote><p>æˆ‘ä»¬ç»§ç»­çœ‹åˆ‡é¢æ˜¯å¦‚ä½•ä½¿ç”¨çš„, è€Œdså¤„ç†å™¨ç­‰ä¼šè®²</p><h3 id=234--dynamicdatasourceannotationadvisor>2.3.4 DynamicDataSourceAnnotationAdvisor<a hidden class=anchor aria-hidden=true href=#234--dynamicdatasourceannotationadvisor>#</a></h3><p>ç›´æ¥çœ‹ <code>DynamicDataSourceAnnotationInterceptor</code> åœ¨å“ªé‡Œç”¨åˆ°äº†, ä¼šå‘ç°å›åˆ°äº†<code>DynamicDataSourceAutoConfiguration</code>ç±»</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Role</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> BeanDefinition<span style=color:#ff7b72;font-weight:700>.</span>ROLE_INFRASTRUCTURE<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Advisor <span style=color:#d2a8ff;font-weight:700>dynamicDatasourceAnnotationAdvisor</span><span style=color:#ff7b72;font-weight:700>(</span>DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åˆ›å»ºæ‹¦æˆªå™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DynamicDataSourceAnnotationInterceptor interceptor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>isAllowedPublicOnly<span style=color:#ff7b72;font-weight:700>(),</span> dsProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æŠŠæ‹¦æˆªå™¨æ”¾åˆ°Advisorä¸Š
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DynamicDataSourceAnnotationAdvisor advisor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationAdvisor<span style=color:#ff7b72;font-weight:700>(</span>interceptor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        advisor<span style=color:#ff7b72;font-weight:700>.</span>setOrder<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getOrder<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> advisor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p>Advisoræ˜¯Spring AOPçš„é¡¶å±‚æŠ½è±¡ï¼Œç”¨æ¥ç®¡ç†Adviceå’ŒPointcut</p><p>@Transactional ä¹Ÿæ˜¯ç”¨è¿™ç§æ–¹å¼åšçš„</p><p><a href=https://cloud.tencent.com/developer/article/1808649 target=_blank rel=noopener>ä» AbstractPointcutAdvisor å¼€å§‹ï¼š Spring AOP ä¹‹ Advisorã€PointcutAdvisor ä»‹ç»</a></p></blockquote><p><code>DynamicDataSourceAnnotationAdvisor</code>æ˜¯ç”¨äºAOPåˆ‡é¢ç¼–ç¨‹çš„ï¼Œé’ˆå¯¹æ³¨è§£@DSçš„åˆ‡é¢è¿›è¡Œå¤„ç†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceAnnotationAdvisor</span> <span style=color:#ff7b72>extends</span> AbstractPointcutAdvisor <span style=color:#ff7b72>implements</span> BeanFactoryAware <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Advice advice<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Pointcut pointcut<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆå§‹åŒ–æ—¶è°ƒç”¨äº†æ„é€ æ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>public</span> <span style=color:#d2a8ff;font-weight:700>DynamicDataSourceAnnotationAdvisor</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#d2a8ff;font-weight:700>@NonNull</span> DynamicDataSourceAnnotationInterceptor dynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>advice <span style=color:#ff7b72;font-weight:700>=</span> dynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>pointcut <span style=color:#ff7b72;font-weight:700>=</span> buildPointcut<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Pointcut <span style=color:#d2a8ff;font-weight:700>getPointcut</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>pointcut<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Advice <span style=color:#d2a8ff;font-weight:700>getAdvice</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>advice<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Pointcut <span style=color:#d2a8ff;font-weight:700>buildPointcut</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Pointcut cpc <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AnnotationMatchingPointcut<span style=color:#ff7b72;font-weight:700>(</span>DS<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        Pointcut mpc <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AnnotationMethodPoint<span style=color:#ff7b72;font-weight:700>(</span>DS<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//æ–¹æ³•ä¼˜äºç±»
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> ComposablePointcut<span style=color:#ff7b72;font-weight:700>(</span>cpc<span style=color:#ff7b72;font-weight:700>).</span>union<span style=color:#ff7b72;font-weight:700>(</span>mpc<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span> <span style=color:#8b949e;font-style:italic>// .....   
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>æ‰€ä»¥æ€»çš„æ¥è¯´, å½“æ‰§è¡Œçš„æ–¹æ³•æˆ–è€…ç±»è¢« @DSåˆ‡åˆ°æ—¶, å°±ä¼šæ‰§è¡Œå¢å¼ºæ–¹æ³•, æŠŠæ•°æ®æºkeyæ”¾åˆ°threadLocalä¸­, è·å–æ•°æ®æºæ—¶ä»threadLocalä¸­æ‹¿åˆ°keyè¿›è€Œæ‹¿åˆ°æ•°æ®æº</p><p>è‡³æ­¤, å¤šæ•°æ®æºçš„åˆå§‹åŒ–å’Œä½¿ç”¨æ—¶åˆ‡æ¢å°±ç»“æŸäº†</p><h2 id=24-æ•°æ®æºçš„å¤„ç†å™¨>2.4 æ•°æ®æºçš„å¤„ç†å™¨<a hidden class=anchor aria-hidden=true href=#24-æ•°æ®æºçš„å¤„ç†å™¨>#</a></h2><p>åœ¨<code>com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey</code>å¤„, æœ‰è¯´è¿‡dså¤„ç†å™¨, å®ƒæ˜¯å¹²ä»€ä¹ˆçš„å‘¢?</p><p>æˆ‘ä»¬å¸¸ç”¨çš„æŒ‡å®šæ•°æ®æºçš„æ–¹å¼æ—¶æ˜¯ <code>@DS("master")</code> <code>@DS("salve_1")</code>, è¿™äº›éƒ½æ˜¯å›ºå®šå­—ç¬¦ä¸², å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®ç§Ÿæˆ·æ¥åˆ‡æ¢æ•°æ®æºå‘¢?æˆ–è€…å¼•å…¥ç°åº¦ç³»ç»ŸåæŒ‰Headerçš„å±æ€§æ¥åˆ‡æ¢å‘¢? å› æ­¤plusçš„æä¾›äº†å„ç§æ•°æ®æºçš„å¤„ç†å™¨</p><ol><li>DsHeaderProcessor : ä»headerä¸­è·å–</li><li>DsSessionProcessor: ä»sessionä¸­è·å–</li><li>DsSpelExpressionProcessor: è§£æSpelè¯­æ³•è·å–</li></ol><blockquote><p>å¸¸è§çš„@vaule()æ³¨è§£å°±æ”¯æŒspelè¯­æ³•, ä»é…ç½®æ–‡ä»¶ä¸­å–å€¼æˆ–è€…å†™é»˜è®¤å€¼éƒ½æ˜¯spelè¯­æ³•</p><p><a href=https://zhuanlan.zhihu.com/p/174786047# target=_blank rel=noopener>ç©è½¬Springä¸­å¼ºå¤§çš„spelè¡¨è¾¾å¼ï¼ - çŸ¥ä¹ (zhihu.com)</a></p></blockquote><p>ç»§ç»­ <code>com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey</code>, çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç </p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#ff7b72>private</span> String <span style=color:#d2a8ff;font-weight:700>determineDatasourceKey</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#ff7b72;font-weight:700>=</span> dataSourceClassResolver<span style=color:#ff7b72;font-weight:700>.</span>findDSKey<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>.</span>getMethod<span style=color:#ff7b72;font-weight:700>(),</span> invocation<span style=color:#ff7b72;font-weight:700>.</span>getThis<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// dsProcessor.determineDatasource() ä»å¤„ç†å™¨è·å–æ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>(!</span>key<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> key<span style=color:#ff7b72;font-weight:700>.</span>startsWith<span style=color:#ff7b72;font-weight:700>(</span>DYNAMIC_PREFIX<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>?</span> dsProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>:</span> key<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><code>dsProcessor</code> åå‘å®šä½è¿™ä¸ªå˜é‡, ä¼šè¿½è¸ªåˆ°<code>com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration#dsProcessor</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DsProcessor <span style=color:#d2a8ff;font-weight:700>dsProcessor</span><span style=color:#ff7b72;font-weight:700>(</span>BeanFactory beanFactory<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å…ˆheaderå¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DsHeaderProcessor headerProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsHeaderProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSessionProcessor sessionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSessionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSpelExpressionProcessor spelExpressionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSpelExpressionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        spelExpressionProcessor<span style=color:#ff7b72;font-weight:700>.</span>setBeanResolver<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>new</span> BeanFactoryResolver<span style=color:#ff7b72;font-weight:700>(</span>beanFactory<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å†sessionå¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        headerProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>sessionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æœ€åspelå¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        sessionProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>spelExpressionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> headerProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>å›åˆ°ä½¿ç”¨çš„åœ°æ–¹, è¿›å…¥æ–¹æ³•</p><p><code>com.baomidou.dynamic.datasource.processor.DsProcessor</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * å†³å®šæ•°æ®æº
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *     è°ƒç”¨åº•å±‚doDetermineDatasourceï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *     å¦‚æœè¿”å›çš„æ˜¯nullåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªï¼Œå¦åˆ™ç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;/pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param invocation æ–¹æ³•æ‰§è¡Œä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param key        DSæ³¨è§£é‡Œçš„å†…å®¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return æ•°æ®æºåç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> String <span style=color:#d2a8ff;font-weight:700>determineDatasource</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>,</span> String key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// keyçš„æ ¼å¼æ˜¯å¦åŒ¹é…
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>matches<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// è§£ææ•°æ®æºkey
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            String datasource <span style=color:#ff7b72;font-weight:700>=</span> doDetermineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>datasource <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> nextProcessor <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// ä¸‹ä¸€ä¸ªå¤„ç†å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>return</span> nextProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> datasource<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>nextProcessor <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> nextProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä»¥<code>DsHeaderProcessor</code> ä¸ºä¾‹:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DsHeaderProcessor</span> <span style=color:#ff7b72>extends</span> DsProcessor <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * header prefix
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String HEADER_PREFIX <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;#header&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>boolean</span> <span style=color:#d2a8ff;font-weight:700>matches</span><span style=color:#ff7b72;font-weight:700>(</span>String key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ˜¯å¦ ä»¥#header å¼€å¤´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> key<span style=color:#ff7b72;font-weight:700>.</span>startsWith<span style=color:#ff7b72;font-weight:700>(</span>HEADER_PREFIX<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> String <span style=color:#d2a8ff;font-weight:700>doDetermineDatasource</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>,</span> String key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        HttpServletRequest request <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>ServletRequestAttributes<span style=color:#ff7b72;font-weight:700>)</span> RequestContextHolder<span style=color:#ff7b72;font-weight:700>.</span>getRequestAttributes<span style=color:#ff7b72;font-weight:700>()).</span>getRequest<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä»è¯·æ±‚å¤´ä¸­ç›´æ¥è·å–(å¾ˆç²—æš´,ç«Ÿç„¶è¿åˆ†éš”ç¬¦éƒ½ä¸ç”¨), æ¯”å¦‚@DS(&#34;#headeruserId&#34;), è¿™æ ·å°±ä¼šä»headerä¸­å–å‡ºuserIdå­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> request<span style=color:#ff7b72;font-weight:700>.</span>getHeader<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>.</span>substring<span style=color:#ff7b72;font-weight:700>(</span>8<span style=color:#ff7b72;font-weight:700>));</span><span style=color:#8b949e;font-style:italic>// åˆšå¥½æŠŠ #header è¿™å‡ ä¸ªå­—ç¬¦æˆªæ–­
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>sessionå¤„ç†å™¨æ˜¯ä»¥<code>#session</code> å¼€å¤´</p><p>æŒ‰é¡ºåºå¤„ç†éƒ½ä¸æ˜¯å, å°±ä¼šæŒ‰<code>DsSpelExpressionProcessor</code> å¤„ç†</p><p>ä¸¾ä¸€äº›ä¾‹å­:</p><p><code>@DS("#headerUserId")</code> : å–headerä¸­çš„UserIdå­—æ®µä½œä¸ºæ•°æ®æºkey</p><p><code>@DS("#sessionTentendId")</code> : å–sessionä¸­çš„TentendIdå­—æ®µä½œä¸ºæ•°æ®æºkey</p><p><code>@DS("#person")</code>: æŠŠæ–¹æ³•ä¸Šçš„å˜é‡personçš„å€¼ä½œä¸ºæ•°æ®æºkey (SPELè¯­æ³•)</p><blockquote><p>å­¦ä¹ SPELè¯­æ³•å°±ä¼šå‘ç°å¾ˆå¤šå¥‡å¦™ç”¨æ³•, æ¯”å¦‚å¯ä¸è·å–æ–¹æ³•çš„å‚æ•°;æ–¹æ³•çš„è¿”å‚ç±»å‹; ç±»çš„åç§°ç­‰</p></blockquote><h1 id=3-qa>3. Q&amp;A<a hidden class=anchor aria-hidden=true href=#3-qa>#</a></h1><h2 id=31-transactional-å’Œ-ds-æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶-dså¤±æ•ˆçš„é—®é¢˜>3.1 @Transactional å’Œ @DS æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶, @DSå¤±æ•ˆçš„é—®é¢˜<a hidden class=anchor aria-hidden=true href=#31-transactional-å’Œ-ds-æ³¨è§£ä¸€èµ·ä½¿ç”¨æ—¶-dså¤±æ•ˆçš„é—®é¢˜>#</a></h2><p>è¿™æ˜¯å› ä¸º <code>@Transactional</code> <strong>å¼€å¯äº‹åŠ¡å, å°±ä¸ä¼šé‡æ–°æ‹¿æ•°æ®æº</strong>,å› ä¸º@DSä¹Ÿå¾—é€šè¿‡åˆ‡é¢å»è·å–æ•°æ®æº, è¿™æ ·å°±å¯¼è‡´äº†@DSå¤±æ•ˆ.</p><p>è¦è§£å†³çš„è¯, å°±åœ¨è¦åˆ‡æ¢æ•°æ®æºçš„æ–¹æ³•ä¸Šä¹Ÿæ‰“ä¸Š@DS, æˆ–è€…å¤šä¸ªæ•°æ®æºæœ‰ä¿®æ”¹æ“ä½œå¯ä»¥éƒ½æ‰“ä¸Šäº‹åŠ¡æ³¨è§£å¹¶æ”¹å˜ä¼ æ’­æœºåˆ¶,(ä½†è¿™å…¶å®æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„èŒƒç•´, è¿™æ ·æ“ä½œä¸èƒ½ä¿è¯äº‹åŠ¡äº†, plusä¹Ÿæä¾›äº†<code>@DSTransactional</code> æ¥æ”¯æŒ, ä¸å¤Ÿéœ€è¦å€ŸåŠ©<code>seata</code>)</p><p><a href=https://blog.csdn.net/weixin_40378837/article/details/106554198 target=_blank rel=noopener>@Transactionalè·Ÿ@DSåŠ¨æ€æ•°æ®æºæ³¨è§£å†²çª_æ—èœ—ç‰›snailçš„åšå®¢-CSDNåšå®¢</a></p><blockquote><p>å…³äº <code>@DSTransactional</code> ä»¥åå†è¡¥å……ä¸€ä¸‹</p></blockquote><h2 id=32--ä½äºv333ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜>3.2 ä½äºV3.3.3ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜<a hidden class=anchor aria-hidden=true href=#32--ä½äºv333ç‰ˆæœ¬æ— æ³•åˆ‡æ¢æ•°æ®æºçš„é—®é¢˜>#</a></h2><p>è¿™æ˜¯å› ä¸ºåœ¨V3.3.3ç‰ˆæœ¬ä¹‹å‰, <code>DruidDataSourceAutoConfigure</code>ä¼šæ¯”<code>DynamicDataSourceAutoConfiguration</code>å…ˆæ³¨å†Œ, å¯¼è‡´æ•°æ®åº“æœ‰è¯»å–<code>druid</code>çš„é…ç½®, æ‰€ä»¥ä¼šå‡ºç° ,æ²¡æœ‰druidé…ç½®å¯åŠ¨æŠ¥é”™; æ•°æ®æºæ— æ³•åˆ‡æ¢ç­‰ç­‰åŸå› , å®˜æ–¹åœ¨V3.3.3è¿™ä¸ªç‰ˆæœ¬ä¿®å¤äº†, ä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬æœ‰ä¸ªå…¶ä»–çš„é‡ç‚¹bug,å®˜æ–¹ä¸è®©ä¸‹è½½, æ‰€ä»¥githubä¸Šæ‰¾ä¸åˆ°è¿™ä¸ªç‰ˆæœ¬çš„æè¿°, åªåœ¨å®˜ç½‘æœ‰æè¿°</p><blockquote><p>åˆ†ä¸¤æ­¥è§£å†³çš„,</p><ol><li>å»é™¤ druid pomåæ ‡</li><li>åœ¨ <code>DynamicDataSourceAutoConfiguration</code> ä¸ŠæŒ‡å®šä¼˜äº <code>DruidDataSourceAutoConfigure</code>åŠ è½½</li></ol></blockquote><p>è§£å†³åŠæ³•å°±æ˜¯æ’é™¤<code>DruidDataSourceAutoConfigure</code> ç±»;</p><p><a href=https://blog.csdn.net/w57685321/article/details/106823660 target=_blank rel=noopener>ä½¿ç”¨dynamic-datasource-spring-boot-starteråšå¤šæ•°æ®æºåŠæºç åˆ†æ_0x2015çš„åšå®¢-CSDNåšå®¢</a></p><p><a href=https://juejin.cn/post/7022650688425426974 target=_blank rel=noopener>Mybatis-Pluså¤šæ•°æ®æºè§£æ - æ˜é‡‘ (juejin.cn)</a></p><p><a href=https://www.kancloud.cn/tracy5546/dynamic-datasource/content/%E7%89%88%E6%9C%AC%E8%AE%B0%E5%BD%95.md target=_blank rel=noopener>å¤šæ•°æ®æºå®˜ç½‘-ç‰ˆæœ¬è®°å½•</a></p><p><a href=https://blog.csdn.net/weixin_43846916/article/details/110824726 target=_blank rel=noopener>Mybatis plusçš„å¤šæ•°æ®æº@DSåˆ‡æ¢ä¸ºä»€ä¹ˆä¸èµ·ä½œç”¨äº†ï¼Œè°çš„é”…ï¼Œ@Transactional</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/MyBatis-Plus.html>MyBatis-Plus</a></li><li><a href=https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>javaåŠå…¶æ¡†æ¶</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6MVCC.html><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)</span></a>
<a class=next href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E6%9D%82%E9%A1%B9/%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F.html><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>å¤šç§Ÿæˆ·æ¨¡å¼</span></a></nav></footer></article></main><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>