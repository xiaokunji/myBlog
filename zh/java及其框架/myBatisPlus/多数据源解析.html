<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>多数据源解析 | 米二</title><meta name=keywords content=" 1. 使用, 1.1. 引包, 1.2 增加配置, 1.3 使用@DS注解, 2. 源码, 2.1 Configuration文件,加载配置与bean注入, 2.1.1  配置类, 2.2 注册DataSource, 2.2.1  获取所有的DataSource, 2.2.1.1 构建DataSource, 2.2.2 对数据源分组, 2.3 切换数据源, 2.3.1 DynamicDataSourceContextHolder, 2.3.2 DynamicDataSourceAnnotationInterceptor, 2.3.4  DynamicDataSourceAnnotationAdvisor, 2.4 数据源的处理器, 3. Q&amp;A, 3.1 @Transactional 和 @DS 注解一起使用时,@DS失效的问题, 3.2  低于V3.3.3版本无法切换数据源的问题"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="多数据源解析"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html"><meta property="article:section" content="java及其框架"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-08T09:03:16+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="多数据源解析"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"多数据源解析","item":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"多数据源解析","name":"多数据源解析","description":"     ","keywords":[" 1. 使用"," 1.1. 引包"," 1.2 增加配置"," 1.3 使用@DS注解"," 2. 源码"," 2.1 Configuration文件, 加载配置与bean注入"," 2.1.1  配置类"," 2.2 注册DataSource"," 2.2.1  获取所有的DataSource"," 2.2.1.1 构建DataSource"," 2.2.2 对数据源分组"," 2.3 切换数据源"," 2.3.1 DynamicDataSourceContextHolder"," 2.3.2 DynamicDataSourceAnnotationInterceptor"," 2.3.4  DynamicDataSourceAnnotationAdvisor"," 2.4 数据源的处理器"," 3. Q\u0026A"," 3.1 @Transactional 和 @DS 注解一起使用时, @DS失效的问题"," 3.2  低于V3.3.3版本无法切换数据源的问题"],"articleBody":"[toc]\n1. 使用 1.1. 引包 com.baomidou dynamic-datasource-spring-boot-starter 3.3.6 用最新版的就好 Maven Repository: dynamic-datasource-spring-boot-starter 不过做开发的经验来看, 应该选 倒数第二个大版本里最新的版本, 这样既能用更多的功能,又能保证没有大bug, 除非最新版本有你需要的功能\n1.2 增加配置 spring: datasource: dynamic: primary: master #设置默认的数据源或者数据源组,默认值即为master, 所以此处不写也可以 strict: false #设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候回抛出异常,不启动会使用默认数据源. datasource: master: # 第一个数据源的名称 url: jdbc:mysql://127.0.0.1:3306/dynamic username: root password: 123456 driver-class-name: com.mysql.jdbc.Driver db_1: # 第二个数据源的名称 url: jdbc:gbase://127.0.0.1:5258/dynamic username: root password: 123456 driver-class-name: com.mysql.jdbc.Driver 如果是多主多从或者一主多从，那么就用分组的功能实现, 即: 数据组名称_xxx，下划线前面的就是数据组名称，后面就是数据源名, 相同组名称的数据源会放在一个组下。切换数据源时，可以指定具体数据源名称，也可以指定组名然后会自动采用负载均衡算法切换,\n例如: 上面配置中的\"db_1\", 表示db分组, 1 名称的数据源, 如果再增加一个\"db_2\", 则表示这两个数据源是同一个分组, 当在@DS中只指定\"db\", 则会在这个分组中采用负载均衡方式选数据源(默认是轮询)\n1.3 使用@DS注解 @DS注解, 是用来表示使用哪个数据源的, 也是切换数据源功能的核心注解, 它可以用来类和方法上, 方法上的优先级更高, 例如 service层, Mapper层,都可以, 如果没有配置,则会使用默认数据源\n@Service @DS(\"master\") // 在类上加 public class UserServiceImpl implements UserService { @Autowired private JdbcTemplate jdbcTemplate; public List\u003cMap\u003cString, Object\u003e\u003e selectAll() { return jdbcTemplate.queryForList(\"select * from user\"); } @Override @DS(\"db_1\") // 在方法上加 public List\u003cMap\u003cString, Object\u003e\u003e selectByCondition() { return jdbcTemplate.queryForList(\"select * from user where age \u003e10\"); } } 官方建议不建议@DS放在Mapper上, 所以网上有很多例子是放在service上,\n但是这有个问题, 当在service中需要访问两个数据库时, 就会无法切换数据源, 毕竟@DS是加在service上, 在同一个service上操作, 自然不会切换, 官方也给出解决方案, 在方法上进一步指定数据源, (伪代码)例如:\nclass Person { @Autowired dbService1 db_1; @Autowired dbService2 db_2; void test(){ db_1.save(); // 如果 db_2.save() 不指定数据源, 数据源会使用db_1 db_2.save(); } } @DS(\"db_1\") class dbService1 { void save(){ } } @DS(\"db_2\") class dbService2 { @DS(\"db_2\") void save(){ } } mybatis-plus中多数据源切换@DS注解到底放在哪一层合适？ @DS不建议加在mapper上的原因是? 2. 源码 一般starter自动配置，都是从 META-INF/spring.factories文件中指定自动配置类：\norg.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration 所以打开 DynamicDataSourceAutoConfiguration 文件\n2.1 Configuration文件, 加载配置与bean注入 // 动态数据源核心自动配置类 @Slf4j @Configuration @EnableConfigurationProperties(DynamicDataSourceProperties.class) // @AutoConfigureBefore 注解的意思是 在DataSourceAutoConfiguration和DruidDataSourceAutoConfigure之前就注册当前bean // 这里特别注意一下, 在 V3.3.3 之前, 没有把DruidDataSourceAutoConfigure加进来, 所以导致项目中有druid时,数据源无法切换或没有druid配置则报错 @AutoConfigureBefore(value = DataSourceAutoConfiguration.class, name = \"com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure\") //引入了Druid的autoConfig和各种数据源连接池的Creator @Import(value = {DynamicDataSourceCreatorAutoConfiguration.class, DynamicDataSourceAopConfiguration.class, DynamicDataSourceAssistConfiguration.class}) @ConditionalOnProperty(prefix = DynamicDataSourceProperties.PREFIX, name = \"enabled\", havingValue = \"true\", matchIfMissing = true) public class DynamicDataSourceAutoConfiguration { private final DynamicDataSourceProperties properties; //读取多数据源配置，注入到spring容器中 @Bean @ConditionalOnMissingBean public DynamicDataSourceProvider dynamicDataSourceProvider() { Map\u003cString, DataSourceProperty\u003e datasourceMap = properties.getDatasource(); return new YmlDynamicDataSourceProvider(datasourceMap); } //注册自己的动态多数据源DataSource @Bean @ConditionalOnMissingBean public DataSource dataSource(DynamicDataSourceProvider dynamicDataSourceProvider) { DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource(); dataSource.setPrimary(properties.getPrimary()); dataSource.setStrict(properties.getStrict()); dataSource.setStrategy(properties.getStrategy()); dataSource.setProvider(dynamicDataSourceProvider); dataSource.setP6spy(properties.getP6spy()); dataSource.setSeata(properties.getSeata()); return dataSource; } //AOP切面，对DS注解过的方法进行增强，达到切换数据源的目的 @Role(value = BeanDefinition.ROLE_INFRASTRUCTURE) @Bean @ConditionalOnMissingBean public DynamicDataSourceAnnotationAdvisor dynamicDatasourceAnnotationAdvisor(DsProcessor dsProcessor) { DynamicDataSourceAnnotationInterceptor interceptor = new DynamicDataSourceAnnotationInterceptor(properties.isAllowedPublicOnly(), dsProcessor); DynamicDataSourceAnnotationAdvisor advisor = new DynamicDataSourceAnnotationAdvisor(interceptor); advisor.setOrder(properties.getOrder()); return advisor; } //关于分布式事务加强 @Role(value = BeanDefinition.ROLE_INFRASTRUCTURE) @ConditionalOnProperty(prefix = DynamicDataSourceProperties.PREFIX, name = \"seata\", havingValue = \"false\", matchIfMissing = true) @Bean public Advisor dynamicTransactionAdvisor() { AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); pointcut.setExpression(\"@annotation(com.baomidou.dynamic.datasource.annotation.DSTransactional)\"); return new DefaultPointcutAdvisor(pointcut, new DynamicTransactionAdvisor()); } //动态参数解析器链 @Bean @ConditionalOnMissingBean public DsProcessor dsProcessor() { DsHeaderProcessor headerProcessor = new DsHeaderProcessor(); DsSessionProcessor sessionProcessor = new DsSessionProcessor(); DsSpelExpressionProcessor spelExpressionProcessor = new DsSpelExpressionProcessor(); headerProcessor.setNextProcessor(sessionProcessor); sessionProcessor.setNextProcessor(spelExpressionProcessor); return headerProcessor; } } 我们可以发现，在使用的时候配置的前缀为spring.datasource.dynamic的配置都会被读取到DynamicDataSourceProperties类，作为一个Bean注入到Spring容器。其实这种读取配置文件信息的方式在日常开发中也是很常见的。\n2.1.1 配置类 DynamicDataSourceProperties\n@ConfigurationProperties(prefix = DynamicDataSourceProperties.PREFIX) public class DynamicDataSourceProperties { public static final String PREFIX = \"spring.datasource.dynamic\"; public static final String HEALTH = PREFIX + \".health\"; /** * 必须设置默认的库,默认master */ private String primary = \"master\"; /** * 是否启用严格模式,默认不启动. 严格模式下未匹配到数据源直接报错, 非严格模式下则使用默认数据源primary所设置的数据源 */ private Boolean strict = false; // ....... } 2.2 注册DataSource 在 DynamicDataSourceAutoConfiguration 类中, 还加载了DataSource, 我们知道 DataSource是spring用来链接数据库的,\n它注册了一个实现类 DynamicRoutingDataSource, 这个类还有一个父类AbstractRoutingDataSource, 我们先看AbstractRoutingDataSource\n/** * 抽象动态获取数据源 * * @author TaoYu * @since 2.2.0 */ public abstract class AbstractRoutingDataSource extends AbstractDataSource { //抽象方法，由子类实现，让子类决定最终使用的数据源 protected abstract DataSource determineDataSource(); //重写getConnection()方法，实现切换数据源的功能 @Override public Connection getConnection() throws SQLException { //这里xid涉及分布式事务的处理 String xid = TransactionContext.getXID(); if (StringUtils.isEmpty(xid)) { //不使用分布式事务，就是直接返回一个数据连接(实现类: ItemDataSource.class) return determineDataSource().getConnection(); } else { String ds = DynamicDataSourceContextHolder.peek(); ConnectionProxy connection = ConnectionFactory.getConnection(ds); return connection == null ? getConnectionProxy(ds, determineDataSource().getConnection()) : connection; } } } 父类很简单, 只是区分了分布式事务的取connect的方式,所以再来看下其子类DynamicRoutingDataSource 的内容\n@Slf4j public class DynamicRoutingDataSource extends AbstractRoutingDataSource implements InitializingBean, DisposableBean { private static final String UNDERLINE = \"_\"; /** * 所有数据库 */ private final Map\u003cString, DataSource\u003e dataSourceMap = new ConcurrentHashMap\u003c\u003e(); /** * 分组数据库 */ private final Map\u003cString, GroupDataSource\u003e groupDataSources = new ConcurrentHashMap\u003c\u003e(); @Setter private DynamicDataSourceProvider provider; @Setter private Class\u003c? extends DynamicDataSourceStrategy\u003e strategy = LoadBalanceDynamicDataSourceStrategy.class; @Setter private String primary = \"master\"; @Setter private Boolean strict = false; @Setter private Boolean p6spy = false; @Setter private Boolean seata = false; @Override public DataSource determineDataSource() { // 获得数据源 return getDataSource(DynamicDataSourceContextHolder.peek()); } private DataSource determinePrimaryDataSource() { log.debug(\"dynamic-datasource switch to the primary datasource\"); return groupDataSources.containsKey(primary) ? groupDataSources.get(primary).determineDataSource() : dataSourceMap.get(primary); } // bean的属性加载完后, 执行该方法 @Override public void afterPropertiesSet() throws Exception { // 检查开启了配置但没有相关依赖 checkEnv(); // 拿到所有的数据源, Key是数据源的名称，Value则是DataSource。 Map\u003cString, DataSource\u003e dataSources = provider.loadDataSources(); // 添加并分组数据源 for (Map.Entry\u003cString, DataSource\u003e dsItem : dataSources.entrySet()) { addDataSource(dsItem.getKey(), dsItem.getValue()); } // 检测默认数据源是否设置 if (groupDataSources.containsKey(primary)) { log.info(\"dynamic-datasource initial loaded [{}] datasource,primary group datasource named [{}]\", dataSources.size(), primary); } else if (dataSourceMap.containsKey(primary)) { log.info(\"dynamic-datasource initial loaded [{}] datasource,primary datasource named [{}]\", dataSources.size(), primary); } else { throw new RuntimeException(\"dynamic-datasource Please check the setting of primary\"); } } /** * 获取数据源 * * @param ds 数据源名称 * @return 数据源 */ public DataSource getDataSource(String ds) { if (StringUtils.isEmpty(ds)) { // 没有ds注解, 则默认用 Primary return determinePrimaryDataSource(); } else if (!groupDataSources.isEmpty() \u0026\u0026 groupDataSources.containsKey(ds)) { // 如果有组, 则用负载均衡的方式取一个 log.debug(\"dynamic-datasource switch to the datasource named [{}]\", ds); return groupDataSources.get(ds).determineDataSource(); } else if (dataSourceMap.containsKey(ds)) { // 没有组, 则直接取 log.debug(\"dynamic-datasource switch to the datasource named [{}]\", ds); return dataSourceMap.get(ds); } // 严格模式下直接报错 if (strict) { throw new CannotFindDataSourceException(\"dynamic-datasource could not find a datasource named\" + ds); } return determinePrimaryDataSource(); } // ..... } 它实现了InitializingBean接口，这个接口需要实现afterPropertiesSet()方法，这是一个Bean的生命周期函数，在Bean初始化的时候做一些操作\n2.2.1 获取所有的DataSource 先看一下它是怎么获得数据源的? provider.loadDataSources() 是抽象方法, 有两个实现\nYmlDynamicDataSourceProvider和AbstractJdbcDataSourceProvider, 在DynamicDataSourceAutoConfiguration 类中, 注入的是YmlDynamicDataSourceProvider, 所以直接看它的实现 , 最后会跳转到AbstractDataSourceProvider\n@Slf4j public abstract class AbstractDataSourceProvider implements DynamicDataSourceProvider { @Autowired private DefaultDataSourceCreator defaultDataSourceCreator; protected Map\u003cString, DataSource\u003e createDataSourceMap( Map\u003cString, DataSourceProperty\u003e dataSourcePropertiesMap) { Map\u003cString, DataSource\u003e dataSourceMap = new HashMap\u003c\u003e(dataSourcePropertiesMap.size() * 2); for (Map.Entry\u003cString, DataSourceProperty\u003e item : dataSourcePropertiesMap.entrySet()) { DataSourceProperty dataSourceProperty = item.getValue(); String poolName = dataSourceProperty.getPoolName(); if (poolName == null || \"\".equals(poolName)) { poolName = item.getKey(); } dataSourceProperty.setPoolName(poolName); // 这里的defaultDataSourceCreator.createDataSource()方法使用到适配器模式。因为每种配置数据源创建的DataSource实现类都不一定相同的，所以需要根据配置的数据源类型进行具体的DataSource创建。 dataSourceMap.put(poolName, defaultDataSourceCreator.createDataSource(dataSourceProperty)); } return dataSourceMap; } } 2.2.1.1 构建DataSource 来看一下defaultDataSourceCreator.createDataSource()的逻辑\npublic DataSource createDataSource(DataSourceProperty dataSourceProperty) { DataSourceCreator dataSourceCreator = null; //this.creators是所有适配的DataSourceCreator实现类 for (DataSourceCreator creator : this.creators) { //根据配置匹配对应的dataSourceCreator if (creator.support(dataSourceProperty)) { //如果匹配，则使用对应的dataSourceCreator dataSourceCreator = creator; break; } } if (dataSourceCreator == null) { throw new IllegalStateException(\"creator must not be null,please check the DataSourceCreator\"); } String publicKey = dataSourceProperty.getPublicKey(); if (StringUtils.isEmpty(publicKey)) { dataSourceProperty.setPublicKey(properties.getPublicKey()); } Boolean lazy = dataSourceProperty.getLazy(); if (lazy == null) { dataSourceProperty.setLazy(properties.getLazy()); } //然后再调用createDataSource方法进行创建对应DataSource DataSource dataSource = dataSourceCreator.createDataSource(dataSourceProperty); // (如果有则运行, 可以自定义)运行 建表语句和数据脚本 this.runScrip(dataSource, dataSourceProperty); return wrapDataSource(dataSource, dataSourceProperty); } 创建DataSource的有很多实现类, 每种数据源都有自己的实现\n对应的全部实现类是放在creator包下：\n创建dataSource就很简单了, 就是把账号/密码/url等参数设置进去\n2.2.2 对数据源分组 再回到之前的，当拿到DataSource的Map集合之后，再做什么呢？\n接着调addDataSource()方法，这个方法是根据下划线\"_“对数据源进行分组，最后放到groupDataSources成员变量里面。 com.baomidou.dynamic.datasource.DynamicRoutingDataSource#addDataSource\nprivate static final String UNDERLINE = \"_\"; // 轮询策略 private Class\u003c? extends DynamicDataSourceStrategy\u003e strategy = LoadBalanceDynamicDataSourceStrategy.class; /** * 新数据源添加到分组 * * @param ds 新数据源的名字 * @param dataSource 新数据源 */ private void addGroupDataSource(String ds, DataSource dataSource) { if (ds.contains(UNDERLINE)) { String group = ds.split(UNDERLINE)[0]; GroupDataSource groupDataSource = groupDataSources.get(group); if (groupDataSource == null) { try { //顺便设置负载均衡策略，strategy默认是LoadBalanceDynamicDataSourceStrategy groupDataSource = new GroupDataSource(group, strategy.getDeclaredConstructor().newInstance()); groupDataSources.put(group, groupDataSource); } catch (Exception e) { throw new RuntimeException(\"dynamic-datasource - add the datasource named \" + ds + \" error\", e); } } groupDataSource.addDatasource(ds, dataSource); } } 至此, 项目启动时, 多数据做的事就完了, 那我们执行sql时, 它是怎么切换的呢?\n2.3 切换数据源 在前面的DynamicRoutingDataSource我们知道, 这是mybatisPlus写的获取数据源的类 , 它最终是通过com.baomidou.dynamic.datasource.DynamicRoutingDataSource#determineDataSource获得数据源的, 在 2.2.1 也有描述.\n@Override public DataSource determineDataSource() { // 从threadLocal中获取当前数据源key (就是@DS注解里的字符串) String dsKey = DynamicDataSourceContextHolder.peek(); // 根据key获取数据源 return getDataSource(dsKey); } 那么上面的DynamicDataSourceContextHolder这个类是干嘛的呢？注解@DS的值又是怎么传进来的呢？\n我们先看看这个类\n2.3.1 DynamicDataSourceContextHolder /** * 核心基于ThreadLocal的切换数据源工具类 */ public final class DynamicDataSourceContextHolder { /** * 为什么要用链表存储(准确的是栈) * * 为了支持嵌套切换，如ABC三个service都是不同的数据源 * 其中A的某个业务要调B的方法，B的方法需要调用C的方法。一级一级调用切换，形成了链。 * 传统的只设置当前线程的方式不能满足此业务需求，必须使用栈，后进先出。 * */ private static final ThreadLocal\u003cDeque\u003cString\u003e\u003e LOOKUP_KEY_HOLDER = new NamedThreadLocal\u003cDeque\u003cString\u003e\u003e(\"dynamic-datasource\") { @Override protected Deque\u003cString\u003e initialValue() { return new ArrayDeque\u003c\u003e(); } }; /** * 获得当前线程数据源 * * @return 数据源名称 */ public static String peek() { return LOOKUP_KEY_HOLDER.get().peek(); } /** * 设置当前线程数据源 * * 如非必要不要手动调用，调用后确保最终清除 * * * @param ds 数据源名称 */ public static String push(String ds) { String dataSourceStr = StringUtils.isEmpty(ds) ? \"\" : ds; LOOKUP_KEY_HOLDER.get().push(dataSourceStr); return dataSourceStr; } // .... } 这里用的是NamedThreadLocal, 比ThreadLocal多了一个名字字段而已, 大家知道ThreadLocal 的特性: 线程隔离/内存泄露风险, 所以 当开多线程会让多数据源切换失败(看你@DS注解打在哪和具体使用); 网上说用到 DynamicDataSourceContextHolder类时, 都是push()和clean()/poll()一起使用.其实就是避免内存泄露\n既然有peek(), 那肯定有push(), 我们来反推一下, 看一下哪些地方在调用push(), 可以发现有两个地方, 分别是\nDynamicDataSourceAnnotationInterceptor 和 MasterSlaveAutoRoutingPlugin,\nMasterSlaveAutoRoutingPlugin是做主从数据库切换的, 我们自然看 DynamicDataSourceAnnotationInterceptor\n2.3.2 DynamicDataSourceAnnotationInterceptor public class DynamicDataSourceAnnotationInterceptor implements MethodInterceptor { /** * The identification of SPEL. */ private static final String DYNAMIC_PREFIX = \"#\"; private final DataSourceClassResolver dataSourceClassResolver; private final DsProcessor dsProcessor; public DynamicDataSourceAnnotationInterceptor(Boolean allowedPublicOnly, DsProcessor dsProcessor) { dataSourceClassResolver = new DataSourceClassResolver(allowedPublicOnly); this.dsProcessor = dsProcessor; } @Override public Object invoke(MethodInvocation invocation) throws Throwable { //找到@DS注解的属性值，也就是数据源名称 String dsKey = determineDatasourceKey(invocation); //把数据源名称push到当前线程的栈 DynamicDataSourceContextHolder.push(dsKey); try { //执行当前方法 return invocation.proceed(); } finally { //从栈里释放数据源 DynamicDataSourceContextHolder.poll(); } } private String determineDatasourceKey(MethodInvocation invocation) { // 从方法上和类上 获取key String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis()); // 如果数据源是以 # 开头, 则进入ds处理器, 这里用的是责任链模式 return (!key.isEmpty() \u0026\u0026 key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key; } } 它是invoke方法, 一看就是反射标准写法, 看一下它的父类, MethodInterceptor, 它可以对AOP的切面进行增强,\n简单来说, 如果被切到后, 就会调用这个invoke方法\nSpring动态代理之MethodInterceptor拦截器详解 - 简书 (jianshu.com) 我们继续看切面是如何使用的, 而ds处理器等会讲\n2.3.4 DynamicDataSourceAnnotationAdvisor 直接看 DynamicDataSourceAnnotationInterceptor 在哪里用到了, 会发现回到了DynamicDataSourceAutoConfiguration类\n@Role(value = BeanDefinition.ROLE_INFRASTRUCTURE) @Bean public Advisor dynamicDatasourceAnnotationAdvisor(DsProcessor dsProcessor) { // 创建拦截器 DynamicDataSourceAnnotationInterceptor interceptor = new DynamicDataSourceAnnotationInterceptor(properties.isAllowedPublicOnly(), dsProcessor); // 把拦截器放到Advisor上 DynamicDataSourceAnnotationAdvisor advisor = new DynamicDataSourceAnnotationAdvisor(interceptor); advisor.setOrder(properties.getOrder()); return advisor; } Advisor是Spring AOP的顶层抽象，用来管理Advice和Pointcut\n@Transactional 也是用这种方式做的\n从 AbstractPointcutAdvisor 开始： Spring AOP 之 Advisor、PointcutAdvisor 介绍 DynamicDataSourceAnnotationAdvisor是用于AOP切面编程的，针对注解@DS的切面进行处理：\npublic class DynamicDataSourceAnnotationAdvisor extends AbstractPointcutAdvisor implements BeanFactoryAware { private final Advice advice; private final Pointcut pointcut; // 初始化时调用了构造方法 public DynamicDataSourceAnnotationAdvisor(@NonNull DynamicDataSourceAnnotationInterceptor dynamicDataSourceAnnotationInterceptor) { this.advice = dynamicDataSourceAnnotationInterceptor; this.pointcut = buildPointcut(); } @Override public Pointcut getPointcut() { return this.pointcut; } @Override public Advice getAdvice() { return this.advice; } private Pointcut buildPointcut() { Pointcut cpc = new AnnotationMatchingPointcut(DS.class, true); Pointcut mpc = new AnnotationMethodPoint(DS.class); //方法优于类 return new ComposablePointcut(cpc).union(mpc); } // ..... } 所以总的来说, 当执行的方法或者类被 @DS切到时, 就会执行增强方法, 把数据源key放到threadLocal中, 获取数据源时从threadLocal中拿到key进而拿到数据源\n至此, 多数据源的初始化和使用时切换就结束了\n2.4 数据源的处理器 在com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey处, 有说过ds处理器, 它是干什么的呢?\n我们常用的指定数据源的方式时是 @DS(\"master\") @DS(\"salve_1\"), 这些都是固定字符串, 如果我们需要根据租户来切换数据源呢?或者引入灰度系统后按Header的属性来切换呢? 因此plus的提供了各种数据源的处理器\nDsHeaderProcessor : 从header中获取 DsSessionProcessor: 从session中获取 DsSpelExpressionProcessor: 解析Spel语法获取 常见的@vaule()注解就支持spel语法, 从配置文件中取值或者写默认值都是spel语法\n玩转Spring中强大的spel表达式！ - 知乎 (zhihu.com) 继续 com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey, 看一下它的代码\nprivate String determineDatasourceKey(MethodInvocation invocation) { String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis()); // dsProcessor.determineDatasource() 从处理器获取数据源 return (!key.isEmpty() \u0026\u0026 key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key; } dsProcessor 反向定位这个变量, 会追踪到com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration#dsProcessor\n@Bean @ConditionalOnMissingBean public DsProcessor dsProcessor(BeanFactory beanFactory) { // 先header处理器 DsHeaderProcessor headerProcessor = new DsHeaderProcessor(); DsSessionProcessor sessionProcessor = new DsSessionProcessor(); DsSpelExpressionProcessor spelExpressionProcessor = new DsSpelExpressionProcessor(); spelExpressionProcessor.setBeanResolver(new BeanFactoryResolver(beanFactory)); // 再session处理器 headerProcessor.setNextProcessor(sessionProcessor); // 最后spel处理器 sessionProcessor.setNextProcessor(spelExpressionProcessor); return headerProcessor; } 回到使用的地方, 进入方法\ncom.baomidou.dynamic.datasource.processor.DsProcessor\n/** * 决定数据源 * * 调用底层doDetermineDatasource， * 如果返回的是null则继续执行下一个，否则直接返回 * * * @param invocation 方法执行信息 * @param key DS注解里的内容 * @return 数据源名称 */ public String determineDatasource(MethodInvocation invocation, String key) { // key的格式是否匹配 if (matches(key)) { // 解析数据源key String datasource = doDetermineDatasource(invocation, key); if (datasource == null \u0026\u0026 nextProcessor != null) { // 下一个处理器 return nextProcessor.determineDatasource(invocation, key); } return datasource; } if (nextProcessor != null) { return nextProcessor.determineDatasource(invocation, key); } return null; } 我们以DsHeaderProcessor 为例:\npublic class DsHeaderProcessor extends DsProcessor { /** * header prefix */ private static final String HEADER_PREFIX = \"#header\"; @Override public boolean matches(String key) { // 是否 以#header 开头 return key.startsWith(HEADER_PREFIX); } @Override public String doDetermineDatasource(MethodInvocation invocation, String key) { HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); // 从请求头中直接获取(很粗暴,竟然连分隔符都不用), 比如@DS(\"#headeruserId\"), 这样就会从header中取出userId字段 return request.getHeader(key.substring(8));// 刚好把 #header 这几个字符截断 } } session处理器是以#session 开头\n按顺序处理都不是后, 就会按DsSpelExpressionProcessor 处理\n举一些例子:\n@DS(\"#headerUserId\") : 取header中的UserId字段作为数据源key\n@DS(\"#sessionTentendId\") : 取session中的TentendId字段作为数据源key\n@DS(\"#person\"): 把方法上的变量person的值作为数据源key (SPEL语法)\n学习SPEL语法就会发现很多奇妙用法, 比如可与获取方法的参数;方法的返参类型; 类的名称等\n3. Q\u0026A 3.1 @Transactional 和 @DS 注解一起使用时, @DS失效的问题 这是因为 @Transactional 开启事务后, 就不会重新拿数据源,因为@DS也得通过切面去获取数据源, 这样就导致了@DS失效.\n要解决的话, 就在要切换数据源的方法上也打上@DS, 或者多个数据源有修改操作可以都打上事务注解并改变传播机制,(但这其实是分布式事务的范畴, 这样操作不能保证事务了, plus也提供了@DSTransactional 来支持, 不够需要借助seata)\n@Transactional跟@DS动态数据源注解冲突_林蜗牛snail的博客-CSDN博客 关于 @DSTransactional 以后再补充一下\n3.2 低于V3.3.3版本无法切换数据源的问题 这是因为在V3.3.3版本之前, DruidDataSourceAutoConfigure会比DynamicDataSourceAutoConfiguration先注册, 导致数据库有读取druid的配置, 所以会出现 ,没有druid配置启动报错; 数据源无法切换等等原因, 官方在V3.3.3这个版本修复了, 但是这个版本有个其他的重点bug,官方不让下载, 所以github上找不到这个版本的描述, 只在官网有描述\n分两步解决的,\n去除 druid pom坐标 在 DynamicDataSourceAutoConfiguration 上指定优于 DruidDataSourceAutoConfigure加载 解决办法就是排除DruidDataSourceAutoConfigure 类;\n使用dynamic-datasource-spring-boot-starter做多数据源及源码分析_0x2015的博客-CSDN博客 Mybatis-Plus多数据源解析 - 掘金 (juejin.cn) 多数据源官网-版本记录 Mybatis plus的多数据源@DS切换为什么不起作用了，谁的锅，@Transactional ","wordCount":"7104","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-08T09:03:16.254783239Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E8%A7%A3%E6%9E%90.html"},"publisher":{"@type":"Organization","name":"米二","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="米二 (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>米二</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://xiaokunji.com/zh/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=📚文章><span>📚文章</span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=🔖标签><span>🔖标签</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=📖分类><span>📖分类</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>🏠</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>java及其框架</a> <span>></span>
<a href=https://xiaokunji.com/zh/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6/myBatisPlus.html>myBatis-Plus</a> <span>></span></ul></nav><h1 class=post-title>多数据源解析</h1><div class=post-description></div><div class=post-meta>创建:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;·&nbsp;更新:&nbsp;2023-09-08&nbsp;·&nbsp;xkj
&nbsp;|&nbsp;分类: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>java及其框架</a></ul><span id=busuanzi_container_page_pv>&nbsp;| 访问: <span id=busuanzi_value_page_pv>1</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#1-%e4%bd%bf%e7%94%a8 aria-label="1. 使用">1. 使用</a><ul><li><a href=#11-%e5%bc%95%e5%8c%85 aria-label="1.1. 引包">1.1. 引包</a></li><li><a href=#12-%e5%a2%9e%e5%8a%a0%e9%85%8d%e7%bd%ae aria-label="1.2 增加配置">1.2 增加配置</a></li><li><a href=#13-%e4%bd%bf%e7%94%a8ds%e6%b3%a8%e8%a7%a3 aria-label="1.3 使用@DS注解">1.3 使用@DS注解</a></li></ul></li><li><a href=#2-%e6%ba%90%e7%a0%81 aria-label="2. 源码">2. 源码</a><ul><li><a href=#21-configuration%e6%96%87%e4%bb%b6-%e5%8a%a0%e8%bd%bd%e9%85%8d%e7%bd%ae%e4%b8%8ebean%e6%b3%a8%e5%85%a5 aria-label="2.1 Configuration文件, 加载配置与bean注入">2.1 Configuration文件, 加载配置与bean注入</a><ul><li><a href=#211--%e9%85%8d%e7%bd%ae%e7%b1%bb aria-label="2.1.1  配置类">2.1.1 配置类</a></li></ul></li><li><a href=#22-%e6%b3%a8%e5%86%8cdatasource aria-label="2.2 注册DataSource">2.2 注册DataSource</a><ul><li><a href=#221--%e8%8e%b7%e5%8f%96%e6%89%80%e6%9c%89%e7%9a%84datasource aria-label="2.2.1  获取所有的DataSource">2.2.1 获取所有的DataSource</a><ul><li><a href=#2211-%e6%9e%84%e5%bb%badatasource aria-label="2.2.1.1 构建DataSource">2.2.1.1 构建DataSource</a></li></ul></li><li><a href=#222-%e5%af%b9%e6%95%b0%e6%8d%ae%e6%ba%90%e5%88%86%e7%bb%84 aria-label="2.2.2 对数据源分组">2.2.2 对数据源分组</a></li></ul></li><li><a href=#23-%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90 aria-label="2.3 切换数据源">2.3 切换数据源</a><ul><li><a href=#231-dynamicdatasourcecontextholder aria-label="2.3.1 DynamicDataSourceContextHolder">2.3.1 DynamicDataSourceContextHolder</a></li><li><a href=#232-dynamicdatasourceannotationinterceptor aria-label="2.3.2 DynamicDataSourceAnnotationInterceptor">2.3.2 DynamicDataSourceAnnotationInterceptor</a></li><li><a href=#234--dynamicdatasourceannotationadvisor aria-label="2.3.4  DynamicDataSourceAnnotationAdvisor">2.3.4 DynamicDataSourceAnnotationAdvisor</a></li></ul></li><li><a href=#24-%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8 aria-label="2.4 数据源的处理器">2.4 数据源的处理器</a></li></ul></li><li><a href=#3-qa aria-label="3. Q&amp;amp;A">3. Q&amp;A</a><ul><li><a href=#31-transactional-%e5%92%8c-ds-%e6%b3%a8%e8%a7%a3%e4%b8%80%e8%b5%b7%e4%bd%bf%e7%94%a8%e6%97%b6-ds%e5%a4%b1%e6%95%88%e7%9a%84%e9%97%ae%e9%a2%98 aria-label="3.1 @Transactional 和 @DS 注解一起使用时, @DS失效的问题">3.1 @Transactional 和 @DS 注解一起使用时, @DS失效的问题</a></li><li><a href=#32--%e4%bd%8e%e4%ba%8ev333%e7%89%88%e6%9c%ac%e6%97%a0%e6%b3%95%e5%88%87%e6%8d%a2%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e9%97%ae%e9%a2%98 aria-label="3.2  低于V3.3.3版本无法切换数据源的问题">3.2 低于V3.3.3版本无法切换数据源的问题</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=1-使用>1. 使用<a hidden class=anchor aria-hidden=true href=#1-使用>#</a></h1><h2 id=11-引包>1.1. 引包<a hidden class=anchor aria-hidden=true href=#11-引包>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;groupId&gt;</span>com.baomidou<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;version&gt;</span>3.3.6<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>用最新版的就好 <a href=https://mvnrepository.com/artifact/com.baomidou/dynamic-datasource-spring-boot-starter target=_blank rel=noopener>Maven Repository: dynamic-datasource-spring-boot-starter</a></p><blockquote><p>不过做开发的经验来看, 应该选 倒数第二个大版本里最新的版本, 这样既能用更多的功能,又能保证没有大bug, 除非最新版本有你需要的功能</p></blockquote><h2 id=12-增加配置>1.2 增加配置<a hidden class=anchor aria-hidden=true href=#12-增加配置>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>datasource</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>dynamic</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>primary</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>master</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>#设置默认的数据源或者数据源组,默认值即为master, 所以此处不写也可以</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>strict</span>:<span style=color:#6e7681> </span><span style=color:#79c0ff>false</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic>#设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候回抛出异常,不启动会使用默认数据源.</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>datasource</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>master</span>:<span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># 第一个数据源的名称</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jdbc:mysql://127.0.0.1:3306/dynamic</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>username</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>root</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>password</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>123456</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>driver-class-name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>com.mysql.jdbc.Driver</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>db_1</span>:<span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># 第二个数据源的名称</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jdbc:gbase://127.0.0.1:5258/dynamic</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>username</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>root</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>password</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>123456</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>driver-class-name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>com.mysql.jdbc.Driver</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>如果是多主多从或者一主多从，那么就用分组的功能实现, 即: <strong>数据组名称_xxx</strong>，下划线前面的就是数据组名称，后面就是数据源名, 相同组名称的数据源会放在一个组下。切换数据源时，可以指定<strong>具体数据源名称</strong>，也可以指定<strong>组名</strong>然后会自动采用负载均衡算法切换,</p><p>例如: 上面配置中的"db_1", 表示db分组, 1 名称的数据源, 如果再增加一个"db_2", 则表示这两个数据源是同一个分组, 当在<code>@DS</code>中只指定"db", 则会在这个分组中采用负载均衡方式选数据源(默认是轮询)</p><h2 id=13-使用ds注解>1.3 使用@DS注解<a hidden class=anchor aria-hidden=true href=#13-使用ds注解>#</a></h2><p>@DS注解, 是用来表示使用哪个数据源的, 也是切换数据源功能的核心注解, <strong>它可以用来类和方法上, 方法上的优先级更高</strong>, 例如 service层, Mapper层,都可以, 如果没有配置,则会使用默认数据源</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Service</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;master&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#8b949e;font-style:italic>// 在类上加
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UserServiceImpl</span> <span style=color:#ff7b72>implements</span> UserService <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>private</span> JdbcTemplate jdbcTemplate<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>public</span> List<span style=color:#ff7b72;font-weight:700>&lt;</span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> Object<span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#d2a8ff;font-weight:700>selectAll</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> jdbcTemplate<span style=color:#ff7b72;font-weight:700>.</span>queryForList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;select * from user&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_1&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#8b949e;font-style:italic>// 在方法上加
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>public</span> List<span style=color:#ff7b72;font-weight:700>&lt;</span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> Object<span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#d2a8ff;font-weight:700>selectByCondition</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> jdbcTemplate<span style=color:#ff7b72;font-weight:700>.</span>queryForList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;select * from user where age &gt;10&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>官方建议不建议@DS放在Mapper上, 所以网上有很多例子是放在service上,</p><p>但是这有个问题, 当在service中需要访问两个数据库时, 就会无法切换数据源, 毕竟@DS是加在service上, 在同一个service上操作, 自然不会切换, 官方也给出解决方案, 在方法上进一步指定数据源, (伪代码)例如:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>Person</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    dbService1 db_1<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    dbService2 db_2<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>test</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>        db_1<span style=color:#ff7b72;font-weight:700>.</span>save<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 如果 db_2.save() 不指定数据源, 数据源会使用db_1
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        db_2<span style=color:#ff7b72;font-weight:700>.</span>save<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_1&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>dbService1</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>save</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_2&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>dbService2</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@DS</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;db_2&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>save</span><span style=color:#ff7b72;font-weight:700>(){</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><a href=https://segmentfault.com/q/1010000041340273 target=_blank rel=noopener>mybatis-plus中多数据源切换@DS注解到底放在哪一层合适？</a></p><p><a href=https://github.com/baomidou/dynamic-datasource-spring-boot-starter/issues/259 target=_blank rel=noopener>@DS不建议加在mapper上的原因是?</a></p><h1 id=2-源码>2. 源码<a hidden class=anchor aria-hidden=true href=#2-源码>#</a></h1><p>一般starter自动配置，都是从 <strong>META-INF/spring.factories</strong>文件中指定自动配置类：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>org<span style=color:#ff7b72;font-weight:700>.</span>springframework<span style=color:#ff7b72;font-weight:700>.</span>boot<span style=color:#ff7b72;font-weight:700>.</span>autoconfigure<span style=color:#ff7b72;font-weight:700>.</span>EnableAutoConfiguration<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#f85149>\</span>
</span></span><span style=display:flex><span>com<span style=color:#ff7b72;font-weight:700>.</span>baomidou<span style=color:#ff7b72;font-weight:700>.</span>dynamic<span style=color:#ff7b72;font-weight:700>.</span>datasource<span style=color:#ff7b72;font-weight:700>.</span>spring<span style=color:#ff7b72;font-weight:700>.</span>boot<span style=color:#ff7b72;font-weight:700>.</span>autoconfigure<span style=color:#ff7b72;font-weight:700>.</span>DynamicDataSourceAutoConfiguration
</span></span></code></pre></div><p>所以打开 <strong>DynamicDataSourceAutoConfiguration</strong> 文件</p><h2 id=21-configuration文件-加载配置与bean注入>2.1 Configuration文件, 加载配置与bean注入<a hidden class=anchor aria-hidden=true href=#21-configuration文件-加载配置与bean注入>#</a></h2><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 动态数据源核心自动配置类
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@EnableConfigurationProperties</span><span style=color:#ff7b72;font-weight:700>(</span>DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// @AutoConfigureBefore 注解的意思是 在DataSourceAutoConfiguration和DruidDataSourceAutoConfigure之前就注册当前bean
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 这里特别注意一下, 在 V3.3.3 之前, 没有把DruidDataSourceAutoConfigure加进来, 所以导致项目中有druid时,数据源无法切换或没有druid配置则报错
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>@AutoConfigureBefore</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> DataSourceAutoConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>//引入了Druid的autoConfig和各种数据源连接池的Creator
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>@Import</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>{</span>DynamicDataSourceCreatorAutoConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> DynamicDataSourceAopConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> DynamicDataSourceAssistConfiguration<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@ConditionalOnProperty</span><span style=color:#ff7b72;font-weight:700>(</span>prefix <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>PREFIX<span style=color:#ff7b72;font-weight:700>,</span> name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;enabled&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> havingValue <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;true&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> matchIfMissing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceAutoConfiguration</span>  <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> DynamicDataSourceProperties properties<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//读取多数据源配置，注入到spring容器中
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DynamicDataSourceProvider <span style=color:#d2a8ff;font-weight:700>dynamicDataSourceProvider</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSourceProperty<span style=color:#ff7b72;font-weight:700>&gt;</span> datasourceMap <span style=color:#ff7b72;font-weight:700>=</span> properties<span style=color:#ff7b72;font-weight:700>.</span>getDatasource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> YmlDynamicDataSourceProvider<span style=color:#ff7b72;font-weight:700>(</span>datasourceMap<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//注册自己的动态多数据源DataSource
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>dataSource</span><span style=color:#ff7b72;font-weight:700>(</span>DynamicDataSourceProvider dynamicDataSourceProvider<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DynamicRoutingDataSource dataSource <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicRoutingDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setPrimary<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getPrimary<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setStrict<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getStrict<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setStrategy<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getStrategy<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setProvider<span style=color:#ff7b72;font-weight:700>(</span>dynamicDataSourceProvider<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setP6spy<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getP6spy<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        dataSource<span style=color:#ff7b72;font-weight:700>.</span>setSeata<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getSeata<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> dataSource<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//AOP切面，对DS注解过的方法进行增强，达到切换数据源的目的
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Role</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> BeanDefinition<span style=color:#ff7b72;font-weight:700>.</span>ROLE_INFRASTRUCTURE<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DynamicDataSourceAnnotationAdvisor <span style=color:#d2a8ff;font-weight:700>dynamicDatasourceAnnotationAdvisor</span><span style=color:#ff7b72;font-weight:700>(</span>DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DynamicDataSourceAnnotationInterceptor interceptor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>isAllowedPublicOnly<span style=color:#ff7b72;font-weight:700>(),</span> dsProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        DynamicDataSourceAnnotationAdvisor advisor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationAdvisor<span style=color:#ff7b72;font-weight:700>(</span>interceptor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        advisor<span style=color:#ff7b72;font-weight:700>.</span>setOrder<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getOrder<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> advisor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//关于分布式事务加强
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Role</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> BeanDefinition<span style=color:#ff7b72;font-weight:700>.</span>ROLE_INFRASTRUCTURE<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnProperty</span><span style=color:#ff7b72;font-weight:700>(</span>prefix <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>PREFIX<span style=color:#ff7b72;font-weight:700>,</span> name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;seata&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> havingValue <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;false&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> matchIfMissing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Advisor <span style=color:#d2a8ff;font-weight:700>dynamicTransactionAdvisor</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        AspectJExpressionPointcut pointcut <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AspectJExpressionPointcut<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        pointcut<span style=color:#ff7b72;font-weight:700>.</span>setExpression<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;@annotation(com.baomidou.dynamic.datasource.annotation.DSTransactional)&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> DefaultPointcutAdvisor<span style=color:#ff7b72;font-weight:700>(</span>pointcut<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#ff7b72>new</span> DynamicTransactionAdvisor<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//动态参数解析器链
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DsProcessor <span style=color:#d2a8ff;font-weight:700>dsProcessor</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DsHeaderProcessor headerProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsHeaderProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSessionProcessor sessionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSessionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSpelExpressionProcessor spelExpressionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSpelExpressionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        headerProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>sessionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        sessionProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>spelExpressionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> headerProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>我们可以发现，在使用的时候配置的前缀为<code>spring.datasource.dynamic</code>的配置都会被读取到<code>DynamicDataSourceProperties</code>类，作为一个Bean注入到Spring容器。其实这种读取配置文件信息的方式在日常开发中也是很常见的。</p><h3 id=211--配置类>2.1.1 配置类<a hidden class=anchor aria-hidden=true href=#211--配置类>#</a></h3><p><strong>DynamicDataSourceProperties</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@ConfigurationProperties</span><span style=color:#ff7b72;font-weight:700>(</span>prefix <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceProperties<span style=color:#ff7b72;font-weight:700>.</span>PREFIX<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceProperties</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String PREFIX <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;spring.datasource.dynamic&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String HEALTH <span style=color:#ff7b72;font-weight:700>=</span> PREFIX <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34;.health&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 必须设置默认的库,默认master
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String primary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;master&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 是否启用严格模式,默认不启动. 严格模式下未匹配到数据源直接报错, 非严格模式下则使用默认数据源primary所设置的数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean strict <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// .......
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=22-注册datasource>2.2 注册DataSource<a hidden class=anchor aria-hidden=true href=#22-注册datasource>#</a></h2><p>在 <code>DynamicDataSourceAutoConfiguration</code> 类中, 还加载了DataSource, 我们知道 DataSource是spring用来链接数据库的,</p><p>它注册了一个实现类 <code>DynamicRoutingDataSource</code>, 这个类还有一个父类<code>AbstractRoutingDataSource</code>, 我们先看<code>AbstractRoutingDataSource</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * 抽象动态获取数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * @author TaoYu
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * @since 2.2.0
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>abstract</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AbstractRoutingDataSource</span> <span style=color:#ff7b72>extends</span> AbstractDataSource <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//抽象方法，由子类实现，让子类决定最终使用的数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>protected</span> <span style=color:#ff7b72>abstract</span> DataSource <span style=color:#d2a8ff;font-weight:700>determineDataSource</span><span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>//重写getConnection()方法，实现切换数据源的功能
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Connection <span style=color:#d2a8ff;font-weight:700>getConnection</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72>throws</span> SQLException <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//这里xid涉及分布式事务的处理
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        String xid <span style=color:#ff7b72;font-weight:700>=</span> TransactionContext<span style=color:#ff7b72;font-weight:700>.</span>getXID<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>xid<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>//不使用分布式事务，就是直接返回一个数据连接(实现类: ItemDataSource.class)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>return</span> determineDataSource<span style=color:#ff7b72;font-weight:700>().</span>getConnection<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            String ds <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>peek<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            ConnectionProxy connection <span style=color:#ff7b72;font-weight:700>=</span> ConnectionFactory<span style=color:#ff7b72;font-weight:700>.</span>getConnection<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> connection <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>?</span> getConnectionProxy<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>,</span> determineDataSource<span style=color:#ff7b72;font-weight:700>().</span>getConnection<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>:</span> connection<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>父类很简单, 只是区分了分布式事务的取connect的方式,所以再来看下其子类<code>DynamicRoutingDataSource</code> 的内容</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicRoutingDataSource</span> <span style=color:#ff7b72>extends</span> AbstractRoutingDataSource <span style=color:#ff7b72>implements</span> InitializingBean<span style=color:#ff7b72;font-weight:700>,</span> DisposableBean <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String UNDERLINE <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;_&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 所有数据库
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSourceMap <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ConcurrentHashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 分组数据库
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> GroupDataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> groupDataSources <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> ConcurrentHashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> DynamicDataSourceProvider provider<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Class<span style=color:#ff7b72;font-weight:700>&lt;?</span> <span style=color:#ff7b72>extends</span> DynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>&gt;</span> strategy <span style=color:#ff7b72;font-weight:700>=</span> LoadBalanceDynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String primary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;master&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean strict <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean p6spy <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Setter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Boolean seata <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>determineDataSource</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 获得数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> getDataSource<span style=color:#ff7b72;font-weight:700>(</span>DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>peek<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> DataSource <span style=color:#d2a8ff;font-weight:700>determinePrimaryDataSource</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource switch to the primary datasource&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>).</span>determineDataSource<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>:</span> dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// bean的属性加载完后, 执行该方法
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>afterPropertiesSet</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72>throws</span> Exception <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 检查开启了配置但没有相关依赖
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        checkEnv<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>// 拿到所有的数据源, Key是数据源的名称，Value则是DataSource。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSources <span style=color:#ff7b72;font-weight:700>=</span> provider<span style=color:#ff7b72;font-weight:700>.</span>loadDataSources<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 添加并分组数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Map<span style=color:#ff7b72;font-weight:700>.</span>Entry<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dsItem <span style=color:#ff7b72;font-weight:700>:</span> dataSources<span style=color:#ff7b72;font-weight:700>.</span>entrySet<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            addDataSource<span style=color:#ff7b72;font-weight:700>(</span>dsItem<span style=color:#ff7b72;font-weight:700>.</span>getKey<span style=color:#ff7b72;font-weight:700>(),</span> dsItem<span style=color:#ff7b72;font-weight:700>.</span>getValue<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 检测默认数据源是否设置
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource initial loaded [{}] datasource,primary group datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataSources<span style=color:#ff7b72;font-weight:700>.</span>size<span style=color:#ff7b72;font-weight:700>(),</span> primary<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>primary<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#ff7b72;font-weight:700>.</span>info<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource initial loaded [{}] datasource,primary datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> dataSources<span style=color:#ff7b72;font-weight:700>.</span>size<span style=color:#ff7b72;font-weight:700>(),</span> primary<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> RuntimeException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource Please check the setting of primary&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 获取数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ds 数据源名称
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return 数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>getDataSource</span><span style=color:#ff7b72;font-weight:700>(</span>String ds<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 没有ds注解, 则默认用 Primary
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>return</span> determinePrimaryDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(!</span>groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 如果有组, 则用负载均衡的方式取一个
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource switch to the datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>).</span>determineDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>containsKey<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 没有组, 则直接取
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            log<span style=color:#ff7b72;font-weight:700>.</span>debug<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource switch to the datasource named [{}]&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 严格模式下直接报错
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>strict<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> CannotFindDataSourceException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource could not find a datasource named&#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> ds<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> determinePrimaryDataSource<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// .....
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>它实现了<code>InitializingBean</code>接口，这个接口需要实现<code>afterPropertiesSet()</code>方法，这是一个Bean的生命周期函数，在Bean初始化的时候做一些操作</p><h3 id=221--获取所有的datasource>2.2.1 获取所有的DataSource<a hidden class=anchor aria-hidden=true href=#221--获取所有的datasource>#</a></h3><p>先看一下它是怎么获得数据源的? <code>provider.loadDataSources()</code> 是抽象方法, 有两个实现</p><p><code>YmlDynamicDataSourceProvider</code>和<code>AbstractJdbcDataSourceProvider</code>, 在<code>DynamicDataSourceAutoConfiguration</code> 类中, 注入的是<code>YmlDynamicDataSourceProvider</code>, 所以直接看它的实现 , 最后会跳转到<code>AbstractDataSourceProvider</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>abstract</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AbstractDataSourceProvider</span> <span style=color:#ff7b72>implements</span> DynamicDataSourceProvider <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> DefaultDataSourceCreator defaultDataSourceCreator<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>protected</span> Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>createDataSourceMap</span><span style=color:#ff7b72;font-weight:700>(</span>
</span></span><span style=display:flex><span>            Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSourceProperty<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSourcePropertiesMap<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSource<span style=color:#ff7b72;font-weight:700>&gt;</span> dataSourceMap <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> HashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;(</span>dataSourcePropertiesMap<span style=color:#ff7b72;font-weight:700>.</span>size<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>*</span> 2<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>Map<span style=color:#ff7b72;font-weight:700>.</span>Entry<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> DataSourceProperty<span style=color:#ff7b72;font-weight:700>&gt;</span> item <span style=color:#ff7b72;font-weight:700>:</span> dataSourcePropertiesMap<span style=color:#ff7b72;font-weight:700>.</span>entrySet<span style=color:#ff7b72;font-weight:700>())</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            DataSourceProperty dataSourceProperty <span style=color:#ff7b72;font-weight:700>=</span> item<span style=color:#ff7b72;font-weight:700>.</span>getValue<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            String poolName <span style=color:#ff7b72;font-weight:700>=</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>getPoolName<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>poolName <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#34;&#34;</span><span style=color:#ff7b72;font-weight:700>.</span>equals<span style=color:#ff7b72;font-weight:700>(</span>poolName<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                poolName <span style=color:#ff7b72;font-weight:700>=</span> item<span style=color:#ff7b72;font-weight:700>.</span>getKey<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>setPoolName<span style=color:#ff7b72;font-weight:700>(</span>poolName<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>//            这里的defaultDataSourceCreator.createDataSource()方法使用到适配器模式。因为每种配置数据源创建的DataSource实现类都不一定相同的，所以需要根据配置的数据源类型进行具体的DataSource创建。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            dataSourceMap<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span>poolName<span style=color:#ff7b72;font-weight:700>,</span> defaultDataSourceCreator<span style=color:#ff7b72;font-weight:700>.</span>createDataSource<span style=color:#ff7b72;font-weight:700>(</span>dataSourceProperty<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> dataSourceMap<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=2211-构建datasource>2.2.1.1 构建DataSource<a hidden class=anchor aria-hidden=true href=#2211-构建datasource>#</a></h4><p>来看一下<code>defaultDataSourceCreator.createDataSource()</code>的逻辑</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>createDataSource</span><span style=color:#ff7b72;font-weight:700>(</span>DataSourceProperty dataSourceProperty<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        DataSourceCreator dataSourceCreator <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>//this.creators是所有适配的DataSourceCreator实现类
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>DataSourceCreator creator <span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>creators<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>//根据配置匹配对应的dataSourceCreator
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>creator<span style=color:#ff7b72;font-weight:700>.</span>support<span style=color:#ff7b72;font-weight:700>(</span>dataSourceProperty<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//如果匹配，则使用对应的dataSourceCreator
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                dataSourceCreator <span style=color:#ff7b72;font-weight:700>=</span> creator<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>break</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>dataSourceCreator <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> IllegalStateException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;creator must not be null,please check the DataSourceCreator&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String publicKey <span style=color:#ff7b72;font-weight:700>=</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>getPublicKey<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>publicKey<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>setPublicKey<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getPublicKey<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Boolean lazy <span style=color:#ff7b72;font-weight:700>=</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>getLazy<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>lazy <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            dataSourceProperty<span style=color:#ff7b72;font-weight:700>.</span>setLazy<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getLazy<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#8b949e;font-style:italic>//然后再调用createDataSource方法进行创建对应DataSource
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DataSource dataSource <span style=color:#ff7b72;font-weight:700>=</span> dataSourceCreator<span style=color:#ff7b72;font-weight:700>.</span>createDataSource<span style=color:#ff7b72;font-weight:700>(</span>dataSourceProperty<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// (如果有则运行, 可以自定义)运行 建表语句和数据脚本
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>runScrip<span style=color:#ff7b72;font-weight:700>(</span>dataSource<span style=color:#ff7b72;font-weight:700>,</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> wrapDataSource<span style=color:#ff7b72;font-weight:700>(</span>dataSource<span style=color:#ff7b72;font-weight:700>,</span> dataSourceProperty<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>创建DataSource的有很多实现类, 每种数据源都有自己的实现</p><p>对应的全部实现类是放在creator包下：</p><p><img loading=lazy src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2319212a11c4446784d5ee196f8f67d7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp alt=img></p><p>创建dataSource就很简单了, 就是把账号/密码/url等参数设置进去</p><h3 id=222-对数据源分组>2.2.2 对数据源分组<a hidden class=anchor aria-hidden=true href=#222-对数据源分组>#</a></h3><p>再回到之前的，当拿到DataSource的Map集合之后，再做什么呢？</p><p>接着调<code>addDataSource()</code>方法，这个方法是根据下划线"_&ldquo;对数据源进行分组，最后放到<code>groupDataSources</code>成员变量里面。 <code>com.baomidou.dynamic.datasource.DynamicRoutingDataSource#addDataSource</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String UNDERLINE <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;_&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>  
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 轮询策略
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>private</span> Class<span style=color:#ff7b72;font-weight:700>&lt;?</span> <span style=color:#ff7b72>extends</span> DynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>&gt;</span> strategy <span style=color:#ff7b72;font-weight:700>=</span> LoadBalanceDynamicDataSourceStrategy<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 新数据源添加到分组
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ds         新数据源的名字
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param dataSource 新数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>private</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>addGroupDataSource</span><span style=color:#ff7b72;font-weight:700>(</span>String ds<span style=color:#ff7b72;font-weight:700>,</span> DataSource dataSource<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>.</span>contains<span style=color:#ff7b72;font-weight:700>(</span>UNDERLINE<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String group <span style=color:#ff7b72;font-weight:700>=</span> ds<span style=color:#ff7b72;font-weight:700>.</span>split<span style=color:#ff7b72;font-weight:700>(</span>UNDERLINE<span style=color:#ff7b72;font-weight:700>)[</span>0<span style=color:#ff7b72;font-weight:700>];</span>
</span></span><span style=display:flex><span>        GroupDataSource groupDataSource <span style=color:#ff7b72;font-weight:700>=</span> groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>groupDataSource <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>//顺便设置负载均衡策略，strategy默认是LoadBalanceDynamicDataSourceStrategy
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                groupDataSource <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> GroupDataSource<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>,</span> strategy<span style=color:#ff7b72;font-weight:700>.</span>getDeclaredConstructor<span style=color:#ff7b72;font-weight:700>().</span>newInstance<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>                groupDataSources<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span>group<span style=color:#ff7b72;font-weight:700>,</span> groupDataSource<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Exception e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> RuntimeException<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;dynamic-datasource - add the datasource named &#34;</span> <span style=color:#ff7b72;font-weight:700>+</span> ds <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#34; error&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> e<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        groupDataSource<span style=color:#ff7b72;font-weight:700>.</span>addDatasource<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>,</span> dataSource<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>至此, 项目启动时, 多数据做的事就完了, 那我们执行sql时, 它是怎么切换的呢?</p><h2 id=23-切换数据源>2.3 切换数据源<a hidden class=anchor aria-hidden=true href=#23-切换数据源>#</a></h2><p>在前面的<code>DynamicRoutingDataSource</code>我们知道, 这是mybatisPlus写的获取数据源的类 , 它最终是通过<code>com.baomidou.dynamic.datasource.DynamicRoutingDataSource#determineDataSource</code>获得数据源的, 在 2.2.1 也有描述.</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DataSource <span style=color:#d2a8ff;font-weight:700>determineDataSource</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 从threadLocal中获取当前数据源key (就是@DS注解里的字符串)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        String dsKey <span style=color:#ff7b72;font-weight:700>=</span> DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>peek<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 根据key获取数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> getDataSource<span style=color:#ff7b72;font-weight:700>(</span>dsKey<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>那么上面的<code>DynamicDataSourceContextHolder</code>这个类是干嘛的呢？注解@DS的值又是怎么传进来的呢？</p><p>我们先看看这个类</p><h3 id=231-dynamicdatasourcecontextholder>2.3.1 DynamicDataSourceContextHolder<a hidden class=anchor aria-hidden=true href=#231-dynamicdatasourcecontextholder>#</a></h3><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> * 核心基于ThreadLocal的切换数据源工具类
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>final</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceContextHolder</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 为什么要用链表存储(准确的是栈)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 为了支持嵌套切换，如ABC三个service都是不同的数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 其中A的某个业务要调B的方法，B的方法需要调用C的方法。一级一级调用切换，形成了链。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 传统的只设置当前线程的方式不能满足此业务需求，必须使用栈，后进先出。
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;/pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> ThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>Deque<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> LOOKUP_KEY_HOLDER <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> NamedThreadLocal<span style=color:#ff7b72;font-weight:700>&lt;</span>Deque<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;&gt;(</span><span style=color:#a5d6ff>&#34;dynamic-datasource&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>protected</span> Deque<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#d2a8ff;font-weight:700>initialValue</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> ArrayDeque<span style=color:#ff7b72;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>};</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 获得当前线程数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return 数据源名称
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> String <span style=color:#d2a8ff;font-weight:700>peek</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> LOOKUP_KEY_HOLDER<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>peek<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 设置当前线程数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 如非必要不要手动调用，调用后确保最终清除
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param ds 数据源名称
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>static</span> String <span style=color:#d2a8ff;font-weight:700>push</span><span style=color:#ff7b72;font-weight:700>(</span>String ds<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String dataSourceStr <span style=color:#ff7b72;font-weight:700>=</span> StringUtils<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>(</span>ds<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>?</span> <span style=color:#a5d6ff>&#34;&#34;</span> <span style=color:#ff7b72;font-weight:700>:</span> ds<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        LOOKUP_KEY_HOLDER<span style=color:#ff7b72;font-weight:700>.</span>get<span style=color:#ff7b72;font-weight:700>().</span>push<span style=color:#ff7b72;font-weight:700>(</span>dataSourceStr<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> dataSourceStr<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ....
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>这里用的是<code>NamedThreadLocal</code>, 比<code>ThreadLocal</code>多了一个名字字段而已, 大家知道<code>ThreadLocal</code> 的特性: 线程隔离/内存泄露风险, 所以 <strong>当开多线程会让多数据源切换失败(看你@DS注解打在哪和具体使用); 网上说用到 <code>DynamicDataSourceContextHolder</code>类时, 都是<code>push()</code>和<code>clean()</code>/<code>poll()</code>一起使用.其实就是避免内存泄露</strong></p><p>既然有<code>peek()</code>, 那肯定有<code>push()</code>, 我们来反推一下, 看一下哪些地方在调用<code>push()</code>, 可以发现有两个地方, 分别是</p><p><code>DynamicDataSourceAnnotationInterceptor</code> 和 <code>MasterSlaveAutoRoutingPlugin</code>,</p><p><code>MasterSlaveAutoRoutingPlugin</code>是做主从数据库切换的, 我们自然看 <code>DynamicDataSourceAnnotationInterceptor</code></p><h3 id=232-dynamicdatasourceannotationinterceptor>2.3.2 DynamicDataSourceAnnotationInterceptor<a hidden class=anchor aria-hidden=true href=#232-dynamicdatasourceannotationinterceptor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceAnnotationInterceptor</span> <span style=color:#ff7b72>implements</span> MethodInterceptor <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * The identification of SPEL.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String DYNAMIC_PREFIX <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;#&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> DataSourceClassResolver dataSourceClassResolver<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#d2a8ff;font-weight:700>DynamicDataSourceAnnotationInterceptor</span><span style=color:#ff7b72;font-weight:700>(</span>Boolean allowedPublicOnly<span style=color:#ff7b72;font-weight:700>,</span> DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        dataSourceClassResolver <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DataSourceClassResolver<span style=color:#ff7b72;font-weight:700>(</span>allowedPublicOnly<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>dsProcessor <span style=color:#ff7b72;font-weight:700>=</span> dsProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Object <span style=color:#d2a8ff;font-weight:700>invoke</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72>throws</span> Throwable <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//找到@DS注解的属性值，也就是数据源名称
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        String dsKey <span style=color:#ff7b72;font-weight:700>=</span> determineDatasourceKey<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//把数据源名称push到当前线程的栈
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>push<span style=color:#ff7b72;font-weight:700>(</span>dsKey<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>//执行当前方法
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>return</span> invocation<span style=color:#ff7b72;font-weight:700>.</span>proceed<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>finally</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>//从栈里释放数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            DynamicDataSourceContextHolder<span style=color:#ff7b72;font-weight:700>.</span>poll<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> String <span style=color:#d2a8ff;font-weight:700>determineDatasourceKey</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 从方法上和类上 获取key
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        String key <span style=color:#ff7b72;font-weight:700>=</span> dataSourceClassResolver<span style=color:#ff7b72;font-weight:700>.</span>findDSKey<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>.</span>getMethod<span style=color:#ff7b72;font-weight:700>(),</span> invocation<span style=color:#ff7b72;font-weight:700>.</span>getThis<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 如果数据源是以 # 开头, 则进入ds处理器, 这里用的是责任链模式
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>(!</span>key<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> key<span style=color:#ff7b72;font-weight:700>.</span>startsWith<span style=color:#ff7b72;font-weight:700>(</span>DYNAMIC_PREFIX<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>?</span> dsProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>:</span> key<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>它是invoke方法, 一看就是反射标准写法, 看一下它的父类, <code>MethodInterceptor</code>, 它可以对AOP的切面进行增强,</p><p>简单来说, 如果被切到后, 就会调用这个invoke方法</p><blockquote><p><a href=https://www.jianshu.com/p/71c4e8b8f09b target=_blank rel=noopener>Spring动态代理之MethodInterceptor拦截器详解 - 简书 (jianshu.com)</a></p></blockquote><p>我们继续看切面是如何使用的, 而ds处理器等会讲</p><h3 id=234--dynamicdatasourceannotationadvisor>2.3.4 DynamicDataSourceAnnotationAdvisor<a hidden class=anchor aria-hidden=true href=#234--dynamicdatasourceannotationadvisor>#</a></h3><p>直接看 <code>DynamicDataSourceAnnotationInterceptor</code> 在哪里用到了, 会发现回到了<code>DynamicDataSourceAutoConfiguration</code>类</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Role</span><span style=color:#ff7b72;font-weight:700>(</span>value <span style=color:#ff7b72;font-weight:700>=</span> BeanDefinition<span style=color:#ff7b72;font-weight:700>.</span>ROLE_INFRASTRUCTURE<span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Advisor <span style=color:#d2a8ff;font-weight:700>dynamicDatasourceAnnotationAdvisor</span><span style=color:#ff7b72;font-weight:700>(</span>DsProcessor dsProcessor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 创建拦截器
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DynamicDataSourceAnnotationInterceptor interceptor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>isAllowedPublicOnly<span style=color:#ff7b72;font-weight:700>(),</span> dsProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 把拦截器放到Advisor上
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DynamicDataSourceAnnotationAdvisor advisor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DynamicDataSourceAnnotationAdvisor<span style=color:#ff7b72;font-weight:700>(</span>interceptor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        advisor<span style=color:#ff7b72;font-weight:700>.</span>setOrder<span style=color:#ff7b72;font-weight:700>(</span>properties<span style=color:#ff7b72;font-weight:700>.</span>getOrder<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> advisor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p>Advisor是Spring AOP的顶层抽象，用来管理Advice和Pointcut</p><p>@Transactional 也是用这种方式做的</p><p><a href=https://cloud.tencent.com/developer/article/1808649 target=_blank rel=noopener>从 AbstractPointcutAdvisor 开始： Spring AOP 之 Advisor、PointcutAdvisor 介绍</a></p></blockquote><p><code>DynamicDataSourceAnnotationAdvisor</code>是用于AOP切面编程的，针对注解@DS的切面进行处理：</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DynamicDataSourceAnnotationAdvisor</span> <span style=color:#ff7b72>extends</span> AbstractPointcutAdvisor <span style=color:#ff7b72>implements</span> BeanFactoryAware <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Advice advice<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>final</span> Pointcut pointcut<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 初始化时调用了构造方法
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>public</span> <span style=color:#d2a8ff;font-weight:700>DynamicDataSourceAnnotationAdvisor</span><span style=color:#ff7b72;font-weight:700>(</span><span style=color:#d2a8ff;font-weight:700>@NonNull</span> DynamicDataSourceAnnotationInterceptor dynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>advice <span style=color:#ff7b72;font-weight:700>=</span> dynamicDataSourceAnnotationInterceptor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>pointcut <span style=color:#ff7b72;font-weight:700>=</span> buildPointcut<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Pointcut <span style=color:#d2a8ff;font-weight:700>getPointcut</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>pointcut<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Advice <span style=color:#d2a8ff;font-weight:700>getAdvice</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span><span style=color:#ff7b72;font-weight:700>.</span>advice<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> Pointcut <span style=color:#d2a8ff;font-weight:700>buildPointcut</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Pointcut cpc <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AnnotationMatchingPointcut<span style=color:#ff7b72;font-weight:700>(</span>DS<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        Pointcut mpc <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> AnnotationMethodPoint<span style=color:#ff7b72;font-weight:700>(</span>DS<span style=color:#ff7b72;font-weight:700>.</span>class<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>//方法优于类
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> ComposablePointcut<span style=color:#ff7b72;font-weight:700>(</span>cpc<span style=color:#ff7b72;font-weight:700>).</span>union<span style=color:#ff7b72;font-weight:700>(</span>mpc<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span> <span style=color:#8b949e;font-style:italic>// .....   
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>所以总的来说, 当执行的方法或者类被 @DS切到时, 就会执行增强方法, 把数据源key放到threadLocal中, 获取数据源时从threadLocal中拿到key进而拿到数据源</p><p>至此, 多数据源的初始化和使用时切换就结束了</p><h2 id=24-数据源的处理器>2.4 数据源的处理器<a hidden class=anchor aria-hidden=true href=#24-数据源的处理器>#</a></h2><p>在<code>com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey</code>处, 有说过ds处理器, 它是干什么的呢?</p><p>我们常用的指定数据源的方式时是 <code>@DS("master")</code> <code>@DS("salve_1")</code>, 这些都是固定字符串, 如果我们需要根据租户来切换数据源呢?或者引入灰度系统后按Header的属性来切换呢? 因此plus的提供了各种数据源的处理器</p><ol><li>DsHeaderProcessor : 从header中获取</li><li>DsSessionProcessor: 从session中获取</li><li>DsSpelExpressionProcessor: 解析Spel语法获取</li></ol><blockquote><p>常见的@vaule()注解就支持spel语法, 从配置文件中取值或者写默认值都是spel语法</p><p><a href=https://zhuanlan.zhihu.com/p/174786047# target=_blank rel=noopener>玩转Spring中强大的spel表达式！ - 知乎 (zhihu.com)</a></p></blockquote><p>继续 <code>com.baomidou.dynamic.datasource.aop.DynamicDataSourceAnnotationInterceptor#determineDatasourceKey</code>, 看一下它的代码</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#ff7b72>private</span> String <span style=color:#d2a8ff;font-weight:700>determineDatasourceKey</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        String key <span style=color:#ff7b72;font-weight:700>=</span> dataSourceClassResolver<span style=color:#ff7b72;font-weight:700>.</span>findDSKey<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>.</span>getMethod<span style=color:#ff7b72;font-weight:700>(),</span> invocation<span style=color:#ff7b72;font-weight:700>.</span>getThis<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>      <span style=color:#8b949e;font-style:italic>// dsProcessor.determineDatasource() 从处理器获取数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>(!</span>key<span style=color:#ff7b72;font-weight:700>.</span>isEmpty<span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> key<span style=color:#ff7b72;font-weight:700>.</span>startsWith<span style=color:#ff7b72;font-weight:700>(</span>DYNAMIC_PREFIX<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>?</span> dsProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>:</span> key<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p><code>dsProcessor</code> 反向定位这个变量, 会追踪到<code>com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DynamicDataSourceAutoConfiguration#dsProcessor</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#d2a8ff;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> DsProcessor <span style=color:#d2a8ff;font-weight:700>dsProcessor</span><span style=color:#ff7b72;font-weight:700>(</span>BeanFactory beanFactory<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 先header处理器
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        DsHeaderProcessor headerProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsHeaderProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSessionProcessor sessionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSessionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        DsSpelExpressionProcessor spelExpressionProcessor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DsSpelExpressionProcessor<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        spelExpressionProcessor<span style=color:#ff7b72;font-weight:700>.</span>setBeanResolver<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>new</span> BeanFactoryResolver<span style=color:#ff7b72;font-weight:700>(</span>beanFactory<span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 再session处理器
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        headerProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>sessionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 最后spel处理器
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        sessionProcessor<span style=color:#ff7b72;font-weight:700>.</span>setNextProcessor<span style=color:#ff7b72;font-weight:700>(</span>spelExpressionProcessor<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> headerProcessor<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>回到使用的地方, 进入方法</p><p><code>com.baomidou.dynamic.datasource.processor.DsProcessor</code></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 决定数据源
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *     调用底层doDetermineDatasource，
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *     如果返回的是null则继续执行下一个，否则直接返回
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * &lt;/pre&gt;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param invocation 方法执行信息
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @param key        DS注解里的内容
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return 数据源名称
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> String <span style=color:#d2a8ff;font-weight:700>determineDatasource</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>,</span> String key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// key的格式是否匹配
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>matches<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 解析数据源key
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            String datasource <span style=color:#ff7b72;font-weight:700>=</span> doDetermineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>datasource <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> nextProcessor <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 下一个处理器
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>return</span> nextProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> datasource<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>(</span>nextProcessor <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> nextProcessor<span style=color:#ff7b72;font-weight:700>.</span>determineDatasource<span style=color:#ff7b72;font-weight:700>(</span>invocation<span style=color:#ff7b72;font-weight:700>,</span> key<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>我们以<code>DsHeaderProcessor</code> 为例:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>public</span> <span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>DsHeaderProcessor</span> <span style=color:#ff7b72>extends</span> DsProcessor <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * header prefix
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>private</span> <span style=color:#ff7b72>static</span> <span style=color:#ff7b72>final</span> String HEADER_PREFIX <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;#header&#34;</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>boolean</span> <span style=color:#d2a8ff;font-weight:700>matches</span><span style=color:#ff7b72;font-weight:700>(</span>String key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 是否 以#header 开头
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> key<span style=color:#ff7b72;font-weight:700>.</span>startsWith<span style=color:#ff7b72;font-weight:700>(</span>HEADER_PREFIX<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d2a8ff;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> String <span style=color:#d2a8ff;font-weight:700>doDetermineDatasource</span><span style=color:#ff7b72;font-weight:700>(</span>MethodInvocation invocation<span style=color:#ff7b72;font-weight:700>,</span> String key<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        HttpServletRequest request <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>((</span>ServletRequestAttributes<span style=color:#ff7b72;font-weight:700>)</span> RequestContextHolder<span style=color:#ff7b72;font-weight:700>.</span>getRequestAttributes<span style=color:#ff7b72;font-weight:700>()).</span>getRequest<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 从请求头中直接获取(很粗暴,竟然连分隔符都不用), 比如@DS(&#34;#headeruserId&#34;), 这样就会从header中取出userId字段
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> request<span style=color:#ff7b72;font-weight:700>.</span>getHeader<span style=color:#ff7b72;font-weight:700>(</span>key<span style=color:#ff7b72;font-weight:700>.</span>substring<span style=color:#ff7b72;font-weight:700>(</span>8<span style=color:#ff7b72;font-weight:700>));</span><span style=color:#8b949e;font-style:italic>// 刚好把 #header 这几个字符截断
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>session处理器是以<code>#session</code> 开头</p><p>按顺序处理都不是后, 就会按<code>DsSpelExpressionProcessor</code> 处理</p><p>举一些例子:</p><p><code>@DS("#headerUserId")</code> : 取header中的UserId字段作为数据源key</p><p><code>@DS("#sessionTentendId")</code> : 取session中的TentendId字段作为数据源key</p><p><code>@DS("#person")</code>: 把方法上的变量person的值作为数据源key (SPEL语法)</p><blockquote><p>学习SPEL语法就会发现很多奇妙用法, 比如可与获取方法的参数;方法的返参类型; 类的名称等</p></blockquote><h1 id=3-qa>3. Q&amp;A<a hidden class=anchor aria-hidden=true href=#3-qa>#</a></h1><h2 id=31-transactional-和-ds-注解一起使用时-ds失效的问题>3.1 @Transactional 和 @DS 注解一起使用时, @DS失效的问题<a hidden class=anchor aria-hidden=true href=#31-transactional-和-ds-注解一起使用时-ds失效的问题>#</a></h2><p>这是因为 <code>@Transactional</code> <strong>开启事务后, 就不会重新拿数据源</strong>,因为@DS也得通过切面去获取数据源, 这样就导致了@DS失效.</p><p>要解决的话, 就在要切换数据源的方法上也打上@DS, 或者多个数据源有修改操作可以都打上事务注解并改变传播机制,(但这其实是分布式事务的范畴, 这样操作不能保证事务了, plus也提供了<code>@DSTransactional</code> 来支持, 不够需要借助<code>seata</code>)</p><p><a href=https://blog.csdn.net/weixin_40378837/article/details/106554198 target=_blank rel=noopener>@Transactional跟@DS动态数据源注解冲突_林蜗牛snail的博客-CSDN博客</a></p><blockquote><p>关于 <code>@DSTransactional</code> 以后再补充一下</p></blockquote><h2 id=32--低于v333版本无法切换数据源的问题>3.2 低于V3.3.3版本无法切换数据源的问题<a hidden class=anchor aria-hidden=true href=#32--低于v333版本无法切换数据源的问题>#</a></h2><p>这是因为在V3.3.3版本之前, <code>DruidDataSourceAutoConfigure</code>会比<code>DynamicDataSourceAutoConfiguration</code>先注册, 导致数据库有读取<code>druid</code>的配置, 所以会出现 ,没有druid配置启动报错; 数据源无法切换等等原因, 官方在V3.3.3这个版本修复了, 但是这个版本有个其他的重点bug,官方不让下载, 所以github上找不到这个版本的描述, 只在官网有描述</p><blockquote><p>分两步解决的,</p><ol><li>去除 druid pom坐标</li><li>在 <code>DynamicDataSourceAutoConfiguration</code> 上指定优于 <code>DruidDataSourceAutoConfigure</code>加载</li></ol></blockquote><p>解决办法就是排除<code>DruidDataSourceAutoConfigure</code> 类;</p><p><a href=https://blog.csdn.net/w57685321/article/details/106823660 target=_blank rel=noopener>使用dynamic-datasource-spring-boot-starter做多数据源及源码分析_0x2015的博客-CSDN博客</a></p><p><a href=https://juejin.cn/post/7022650688425426974 target=_blank rel=noopener>Mybatis-Plus多数据源解析 - 掘金 (juejin.cn)</a></p><p><a href=https://www.kancloud.cn/tracy5546/dynamic-datasource/content/%E7%89%88%E6%9C%AC%E8%AE%B0%E5%BD%95.md target=_blank rel=noopener>多数据源官网-版本记录</a></p><p><a href=https://blog.csdn.net/weixin_43846916/article/details/110824726 target=_blank rel=noopener>Mybatis plus的多数据源@DS切换为什么不起作用了，谁的锅，@Transactional</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/MyBatis-Plus.html>MyBatis-Plus</a></li><li><a href=https://xiaokunji.com/zh/tags/java%E5%8F%8A%E5%85%B6%E6%A1%86%E6%9E%B6.html>java及其框架</a></li></ul><nav class=paginav><a class=prev href=https://xiaokunji.com/zh/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6MVCC.html><span class=title>« 上一页</span><br><span>多版本并发控制(MVCC)</span></a>
<a class=next href=https://xiaokunji.com/zh/%E7%BB%BC%E5%90%88/%E4%B8%AA%E4%BA%BA%E5%B0%8F%E7%9F%A5%E8%AF%86/%E6%9D%82%E9%A1%B9/%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%BC%8F.html><span class=title>下一页 »</span><br><span>多租户模式</span></a></nav></footer></article></main><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>米二</a>
All Rights Reserved</span>
<span id=busuanzi_container><span class="fa fa-user">用户数:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">访问数:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>