<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ç®€è¿°å¹‚ç­‰æ€§ | ç±³äºŒ</title><meta name=keywords content=" ä¸€. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§?, äºŒ. ç”Ÿäº§è€…å¹‚ç­‰æ€§, 2.1 å•å›è¯å¹‚ç­‰æ€§, 2.2 å¤šå›è¯å¹‚ç­‰æ€§, 2.2.1 å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§, ä¸‰. æ¶ˆè´¹è€…å¹‚ç­‰æ€§"><meta name=description content="     "><meta name=author content="xkj"><link rel=canonical href=https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/Kafka/%E7%AE%80%E8%BF%B0%E5%B9%82%E7%AD%89%E6%80%A7.html><link crossorigin=anonymous href=/assets/css/stylesheet.b3faf608c544858ba700943ffe182cb647f38432d29a07d73234965beacb26f6.css integrity="sha256-s/r2CMVEhYunAJQ//hgstkfzhDLSmgfXMjSWW+rLJvY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=16x16 href=https://xiaokunji.com/img/Q.svg><link rel=icon type=image/png sizes=32x32 href=https://xiaokunji.com/img/Q.svg><link rel=apple-touch-icon href=https://xiaokunji.com/Q.svg><link rel=mask-icon href=https://xiaokunji.com/Q.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/Kafka/%E7%AE%80%E8%BF%B0%E5%B9%82%E7%AD%89%E6%80%A7.html><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="ç®€è¿°å¹‚ç­‰æ€§"><meta property="og:description" content="     "><meta property="og:type" content="article"><meta property="og:url" content="https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/Kafka/%E7%AE%80%E8%BF%B0%E5%B9%82%E7%AD%89%E6%80%A7.html"><meta property="article:section" content="hadoopç”Ÿæ€åœˆ"><meta property="article:published_time" content="2023-08-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-04T05:50:23+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ç®€è¿°å¹‚ç­‰æ€§"><meta name=twitter:description content="     "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":4,"name":"ç®€è¿°å¹‚ç­‰æ€§","item":"https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/Kafka/%E7%AE%80%E8%BF%B0%E5%B9%82%E7%AD%89%E6%80%A7.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ç®€è¿°å¹‚ç­‰æ€§","name":"ç®€è¿°å¹‚ç­‰æ€§","description":"     ","keywords":[" ä¸€. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§?"," äºŒ. ç”Ÿäº§è€…å¹‚ç­‰æ€§"," 2.1 å•å›è¯å¹‚ç­‰æ€§"," 2.2 å¤šå›è¯å¹‚ç­‰æ€§"," 2.2.1 å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§"," ä¸‰. æ¶ˆè´¹è€…å¹‚ç­‰æ€§"],"articleBody":"[toc]\nä¸€. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§? å¹‚ç­‰æ€§å…¶å®æ˜¯æ¶ˆæ¯çš„ä¸€è‡´æ€§,åˆ†ä¸ºç”Ÿäº§è€…å¹‚ç­‰æ€§å’Œæ¶ˆè´¹è€…å¹‚ç­‰æ€§.\nä½¿ç”¨Kafkaæ—¶,éœ€è¦ä¿è¯exactly-onceè¯­ä¹‰ã€‚è¦çŸ¥é“åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå‡ºç°ç½‘ç»œåˆ†åŒºæ˜¯ä¸å¯é¿å…çš„ï¼Œå¦‚æœkafka broker åœ¨å›å¤ackæ—¶ï¼Œå‡ºç°ç½‘ç»œæ•…éšœæˆ–è€…æ˜¯full gcå¯¼è‡´ack timeoutï¼Œproducerå°†ä¼šé‡å‘ï¼Œå¦‚ä½•ä¿è¯produceré‡è¯•æ—¶ä¸é€ æˆé‡å¤orä¹±åºï¼Ÿåˆæˆ–è€…producer æŒ‚äº†ï¼Œæ–°çš„producerå¹¶æ²¡æœ‰old producerçš„çŠ¶æ€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å¦‚ä½•ä¿è¯å¹‚ç­‰ï¼Ÿå³ä½¿Kafka å‘é€æ¶ˆæ¯æ»¡è¶³äº†å¹‚ç­‰ï¼Œconsumeræ‹‰å–åˆ°æ¶ˆæ¯åï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™çº¿ç¨‹æ± workersï¼Œworkersçº¿ç¨‹å¯¹messageçš„å¤„ç†å¯èƒ½åŒ…å«å¼‚æ­¥æ“ä½œï¼Œ\næ¥è‡ª https://www.cnblogs.com/jingangtx/p/11330338.html å°±æ˜¯ç”¨æ¥è§£å†³æ•°æ®é‡å¤é—®é¢˜ï¼Œä¿è¯kafkaå•ä¼šè¯å•åˆ†åŒºå†…æ•°æ®ä¸ä¼šé‡å¤æ¶ˆè´¹åœ¨kafka0.11ä¹‹å‰é€šè¿‡isr+ackæœºåˆ¶å¯ä¿è¯æ•°æ®ä¸ä¸¢ï¼Œå´ä¸èƒ½ä¿è¯ä¸é‡å¤ æœ‰ä¸€äº›æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´æ•°æ®é‡å¤ã€‚æ¯”å¦‚ï¼šç½‘ç»œè¯·æ±‚å»¶æ—¶å¯¼è‡´çš„é‡è¯•æ“ä½œï¼Œåœ¨å‘é€è¯·æ±‚é‡è¯•æ—¶ Server ç«¯å¹¶ä¸çŸ¥é“è¿™æ¡è¯·æ±‚æ˜¯å¦å·²ç»å¤„ç†ï¼ˆæ²¡æœ‰è®°å½•ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼‰ï¼Œæ‰€ä»¥å°±ä¼šæœ‰å¯èƒ½å¯¼è‡´æ•°æ®è¯·æ±‚çš„é‡å¤å‘é€ï¼Œè¿™æ˜¯ Kafka è‡ªèº«çš„æœºåˆ¶ï¼ˆå¼‚å¸¸æ—¶è¯·æ±‚é‡è¯•æœºåˆ¶ï¼‰å¯¼è‡´çš„æ•°æ®é‡å¤ã€‚\næ•°æ®é‡å¤çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ å”¯ä¸€idï¼Œé€šè¿‡idåˆ¤æ–­æ•°æ®æ˜¯å¦é‡å¤\nåŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/qq_37923600/article/details/88583170\näºŒ. ç”Ÿäº§è€…å¹‚ç­‰æ€§ ä¿è¯åœ¨å‘é€åŒä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œåœ¨æœåŠ¡ç«¯åªä¼šè¢«æŒä¹…åŒ–ä¸€æ¬¡ï¼Œæ•°æ®ä¸ä¸¢ä¸é‡ã€‚\nä½†æ˜¯æ˜¯æœ‰æ¡ä»¶çš„\nkafkaçš„å¹‚ç­‰æ€§åªèƒ½ä¿è¯å•ä¼šè¯æœ‰æ•ˆï¼Œå¦‚æœbrokeræŒ‚æ‰é‡å¯ï¼Œå¹‚ç­‰å°±æ— æ•ˆäº†ï¼Œå› ä¸ºæ— æ³•è·å–ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ å¹‚ç­‰æ€§ä¸èƒ½è·¨å¤šä¸ªTopic-Partitionï¼Œåªèƒ½ä¿è¯å•ä¸ªpartitionçš„å¹‚ç­‰æ€§ã€‚ æ‰€ä»¥ç”Ÿäº§è€…åˆ†ä¸ºäº† å¹‚ç­‰å‹producer å’Œ äº‹åŠ¡å‹producer,å‰è€…è§£å†³äº†å•ä¼šè¯å¹‚ç­‰æ€§ç­‰é—®é¢˜ï¼Œåè€…è§£å†³äº†å¤šä¼šè¯å¹‚ç­‰æ€§\nå•å›è¯çš„æ„æ€å¤§æ¦‚æ˜¯ å‘é€ä¸€æ¬¡æ¶ˆæ¯è¡¨ç¤ºä¸€æ¬¡å›è¯å§\n2.1 å•å›è¯å¹‚ç­‰æ€§ ä¸ºè§£å†³produceré‡è¯•å¼•èµ·çš„ä¹±åºå’Œé‡å¤ã€‚Kafkaå¢åŠ äº†pidå’Œseqã€‚Producerä¸­æ¯ä¸ªRecordBatchéƒ½æœ‰ä¸€ä¸ªå•è°ƒé€’å¢çš„seq; Brokerä¸Šæ¯ä¸ªtpä¹Ÿä¼šç»´æŠ¤pid-seqçš„æ˜ å°„ï¼Œå¹¶ä¸”æ¯Commitéƒ½ä¼šæ›´æ–°lastSeqã€‚è¿™æ ·recordBatchåˆ°æ¥æ—¶ï¼Œbrokerä¼šå…ˆæ£€æŸ¥RecordBatchå†ä¿å­˜æ•°æ®ï¼šå¦‚æœbatchä¸­ baseSeq(ç¬¬ä¸€æ¡æ¶ˆæ¯çš„seq)æ¯”Brokerç»´æŠ¤çš„åºå·(lastSeq)å¤§1ï¼Œåˆ™ä¿å­˜æ•°æ®ï¼Œå¦åˆ™ä¸ä¿å­˜(inSequenceæ–¹æ³•)ã€‚\nç®€å•çš„è¯´,ç›¸å½“äºæŠŠå­˜ä¸€ä»½æ ‡è¯†ç¬¦,æ¥ç¡®å®šæ˜¯å¦å·²ç”Ÿäº§äº†\nåœ¨ç”Ÿäº§è€…é…ç½®æ–‡ä»¶ä¸­åŠ å…¥é…ç½®å³å¯å®ç°: enable.idempotence=true\nå‚è€ƒ: https://blog.csdn.net/qq_37923600/article/details/88583170 2.2 å¤šå›è¯å¹‚ç­‰æ€§ kafkaäº‹åŠ¡å¼•å…¥äº†transactionId å’ŒEpochï¼Œè®¾ç½®transactional.idåï¼Œä¸€ä¸ªtransactionIdåªå¯¹åº”ä¸€ä¸ªpid, ä¸”Server ç«¯ä¼šè®°å½•æœ€æ–°çš„ Epoch å€¼ã€‚è¿™æ ·æœ‰æ–°çš„produceråˆå§‹åŒ–æ—¶ï¼Œä¼šå‘TransactionCoordinatorå‘é€InitPIDRequestè¯·æ±‚ï¼Œ TransactionCoordinator å·²ç»æœ‰äº†è¿™ä¸ª transactionIdå¯¹åº”çš„ metaï¼Œä¼šè¿”å›ä¹‹å‰åˆ†é…çš„ PIDï¼Œå¹¶æŠŠ Epoch è‡ªå¢ 1 è¿”å›ï¼Œè¿™æ ·å½“old produceræ¢å¤è¿‡æ¥è¯·æ±‚æ“ä½œæ—¶ï¼Œå°†è¢«è®¤ä¸ºæ˜¯æ— æ•ˆproduceræŠ›å‡ºå¼‚å¸¸ã€‚ å¦‚æœæ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼ŒTransactionCoordinatorä¼šä¸ºæ–°çš„producerè¿”å›new pidï¼Œè¿™æ ·å°±èµ·ä¸åˆ°éš”ç¦»æ•ˆæœï¼Œå› æ­¤æ— æ³•å®ç°å¤šä¼šè¯å¹‚ç­‰ã€‚\nå…¶å®å°±æ˜¯åˆ©ç”¨äº‹åŠ¡,åªè¦æ²¡å®Œæˆå°±ä¸ä¼šè‡ªå¢(åŸå­æ€§),å®Œæˆæ“ä½œåæ‰‹åŠ¨æäº¤\n2.2.1 å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§ æä¾›äº†API,ä½¿ç”¨APIå³å¯. å…¶ä¸­åˆ†ä¸º\nåªæœ‰å†™ æœ‰å†™æœ‰è¯»(æœ€å¸¸è§) åªæœ‰è¯»(æ²¡æœ‰å®é™…æ„ä¹‰,å› ä¸ºåªæœ‰è¯»ä¸ä¼šå‘ç”Ÿå¼‚å¸¸) è¿™é‡Œåªæè¿°ç¬¬äºŒç§\n/** * åœ¨ä¸€ä¸ªäº‹åŠ¡å†…,å³æœ‰ç”Ÿäº§æ¶ˆæ¯åˆæœ‰æ¶ˆè´¹æ¶ˆæ¯ */ public void consumeTransferProduce() { // 1.æ„å»ºä¸Šäº§è€… Producer producer = buildProducer(); // 2.åˆå§‹åŒ–äº‹åŠ¡(ç”ŸæˆproductId),å¯¹äºä¸€ä¸ªç”Ÿäº§è€…,åªèƒ½æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–äº‹åŠ¡æ“ä½œ producer.initTransactions(); // 3.æ„å»ºæ¶ˆè´¹è€…å’Œè®¢é˜…ä¸»é¢˜ Consumer consumer = buildConsumer(); consumer.subscribe(Arrays.asList(\"test\")); while (true) { // 4.å¼€å¯äº‹åŠ¡ producer.beginTransaction(); // 5.1 æ¥å—æ¶ˆæ¯ ConsumerRecords\u003cString, String\u003e records = consumer.poll(500); try { // 5.2 doä¸šåŠ¡é€»è¾‘; System.out.println(\"customer Message---\"); Map\u003cTopicPartition, OffsetAndMetadata\u003e commits = Maps.newHashMap(); for (ConsumerRecord\u003cString, String\u003e record : records) { // 5.2.1 è¯»å–æ¶ˆæ¯,å¹¶å¤„ç†æ¶ˆæ¯ã€‚print the offset,key and value for the consumer records. System.out.printf(\"offset = %d, key = %s, value = %s \", record.offset(), record.key(), record.value()); // 5.2.2 è®°å½•æäº¤çš„åç§»é‡ commits.put(new TopicPartition(record.topic(), record.partition()), new OffsetAndMetadata(record.offset())); // 6.ç”Ÿäº§æ–°çš„æ¶ˆæ¯ã€‚æ¯”å¦‚å¤–å–è®¢å•çŠ¶æ€çš„æ¶ˆæ¯,å¦‚æœè®¢å•æˆåŠŸ,åˆ™éœ€è¦å‘é€è·Ÿå•†å®¶ç»“è½¬æ¶ˆæ¯æˆ–è€…æ´¾é€å‘˜çš„ææˆæ¶ˆæ¯ producer.send(new ProducerRecord\u003cString, String\u003e(\"test\", \"data2\")); } // 7.æäº¤åç§»é‡ producer.sendOffsetsToTransaction(commits, \"group0323\"); // 8.äº‹åŠ¡æäº¤ producer.commitTransaction(); } catch (Exception e) { // 7.æ”¾å¼ƒäº‹åŠ¡ producer.abortTransaction(); } } } åˆ›å»ºæ¶ˆè´¹è€…ä»£ç ï¼Œéœ€è¦ï¼š\nå°†é…ç½®ä¸­çš„è‡ªåŠ¨æäº¤å±æ€§ï¼ˆauto.commitï¼‰è¿›è¡Œå…³é—­ è€Œä¸”åœ¨ä»£ç é‡Œé¢ä¹Ÿä¸èƒ½ä½¿ç”¨æ‰‹åŠ¨æäº¤commitSync( )æˆ–è€…commitAsync( ) è®¾ç½®isolation.level /** * éœ€è¦: * 1ã€å…³é—­è‡ªåŠ¨æäº¤ enable.auto.commit * 2ã€isolation.levelä¸º * @return */ public Consumer buildConsumer() { Properties props = new Properties(); // bootstrap.serversæ˜¯Kafkaé›†ç¾¤çš„IPåœ°å€ã€‚å¤šä¸ªæ—¶,ä½¿ç”¨é€—å·éš”å¼€ props.put(\"bootstrap.servers\", \"localhost:9092\"); // æ¶ˆè´¹è€…ç¾¤ç»„ props.put(\"group.id\", \"group0323\"); // è®¾ç½®éš”ç¦»çº§åˆ« props.put(\"isolation.level\",\"read_committed\"); // å…³é—­è‡ªåŠ¨æäº¤ props.put(\"enable.auto.commit\", \"false\"); props.put(\"session.timeout.ms\", \"30000\"); props.put(\"key.deserializer\", \"org.apache.kafka.common.serialization.StringDeserializer\"); props.put(\"value.deserializer\", \"org.apache.kafka.common.serialization.StringDeserializer\"); KafkaConsumer\u003cString, String\u003e consumer = new KafkaConsumer \u003cString, String\u003e(props); return consumer; } æ›´å¤šå‚è§:http://www.heartthinkdo.com/?p=2040\nä¸‰. æ¶ˆè´¹è€…å¹‚ç­‰æ€§ æŒ‡çš„æ˜¯å³ä½¿æœ‰é‡å¤æ¶ˆæ¯,ä¹Ÿä¸èƒ½é‡å¤å¤„ç†\nå…¶åšæ³•å°±æ˜¯åšå”¯ä¸€id,ç›¸å½“äºå¤©å¯åŒæ­¥æ¨¡å—ä¸­,åšä¸ªåˆ¤æ–­,å¦‚æœé¡¹ç›®ç¼–å·å·²å­˜åœ¨åˆ™ä¸åšæ¶ˆè´¹å¤„ç†\nif(cache.contain(msgId)){ // cacheä¸­åŒ…å«msgIdï¼Œå·²ç»å¤„ç†è¿‡ continue; }else { lock.lock(); cache.put(msgId,timeout); commitSync(); lock.unLock(); } // åç»­å®Œæˆæ‰€æœ‰æ“ä½œåï¼Œåˆ é™¤cacheä¸­çš„msgIdï¼Œåªè¦msgIdå­˜åœ¨cacheä¸­ï¼Œå°±è®¤ä¸ºå·²ç»å¤„ç†è¿‡ã€‚Noteï¼šéœ€è¦ç»™cacheè®¾ç½®æœ‰æ¶ˆæ¯ å‚è€ƒ: https://www.cnblogs.com/jingangtx/p/11330338.html ","wordCount":"2273","inLanguage":"zh","datePublished":"2023-08-22T00:00:00Z","dateModified":"2023-09-04T05:50:23.633349671Z","author":{"@type":"Person","name":"xkj"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/Kafka/%E7%AE%80%E8%BF%B0%E5%B9%82%E7%AD%89%E6%80%A7.html"},"publisher":{"@type":"Organization","name":"ç±³äºŒ","logo":{"@type":"ImageObject","url":"https://xiaokunji.com/img/Q.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaokunji.com/zh/ accesskey=h title="ç±³äºŒ (Alt + H)"><img src=https://xiaokunji.com/img/Q.svg alt aria-label=logo height=35>ç±³äºŒ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaokunji.com/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://xiaokunji.com/zh/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=https://xiaokunji.com/zh/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://xiaokunji.com/zh/post.html title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=https://xiaokunji.com/zh/archives.html title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://xiaokunji.com/zh/tags.html title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://xiaokunji.com/zh/categories.html title=ğŸ“–åˆ†ç±»><span>ğŸ“–åˆ†ç±»</span></a></li><li><a href=https://xiaokunji.com/zh/links.html title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><nav aria-label=breadcrumb><ul><a href=https://xiaokunji.com/zh/>ğŸ </a> <span>></span>
<a href=https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88.html>hadoopç”Ÿæ€åœˆ</a> <span>></span>
<a href=https://xiaokunji.com/zh/hadoop%E7%94%9F%E6%80%81%E5%9C%88/Kafka.html>Kafka</a> <span>></span></ul></nav><h1 class=post-title>ç®€è¿°å¹‚ç­‰æ€§</h1><div class=post-description></div><div class=post-meta>åˆ›å»º:&nbsp;<span title='2023-08-22 00:00:00 +0000 UTC'>2023-08-22</span>&nbsp;Â·&nbsp;æ›´æ–°:&nbsp;2023-09-04&nbsp;Â·&nbsp;xkj
&nbsp;|&nbsp;åˆ†ç±»: &nbsp;<ul class=post-categories-meta><a href=https://xiaokunji.com/zh/categories/Hadoop%E7%94%9F%E6%80%81%E5%9C%88.html>Hadoopç”Ÿæ€åœˆ</a></ul><span id=busuanzi_container_page_pv>&nbsp;| è®¿é—®: <span id=busuanzi_value_page_pv>1</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e4%b8%80-%e4%bb%80%e4%b9%88%e6%98%af%e5%b9%82%e7%ad%89%e6%80%a7 aria-label="ä¸€. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§?">ä¸€. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§?</a></li><li><a href=#%e4%ba%8c-%e7%94%9f%e4%ba%a7%e8%80%85%e5%b9%82%e7%ad%89%e6%80%a7 aria-label="äºŒ. ç”Ÿäº§è€…å¹‚ç­‰æ€§">äºŒ. ç”Ÿäº§è€…å¹‚ç­‰æ€§</a><ul><li><a href=#21-%e5%8d%95%e5%9b%9e%e8%af%9d%e5%b9%82%e7%ad%89%e6%80%a7 aria-label="2.1 å•å›è¯å¹‚ç­‰æ€§">2.1 å•å›è¯å¹‚ç­‰æ€§</a></li><li><a href=#22-%e5%a4%9a%e5%9b%9e%e8%af%9d%e5%b9%82%e7%ad%89%e6%80%a7 aria-label="2.2 å¤šå›è¯å¹‚ç­‰æ€§">2.2 å¤šå›è¯å¹‚ç­‰æ€§</a><ul><li><a href=#221-%e5%ae%9e%e7%8e%b0%e5%a4%9a%e4%bc%9a%e8%af%9d%e5%b9%82%e7%ad%89%e6%80%a7 aria-label="2.2.1 å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§">2.2.1 å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§</a></li></ul></li></ul></li><li><a href=#%e4%b8%89-%e6%b6%88%e8%b4%b9%e8%80%85%e5%b9%82%e7%ad%89%e6%80%a7 aria-label="ä¸‰. æ¶ˆè´¹è€…å¹‚ç­‰æ€§">ä¸‰. æ¶ˆè´¹è€…å¹‚ç­‰æ€§</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>[toc]</p><h1 id=ä¸€-ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§>ä¸€. ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§?<a hidden class=anchor aria-hidden=true href=#ä¸€-ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§>#</a></h1><p>å¹‚ç­‰æ€§å…¶å®æ˜¯æ¶ˆæ¯çš„ä¸€è‡´æ€§,åˆ†ä¸ºç”Ÿäº§è€…å¹‚ç­‰æ€§å’Œæ¶ˆè´¹è€…å¹‚ç­‰æ€§.</p><p>ä½¿ç”¨Kafkaæ—¶,éœ€è¦ä¿è¯exactly-onceè¯­ä¹‰ã€‚è¦çŸ¥é“åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå‡ºç°ç½‘ç»œåˆ†åŒºæ˜¯ä¸å¯é¿å…çš„ï¼Œå¦‚æœkafka broker åœ¨å›å¤ackæ—¶ï¼Œå‡ºç°ç½‘ç»œæ•…éšœæˆ–è€…æ˜¯full gcå¯¼è‡´ack timeoutï¼Œproducerå°†ä¼šé‡å‘ï¼Œå¦‚ä½•ä¿è¯produceré‡è¯•æ—¶ä¸é€ æˆé‡å¤orä¹±åºï¼Ÿåˆæˆ–è€…producer æŒ‚äº†ï¼Œæ–°çš„producerå¹¶æ²¡æœ‰old producerçš„çŠ¶æ€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å¦‚ä½•ä¿è¯å¹‚ç­‰ï¼Ÿå³ä½¿Kafka å‘é€æ¶ˆæ¯æ»¡è¶³äº†å¹‚ç­‰ï¼Œconsumeræ‹‰å–åˆ°æ¶ˆæ¯åï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™çº¿ç¨‹æ± workersï¼Œworkersçº¿ç¨‹å¯¹messageçš„å¤„ç†å¯èƒ½åŒ…å«å¼‚æ­¥æ“ä½œï¼Œ</p><blockquote><p>æ¥è‡ª <a href=https://www.cnblogs.com/jingangtx/p/11330338.html target=_blank rel=noopener>https://www.cnblogs.com/jingangtx/p/11330338.html</a></p></blockquote><p>å°±æ˜¯ç”¨æ¥è§£å†³æ•°æ®é‡å¤é—®é¢˜ï¼Œä¿è¯kafkaå•ä¼šè¯å•åˆ†åŒºå†…æ•°æ®ä¸ä¼šé‡å¤æ¶ˆè´¹åœ¨kafka0.11ä¹‹å‰é€šè¿‡isr+ackæœºåˆ¶å¯ä¿è¯æ•°æ®ä¸ä¸¢ï¼Œå´ä¸èƒ½ä¿è¯ä¸é‡å¤
æœ‰ä¸€äº›æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´æ•°æ®é‡å¤ã€‚æ¯”å¦‚ï¼šç½‘ç»œè¯·æ±‚å»¶æ—¶å¯¼è‡´çš„é‡è¯•æ“ä½œï¼Œåœ¨å‘é€è¯·æ±‚é‡è¯•æ—¶ Server ç«¯å¹¶ä¸çŸ¥é“è¿™æ¡è¯·æ±‚æ˜¯å¦å·²ç»å¤„ç†ï¼ˆæ²¡æœ‰è®°å½•ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼‰ï¼Œæ‰€ä»¥å°±ä¼šæœ‰å¯èƒ½å¯¼è‡´æ•°æ®è¯·æ±‚çš„é‡å¤å‘é€ï¼Œè¿™æ˜¯ Kafka è‡ªèº«çš„æœºåˆ¶ï¼ˆå¼‚å¸¸æ—¶è¯·æ±‚é‡è¯•æœºåˆ¶ï¼‰å¯¼è‡´çš„æ•°æ®é‡å¤ã€‚</p><p>æ•°æ®é‡å¤çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ å”¯ä¸€idï¼Œé€šè¿‡idåˆ¤æ–­æ•°æ®æ˜¯å¦é‡å¤</p><blockquote><p>åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/qq_37923600/article/details/88583170</p></blockquote><h1 id=äºŒ-ç”Ÿäº§è€…å¹‚ç­‰æ€§>äºŒ. ç”Ÿäº§è€…å¹‚ç­‰æ€§<a hidden class=anchor aria-hidden=true href=#äºŒ-ç”Ÿäº§è€…å¹‚ç­‰æ€§>#</a></h1><p>ä¿è¯åœ¨å‘é€åŒä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œåœ¨æœåŠ¡ç«¯åªä¼šè¢«æŒä¹…åŒ–ä¸€æ¬¡ï¼Œæ•°æ®ä¸ä¸¢ä¸é‡ã€‚</p><p>ä½†æ˜¯æ˜¯æœ‰æ¡ä»¶çš„</p><ol><li>kafkaçš„å¹‚ç­‰æ€§åªèƒ½ä¿è¯å•ä¼šè¯æœ‰æ•ˆï¼Œå¦‚æœbrokeræŒ‚æ‰é‡å¯ï¼Œå¹‚ç­‰å°±æ— æ•ˆäº†ï¼Œå› ä¸ºæ— æ³•è·å–ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯</li><li>å¹‚ç­‰æ€§ä¸èƒ½è·¨å¤šä¸ªTopic-Partitionï¼Œåªèƒ½ä¿è¯å•ä¸ªpartitionçš„å¹‚ç­‰æ€§ã€‚</li></ol><p>æ‰€ä»¥ç”Ÿäº§è€…åˆ†ä¸ºäº† <u>å¹‚ç­‰å‹producer</u> å’Œ <u>äº‹åŠ¡å‹producer</u>,å‰è€…è§£å†³äº†å•ä¼šè¯å¹‚ç­‰æ€§ç­‰é—®é¢˜ï¼Œåè€…è§£å†³äº†å¤šä¼šè¯å¹‚ç­‰æ€§</p><blockquote><p>å•å›è¯çš„æ„æ€å¤§æ¦‚æ˜¯ å‘é€ä¸€æ¬¡æ¶ˆæ¯è¡¨ç¤ºä¸€æ¬¡å›è¯å§</p></blockquote><h2 id=21-å•å›è¯å¹‚ç­‰æ€§>2.1 å•å›è¯å¹‚ç­‰æ€§<a hidden class=anchor aria-hidden=true href=#21-å•å›è¯å¹‚ç­‰æ€§>#</a></h2><p>ä¸ºè§£å†³produceré‡è¯•å¼•èµ·çš„ä¹±åºå’Œé‡å¤ã€‚Kafkaå¢åŠ äº†pidå’Œseqã€‚Producerä¸­æ¯ä¸ªRecordBatchéƒ½æœ‰ä¸€ä¸ªå•è°ƒé€’å¢çš„seq; Brokerä¸Šæ¯ä¸ªtpä¹Ÿä¼šç»´æŠ¤pid-seqçš„æ˜ å°„ï¼Œå¹¶ä¸”æ¯Commitéƒ½ä¼šæ›´æ–°lastSeqã€‚è¿™æ ·recordBatchåˆ°æ¥æ—¶ï¼Œbrokerä¼šå…ˆæ£€æŸ¥RecordBatchå†ä¿å­˜æ•°æ®ï¼šå¦‚æœbatchä¸­ baseSeq(ç¬¬ä¸€æ¡æ¶ˆæ¯çš„seq)æ¯”Brokerç»´æŠ¤çš„åºå·(lastSeq)å¤§1ï¼Œåˆ™ä¿å­˜æ•°æ®ï¼Œå¦åˆ™ä¸ä¿å­˜(inSequenceæ–¹æ³•)ã€‚</p><blockquote><p>ç®€å•çš„è¯´,ç›¸å½“äºæŠŠå­˜ä¸€ä»½æ ‡è¯†ç¬¦,æ¥ç¡®å®šæ˜¯å¦å·²ç”Ÿäº§äº†</p></blockquote><p>åœ¨ç”Ÿäº§è€…é…ç½®æ–‡ä»¶ä¸­åŠ å…¥é…ç½®å³å¯å®ç°:
<code>enable.idempotence=true</code></p><blockquote><p>å‚è€ƒ: <a href=https://blog.csdn.net/qq_37923600/article/details/88583170 target=_blank rel=noopener>https://blog.csdn.net/qq_37923600/article/details/88583170</a></p></blockquote><h2 id=22-å¤šå›è¯å¹‚ç­‰æ€§>2.2 å¤šå›è¯å¹‚ç­‰æ€§<a hidden class=anchor aria-hidden=true href=#22-å¤šå›è¯å¹‚ç­‰æ€§>#</a></h2><p>kafkaäº‹åŠ¡å¼•å…¥äº†transactionId å’ŒEpochï¼Œè®¾ç½®transactional.idåï¼Œä¸€ä¸ªtransactionIdåªå¯¹åº”ä¸€ä¸ªpid, ä¸”Server ç«¯ä¼šè®°å½•æœ€æ–°çš„ Epoch å€¼ã€‚è¿™æ ·æœ‰æ–°çš„produceråˆå§‹åŒ–æ—¶ï¼Œä¼šå‘TransactionCoordinatorå‘é€InitPIDRequestè¯·æ±‚ï¼Œ TransactionCoordinator å·²ç»æœ‰äº†è¿™ä¸ª transactionIdå¯¹åº”çš„ metaï¼Œä¼šè¿”å›ä¹‹å‰åˆ†é…çš„ PIDï¼Œå¹¶æŠŠ Epoch è‡ªå¢ 1 è¿”å›ï¼Œè¿™æ ·å½“old produceræ¢å¤è¿‡æ¥è¯·æ±‚æ“ä½œæ—¶ï¼Œå°†è¢«è®¤ä¸ºæ˜¯æ— æ•ˆproduceræŠ›å‡ºå¼‚å¸¸ã€‚ å¦‚æœæ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼ŒTransactionCoordinatorä¼šä¸ºæ–°çš„producerè¿”å›new pidï¼Œè¿™æ ·å°±èµ·ä¸åˆ°éš”ç¦»æ•ˆæœï¼Œå› æ­¤æ— æ³•å®ç°å¤šä¼šè¯å¹‚ç­‰ã€‚</p><blockquote><p>å…¶å®å°±æ˜¯åˆ©ç”¨äº‹åŠ¡,åªè¦æ²¡å®Œæˆå°±ä¸ä¼šè‡ªå¢(åŸå­æ€§),å®Œæˆæ“ä½œåæ‰‹åŠ¨æäº¤</p></blockquote><h3 id=221-å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§>2.2.1 å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§<a hidden class=anchor aria-hidden=true href=#221-å®ç°å¤šä¼šè¯å¹‚ç­‰æ€§>#</a></h3><p>æä¾›äº†API,ä½¿ç”¨APIå³å¯. å…¶ä¸­åˆ†ä¸º</p><ol><li>åªæœ‰å†™</li><li>æœ‰å†™æœ‰è¯»(æœ€å¸¸è§)</li><li>åªæœ‰è¯»(æ²¡æœ‰å®é™…æ„ä¹‰,å› ä¸ºåªæœ‰è¯»ä¸ä¼šå‘ç”Ÿå¼‚å¸¸)</li></ol><p>è¿™é‡Œåªæè¿°ç¬¬äºŒç§</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * åœ¨ä¸€ä¸ªäº‹åŠ¡å†…,å³æœ‰ç”Ÿäº§æ¶ˆæ¯åˆæœ‰æ¶ˆè´¹æ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> <span style=color:#ff7b72>void</span> <span style=color:#d2a8ff;font-weight:700>consumeTransferProduce</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 1.æ„å»ºä¸Šäº§è€…
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        Producer producer <span style=color:#ff7b72;font-weight:700>=</span> buildProducer<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 2.åˆå§‹åŒ–äº‹åŠ¡(ç”ŸæˆproductId),å¯¹äºä¸€ä¸ªç”Ÿäº§è€…,åªèƒ½æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–äº‹åŠ¡æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        producer<span style=color:#ff7b72;font-weight:700>.</span>initTransactions<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// 3.æ„å»ºæ¶ˆè´¹è€…å’Œè®¢é˜…ä¸»é¢˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        Consumer consumer <span style=color:#ff7b72;font-weight:700>=</span> buildConsumer<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        consumer<span style=color:#ff7b72;font-weight:700>.</span>subscribe<span style=color:#ff7b72;font-weight:700>(</span>Arrays<span style=color:#ff7b72;font-weight:700>.</span>asList<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;test&#34;</span><span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>while</span> <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#79c0ff>true</span><span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 4.å¼€å¯äº‹åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            producer<span style=color:#ff7b72;font-weight:700>.</span>beginTransaction<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// 5.1 æ¥å—æ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            ConsumerRecords<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> String<span style=color:#ff7b72;font-weight:700>&gt;</span> records <span style=color:#ff7b72;font-weight:700>=</span> consumer<span style=color:#ff7b72;font-weight:700>.</span>poll<span style=color:#ff7b72;font-weight:700>(</span>500<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 5.2 doä¸šåŠ¡é€»è¾‘;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                System<span style=color:#ff7b72;font-weight:700>.</span>out<span style=color:#ff7b72;font-weight:700>.</span>println<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;customer Message---&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>                Map<span style=color:#ff7b72;font-weight:700>&lt;</span>TopicPartition<span style=color:#ff7b72;font-weight:700>,</span> OffsetAndMetadata<span style=color:#ff7b72;font-weight:700>&gt;</span> commits <span style=color:#ff7b72;font-weight:700>=</span> Maps<span style=color:#ff7b72;font-weight:700>.</span>newHashMap<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>for</span> <span style=color:#ff7b72;font-weight:700>(</span>ConsumerRecord<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> String<span style=color:#ff7b72;font-weight:700>&gt;</span> record <span style=color:#ff7b72;font-weight:700>:</span> records<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// 5.2.1 è¯»å–æ¶ˆæ¯,å¹¶å¤„ç†æ¶ˆæ¯ã€‚print the offset,key and value for the consumer records.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    System<span style=color:#ff7b72;font-weight:700>.</span>out<span style=color:#ff7b72;font-weight:700>.</span>printf<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;offset = %d, key = %s, value = %s
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            record<span style=color:#ff7b72;font-weight:700>.</span>offset<span style=color:#ff7b72;font-weight:700>(),</span> record<span style=color:#ff7b72;font-weight:700>.</span>key<span style=color:#ff7b72;font-weight:700>(),</span> record<span style=color:#ff7b72;font-weight:700>.</span>value<span style=color:#ff7b72;font-weight:700>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// 5.2.2 è®°å½•æäº¤çš„åç§»é‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    commits<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>new</span> TopicPartition<span style=color:#ff7b72;font-weight:700>(</span>record<span style=color:#ff7b72;font-weight:700>.</span>topic<span style=color:#ff7b72;font-weight:700>(),</span> record<span style=color:#ff7b72;font-weight:700>.</span>partition<span style=color:#ff7b72;font-weight:700>()),</span>
</span></span><span style=display:flex><span>                            <span style=color:#ff7b72>new</span> OffsetAndMetadata<span style=color:#ff7b72;font-weight:700>(</span>record<span style=color:#ff7b72;font-weight:700>.</span>offset<span style=color:#ff7b72;font-weight:700>()));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#8b949e;font-style:italic>// 6.ç”Ÿäº§æ–°çš„æ¶ˆæ¯ã€‚æ¯”å¦‚å¤–å–è®¢å•çŠ¶æ€çš„æ¶ˆæ¯,å¦‚æœè®¢å•æˆåŠŸ,åˆ™éœ€è¦å‘é€è·Ÿå•†å®¶ç»“è½¬æ¶ˆæ¯æˆ–è€…æ´¾é€å‘˜çš„ææˆæ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                    producer<span style=color:#ff7b72;font-weight:700>.</span>send<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#ff7b72>new</span> ProducerRecord<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> String<span style=color:#ff7b72;font-weight:700>&gt;(</span><span style=color:#a5d6ff>&#34;test&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;data2&#34;</span><span style=color:#ff7b72;font-weight:700>));</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 7.æäº¤åç§»é‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                producer<span style=color:#ff7b72;font-weight:700>.</span>sendOffsetsToTransaction<span style=color:#ff7b72;font-weight:700>(</span>commits<span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;group0323&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 8.äº‹åŠ¡æäº¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                producer<span style=color:#ff7b72;font-weight:700>.</span>commitTransaction<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span> <span style=color:#ff7b72>catch</span> <span style=color:#ff7b72;font-weight:700>(</span>Exception e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// 7.æ”¾å¼ƒäº‹åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                producer<span style=color:#ff7b72;font-weight:700>.</span>abortTransaction<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><p>åˆ›å»ºæ¶ˆè´¹è€…ä»£ç ï¼Œéœ€è¦ï¼š</p><ul><li>å°†é…ç½®ä¸­çš„è‡ªåŠ¨æäº¤å±æ€§ï¼ˆauto.commitï¼‰è¿›è¡Œå…³é—­</li><li>è€Œä¸”åœ¨ä»£ç é‡Œé¢ä¹Ÿä¸èƒ½ä½¿ç”¨æ‰‹åŠ¨æäº¤commitSync( )æˆ–è€…commitAsync( )</li><li>è®¾ç½®isolation.level</li></ul><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * éœ€è¦:
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 1ã€å…³é—­è‡ªåŠ¨æäº¤ enable.auto.commit
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * 2ã€isolation.levelä¸º
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>public</span> Consumer <span style=color:#d2a8ff;font-weight:700>buildConsumer</span><span style=color:#ff7b72;font-weight:700>()</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        Properties props <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Properties<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// bootstrap.serversæ˜¯Kafkaé›†ç¾¤çš„IPåœ°å€ã€‚å¤šä¸ªæ—¶,ä½¿ç”¨é€—å·éš”å¼€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;bootstrap.servers&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;localhost:9092&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ¶ˆè´¹è€…ç¾¤ç»„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;group.id&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;group0323&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è®¾ç½®éš”ç¦»çº§åˆ«
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;isolation.level&#34;</span><span style=color:#ff7b72;font-weight:700>,</span><span style=color:#a5d6ff>&#34;read_committed&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å…³é—­è‡ªåŠ¨æäº¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;enable.auto.commit&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;false&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;session.timeout.ms&#34;</span><span style=color:#ff7b72;font-weight:700>,</span> <span style=color:#a5d6ff>&#34;30000&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;key.deserializer&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        props<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;value.deserializer&#34;</span><span style=color:#ff7b72;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span><span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>        KafkaConsumer<span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> String<span style=color:#ff7b72;font-weight:700>&gt;</span> consumer <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> KafkaConsumer
</span></span><span style=display:flex><span>                <span style=color:#ff7b72;font-weight:700>&lt;</span>String<span style=color:#ff7b72;font-weight:700>,</span> String<span style=color:#ff7b72;font-weight:700>&gt;(</span>props<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> consumer<span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><blockquote><p>æ›´å¤šå‚è§:http://www.heartthinkdo.com/?p=2040</p></blockquote><h1 id=ä¸‰-æ¶ˆè´¹è€…å¹‚ç­‰æ€§>ä¸‰. æ¶ˆè´¹è€…å¹‚ç­‰æ€§<a hidden class=anchor aria-hidden=true href=#ä¸‰-æ¶ˆè´¹è€…å¹‚ç­‰æ€§>#</a></h1><p>æŒ‡çš„æ˜¯å³ä½¿æœ‰é‡å¤æ¶ˆæ¯,ä¹Ÿä¸èƒ½é‡å¤å¤„ç†</p><p><strong>å…¶åšæ³•å°±æ˜¯åšå”¯ä¸€id,ç›¸å½“äºå¤©å¯åŒæ­¥æ¨¡å—ä¸­,åšä¸ªåˆ¤æ–­,å¦‚æœé¡¹ç›®ç¼–å·å·²å­˜åœ¨åˆ™ä¸åšæ¶ˆè´¹å¤„ç†</strong></p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>if</span><span style=color:#ff7b72;font-weight:700>(</span>cache<span style=color:#ff7b72;font-weight:700>.</span>contain<span style=color:#ff7b72;font-weight:700>(</span>msgId<span style=color:#ff7b72;font-weight:700>)){</span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// cacheä¸­åŒ…å«msgIdï¼Œå·²ç»å¤„ç†è¿‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>continue</span><span style=color:#ff7b72;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span><span style=color:#ff7b72>else</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  lock<span style=color:#ff7b72;font-weight:700>.</span>lock<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>  cache<span style=color:#ff7b72;font-weight:700>.</span>put<span style=color:#ff7b72;font-weight:700>(</span>msgId<span style=color:#ff7b72;font-weight:700>,</span>timeout<span style=color:#ff7b72;font-weight:700>);</span>
</span></span><span style=display:flex><span>  commitSync<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span>  lock<span style=color:#ff7b72;font-weight:700>.</span>unLock<span style=color:#ff7b72;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åç»­å®Œæˆæ‰€æœ‰æ“ä½œåï¼Œåˆ é™¤cacheä¸­çš„msgIdï¼Œåªè¦msgIdå­˜åœ¨cacheä¸­ï¼Œå°±è®¤ä¸ºå·²ç»å¤„ç†è¿‡ã€‚Noteï¼šéœ€è¦ç»™cacheè®¾ç½®æœ‰æ¶ˆæ¯
</span></span></span></code></pre></div><blockquote><p>å‚è€ƒ: <a href=https://www.cnblogs.com/jingangtx/p/11330338.html target=_blank rel=noopener>https://www.cnblogs.com/jingangtx/p/11330338.html</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaokunji.com/zh/tags/Kafka.html>Kafka</a></li><li><a href=https://xiaokunji.com/zh/tags/Hadoop%E7%94%9F%E6%80%81%E5%9C%88.html>Hadoopç”Ÿæ€åœˆ</a></li></ul></footer></article></main><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><footer class=footer><span>Copyright
&copy;
-2023
<a href=https://xiaokunji.com/zh/ style=color:#939393>ç±³äºŒ</a>
All Rights Reserved</span>
<span id=busuanzi_container><span class="fa fa-user">ç”¨æˆ·æ•°:</span><span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye">è®¿é—®æ•°:</span><span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>